<!DOCTYPE html>
<html lang="简体中文">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>STM32 | 程序人生</title><meta name="description" content="不因虚度年华而悔恨，不因碌碌无为而羞耻。">
    <link rel="preload" href="/my-vuepress-blog/assets/style-e1f21a1f.css" as="style"><link rel="stylesheet" href="/my-vuepress-blog/assets/style-e1f21a1f.css">
    <link rel="modulepreload" href="/my-vuepress-blog/assets/app-521e935c.js"><link rel="modulepreload" href="/my-vuepress-blog/assets/STM32.html-2411d764.js"><link rel="modulepreload" href="/my-vuepress-blog/assets/STM32.html-39688344.js"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-8e536b67.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-cd51371e.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-85224617.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-de2179da.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-62f3fcc4.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-bf5748db.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-863de4b2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/GNU.html-9b334f8b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-41292ae1.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-354884f3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-41b6034c.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-1e542293.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-ea01f80f.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-6049be6f.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-a5cd54a3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-6e375392.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-d97e1897.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-8e5485e0.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-f60d479b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-dbb41269.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-bc59e5ee.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-d038ca97.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-a6627571.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-a77869ee.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-0e2beb2a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-fe4120f2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-e0ab504c.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-af1902df.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-07b89f5b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-26496d14.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-c29783f5.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-57ad1333.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-c9dbe43a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-3b67e3e3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-a6fa84ba.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-805d6d17.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-8f83464a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-ea7eb110.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-39718876.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-c7f5783a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/404.html-f62106ff.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-0e3add3d.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-2979ca24.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-c6fc80dc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-ae8f0269.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-394e9cca.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-8e47e651.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-38348bb5.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/GNU.html-87241cdd.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-1f1d16cc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-ca601a94.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-216564d1.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-ebdd7b52.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-85c33282.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-7ef34afa.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-ff9c155d.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-a62301c6.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-f2370b0b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-743dec54.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-b958c422.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-fff02bd4.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-ccd7c332.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-0353cc68.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-faa4c062.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-caf4f3ca.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-d660b06b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-6807c7c7.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-fd0cd085.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-d52b7005.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-99acd2c6.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-28e441bf.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-c26c3399.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-b0ba95bc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-ca4c11eb.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-387a8185.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-69259a35.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-5134a5c2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-403523ab.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-5dcda878.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-51b5a534.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-2e5c188b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/404.html-9e190cf3.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/my-vuepress-blog/zh/" class=""><!----><span class="site-name can-hide">程序人生</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/my-vuepress-blog/zh/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/README.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/C语言.md" class="" aria-label="C语言"><!--[--><!--]--> C语言 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/CPP.md" class="" aria-label="C++"><!--[--><!--]--> C++ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Echarts图表基本结构.md" class="" aria-label="Echarts图表基本结构"><!--[--><!--]--> Echarts图表基本结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Git.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Linux.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Makefile.md" class="" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/OpenCV.md" class="" aria-label="OpenCV"><!--[--><!--]--> OpenCV <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Operating System.md" class="" aria-label="操作系统"><!--[--><!--]--> 操作系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Spring Cloud.md" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/STM32.md" class="" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/TensorFlow.md" class="" aria-label="TensorFlow"><!--[--><!--]--> TensorFlow <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/乱七八糟.md" class="" aria-label="Mix"><!--[--><!--]--> Mix <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/数据结构与算法C语言实现.md" class="" aria-label="数据结构与算法"><!--[--><!--]--> 数据结构与算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="内核"><span class="title">内核</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="内核"><span class="title">内核</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Kernel.md" class="" aria-label="内核"><!--[--><!--]--> 内核 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/STM32.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/GerryDush" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/my-vuepress-blog/zh/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="笔记"><span class="title">笔记</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="笔记"><span class="title">笔记</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/README.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/C语言.md" class="" aria-label="C语言"><!--[--><!--]--> C语言 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/CPP.md" class="" aria-label="C++"><!--[--><!--]--> C++ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Echarts图表基本结构.md" class="" aria-label="Echarts图表基本结构"><!--[--><!--]--> Echarts图表基本结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Git.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Linux.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Makefile.md" class="" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/OpenCV.md" class="" aria-label="OpenCV"><!--[--><!--]--> OpenCV <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Operating System.md" class="" aria-label="操作系统"><!--[--><!--]--> 操作系统 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Spring Cloud.md" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/STM32.md" class="" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/TensorFlow.md" class="" aria-label="TensorFlow"><!--[--><!--]--> TensorFlow <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/乱七八糟.md" class="" aria-label="Mix"><!--[--><!--]--> Mix <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/数据结构与算法C语言实现.md" class="" aria-label="数据结构与算法"><!--[--><!--]--> 数据结构与算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="内核"><span class="title">内核</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="内核"><span class="title">内核</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Kernel.md" class="" aria-label="内核"><!--[--><!--]--> 内核 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">选择语言</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/STM32.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html" class="router-link-active router-link-exact-active router-link-active" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/GerryDush" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">STM32 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#what-is-stm32" class="router-link-active router-link-exact-active sidebar-item" aria-label="What is STM32？"><!--[--><!--]--> What is STM32？ <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32的字面意思" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32的字面意思"><!--[--><!--]--> STM32的字面意思 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm诞生的背景" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM诞生的背景"><!--[--><!--]--> STM诞生的背景 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-能做什么" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 能做什么"><!--[--><!--]--> STM32 能做什么 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm分类" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM分类"><!--[--><!--]--> STM分类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm命名方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM命名方法"><!--[--><!--]--> STM命名方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32怎么选型" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32怎么选型"><!--[--><!--]--> STM32怎么选型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#如何分配原理图引脚" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何分配原理图引脚"><!--[--><!--]--> 如何分配原理图引脚 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#如何寻找引脚功能说明" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何寻找引脚功能说明"><!--[--><!--]--> 如何寻找引脚功能说明 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#什么是寄存器" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是寄存器"><!--[--><!--]--> 什么是寄存器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32长啥样" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32长啥样"><!--[--><!--]--> STM32长啥样 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#_1、如何辨别正方向" class="router-link-active router-link-exact-active sidebar-item" aria-label="1、如何辨别正方向"><!--[--><!--]--> 1、如何辨别正方向 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32内部有什么" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32内部有什么"><!--[--><!--]--> STM32内部有什么 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#_1、什么是存储器映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="1、什么是存储器映射"><!--[--><!--]--> 1、什么是存储器映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#_2、什么是寄存器映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="2、什么是寄存器映射"><!--[--><!--]--> 2、什么是寄存器映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#如何理解寄存器的说明" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何理解寄存器的说明"><!--[--><!--]--> 如何理解寄存器的说明 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#c语言对寄存器封装" class="router-link-active router-link-exact-active sidebar-item" aria-label="C语言对寄存器封装"><!--[--><!--]--> C语言对寄存器封装 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#新建本地工程" class="router-link-active router-link-exact-active sidebar-item" aria-label="新建本地工程"><!--[--><!--]--> 新建本地工程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#寄存器点亮led" class="router-link-active router-link-exact-active sidebar-item" aria-label="寄存器点亮LED"><!--[--><!--]--> 寄存器点亮LED <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#寄存器封装" class="router-link-active router-link-exact-active sidebar-item" aria-label="寄存器封装"><!--[--><!--]--> 寄存器封装 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-固件库" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 固件库"><!--[--><!--]--> STM32 固件库 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#什么是固件库" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是固件库"><!--[--><!--]--> 什么是固件库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#如何获取固件库" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何获取固件库"><!--[--><!--]--> 如何获取固件库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#新建工程-库函数版" class="router-link-active router-link-exact-active sidebar-item" aria-label="新建工程-库函数版"><!--[--><!--]--> 新建工程-库函数版 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gpio输出-使用固件库点亮led" class="router-link-active router-link-exact-active sidebar-item" aria-label="GPIO输出-使用固件库点亮LED"><!--[--><!--]--> GPIO输出-使用固件库点亮LED <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gpio输入-按键检测" class="router-link-active router-link-exact-active sidebar-item" aria-label="GPIO输入-按键检测"><!--[--><!--]--> GPIO输入-按键检测 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gpio-位带操作" class="router-link-active router-link-exact-active sidebar-item" aria-label="GPIO - 位带操作"><!--[--><!--]--> GPIO - 位带操作 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#使用位带的方式访问gpio的odr寄存器" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用位带的方式访问GPIO的ODR寄存器"><!--[--><!--]--> 使用位带的方式访问GPIO的ODR寄存器 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#启动文件详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动文件详解"><!--[--><!--]--> 启动文件详解 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#启动文件的作用" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动文件的作用"><!--[--><!--]--> 启动文件的作用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stack-栈" class="router-link-active router-link-exact-active sidebar-item" aria-label="Stack-栈"><!--[--><!--]--> Stack-栈 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#heap-堆" class="router-link-active router-link-exact-active sidebar-item" aria-label="Heap-堆"><!--[--><!--]--> Heap-堆 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#向量表" class="router-link-active router-link-exact-active sidebar-item" aria-label="向量表"><!--[--><!--]--> 向量表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#关于中断向量表存放位置问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="关于中断向量表存放位置问题"><!--[--><!--]--> 关于中断向量表存放位置问题 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#启动文件中的汇编指令总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动文件中的汇编指令总结"><!--[--><!--]--> 启动文件中的汇编指令总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#cortex内核指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="Cortex内核指令"><!--[--><!--]--> Cortex内核指令 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#rcc-时钟树" class="router-link-active router-link-exact-active sidebar-item" aria-label="RCC 时钟树"><!--[--><!--]--> RCC 时钟树 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#分频和倍频" class="router-link-active router-link-exact-active sidebar-item" aria-label="分频和倍频"><!--[--><!--]--> 分频和倍频 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#系统时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="系统时钟"><!--[--><!--]--> 系统时钟 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#hse-高速外部时钟信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="HSE 高速外部时钟信号"><!--[--><!--]--> HSE 高速外部时钟信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#锁相环-pll" class="router-link-active router-link-exact-active sidebar-item" aria-label="锁相环 PLL"><!--[--><!--]--> 锁相环 PLL <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#系统时钟-sysclk" class="router-link-active router-link-exact-active sidebar-item" aria-label="系统时钟 SYSCLK"><!--[--><!--]--> 系统时钟 SYSCLK <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#ahb-总线时钟-hclk" class="router-link-active router-link-exact-active sidebar-item" aria-label="AHB 总线时钟 HCLK"><!--[--><!--]--> AHB 总线时钟 HCLK <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#apb2-总线时钟-pclk2" class="router-link-active router-link-exact-active sidebar-item" aria-label="APB2 总线时钟 PCLK2"><!--[--><!--]--> APB2 总线时钟 PCLK2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#apb1-总线时钟-pclk1" class="router-link-active router-link-exact-active sidebar-item" aria-label="APB1 总线时钟 PCLK1"><!--[--><!--]--> APB1 总线时钟 PCLK1 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#其他时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="其他时钟"><!--[--><!--]--> 其他时钟 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#rtc-时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="RTC 时钟"><!--[--><!--]--> RTC 时钟 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32的lsi内部rc晶震不稳定" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32的LSI内部RC晶震不稳定"><!--[--><!--]--> STM32的LSI内部RC晶震不稳定 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#独立看门狗时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="独立看门狗时钟"><!--[--><!--]--> 独立看门狗时钟 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#phy-以太网时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="PHY 以太网时钟"><!--[--><!--]--> PHY 以太网时钟 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usb-phy-时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="USB PHY 时钟"><!--[--><!--]--> USB PHY 时钟 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#mco-时钟输出" class="router-link-active router-link-exact-active sidebar-item" aria-label="MCO 时钟输出"><!--[--><!--]--> MCO 时钟输出 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#为什么不直接外置高速时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么不直接外置高速时钟？"><!--[--><!--]--> 为什么不直接外置高速时钟？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#配置系统时钟实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置系统时钟实验"><!--[--><!--]--> 配置系统时钟实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#使用hse" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用HSE"><!--[--><!--]--> 使用HSE <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#使用hsi" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用HSI"><!--[--><!--]--> 使用HSI <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#mco-输出" class="router-link-active router-link-exact-active sidebar-item" aria-label="MCO 输出"><!--[--><!--]--> MCO 输出 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#下载验证" class="router-link-active router-link-exact-active sidebar-item" aria-label="下载验证"><!--[--><!--]--> 下载验证 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-中断应用概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 中断应用概述"><!--[--><!--]--> STM32 中断应用概述 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#异常类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="异常类型"><!--[--><!--]--> 异常类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#nvic-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="NVIC 简介"><!--[--><!--]--> NVIC 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#nvic-中断配置固件" class="router-link-active router-link-exact-active sidebar-item" aria-label="NVIC 中断配置固件"><!--[--><!--]--> NVIC 中断配置固件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#优先级的定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="优先级的定义"><!--[--><!--]--> 优先级的定义 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#优先级定义" class="router-link-active router-link-exact-active sidebar-item" aria-label="优先级定义"><!--[--><!--]--> 优先级定义 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#优先级分组" class="router-link-active router-link-exact-active sidebar-item" aria-label="优先级分组"><!--[--><!--]--> 优先级分组 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#中断编程" class="router-link-active router-link-exact-active sidebar-item" aria-label="中断编程"><!--[--><!--]--> 中断编程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#exti-外部中断-事件控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="EXTI 外部中断/事件控制器"><!--[--><!--]--> EXTI 外部中断/事件控制器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#exti-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="EXTI  简介"><!--[--><!--]--> EXTI  简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#exti-功能框图" class="router-link-active router-link-exact-active sidebar-item" aria-label="EXTI  功能框图"><!--[--><!--]--> EXTI  功能框图 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#中断-事件线" class="router-link-active router-link-exact-active sidebar-item" aria-label="中断/事件线"><!--[--><!--]--> 中断/事件线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#exti-初始化结构体详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="EXTI 初始化结构体详解"><!--[--><!--]--> EXTI 初始化结构体详解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#外部中断控制实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="外部中断控制实验"><!--[--><!--]--> 外部中断控制实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systick-系统定时器" class="router-link-active router-link-exact-active sidebar-item" aria-label="SysTick 系统定时器"><!--[--><!--]--> SysTick 系统定时器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systick-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="SysTick 简介"><!--[--><!--]--> SysTick 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systick-寄存器介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="SysTick 寄存器介绍"><!--[--><!--]--> SysTick 寄存器介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systick-定时器实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="SysTick 定时器实验"><!--[--><!--]--> SysTick 定时器实验 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯的基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯的基本概念"><!--[--><!--]--> 通讯的基本概念 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#串行通讯与并行通行" class="router-link-active router-link-exact-active sidebar-item" aria-label="串行通讯与并行通行"><!--[--><!--]--> 串行通讯与并行通行 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#全双工、半双工及单工通讯" class="router-link-active router-link-exact-active sidebar-item" aria-label="全双工、半双工及单工通讯"><!--[--><!--]--> 全双工、半双工及单工通讯 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#同步通讯和异步通讯" class="router-link-active router-link-exact-active sidebar-item" aria-label="同步通讯和异步通讯"><!--[--><!--]--> 同步通讯和异步通讯 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯速率" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯速率"><!--[--><!--]--> 通讯速率 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usart—串口通讯" class="router-link-active router-link-exact-active sidebar-item" aria-label="USART—串口通讯"><!--[--><!--]--> USART—串口通讯 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#串口通讯协议简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="串口通讯协议简介"><!--[--><!--]--> 串口通讯协议简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#物理层" class="router-link-active router-link-exact-active sidebar-item" aria-label="物理层"><!--[--><!--]--> 物理层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#协议层" class="router-link-active router-link-exact-active sidebar-item" aria-label="协议层"><!--[--><!--]--> 协议层 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-usart-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 USART 简介"><!--[--><!--]--> STM32 的 USART 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usart-功能框图" class="router-link-active router-link-exact-active sidebar-item" aria-label="USART 功能框图"><!--[--><!--]--> USART 功能框图 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#功能引脚" class="router-link-active router-link-exact-active sidebar-item" aria-label="功能引脚"><!--[--><!--]--> 功能引脚 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数据寄存器" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据寄存器"><!--[--><!--]--> 数据寄存器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="控制器"><!--[--><!--]--> 控制器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#小数波特率生成" class="router-link-active router-link-exact-active sidebar-item" aria-label="小数波特率生成"><!--[--><!--]--> 小数波特率生成 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usart-初始化结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="USART 初始化结构体"><!--[--><!--]--> USART 初始化结构体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usart1-收发通信实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="USART1 收发通信实验"><!--[--><!--]--> USART1 收发通信实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#代码实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码实现"><!--[--><!--]--> 代码实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#usart1-接收指令控制led" class="router-link-active router-link-exact-active sidebar-item" aria-label="USART1 接收指令控制LED"><!--[--><!--]--> USART1 接收指令控制LED <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#下载验证-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="下载验证"><!--[--><!--]--> 下载验证 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-直接存储区访问" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 直接存储区访问"><!--[--><!--]--> DMA 直接存储区访问 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 简介"><!--[--><!--]--> DMA 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-功能框图" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 功能框图"><!--[--><!--]--> DMA 功能框图 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#外设通道选择" class="router-link-active router-link-exact-active sidebar-item" aria-label="外设通道选择"><!--[--><!--]--> 外设通道选择 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#仲裁器" class="router-link-active router-link-exact-active sidebar-item" aria-label="仲裁器"><!--[--><!--]--> 仲裁器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fifo-dma-传输具有fifo-模式和直接模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="FIFO（DMA 传输具有FIFO 模式和直接模式）"><!--[--><!--]--> FIFO（DMA 传输具有FIFO 模式和直接模式） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#存储器端口、外设端口" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储器端口、外设端口"><!--[--><!--]--> 存储器端口、外设端口 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程端口" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程端口"><!--[--><!--]--> 编程端口 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-数据配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 数据配置"><!--[--><!--]--> DMA 数据配置 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-传输模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 传输模式"><!--[--><!--]--> DMA 传输模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#源地址和目标地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="源地址和目标地址"><!--[--><!--]--> 源地址和目标地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#流控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="流控制器"><!--[--><!--]--> 流控制器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#循环模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="循环模式"><!--[--><!--]--> 循环模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#传输类型-单次-single-传输-突发-burst-传输" class="router-link-active router-link-exact-active sidebar-item" aria-label="传输类型（单次(Single)传输 &amp; 突发(Burst)传输）"><!--[--><!--]--> 传输类型（单次(Single)传输 &amp; 突发(Burst)传输） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#直接模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="直接模式"><!--[--><!--]--> 直接模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#双缓冲模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="双缓冲模式"><!--[--><!--]--> 双缓冲模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-中断" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 中断"><!--[--><!--]--> DMA 中断 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-初始化结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 初始化结构体"><!--[--><!--]--> DMA 初始化结构体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-存储器到存储器实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 存储器到存储器实验"><!--[--><!--]--> DMA 存储器到存储器实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#代码实现-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码实现"><!--[--><!--]--> 代码实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dma-存储器到外设实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="DMA 存储器到外设实验"><!--[--><!--]--> DMA 存储器到外设实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-4" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#代码实现-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码实现"><!--[--><!--]--> 代码实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#下载验证-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="下载验证"><!--[--><!--]--> 下载验证 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#常用存储器" class="router-link-active router-link-exact-active sidebar-item" aria-label="常用存储器"><!--[--><!--]--> 常用存储器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#存储器种类" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储器种类"><!--[--><!--]--> 存储器种类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#ram-存储器" class="router-link-active router-link-exact-active sidebar-item" aria-label="RAM 存储器"><!--[--><!--]--> RAM 存储器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dram" class="router-link-active router-link-exact-active sidebar-item" aria-label="DRAM"><!--[--><!--]--> DRAM <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM"><!--[--><!--]--> SRAM <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#ddr-sdram" class="router-link-active router-link-exact-active sidebar-item" aria-label="DDR SDRAM"><!--[--><!--]--> DDR SDRAM <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM"><!--[--><!--]--> SRAM <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#dram-与-sram-的应用场合" class="router-link-active router-link-exact-active sidebar-item" aria-label="DRAM 与 SRAM 的应用场合"><!--[--><!--]--> DRAM 与 SRAM 的应用场合 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#非易失性存储器" class="router-link-active router-link-exact-active sidebar-item" aria-label="非易失性存储器"><!--[--><!--]--> 非易失性存储器 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#rom-存储器" class="router-link-active router-link-exact-active sidebar-item" aria-label="ROM 存储器"><!--[--><!--]--> ROM 存储器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#flash-存储器" class="router-link-active router-link-exact-active sidebar-item" aria-label="Flash 存储器"><!--[--><!--]--> Flash 存储器 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-读写eeprom" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 读写EEPROM"><!--[--><!--]--> I2C 读写EEPROM <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-协议简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 协议简介"><!--[--><!--]--> I2C 协议简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#物理层-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="物理层"><!--[--><!--]--> 物理层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#协议层-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="协议层"><!--[--><!--]--> 协议层 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-基本读写过程" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 基本读写过程"><!--[--><!--]--> I2C 基本读写过程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯的起始信号和停止信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯的起始信号和停止信号"><!--[--><!--]--> 通讯的起始信号和停止信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数据有效性" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据有效性"><!--[--><!--]--> 数据有效性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#地址及数据方向" class="router-link-active router-link-exact-active sidebar-item" aria-label="地址及数据方向"><!--[--><!--]--> 地址及数据方向 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#响应" class="router-link-active router-link-exact-active sidebar-item" aria-label="响应"><!--[--><!--]--> 响应 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-i2c-特性及架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 I2C 特性及架构"><!--[--><!--]--> STM32 的 I2C 特性及架构 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-i2c-外设简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 I2C 外设简介"><!--[--><!--]--> STM32 的 I2C 外设简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-i2c-架构剖析" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 I2C 架构剖析"><!--[--><!--]--> STM32 的 I2C 架构剖析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯引脚" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯引脚"><!--[--><!--]--> 通讯引脚 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#时钟控制逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="时钟控制逻辑"><!--[--><!--]--> 时钟控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数据控制逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据控制逻辑"><!--[--><!--]--> 数据控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#整体控制逻辑" class="router-link-active router-link-exact-active sidebar-item" aria-label="整体控制逻辑"><!--[--><!--]--> 整体控制逻辑 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯过程" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯过程"><!--[--><!--]--> 通讯过程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#中断" class="router-link-active router-link-exact-active sidebar-item" aria-label="中断"><!--[--><!--]--> 中断 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#主发送器" class="router-link-active router-link-exact-active sidebar-item" aria-label="主发送器"><!--[--><!--]--> 主发送器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#主接收器" class="router-link-active router-link-exact-active sidebar-item" aria-label="主接收器"><!--[--><!--]--> 主接收器 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-初始化结构体了解" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 初始化结构体了解"><!--[--><!--]--> I2C 初始化结构体了解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-读写-eeprom-实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 读写 EEPROM 实验"><!--[--><!--]--> I2C 读写 EEPROM 实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-4" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-4" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-5" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#代码实现-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码实现"><!--[--><!--]--> 代码实现 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#i2c-读写-eeprom-实验总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C 读写 EEPROM 实验总结"><!--[--><!--]--> I2C 读写 EEPROM 实验总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件模拟-i2c-和读写-eeprom" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件模拟 I2C 和读写 EEPROM"><!--[--><!--]--> 软件模拟 I2C 和读写 EEPROM <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-读写串行-flash" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 读写串行 Flash"><!--[--><!--]--> SPI 读写串行 Flash <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-协议简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 协议简介"><!--[--><!--]--> SPI 协议简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-物理层" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 物理层"><!--[--><!--]--> SPI 物理层 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#协议层-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="协议层"><!--[--><!--]--> 协议层 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-基本通讯过程" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 基本通讯过程"><!--[--><!--]--> SPI 基本通讯过程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯的起始和停止信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯的起始和停止信号"><!--[--><!--]--> 通讯的起始和停止信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数据有效性-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据有效性"><!--[--><!--]--> 数据有效性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#cpol-cpha-及通讯模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="CPOL/CPHA 及通讯模式"><!--[--><!--]--> CPOL/CPHA 及通讯模式 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-spi-特性及架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 SPI 特性及架构"><!--[--><!--]--> STM32 的 SPI 特性及架构 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-spi-外设简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 SPI 外设简介"><!--[--><!--]--> STM32 的 SPI 外设简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#stm32-的-spi-架构剖析" class="router-link-active router-link-exact-active sidebar-item" aria-label="STM32 的 SPI 架构剖析"><!--[--><!--]--> STM32 的 SPI 架构剖析 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯引脚-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯引脚"><!--[--><!--]--> 通讯引脚 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#时钟控制逻辑-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="时钟控制逻辑"><!--[--><!--]--> 时钟控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数据控制逻辑-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="数据控制逻辑"><!--[--><!--]--> 数据控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#整体控制逻辑-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="整体控制逻辑"><!--[--><!--]--> 整体控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯过程-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯过程"><!--[--><!--]--> 通讯过程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-初始化结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 初始化结构体"><!--[--><!--]--> SPI 初始化结构体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#spi-读写串行-flash-实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="SPI 读写串行 FLASH 实验"><!--[--><!--]--> SPI 读写串行 FLASH 实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-5" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-5" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#控制-flash-的指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="控制 FLASH 的指令"><!--[--><!--]--> 控制 FLASH 的指令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#定义-flash指令编码表" class="router-link-active router-link-exact-active sidebar-item" aria-label="定义 FLASH指令编码表"><!--[--><!--]--> 定义 FLASH指令编码表 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#flash-扇区擦除" class="router-link-active router-link-exact-active sidebar-item" aria-label="FLASH 扇区擦除"><!--[--><!--]--> FLASH 扇区擦除 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#flash-的页写入" class="router-link-active router-link-exact-active sidebar-item" aria-label="FLASH 的页写入"><!--[--><!--]--> FLASH 的页写入 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#不定量数据写入" class="router-link-active router-link-exact-active sidebar-item" aria-label="不定量数据写入"><!--[--><!--]--> 不定量数据写入 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#从-flash-读取数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="从 FLASH 读取数据"><!--[--><!--]--> 从 FLASH 读取数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#完整代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="完整代码"><!--[--><!--]--> 完整代码 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#串行-flash-文件系统-fatfs" class="router-link-active router-link-exact-active sidebar-item" aria-label="串行 FLASH 文件系统 FatFS"><!--[--><!--]--> 串行 FLASH 文件系统 FatFS <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#各类文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="各类文件系统"><!--[--><!--]--> 各类文件系统 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#一、fat-fat16-文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、FAT（FAT16）文件系统"><!--[--><!--]--> 一、FAT（FAT16）文件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#二、fat32文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、FAT32文件系统"><!--[--><!--]--> 二、FAT32文件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#三、ntfs文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、NTFS文件系统"><!--[--><!--]--> 三、NTFS文件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#四、exfat文件系统" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、exFAT文件系统"><!--[--><!--]--> 四、exFAT文件系统 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#磁盘文件系统fat、fat32、ntfs、exfat的优缺点" class="router-link-active router-link-exact-active sidebar-item" aria-label="磁盘文件系统Fat、Fat32、NTFS、exFAT的优缺点"><!--[--><!--]--> 磁盘文件系统Fat、Fat32、NTFS、exFAT的优缺点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fatfs-功能测试" class="router-link-active router-link-exact-active sidebar-item" aria-label="FatFs  功能测试"><!--[--><!--]--> FatFs  功能测试 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#文件访问" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件访问"><!--[--><!--]--> 文件访问 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#目录访问" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录访问"><!--[--><!--]--> 目录访问 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#文件和目录管理" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件和目录管理"><!--[--><!--]--> 文件和目录管理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#卷管理和系统配置" class="router-link-active router-link-exact-active sidebar-item" aria-label="卷管理和系统配置"><!--[--><!--]--> 卷管理和系统配置 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fatfs-功能使用实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="FatFs  功能使用实验"><!--[--><!--]--> FatFs  功能使用实验 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc—扩展外部sram" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC—扩展外部SRAM"><!--[--><!--]--> FSMC—扩展外部SRAM <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-控制原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM  控制原理"><!--[--><!--]--> SRAM  控制原理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-信号线" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM  信号线"><!--[--><!--]--> SRAM  信号线 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#存储器矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储器矩阵"><!--[--><!--]--> 存储器矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#地址译码器、列-i-o-及-i-o-数据电路" class="router-link-active router-link-exact-active sidebar-item" aria-label="地址译码器、列 I/O  及 I/O  数据电路"><!--[--><!--]--> 地址译码器、列 I/O  及 I/O  数据电路 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#控制电路" class="router-link-active router-link-exact-active sidebar-item" aria-label="控制电路"><!--[--><!--]--> 控制电路 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-的读写流程" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM  的读写流程"><!--[--><!--]--> SRAM  的读写流程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC"><!--[--><!--]--> FSMC <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#简介-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc-框图剖析" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC  框图剖析"><!--[--><!--]--> FSMC  框图剖析 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#通讯引脚-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="通讯引脚"><!--[--><!--]--> 通讯引脚 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#存储器控制器" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储器控制器"><!--[--><!--]--> 存储器控制器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#时钟控制逻辑-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="时钟控制逻辑"><!--[--><!--]--> 时钟控制逻辑 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc-的地址映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC  的地址映射"><!--[--><!--]--> FSMC  的地址映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc-控制-sram-的时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC  控制 SRAM  的时序"><!--[--><!--]--> FSMC  控制 SRAM  的时序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-时序结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM  时序结构体"><!--[--><!--]--> SRAM  时序结构体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#sram-初始化结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="SRAM  初始化结构体"><!--[--><!--]--> SRAM  初始化结构体 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc—扩展外部-sram-实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC—扩展外部 SRAM  实验"><!--[--><!--]--> FSMC—扩展外部 SRAM  实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-6" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-6" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-6" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#lcd-液晶显示" class="router-link-active router-link-exact-active sidebar-item" aria-label="LCD 液晶显示"><!--[--><!--]--> LCD 液晶显示 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#显示器简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="显示器简介"><!--[--><!--]--> 显示器简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#液晶显示器" class="router-link-active router-link-exact-active sidebar-item" aria-label="液晶显示器"><!--[--><!--]--> 液晶显示器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#led-和-oled-显示器" class="router-link-active router-link-exact-active sidebar-item" aria-label="LED  和 OLED  显示器"><!--[--><!--]--> LED  和 OLED  显示器 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#显示器的基本参数" class="router-link-active router-link-exact-active sidebar-item" aria-label="显示器的基本参数"><!--[--><!--]--> 显示器的基本参数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#液晶控制原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="液晶控制原理"><!--[--><!--]--> 液晶控制原理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#液晶面板的控制信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="液晶面板的控制信号"><!--[--><!--]--> 液晶面板的控制信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#液晶数据传输时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="液晶数据传输时序"><!--[--><!--]--> 液晶数据传输时序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#显存" class="router-link-active router-link-exact-active sidebar-item" aria-label="显存"><!--[--><!--]--> 显存 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#本笔记3-5寸液晶显示屏简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="本笔记3.5寸液晶显示屏简介"><!--[--><!--]--> 本笔记3.5寸液晶显示屏简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#tftlcd-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="TFTLCD 简介"><!--[--><!--]--> TFTLCD 简介 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#液晶屏的信号线及-8080-时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="液晶屏的信号线及 8080  时序"><!--[--><!--]--> 液晶屏的信号线及 8080  时序 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#使用-stm32-的-fsmc-模拟-8080-接口时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 STM32  的 FSMC  模拟 8080  接口时序"><!--[--><!--]--> 使用 STM32  的 FSMC  模拟 8080  接口时序 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc-简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC  简介"><!--[--><!--]--> FSMC  简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#用-fsmc-模拟-8080-时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="用 FSMC  模拟 8080  时序"><!--[--><!--]--> 用 FSMC  模拟 8080  时序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#nor-flash-时序结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="NOR  FLASH  时序结构体"><!--[--><!--]--> NOR  FLASH  时序结构体 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc-初始化结构体" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC  初始化结构体"><!--[--><!--]--> FSMC  初始化结构体 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#fsmc—液晶显示实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="FSMC—液晶显示实验"><!--[--><!--]--> FSMC—液晶显示实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-7" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#软件设计-7" class="router-link-active router-link-exact-active sidebar-item" aria-label="软件设计"><!--[--><!--]--> 软件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-7" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#lcd-液晶显示中英文" class="router-link-active router-link-exact-active sidebar-item" aria-label="LCD 液晶显示中英文"><!--[--><!--]--> LCD 液晶显示中英文 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#字符编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="字符编码"><!--[--><!--]--> 字符编码 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#ascii-编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="ASCII  编码"><!--[--><!--]--> ASCII  编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#中文编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="中文编码"><!--[--><!--]--> 中文编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gb2312-标准" class="router-link-active router-link-exact-active sidebar-item" aria-label="GB2312  标准"><!--[--><!--]--> GB2312  标准 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#区位码" class="router-link-active router-link-exact-active sidebar-item" aria-label="区位码"><!--[--><!--]--> 区位码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gbk-编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="GBK  编码"><!--[--><!--]--> GBK  编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gb18030" class="router-link-active router-link-exact-active sidebar-item" aria-label="GB18030"><!--[--><!--]--> GB18030 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#big5-编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="Big5  编码"><!--[--><!--]--> Big5  编码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#unicode-字符集和编码" class="router-link-active router-link-exact-active sidebar-item" aria-label="Unicode  字符集和编码"><!--[--><!--]--> Unicode  字符集和编码 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#utf-32" class="router-link-active router-link-exact-active sidebar-item" aria-label="UTF-32"><!--[--><!--]--> UTF-32 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#utf-16" class="router-link-active router-link-exact-active sidebar-item" aria-label="UTF-16"><!--[--><!--]--> UTF-16 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#utf-8" class="router-link-active router-link-exact-active sidebar-item" aria-label="UTF-8"><!--[--><!--]--> UTF-8 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#bom" class="router-link-active router-link-exact-active sidebar-item" aria-label="BOM"><!--[--><!--]--> BOM <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#字模" class="router-link-active router-link-exact-active sidebar-item" aria-label="字模"><!--[--><!--]--> 字模 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#字模的构成" class="router-link-active router-link-exact-active sidebar-item" aria-label="字模的构成"><!--[--><!--]--> 字模的构成 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#字模显示原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="字模显示原理"><!--[--><!--]--> 字模显示原理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#如何制作字模" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何制作字模"><!--[--><!--]--> 如何制作字模 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#字模寻址公式" class="router-link-active router-link-exact-active sidebar-item" aria-label="字模寻址公式"><!--[--><!--]--> 字模寻址公式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#存储字模文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储字模文件"><!--[--><!--]--> 存储字模文件 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#各种模式的液晶显示字符实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="各种模式的液晶显示字符实验"><!--[--><!--]--> 各种模式的液晶显示字符实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#硬件设计-8" class="router-link-active router-link-exact-active sidebar-item" aria-label="硬件设计"><!--[--><!--]--> 硬件设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#显示-ascii-编码的字符" class="router-link-active router-link-exact-active sidebar-item" aria-label="显示 ASCII  编码的字符"><!--[--><!--]--> 显示 ASCII  编码的字符 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#编程要点-8" class="router-link-active router-link-exact-active sidebar-item" aria-label="编程要点"><!--[--><!--]--> 编程要点 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#代码实现-4" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码实现"><!--[--><!--]--> 代码实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#显示-gb2312-编码的字符" class="router-link-active router-link-exact-active sidebar-item" aria-label="显示 GB2312  编码的字符"><!--[--><!--]--> 显示 GB2312  编码的字符 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#启动文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="启动文件"><!--[--><!--]--> 启动文件 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systeminit-函数去哪了" class="router-link-active router-link-exact-active sidebar-item" aria-label="SystemInit 函数去哪了?"><!--[--><!--]--> SystemInit 函数去哪了? <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#问题" class="router-link-active router-link-exact-active sidebar-item" aria-label="问题"><!--[--><!--]--> 问题 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#systick-系统定时器-时间不正确" class="router-link-active router-link-exact-active sidebar-item" aria-label="SysTick 系统定时器 时间不正确"><!--[--><!--]--> SysTick 系统定时器 时间不正确 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#名词解释" class="router-link-active router-link-exact-active sidebar-item" aria-label="名词解释"><!--[--><!--]--> 名词解释 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#what-is-the" class="router-link-active router-link-exact-active sidebar-item" aria-label="What is the？"><!--[--><!--]--> What is the？ <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#什么是数字信号-什么是模拟信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是数字信号？什么是模拟信号？"><!--[--><!--]--> 什么是数字信号？什么是模拟信号？ <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#数字信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="数字信号"><!--[--><!--]--> 数字信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#模拟信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="模拟信号"><!--[--><!--]--> 模拟信号 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#载波" class="router-link-active router-link-exact-active sidebar-item" aria-label="载波"><!--[--><!--]--> 载波 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#无线通信中-射频和载波指的都是模拟信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="无线通信中，射频和载波指的都是模拟信号"><!--[--><!--]--> 无线通信中，射频和载波指的都是模拟信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="时钟"><!--[--><!--]--> 时钟 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#为什么cpu需要时钟" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么CPU需要时钟？"><!--[--><!--]--> 为什么CPU需要时钟？ <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#流控制" class="router-link-active router-link-exact-active sidebar-item" aria-label="流控制"><!--[--><!--]--> 流控制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#gpio-复用概述" class="router-link-active router-link-exact-active sidebar-item" aria-label="GPIO 复用概述"><!--[--><!--]--> GPIO 复用概述 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#c库函数重定向" class="router-link-active router-link-exact-active sidebar-item" aria-label="C库函数重定向"><!--[--><!--]--> C库函数重定向 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#isp" class="router-link-active router-link-exact-active sidebar-item" aria-label="ISP"><!--[--><!--]--> ISP <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#总线矩阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="总线矩阵"><!--[--><!--]--> 总线矩阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#大小端模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="大小端模式"><!--[--><!--]--> 大小端模式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/zh/note/STM32.html#msb-lsb" class="router-link-active router-link-exact-active sidebar-item" aria-label="MSB &amp; LSB"><!--[--><!--]--> MSB &amp; LSB <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="stm32" tabindex="-1"><a class="header-anchor" href="#stm32" aria-hidden="true">#</a> STM32</h1><h2 id="what-is-stm32" tabindex="-1"><a class="header-anchor" href="#what-is-stm32" aria-hidden="true">#</a> What is STM32？</h2><h3 id="stm32的字面意思" tabindex="-1"><a class="header-anchor" href="#stm32的字面意思" aria-hidden="true">#</a> STM32的字面意思</h3><blockquote><ul><li>ST - 意法半导体，是一个公司名，即SOC厂商 <ul><li>IP厂商：内核，如ARM，专门生产内核的，如<strong>Cortex-M</strong>内核。</li><li>内核、Flash、GPIO、串口...都由芯片厂商在ARM的基础上加的。</li><li>生产芯片的叫SOC厂商</li></ul></li><li>M - Microelectronics的缩写，表示微控制器 <ul><li>微控制器，一般是针对控制，一般家用电器都是用的微控制器</li><li>微处理器，一般是处理，就像手机上的</li><li>微控制器和微处理器最主要的区别在于主频，前者能做到400MHZ已经很牛逼了，后者一般都1、2G以上了。</li><li>一般微控制器不能跑Linux操作系统，对于微处理器是必须的。</li></ul></li><li>32 - 32bit的意思，表示这是一个32bit的微控制器。</li></ul></blockquote><h3 id="stm诞生的背景" tabindex="-1"><a class="header-anchor" href="#stm诞生的背景" aria-hidden="true">#</a> STM诞生的背景</h3><blockquote><ol><li>技术的更替，这个是最主要的原因。</li><li>市场的需求（成本、性能、功耗、GUI、操作系统），传统的 8/16 位的微控制器经过岁月的洗礼，已经满足不了需求了。</li><li>ST的努力（产品线丰富、开始简单易上手-基于固件库 HAL），开STM32在众多基于 Cortex-M内核的微控制器中脱颖而出。</li></ol></blockquote><h3 id="stm32-能做什么" tabindex="-1"><a class="header-anchor" href="#stm32-能做什么" aria-hidden="true">#</a> STM32 能做什么</h3><blockquote><p>STM属于一个微控制器，自带了各种常用通信接口，功能非常强大</p></blockquote><ol><li>串口-USART，用于跟串口接口的设备通信，比如：USB转串口模块，ESP8266，WIFI、GPS｜GSM、串口屏、指纹识别模块。</li><li>内部集成电路-I2C，用于跟I2C接口的设备通信，比如：EEROM、电容屏、陀螺仪MPU6050、LED显示屏。</li><li>串行通信接口-SPI，用于跟SPI接口的设备通信，比如：串行FLASH、以太网、W5500、音频模块</li><li>SDID、FSMC、I2S、SAI、ADC、GPIO</li></ol><h3 id="stm分类" tabindex="-1"><a class="header-anchor" href="#stm分类" aria-hidden="true">#</a> STM分类</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091455055.png" alt="image-20220909145519342" style="zoom:50%;"><h3 id="stm命名方法" tabindex="-1"><a class="header-anchor" href="#stm命名方法" aria-hidden="true">#</a> STM命名方法</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091456247.png" alt="image-20220909145626210" style="zoom:50%;"><blockquote><ul><li>pin 引脚</li></ul></blockquote><h3 id="stm32怎么选型" tabindex="-1"><a class="header-anchor" href="#stm32怎么选型" aria-hidden="true">#</a> STM32怎么选型</h3><p><strong>一个原则：花最少的钱，做最多的事</strong></p><p>在确定项目需求的情况下，一般按照下面的顺序来选择合适的MCU</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091459416.png" alt="image-20220909145915369" style="zoom:50%;"><h3 id="如何分配原理图引脚" tabindex="-1"><a class="header-anchor" href="#如何分配原理图引脚" aria-hidden="true">#</a> 如何分配原理图引脚</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091500851.png" alt="image-20220909150037814" style="zoom:50%;"><h3 id="如何寻找引脚功能说明" tabindex="-1"><a class="header-anchor" href="#如何寻找引脚功能说明" aria-hidden="true">#</a> 如何寻找引脚功能说明</h3><p><code>当前目录下的STM引脚分配表格.xsl</code></p><h2 id="什么是寄存器" tabindex="-1"><a class="header-anchor" href="#什么是寄存器" aria-hidden="true">#</a> 什么是寄存器</h2><h3 id="stm32长啥样" tabindex="-1"><a class="header-anchor" href="#stm32长啥样" aria-hidden="true">#</a> STM32长啥样</h3><h4 id="_1、如何辨别正方向" tabindex="-1"><a class="header-anchor" href="#_1、如何辨别正方向" aria-hidden="true">#</a> 1、如何辨别正方向</h4><ul><li>从左上角小点开始，逆时针数器 1 ～ 144 /（x）</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091511464.png" alt="image-20220909151135425" style="zoom:50%;"><blockquote><p>贴片封装：LQFP封装</p></blockquote><h3 id="stm32内部有什么" tabindex="-1"><a class="header-anchor" href="#stm32内部有什么" aria-hidden="true">#</a> STM32内部有什么</h3><p><img src="/my-vuepress-blog/assets/image-20220909151547477-1127006d.png" alt="image-20220909151547477"></p><ul><li><p>Cortex-M4 由ARM公司设计，属于IP核</p></li><li><p>ST从ARM买下内核，在内核的基础上加一些东西：</p><ul><li>总线</li><li>FLASH</li><li>外设 <ul><li>GPIO</li><li>USART</li><li>I2C</li><li>SPI</li><li>...</li></ul></li><li>SRAM</li></ul></li><li><p>芯片里面总体是由内核（Cortex-M）+ 外核（ST公司设计）构成</p></li><li><p>最多能寻址：STM32是32位的，2^32 = 4GB</p></li><li><p>ARM规定，无论是内核还是外设，设计的东西全部得在32位的寻址能力里面。</p><ul><li>这么大的寻找空间可以随便用吗？不能！</li><li><strong>ARM内核对32位的地址空间已经分配（规定）好了</strong>，哪些地方可以放什么。<strong>32位分为8个块（block），每个块512MB</strong><ul><li>block7 - Cortex-M4内部外设</li><li>block6 - 没有使用</li><li>block5 - FSMC寄存器</li><li>block4 - FSMC的bank3 ～ bank4</li><li>block3 - FSMC的bank1 ～ bank2</li><li>block2 - 外设寄存器，Block2有512MB，像GPIO、I2C、串口、SPI、...这些全部的外设都放在这里。512MB也没有被用光。 - 外设有的速度是不一样的，比如GPIO速度很快，I2C速度非常慢，根据外设速度ST厂商又把Block2分成了好几个块（寻址空间，总线）。比如： <ul><li>AHB2 高速外设</li><li>AHB1 高速外设</li><li>APB2 高速外设</li><li>APB1 低速外设</li></ul></li><li>block1 - 用来配置内存（SRAM），STM32 407只用了192KB</li><li>block0 - 放代码 - 芯片厂商拿到内核来设计的时候，但是Block0只能用来放代码，总共可以放512MB，但是考虑成成本还有工艺的要求，做不了那么大，STM407 只用了1MB</li></ul></li></ul></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209091630888.png" alt="image-20220909163051855" style="zoom:33%;"><blockquote><p>怎么使用这些寄存器可以在：<code>STM32F4xx中文参考手册.pdf</code> 中查找，控制不同的引脚，就是控制不同的寄存器</p></blockquote><h3 id="_1、什么是存储器映射" tabindex="-1"><a class="header-anchor" href="#_1、什么是存储器映射" aria-hidden="true">#</a> 1、什么是存储器映射</h3><blockquote><p>给存储器分配地址的过程就叫存储器映射，再分配一个地址叫做重映射。</p><ul><li>STM32里面很少涉及到，了解一下这个概念。</li></ul></blockquote><h3 id="_2、什么是寄存器映射" tabindex="-1"><a class="header-anchor" href="#_2、什么是寄存器映射" aria-hidden="true">#</a> 2、什么是寄存器映射</h3><blockquote><p>寄存器映射就是对芯片里面的某一个分配好的地址，具有特殊功能的内存单元，取一个别名的过程就叫寄存器映射。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_ODR</span> <span class="token expression"><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x40021414</span></span></span>
GPIO_ODR <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="如何理解寄存器的说明" tabindex="-1"><a class="header-anchor" href="#如何理解寄存器的说明" aria-hidden="true">#</a> 如何理解寄存器的说明</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111340753.jpg" alt="regist007" style="zoom:67%;"><ul><li><p>①名称</p><p>寄存器说明中首先列出了该寄存器中的名称，“(GPIOx_BSRR)(x=A…I)”这段的意思是该寄存器名为“GPIOx_BSRR”其中的“x”可以为A-I， 也就是说这个寄存器说明适用于GPIOA、GPIOB至GPIOI，这些GPIO端口都有这样的一个寄存器。</p></li><li><p>②偏移地址</p><p>偏移地址是指本寄存器相对于这个外设的基地址的偏移。本寄存器的偏移地址是0x18，从参考手册中我们可以查到GPIOA外设的基地址为0x4002 0000 ， 我们就可以算出GPIOA的这个GPIOA_BSRR寄存器的地址为：0x4002 0000+0x18；同理，由于GPIOB的外设基地址为0x4002 0400， 可算出GPIOB_BSRR寄存器的地址为：0x4002 0400+0x18 。其他GPIO端口以此类推即可。</p></li><li><p>③寄存器位表</p><p>紧接着的是本寄存器的位表，表中列出它的0-31位的名称及权限。表上方的数字为位编号，中间为位名称，最下方为读写权限，其中w表示只写，r表示只读， rw表示可读写。本寄存器中的位权限都是w，所以只能写，如果读本寄存器，是无法保证读取到它真正内容的。而有的寄存器位只读， 一般是用于表示STM32外设的某种工作状态的，由STM32硬件自动更改，程序通过读取那些寄存器位来判断外设的工作状态。</p></li><li><p>④位功能说明</p><p>位功能是寄存器说明中最重要的部分，它详细介绍了寄存器每一个位的功能。例如本寄存器中有两种寄存器位，分别为BRy及BSy，其中的y数值可以是0-15， 这里的0-15表示端口的引脚号，如BR0、BS0用于控制GPIOx的第0个引脚，若x表示GPIOA，那就是控制GPIOA的第0引脚，而BR1、BS1就是控制GPIOA第1个引脚。</p><p>其中BRy引脚的说明是“0：不会对相应的ODRx位执行任何操作；1：对相应ODRx位进行复位”。这里的“复位”是将该位设置为0的意思， 而“置位”表示将该位设置为1；说明中的ODRx是另一个寄存器的寄存器位，我们只需要知道ODRx位为1的时候，对应的引脚x输出高电平， 为0的时候对应的引脚输出低电平即可(感兴趣的读者可以查询该寄存器GPIOx_ODR的说明了解)。所以，如果对BR0写入“1”的话， 那么GPIOx的第0个引脚就会输出“低电平”，但是对BR0写入“0”的话，却不会影响ODR0位，所以引脚电平不会改变。要想该引脚输出“高电平”， 就需要对“BS0”位写入“1”，寄存器位BSy与BRy是相反的操作。</p></li></ul><h3 id="c语言对寄存器封装" tabindex="-1"><a class="header-anchor" href="#c语言对寄存器封装" aria-hidden="true">#</a> C语言对寄存器封装</h3><p><strong><em>Stm32f407共有9组GPIO(A~I)</em>,每组16个(0~15) IO口,stm32所有寄存器都是32位的。</strong></p><p>32位寄存器中，高16位和低16位有可能是设置同一个引脚的，也有可能对其他寄存器有效，具体需要看文档</p><blockquote><p><strong>宏定义封装</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIPH_BASE</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 总线基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB1PERIPH_BASE</span>       <span class="token expression">PERIPH_BASE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB1PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00020000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x10000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* GPIO外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOB_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOC_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOD_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0C00</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOE_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOG_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOH_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1C00</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 寄存器基地址，以GPIOF为例 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_MODER</span>             <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x00</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_OTYPER</span>            <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x04</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_OSPEEDR</span>           <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x08</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_PUPDR</span>             <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x0C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_IDR</span>               <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_ODR</span>               <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x14</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_BSRR</span>              <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x18</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_LCKR</span>              <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x1C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_AFRL</span>              <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x20</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_AFRH</span>              <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE<span class="token operator">+</span><span class="token number">0x24</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 控制GPIOF 引脚6输出低电平(BSRR寄存器的BR6置1) */</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>GPIOF_BSRR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 控制GPIOF 引脚6输出高电平(BSRR寄存器的BS6置1) */</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>GPIOF_BSRR <span class="token operator">=</span> <span class="token number">0x01</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>

<span class="token keyword">unsigned</span> <span class="token keyword">int</span> temp<span class="token punctuation">;</span>
<span class="token comment">/* 控制GPIOF 端口所有引脚的电平(读IDR寄存器) */</span>
temp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>GPIOF_IDR<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用上面的方法去定义地址，还是稍显繁琐，例如GPIOA~GPIOH都各有一组功能相同的寄存器，如GPIOA_MODER/GPIOB_MODER/GPIOC_MODER等等， 它们只是地址不一样，但却要为每个寄存器都定义它的地址。为了更方便地访问寄存器，我们引入C语言中的结构体语法对寄存器进行封装</p><p><strong>宏定义+结构体封装</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span>           <span class="token keyword">int</span> <span class="token class-name">uint32_t</span><span class="token punctuation">;</span> <span class="token comment">/*无符号32位变量*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span>     <span class="token keyword">int</span> <span class="token class-name">uint16_t</span><span class="token punctuation">;</span> <span class="token comment">/*无符号16位变量*/</span>

<span class="token comment">/* GPIO寄存器列表 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   <span class="token class-name">uint32_t</span> MODER<span class="token punctuation">;</span>    <span class="token comment">/*GPIO模式寄存器             地址偏移: 0x00      */</span>
   <span class="token class-name">uint32_t</span> OTYPER<span class="token punctuation">;</span>   <span class="token comment">/*GPIO输出类型寄存器          地址偏移: 0x04      */</span>
   <span class="token class-name">uint32_t</span> OSPEEDR<span class="token punctuation">;</span>  <span class="token comment">/*GPIO输出速度寄存器          地址偏移: 0x08      */</span>
   <span class="token class-name">uint32_t</span> PUPDR<span class="token punctuation">;</span>    <span class="token comment">/*GPIO上拉/下拉寄存器         地址偏移: 0x0C      */</span>
   <span class="token class-name">uint32_t</span> IDR<span class="token punctuation">;</span>      <span class="token comment">/*GPIO输入数据寄存器          地址偏移: 0x10      */</span>
   <span class="token class-name">uint32_t</span> ODR<span class="token punctuation">;</span>      <span class="token comment">/*GPIO输出数据寄存器          地址偏移: 0x14      */</span>
   <span class="token class-name">uint16_t</span> BSRRL<span class="token punctuation">;</span>    <span class="token comment">/*GPIO置位/复位寄存器低16位部分 地址偏移: 0x18     */</span>
   <span class="token class-name">uint16_t</span> BSRRH<span class="token punctuation">;</span>    <span class="token comment">/*GPIO置位/复位寄存器高16位部分 地址偏移: 0x1A     */</span>
   <span class="token class-name">uint32_t</span> LCKR<span class="token punctuation">;</span>     <span class="token comment">/*GPIO配置锁定寄存器          地址偏移: 0x1C      */</span>
   <span class="token class-name">uint32_t</span> AFR<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">/*GPIO复用功能配置寄存器       地址偏移: 0x20-0x24  */</span>
<span class="token punctuation">}</span> GPIO_TypeDef<span class="token punctuation">;</span>

<span class="token comment">/* 外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIPH_BASE</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 总线基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB1PERIPH_BASE</span>       <span class="token expression">PERIPH_BASE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB1PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00020000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x10000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* GPIO外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOB_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOC_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOD_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0C00</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOE_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOG_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOH_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1C00</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*使用GPIO_TypeDef把地址强制转换成指针*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOA_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOB</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOB_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOC</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOC_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOD</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOD_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOE</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOE_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOF_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOG</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOG_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOH</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOH_BASE<span class="token punctuation">)</span></span></span>

<span class="token comment">/*使用定义好的宏直接访问*/</span>
<span class="token comment">/*访问GPIOF端口的寄存器*/</span>
GPIOF<span class="token operator">-&gt;</span>BSRRL <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>       <span class="token comment">//通过指针访问并修改GPIOF_BSRRL寄存器</span>
GPIOF<span class="token operator">-&gt;</span>MODER <span class="token operator">=</span> <span class="token number">0xFFFFFFF</span><span class="token punctuation">;</span>    <span class="token comment">//修改GPIOF_MODER寄存器</span>
GPIOF<span class="token operator">-&gt;</span>OTYPER <span class="token operator">=</span><span class="token number">0xFFFFFFF</span><span class="token punctuation">;</span>    <span class="token comment">//修改GPIOF_OTYPER寄存器</span>

<span class="token class-name">uint32_t</span> temp<span class="token punctuation">;</span>
temp <span class="token operator">=</span> GPIOF<span class="token operator">-&gt;</span>IDR<span class="token punctuation">;</span>          <span class="token comment">//读取GPIOF_IDR寄存器的值到变量temp中</span>

<span class="token comment">/*访问GPIOA端口的寄存器*/</span>
GPIOA<span class="token operator">-&gt;</span>BSRRL <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>       <span class="token comment">//通过指针访问并修改GPIOA_BSRRL寄存器</span>
GPIOA<span class="token operator">-&gt;</span>MODER <span class="token operator">=</span> <span class="token number">0xFFFFFFF</span><span class="token punctuation">;</span>    <span class="token comment">//修改GPIOA_MODER寄存器</span>
GPIOA<span class="token operator">-&gt;</span>OTYPER <span class="token operator">=</span><span class="token number">0xFFFFFFF</span><span class="token punctuation">;</span>    <span class="token comment">//修改GPIOA_OTYPER寄存器</span>

<span class="token class-name">uint32_t</span> temp<span class="token punctuation">;</span>
temp <span class="token operator">=</span> GPIOA<span class="token operator">-&gt;</span>IDR<span class="token punctuation">;</span>          <span class="token comment">//读取GPIOA_IDR寄存器的值到变量temp中</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h3 id="新建本地工程" tabindex="-1"><a class="header-anchor" href="#新建本地工程" aria-hidden="true">#</a> 新建本地工程</h3><p>keil 5创建工程</p><ul><li><p>创建c文件，写好main函数</p></li><li><p>自动生成文件</p><ul><li><p>Listings 存放编译器编译产生的 c/汇编/链接的列表清单</p></li><li><p>Objects 存放编译产生的调试信息、hex文件、预览信息、封装库等</p></li></ul></li><li><p>导入官方固件库 放到功能目录下，stm32 407使用 <code>startup_stm32f40xx.s</code></p><ul><li>单片机上电复位后第一个执行的程序在这个文件里面写好了</li></ul></li><li><p>尝试编译</p></li></ul><blockquote><p>报错 : .\hello.axf: Error: L6218E: Undefined symbol SystemInit (referred from startup_stm32f40xx.o).</p><p>意思是：找不到 SystemInit</p></blockquote><ol><li><p>打开 <code>startup_stm32f40xx.s</code> 文件</p></li><li><p>找到：</p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>Reset_Handler    PROC
                 EXPORT  Reset_Handler             [WEAK]
        IMPORT  SystemInit #IMPORT 在C语言中相当于 extern ：外部声明，告诉编译器这个函数是外部定义的
        # SystemInit 这个函数在后面固件库编程里面，它是用来实现系统时钟初始化的，目前没用
        IMPORT  __main  #__main 是由keil5安装的时候在根目录会提供一些C语言的库，由这些库来生成__main函数，这个函数的主要作用：初始化一些单片机的堆栈 比如说初始化成0，最后这个函数会调用 我们写的main函数
        #....
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><blockquote><ul><li><p>IMPORT 在C语言中相当于 extern ：外部声明，告诉编译器这个函数是外部定义的</p></li><li><p>SystemInit 这个函数在后面固件库编程里面，它是用来实现系统时钟初始化的，目前没用</p></li><li><p>__main 是由keil5安装的时候在根目录会提供一些C语言的库，由这些库来生成__main函数，这个函数的主要作用：初始化一些单片机的堆栈 比如说初始化成0，最后这个函数会调用 我们写的main函数</p></li><li><p>要想生成__main函数：</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111507607.png" alt="image-20220911150751467" style="zoom:50%;"></li></ul></blockquote><p>运行前配置仿真器：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111517656.png" alt="image-20220911151729607"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111518602.png" alt="image-20220911151835549"></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111522329.png" alt="image-20220911152208277" style="zoom:50%;"><p>自动运行：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111523743.png" alt=""></p><p>代码：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx.h&quot;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*函数体为空，目的是为了骗过编译器不报错*/</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行成功！</p><h3 id="寄存器点亮led" tabindex="-1"><a class="header-anchor" href="#寄存器点亮led" aria-hidden="true">#</a> 寄存器点亮LED</h3><ul><li>在只有STM32官方手册的情况下，怎么根据官方手册从0开始写程序，把灯点亮。</li></ul><p><strong>示例：</strong></p><p><strong>1、看电路图，找到LED模块</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111548670.png" alt="image-20220911154842620" style="zoom:33%;"><ul><li>可以看到它一边接了VCC3.3代表接了+3.3v，证明它是<strong>低电平有效</strong></li></ul><p><strong>2、查看LED接到哪个GPIO口</strong></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111551836.png" alt="image-20220911155150784"></p><ul><li><p>可以看到它接的引脚有两个网络标签；</p></li><li><p>PF9、PF10 ： STM32的IO口；</p></li><li><p>PF9表示接到了GPIOF的第9个引脚，PF10也是同理。</p></li><li><p>LED 0、LED 1 本开发版用于LED</p></li></ul><p><strong>3、查看STM 32 官方手册</strong></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111600609.png" alt="image-20220911160002562"></p><ul><li>找到寄存器地址</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111600686.png" alt="image-20220911160058648" style="zoom:50%;"><ul><li><p>GPIO A～I 寄存器每个寄存器有16个IO口，由GPIO A～I的基地址+偏移地址 这一堆小寄存器 <strong>配置</strong> GPIO A ～ I 的每16个IO口； 不知道应该怎么叫它们，所以在本笔记中，称这些小寄存器为 <strong>配置寄存器</strong> 吧</p></li><li><p>我们需要点亮LED，LED接到了GPIOF 的 第9、10个引脚，需要让单片机在这个引脚输出低电平。以上配置寄存器中，<strong>ORD是输出数据的 也就是高低电平，所以我们要配置它</strong>。</p></li></ul><p><strong>4、尝试点亮LED</strong></p><p>​ <img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111619864.png" alt="image-20220911161920817" style="zoom:33%;"></p><ul><li><p>可以看到偏移地址，我们的LED接到了 GPIOF的第9个引脚，</p></li><li><p>我们需要可以根据GPIOF的基地址+偏移地址找到ORD把它的第9位置0（低电平有效）</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx.h&quot;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span><span class="token operator">+</span><span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开位（不影响其他位）</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*函数体为空，目的是为了骗过编译器不报错*/</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ul><li>写入成功，但是灯并没有亮。</li><li>STM32和51单片机不一样，<strong>IO口在稍微高级的时候 会分成输入或者输出</strong></li><li>我们<strong>需要配置端口模式寄存器</strong></li></ul></blockquote><p><strong>5、配置端口模式</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111634090.png" alt="image-20220911163407030" style="zoom:33%;"><ul><li>模式寄存器有32位，控制16个IO口，1个IO口对应着2个位，PF9、PF10 对应着 模式寄存器的 MODER9、MODER10</li><li>上图复位值中，GPIOF属于其他端口，所以GPIOF的模式寄存器默认值是 0x0000 0000。</li><li>对应的模式是 00 : 输入（复位状态）</li><li>我们需要的是输出低电平，通用输出模式：01</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx.h&quot;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	<span class="token comment">//配置模式寄存器MODER9为：01（通用输出模式）</span>
	
	<span class="token comment">//2位控制一个IO口，MODERx 可能会有其他默认值，所以需要2位都先复位（置0）</span>
	<span class="token comment">//0x3的二进制是11，每一个MODERx占2位，我们要设置第9个IO口，所以是 2*9</span>
	<span class="token comment">//11左移9 = 11 00 00 00 00 00 00 00 00 00	//取反：00 11 11 11 11 11 11 11 11，关闭的就是MODER9</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//置0后再打开位</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//打开GPIOF_ODR第9位（不影响其他位）</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span><span class="token operator">+</span><span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*函数体为空，目的是为了骗过编译器不报错*/</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>尝试运行，还是不行</li><li>STM32比较讲究，它里面有非常多的外设，每个外设都由时钟来控制，这样的好处是可以降低功耗，所以<strong>默认的情况下，所有外设的时钟都是关闭的</strong></li></ul><p><strong>6、打开外设的时钟</strong></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111710365.png" alt="image-20220911171049311"></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111714334.png" alt="image-20220911171413286" style="zoom:25%;"><ul><li><p>专门有另一个外设 GCC 来控制时钟使能</p></li><li><p>我们的GPIO挂在在总线 AHB1上，所以找到 RCC_AHB1ENR，可以看到它的偏移地址是0x30</p></li><li><p>再找到它的基地址</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209111712009.png" alt="image-20220911171255926" style="zoom:25%;"></li><li><p>使能GPIOF</p></li></ul><p><strong>再次运行：</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//打开GPIOF的时钟</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40023800</span> <span class="token operator">+</span> <span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置模式寄存器MODER9为：01（通用输出模式）</span>
	<span class="token comment">//2位控制一个IO口，MODERx 可能会有其他默认值，所以需要2位都先复位（置0）</span>
	<span class="token comment">//0x3的二进制是11，每一个MODERx占2位，我们要设置第9个IO口，所以是 2*9</span>
	<span class="token comment">//11左移9 = 11 00 00 00 00 00 00 00 00 00	//取反：00 11 11 11 11 11 11 11 11，关闭的就是MODER9</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x03</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x03</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//置0后再打开位</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0x40021400</span> <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*函数体为空，目的是为了骗过编译器不报错*/</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>总结：</strong></p><ol><li>确定GPIO是输入、通用输出、复用功能还是模拟输入（模式寄存器：MODER）</li><li>如果书去还要确定是推挽输出还是开漏输出（输出类型寄存器，OTYPER）</li><li>配置输出的速度（输出速度寄存器：OSPEEDR）</li><li>输出的时候内部上/下拉电阻要不要开启（上拉/下拉寄存器）PUPDR</li><li>具体要输出的内容（置位复位寄存器：BSRR 或 数据输出寄存器：ODR）</li></ol></blockquote><h3 id="寄存器封装" tabindex="-1"><a class="header-anchor" href="#寄存器封装" aria-hidden="true">#</a> 寄存器封装</h3><p><code>stm32f4xx.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/*用来存放寄存器相关的代码*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span>           <span class="token keyword">int</span> <span class="token class-name">uint32_t</span><span class="token punctuation">;</span> <span class="token comment">/*无符号32位变量*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span>     <span class="token keyword">int</span> <span class="token class-name">uint16_t</span><span class="token punctuation">;</span> <span class="token comment">/*无符号16位变量*/</span>

<span class="token comment">/* GPIO寄存器列表 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> MODER<span class="token punctuation">;</span>    <span class="token comment">/*GPIO模式寄存器             地址偏移: 0x00      */</span>
<span class="token class-name">uint32_t</span> OTYPER<span class="token punctuation">;</span>   <span class="token comment">/*GPIO输出类型寄存器          地址偏移: 0x04      */</span>
<span class="token class-name">uint32_t</span> OSPEEDR<span class="token punctuation">;</span>  <span class="token comment">/*GPIO输出速度寄存器          地址偏移: 0x08      */</span>
<span class="token class-name">uint32_t</span> PUPDR<span class="token punctuation">;</span>    <span class="token comment">/*GPIO上拉/下拉寄存器         地址偏移: 0x0C      */</span>
<span class="token class-name">uint32_t</span> IDR<span class="token punctuation">;</span>      <span class="token comment">/*GPIO输入数据寄存器          地址偏移: 0x10      */</span>
<span class="token class-name">uint32_t</span> ODR<span class="token punctuation">;</span>      <span class="token comment">/*GPIO输出数据寄存器          地址偏移: 0x14      */</span>
<span class="token class-name">uint16_t</span> BSRRL<span class="token punctuation">;</span>    <span class="token comment">/*GPIO置位/复位寄存器低16位部分 地址偏移: 0x18     */</span>
<span class="token class-name">uint16_t</span> BSRRH<span class="token punctuation">;</span>    <span class="token comment">/*GPIO置位/复位寄存器高16位部分 地址偏移: 0x1A     */</span>
<span class="token class-name">uint32_t</span> LCKR<span class="token punctuation">;</span>     <span class="token comment">/*GPIO配置锁定寄存器          地址偏移: 0x1C      */</span>
<span class="token class-name">uint32_t</span> AFR<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">/*GPIO复用功能配置寄存器       地址偏移: 0x20-0x24  */</span>
<span class="token punctuation">}</span> GPIO_TypeDef<span class="token punctuation">;</span>

<span class="token comment">/* 外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIPH_BASE</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">0x40000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 总线基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB1PERIPH_BASE</span>       <span class="token expression">PERIPH_BASE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">APB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00010000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB1PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x00020000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AHB2PERIPH_BASE</span>       <span class="token expression"><span class="token punctuation">(</span>PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x10000000</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* GPIO外设基地址 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOB_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOC_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOD_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x0C00</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOE_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1400</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOG_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOH_BASE</span>            <span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x1C00</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/*使用GPIO_TypeDef把地址强制转换成指针*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOA</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOA_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOB</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOB_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOC</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOC_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOD</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOD_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOE</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOE_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOF_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOG</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOG_BASE<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOH</span>               <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> GPIOH_BASE<span class="token punctuation">)</span></span></span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token class-name">uint32_t</span> RCC_CR<span class="token punctuation">;</span>				<span class="token comment">//0x00</span>
	<span class="token class-name">uint32_t</span> RCC_PLLCFGR<span class="token punctuation">;</span>		<span class="token comment">//0x04</span>
	<span class="token class-name">uint32_t</span> RCC_CFGR<span class="token punctuation">;</span>			<span class="token comment">//0x08</span>
	<span class="token class-name">uint32_t</span> RCC_CIR<span class="token punctuation">;</span>				<span class="token comment">//0x0C	</span>
	<span class="token class-name">uint32_t</span> RCC_AHB1RSTR<span class="token punctuation">;</span>	<span class="token comment">//0x10</span>
	<span class="token class-name">uint32_t</span> RCC_AHB2RSTR<span class="token punctuation">;</span>	<span class="token comment">//0x14</span>
	<span class="token class-name">uint32_t</span> RCC_AHB3RSTR<span class="token punctuation">;</span>	<span class="token comment">//0x18</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x1C									//无名位域一般是用来填充或调整成员在内存之间的位置	</span>
	<span class="token class-name">uint32_t</span> RCC_APB1RSTR<span class="token punctuation">;</span>	<span class="token comment">//0x20</span>
	<span class="token class-name">uint32_t</span> RCC_APB2RSTR<span class="token punctuation">;</span>	<span class="token comment">//0x24</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x28</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x2C</span>
	<span class="token class-name">uint32_t</span> RCC_AHB1ENR<span class="token punctuation">;</span>		<span class="token comment">//0x30</span>
	<span class="token class-name">uint32_t</span> RCC_AHB2ENR<span class="token punctuation">;</span>		<span class="token comment">//0x34</span>
	<span class="token class-name">uint32_t</span> RCC_AHB3ENR<span class="token punctuation">;</span>		<span class="token comment">//0x38</span>
	<span class="token class-name">uint32_t</span> RCC_APB1ENR<span class="token punctuation">;</span>		<span class="token comment">//0x40</span>
	<span class="token class-name">uint32_t</span> RCC_APB2ENR<span class="token punctuation">;</span>		<span class="token comment">//0x44</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x48</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x4C</span>
	<span class="token class-name">uint32_t</span> RCC_AHB1LPENR<span class="token punctuation">;</span>	<span class="token comment">//0x50</span>
	<span class="token class-name">uint32_t</span> RCC_AHB2LPENR<span class="token punctuation">;</span>	<span class="token comment">//0x54</span>
	<span class="token class-name">uint32_t</span> RCC_AHB3LPENR<span class="token punctuation">;</span>	<span class="token comment">//0x58</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x5C</span>
	<span class="token class-name">uint32_t</span> RCC_APB1LPENR<span class="token punctuation">;</span>	<span class="token comment">//0x60</span>
	<span class="token class-name">uint32_t</span> RCC_APB2LPENR<span class="token punctuation">;</span>	<span class="token comment">//0x64</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x68	//无名位域一般是用来填充或调整成员在内存之间的位置	</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x6C</span>
	<span class="token class-name">uint32_t</span> RCC_BDCR<span class="token punctuation">;</span>			<span class="token comment">//0x70</span>
	<span class="token class-name">uint32_t</span> RCC_CSR<span class="token punctuation">;</span>				<span class="token comment">//0x74</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x78</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x7C</span>
	<span class="token class-name">uint32_t</span> RCC_SSCGR<span class="token punctuation">;</span>			<span class="token comment">//0x80</span>
	<span class="token class-name">uint32_t</span> RCC_PLLI2SCFGR<span class="token punctuation">;</span><span class="token comment">//0x84</span>
	<span class="token class-name">uint32_t</span> <span class="token operator">:</span><span class="token number">32</span><span class="token punctuation">;</span>						<span class="token comment">//0x88</span>
	<span class="token class-name">uint32_t</span> RCC_DCKCFGR<span class="token punctuation">;</span>		<span class="token comment">//0x8C</span>
<span class="token punctuation">}</span> RCC_TypeDef<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCC_BASE</span>			<span class="token expression"><span class="token punctuation">(</span>AHB1PERIPH_BASE <span class="token operator">+</span> <span class="token number">0x3800</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCC</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span>RCC_TypeDef <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>RCC_BASE<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SET_BIT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span> 		<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">|=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">RESET_BIT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span>	<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>stm32f4xx_gpio.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_STM32F4XXX_GPIO_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_STM32F4XXX_GPIO_H_</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_STM32F4XXX_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_0</span> 		<span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_1</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_2</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_3</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_4</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_5</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_6</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_7</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_8</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">8</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_9</span>    <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">9</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_10</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_11</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_12</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_13</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_14</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_15</span>   <span class="token expression"><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO_PIN_ALL</span>  <span class="token expression"><span class="token punctuation">(</span> <span class="token number">0xffff</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

 <span class="token comment">/* GPIO_MODE_TypeDef
 复位值：
 0xA800 0000（端口 A）
 0x0000 0280（端口 B）
 0x0000 0000（其它端口）
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span><span class="token punctuation">{</span>
	GPIO_MODE_IN  <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token comment">//Input									//输入（复位状态）</span>
	GPIO_MODE_OUT <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span><span class="token comment">//Output									//通用输出模式</span>
	GPIO_MODE_AF  <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span><span class="token comment">//Alternate functions		//复用功能模式</span>
	GPIO_MODE_AN  <span class="token operator">=</span> <span class="token number">0x03</span> <span class="token comment">//Analog									//模拟模式</span>
<span class="token punctuation">}</span> GPIO_MODE_TypeDef<span class="token punctuation">;</span>


 <span class="token comment">/* GPIO_OTYPER_TypeDef
 复位值：
 0x0000 0000
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span><span class="token punctuation">{</span>
	GPIO_OTYPER_PP  <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token comment">//push-pull							//输出推挽（复位状态）</span>
	GPIO_OTYPER_OD  <span class="token operator">=</span> <span class="token number">0x01</span> <span class="token comment">//open drain							//输出开漏</span>
<span class="token punctuation">}</span> GPIO_OTYPER_TypeDef<span class="token punctuation">;</span>


<span class="token comment">/* GPIO_SPEED_TypeDef
 复位值：
 0x0000 00C0（端口 B）
 0x0000 0000（其它端口）
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span><span class="token punctuation">{</span>
	GPIO_SPEED_2MHZ   <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>												<span class="token comment">//2 MHz（低速） </span>
	GPIO_SPEED_25MHZ  <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span>												<span class="token comment">//25 MHz（中速）</span>
	GPIO_SPEED_50MHZ  <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span>												<span class="token comment">//50 MHz（快速）</span>
	GPIO_SPEED_100MHZ <span class="token operator">=</span> <span class="token number">0x03</span>												<span class="token comment">//30 pF 时为 100 MHz（高速）（15 pF 时为 80 MHz 输出（最大速度））</span>
<span class="token punctuation">}</span> GPIO_SPEED_TypeDef<span class="token punctuation">;</span>


<span class="token comment">/* GPIO_PUPDR_TypeDef
 复位值：
 0x6400 0000（端口 A）
 0x0000 0100（端口 B）
 0x0000 0000（其它端口）
*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span><span class="token punctuation">{</span>
	GPIO_PUPDR_NOPULL    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span><span class="token comment">//无上拉或下拉</span>
	GPIO_PUPDR_UP        <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">,</span><span class="token comment">//上拉</span>
	GPIO_PUPDR_DOWN   	 <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">,</span><span class="token comment">//下拉</span>
	GPIO_PUPDR_DISABLED  <span class="token operator">=</span> <span class="token number">0x03</span> <span class="token comment">//保留</span>
<span class="token punctuation">}</span> GPIO_PUPDR_TypeDef<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
	<span class="token class-name">uint16_t</span> GPIO_PIN<span class="token punctuation">;</span>
	GPIO_MODE_TypeDef MODER<span class="token punctuation">;</span>
	GPIO_OTYPER_TypeDef OTYPER<span class="token punctuation">;</span>
	GPIO_SPEED_TypeDef OSPEEDR<span class="token punctuation">;</span>
	GPIO_PUPDR_TypeDef PUPDR<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> GPIO_INIT_TypeDef<span class="token punctuation">;</span>

 
 
 <span class="token keyword">void</span>  <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIO_TypeDef<span class="token operator">*</span> GPIOx<span class="token punctuation">,</span>GPIO_INIT_TypeDef<span class="token operator">*</span> GPIO_INIT_Struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>stm32f4xx_gpio.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx_gpio.h&quot;</span></span>

<span class="token keyword">void</span>  <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIO_TypeDef<span class="token operator">*</span> GPIOx<span class="token punctuation">,</span>GPIO_INIT_TypeDef<span class="token operator">*</span> GPIO_INIT_Struct<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//根据引脚在32位中的表示获取它是第几位</span>
	<span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>GPIO_PIN<span class="token operator">==</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			pos<span class="token operator">=</span>i<span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	GPIOx<span class="token operator">-&gt;</span>MODER <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIOx<span class="token operator">-&gt;</span>MODER <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>MODER <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIOx<span class="token operator">-&gt;</span>PUPDR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIOx<span class="token operator">-&gt;</span>PUPDR <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>PUPDR <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//如果是 通用输出模式 或者 复用功能模式</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>MODER<span class="token operator">==</span>GPIO_MODE_OUT <span class="token operator">||</span> GPIO_INIT_Struct<span class="token operator">-&gt;</span>MODER<span class="token operator">==</span>GPIO_MODE_AF<span class="token punctuation">)</span><span class="token punctuation">{</span>
		GPIOx<span class="token operator">-&gt;</span>OSPEEDR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		GPIOx<span class="token operator">-&gt;</span>OSPEEDR <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>OSPEEDR <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		GPIOx<span class="token operator">-&gt;</span>PUPDR <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		GPIOx<span class="token operator">-&gt;</span>PUPDR <span class="token operator">|=</span> <span class="token punctuation">(</span>GPIO_INIT_Struct<span class="token operator">-&gt;</span>PUPDR <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xxx_gpio.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*
	//打开GPIOF的时钟
	SET_BIT(RCC-&gt;RCC_AHB1ENR,5);
	
	RESET_BIT(GPIOF-&gt;MODER,2*9);
	RESET_BIT(GPIOF-&gt;MODER,2*9+1);
	
	RESET_BIT(GPIOF-&gt;MODER,2*10);
	RESET_BIT(GPIOF-&gt;MODER,2*10+1);
	
	SET_BIT(GPIOF-&gt;MODER,2*9);
	SET_BIT(GPIOF-&gt;MODER,2*10);
	
	RESET_BIT(GPIOF-&gt;ODR,9);
	RESET_BIT(GPIOF-&gt;ODR,10);
	*/</span>
	<span class="token function">SET_BIT</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>RCC_AHB1ENR<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_INIT_TypeDef GPIO_INIT_Struct1<span class="token punctuation">;</span>
	GPIO_INIT_Struct1<span class="token punctuation">.</span>GPIO_PIN<span class="token operator">=</span>GPIO_PIN_9<span class="token punctuation">;</span>
	GPIO_INIT_Struct1<span class="token punctuation">.</span>MODER<span class="token operator">=</span>GPIO_MODE_OUT<span class="token punctuation">;</span>
	GPIO_INIT_Struct1<span class="token punctuation">.</span>OTYPER<span class="token operator">=</span>GPIO_OTYPER_PP<span class="token punctuation">;</span>
	GPIO_INIT_Struct1<span class="token punctuation">.</span>OSPEEDR<span class="token operator">=</span>GPIO_SPEED_2MHZ<span class="token punctuation">;</span>
	GPIO_INIT_Struct1<span class="token punctuation">.</span>PUPDR<span class="token operator">=</span>GPIO_PUPDR_UP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOF <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_INIT_Struct1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_INIT_TypeDef GPIO_INIT_Struct2<span class="token punctuation">;</span>
	GPIO_INIT_Struct2<span class="token punctuation">.</span>GPIO_PIN<span class="token operator">=</span>GPIO_PIN_10<span class="token punctuation">;</span>
	GPIO_INIT_Struct2<span class="token punctuation">.</span>MODER<span class="token operator">=</span>GPIO_MODE_OUT<span class="token punctuation">;</span>
	GPIO_INIT_Struct2<span class="token punctuation">.</span>OTYPER<span class="token operator">=</span>GPIO_OTYPER_PP<span class="token punctuation">;</span>
	GPIO_INIT_Struct2<span class="token punctuation">.</span>OSPEEDR<span class="token operator">=</span>GPIO_SPEED_2MHZ<span class="token punctuation">;</span>
	GPIO_INIT_Struct2<span class="token punctuation">.</span>PUPDR<span class="token operator">=</span>GPIO_PUPDR_UP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOF <span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_INIT_Struct2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token class-name">uint32_t</span> hello <span class="token operator">=</span> <span class="token number">0x02ffff</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>hello<span class="token operator">&lt;=</span><span class="token number">0x001111</span><span class="token punctuation">)</span>hello<span class="token operator">=</span><span class="token number">0x00ffff</span><span class="token punctuation">;</span>
		<span class="token function">RESET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token function">SET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">SET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RESET_BIT</span><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>ODR<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
		hello<span class="token operator">-=</span><span class="token number">0x001111</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SystemInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/*函数体为空，目的是为了骗过编译器不报错*/</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="stm32-固件库" tabindex="-1"><a class="header-anchor" href="#stm32-固件库" aria-hidden="true">#</a> STM32 固件库</h2><h3 id="什么是固件库" tabindex="-1"><a class="header-anchor" href="#什么是固件库" aria-hidden="true">#</a> 什么是固件库</h3><ol><li>固化到EEPROM（很少用了） 或者 Flash。</li><li>操作的是最底层的设备。</li></ol><h3 id="如何获取固件库" tabindex="-1"><a class="header-anchor" href="#如何获取固件库" aria-hidden="true">#</a> 如何获取固件库</h3><ul><li><p>本地：<code>./md/STM32/STM32F4xx固件库</code></p></li><li><p>官网获取：</p><ul><li>[STMCU中文官网](https://www.stmcu.com.cn/Designresource/list/STM32 MCU/firmware_software/firmware_software)</li></ul></li></ul><p><strong>文件结构：</strong></p><ul><li><p><code>Libraries</code></p><ul><li>库源码</li><li>启动文件</li><li><code>CMSIS</code><ul><li>这是个标准，它是ARM公司规定的，要怎么写，要怎么命名</li><li>里面有一个<code>stm32f4xx.h</code>,所有的寄存器映射都在里面</li></ul></li><li><code>STM32F4xxStdPeriph_Driver</code><ul><li>固件库</li></ul></li></ul></li><li><p><code>Project</code></p><ul><li>驱动示例</li><li>工程模板</li><li><code>STM32F4xxStdPeriph_Examples</code><ul><li>官方例子</li></ul></li><li><code>STM32F4xxStdPeriph_Templates</code><ul><li>官方模板</li></ul></li></ul></li><li><p><code>Utilities</code></p><ul><li>基于ST官方开发版的例程</li></ul></li><li><p><code>Release_Notes.html</code></p><ul><li>库版本更新说明</li></ul></li><li><p><code>stm32f4xx_dsp_stdperiph_lib_um.chm</code></p><ul><li>库使用帮助文档</li></ul></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140259327.png" alt="image-20220914025916622"></p><h3 id="新建工程-库函数版" tabindex="-1"><a class="header-anchor" href="#新建工程-库函数版" aria-hidden="true">#</a> 新建工程-库函数版</h3><p>为了工程目录更加清晰，我们在本地电脑新建一个 &quot;工程模板&quot; 文件夹，在它之下再新建 6 个文件夹：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140329853.png" alt="image-20220914032953785"></p><table><thead><tr><th style="text-align:center;">名称</th><th>作用</th></tr></thead><tbody><tr><td style="text-align:center;">Doc</td><td>用来存放程序说明的文件，由编写程序的人添加</td></tr><tr><td style="text-align:center;">Libraries</td><td>存放库文件</td></tr><tr><td style="text-align:center;">Listing</td><td>存放编译器编译时长生的C/汇编/链接的列表清单</td></tr><tr><td style="text-align:center;">Output</td><td>存放编译产生的调试信息、hex文件、预览信息、封装库等</td></tr><tr><td style="text-align:center;">Project</td><td>用来存放工程文件</td></tr><tr><td style="text-align:center;">User</td><td>用户编写的驱动文件</td></tr></tbody></table><p>再本地新建好文件夹后，把准备好的库文件添加到相应的文件夹下，即从固件库里面把这些文件到我们新建的工程下的文件夹里面。</p><table><thead><tr><th style="text-align:center;">名称</th><th>作用</th></tr></thead><tbody><tr><td style="text-align:center;">Doc</td><td>工程说明.txt</td></tr><tr><td style="text-align:center;">Libraries</td><td>CMSIS：里面存放着跟CM3内核有关的库文件；<br>STM32F4xx_StdPeriph_Driver: STM外设库文件</td></tr><tr><td style="text-align:center;">Listing</td><td>暂时为空</td></tr><tr><td style="text-align:center;">Output</td><td>暂时为空</td></tr><tr><td style="text-align:center;">Project</td><td>暂时为空</td></tr><tr><td style="text-align:center;">User</td><td>stm32f4xx_it.h<br>stm32f4xx_it.c 中断相关的函数都在这个文件编写，暂时为空<br>main.c main函数文件</td></tr></tbody></table><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140346459.png" alt="image-20220914034642336"></p><ul><li>把固件库 Libraries 下的文件拷贝到 工程模板 下的 Libraries</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140357490.png" alt="image-20220914035701387" style="zoom:33%;"><ul><li><code>\工程模板\Libraries\STM32F4xx_StdPeriph_Driver\inc</code>里面是芯片的所有外设驱动，需要保留</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140358244.png" alt="image-20220914035809136"></p><ul><li><code>工程模板\Libraries\CMSIS\</code>下，除了Device、Include 其他全部删除，是没有用的</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140400978.png" alt="image-20220914040021938" style="zoom:33%;"><ul><li>这些是跟内核相关的，比如：内存的寄存器映射、内核外设函数的操作 等，都在里面</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140402608.png" alt="image-20220914040243556"></p><ul><li><code>stm32f4xx.h</code> : 所有芯片外设寄存器的映射头文件</li><li><code>system_stm32f4xx.h</code> : 实现系统初始化、配置系统时钟、等 也就是我们前面提到的 <code>SystemInit</code> 函数</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140406407.png" alt="image-20220914040620363"></p><ul><li><p><code>arm</code> : 跟编译器相关的（Keil5）</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140409996.png" alt="image-20220914040933882" style="zoom:33%;"><p>​ 全部都是汇编编写的启动文件</p></li></ul></li><li><p><code>gcc_ride7</code> : 编译器，没有用到，删除</p></li><li><p><code>iar</code> : 编译器，没有用到，删除</p></li><li><p><code>TASKING</code> : 编译器，没有用到，删除</p><p><code>TrueSTUDIO</code> : 编译器，没有用到，删除</p></li><li><p><code>system_stm32f4xx.c</code> 是 <code>system_stm32f4xx.h</code>的实现</p></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140348829.png" alt="image-20220914034847736"></p><ul><li>把固件库 Project/STM32F4xx_StdPeriph_Templates 的几个文件拷贝到 工程模板的 User文件夹下</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140351579.png" alt="image-20220914035125515"></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140351408.png" alt="image-20220914035154331" style="zoom:50%;"><ul><li>把 stm32f4xx_it.c 里面的 <code>#include &quot;main.h&quot;</code> 和 <code>TimingDelay_decrement();</code> 删掉，我们工程模板不需要这些。</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140354332.png" alt="image-20220914035438276" style="zoom:33%;"><ul><li><code>main.c</code>的内容也全部删除，字节写</li></ul><p><strong>开始新建工程</strong></p><p>在 <code>Project/</code>下创建文件夹：<code>RVMDK-uv5</code>，表示Keil5开发工具的工程，在其他开发工具配置可以再新建另一个文件</p><ul><li><p>在 <code>RVMDK-uv5</code> 或 开发工具目录下创建项目</p></li><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140415670.png" alt="image-20220914041503609" style="zoom:25%;"><p>&quot;管理运行时环境&quot; 表示在线添加固件库，我们已经本地添加了，不需要，关闭它</p></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140418821.png" alt="image-20220914041823720"></p><ul><li>可以修改这个目标名称，默认是 <code>Target1</code> 这个名字没有什么意义，可以改成有意义的名字</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140422470.png" alt="image-20220914042222373"></p><ul><li>添加组，以清晰分类文件</li><li><code>STARTUP</code> : 启动文件</li><li><code>CMSIS</code> : ST根据ARM标准写的库文件</li><li><code>STM32FxxStdPeriph_Driver</code> : 芯片外设驱动文件</li><li><code>USER</code> : 用户自己写的文件，比如main函数、跟中断相关的函数</li><li><code>DOC</code> : 文档</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140426987.png" alt="image-20220914042656935" style="zoom:33%;"><ul><li><code>工程模板\Libraries\CMSIS\Device\ST\STM32F4xx\Source\Templates\arm</code></li><li>添加启动文件</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140428467.png" alt="image-20220914042831384" style="zoom:33%;"><ul><li><p><code>工程模板\Libraries\CMSIS\Device\ST\STM32F4xx\Source\Templates</code></p></li><li><p>添加 跟单片机系统初始化和系统时钟相关的 文件，有了这个文件在执行启动文件的时候，就可以把系统时钟配置成 168MHZ了，在main函数之前 它的系统时钟已经配置好了</p></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209140431415.png" alt="image-20220914043156328"></p><ul><li><code>工程模板\Libraries\STM32F4xx_StdPeriph_Driver\src</code></li><li>添加芯片的寄存器库，全选</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141152304.png" alt="image-20220914115248249"></p><ul><li>添加main和stm32f4xx_it.c文件</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141153111.png" alt="image-20220914115344058"></p><ul><li>这里可以添加说明文件，或文档</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141201069.png" alt="image-20220914120135969"></p><ul><li>添加所有头文件，否则会找不到头文件</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141206212.png" alt="image-20220914120623159"></p><ul><li>指定芯片型号</li><li>因为库文件包含了所有的芯片，需要告诉编译器是哪一个芯片</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141210106.png" alt="image-20220914121059053" style="zoom:33%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141211925.png" alt="image-20220914121124871" style="zoom:33%;"><ul><li>屏蔽库文件 <ul><li><code>stm32f4xx_dma2d.c</code> : F407没有对应的外设，F429以上才有</li><li><code>stm32f4xx_fmc.c</code> : 用于驱动SDRAM的，F407不支持</li><li><code>stm32f4xx_ltdc.c</code> : 用于支持RGB屏幕的，F407不支持</li></ul></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141221700.png" alt="image-20220914122119636"></p><ul><li><p>在使用Keil5编译过程出现“../CMSIS/Include\core_cmFunc.h(629): error: unknown register name &#39;vfpcc&#39; in asm”。其原因一般是使用了compiler version 6进行编译，解决方法：将Target标签下的ARM complier改为版本5即可，具体如下图：</p></li><li><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141221345.png" alt="image-20220914122157248"></p></li><li><p>将ARM complier改为版本5</p></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141222732.png" alt="image-20220914122232640"></p><ul><li>编译成功！</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141224186.png" alt="image-20220914122448075" style="zoom:33%;"><ul><li><p>勾上这个才能够使用 <code>__main</code> 这个函数</p></li><li><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141226214.png" alt="image-20220914122601105"></p></li><li><p><code>__main</code> 函数最主要的作用是</p><ul><li>初始化遍历</li><li>在函数的末尾调用main，也就是用户编写的main</li><li>当它执行完之后才能由汇编启动文件，跳转到C文件里面</li></ul></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141229151.png" alt="image-20220914122942047" style="zoom:33%;"><ul><li>指定 存放编译器编译产生的 c/汇编/链接的列表清单 输出目录</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141231065.png" alt="image-20220914123100960" style="zoom:33%;"><ul><li>指定 存放编译产生的调试信息、hex文件、预览信息、封装库等 输出目录</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141236904.png" alt="image-20220914123619841"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141236473.png" alt="image-20220914123648412"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141241872.png" alt="image-20220914124142801"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141241825.png" alt="image-20220914124123697"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141243837.png" alt="image-20220914124324773"></p><ul><li>编译并下载到仿真器运行成功！</li></ul><h3 id="gpio输出-使用固件库点亮led" tabindex="-1"><a class="header-anchor" href="#gpio输出-使用固件库点亮led" aria-hidden="true">#</a> GPIO输出-使用固件库点亮LED</h3><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142225275.png" alt="image-20220914222528183"></p><ul><li>复制前面的工程模板，并在User目录下面创建LED文件夹，用于区分不同的硬件驱动</li><li>在LED下面创建LED相关的头文件和源文件</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142231362.png" alt="image-20220914223158286"></p><ul><li>找不到头文件</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142233382.png" alt="image-20220914223306319"></p><ul><li>配置头文件路径</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142233234.png" alt="image-20220914223351095"></p><ul><li>编译成功</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142235100.png" alt="image-20220914223531974"></p><ul><li>打卡头文件</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142246981.png" alt="image-20220914224624896"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142246336.png" alt="image-20220914224648219"></p><ul><li>所有外设的初始化可以分为四个步骤</li><li>接下来我们要打开GPIO时钟，RCC使能，前面寄存器有提到所有GPIO外设在AHB1外设总线：</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142250569.png" alt="image-20220914225011431"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209141206212.png" alt="image-20220914120623159"></p><ul><li>固件库是针对F4系列的，它有非常多的型号，407、405、429等等。我们用的是407，有的东西可以不支持，所以这些宏定义用处就在这里</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142253546.png" alt="image-20220914225353343"></p><ul><li>GPIO在AHB1这个总线上，这个函数用来控制AHB1总线上所有外设的<strong>使能</strong>或<strong>失能</strong></li><li>其他总线，可以看它的函数名，都是差不多的</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142305324.png" alt="image-20220914230530174"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142325910.png" alt="image-20220914232519824"></p><ul><li>打开GPIO时钟</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142326727.png" alt="image-20220914232659631"></p><ul><li>初始化结构体定义</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142330923.png" alt="image-20220914233039827"></p><ul><li>IO口定义</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142340748.png" alt="image-20220914234015647"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142341204.png" alt="image-20220914234142108"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142340959.png" alt="image-20220914234042853"></p><p>尝试编译：</p><ul><li><p>报错：<code>..\..\..\宸ョ▼妯℃澘\User\bsp_led.c(12): error: #268: declaration may not appear after executable statement in block</code></p></li><li><p>“错误：#268:声明不能出现在块中的可执行语句之后”</p></li><li><p>解决：默认编译器是C89模式标准，变量需要定义在代码块开头，把模式换成C99</p></li><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142346956.png" alt="image-20220914234637856" style="zoom:25%;"></li><li><p>编译通过！</p></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209142349239.png" alt="image-20220914234903145"></p><ul><li>设置IO口</li></ul><p><strong>完整代码</strong></p><p><code>bsp_led.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_LED_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_LED_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span>		<span class="token comment">//导入寄存器映射</span></span>

<span class="token keyword">void</span> <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_LED_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_led.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* 以下四个步骤适用所有外设的初始化 */</span>
	
	<span class="token comment">/* 第一步：打开GPIO的时钟 */</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOF<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 第二步：定义一个GPIO初始化结构体 */</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	<span class="token comment">/* 第三步：配置GPIO初始化结构体成员 */</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_2MHz<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	
	<span class="token comment">/* 第四步：调用GPIO初始化函数，把配置好的结构体成员参数写入寄存器 */</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">/* ******************************************************** */</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x2fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x2fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* 在这里添加自己的代码 */</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>实现LED流水灯效果</li></ul><h3 id="gpio输入-按键检测" tabindex="-1"><a class="header-anchor" href="#gpio输入-按键检测" aria-hidden="true">#</a> GPIO输入-按键检测</h3><ul><li><p>**软件防抖：**按键机械触点断开、闭合时，由于触点的弹性作用，按键开关不会马上稳定接通或一下子断开， 使用按键时会产生图按键抖动说明图 中的带波纹信号，需要用软件消抖处理滤波，不方便输入检测。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209150037147.png" alt="image-20220915003753018" style="zoom:25%;"></li><li><p>**硬件防抖：**有的开发版按键带硬件消抖功能 ，它利用电容充放电的延时，消除了波纹，从而简化软件的处理，软件只需要直接检测引脚的电平即可。</p></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209150039798.png" alt="image-20220915003906680" style="zoom:33%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209150040724.png" alt="image-20220915004022616" style="zoom:33%;"><ul><li>本 正点原子开发版探索者F407 没有带硬件防抖</li><li>原理图可以看到： <ul><li>KEY_UP 按键按下之后，高电平</li><li>KEY0～KEY3按键按下之后，低电平</li></ul></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209150046248.png" alt="image-20220915004616027" style="zoom:50%;"><ul><li>查看开发版原理图，一样的套路，根据引脚去找STM32官方文档</li><li>引脚分别是： <ul><li>WK_UP -&gt; GPIOA -&gt; PIN0</li><li>KEY0 -&gt; GPIOE -&gt; PIN4</li><li>KEY1 -&gt; GPIOE -&gt; PIN3</li><li>KEY2 -&gt; GPIOE -&gt; PIN2</li></ul></li></ul><p><strong>示例：</strong></p><p><code>bsp_key.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_KEY_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_KEY_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UP</span> <span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UP_GPIO</span> <span class="token expression">GPIOA</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_LEFT</span> <span class="token expression">GPIO_Pin_2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_LEFT_GPIO</span> <span class="token expression">GPIOE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_RIGHT</span> <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_RIGHT_GPIO</span> <span class="token expression">GPIOE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_DOWN</span> <span class="token expression">GPIO_Pin_3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_DOWN_GPIO</span> <span class="token expression">GPIOE</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_ON</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_OFF</span> <span class="token expression"><span class="token number">0</span></span></span>

<span class="token keyword">void</span> <span class="token function">KEY_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span>GPIOx<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> GPIO_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_KEY_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_key.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_key.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">KEY_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* 第一步：打开GPIO的时钟 */</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA <span class="token operator">|</span> RCC_AHB1Periph_GPIOE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 001 | 010 = 011 //所以可以实现多个GPIO同时初始化</span>
	
	<span class="token comment">/* 第二步：定义一个GPIO初始化结构体 */</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	<span class="token comment">/* 第三步：配置GPIO初始化结构体成员 */</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN<span class="token punctuation">;</span><span class="token comment">//输入模式</span>
	<span class="token comment">//GPIO_InitStruct.GPIO_Speed = GPIO_Speed_2MHz;//只有在输出的情况下有效</span>
	<span class="token comment">//GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;//配置推挽输出或开漏输出，我们要接受输入，所以不需要配置</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span><span class="token comment">//输入状态我们希望是由外部电路决定的，所以GPIO_PuPd_NOPULL：不上拉也不下拉</span>
	
	<span class="token comment">/* 第四步：调用GPIO初始化函数，把配置好的结构体成员参数写入寄存器 */</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">/* ******************************************************** */</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span><span class="token comment">//因为KEY0、KEY1、KEY2按下的是第电平，所以我们需要把引脚上拉</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_4<span class="token punctuation">;</span><span class="token comment">//PE4 KEY0</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	

 	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_3<span class="token punctuation">;</span><span class="token comment">//PE3 KEY1</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_2<span class="token punctuation">;</span><span class="token comment">//P22 KEY2</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>GPIO_TypeDef <span class="token operator">*</span>GPIOx<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> GPIO_Pin<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//读取IO口的电平，可以读取GPIOx_IDR端口输入数据寄存器</span>
	<span class="token comment">//可以通过操作寄存器的方式，也可以通过固件库方式读取</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>GPIO_Pin <span class="token operator">==</span> KEY_UP<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOx<span class="token punctuation">,</span>GPIO_Pin<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">// Delay(0xff);//软件防抖（简陋版，真正的防抖需要通过定时器中断来实现 判断多少毫秒 算按下）</span>
			<span class="token keyword">return</span> <span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOx<span class="token punctuation">,</span>GPIO_Pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> KEY_OFF<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOx<span class="token punctuation">,</span>GPIO_Pin<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> KEY_ON<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> KEY_OFF<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span>					<span class="token comment">//可以在keil5配置引用头文件路径</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;./KEY/bsp_key.h&quot;</span>		<span class="token comment">//也可以指定相对路径</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">KEY_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>KEY_UP_GPIO<span class="token punctuation">,</span> KEY_UP<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>KEY_RIGHT_GPIO<span class="token punctuation">,</span> KEY_RIGHT<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>KEY_DOWN_GPIO<span class="token punctuation">,</span> KEY_DOWN<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="gpio-位带操作" tabindex="-1"><a class="header-anchor" href="#gpio-位带操作" aria-hidden="true">#</a> GPIO - 位带操作</h2><p><strong>位带简介：</strong></p><ul><li>位操作就是可以单独的对一个比特位读和写，这个在 51 单片机中非常常见。51 单片机中通过关键字 sbit 来实现位定义，F407 中没有这样的关键字，而是通过访问位带别名区来实现。</li><li>在 F407 中，有两个地方实现了位带，一个是 SRAM 区的最低 1MB 空间，另一个是外设区最低 1MB 空间。这两个 1MB 的空间除了可以像正常的 RAM 一样操作外，他们还有自己的位带别名 区，位带别名区把这 1MB 的空间的每一个位膨胀成一个 32 位的字（4个字节），当访问位带别名区的这些字 时，就可以达到访问位带区某个比特位的目的。</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209160050508.png" alt="image-20220916005049375" style="zoom:33%;"><ul><li>Bit band region : 位带区</li><li>Bit band alias : 位带别名区</li></ul><p>外设区位带区：<img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209160053352.png" alt="image-20220916005328246" style="zoom:33%;"></p><ul><li>F407只用了192KB的位带区大小，APB1/APB2和AHB1外设属于位带区</li></ul><p>外设区位带别名区：<img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209160054157.png" alt="image-20220916005456047"></p><ul><li>操作位带区对应的位带别名区地址即可实现操作位带区的寄存器。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209160100274.png" alt="image-20220916010009156"></p><ul><li>对应别位带别名区的4个字节的最低位有效，修改最低位相当于修改位带别名区中的某一位</li></ul><p>外设位带区与位带别名区地址转换：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>AliasAddr <span class="token operator">=</span> <span class="token number">0x42000000</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A <span class="token operator">-</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> n <span class="token operator">*</span> <span class="token number">4</span>
<span class="token comment">// 0x42000000  位带别名区起始地址</span>
<span class="token comment">// A表示我们要操作的那个位所在的寄存器地址</span>
<span class="token comment">// - 0x40000000 得到 寄存器A 相对于 位带区 的偏移地址</span>
<span class="token comment">// * 8 将1个位转换成1个字节</span>
<span class="token comment">// * 4 （4个字节对应位带区一个位）转换成相对于位带别名区的偏移地址</span>
<span class="token comment">// * 8 * 4 相当于把位带区的1个位转换成位带别名区的4个字节</span>
<span class="token comment">// n 表示要操作的位号，* 4 就是4个字节，对应着位带别名区的位置</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SRAM位带区与SRAM位带别名区地址转换：</p><ul><li><code>AliasAddr = 0x42000000 + ((A - 0x40000000) * 8 * 4) + n * 4</code><ul><li>和外设位带区的逻辑是一致的</li></ul></li></ul><blockquote><p>理解要点：位带区的一个位在别名区会被膨胀为4个字节</p></blockquote><p><strong>外设与SRAM位带区与位带别名区的地址转换可以用一个公式表示：</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xF0000000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x02000000</span> <span class="token operator">+</span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0x000FFFFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bitnum <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// addr   : 要操作的位所在寄存器的地址 </span>
<span class="token comment">// bitnum : 位号，即在寄存器的第几位</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><ul><li><code>addr &amp; 0xF0000000</code> : 目的是取出4(外设)和2(SRAM)，用于区分是外设还是SRAM，然后在加上 0x02000000 就等于外设/SRAM位带别名区的起始地址，如： <ul><li>外设 : 0x4200 0000 &amp; 0xF000 0000 得到 0x4000 0000 <ul><li>0x4000 0000 + 0x02000000 : 外设位带别名区</li></ul></li><li>SRAM : 0x2200 0000 &amp; 0xF000 0000 得到 0x2000 0000 <ul><li>0x2000 0000 + 0x02000000 : SRAM位带别名区</li></ul></li></ul></li><li><code>addr &amp; 0x000FFFFF</code> : 屏蔽高3位 求偏移地址，外设位带区最高地址为 0x400F 0000 ，SRAM位带区最高地址为 0x200F 0000 ， 在求偏移地址的时候只有低5位有效</li><li><code>&lt;&lt; 5</code> : 相当于 <code>* 8 * 4</code></li><li><code> bitnum &lt;&lt; 2</code> ：相当于 <code>n * 4</code></li></ul></blockquote><blockquote><p><strong>这里我们要强调一下</strong>，我们最终求出的位带别名区地址，这个地址对应的是4个字节，那么我们往这4个字节数据的时候，其实还是最低位有效。</p><p>为什么要这样做？因为我们STM32M4这个内核是32位的，所以他按照32位总线线宽来操作一去就是4个字节，这样子的效率是最高的。</p></blockquote><p>位带操作呢，就这样，简单了解下就行了，没有什么特别大的用处，他这样设计就是为了主要用在 需要对某些进行频繁的读和写的时候，当然现在单片机的这个主频性能这么强，直接操作寄存器的方式也没有什么太大关系。</p><p>这个位带呢，你只需要了解下就行了，没有什么太大意义。</p><p>就了解下，没有什么太大作用的， 在ST最高性能的F7这个系列的单片机已经不支持这个操作了</p><h3 id="使用位带的方式访问gpio的odr寄存器" tabindex="-1"><a class="header-anchor" href="#使用位带的方式访问gpio的odr寄存器" aria-hidden="true">#</a> 使用位带的方式访问GPIO的ODR寄存器</h3><p><strong>示例：</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span>					<span class="token comment">//可以在keil5配置引用头文件路径</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;./KEY/bsp_key.h&quot;</span>		<span class="token comment">//也可以指定相对路径</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//求出位带别名区地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIT_BAND</span><span class="token expression"><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>bitnum<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0xF0000000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x02000000</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>addr <span class="token operator">&amp;</span> <span class="token number">0x000FFFFF</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>bitnum <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//将地址转换成指针</span>
<span class="token comment">//volatile 防止编译器优化</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MEM</span><span class="token expression"><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

#得到对应内存地址变量
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BIT_ADDR</span><span class="token expression"><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>bitnum<span class="token punctuation">)</span> <span class="token function">MEM</span><span class="token punctuation">(</span><span class="token function">BIT_BAND</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>bitnum<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

#得到GPIOF ODR寄存器地址
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIOF_ODR_ADDR</span> <span class="token expression"><span class="token punctuation">(</span>GPIOF_BASE <span class="token operator">+</span> <span class="token number">0x14</span><span class="token punctuation">)</span> </span></span>

#寄存器地址的n位
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PFout</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token function">BIT_ADDR</span><span class="token punctuation">(</span>GPIOF_ODR_ADDR<span class="token punctuation">,</span> n<span class="token punctuation">)</span></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">PFout</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">PFout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">PFout</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">PFout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="启动文件详解" tabindex="-1"><a class="header-anchor" href="#启动文件详解" aria-hidden="true">#</a> 启动文件详解</h2><p>在往后的学习中没有太大的作用，简单了解一下就行了，听不懂没有关系，后面的学习慢慢就懂了</p><h3 id="启动文件的作用" tabindex="-1"><a class="header-anchor" href="#启动文件的作用" aria-hidden="true">#</a> 启动文件的作用</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209190157494.png" alt="QQ20220919-015646@2x" style="zoom:33%;"><ul><li><p>Set the initial SP</p><ul><li>初始化堆栈指针SP</li></ul></li><li><p>Set the initial PC == Reset_Handler</p><ul><li>初始化PC指针，指向复位程序</li></ul></li><li><p>Set the vector table entries with the exceptions ISR address</p><ul><li>初始化中断向量表，但不包括ISR地址</li></ul></li><li><p>Configure the system clock and the external SRAM mounted on STM324xG-EVAL board to be used as data memory (optional, to be enabled by user)</p><ul><li>配置安装在STM324xG评估板上的系统时钟和外部SRAM，用作数据存储器（可选，由用户启用）</li><li>STM324xG-EVAL board ：比如说ST出了个芯片，人家用它的芯片呢，它会出一个全功能的开发版叫 EVAL版，评估这个芯片，它把芯片里的功能基本上全部都会搭上一个外设 来演示这个功能。比如说刚出F407这个芯片的时候，很多功能出了原厂的都是不会使用这个芯片的，所以原厂就就提供这样子的 EVAL board 让大家去学习，顺便买它的芯片。</li><li>外部SRAM : 我们一般不使用，除非需要大内存使用</li></ul></li><li><p>Branches to __main in the C library (which eventually calls main()).</p><ul><li>调用C库函数_main，最终进入C语言世界(最终调用用户写的main函数)</li></ul></li><li><p>After Reset the CortexM4 processor is in Thread mode, priority is Privileged, and the Stack is set to Main.</p><ul><li>重置后，CortexM4处理器处于线程模式，优先级为特权，堆栈设置为Main。</li></ul></li></ul><h3 id="stack-栈" tabindex="-1"><a class="header-anchor" href="#stack-栈" aria-hidden="true">#</a> Stack-栈</h3><p>用于局部变量、函数调用、函数形参的开销</p><p>都是SRAM里面，SRAM启动的时候是一块很大的内存，那么有哪些是用来存放 Stack栈的呢？</p><ul><li>栈只占用SRAM的一部分</li><li>怎么配置它的大小呢？</li></ul><blockquote><p>当程序非常大的时候定一个了局部变量和全局变量，函数调用非常多的时候，栈的大小可能就不够大了，我们可以改大点，这样就不会出现内存溢出的情况。</p></blockquote><h3 id="heap-堆" tabindex="-1"><a class="header-anchor" href="#heap-堆" aria-hidden="true">#</a> Heap-堆</h3><p>堆用于动态内存分配，如malloc函数分配的内存</p><blockquote><p><strong>栈和堆的内存地址增长方向问题</strong></p><p>进程地址空间的分布取决于操作系统，栈向什么方向增长取决于操作系统与CPU的组合。</p><p>不要把别的操作系统的实现方式套用到不同的操作上。</p><p>x86硬件直接支持的栈确实是“向下增长”的：push指令导致sp自减一个slot，pop指令导致sp自增一个slot。其它硬件有其它硬件的情况。</p></blockquote><h3 id="向量表" tabindex="-1"><a class="header-anchor" href="#向量表" aria-hidden="true">#</a> 向量表</h3><ul><li>向量表实际上是一个32位的整形数组，一个元素对应一个异常（ESR，中断服务程序），数组元素存放的是（ESR，中断服务程序）的入口地址。 <ul><li>Cortex-M ，它中断相应跟以前老式的ARM7的中断响应方式是不一样的，比如说我们产生了串口中断 如串口的 TX-2SR 中断，产生中断的时候要找它的中断服务程序，找它的中断服务程序要找它的地址，老式它是中断会对应一个标号的，它长生什么中断的时候标号1～30，有30个中断的话，它要一个个来判断 对比，比如说我们这个TX-ISR的地址是10，它首先要轮询0～30个中断号找到10 然后再找到它的地址，然后再跳到中断服务函数的里面去。</li><li>Cortex-M 不一样，如果它是10的话它直接在中断向量表里面10的位置，取出串口发送中断服务函数的地址，然后直接跳到中断服务函数里面执行。相当于数组根据索引来取元素，不需要一个个来查询。</li><li>当内核响应了一个发生的异常后，对应的异常服务例程 (ESR) 就会执行。为了决定 ESR 的入口 地址，内核使用了“向量表查表机制”。这里使用一张向量表。向量表其实是一个 WORD（32 位 整数）数组，每个下标对应一种异常，该下标元素的值则是该 ESR 的入口地址。向量表在地址空 间中的位置是可以设置的，通过 NVIC 中的一个重定位寄存器来指出向量表的地址。在复位后， 该寄存器的值为 0。因此，在地址 0 （即 FLASH 地址 0）处必须包含一张向量表，用于初始时的 异常分配。要注意的是这里有个另类：0 号类型并不是什么入口地址，而是给出了复位后 MSP 的 初值。</li><li>向量表放的就是中断函数的地址</li></ul></li><li>向量表在复位后从Flash的0地址位置开始，具体的初始化值请查询手册中的中断章节。 <ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209190330628.png" alt="image-20220919033059565" style="zoom:50%;"></li><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209190332421.png" alt="image-20220919033246369" style="zoom:33%;"></li><li>首先第一个，0x00的时候它这个表是保留的，但是我们在启动文件放了栈顶指针。</li><li>后面的跟我们启动文件中断向量表中放的地址是完全对应的，而且一定要对应它。</li><li>因为这会影响到中断响应的优先级问题，如果说你没对应，会导致中断的顺序就反过来了，这个代码由官方为我们提供了。</li></ul></li></ul><blockquote><p><strong>3.启动代码</strong></p><p>分析对象 : startup_stm32f40xx.s</p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>Stack_Size   EQU   0x00000400 ; 就相当于#define，Stack_Size定义为0x400字节

AREA  STACK, NOINIT, READWRITE, ALIGN=3

Stack_Mem    SPACE  Stack_Size ;栈空间的开辟：开辟一个空间大小为Stack_Size的内存空间

__initial_sp ;标号 __initial_sp  其实就是在开辟的空间的顶部做一个标记，记录下这个地址，以后这个地址就代表这个空间的顶部，也就是栈顶
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>AREA 用法 ： AREA 段名 属性1 属性2 属性N <ul><li>AREA伪指令用于定义一个代码段或数据段。其中，段名若以数字开头，则该段名需用“|”括起来，如：|1_test| 。</li><li>属性字段表示该代码段（或数据段）的相关属性，多个属性用逗号分隔。常用的属性如下：<br> - CODE 属性：用于定义代码段，默认为READONLY 。<br> - DATA 属性：用于定义数据段，默认为READWRITE 。<br> - READONLY 属性：指定本段为只读，代码段默认为READONLY 。<br> - READWRITE 属性：指定本段为可读可写，数据段的默认属性为READWRITE 。<br> - ALIGN 属性：使用方式为ALIGN表达式。在默认时，ELF（可执行连接文件）的代码段和数据段是按字对齐的，表达式的取值范围为0～31，相应的对齐方式为2表达式次方。<br> - COMMON 属性：该属性定义一个通用的段，不包含任何的用户代码和数据。各源文件中同名的COMMON段共享同一段存储单元。</li></ul></li></ul><p>​ <code>AREA STACK, NOINIT, READWRITE, ALIGN=3</code> 就是<strong>定义一个数据段，其段名为STACK，可读可写，2^3=8字节对齐</strong>【NOINIT：指定此数据段仅仅保留了内存单元，而没有将各初始值写入内存单元，或者将各个内存单元值初始化为0</p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>Heap_Size    EQU   0x00000200

AREA  HEAP, NOINIT, READWRITE, ALIGN=3

__heap_base

Heap_Mem    SPACE  Heap_Size

__heap_limit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有了前面这一段就非常好理解了，就是申请了<strong>大小为0x400字节的堆空间，其中堆空间的开始是_heap_base 它的顶部是_heap_limit</strong>。</p><p><strong>另外由于这两段的可读写数据，所以实际上他们都是在SRAM上长的。</strong></p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>PRESERVE8 ;8字节对齐
THUMB ;表示后面的指令为 THUMB 指令，THUMB是ARM以前的指令集，16bit，现在 Cortex-M 系列使用的是 `THUMB-2` 指令集，`THUMB-2`是32位的，兼容 16位和32位的指令，是`THUMB`的超集。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p><code>startup_stm32f40xx.s</code> 根据教程视频注释，很浅，可能有错误</p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>;******************** (C) COPYRIGHT 2014 STMicroelectronics ********************
;* File Name          : startup_stm32f40xx.s
;* Author             : MCD Application Team
;* @version           : V1.4.0
;* @date              : 04-August-2014
;* Description        : STM32F40xxx/41xxx devices vector table for MDK-ARM toolchain. 
;*                      Same as startup_stm32f40_41xxx.s and maintained for legacy purpose 
;*                      This module performs:
;*                      - Set the initial SP
;*                      - Set the initial PC == Reset_Handler
;*                      - Set the vector table entries with the exceptions ISR address
;*                      - Configure the system clock and the external SRAM mounted on 
;*                        STM324xG-EVAL board to be used as data memory (optional, 
;*                        to be enabled by user)
;*                      - Branches to __main in the C library (which eventually
;*                        calls main()).
;*                      After Reset the CortexM4 processor is in Thread mode,
;*                      priority is Privileged, and the Stack is set to Main.
;* &lt;&lt;&lt; Use Configuration Wizard in Context Menu &gt;&gt;&gt;   
;*******************************************************************************
; 
; Licensed under MCD-ST Liberty SW License Agreement V2, (the &quot;License&quot;);
; You may not use this file except in compliance with the License.
; You may obtain a copy of the License at:
; 
;        http://www.st.com/software_license_agreement_liberty_v2
; 
; Unless required by applicable law or agreed to in writing, software 
; distributed under the License is distributed on an &quot;AS IS&quot; BASIS, 
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
; 
;*******************************************************************************

; Amount of memory (in bytes) allocated for Stack
; Tailor this value to your application needs
; &lt;h&gt; Stack Configuration
;   &lt;o&gt; Stack Size (in Bytes) &lt;0x0-0xFFFFFFFF:8&gt;
; &lt;/h&gt;

;EQU ：等于的意思,类似于 C 中的Define
;Stack_Size 相当与宏的名字
;0x00000400 = 1KB 
Stack_Size      EQU     0x00000400				

;栈空间是一个数据段；
;AREA : 告诉编译器汇编一个新的代码段或数据段
;STACK : 命名为STACK
;NOINIT : 不初始化
;READWRITE : 可读可写
;ALIGN = 3 :  2^3 = 8 表示栈是按照8个字节对齐来开辟的
AREA    STACK, NOINIT, READWRITE, ALIGN=3

;SPACE : 用于分配一定大小的内存空间，单位为字节
;SPACE   Stack_Size : 分配大小为Stack_Size的空间
Stack_Mem       SPACE   Stack_Size

;标号，不属于关键字，应该是用于标记当前的地址。__initial_sp紧跟着 SPACE 语句放置，表示栈的结束地址，即栈顶地址
__initial_sp


; &lt;h&gt; Heap Configuration
;   &lt;o&gt;  Heap Size (in Bytes) &lt;0x0-0xFFFFFFFF:8&gt;
; &lt;/h&gt;


;EQU ：等于的意思,类似于 C 中的Define
;Heap_Size 相当与宏的名字
Heap_Size       EQU     0x00000200

;堆空间是一个数据段；
;AREA : 告诉编译器汇编一个新的代码段或数据段
;STACK : 命名为STACK
;NOINIT : 不初始化
;READWRITE : 可读可写
;ALIGN = 3 :  2^3 = 8 表示栈是按照8个字节对齐来开辟的
                AREA    HEAP, NOINIT, READWRITE, ALIGN=3

;标号，不属于关键字，应该是用于标记当前的地址。__heap_base 表示堆的开始地址
__heap_base
;SPACE   Heap_Size : 分配大小为Heap_Size的空间
Heap_Mem        SPACE   Heap_Size
;标号，不属于关键字，应该是用于标记当前的地址。__heap_limit紧跟着 SPACE 语句放置，表示堆的结束地址，即堆的顶部地址
__heap_limit
 
;指定当前文件的堆栈按照8字节对齐
                PRESERVE8
;表示后面的指令为 THUMB 指令，THUMB是ARM以前的指令集，16bit，现在 Cortex-M 系列使用的是 `THUMB-2` 指令集，`THUMB-2`是32位的，兼容 16位和32位的指令，是`THUMB`的超集。
                THUMB


;重置时映射到地址0的向量表
;Address 0 表示Flash的起始地址，Flash能够装多少程序，Flash也是内存，也是0~n的地址范围空间
;0 地址开始放的是向量表
; Vector Table Mapped to Address 0 at Reset

;AREA 告诉编译器汇编一个新的代码段或数据段（向量表实际上是一个32位的整形数组，所以是数据段）
;RESET : 数据段名字
;DATA, READONLY : 数据段，可读（只读，中断向量表初始化之后是不能改变的，所以只能是ReadOnly）
                AREA    RESET, DATA, READONLY
					
                EXPORT  __Vectors ;__Vectors 表示向量表的起始地址
                EXPORT  __Vectors_End ;__Vectors_End 表示向量表的结束地址
                EXPORT  __Vectors_Size ;__Vectors_Size ,后面定义了EQU __Vectors_End - __Vectors 算出中断向量表的大小

;DCD 就是初始化一段内存
;为什么我们说中断向量表是一个32位的整形数组呢？就是由这个DCD来决定的

; DCD     __initial_sp               ; Top of Stack 指向栈顶
__Vectors       DCD     __initial_sp               ; Top of Stack

;-----------------------------------------------这里的一部分是内核使用的，内核异常的中断服务函数
                DCD     Reset_Handler              ; Reset Handler
                DCD     NMI_Handler                ; NMI Handler
                DCD     HardFault_Handler          ; Hard Fault Handler
                DCD     MemManage_Handler          ; MPU Fault Handler
                DCD     BusFault_Handler           ; Bus Fault Handler
                DCD     UsageFault_Handler         ; Usage Fault Handler
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     0                          ; Reserved
                DCD     SVC_Handler                ; SVCall Handler
                DCD     DebugMon_Handler           ; Debug Monitor Handler
                DCD     0                          ; Reserved
                DCD     PendSV_Handler             ; PendSV Handler
                DCD     SysTick_Handler            ; SysTick Handler
;-----------------------------------------------
;下面是外部中断
                ; External Interrupts
                DCD     WWDG_IRQHandler                   ; Window WatchDog                                        
                DCD     PVD_IRQHandler                    ; PVD through EXTI Line detection                        
                DCD     TAMP_STAMP_IRQHandler             ; Tamper and TimeStamps through the EXTI line            
                DCD     RTC_WKUP_IRQHandler               ; RTC Wakeup through the EXTI line                       
                DCD     FLASH_IRQHandler                  ; FLASH                                           
                DCD     RCC_IRQHandler                    ; RCC                                             
                DCD     EXTI0_IRQHandler                  ; EXTI Line0                                             
                DCD     EXTI1_IRQHandler                  ; EXTI Line1                                             
                DCD     EXTI2_IRQHandler                  ; EXTI Line2                                             
                DCD     EXTI3_IRQHandler                  ; EXTI Line3                                             
                DCD     EXTI4_IRQHandler                  ; EXTI Line4                                             
                DCD     DMA1_Stream0_IRQHandler           ; DMA1 Stream 0                                   
                DCD     DMA1_Stream1_IRQHandler           ; DMA1 Stream 1                                   
                DCD     DMA1_Stream2_IRQHandler           ; DMA1 Stream 2                                   
                DCD     DMA1_Stream3_IRQHandler           ; DMA1 Stream 3                                   
                DCD     DMA1_Stream4_IRQHandler           ; DMA1 Stream 4                                   
                DCD     DMA1_Stream5_IRQHandler           ; DMA1 Stream 5                                   
                DCD     DMA1_Stream6_IRQHandler           ; DMA1 Stream 6                                   
                DCD     ADC_IRQHandler                    ; ADC1, ADC2 and ADC3s                            
                DCD     CAN1_TX_IRQHandler                ; CAN1 TX                                                
                DCD     CAN1_RX0_IRQHandler               ; CAN1 RX0                                               
                DCD     CAN1_RX1_IRQHandler               ; CAN1 RX1                                               
                DCD     CAN1_SCE_IRQHandler               ; CAN1 SCE                                               
                DCD     EXTI9_5_IRQHandler                ; External Line[9:5]s                                    
                DCD     TIM1_BRK_TIM9_IRQHandler          ; TIM1 Break and TIM9                   
                DCD     TIM1_UP_TIM10_IRQHandler          ; TIM1 Update and TIM10                 
                DCD     TIM1_TRG_COM_TIM11_IRQHandler     ; TIM1 Trigger and Commutation and TIM11
                DCD     TIM1_CC_IRQHandler                ; TIM1 Capture Compare                                   
                DCD     TIM2_IRQHandler                   ; TIM2                                            
                DCD     TIM3_IRQHandler                   ; TIM3                                            
                DCD     TIM4_IRQHandler                   ; TIM4                                            
                DCD     I2C1_EV_IRQHandler                ; I2C1 Event                                             
                DCD     I2C1_ER_IRQHandler                ; I2C1 Error                                             
                DCD     I2C2_EV_IRQHandler                ; I2C2 Event                                             
                DCD     I2C2_ER_IRQHandler                ; I2C2 Error                                               
                DCD     SPI1_IRQHandler                   ; SPI1                                            
                DCD     SPI2_IRQHandler                   ; SPI2                                            
                DCD     USART1_IRQHandler                 ; USART1                                          
                DCD     USART2_IRQHandler                 ; USART2                                          
                DCD     USART3_IRQHandler                 ; USART3                                          
                DCD     EXTI15_10_IRQHandler              ; External Line[15:10]s                                  
                DCD     RTC_Alarm_IRQHandler              ; RTC Alarm (A and B) through EXTI Line                  
                DCD     OTG_FS_WKUP_IRQHandler            ; USB OTG FS Wakeup through EXTI line                        
                DCD     TIM8_BRK_TIM12_IRQHandler         ; TIM8 Break and TIM12                  
                DCD     TIM8_UP_TIM13_IRQHandler          ; TIM8 Update and TIM13                 
                DCD     TIM8_TRG_COM_TIM14_IRQHandler     ; TIM8 Trigger and Commutation and TIM14
                DCD     TIM8_CC_IRQHandler                ; TIM8 Capture Compare                                   
                DCD     DMA1_Stream7_IRQHandler           ; DMA1 Stream7                                           
                DCD     FSMC_IRQHandler                   ; FSMC                                            
                DCD     SDIO_IRQHandler                   ; SDIO                                            
                DCD     TIM5_IRQHandler                   ; TIM5                                            
                DCD     SPI3_IRQHandler                   ; SPI3                                            
                DCD     UART4_IRQHandler                  ; UART4                                           
                DCD     UART5_IRQHandler                  ; UART5                                           
                DCD     TIM6_DAC_IRQHandler               ; TIM6 and DAC1&amp;2 underrun errors                   
                DCD     TIM7_IRQHandler                   ; TIM7                   
                DCD     DMA2_Stream0_IRQHandler           ; DMA2 Stream 0                                   
                DCD     DMA2_Stream1_IRQHandler           ; DMA2 Stream 1                                   
                DCD     DMA2_Stream2_IRQHandler           ; DMA2 Stream 2                                   
                DCD     DMA2_Stream3_IRQHandler           ; DMA2 Stream 3                                   
                DCD     DMA2_Stream4_IRQHandler           ; DMA2 Stream 4                                   
                DCD     ETH_IRQHandler                    ; Ethernet                                        
                DCD     ETH_WKUP_IRQHandler               ; Ethernet Wakeup through EXTI line                      
                DCD     CAN2_TX_IRQHandler                ; CAN2 TX                                                
                DCD     CAN2_RX0_IRQHandler               ; CAN2 RX0                                               
                DCD     CAN2_RX1_IRQHandler               ; CAN2 RX1                                               
                DCD     CAN2_SCE_IRQHandler               ; CAN2 SCE                                               
                DCD     OTG_FS_IRQHandler                 ; USB OTG FS                                      
                DCD     DMA2_Stream5_IRQHandler           ; DMA2 Stream 5                                   
                DCD     DMA2_Stream6_IRQHandler           ; DMA2 Stream 6                                   
                DCD     DMA2_Stream7_IRQHandler           ; DMA2 Stream 7                                   
                DCD     USART6_IRQHandler                 ; USART6                                           
                DCD     I2C3_EV_IRQHandler                ; I2C3 event                                             
                DCD     I2C3_ER_IRQHandler                ; I2C3 error                                             
                DCD     OTG_HS_EP1_OUT_IRQHandler         ; USB OTG HS End Point 1 Out                      
                DCD     OTG_HS_EP1_IN_IRQHandler          ; USB OTG HS End Point 1 In                       
                DCD     OTG_HS_WKUP_IRQHandler            ; USB OTG HS Wakeup through EXTI                         
                DCD     OTG_HS_IRQHandler                 ; USB OTG HS                                      
                DCD     DCMI_IRQHandler                   ; DCMI                                            
                DCD     CRYP_IRQHandler                   ; CRYP crypto                                     
                DCD     HASH_RNG_IRQHandler               ; Hash and Rng
                DCD     FPU_IRQHandler                    ; FPU
;最后跟着一个标号，表示向量表的结束位置                                         
__Vectors_End
;求出向量表的大小
__Vectors_Size  EQU  __Vectors_End - __Vectors

;告诉编译器，我要写代码了，名字是.text,代码是只读的READONLY
                AREA    |.text|, CODE, READONLY

;复位函数，这个是我们上电复位/或手动复位，第一个需要执行的程序，所以我们的程序烧到开发板之后首先执行这个程序
; Reset handler
;Reset_Handler 子程序的名字
;PROC 表示子程序的开始，
;EXPORT  Reset_Handler  把函数导出
;\[WEAK\]  表示弱定义，如果外部文件优先定义了该标号则首先引用该标号，如果外部文件没有声明也不会出错。
Reset_Handler    PROC
                 EXPORT  Reset_Handler             [WEAK]

;IMPORT 表示该标号来自外部文件，跟 C 语言中的 extern关键字类似,在启动文件中用于表示 SystemInit 和 _main 这两个函数均来自外部的文件
;SystemInit :Setup the microcontroller system Initialize the Embedded Flash Interface, the PLL and update the  SystemFrequency variable.
;设置微控制器系统初始化嵌入式闪存接口、PLL并更新系统频率变量。
;当执行来到用户写的main函数的时候，系统时钟已经由SystemInit这个函数初始化好了，所以在我们使用固件库编程的时候自己就不需要配置系统时钟了
;跟固件库的版本有关，如果使用时钟的是3.0版本以下的，它的启动文件里面没有调用SystemInit函数。需要我们在main里面自己写，后面到了3.5以上的版本，就变成了这样子
        IMPORT  SystemInit
;_main属于C库函数，在最后会调用用户自己写的main函数
;一 : 初始化程序里面的变量，局部变量、全局变量，是由C库中的_main来完成的
;二 : 调用用户写的main函数
;具体会在MDK编译过程及文件类型全解中详解
        IMPORT  __main
;LDR 从存储器中加载字到一个寄存器中
; 完整意思 ：把SystemInit函数的指针加载到R0寄存器
                 LDR     R0, =SystemInit
;BLX 跳转到由寄存器给出的地址，并根据寄存器的LSE确定处理器的状态，还要把跳转前的下条指令地址保存到LR
; 完整意思 ：执行R0寄存器中的函数，保存当前指令的下条指令，返回继续执行指令
                 BLX     R0
;LDR 从存储器中加载字到一个寄存器中
; 完整意思 ：把__main函数的指针加载到R0寄存器
                 LDR     R0, =__main
;BX 跳转到由寄存器/标号给出的地址，不用返回
; 完整意思 ：执行R0寄存器中的函数 
                 BX      R0
;ENDP 表示子程序完毕，
                 ENDP

;虚拟异常处理程序（可以修改的无限循环）
; Dummy Exception Handlers (infinite loops which can be modified)

;上面已经初始化中断向量表了，向量表是由由中断函数的函数名的地址来初始化的，这些函数名 在汇编文件里面已经全部写好了，也就是说这些中断服务函数已经全部写好了




; NMI_Handler 子程序名
;PROC 表示子程序的开始，
;\[WEAK\]  表示弱定义，如果外部文件优先定义了该标号则首先引用该标号，如果外部文件没有声明也不会出错。
;你可以在其他地方比如C语言里面重新写一个，之后真正起做哦那个的是C语言里面那个，而不是这个文件里面的，因为这个属于定义
;B       . 表示跳到这里无限循环

;下面的终端服务函数全部都是弱定义，就是说当我们真正需要使用某个终端服务函数的时候，我们会在 USER目录下的 stm32_f4xx_it.c 里面写，
;下面的函数已经在stm32_f4xx_it.c中定义了，要使用的时候写在函数体里面就行了，
;但是有个问题，如果你在C文件里面写的中断服务函数名，跟我们这个中断向量表里面的名字不对应的话，它就相应不了，找不到了，
;它就会回到汇编里面写好的这些 B       . 无限循环，即程序就死在这里。,出现这样的情况下呢，就出现HardFault_Handler硬件错误，
;如果某天发现中断不正常，出现了HardFault_Handler的时候，或者一直跳到汇编里面默认已经写好的代码的话，就要检查中断服务函数名有没有写错，是不是和向量表里面的名字是否一样
NMI_Handler     PROC
                EXPORT  NMI_Handler                [WEAK]
                B       .
                ENDP
HardFault_Handler\
                PROC
                EXPORT  HardFault_Handler          [WEAK]
                B       .
                ENDP

;............................

;*******************************************************************************
; User Stack and Heap initialization
;*******************************************************************************
;我们前面只是开辟了堆和栈的大小，没有初始化它们
;IF ELSE 跟C语言里面是一样的，
;如果Define了__MICROLIB的话，就把__initial_sp、__heap_base、__heap_limit 生命为全局，供其他文件使用
                 IF      :DEF:__MICROLIB
                
                 EXPORT  __initial_sp
                 EXPORT  __heap_base
                 EXPORT  __heap_limit
                
                 ELSE
;否则就由 __use_two_region_memory、__user_initial_stackheap 这部分代码来初始化堆和栈，
                 IMPORT  __use_two_region_memory
                 EXPORT  __user_initial_stackheap
                 
__user_initial_stackheap

                 LDR     R0, =  Heap_Mem
                 LDR     R1, =(Stack_Mem + Stack_Size)
                 LDR     R2, = (Heap_Mem +  Heap_Size)
                 LDR     R3, = Stack_Mem
                 BX      LR

                 ALIGN

                 ENDIF

                 END

;************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE*****

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关于中断向量表存放位置问题" tabindex="-1"><a class="header-anchor" href="#关于中断向量表存放位置问题" aria-hidden="true">#</a> 关于中断向量表存放位置问题</h3><ul><li><p>单片机默认引导是从 8000000 地址开始运行的。 相当于我们的程序就是从main 开始运行的一样。 约定好了。 上电就是从 8000000 处开始运行的。</p></li><li><p><strong>flash硬件映射首地址就是0x8000000</strong>，如果到0x00000000是不会运行的。</p></li><li><p>M3，M4内核芯片上电复位后，要固定从0x0000 0000地址读取中断向量表，获取复位中断服务程序的入口地址后，进入复位中断服务程序，其中0x0000 0000是栈顶地址，0x0000 0004存的是复位中断服务程序地址。</p></li><li><p>ARM规定了M3，M4内核要从地址0x0000 0000读取中断向量表，而STM32设置Flash地址到0x0800 0000怎么办？</p></li><li><p>STM32支持了个内存重映射功能，将地址0x0800 0000开始的内容重映射到首地址0x0000 0000中，这样就解决了从0x0000 0000读取中断向量表的问题。</p></li><li><p>保证中断向量表存到0x0800 0000，这个涉及到分散加载的一个小知识，以MDK为例，如果大家看xxx.S启动文件，里面通过AREA定义了一个名叫<strong>RESET的段</strong>，这段存的就是中断向量表。</p><ul><li><strong>RESET这个名字很重要</strong>，MDK对应的xxx.sct分散加载里面通过下面这句将这个RESET段放在了0x0800 0000优先存储。</li></ul></li></ul><h3 id="启动文件中的汇编指令总结" tabindex="-1"><a class="header-anchor" href="#启动文件中的汇编指令总结" aria-hidden="true">#</a> 启动文件中的汇编指令总结</h3><ul><li><code>EQU</code> : 宏定义的伪指令，相当于等于，类似于 C 中的define</li><li><code>AREA</code> : 告诉编译器汇编一个新的代码段或数据段 <ul><li><pre><code>AREA伪指令用于定义一个代码段或数据段。其中，段名若以数字开头，则该段名需用“|”括起来，如：|1_test| 。   属性字段表示该代码段（或数据段）的相关属性，多个属性用逗号分隔。常用的属性如下：   
</code></pre></li><li>CODE 属性：用于定义代码段，默认为READONLY 。</li><li>DATA 属性：用于定义数据段，默认为READWRITE 。</li><li>READONLY 属性：指定本段为只读，代码段默认为READONLY 。</li><li>READWRITE 属性：指定本段为可读可写，数据段的默认属性为READWRITE 。</li><li>ALIGN 属性：使用方式为ALIGN表达式。在默认时，ELF（可执行连接文件）的代码段和数据段是按字对齐的，表达式的取值范围为0～31，相应的对齐方式为2表达式次方。</li></ul></li><li><code>SPACE</code> : 用于分配一定大小的内存空间，单位为字节</li><li><code>PRESERVE8</code> ： 指定当前文件的堆栈按照8字节对齐</li><li><code>THUMB</code> : 表示后面的指令为 THUMB 指令，THUMB是ARM以前的指令集，16bit，现在 Cortex-M 系列使用的是 <code>THUMB-2</code> 指令集，<code>THUMB-2</code>是32位的，兼容 16位和32位的指令，是<code>THUMB</code>的超集。</li><li><code>EXPORT</code> : 声明一个标号具有全局属性，可被外部的文件使用，如果是IAR编译器，则使用 GLOBAL 指令 <ul><li>可以被C语言的文件使用，或者本文件的其他地方</li></ul></li><li><code>DCD</code> : 分配一个或多个以字为单位的内存，以4字节对齐，并要求初始化这些内存。 <ul><li>在中断向量表中，DCD分配了一堆内存，并且以ESR（中断服务程序（函数））的入口地址初始化它们。</li></ul></li><li><code>WEAK</code> : 表示弱定义，如果外部文件优先定义了该标号则首先引用该标号，如果外部文件没有声明也不会出错。 <ul><li>在启动文件中用于表示复位子程序可以由用户在其他文件重新实现，这里并不是唯一的。</li></ul></li><li><code>IMPORT</code> : 表示该标号来自外部文件，跟 C 语言中的 extern关键字类似。 <ul><li>在启动文件中用于表示 SystemInit 和 _main 这两个函数均来自外部的文件</li></ul></li><li><code>IF,ELSE,ENDIF</code> : 汇编的条件分支语句，跟C语言的 if，else类似</li><li><code>END</code> : 文件结束</li><li><code>ALIGN</code> : 对数据或数据存放的进行对齐，后面会跟一个立即数，缺省表示4字节对齐</li></ul><blockquote><p>更多指令可以在MDK中的帮助手册——ARM Development Tools ：用来查询 ARM 的汇编指令和编译器相关的指令。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209190452690.png" alt="image-20220919045234635" style="zoom:50%;"></blockquote><h3 id="cortex内核指令" tabindex="-1"><a class="header-anchor" href="#cortex内核指令" aria-hidden="true">#</a> Cortex内核指令</h3><p>LDR、BLX、BX 是Cortext-M4内核的指令，可在《CM3权威指南 CnR2》第四章-指令集里面查询到，具体作用如下表：</p><table><thead><tr><th>指令名称</th><th>作用</th></tr></thead><tbody><tr><td>LDR</td><td>从存储器中加载字到一个寄存器中</td></tr><tr><td>BL</td><td>跳转到由寄存器/标号给出的地址。并把跳转前的下跳指令保存到LR（连接寄存器 ）</td></tr><tr><td>BLX</td><td>跳转到由寄存器给出的地址，并根据寄存器的LSE确定处理器的状态，还要把跳转前的下条指令地址保存到LR</td></tr><tr><td>BX</td><td>跳转到由寄存器/标号给出的地址，不用返回</td></tr></tbody></table><blockquote><p>LDR作为伪指令</p><ul><li>LDR : 加载一个立即数或者一个地址值到一个寄存器</li></ul><p>举例：</p><ul><li><p>LDR Rd,label</p></li><li><p>如果label是立即数，那Rd等于立即数</p></li><li><p>如果label是一个标识符，比如指针，那存到Rd的就是label这个标识符的地址</p></li></ul></blockquote><h2 id="rcc-时钟树" tabindex="-1"><a class="header-anchor" href="#rcc-时钟树" aria-hidden="true">#</a> RCC 时钟树</h2><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/QQ20220919-215408@2x.png" alt="QQ20220919-215408@2x"></p><h3 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h3><p>RCC（Reset Clock Control，复位和时钟控制器）时钟控制器为应用带来了高度的灵活性，用户在运行内核和外设时可选择使用外部晶振或者 使用振荡器，既可采用最高的频率，也可为以太网、USB OTG FS 以及 HS、I2S 和 SDIO 等需要特定时钟的外设保证合适的频率。</p><h3 id="分频和倍频" tabindex="-1"><a class="header-anchor" href="#分频和倍频" aria-hidden="true">#</a> 分频和倍频</h3><p>有了倍频和分频器,就不用每个频率用一个振荡器,它可以对原来的基频的多次计数就可以产生新的频率</p><ul><li>分频因子 <ul><li>分频因子是对于一个时钟源而言的，通俗点说就是把它分为多少份取其中的一份，就比如说是10Khz的时钟2分频，分频以后变为了10/2=5KHZ</li><li>单片机都是有时钟振荡器的。还有定时器，看门狗，程序计数器等等。如果看门狗或者定时器所要求的脉冲速度比较时钟脉冲慢，那么，就要利用分频器进行分频，以得到你所要求的脉冲速率。</li></ul></li><li>倍频因子 <ul><li>倍频因子就是指倍频，该词全称是倍频系数，主频 = 外频 x 倍频。</li><li>原先并没有倍频概念，CPU的主频和系统总线的速度是一样的，但CPU的速度越来越快，倍频技术也就应允而生。它可使<strong>系统总线工作在相对较低的频率上</strong>，而CPU速度可以通过倍频来无限提升。那么CPU主频的计算方式变为：主频 = 外频 x 倍频。也就是倍频是指CPU和系统总线之间相差的倍数，当外频不变时，提高倍频，CPU主频也就越高。</li></ul></li></ul><h3 id="系统时钟" tabindex="-1"><a class="header-anchor" href="#系统时钟" aria-hidden="true">#</a> 系统时钟</h3><h4 id="hse-高速外部时钟信号" tabindex="-1"><a class="header-anchor" href="#hse-高速外部时钟信号" aria-hidden="true">#</a> HSE 高速外部时钟信号</h4><p>HSE 是高速的外部时钟信号，可以由有源晶振或者无源晶振提供，频率从 4-26MHZ 不等。当 使用有源晶振时，时钟从 OSC_IN 引脚进入，OSC_OUT 引脚悬空，当选用无源晶振时，时钟从 OSC_IN 和 OSC_OUT 进入，并且要配谐振电容。HSE 我们使用 25M 的无源晶振。如果我们使用 HSE 或者 HSE 经过 PLL 倍频之后的时钟作为系统时钟 SYSCLK，当 HSE 故障时候，不仅 HSE 会 被关闭，PLL 也会被关闭，此时高速的内部时钟时钟信号 HSI 会作为备用的系统时钟，直到 HSE 恢复正常，HSI=16M。</p><h4 id="锁相环-pll" tabindex="-1"><a class="header-anchor" href="#锁相环-pll" aria-hidden="true">#</a> 锁相环 PLL</h4><p>PLL 的主要作用是对时钟进行倍频，然后把时钟输出到各个功能部件。PLL 有两个，一个是主 PLL，另外一个是专用的 PLLI2S，他们均由 HSE 或者 HSI 提供时钟输入信号。 主 PLL 有两路的时钟输出，第一个输出时钟 PLLCLK 用于系统时钟，F407 里面最高是 168M，第 二个输出用于 USB OTG FS 的时钟（48M）、RNG 和 SDIO 时钟（&lt;=48M）。专用的 PLLI2S 用于 生成精确时钟，给 I2S 提供时钟。</p><p>HSE 或者 HSI 经过 PLL 时钟输入分频因子 M（2~63）分频后，成为 VCO 的时钟输入，VCO 的时 钟必须在 1~2M 之间，我们选择 HSE=25M 作为 PLL 的时钟输入，M 设置为 25，那么 VCO 输入 时钟就等于 1M。</p><p>VCO 输入时钟经过 VCO 倍频因子 N 倍频之后，成为 VCO 时钟输出，VCO 时钟必须在 192~432M 之间。我们配置 N 为 336，则 VCO 的输出时钟等于 336M。如果要把系统时钟超频，就得在 VCO 倍 频系数 N 这里做手脚。PLLCLK_OUTMAX = VCOCLK_OUTMAX/P_MIN =432/2=216M，即 F407 最高可超频到 216M。</p><p>VCO 输出时钟之后有三个分频因子：PLLCLK 分频因子 p，USB OTG FS/RNG/SDIO 时钟分频因 子 Q，分频因子 R（F446 才有，F407 没有）。p 可以取值 2、4、6、8, 我们配置为 2，则得到 PLLCLK=168M。Q 可以取值 4~15，但是 USB OTGFS 必须使用 48M，Q=VCO 输出时钟 336/48=7。 有关 PLL 的配置有一个专门的 RCC PLL 配置寄存器 RCC_PLLCFGR，具体描述看手册即可。</p><p>PLL 的时钟配置经过，稍微整理下可由如下公式表达：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>VCOCLK_IN <span class="token operator">=</span> PLLCLK_IN / M <span class="token operator">=</span> HSE / <span class="token number">25</span> <span class="token operator">=</span> 1M
VCOCLK_OUT <span class="token operator">=</span> VCOCLK_IN * N <span class="token operator">=</span> 1M * <span class="token number">336</span> <span class="token operator">=</span> 336M
<span class="token assign-left variable">PLLCLK_OUT</span><span class="token operator">=</span>VCOCLK_OUT/P<span class="token operator">=</span><span class="token number">336</span>/2<span class="token operator">=</span>168M
USBCLK <span class="token operator">=</span> VCOCLK_OUT/Q<span class="token operator">=</span><span class="token number">336</span>/7<span class="token operator">=</span><span class="token number">48</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="系统时钟-sysclk" tabindex="-1"><a class="header-anchor" href="#系统时钟-sysclk" aria-hidden="true">#</a> 系统时钟 SYSCLK</h4><p>系统时钟来源可以是：HSI、PLLCLK、HSE，具体的由时钟配置寄存器 RCC_CFGR 的 SW 位配 置。我们这里设置系统时钟：SYSCLK = PLLCLK =168M。如果系统时钟是由 HSE 经过 PLL 倍频 之后的 PLLCLK 得到，当 HSE 出现故障的时候，系统时钟会切换为 HSI=16M，直到 HSE 恢复正 常为止。</p><h4 id="ahb-总线时钟-hclk" tabindex="-1"><a class="header-anchor" href="#ahb-总线时钟-hclk" aria-hidden="true">#</a> AHB 总线时钟 HCLK</h4><p>系统时钟 SYSCLK 经过 AHB 预分频器分频之后得到时钟叫 AHB 总线时钟，即 HCLK，分频因子 可以是:[1,2,4，8，16，64，128，256，512]，具体的由时钟配置寄存器 RCC_CFGR 的 HPRE 位设 置。片上大部分外设的时钟都是经过 HCLK 分频得到，至于 AHB 总线上的外设的时钟设置为多 少，得等到我们使用该外设的时候才设置，我们这里只需粗线条的设置好 APB 的时钟即可。我 们这里设置为 1 分频，即 HCLK=SYSCLK=168M。</p><h4 id="apb2-总线时钟-pclk2" tabindex="-1"><a class="header-anchor" href="#apb2-总线时钟-pclk2" aria-hidden="true">#</a> APB2 总线时钟 PCLK2</h4><p>APB2 总线时钟 PCLK2 由 HCLK 经过高速 APB2 预分频器得到，分频因子可以是:[1,2,4，8，16]， 具体由时钟配置寄存器 RCC_CFGR 的 PPRE2 位设置。PCLK2 属于高速的总线时钟，片上高速的 外设就挂载到这条总线上，比如全部的 GPIO、USART1、SPI1 等。至于 APB2 总线上的外设的时 钟设置为多少，得等到我们使用该外设的时候才设置，我们这里只需粗线条的设置好 APB2 的时 钟即可。我们这里设置为 2 分频，即 PCLK2 = HCLK /2= 84M。</p><h4 id="apb1-总线时钟-pclk1" tabindex="-1"><a class="header-anchor" href="#apb1-总线时钟-pclk1" aria-hidden="true">#</a> APB1 总线时钟 PCLK1</h4><p>APB1 总线时钟 PCLK1 由 HCLK 经过低速 APB 预分频器得到，分频因子可以是:[1,2,4，8，16]， 具体由时钟配置寄存器 RCC_CFGR 的 PPRE1 位设置。PCLK1 属于低速的总线时钟，最高为 42M， 片上低速的外设就挂载到这条总线上，比如 USART2/3/4/5、SPI2/3，I2C1/2 等。至于 APB1 总线 上的外设的时钟设置为多少，得等到我们使用该外设的时候才设置，我们这里只需粗线条的设置 好 APB1 的时钟即可。我们这里设置为 4 分频，即 PCLK1= HCLK/4 = 42M。</p><h3 id="其他时钟" tabindex="-1"><a class="header-anchor" href="#其他时钟" aria-hidden="true">#</a> 其他时钟</h3><p>通过对系统时钟设置的讲解，整个时钟树我们已经把握的有六七成，剩下的时钟部分我们讲解几 个重要的。</p><h4 id="rtc-时钟" tabindex="-1"><a class="header-anchor" href="#rtc-时钟" aria-hidden="true">#</a> RTC 时钟</h4><p>RTCCLK 时钟源可以是 HSE 1 MHz（HSE 由一个可编程的预分频器分频）、LSE 或者 LSI 时钟。 选择方式是编程 RCC 备份域控制寄存器 (RCC_BDCR) 中的 RTCSEL[1:0] 位和 RCC 时钟配置寄 存器 (RCC_CFGR) 中的 RTCPRE[4:0] 位。所做的选择只能通过复位备份域的方式修改。我们通 常的做法是由 LSE 给 RTC 提供时钟，大小为 32.768KHZ。LSE 由外接的晶体谐振器产生，所配 的谐振电容精度要求高，不然很容易不起震。</p><h4 id="stm32的lsi内部rc晶震不稳定" tabindex="-1"><a class="header-anchor" href="#stm32的lsi内部rc晶震不稳定" aria-hidden="true">#</a> <strong>STM32的LSI内部RC晶震不稳定</strong></h4><h4 id="独立看门狗时钟" tabindex="-1"><a class="header-anchor" href="#独立看门狗时钟" aria-hidden="true">#</a> 独立看门狗时钟</h4><p>独立看门狗时钟由内部的低速时钟 LSI 提供，大小为 32KHZ。I2S 时钟可由外部的时钟引脚 I2S_CKIN 输入，也可由专用的 PLLI2SCLK 提供，具体的由 RCC 时钟配置寄存器 (RCC_CFGR) 的 I2SSCR 位配置。我们在使用 I2S 外设驱动 W8978 的时候，使用 的时钟是 PLLI2SCLK，这样就可以省掉一个有源晶振。</p><h4 id="phy-以太网时钟" tabindex="-1"><a class="header-anchor" href="#phy-以太网时钟" aria-hidden="true">#</a> PHY 以太网时钟</h4><p>F407 要想实现以太网功能，除了有本身内置的 MAC 之外，还需要外接一个 PHY 芯片，常见的 PHY 芯片有 DP83848 和 LAN8720，其中 DP83848 支持 MII 和 RMII 接口，LAN8720 只支持 RMII 接口。野火 F407 开发板用的是 RMII 接口，选择的 PHY 芯片是 LAB8720。使用 RMII 接口的好 处是使用的 IO 减少了一半，速度还是跟 MII 接口一样。当使用 RMII 接口时，PHY 芯片只需输 出一路时钟给 MCU 即可，如果是 MII 接口，PHY 芯片则需要提供两路时钟给 MCU。</p><h4 id="usb-phy-时钟" tabindex="-1"><a class="header-anchor" href="#usb-phy-时钟" aria-hidden="true">#</a> USB PHY 时钟</h4><p>F407 的 USB 没有集成 PHY，要想实现 USB 高速传输的话，必须外置 USB PHY 芯片，常用的芯 片是 USB3300。当外接 USB PHY 芯片时，PHY 芯片需要给 MCU 提供一个时钟。 外扩 USB3300 会占用非常多的 IO，跟 SDRAM 和 RGB888 的 IO 会复用的很厉害，鉴于 USB 高 速传输用的比较少，野火 F407 霸天虎就没有外扩这个芯片。</p><h4 id="mco-时钟输出" tabindex="-1"><a class="header-anchor" href="#mco-时钟输出" aria-hidden="true">#</a> MCO 时钟输出</h4><p>MCO 是 microcontroller clock output 的缩写，是微控制器时钟输出引脚，主要作用是可以对外提 供时钟，相当于一个有源晶振。F407 中有两个 MCO，由 PA8/PC9 复用所得。MCO1 所需的时钟 源通过 RCC 时钟配置寄存器 (RCC_CFGR) 中的 MCO1PRE[2:0] 和 MCO1[1:0] 位选择。MCO2 所 需的时钟源通过 RCC 时钟配置寄存器 (RCC_CFGR) 中的 MCO2PRE[2:0] 和 MCO2 位选择。有关 MCO 的 IO、时钟选择和输出速率的具体信息如下表所示：</p><table><thead><tr><th>时钟输出</th><th>IO</th><th>时钟来源</th><th>最大输出速率</th></tr></thead><tbody><tr><td>MCO1</td><td>PA8</td><td>HSI、LSE、HSE、PLLCLK</td><td>100M</td></tr><tr><td>MCO2</td><td>PC9</td><td>HSE、PLLCLK、SYSCLK、PLLI2SCLK</td><td>100M</td></tr></tbody></table><h3 id="为什么不直接外置高速时钟" tabindex="-1"><a class="header-anchor" href="#为什么不直接外置高速时钟" aria-hidden="true">#</a> 为什么不直接外置高速时钟？</h3><p>从上面可以了解到，168MHZ的频率是经过分频再倍频得来的，为什么要这样呢？为什么不能直接外置168MHz时钟呢？</p><p>我们要考虑到当时钟越高的时候，外部器件制作的工艺要求就越高 越难制作，可以看到开发版的晶振是暴露在外面的，如果它的频率越高，越容易受到外界的干扰导致出错，时钟相当于CPU的心脏，非常重要。</p><h3 id="配置系统时钟实验" tabindex="-1"><a class="header-anchor" href="#配置系统时钟实验" aria-hidden="true">#</a> 配置系统时钟实验</h3><p>在启动文件中的SystemInit函数中，调用了一个SetSysClock的函数，我们以这个函数 的编写流程来讲解时钟树，这个函数也是我们用库的时候默认的系统时钟设置函数。该函数的 功能是利用 HSE 把时钟设置为：HCLK = SYSCLK=PLLCLK = 168M，PCLK1=HCLK/2 = 84M， PCLK1=HCLK/4 = 42M 下面我们就以这个代码的流程为主线，来分析时钟树，对应的是图中的黄 色部分，代码流程在时钟树中以数字的大小顺序标识。</p><p><code>bsp_clkconfig.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_CLKCONFIG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_CLKCONFIG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span>		<span class="token comment">//导入寄存器映射</span></span>

<span class="token keyword">void</span> <span class="token function">User_SetSysClock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_CLKCONFIG_H*/</span></span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_clkconfig.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clock_config.h&quot;</span></span>

<span class="token comment">/*
使用 HSE 时，设置系统时钟的步骤
1、开启 HSE , 并等待 HSE 稳定
2、开启 AHB、APB2、APB1 的预分频因子
3、设置 PLL 的时钟来源
		设置 VCO 输入时钟 分频因子						m
		设置 VCO 输出时钟	分频因子						n
		设置 PLLCLK 时钟分频因子							p
		设置 OTG、FS、SDIO、RNG 时钟分频因子	q
4、开启 PLL，并等待 PPL 稳定
5、开启 PLLCK	切换为系统时钟 SYSCLK
6、读取时钟切换状态位，确保 PLLCLK 被选为系统时钟
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLL_M</span>      <span class="token expression"><span class="token number">25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLL_Q</span>      <span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLL_N</span>      <span class="token expression"><span class="token number">336</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLL_P</span>      <span class="token expression"><span class="token number">2</span></span></span>

<span class="token comment">//如果要超频的话，修改 PLL_N 这个宏即可，取值范围 192 ~ 432</span>
<span class="token comment">//如果没有配置系统时钟，CPU默认使用HSI作为系统时钟，这个时候整个系统时钟只有16MHZ</span>
<span class="token keyword">void</span> <span class="token function">User_SetSysClock</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token comment">/*            PLL (clocked by HSE) used as System clock source                */</span>
<span class="token comment">/*            PLL（由HSE计时）用作系统时钟源                                  */</span>
<span class="token comment">/******************************************************************************/</span>
  __IO <span class="token class-name">uint32_t</span> StartUpCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> HSEStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* 使能 HSE */</span>
  RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CR_HSEON<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token comment">/* 等待HSE准备就绪，如果超时，则退出 (等待 HSE  启动稳定)*/</span>
  <span class="token keyword">do</span><span class="token punctuation">{</span>
		<span class="token comment">//RCC_CR 时钟控制寄存器 ,第17位是HSERDY ，用以指示 HSE 振荡器已稳定</span>
		<span class="token comment">//RCC_CR_HSERDY = 0x00020000 = 100000000000000000</span>
    HSEStatus <span class="token operator">=</span> RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_HSERDY<span class="token punctuation">;</span>
    StartUpCounter<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HSEStatus <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>StartUpCounter <span class="token operator">!=</span> HSE_STARTUP_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//如果HSE启动成功 HSEStatus = 1 否则 0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_HSERDY<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">{</span>
    HSEStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x01</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    HSEStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x00</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token comment">//如果 HSE 启动成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>HSEStatus <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/* Select regulator voltage output Scale 1 mode */</span>
		<span class="token comment">/* 选择电压调节器模式为1   //(调压器电压输出级别配置为 1，以便在器件为最大频率) */</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_PWREN<span class="token punctuation">;</span><span class="token comment">//打开STM32 的备份寄存器 电源</span>
		<span class="token comment">//    工作时使性能和功耗实现平衡</span>
    PWR<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> PWR_CR_VOS<span class="token punctuation">;</span>

		<span class="token comment">// 设置 AHB/APB2/APB1    的分频因子</span>
    <span class="token comment">/* HCLK = SYSCLK / 1*/</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_HPRE_DIV1<span class="token punctuation">;</span>
     
    <span class="token comment">/* PCLK2 = HCLK / 2*/</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_PPRE2_DIV2<span class="token punctuation">;</span>
    
    <span class="token comment">/* PCLK1 = HCLK / 4*/</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_PPRE1_DIV4<span class="token punctuation">;</span>
   
    <span class="token comment">/* Configure the main PLL */</span>
		<span class="token comment">/* 配置主 PLL 的时钟来源，设置 M,N,P,Q */</span>
    RCC<span class="token operator">-&gt;</span>PLLCFGR <span class="token operator">=</span> PLL_M <span class="token operator">|</span> <span class="token punctuation">(</span>PLL_N <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PLL_P <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
                   <span class="token punctuation">(</span>RCC_PLLCFGR_PLLSRC_HSE<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>PLL_Q <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Enable the main PLL */</span>
		<span class="token comment">// 使能主 PLL</span>
    RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> RCC_CR_PLLON<span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is ready */</span>
		<span class="token comment">//等待 PLL 稳定</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
   
   
    <span class="token comment">/* Configure Flash prefetch, Instruction cache, Data cache and wait state */</span>
		<span class="token comment">// 配置 FLASH 预取指, 指令缓存, 数据缓存和等待周期 </span>
			<span class="token comment">// STM32 是多级流水线 : 取指令执行的的时候把下一条指令取好，</span>
			<span class="token comment">//下次就可以继续直接执行了，不断这样，这就是预取指，指令缓存和数据缓存是差不多的</span>
			<span class="token comment">//等待周期 ：表示CPU时钟周期与Flash访问时间之比 </span>
			<span class="token comment">//意思是说 读Flash的时候不能太快，Flash跟不上CPU执行速度，可能会出现一些不可预知的问题，</span>
			<span class="token comment">//老师说他超频读取WIFI遇到了问题，超频的时候，记得把这个也改下</span>
    FLASH<span class="token operator">-&gt;</span>ACR <span class="token operator">=</span> FLASH_ACR_PRFTEN <span class="token operator">|</span> FLASH_ACR_ICEN <span class="token operator">|</span>FLASH_ACR_DCEN <span class="token operator">|</span>FLASH_ACR_LATENCY_5WS<span class="token punctuation">;</span>


    <span class="token comment">/* Select the main PLL as system clock source */</span>
		<span class="token comment">//选择主 PLLCLK 作为系统时钟</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_SW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_SW_PLL<span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is used as system clock source */</span>
		<span class="token comment">// 读取时钟切换状态位，确保 PLLCLK 选为系统时钟</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SWS <span class="token punctuation">)</span> <span class="token operator">!=</span> RCC_CFGR_SWS_PLL<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> <span class="token comment">/* If HSE fails to start-up, the application will have wrong clock
         configuration. User can add here some code to deal with this error */</span>
		<span class="token comment">/*
		如果HSE无法启动，应用程序将具有错误的时钟配置。用户可以在此处添加一些代码来处理此错误
		*/</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Select regulator voltage output Scale 1 mode */</span>
  RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_PWREN<span class="token punctuation">;</span>
  PWR<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> PWR_CR_VOS<span class="token punctuation">;</span>
  
  <span class="token comment">/* HCLK = SYSCLK / 1*/</span>
  RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_HPRE_DIV1<span class="token punctuation">;</span>
  
  <span class="token comment">/* PCLK2 = HCLK / 2*/</span>
  RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_PPRE2_DIV1<span class="token punctuation">;</span>
  
  <span class="token comment">/* PCLK1 = HCLK / 4*/</span>
  RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_PPRE1_DIV2<span class="token punctuation">;</span>
  
  <span class="token comment">/* Configure the main PLL */</span>
  RCC<span class="token operator">-&gt;</span>PLLCFGR <span class="token operator">=</span> PLL_M <span class="token operator">|</span> <span class="token punctuation">(</span>PLL_N <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PLL_P <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>PLL_Q <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   
  <span class="token comment">/* Enable the main PLL */</span>
  RCC<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> RCC_CR_PLLON<span class="token punctuation">;</span>
  
  <span class="token comment">/* Wait till the main PLL is ready */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>   
  <span class="token punctuation">}</span>
  
  <span class="token comment">/* Configure Flash prefetch, Instruction cache, Data cache and wait state */</span>
  FLASH<span class="token operator">-&gt;</span>ACR <span class="token operator">=</span> FLASH_ACR_PRFTEN <span class="token operator">|</span> FLASH_ACR_ICEN <span class="token operator">|</span>FLASH_ACR_DCEN <span class="token operator">|</span>FLASH_ACR_LATENCY_2WS<span class="token punctuation">;</span>
  
  <span class="token comment">/* Select the main PLL as system clock source */</span>
  RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token operator">~</span><span class="token punctuation">(</span>RCC_CFGR_SW<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">|=</span> RCC_CFGR_SW_PLL<span class="token punctuation">;</span>
  
  <span class="token comment">/* Wait till the main PLL is used as system clock source */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>CFGR <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RCC_CFGR_SWS <span class="token punctuation">)</span> <span class="token operator">!=</span> RCC_CFGR_SWS_PLL<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clock_config.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">User_SetSysClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/my-vuepress-blog/assets/image-20220920191908191-823e1817.png" alt="image-20220920191908191"></p><ul><li>自己配置时钟</li></ul><h3 id="使用hse" tabindex="-1"><a class="header-anchor" href="#使用hse" aria-hidden="true">#</a> 使用HSE</h3><p>一般情况下，我们都是使用HSE，然后HSE 经过PLL 倍频之后作为系统时钟。F407 系统时钟最 高为 168M，这个是官方推荐的最高的稳定时钟，如果你想铤而走险，也可以超频，超频最高能 到216M。</p><p>如果我们使用库函数编程，当程序来到main 函数之前，启动文件：startup_stm32f40xxx.s 已经调 用SystemInit() 函数把系统时钟初始化成168MHZ，SystemInit() 在库文件：system_stm32f4xx.c 中 定义。如果我们想把系统时钟设置低一点或者超频的话，可以修改底层的库文件，但是为了维持 库的完整性，我们可以根据时钟树的流程自行写一个。</p><h3 id="使用hsi" tabindex="-1"><a class="header-anchor" href="#使用hsi" aria-hidden="true">#</a> 使用HSI</h3><p>当 HSE 直接或者间接（HSE 经过 PLL 倍频）的作为系统时钟的时候，如果 HSE 发生故障，不 仅 HSE 会被关闭，连 PLL 也会被关闭，这个时候系统会自动切换 HSI 作为系统时钟，此时 SYSCLK=HSI=16M，如果没有开启 CSS 和 CSS 中断的话，那么整个系统就只能在低速率运行， 这是系统跟瘫痪没什么两样。</p><p>如果开启了CSS 功能的话，那么可以当HSE 故障时，在CSS 中断里面采取补救措施，使用HSI， 重新设置系统频率为 168M，让系统恢复正常使用。但这只是权宜之计，并非万全之策，最好的 方法还是要采取相应的补救措施并报警，然后修复HSE。临时使用HSI 只是为了把损失降低到最 小，毕竟HSI 较于HSE 精度还是要低点。</p><p><strong>F103 系列中</strong>，使用HSI 最大只能把系统设置为64M，并不能跟使用HSE 一样把系统时钟设置为 72M，究其原因是 HSI 在进入 PLL 倍频的时候必须 2 分频，导致 PLL 倍频因子调到最大也只能到 64M，而HSE 进入PLL 倍频的时候则不用2 分频。</p><p><strong>在F407 中</strong>，无论是使用HSI 还是HSE 都可以把系统时钟设置为168M，因为HSE 或者HSI 在进 入 PLL 倍频的时候都会被分频为1M 之后再倍频。 还有一种情况是，有些用户不想用 HSE，想用 HSI，但是又不知道怎么用 HSI 来设置系统时钟， 因为调用库函数都是使用HSE，下面我们给出个使用HSI 配置系统时钟例子，起个抛砖引玉的作 用。</p><h3 id="硬件设计" tabindex="-1"><a class="header-anchor" href="#硬件设计" aria-hidden="true">#</a> 硬件设计</h3><ul><li>LED</li><li>RCC <ul><li>RCC 是单片机内部资源，不需要外部电路。通过 LED 闪烁的频率来直观的判断不同系统时钟频率对软件延时的效果。</li></ul></li></ul><h3 id="软件设计" tabindex="-1"><a class="header-anchor" href="#软件设计" aria-hidden="true">#</a> 软件设计</h3><p>我们编写两个 RCC 驱动文件，bsp_clkconﬁg.h 和 bsp_clkconﬁg.c，用来存放 RCC 系统时钟配置函 数。</p><h3 id="编程要点" tabindex="-1"><a class="header-anchor" href="#编程要点" aria-hidden="true">#</a> 编程要点</h3><ol><li>开启 HSE/HSI ，并等待 HSE/HSI 稳定</li><li>设置 AHB、APB2、APB1 的预分频因子</li><li>设置 PLL 的时钟来源，设置 VCO 输入时钟分频因子 PLL_M，设置 VCO 输出时钟倍频因子 PLL_N，设置PLLCLK 时钟分频因子PLL_P，设置OTG FS,SDIO,RNG 时钟分频因子PLL_Q</li><li>开启 PLL，并等待 PLL 稳定</li><li>把 PLLCK 切换为系统时钟SYSCLK</li><li>读取时钟切换状态位，确保PLLCLK 被选为系统时钟</li></ol><p><code>bsp_clkconfig.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_CLKCONFIG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_CLKCONFIG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span>		<span class="token comment">//导入寄存器映射</span></span>

<span class="token keyword">void</span> <span class="token function">HSE_SetSysClock</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> m<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> n<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> p<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">HSI_SetSysClock</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> m<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> n<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> p<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_CLKCONFIG_H*/</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_clkconfig.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>

<span class="token comment">/*
使用 HSE 时，设置系统时钟的步骤
1、开启 HSE , 并等待 HSE 稳定
2、开启 AHB、APB2、APB1 的预分频因子
3、设置 PLL 的时钟来源
		设置 VCO 输入时钟 分频因子						m
		设置 VCO 输出时钟	分频因子						n
		设置 PLLCLK 时钟分频因子							p
		设置 OTG、FS、SDIO、RNG 时钟分频因子	q
4、开启 PLL，并等待 PPL 稳定
5、开启 PLLCK	切换为系统时钟 SYSCLK
6、读取时钟切换状态位，确保 PLLCLK 被选为系统时钟
*/</span>

<span class="token comment">/*
*    m: VCO 输入时钟 分频因子，取值 2~63
*    n: VCO 输出时钟 倍频因子，取值 192~432
*    p: PLLCLK 时钟分频因子 ，取值 2，4，6，8 
*    q: OTG FS,SDIO,RNG 时钟分频因子，取值 4~15 
*    函数调用举例，使用 HSE 设置时钟
*    SYSCLK=HCLK=168M,PCLK2=HCLK/2=84M,PCLK1=HCLK/4=42M 
*    HSE_SetSysClock(25, 336, 2, 7);
*    HSE 作为时钟来源，经过 PLL 倍频作为系统时钟，这是通常的做法 
*    系统时钟超频到 216M 爽一下
*    HSE_SetSysClock(25, 432, 2, 7); 
*/</span>

<span class="token comment">//如果要超频的话，修改 n 即可，取值范围 192 ~ 432</span>
<span class="token comment">//如果没有配置系统时钟，CPU默认使用HSI作为系统时钟，这个时候整个系统时钟只有16MHZ</span>
<span class="token keyword">void</span> <span class="token function">HSE_SetSysClock</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> m<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> n<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> p<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> q<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token comment">/*            PLL (clocked by HSE) used as System clock source                */</span>
<span class="token comment">/*            PLL（由HSE计时）用作系统时钟源                                  */</span>
<span class="token comment">/******************************************************************************/</span>
  __IO <span class="token class-name">uint32_t</span> HSEStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 使能 HSE，开启外部晶振，野火 F407 使用 HSE=25M</span>
  <span class="token function">RCC_HSEConfig</span><span class="token punctuation">(</span>RCC_HSE_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 等待 HSE 启动稳定</span>
	HSEStatus <span class="token operator">=</span> <span class="token function">RCC_WaitForHSEStartUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>HSEStatus <span class="token operator">==</span> SUCCESS<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//打开STM32 的备份寄存器 电源</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_PWREN<span class="token punctuation">;</span> 
		
		<span class="token comment">//调压器电压输出级别配置为 1，以便在器件为最大频率</span>
		<span class="token comment">// 工作时使性能和功耗实现平衡</span>
    PWR<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> PWR_CR_VOS<span class="token punctuation">;</span>						 

		<span class="token comment">// 设置 AHB/APB2/APB1 的分频因子</span>
    <span class="token comment">/* HCLK = SYSCLK / 1*/</span>
		<span class="token function">RCC_HCLKConfig</span><span class="token punctuation">(</span>RCC_SYSCLK_Div1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* PCLK2 = HCLK / 2*/</span>
		<span class="token function">RCC_PCLK2Config</span><span class="token punctuation">(</span>RCC_HCLK_Div2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* PCLK1 = HCLK / 4*/</span>
		<span class="token function">RCC_PCLK1Config</span><span class="token punctuation">(</span>RCC_HCLK_Div4<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
    <span class="token comment">//如果要超频就得在这里下手啦</span>
		<span class="token comment">//设置 PLL 来源时钟，设置 VCO 分频因子 m，设置 VCO 倍频因子 n</span>
		<span class="token comment">//设置系统时钟分频因子 p，设置 OTG FS,SDIO,RNG 分频因子 q</span>
    <span class="token comment">/* Configure the main PLL */</span>
		<span class="token comment">/* 配置主 PLL 的时钟来源，设置 M,N,P,Q */</span>
    <span class="token function">RCC_PLLConfig</span><span class="token punctuation">(</span>RCC_PLLSource_HSE<span class="token punctuation">,</span>m<span class="token punctuation">,</span>n<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Enable the main PLL */</span>
		<span class="token comment">// 使能主 PLL</span>
    <span class="token function">RCC_PLLCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is ready */</span>
		<span class="token comment">//等待 PLL 稳定</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
   
   
    <span class="token comment">/* Configure Flash prefetch, Instruction cache, Data cache and wait state */</span>
		<span class="token comment">// 配置 FLASH 预取指, 指令缓存, 数据缓存和等待周期 </span>
			<span class="token comment">// STM32 是多级流水线 : 取指令执行的的时候把下一条指令取好，</span>
			<span class="token comment">//下次就可以继续直接执行了，不断这样，这就是预取指，指令缓存和数据缓存是差不多的</span>
			<span class="token comment">//等待周期 ：表示CPU时钟周期与Flash访问时间之比 </span>
			<span class="token comment">//意思是说 读Flash的时候不能太快，Flash跟不上CPU执行速度，可能会出现一些不可预知的问题，</span>
			<span class="token comment">//老师说他超频读取WIFI遇到了问题，超频的时候，记得把这个也改下</span>
    FLASH<span class="token operator">-&gt;</span>ACR <span class="token operator">=</span> FLASH_ACR_PRFTEN
								 <span class="token operator">|</span> FLASH_ACR_ICEN
								 <span class="token operator">|</span> FLASH_ACR_DCEN
								 <span class="token operator">|</span> FLASH_ACR_LATENCY_5WS<span class="token punctuation">;</span>


    <span class="token comment">/* Select the main PLL as system clock source */</span>
		<span class="token comment">//选择主 PLLCLK 作为系统时钟</span>
    <span class="token function">RCC_SYSCLKConfig</span><span class="token punctuation">(</span>RCC_SYSCLKSource_PLLCLK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is used as system clock source */</span>
		<span class="token comment">// 读取时钟切换状态位，确保 PLLCLK 选为系统时钟</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">RCC_GetSYSCLKSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RCC_CFGR_SWS_PLL<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> 
		<span class="token comment">/* If HSE fails to start-up, the application will have wrong clock
       configuration. User can add here some code to deal with this error */</span>
		<span class="token comment">/*
		如果HSE无法启动，应用程序将具有错误的时钟配置。用户可以在此处添加一些代码来处理此错误
		*/</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
使用 HSI 时，设置系统时钟的步骤
1、开启 HSI , 并等待 HSE 稳定
2、开启 AHB、APB2、APB1 的预分频因子
3、设置 PLL 的时钟来源
		设置 VCO 输入时钟 分频因子						m
		设置 VCO 输出时钟	分频因子						n
		设置 PLLCLK 时钟分频因子							p
		设置 OTG、FS、SDIO、RNG 时钟分频因子	q
4、开启 PLL，并等待 PPL 稳定
5、开启 PLLCK	切换为系统时钟 SYSCLK
6、读取时钟切换状态位，确保 PLLCLK 被选为系统时钟
*/</span>

<span class="token comment">/*
*    m: VCO 输入时钟 分频因子，取值 2~63
*    n: VCO 输出时钟 倍频因子，取值 192~432
*    p: PLLCLK 时钟分频因子 ，取值 2，4，6，8 
*    q: OTG FS,SDIO,RNG 时钟分频因子，取值 4~15 
*    函数调用举例，使用 HSI 设置时钟
*    SYSCLK=HCLK=168M,PCLK2=HCLK/2=84M,PCLK1=HCLK/4=42M 
*    HSI_SetSysClock(25, 336, 2, 7);
*    HSI 作为时钟来源，经过 PLL 倍频作为系统时钟，这是通常的做法 
*    系统时钟超频到 216M 爽一下
*    HSI_SetSysClock(25, 432, 2, 9); 
*/</span>


<span class="token comment">//如果要超频的话，修改 n 即可，取值范围 192 ~ 432</span>
<span class="token comment">//如果没有配置系统时钟，CPU默认使用HSI作为系统时钟，这个时候整个系统时钟只有16MHZ</span>
<span class="token keyword">void</span> <span class="token function">HSI_SetSysClock</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> m<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> n<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> p<span class="token punctuation">,</span><span class="token class-name">uint32_t</span> q<span class="token punctuation">)</span><span class="token punctuation">{</span>
  __IO <span class="token class-name">uint32_t</span> HSIStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">//把 RCC 外设初始化成复位状态</span>
	<span class="token function">RCC_DeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能 HSI,HSI=16M</span>
	<span class="token function">RCC_HSICmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//等待 HSI 就绪</span>
	HSIStatus <span class="token operator">=</span> RCC<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> RCC_CR_HSIRDY<span class="token punctuation">;</span>
	<span class="token comment">//只有 HSI 就绪之后则继续往下执行</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>HSIStatus <span class="token operator">==</span> RCC_CR_HSIRDY<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//打开STM32 的备份寄存器 电源</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR <span class="token operator">|=</span> RCC_APB1ENR_PWREN<span class="token punctuation">;</span> 
		
		<span class="token comment">//调压器电压输出级别配置为 1，以便在器件为最大频率</span>
		<span class="token comment">// 工作时使性能和功耗实现平衡</span>
    PWR<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> PWR_CR_VOS<span class="token punctuation">;</span>						 

		<span class="token comment">// 设置 AHB/APB2/APB1 的分频因子</span>
    <span class="token comment">/* HCLK = SYSCLK / 1*/</span>
		<span class="token function">RCC_HCLKConfig</span><span class="token punctuation">(</span>RCC_SYSCLK_Div1<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* PCLK2 = HCLK / 2*/</span>
		<span class="token function">RCC_PCLK2Config</span><span class="token punctuation">(</span>RCC_HCLK_Div2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* PCLK1 = HCLK / 4*/</span>
		<span class="token function">RCC_PCLK1Config</span><span class="token punctuation">(</span>RCC_HCLK_Div4<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
    <span class="token comment">//如果要超频就得在这里下手啦</span>
		<span class="token comment">//设置 PLL 来源时钟，设置 VCO 分频因子 m，设置 VCO 倍频因子 n</span>
		<span class="token comment">//设置系统时钟分频因子 p，设置 OTG FS,SDIO,RNG 分频因子 q</span>
    <span class="token comment">/* Configure the main PLL */</span>
		<span class="token comment">/* 配置主 PLL 的时钟来源，设置 M,N,P,Q */</span>
    <span class="token function">RCC_PLLConfig</span><span class="token punctuation">(</span>RCC_PLLSource_HSI<span class="token punctuation">,</span>m<span class="token punctuation">,</span>n<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Enable the main PLL */</span>
		<span class="token comment">// 使能主 PLL</span>
    <span class="token function">RCC_PLLCmd</span><span class="token punctuation">(</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is ready */</span>
		<span class="token comment">//等待 PLL 稳定</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">RCC_GetFlagStatus</span><span class="token punctuation">(</span>RCC_FLAG_PLLRDY<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
   
   
    <span class="token comment">/* Configure Flash prefetch, Instruction cache, Data cache and wait state */</span>
		<span class="token comment">// 配置 FLASH 预取指, 指令缓存, 数据缓存和等待周期 </span>
			<span class="token comment">// STM32 是多级流水线 : 取指令执行的的时候把下一条指令取好，</span>
			<span class="token comment">//下次就可以继续直接执行了，不断这样，这就是预取指，指令缓存和数据缓存是差不多的</span>
			<span class="token comment">//等待周期 ：表示CPU时钟周期与Flash访问时间之比 </span>
			<span class="token comment">//意思是说 读Flash的时候不能太快，Flash跟不上CPU执行速度，可能会出现一些不可预知的问题，</span>
			<span class="token comment">//老师说他超频读取WIFI遇到了问题，超频的时候，记得把这个也改下</span>
    FLASH<span class="token operator">-&gt;</span>ACR <span class="token operator">=</span> FLASH_ACR_PRFTEN
								 <span class="token operator">|</span> FLASH_ACR_ICEN
								 <span class="token operator">|</span> FLASH_ACR_DCEN
								 <span class="token operator">|</span> FLASH_ACR_LATENCY_5WS<span class="token punctuation">;</span>


    <span class="token comment">/* Select the main PLL as system clock source */</span>
		<span class="token comment">//选择主 PLLCLK 作为系统时钟</span>
    <span class="token function">RCC_SYSCLKConfig</span><span class="token punctuation">(</span>RCC_SYSCLKSource_PLLCLK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Wait till the main PLL is used as system clock source */</span>
		<span class="token comment">// 读取时钟切换状态位，确保 PLLCLK 选为系统时钟</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">RCC_GetSYSCLKSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> RCC_CFGR_SWS_PLL<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> 
		<span class="token comment">/* If HSI fails to start-up, the application will have wrong clock
       configuration. User can add here some code to deal with this error */</span>
		<span class="token comment">/*
		如果HSI无法启动，应用程序将具有错误的时钟配置。用户可以在此处添加一些代码来处理此错误
		*/</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">HSE_SetSysClock</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">192</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//HSE_SetSysClock(25,432,2,7);</span>
	
	<span class="token comment">//HSI_SetSysClock(16,192,2,7);</span>
	<span class="token comment">//HSI_SetSysClock(16,336,2,7);</span>
	
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化HSI时钟函数采用库函数，HSI 为 16M，参数 m 我们一般也设置为 16，所以我们需要修改系统时钟的时候只需要修改参数 n 和p 即可，<code>SYSCLK=PLLCLK=HSI/m*n/p</code>。 函数调用举例：<code>HSI_SetSysClock(16, 336, 2, 7)</code> 把系统时钟设置为 168M，这个跟库里面的系统时 钟配置是一样的。<code>HSI_SetSysClock(16, 432, 2, 9) </code> 把系统时钟设置为216M，这个是超频，要慎用。</p><p><strong>软件延时函数，使用不同的系统时钟，延时时间不一样，可以通过LED 闪烁的频率来判断。</strong></p><h3 id="mco-输出" tabindex="-1"><a class="header-anchor" href="#mco-输出" aria-hidden="true">#</a> MCO 输出</h3><p>在 F407 中，PA8/PC9 可以复用为 MCO1/2 引脚，对外提供时钟输出，我们也可以用示波器监控 该引脚的输出来判断我们的系统时钟是否设置正确。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">void</span> <span class="token function">MCO1_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//开启 GPIOA 的时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin<span class="token operator">=</span>GPIO_Pin_8<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span>
	<span class="token comment">//复用功能模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
	<span class="token comment">//推挽输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	<span class="token comment">//上拉</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">MCO2_GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//开启 GPIOC 的时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOC<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin<span class="token operator">=</span>GPIO_Pin_9<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//HSE_SetSysClock(25,192,2,7);</span>
	<span class="token function">HSE_SetSysClock</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">432</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//HSI_SetSysClock(16,192,2,7);</span>
	<span class="token comment">//HSI_SetSysClock(16,336,2,7);</span>
	
	<span class="token comment">//MCO GPIO 初始化</span>
	<span class="token function">MCO1_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">MCO2_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		
	<span class="token comment">//LED GPIO 初始化</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//MCO1 输出 PPLCLK</span>
	<span class="token function">RCC_MCO1Config</span><span class="token punctuation">(</span>RCC_MCO1Source_PLLCLK<span class="token punctuation">,</span>RCC_MCO1Div_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//MCO2 输出 SYSCLK</span>
	<span class="token function">RCC_MCO2Config</span><span class="token punctuation">(</span>RCC_MCO2Source_SYSCLK<span class="token punctuation">,</span>RCC_MCO2Div_1<span class="token punctuation">)</span><span class="token punctuation">;</span>

		
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">0x0fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>我们初始化MCO 引脚之后，可以直接调用库函数RCC_MCOxConﬁg() 来选择MCO 时钟来源，同时还可以分频，这两个参数的取值参考库函数说明即可。</p></li><li><p>在主函数中，可以调用 HSE_SetSysClock() 或者 HSI_SetSysClock() 这两个函数把系统时钟设置成 各种常用的时钟，然后通过MCO 引脚监控，或者通过LED 闪烁的快慢体验不同的系统时钟对同 一个软件延时函数的影响。</p></li></ul><h3 id="下载验证" tabindex="-1"><a class="header-anchor" href="#下载验证" aria-hidden="true">#</a> 下载验证</h3><ul><li>把编译好的程序下载到开发板，可以看到设置不同的系统时钟时，LED 闪烁的快慢不一样。更精确的数据我们可以用示波器监控MCO 引脚看到。</li></ul><h2 id="stm32-中断应用概述" tabindex="-1"><a class="header-anchor" href="#stm32-中断应用概述" aria-hidden="true">#</a> STM32 中断应用概述</h2><p>本章参考资料《STM32F4xx 中文参考手册》第十章-中断和事件、《ARM Cortex™-M4F 技术参考 手册》-4.3 章节：NVIC 和 4.4 章节：SCB—4.4.5 的 AIRCR。</p><p>STM32 中断非常强大，每个外设都可以产生中断，所以中断的讲解放在哪一个外设里面去讲都 不合适，这里单独抽出一章来做一个总结性的介绍，这样在其他章节涉及到中断部分的知识我们 就不用费很大的篇幅去讲解，只要示意性带过即可。 <strong>本章如无特别说明，异常就是中断，中断就是异常，请不要刻意钻牛角尖较劲。</strong></p><h3 id="异常类型" tabindex="-1"><a class="header-anchor" href="#异常类型" aria-hidden="true">#</a> 异常类型</h3><ul><li>系统异常，体现在内核水平 <ul><li>Cortex M4 内核的异常</li></ul></li><li>外部中断，体现在外设水平 <ul><li>ST 公司在Cortex M4的加了一些外设 比如：GPIO、I2C、USART，叫做<strong>片上外设（STMF407这个芯片的外设）</strong>，外部中断是相对于内核来说的，虽然片上外设叫外，但实际上还是在芯片里面</li></ul></li></ul><p>F407 在内核水平上搭载了一个异常响应系统，支持为数众多的系统异常和外部中断。其中系统 异常有 10 个，外部中断有 82 个。除了个别异常的优先级被定死外，其它异常的优先级都是可 编程的。有关具体的系统异常和外部中断可在标准库文件 stm32f4xx.h 这个头文件查询到，在 IRQn_Type 这个结构体里面包含了F4 系列全部的异常声明。</p><p><strong>F407 系统异常清单</strong></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220923142551973.png" alt="image-20220923142551973"></p><h3 id="nvic-简介" tabindex="-1"><a class="header-anchor" href="#nvic-简介" aria-hidden="true">#</a> NVIC 简介</h3><p>NVIC：嵌套向量中断控制器，属于内核外设（在内核里面），管理着包括内核和片上所有外设的中断相关功能。</p><p>在<code>STM32F4xx中文参考手册.pdf</code>中只是简单的描述了NVIC的功能。具体需要参考<code>ARM Cortex™-M4F 技术参考手册.pdf</code></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220924225820167.png" alt="image-20220924225820167"></p><ul><li><p>(Nested vectored interrupt controller,NVIC,嵌套向量中断控制器)，它里面有非常多的寄存器 NVIC的功能非常强，但是 这个是ARM公司设计的，每一个芯片厂家比如：ST，它在拿这个内核生产芯片的时候，它会对NVIC进行裁剪 也就是说这些寄存器 在ST里面的NVIC不一定会全部包含这些寄存器 或者说 不一定会全部都使用。</p></li><li><p>两个重要的库文件：<code>core_cm4.h</code> 和 <code>misc.c</code> ,</p></li></ul><p>在固件库中，NVIC 的结构体定义给每个寄存器都预览了很多位，为的是日后扩展功能。不过 STM32F407 用不了这么多，只是用了部分而已，具体使用了多少可参考 《ARM Cortex™-M4F 技术参考手册》-4.3.11:NVIC 寄存器映射。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
__IO <span class="token class-name">uint32_t</span> ISER<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                          <span class="token comment">// 中断使能寄存器 </span>
<span class="token class-name">uint32_t</span> RESERVED0<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>													<span class="token comment">//RESERVED 保留</span>
  
__IO <span class="token class-name">uint32_t</span> ICER<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                          <span class="token comment">// 中断清除寄存器 </span>
<span class="token class-name">uint32_t</span> RSERVED1<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
__IO <span class="token class-name">uint32_t</span> ISPR<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                          <span class="token comment">// 中断使能悬起寄存器 </span>
<span class="token class-name">uint32_t</span> RESERVED2<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
__IO <span class="token class-name">uint32_t</span> ICPR<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                          <span class="token comment">// 中断清除悬起寄存器 </span>
<span class="token class-name">uint32_t</span> RESERVED3<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
__IO <span class="token class-name">uint32_t</span> IABR<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                          <span class="token comment">// 中断有效位寄存器 </span>
<span class="token class-name">uint32_t</span> RESERVED4<span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
__IO <span class="token class-name">uint8_t</span> IP<span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                           <span class="token comment">// 中断优先级寄存器 (8Bit wide) </span>
<span class="token class-name">uint32_t</span> RESERVED5<span class="token punctuation">[</span><span class="token number">644</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
__O <span class="token class-name">uint32_t</span> STIR<span class="token punctuation">;</span>                              <span class="token comment">// 软件触发中断寄存器 </span>
<span class="token punctuation">}</span> NVIC_Type<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在配置中断的时候我们一般只用ISER、ICER 和IP(IPR) 这三个寄存器，ISER 用来使能中断，ICER 用 来失能中断，IP 用来设置中断优先级。</p><h3 id="nvic-中断配置固件" tabindex="-1"><a class="header-anchor" href="#nvic-中断配置固件" aria-hidden="true">#</a> NVIC 中断配置固件</h3><p>在配置中断的时候我们一般只用ISER、ICER 和IP 这三个寄存器，ISER 用来使能中断，ICER 用 来失能中断，IP 用来设置中断优先级。</p><p>固件库文件core_cm4.h 的最后，还提供了NVIC 的一些函数，这些函数遵循CMSI 规则，只要是 Cortex-M4 的处理器都可以使用，具体如下：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220924213657198.png" alt="image-20220924213657198"></p><p>这些库函数我们在编程的时候用的都比较少，甚至基本都不用。在配置中断的时候我们还有更简 洁的方法，请看中断编程小节。</p><h3 id="优先级的定义" tabindex="-1"><a class="header-anchor" href="#优先级的定义" aria-hidden="true">#</a> 优先级的定义</h3><h4 id="优先级定义" tabindex="-1"><a class="header-anchor" href="#优先级定义" aria-hidden="true">#</a> 优先级定义</h4><p>在 NVIC 有一个专门的寄存器：中断优先级寄存器 NVIC_IPRx（在 F407 中，x=0…981）用来配 置外部中断的优先级，IPR 宽度为 8bit，原则上每个外部中断可配置的优先级为 0~255，数值越 小，优先级越高。但是绝大多数 CM4 芯片都会精简设计，以致实际上支持的优先级数减少，在 F407 中，只使用了高4bit，如下所示：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220924221104797.png" alt="image-20220924221104797"></p><p>用于表达优先级的这4bit，又被分组成抢占优先级和子优先级。如果有多个中断同时响应，抢占 优先级高的就会抢占抢占优先级低的优先得到执行，如果抢占优先级相同，就比较子优先级。如 果抢占优先级和子优先级都相同的话，就比较他们的硬件中断编号，编号越小，优先级越高。</p><h3 id="优先级分组" tabindex="-1"><a class="header-anchor" href="#优先级分组" aria-hidden="true">#</a> 优先级分组</h3><p>优先级的分组由内核外设 SCB 的(AIRCR，Application interrupt and reset control register，应用程序中断及复位控制寄存器) 的 PRIGROUP[10:8] 位 决定，F407 分为了5 组，具体如下：主优先级= 抢占优先级</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220925003617107.png" alt="image-20220925003617107"></p><p>设置优先级分组可调用库函数NVIC_PriorityGroupConﬁg() 实现，有关NVIC 中断相关的库函数都 在库文件misc.c 和 misc.h 中。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/**
* 配置中断优先级分组：抢占优先级和子优先级 
* 形参如下：
* @arg NVIC_PriorityGroup_0: 0 bit for 抢占优先级
*														 4 bits for 子优先级
* @arg NVIC_PriorityGroup_1: 1 bit for 抢占优先级
*														 3 bits for 子优先级
* @arg NVIC_PriorityGroup_2: 2 bit for 抢占优先级
*                            2 bits for 子优先级
* @arg NVIC_PriorityGroup_3: 3 bit for 抢占优先级
*    											   1 bits for 子优先级
* @arg NVIC_PriorityGroup_4: 4 bit for 抢占优先级
*                            0 bit for 子优先级 
*@ 注意:如果优先级分组为 0，则抢占优先级就不存在，优先级就全部由子优先级控制
*/</span>
<span class="token keyword">void</span> <span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> NVIC_PriorityGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 设置优先级分组</span>
	SCB<span class="token operator">-&gt;</span>AIRCR <span class="token operator">=</span> AIRCR_VECTKEY_MASK <span class="token operator">|</span> NVIC_PriorityGroup<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220925004247385.png" alt="image-20220925004247385"></p><h3 id="中断编程" tabindex="-1"><a class="header-anchor" href="#中断编程" aria-hidden="true">#</a> 中断编程</h3><p><strong>在配置每个中断的时候一般有3 个编程要点：</strong></p><ul><li>使能外设某个中断，这个具体由每个外设的相关中断使能位控制。比如串口有发送完成中断， 接收完成中断，这两个中断都由<strong>串口控制寄存器的相关中断使能位控制</strong>。</li><li>初始化 NVIC_InitTypeDef 结构体，配置中断优先级分组，设置抢占优先级和子优先级，使能 中断请求。</li><li>编写中断服务函数 <ul><li>在启动文件 startup_stm32f40xx.s 中我们预先为每个中断都写了一个中断服务函数，只是这些中 断函数都是为空，为的只是初始化中断向量表。实际的中断服务函数都需要我们重新编写，中断服务函数我们统一写在stm32f4xx_it.c 这个库文件中。</li><li>关于中断服务函数的函数名必须跟启动文件里面预先设置的一样，如果写错，系统就在中断向量 表中找不到中断服务函数的入口，直接跳转到启动文件里面预先写好的空函数，并且在里面无限 循环，实现不了中断。</li></ul></li></ul><p><strong>NVIC 初始化结构体</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint8_t</span> NVIC_IRQChannel<span class="token punctuation">;</span>   											   <span class="token comment">// 中断源</span>
  <span class="token class-name">uint8_t</span> NVIC_IRQChannelPreemptionPriority<span class="token punctuation">;</span>         <span class="token comment">// 抢占优先级 </span>
	<span class="token class-name">uint8_t</span> NVIC_IRQChannelSubPriority<span class="token punctuation">;</span>                <span class="token comment">// 子优先级</span>
  FunctionalState NVIC_IRQChannelCmd<span class="token punctuation">;</span> 	        		 <span class="token comment">// 中断使能或者失能 </span>
<span class="token punctuation">}</span> NVIC_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关NVIC 初始化结构体的成员我们一一解释下：</p><ul><li>NVIC_IROChannel：用来设置中断源，不同的中断中断源不一样，且不可写错，即使写错了程 序不会报错，只会导致不想要中断。具体的成员配置可参考stm32f4xx.h 头文件里面的IRQn_Type 结构体定义，这个结构体包含了所有的中断源。</li><li>NVIC_IRQChannelPreemptionPriority：抢占优先级，具体的值要根据优先级分组来确定，具体 参考表格优先级分组真值表。</li><li>NVIC_IRQChannelSubPriority：子优先级，具体的值要根据优先级分组来确定，具体参考表格 优先级分组真值表。</li><li>NVIC_IRQChannelCmd：中断使能（ENABLE）或者失能（DISABLE）。操作的是NVIC_ISER 和 NVIC_ICER 这两个寄存器。</li></ul><p><strong>IRQn_Type 中断源结构体</strong></p><p>我们把引起中断的原因，或者能够发出中断请求信号的来源统称为<strong>中断源</strong>（即中断向量表中的内容）</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209270223966.png" alt="image-20220927022340294" style="zoom:25%;"><ul><li><strong>NVIC_IRQChannel</strong> 需要指向这些东西</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token class-name">IRQn</span> <span class="token punctuation">{</span>
  <span class="token comment">//Cortex-M4 处理器异常编号 </span>
	NonMaskableInt_IRQn 		<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">,</span> 
	MemoryManagement_IRQn 	<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span>
  BusFault_IRQn 					<span class="token operator">=</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span>
	UsageFault_IRQn 				<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
	SVCall_IRQn 						<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span>
	DebugMonitor_IRQn 			<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span>
  PendSV_IRQn 						<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>
  SysTick_IRQn 						<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token comment">//STM32 外部中断编号</span>
  WWDG_IRQn 							<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  PVD_IRQn 								<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  TAMP_STAMP_IRQn					<span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  
  <span class="token comment">// 限于篇幅，中间部分代码省略，具体的可查看库文件 stm32f4xx.h</span>
  
  CRYP_IRQn 							<span class="token operator">=</span> <span class="token number">79</span><span class="token punctuation">,</span>
  HASH_RNG_IRQn 					<span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">,</span>
  FPU_IRQn 								<span class="token operator">=</span> <span class="token number">81</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> IRQn_Type<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="exti-外部中断-事件控制器" tabindex="-1"><a class="header-anchor" href="#exti-外部中断-事件控制器" aria-hidden="true">#</a> EXTI 外部中断/事件控制器</h2><p>本章参考资料：《STM32F4xx 中文参考手册》系统配置控制器以及中断和事件章节。</p><p>上一章我们已经详细介绍了 NVIC，对 STM32F4xx 中断管理系统有个全局的了解，我们这章的 内容是 NVIC 的实例应用，也是 STM32F4xx 控制器非常重要的一个资源。学习本章时，配合 《STM32F4xx 中文参考手册》系统配置控制器以及中断和事件章节一起阅读，效果会更佳，特别 是涉及到寄存器说明的部分。 特别说明，本书内容是以 STM32F40xxx 系列控制器资源讲解。</p><h3 id="exti-简介" tabindex="-1"><a class="header-anchor" href="#exti-简介" aria-hidden="true">#</a> EXTI 简介</h3><p>外部中断/事件控制器(EXTI) 管理了控制器的23 个中断/事件线。每个中断/事件线都对应有一个 边沿检测器，可以实现输入信号的上升沿检测和下降沿的检测。EXTI 可以实现对每个中断/事件 线进行单独配置，可以单独配置为中断或者事件，以及触发事件的属性。</p><h3 id="exti-功能框图" tabindex="-1"><a class="header-anchor" href="#exti-功能框图" aria-hidden="true">#</a> EXTI 功能框图</h3><p>EXTI 的功能框图包含了EXTI 最核心内容，掌握了功能框图，对EXTI 就有一个整体的把握，在 编程时就思路就非常清晰。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220925010817461.png" alt="image-20220925010817461"></p><ul><li><p>可以看到很多在信号线上打一个斜杠并标注“23”字样，这个表示在控制器内部类似的信号线路有23 个，这与EXTI 总共有23 个中断/事件线是吻合的。所以我们只要明白 其中一个的原理，那其他22 个线路原理也就知道了。</p></li><li><p>EXTI 可分为两大部分功能，一个是产生中断，另一个是产生事件，这两个功能从硬件上就有所 不同。</p><ul><li>首先我们来看图EXTI 功能框图中红色虚线指示的电路流程。它是一个产生中断的线路，最终信号流入到NVIC 控制器内。</li><li>编号 1 是输入线，EXTI 控制器有 23 个中断/事件输入线，这些输入线可以通过寄存器设置为任意一个 GPIO，也可以是一些外设的事件，这部分内容我们将在后面专门讲解。输入线一般是存在电平变化的信号。</li><li>编号 2 是一个边沿检测电路，它会根据上升沿触发选择寄存器 (EXTI_RTSR) 和下降沿触发选择寄存器(EXTI_FTSR) 对应位的设置来控制信号触发。边沿检测电路以输入线作为信号输入端，如果检测到有边沿跳变就输出有效信号 1 给编号 3 电路，否则输出无效信号 0。而 EXTI_RTSR 和 EXTI_FTSR 两个寄存器可以控制器需要检测哪些类型的电平跳变过程，可以是只有上升沿触发、只有下降沿触发或者上升沿和下降沿都触发。</li><li>编号3 电路实际就是一个或门电路，它一个输入来自编号2 电路，另外一输入来自软件中断事件 寄存器(EXTI_SWIER)。EXTI_SWIER 允许我们通过程序控制就可以启动中断/事件线，这在某些地方非常有用。我们知道或门的作用就是有”就为1，所以这两个输入随便一个有有效信号1 就 可以输出1 给编号4 和编号 6 电路。</li><li>编号 4 电路是一个与门电路，它一个输入编号 3 电路，另外一个输入来自中断屏蔽寄存器 (EXTI_IMR)。与门电路要求输入都为 1 才输出 1，导致的结果如果 EXTI_IMR 设置为 0 时，那 不管编号 3 电路的输出信号是 1 还是 0，最终编号 4 电路输出的信号都为 0；如果 EXTI_IMR 设置为 1 时，最终编号 4 电路输出的信号才由编号 3 电路的输出信号决定，这样我们可以简单 的控制 EXTI_IMR 来实现是否产生中断的目的。编号 4 电路输出的信号会被保存到挂起寄存器 (EXTI_PR) 内，如果确定编号4 电路输出为 1 就会把 EXTI_PR 对应位置 1。</li><li>编号5 是将 EXTI_PR 寄存器内容输出到NVIC 内，从而实现系统中断事件控制。</li></ul></li><li><p>接下来我们来看看绿色虚线指示的电路流程。它是一个产生事件的线路，最终输出一个脉冲信 号。</p><ul><li>产生事件线路是在编号 3 电路之后与中断线路有所不同，之前电路都是共用的。编号 6 电路 是一个与门，它一个输入编号 3 电路，另外一个输入来自事件屏蔽寄存器(EXTI_EMR)。如果 EXTI_EMR 设置为0 时，那不管编号3 电路的输出信号是1 还是0，最终编号6 电路输出的信号 都为0；如果EXTI_EMR 设置为1 时，最终编号6 电路输出的信号才由编号3 电路的输出信号决 定，这样我们可以简单的控制EXTI_EMR 来实现是否产生事件的目的。</li><li>编号7 是一个脉冲发生器电路，当它的输入端，即编号6 电路的输出端，是一个有效信号1 时就 会产生一个脉冲；如果输入端是无效信号就不会输出脉冲。</li><li>编号8 是一个脉冲信号，就是产生事件的线路最终的产物，这个脉冲信号可以给其他外设电路使 用，比如定时器TIM、模拟数字转换器ADC 等等。</li></ul></li><li><p>产生中断线路目的是把输入信号输入到 NVIC，进一步会运行中断服务函数实现功能，这样是 软件级的。</p></li><li><p>而产生事件线路目的就是传输一个脉冲信号给其他外设使用，并且是电路级别的信号 传输，属于硬件级的。</p></li><li><p><strong>另外，EXTI 是在 APB2 总线上的，在编程时候需要注意到这点。</strong></p></li></ul><h3 id="中断-事件线" tabindex="-1"><a class="header-anchor" href="#中断-事件线" aria-hidden="true">#</a> 中断/事件线</h3><p>EXTI 有23 个中断/事件线，每个 GPIO 都可以被设置为输入线，占用EXTI0 至EXTI15，还有另 外七根用于特定的外设事件，见表EXTI 中断/事件线。 七根特定外设中断/事件线由外设触发，具体用法参考《STM32F4xx 中文参考手册》中对外设的 具体说明。</p><p><strong>EXTI 中断/事件线</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220925012026132.png" alt="image-20220925012026132" style="zoom:25%;"><ul><li>EXTI0 至 EXTI15 用于GPIO，通过编程控制可以实现任意一个GPIO 作为EXTI 的输入源。由上 表可知，<strong>EXTI0 可以通过SYSCFG 外部中断配置寄存器1(SYSCFG_EXTICR1) 的EXTI0[3:0] 位选 择配置为PA0、PB0、PC0、PD0、PE0、PF0、PG0、PH0 或者PI0，见图EXTI0 输入源选择。其 他 EXTI 线 (EXTI 中断/事件线) 使用配置都是类似的。</strong><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/image-20220925012204637.png" alt="image-20220925012204637" style="zoom:33%;"></li></ul></li></ul><h3 id="exti-初始化结构体详解" tabindex="-1"><a class="header-anchor" href="#exti-初始化结构体详解" aria-hidden="true">#</a> EXTI 初始化结构体详解</h3><p>标准库函数对每个外设都建立初始化结构体，比如 <code>EXTI_InitTypeDef</code>，结构体成员用于设置外设工作参数，并且由外设初始化配置函数，比如 <code>EXTI_Init()</code> 调用，这些设定参数将会设置外设相应的寄存器，达到配置外设工作环境的目的。</p><p>初始化结构体和初始化函数配合使用的是标准库精髓所在，理解初始化结构体成员意义基本就可以对该外设运用自如了，初始化结构体定义在 <code>stm32f4xx.h</code> 文件中，初始化库函数定义在 <code>stm32fxx_exti.c</code> 中，编程时我们可以结合这两个文件内的注释使用。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> EXTI_Line<span class="token punctuation">;</span>
  EXTIMODE_Typedef EXTI_Mode<span class="token punctuation">;</span>
  EXTITrigger_TypeDef EXTI_Trigger<span class="token punctuation">;</span>   <span class="token comment">// 触发事件</span>
  FunctionalState EXTI_LineCmd<span class="token punctuation">;</span>       <span class="token comment">// EXTI 控制</span>
<span class="token punctuation">}</span> EXTI_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>EXTI_Line</code> ：EXTI 中断/事件线选择，可选EXTI0 至EXTI22，可参考上图选择。</li><li><code>EXTI_Mode</code> ：EXTI 模式选择，可选为产生中断 (EXTI_Mode_Interrupt) 或者产生事件 (EXTI_Mode_Event)。</li><li><code>EXTI_Trigger</code> ：EXTI 边沿触发事件，可选上升沿触发 (EXTI_Trigger_Rising)、下降沿触发 (EXTI_Trigger_Falling) 或者上升沿和下降沿都触发( EXTI_Trigger_Rising_Falling)。</li><li><code>EXTI_LineCmd</code> ：控制是否使能EXTI 线，可选使能 EXTI 线 (ENABLE) 或禁用(DISABLE)。</li></ul><h3 id="外部中断控制实验" tabindex="-1"><a class="header-anchor" href="#外部中断控制实验" aria-hidden="true">#</a> 外部中断控制实验</h3><ul><li><p>中断在嵌入式应用中占有非常重要的地位，几乎每个控制器都有中断功能。中断对保证紧急事件 得到第一时间处理是非常重要的。</p></li><li><p>我们设计使用外接的按键来作为触发源，使得控制器产生中断，并在中断服务函数中实现控制 RGB 彩灯的任务。</p></li></ul><h3 id="硬件设计-1" tabindex="-1"><a class="header-anchor" href="#硬件设计-1" aria-hidden="true">#</a> 硬件设计</h3><ul><li>轻触按键在按下时会使得引脚接通，通过电路设计可以使得按下时产生电平变化。</li></ul><h3 id="软件设计-1" tabindex="-1"><a class="header-anchor" href="#软件设计-1" aria-hidden="true">#</a> 软件设计</h3><ul><li>我们创建了两个文件：bsp_exti.c 和 bsp_exti.h 文件用来存放 EXTI 驱动程序及相关宏定义，中断服务函数放在stm32f4xx_it.h 文件中。</li></ul><h3 id="编程要点-1" tabindex="-1"><a class="header-anchor" href="#编程要点-1" aria-hidden="true">#</a> 编程要点</h3><ol><li>初始化 LED 的 GPIO</li><li>开始按键 GPIO 时钟 和 SYSCFG 时钟</li><li>配置 NVIC</li><li>配置按键 GPIO 为输入模式</li><li>将案件 GPIO 连接到 EXTI 源输入</li><li>配置按键 EXTI 中断。事件栈</li><li>编写 EXTI 中断服务函数</li></ol><p><code>bsp_exti.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_EXTI_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_EXTI_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_exti.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;misc.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_GPIO_PORT</span> 	   		  <span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_GPIO_CLK</span> 	  			<span class="token expression">RCC_AHB1Periph_GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_GPIO_PIN</span>  					<span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_EXTI_PORTSOURCE</span> 		<span class="token expression">EXTI_PortSourceGPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_EXTI_PINSOURCE</span>		  <span class="token expression">EXTI_PinSource0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_EXTI_LINE</span>					<span class="token expression">EXTI_Line0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_INT_EXTI_IRQ</span>						<span class="token expression">EXTI0_IRQn</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_IRQHandler</span>							<span class="token expression">EXTI0_IRQHandler</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_GPIO_PORT</span> 	   		  <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_GPIO_CLK</span> 	  			<span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_GPIO_PIN</span>  					<span class="token expression">GPIO_Pin_2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_EXTI_PORTSOURCE</span> 		<span class="token expression">EXTI_PortSourceGPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_EXTI_PINSOURCE</span>		  <span class="token expression">EXTI_PinSource2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_EXTI_LINE</span>					<span class="token expression">EXTI_Line2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_INT_EXTI_IRQ</span>						<span class="token expression">EXTI2_IRQn</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_IRQHandler</span>							<span class="token expression">EXTI2_IRQHandler</span></span>
<span class="token comment">/*使用宏定义方法指定与电路设计相关配置，这对于程序移植或升级非常有用的。*/</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">EXTI_Key_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_exti.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_exti.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
	
	<span class="token comment">//配置 NVIC 为优先级组 1</span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置KEY2中断源</span>
	<span class="token comment">//配置 EXTI(中断/事件线) 1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> KEY1_INT_EXTI_IRQ<span class="token punctuation">;</span>
	
	<span class="token comment">//配置抢占优先级：1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//配置子优先级：1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">//使能中断通道</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置KEY2中断源</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> KEY2_INT_EXTI_IRQ<span class="token punctuation">;</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">EXTI_Key_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	EXTI_InitTypeDef EXTI_InitStructure<span class="token punctuation">;</span>
	
	<span class="token comment">//开启按键 GPIO 时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>KEY1_INT_GPIO_CLK <span class="token operator">|</span> KEY2_INT_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//开启 SYSCFG 时钟（挂载在 APB2 总线），使用 GPIO 外部中断时必须使能 SYSCFG 时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_SYSCFG<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置 NVIC</span>
	<span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//选择按键 1 的引脚</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> KEY1_INT_GPIO_PIN<span class="token punctuation">;</span>
	<span class="token comment">//设置引脚为输入模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN<span class="token punctuation">;</span>
	<span class="token comment">//设置引脚不上拉也不下拉</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>
	<span class="token comment">//初始化 GPIO</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>KEY1_INT_GPIO_PORT<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//连接 EXTI 中断源 到GPIOA-KEY1引脚</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>KEY1_INT_EXTI_PORTSOURCE<span class="token punctuation">,</span>KEY1_INT_EXTI_PINSOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//选择 EXTI 中断源</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Line <span class="token operator">=</span> KEY1_INT_EXTI_LINE<span class="token punctuation">;</span>
	<span class="token comment">//中断模式</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Mode <span class="token operator">=</span> EXTI_Mode_Interrupt<span class="token punctuation">;</span>
	<span class="token comment">//上升沿触发</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Trigger <span class="token operator">=</span> EXTI_Trigger_Falling<span class="token punctuation">;</span>
	<span class="token comment">//使能 中断/事件 线</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_LineCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	<span class="token comment">//初始化 EXTI</span>
	<span class="token function">EXTI_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EXTI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//选择按键 2 的引脚</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> KEY2_INT_GPIO_PIN<span class="token punctuation">;</span>
	<span class="token comment">//设置引脚为输入模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN<span class="token punctuation">;</span>
	<span class="token comment">//KEY2 低电平有效，所以需要默认上拉</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	<span class="token comment">//初始化 GPIO</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>KEY2_INT_GPIO_PORT<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//连接 EXTI 中断源 到GPIOA-KEY2引脚</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>KEY2_INT_EXTI_PORTSOURCE<span class="token punctuation">,</span>KEY2_INT_EXTI_PINSOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//选择 EXTI 中断源</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Line <span class="token operator">=</span> KEY2_INT_EXTI_LINE<span class="token punctuation">;</span>
	<span class="token comment">//中断模式</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Mode <span class="token operator">=</span> EXTI_Mode_Interrupt<span class="token punctuation">;</span>
	<span class="token comment">//下降沿触发</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_Trigger <span class="token operator">=</span> EXTI_Trigger_Falling<span class="token punctuation">;</span>
	<span class="token comment">//使能 中断/事件 线</span>
	EXTI_InitStructure<span class="token punctuation">.</span>EXTI_LineCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	<span class="token comment">//初始化 EXTI</span>
	<span class="token function">EXTI_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EXTI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>``</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_exti.h&quot;</span></span>

<span class="token comment">//中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">KEY1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//确保产生了 EXTI Line 中断</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">EXTI_GetITStatus</span><span class="token punctuation">(</span>KEY1_INT_EXTI_LINE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_ToggleBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//清除中断标志位</span>
	<span class="token function">EXTI_ClearITPendingBit</span><span class="token punctuation">(</span>KEY1_INT_EXTI_LINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">KEY2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//确保产生了 EXTI Line 中断</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">EXTI_GetITStatus</span><span class="token punctuation">(</span>KEY2_INT_EXTI_LINE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_ToggleBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//清除中断标志位</span>
	<span class="token function">EXTI_ClearITPendingBit</span><span class="token punctuation">(</span>KEY2_INT_EXTI_LINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_exti.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//LED GPIO 端口初始化</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	初始化 EXTI 中断，按下按键会触发中断
	触发中断会进入 stm32f4xx_it.c 文件中的函数
	KEY1_IRQHandler 和 KEY2_IRQHandler，处理中断，反转 LED    灯。
	*/</span>
	<span class="token function">EXTI_Key_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>首先，使用 GPIO_InitTypeDef 和 EXTI_InitTypeDef 结构体定义两个用于 GPIO 和 EXTI 初始化配 置的变量，关于这两个结构体前面都已经做了详细的讲解。</p></li><li><p>使用GPIO 之前必须开启GPIO 端口的时钟；用到EXTI 必须开启SYSCFG 时钟。</p></li><li><p>调用NVIC_Conﬁguration 函数完成对按键1、按键2 优先级配置并使能中断通道。 作为中断/时间输入线把GPIO 配置为输入模式，这里PA0不使用上拉或下拉，有外部电路完全决定引脚的状态。</p></li><li><p>SYSCFG_EXTILineConﬁg 函数用来指定中断/事件线的输入源，它实际是设定 SYSCFG 外部中断 配置寄存器的值，该函数接收两个参数，第一个参数指定GPIO 端口源，第二个参数为选择对应 GPIO 引脚源编号。</p></li><li><p>我们的目的是产生中断，执行中断服务函数，EXTI 选择中断模式，按键1 使用下降沿触发方式， 并使能EXTI 线。按键2 基本上采用与按键 1 相关参数配置，只是改为上升沿触发方式。</p></li><li><p>当中断发生时，对应的中断服务函数就会被执行，我们可以在中断服务函数实现一些控制。 一般为确保中断确实发生，我们会在中断服务函数调用中断标志位状态读取函数读取外设中断 标志位并判断标志位状态。</p></li><li><p>EXTI_GetITStatus 函数用来获取 EXTI 的中断标志位状态，如果 EXTI 线有中断发生函数返回 “SET”否则返回“RESET”。实际上，EXTI_GetITStatus 函数是通过读取 EXTI_PR 寄存器值来判 断 EXTI 线状态的。</p></li><li><p>按键1 的中断服务函数我们让LED1 翻转其状态，按键2 的中断服务函数我们让LED2 翻转其状 态。执行任务后需要调用EXTI_ClearITPendingBit 函数清除EXTI 线的中断标志位</p></li><li><p>主函数非常简单，只有两个任务函数。LED_GPIO_Conﬁg 函数定义在bsp_led.c 文件内，完成LED 的GPIO 初始化配置。EXTI_Key_Conﬁg 函数完成两个按键的GPIO 和 EXTI 配置。</p></li></ul><h2 id="systick-系统定时器" tabindex="-1"><a class="header-anchor" href="#systick-系统定时器" aria-hidden="true">#</a> SysTick 系统定时器</h2><p>本章参考资料《ARM Cortex™-M4F 技术参考手册》-4.5 章节 SysTickTimer(STK)，和 4.48 章节 SHPRx，其中STK 这个章节有SysTick 的简介和寄存器的详细描述。因为SysTick 是属于CM4 内 核的外设，有关寄存器的定义和部分库函数都在core_cm4.h 这个头文件中实现。所以学习SysTick 的时候可以参考这两个资料，一个是文档，一个是源码。</p><h3 id="systick-简介" tabindex="-1"><a class="header-anchor" href="#systick-简介" aria-hidden="true">#</a> SysTick 简介</h3><p>SysTick 系统定时器输入 CM4 内核的一个外设，内嵌在 NVIC 中。系统定时器是一个 <strong>向下递减的24bit 计数器</strong>，计数器每计数一次的时间 为1/SYSCLK，一般我们设置系统时钟为168M。当重装载数值寄存器的值递减到 0 的时候，系统定时器就产生一次中断，以此循环往复。</p><p>因为SysTick 是属于CM4 内核的外设，所以所有基于CM4 内核的单片机都具有这个系统定时器， 使得软件在CM4 单片机中可以很容易的移植。系统定时器一般用于操作系统，用于产生时基，维 持操作系统的心跳。</p><h3 id="systick-寄存器介绍" tabindex="-1"><a class="header-anchor" href="#systick-寄存器介绍" aria-hidden="true">#</a> SysTick 寄存器介绍</h3><p>SysTick—系统定时有4 个寄存器，简要介绍如下。在使用SysTick 产生定时的时候，只需要配置 前三个寄存器，最后一个校准寄存器不需要使用。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271909786.png" alt="image-20220927190944127"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271910723.png" alt="image-20220927191011672"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271910227.png" alt="image-20220927191032178"></p><p>系统定时器的校准数值寄存器在定时实验中不需要用到。老师说：“有关各个位的描述这里引用手册里面的英文版本，比较晦涩难懂，暂时不知道这个寄存器用来干什么”。</p><h3 id="systick-定时器实验" tabindex="-1"><a class="header-anchor" href="#systick-定时器实验" aria-hidden="true">#</a> SysTick 定时器实验</h3><p>利用SysTick 产生1s 的时基，LED 以 1s 的频率闪烁。</p><p><strong>步骤</strong></p><ol><li>设置重装载寄存器的值</li><li>清除当前数值寄存器的值</li><li>配置控制与状态寄存器</li></ol><p>SysTick 属于内核的外设，有关的寄存器定义和库函数都在内核相关的库文件core_cm4.h 中。</p><p><strong>SysTick 配置库函数</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>__STATIC_INLINE <span class="token class-name">uint32_t</span> <span class="token function">SysTick_Config</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> ticks<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 不可能的重装载值，超出范围</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ticks <span class="token operator">-</span> <span class="token number">1UL</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> SysTick_LOAD_RELOAD_Msk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">1UL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token comment">// 设置重装载寄存器</span>
	SysTick<span class="token operator">-&gt;</span>LOAD <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ticks <span class="token operator">-</span> <span class="token number">1UL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">// 设置中断优先级</span>
	<span class="token function">NVIC_SetPriority</span> <span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> __NVIC_PRIO_BITS<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1UL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 设置当前数值寄存器 </span>
	SysTick<span class="token operator">-&gt;</span>VAL <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>
	<span class="token comment">// 设置系统定时器的时钟源为 AHBCLK=168M </span>
	<span class="token comment">// 使能系统定时器中断</span>
	<span class="token comment">// 使能定时器</span>
	SysTick<span class="token operator">-&gt;</span>CTRL <span class="token operator">=</span> SysTick_CTRL_CLKSOURCE_Msk <span class="token operator">|</span>
									SysTick_CTRL_TICKINT_Msk   <span class="token operator">|</span> 
									SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0UL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>用固件库编程的时候我们只需要调用库函数 SysTick_Conﬁg() 即可，形参 ticks 用来设置重装载寄 存器的值，最大不能超过重装载寄存器的值2^24，当重装载寄存器的值递减到0 的时候产生中断， 然后重装载寄存器的值又重新装载往下递减计数，以此循环往复。紧随其后设置好中断优先级， 最后配置系统定时器的时钟为 168M，使能定时器和定时器中断，这样系统定时器就配置好了， 一个库函数搞定。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>__STATIC_INLINE <span class="token keyword">void</span> <span class="token function">NVIC_SetPriority</span><span class="token punctuation">(</span>IRQn_Type IRQn<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> priority<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span>IRQn <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		 SCB<span class="token operator">-&gt;</span>SHP<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span>IRQn<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFUL</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">4UL</span><span class="token punctuation">]</span> <span class="token operator">=</span>
		<span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>priority <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> __NVIC_PRIO_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFFUL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		NVIC<span class="token operator">-&gt;</span>IP<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span><span class="token punctuation">)</span>IRQn<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span>
		<span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>priority <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> __NVIC_PRIO_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0xFFUL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>SysTick_Conﬁg() 库函数主要配置了 SysTick 中的三个寄存器：LOAD、VAL 和 CTRL，有关具体 的部分看代码注释即可。其中还调用了固件库函数 NVIC_SetPriority() 来配置系统定时器的中断 优先级，该库函数也在core_m4.h 中定义。</li></ul><p><strong>因为 SysTick 属于内核外设，跟普通外设的中断优先级有些区别</strong>，并没有抢占优先级和子优先 级的说法。在 STM32F407 中，内核外设的中断优先级由内核 SCB 这个外设的寄存器：SHPRx （x=1.2.3）来配置。有关SHPRx 寄存器的详细描述可参考《Cortex-M4 内核编程手册》4.4.8 章节。 下面我们简单介绍下这个寄存器。</p><p><strong>SPRH1～SPRH3 是一个32 位的寄存器，但是只能通过字节访问，每8 个字段控制着一个内核外设</strong><strong>的中断优先级的配置</strong>。在STM32F407 中，只有位7:4 这高四位有效，低四位没有用到，所以内核 外设的中断优先级可编程为：0~15，只有 16 个可编程优先级，数值越小，优先级越高。如果软 件优先级配置相同，那就根据他们在中断向量表里面的位置编号来决定优先级大小，编号越小， 优先级越高。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271932087.png" alt="image-20220927193222983"></p><p>如果要修改内核外设的优先级，只需要修改下面三个寄存器对应的某个字段即可。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271933055.png" alt="image-20220927193332997"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209271934173.png" alt="image-20220927193408114"></p><p>​</p><p>在系统定时器中，配置优先级为</p><ul><li><code>NVIC_SetPriority (SysTick_IRQn, (1UL &lt;&lt; __NVIC_PRIO_BITS) - 1UL);</code></li><li>其中宏__NVIC_PRIO_BITS 为 4，那计算结果就等于 15，可以看出系统定时器此时设置的优先级在内核外设中是最低的。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_EXTI_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_EXTI_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>

<span class="token keyword">static</span> __IO <span class="token class-name">uint32_t</span> TimingDelay<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Delay_ms</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> nTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Delay_10us</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> nTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TimingDelay_Decrement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">/* SystemFrequency / 1       1s       中断一次 */</span> 
	<span class="token comment">/* SystemFrequency / 10      100ms    中断一次 */</span>
	<span class="token comment">/* SystemFrequency / 100   	 10ms     中断一次 */</span>
	<span class="token comment">/* SystemFrequency / 1000    1ms      中断一次 */</span> 
	<span class="token comment">/* SystemFrequency / 10000   100us    中断一次 */</span>
	<span class="token comment">/* SystemFrequency / 100000  10us     中断一次 */</span>
	<span class="token comment">/* SystemFrequency / 1000000 1us      中断一次 */</span>
	
	<span class="token comment">// SystemCoreClock = 168M</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">SysTick_Config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//返回 1 表示初始化失败</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Delay_ms</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> nTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">uint16_t</span> count <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
	TimingDelay <span class="token operator">=</span> nTime<span class="token punctuation">;</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span>count <span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>TimingDelay <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			TimingDelay <span class="token operator">=</span> nTime<span class="token punctuation">;</span>
			count<span class="token operator">--</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Delay_10us</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> nTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
	TimingDelay <span class="token operator">=</span> nTime<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>TimingDelay <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">TimingDelay_Decrement</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>TimingDelay<span class="token operator">!=</span><span class="token number">0x00</span><span class="token punctuation">)</span> TimingDelay<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">Delay</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> i<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//HSE_SetSysClock(8, 432, 2, 7);</span>
	<span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay_10us</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay_10us</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>更简洁的方法</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">SysTick_Delay_Us</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> us<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">SysTick_Config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//当计数器的值减小到0，CTRL寄存器的16位会置1</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">&amp;=</span><span class="token operator">~</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SysTick_Delay_Ms</span><span class="token punctuation">(</span>__IO <span class="token class-name">uint32_t</span> ms<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">SysTick_Config</span><span class="token punctuation">(</span>SystemCoreClock <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ms<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//当计数器的值减小到0，CTRL寄存器的16位会置1</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SysTick<span class="token operator">-&gt;</span>CTRL<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	SysTick<span class="token operator">-&gt;</span>CTRL<span class="token operator">&amp;=</span><span class="token operator">~</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>直接调用即可，无需再另外初始化定时器</li></ul><h2 id="通讯的基本概念" tabindex="-1"><a class="header-anchor" href="#通讯的基本概念" aria-hidden="true">#</a> 通讯的基本概念</h2><p>在计算机设备与设备之间或集成电路之间常常需要进行数据传输，在本书后面的章节我们会学习到各种各样的通信方式，所以本章我们先统一了解一下这些通讯的基本概念。</p><h3 id="串行通讯与并行通行" tabindex="-1"><a class="header-anchor" href="#串行通讯与并行通行" aria-hidden="true">#</a> 串行通讯与并行通行</h3><p><strong>按数据传送的方式</strong>，通讯可分为<strong>串行通讯</strong>和<strong>并行通讯</strong></p><ul><li><p><strong>串行通讯</strong>：是指设备之间通过少量数据信号线（一般8根以下）、地线 以及 控制信号线，按数据位形式一位一位地传输数据的通讯方式。串行通讯就像单个车道的公路，同一时刻只能传输一个数据位的数据。</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281619016.png" alt="image-20220928161910923" style="zoom:25%;"></li></ul></li><li><p><strong>并行通讯</strong>：一般是指使用8、16、32、64根或更多的数据线进行数据传输的通讯方式。并行通讯就像多个车道的公路，可以同时传输多个数据位的数据。</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281619432.png" alt="image-20220928161930380" style="zoom:25%;"></li></ul></li></ul><p><strong>串行通讯和并行通讯的特性对比</strong></p><ul><li><p><strong>并行通信</strong>：因为一次可以传输多个数据位的数据，在数据传输速率相同的情况下，<strong>并行通讯传输的数据量要大得多</strong></p></li><li><p><strong>串行通信</strong>：<strong>串行通信则可以节省数据线的硬件成本</strong>（特别远距离时）以及PCB的布线面积</p></li><li><table><thead><tr><th style="text-align:center;">特性</th><th style="text-align:center;">串行通讯</th><th style="text-align:center;">并行通讯</th></tr></thead><tbody><tr><td style="text-align:center;">通讯距离</td><td style="text-align:center;">较远</td><td style="text-align:center;">较近</td></tr><tr><td style="text-align:center;">抗干扰能力</td><td style="text-align:center;">较强</td><td style="text-align:center;">较弱</td></tr><tr><td style="text-align:center;">传输速率</td><td style="text-align:center;">较慢</td><td style="text-align:center;">较高</td></tr><tr><td style="text-align:center;">成本</td><td style="text-align:center;">较低</td><td style="text-align:center;">较高</td></tr></tbody></table></li><li><p>不过由于<strong>并行传输对同步要求较高</strong>，且随着通讯速率的提高，<strong>信号干扰的问题会显著影响通讯性能</strong>，<strong>现在随着技术的发展，越来越多的应用场合采用高速率的串行差分传输</strong>。</p></li></ul><h3 id="全双工、半双工及单工通讯" tabindex="-1"><a class="header-anchor" href="#全双工、半双工及单工通讯" aria-hidden="true">#</a> 全双工、半双工及单工通讯</h3><p><strong>根据数据通讯方向</strong>，通讯又分为 <strong>全双工、半双工、单工</strong> 通讯，它们主要以信道的方向来区分。</p><table><thead><tr><th>通讯方式</th><th>说明</th></tr></thead><tbody><tr><td>全双工</td><td>在同一时刻，两个设备之间可以同时收发数据</td></tr><tr><td>半双工</td><td>两个设备之间可以收发数据，但不能在同一时刻（错开）</td></tr><tr><td>单工</td><td>在任何时刻只能进行一个方向的的通讯，即一个固定为发送设备，另一个固定为接收设备。</td></tr></tbody></table><ul><li><p><strong>全双工</strong>：就像一个双向车道，两个方向上的车流互不相干</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281642314.png" alt="image-20220928164205263" style="zoom:25%;"></li></ul></li><li><p><strong>半双工</strong>：就像乡间小道那样，同一时刻只能让一辆小车通过，另一个方向的来车只能等待道路空出来时才能通过</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281642710.png" alt="image-20220928164227624" style="zoom:25%;"></li></ul></li><li><p><strong>单工</strong>：就像单向车道，另一方向的车辆完全禁止通行。</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281642149.png" alt="image-20220928164241097" style="zoom:25%;"></li></ul></li></ul><h3 id="同步通讯和异步通讯" tabindex="-1"><a class="header-anchor" href="#同步通讯和异步通讯" aria-hidden="true">#</a> 同步通讯和异步通讯</h3><p><strong>根据通讯的数据同步方式</strong>，又分为<strong>同步和异步</strong>两种，可以<strong>根据通讯过程中是否使用到时钟信号进行简单的区分</strong>。</p><ul><li><p><strong>同步通讯：<strong>中，收发</strong>设备双方会使用一根信号线表示时钟信号</strong>，在时钟信号的驱动下双方进行协调，同步数据。<strong>通常通讯双方会统一规定在时钟信号的上升沿或下降沿对数据线进行采样</strong>。</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281701340.png" alt="image-20220928170122282" style="zoom:33%;"></li></ul></li><li><p>**异步通讯：**中，不使用时钟信号进行数据同步，它们直接在数据数据信号中穿插一些同步用的信号位，或者把主体数据进行打包，以数据帧的格式传输数据。某些通讯中还需要双方约定数据的传输速率，以便更好地同步。</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281705841.png" alt="image-20220928170502718" style="zoom:33%;"></li></ul></li><li><p>在<strong>同步通讯</strong>中，数据信号所传输的内容绝大部分就是有效数据</p></li><li><p>在<strong>异步通讯</strong>中，会包含有帧的各种标识符。</p></li><li><p>但是<strong>同步通讯双方时钟允许误差较小</strong>，而<strong>异步通讯双方的时钟允许误差较大</strong>。</p></li></ul><h3 id="通讯速率" tabindex="-1"><a class="header-anchor" href="#通讯速率" aria-hidden="true">#</a> 通讯速率</h3><p><strong>衡量通讯性能的一个非常重要的参数就是通讯速率</strong>，<strong>通常以比特率(Bitrate)来表示</strong>，即<strong>每秒传输的二进制位数</strong>，单位为比特每秒(bit/s)。</p><p><strong>容易和比特率混淆的概念 波特率(Baudrate)</strong></p><ul><li><p>**比特率(Bitrate)：**每秒传输的二进制位数，单位为比特每秒(bit/s)</p></li><li><p>**波特率(Baudrate)：**表示每秒传输了多少个码元。</p><ul><li><p><strong>码元</strong>：<strong>码元是通讯信号调制的概念</strong>，通讯中常用时间间隔相同的符号来表示一位二进制数字，这样的信号称为码元。</p><p>如常见的通讯传输中，用 0V 来表示数字0，5V 表示数字1，那么一个码元就可以表示 0 和 1 两种状态，所以一个码元等于一个二进制比特位，此时波特率的大小与比特率一致。</p><p>如果在通讯传输中，有 0V、2V、4V、6V 分别表示二进制数 00、01、10、11，那么每个码元可以表示四种状态，即两个两个二进制比特位，所以码元数是二进制比特位的一半（1码元 = 2个二进制数）。</p><p>因为很多常见的通讯中一个码元都是表示两种状态，人们常常直接以波特率来表示比特率，虽然严格来说没什么问题，但还是要了解一下，以免闹笑话😂。</p></li></ul></li></ul><h2 id="usart—串口通讯" tabindex="-1"><a class="header-anchor" href="#usart—串口通讯" aria-hidden="true">#</a> USART—串口通讯</h2><p>本章参考资料：《STM32F4xx 中文参考手册》USART 章节。</p><p>学习本章时，配合《STM32F4xx 中文参考手册》USART 章节一起阅读，效果会更佳，特别是涉 及到寄存器说明的部分。</p><p>特别说明，本书内容是以STM32F4xxx 系列控制器资源讲解。</p><h3 id="串口通讯协议简介" tabindex="-1"><a class="header-anchor" href="#串口通讯协议简介" aria-hidden="true">#</a> 串口通讯协议简介</h3><p>串口通讯(Serial Communication) 是一种设备间非常常用的串行通讯方式，因为它简单便捷，大部分电子设备都支持该通讯方式，电子工程师在调试设备时也经常使用该通讯方式输出调试信息。</p><p><strong>在计算机科学中，大部分复杂的问题都可以通过分层来简化</strong>。如芯片被分为内核层 和 片上外设。STM32 标准库则是在寄存器与用户代码之间的软件层。对于通讯协议，我们也以分层的方式来理解。最基本的就是把它分为<strong>物理层和协议层</strong>。</p><ul><li>**物理层：**物理层规定通讯系统中具有机械、电子功能的部分特性，确保原始数据在物理媒体的传输。</li><li>**协议层：**协议层主要规定通讯逻辑，统一收发双方数据的大包、解包的标准。</li><li><strong>简单来说，物理层规定我们用嘴巴还是肢体交流，协议层规定我们用中文还是英文来交流。</strong></li></ul><h4 id="物理层" tabindex="-1"><a class="header-anchor" href="#物理层" aria-hidden="true">#</a> 物理层</h4><p>串口通讯的物理层有很多标准及变种，我们主要讲解 RS-232 标准，RS-232 标准主要规定了信号的用途，通讯接口及信号的电平标准。</p><p><strong>常见的 RS-232标准串口的设备间 的通讯结构图</strong></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281818462.png" alt="image-20220928181807364"></p><ul><li>在上面通讯方式中，两个通讯设备的 “<strong>DB9接口</strong>” 之间通过串口信号线建立起连接，串口信号线中传输 “<strong>RS-232 标准</strong>” 数据信号。</li><li>由于 <strong>RS-232</strong> 电平标准的信号不能被控制器直接识别，所以这些信号会经过一个 “<strong>电平转换芯片</strong>” 转换成控制器能识别的 “<strong>TTL 标准</strong>” 的电平信号，才能实现通讯。</li></ul><p><strong>电平标准</strong></p><p>根据通讯使用的电平标准不同，串口通讯可以分为 TTL标准 及 RS-232标准。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281826074.png" alt="image-20220928182656018" style="zoom:33%;"><ul><li>我们知道常见的电子电路中常使用 TTL电平标准 ，理想状态下，使用 5V 表示二进制逻辑 1，使用 0V 表示逻辑 0</li><li>而 RS-232电平标准 为了增加串口通讯的远距离传输及抗干扰能力，它使用 -15V 表示逻辑 1，+15V表示逻辑 0</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281831801.png" alt="image-20220928183117739" style="zoom:33%;"><ul><li>因为控制器一般使用 TTL电平标准，所以常常会使用 MA3232芯片 对 TTL 和 RS-232 电平的信号进行互相转换。</li></ul><p><strong>RS-232 信号线</strong></p><p>在最初的应用中，RS-232串口标准常用于计算机、路由器 与 调制解调器(MODEN，俗称 “猫”) 之间的通讯，在这种通讯系统中，设备被分为 <strong>数据终端设备(DTE)</strong> (计算机、路由器) 和<strong>数据通讯设备(DCE)</strong> （调制解调器）。我们以这种通讯模型了解它们的信号线连接方式及各个信号线的作用。</p><p><strong>在旧式的台式计算机中一般会有 RS-232标准的COM 口（也称DB9接口）</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281853374.png" alt="image-20220928185352323" style="zoom:40%;"><ul><li><strong>公头</strong>：以针式引出的信号线称为公头。</li><li><strong>母头</strong>：以孔式引出的信号线称为母头。</li><li>在计算机中一般引出公头接口，而在调制解调器设备中引出的一般为母头。通过串口线连接起来。</li><li>通讯时，串口线中传输的信号就是使用前面了解到的 RS-232标准调制的。</li></ul><p><strong>DB9信号线说明</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281914565.png" alt="image-20220928191402512" style="zoom:40%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209281943783.png" alt="image-20220928194326706" style="zoom:40%;"><ul><li>上表中的是计算机端的DB9公头标准接法，由于两个通讯设备之间的收发信号(RXD 与 TXD)应交叉相连，所以调制解调器端的 DB9 母头的收发信号接法一般与公头的相反</li><li>两个设备纸巾啊连接时，只要使用 “直通型” 的串口线连接起来即可</li><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209282013694.png" alt="image-20220928201321639" style="zoom:33%;"></li><li>串口线中的 RTS、CTS、DSR、DCD 信号，使用逻辑 1 表示信号有效，逻辑 0 表示信号无效。例如，当计算机端控制 DTR 信号线表示为逻辑 1时，它是为了告知远端的调制解调器，本机已准备好接受数据， 0 则表示还没准备就绪。</li><li><strong>在目前的其它工业控制使用的串口通讯中，一般只使用RXD、TXD、GND 三条信号线</strong>，直接传输数据信号。而 RTS、CTS、DSR、DTR、DCD 信号都被裁剪掉了，如果被前面这些信号弄得晕头转向，那就忽略它们吧！</li></ul><h4 id="协议层" tabindex="-1"><a class="header-anchor" href="#协议层" aria-hidden="true">#</a> 协议层</h4><p>串口通讯数据包由发送设备通过自身的 TXD接口 传输到接收设备的 RXD接口。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209282027858.png" alt="image-20220928202723728"></p><ul><li>在<strong>串口通讯的协议层中，规定了数据包的内容，它由起始位、主体数据、校验位 以及 停止位组成</strong>，通讯双方的<strong>数据包格式要约定一致才能正常收发数据</strong>。</li></ul><p><strong>波特率</strong></p><p>本章主要了解的是串口异步通讯，异步通讯中由于没有时钟信号（如前面了解的DB9接口中是没有时钟信号的），所以<strong>两个通讯设备之间需要约定好波特率，即每个码元的长度，以便对信号进行解码</strong>。</p><p>上图中虚线分开的每一个就是代表一个码元，常见的波特率为 4800、9600、115200 等。</p><p><strong>通讯的起始和停止信号</strong></p><p>串口通讯的一个数据包从起始信号开始，直到停止信号结束。数据包的起始信号由一个逻辑 0 的数据位表示，而数据包的停止信号可由 0.5、1、1.5 或 2个逻辑 1 的数据位表示，只要双方约定一致即可</p><p><strong>有效数据</strong></p><p>在数据包的起始位之后紧接着就是<strong>要传输的主体数据内容，也称为有效数据</strong>，有效数据的长度常被约定位 5、6、7 或 8 位长。</p><p><strong>数据校验</strong></p><p>在有效数据之后，有一个可选的数据校验位。由于数据通讯相对更容易受到外部干扰导致传输数据出现偏差，可以在传输过程加上校验位来解决这个问题。校验方法有奇校验(odd)、偶校验(even)、0校验(space)、1校验(mark) 以及 无校验(noparity)。</p><ul><li>**奇校验(odd)：**要求有效数据 + 校验位中 “1” 的个数为奇数。 <ul><li>比如：8位长的有效数据 01101001 ，此时总共有4个 “1” ，为达到奇校验的效果，校验位为 “1” ，最后传输的数据将是8位的有效数据加上1位的校验位总共 9 位。</li></ul></li><li>**偶校验(even)：**与奇校验要求刚好相反，要求帧数据 + 校验位中的 “1” 的个数为偶数。 <ul><li>比如数据帧：11001010 ，此时数据帧 “1” 的个数为4，所以偶校验位为“0”</li></ul></li><li>**0校验(space)：**不管有效数据中的内容是什么，校验位总为 “0”</li><li>**1校验(mark)：**不管有效数据中的内容是什么，校验位总为 “1”</li><li>**无校验：**在无校验的情况下，数据包中不包含校验位校验位。</li></ul><h3 id="stm32-的-usart-简介" tabindex="-1"><a class="header-anchor" href="#stm32-的-usart-简介" aria-hidden="true">#</a> STM32 的 USART 简介</h3><p>STM32具有多个<strong>USART</strong>外设用于串口通讯，它是 <strong>Universal Synchronous Asynchronous Receiver and Transmitter</strong> 的缩写，即<strong>通用同步异步收发器</strong>，可以灵活地与外部设备进行全双工数据交换。</p><p>除了 USART ，它还有 <strong>UART 外设（Universal Asynchronous Receiver and Transmitter，通用异步收发器），它是在USART的急促上裁剪掉了同步通信功能，只有异步通信</strong>。简单区分同步异步就是看通信时<strong>是否需要对外提供时钟输出，我们平时用的串口通信基本都是 UART</strong>。</p><p><strong>USART 满足外部设备对工业标准 NRZ 异步串行数据格式的要求</strong>，并且<strong>使用了小数波特率发生器，可以提供多种波特率</strong>，使得它的应用更加广泛。</p><p><strong>USART 支持同步单向通信和半双工单线通</strong>讯，还<strong>支持局域网互联网络 LIN 、智能卡(Smart Card) 协议 与 IrDa(红外线数据协会) SIR ENDEC 规范</strong>。</p><p>USART 支持使用 DMA，可实现高速数据通信，有关 DMA 具体应用将在 DMA 章节了解。</p><p>USART 在 STM32 应用最多莫过于 “打印” 程序信息，一般在硬件设计时都会预留一个 USART 通信接口连接电脑，用于在调试程序时可以把一些调试信息 “打印” 在电脑端的串口调试助手工具上，从而了解程序运行是否正确、指出运行出错位置信息等等。</p><h3 id="usart-功能框图" tabindex="-1"><a class="header-anchor" href="#usart-功能框图" aria-hidden="true">#</a> USART 功能框图</h3><p>STM32的USART功能框图包含了USART最核心的内容，掌握了功能框图，对USART就有一个整体的把握，在编程时思路就非常清晰。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209290122317.png" alt="image-20220929012253257"></p><h4 id="功能引脚" tabindex="-1"><a class="header-anchor" href="#功能引脚" aria-hidden="true">#</a> 功能引脚</h4><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209290138399.png" alt="image-20220929013800338"></p><ul><li><p><strong>TX</strong>：发送数据输出引脚</p></li><li><p><strong>RX</strong>：接受数据输入引脚</p></li><li><p><strong>SW_RX</strong>：数据接收引脚，只用于单线和智能卡模式，属于内部引脚，没有具体的外部引脚</p></li><li><p><strong>nRTS</strong>：请求以发送数据(Request To Send)，n表示低电平有效。</p><ul><li>如果使能RTS流控制，当USART接收器准备好接收新数据时就会将 nRTS 变成低电平。</li><li>当接受寄存器已满时， nRTS 将被设置为高电平。</li><li>该引脚只适用于硬件流控制。</li></ul></li><li><p><strong>nCTS</strong>：清除以发送(Clear To Send)，n表示低电平有效。</p><ul><li>如果使能 CTS 流控制，发送器在发送下一帧数据之前 会检测 nCTS 引脚，如果为低电平，表示可以发送数据。</li><li>如果为高电平则在发送完当前数据帧之后停止发送。</li><li>该引脚只适用于硬件流控制。</li></ul></li><li><p><strong>SCLK</strong>：发送器时钟输出引脚。这个引脚仅适用于同步模式。</p></li><li><p>STM32F407ZGT6 有4个 USART 和2个 UART，其中 USART1 和 USART6 的时钟来源于 APB2 总线时钟，其最大频率为 84HMz ，其它4个的时钟来源于 APB1 总线时钟，其最大频率为 42MHz。</p></li><li><p>UART 只是异步异步传输功能，所以没有 SCLK、nCTS、nRTS 功能引脚。</p></li><li><p>可发现很多 USART 的功能引脚有多个引脚可选，这非常方便引脚设计，只要在程序编程时软件绑定引脚即可。</p></li></ul><h4 id="数据寄存器" tabindex="-1"><a class="header-anchor" href="#数据寄存器" aria-hidden="true">#</a> 数据寄存器</h4><p>USART 数据寄存器(USART_DR) 只有低 9 位有效，并且第 9 位数据是否有效要取决于 USART 控制寄存器 1(USART_CR1) 的M位设置，当M位为0时表示 8 位数据字长，当 M 位为 1 表示 9 位数据字长，我们一般使用 8 位数据字长。</p><p>USART_DR 包含了 已发送的数据 或者 接收到的数据。USART_DR 实际上包含了两个寄存器，</p><ul><li>一个专门用于发送的可写 TDR。</li><li>一个专门用于接收的可读 RDR。</li><li>当进行发送操作时，往 USART_DR 写入数据会自动存储在 TDR 内。</li><li>当进行读取操作时，像 USART_DR 读取数据会自动提取 RDR 内的数据</li></ul><p>TDR 和 RDR 都是介于系统总线和移位寄存器之间。串行通信是一个位一个位传输的。</p><ul><li>发送时，把 TDR 内容转移到发送移位寄存器，然后把移位寄存器数据的每一位发送出去。</li><li>接受时，把接收到的每一位按顺序保存在接收移位寄存器内，然后才转移到 RDR。</li></ul><p>USART 支持 DMA传输，可以实现高速数据传输，具体 DMA 使用将在 DMA章节了解。</p><h4 id="控制器" tabindex="-1"><a class="header-anchor" href="#控制器" aria-hidden="true">#</a> 控制器</h4><p>USART 有专门控制发送的发送器、控制接收的接收器，还有唤醒单元、中断控制等等。</p><p><strong>使用USART之前 需要向 USART_CR1 寄存器的 UE位 置1 使能USART</strong>。</p><p>发送或接收数据字长可选 8位 或 9位，由 USART_CR1 的 M位控制。</p><p><strong>发送器</strong></p><p>当 USART_CR1寄存器 的发送使能位TE置1时，启动数据发送，发送移位寄存器的数据会在TX引脚输出，如果是同步模式 SCLK 也输出时钟信号。</p><p>一个字符帧发送需要三个部分：</p><ul><li><strong>起始位</strong>：起始位是一个位周期的低电平 <ul><li><strong>位周期</strong>：就是传输一位占用的时间；</li></ul></li><li><strong>数据帧</strong>：数据帧就是我们要发送的 8位或9位 数据，数据从最低位开始传输的。</li><li><strong>停止位</strong>：停止位是一定时间周期的高电平。 <ul><li>停止位的时间长短可以通过 USART 控制器2(USART_CR2) 的 STOP[1:0] 位控制，可选0.5、1、1.5、2 个停止位。</li><li>默认使用1个停止位</li><li>2个停止位适用于正常USART模式、单线模式 和 调制解调器模式。</li><li>0.5 和 1.5 个停止位适用于智能卡模式。</li></ul></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209290213630.png" alt="image-20220929021336571"></p><ol><li>当发送使能位 TE 置1 之后，发送器会发送一个空闲帧（一个数据帧长度的高电平）</li><li>接下来就可以往 USART_DR 寄存器写入要发送的数据</li><li>在写入最后一个数据后，需要等待 USART 状态寄存器(USART_SR) 的TC位为1，表示数据传输完成，如果 USART_CR1 寄存器的 TCIE位 置1,将产生中断。</li></ol><p>在发送数据时，编程的时候有几个比较重要的标志为我们来总结下：</p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>TE</td><td>发送使能</td></tr><tr><td>TXE</td><td>发送寄存器为空，发送单个字节的时候使用</td></tr><tr><td>TC</td><td>发送完成，发送多个字节数据的时候使用</td></tr><tr><td>TXIE</td><td>发送完成中断使能</td></tr></tbody></table><p>串口调试中：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>RS<span class="token operator">-</span><span class="token number">232</span>C接口定义<span class="token punctuation">(</span>DB9<span class="token punctuation">)</span>
引脚 定义 符号
<span class="token number">1</span> 载波检测 DCD（Data Carrier Detect）
<span class="token number">2</span> 接收数据 RXD（Received Data）
<span class="token number">3</span> 发送数据 TXD（Transmit Data）
<span class="token number">4</span> 数据终端准备好 DTR（Data Terminal Ready）
<span class="token number">5</span> 信号地 SG（Signal Ground）
<span class="token number">6</span> 数据准备好 DSR（Data Set Ready）
<span class="token number">7</span> 请求发送 RTS（Request To Send）
<span class="token number">8</span> 清除发送 CTS（Clear To Send）
<span class="token number">9</span> 振铃提示 RI（Ring Indicator）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>接收器</strong></p><ul><li><p>如果将 USART_CR1 寄存器的 RE位 置1，使能 USART 接收，使得接收器在 RX 线开始搜索起始位。</p></li><li><p>在确定到起始位后，根据 RX线 电平状态把数据放在接收移位寄存器内。</p></li><li><p>接收完成后就把接收移位寄存器数据移到 RDR 内，并把 USART_SR 寄存器的 RXNE位 置1，同时如果 USART_CR2 寄存器的 PXNEIE 置1的话就可以产生中断。</p></li></ul><p><strong>在接收数据时，编程的时候有几个比较重要的标志位</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209300124167.png" alt="image-20220930012415057" style="zoom:33%;"><p><strong>为得到一个信号的真实情况，需要用到一个比这个信号频率更高的采样信号去检测 称为过采样</strong>，这个采样信号频率大小决定最后得到的源信号的准确度，一般频率越高得到的准确度越高，但想得到越高的频率的采样信号也越困难，运算和功耗等等也会增加，所以一般选择合适就好。</p><p>接收器可配置为不同的过采样技术，以实现从噪声中提取有效的数据。</p><p><strong>USART_CR1 寄存器的 OVER8位 用来选择不同的采样方法</strong></p><ul><li>如果 OVER8位 设置为1 采用8倍过采样，即用8个采样信号采样一位数据</li><li>如果 OVER8位 位置为0 采用16倍过采样，即用16个采样信号采样一位数据</li></ul><p>USART 的起始位检测需要用到特定序列，如果在 RX线 识别到该特定序列就认为是检测到了起始位。</p><ul><li>起始位检测对使用 16倍 或 8倍 过采样 的 序列都是一样的。</li><li>该特定序列为：1110X0X0X0000，其中X表示电平任意，1 或 0 皆可。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209300204751.png" alt="image-20220930020424688"></p><ul><li>8倍过采样速度更快，最高速度可达 $f_{PCLK}/8$ , $f_{PCLK}$ 为USART时钟</li><li>8倍过采样 使用 4、5、6 次脉冲的值决定该位的电平状态。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209300208627.png" alt="image-20220930020821554"></p><ul><li>16倍过采样速度虽然没有8倍过采样那么快，但得到的数据更加精准，其最大速度为 $f_{PCLK}/16$</li><li>8倍过采样 使用 8、9、10 次脉冲的值决定该位的电平状态。</li></ul><p><strong>过采样，大概意思是多次读取一个位数据的电平，保证数据信号的准确性？</strong></p><h4 id="小数波特率生成" tabindex="-1"><a class="header-anchor" href="#小数波特率生成" aria-hidden="true">#</a> 小数波特率生成</h4><p>波特率指数据信号对载波的调制速率，它用单位时间内载波调制状态改变次数来表示，单位为波特。</p><p><strong>波特率是指单位时间内传输的比特数，单位 bit/s (bps)。</strong></p><p>对于USART，波特率与比特率相等。以后不区分这两个概念，总之波特率越大，传输速率越大。</p><p><strong>USART 的发送器和接收器使用相同的波特率。计算公式为：</strong></p><p>$波特率(Baud Rate) = \Large \frac{f_{PCLK}} {8 \times (2 - OVER8) \times USARTDIV}$</p><ul><li><p>其中，$f_{PCLK}$ 为USART时钟</p></li><li><p>OVER8 为 USART_CR1寄存器 的 OVER8位 对应的值</p></li><li><p>USARTDIV 是一个存放在 波特率寄存器(USARTBRR) 的一个无符号定点数。</p><ul><li>其中 DIV_Mantissa[11:0]位 为 USARTDIV 的整数部分</li><li>DIV_Fraction[3:0]位 为 USARTDIV 的小数部分，</li><li>DIV_Fraction[3] 位 只有在OVER8 位为0 时有效，否则必须清零。</li><li><strong>USARTDIV ： 是对串口外设的时钟源进行分频的</strong></li><li><strong>定点数和浮点数应该是一样的东西</strong></li></ul></li><li><p><strong>例如：</strong></p><ul><li>如果 OVER8 = 0（过采样倍数 = 16），DIV_Mantissa = 24，DIV_Fraction = 10，此时 USART_BRR = 0x18A；那么 USARTDIV 的小数位 = 10 / 16 = 0.625 ；整数位 = 24 ， 最终 USARTDIV 的值 = 24.625</li><li>如果 OVER = 0 并且知道 USARTDIV = 27.68 ，那么 DIV_Fraction = 16 * 0.68 = 10.88 ，最接近的整数为11 ，所以 DIV_Fraction[3:0] = 0xB ；DIV_Mantissa = 27 = 0x1B</li><li><strong>如果 OVER8 = 1 计算方法类似，只是把计算用到的权值由 16 改为 8</strong></li></ul></li><li><p>波特率的常用值有 2400、9600、19200、115200，计算方法如下：</p><ul><li>由表STM32F407ZGT6 芯片的USART 引脚可知USART1 和USART6 使用APB2 总线时钟，最高可 达84MHz，其他USART 的最高频率为42MHz。我们选取USART1 作为实例讲解，即fPLCK=84MHz</li><li>当我们使用 16倍过采样时即 OVER8 = 0 ，为得到 115200bps 的波特率，此时：$115200 = \Large \frac{84000000} {8 \times 2 \times USARTDIV}$</li><li>移项计算：$84000000 \div 16 \div 115200 = USARTDIV = 45.5729167 \approx 45.57$ <ul><li>解得 USARTDIV = 45.57</li><li>可算得 DIV_Fraction = $0.57 \times 16(2^4) = 9.12 \approx 9$ = 0x9 (2^4，在BRR 寄存器中，表示小数位的有 4 位)</li><li>DIV_Mantissa = 45 = 0x2D ,</li><li>则 USART_BRR = 0x2D9 。</li></ul></li></ul></li><li><p>在计算机 DIV_Fraction 会有经常出现小数得情况，经过我们取舍得到整数，这样会导致最终输出的波特率较目标值略有偏差。下面计算 USART_BRR = 0x2D9 时，实际输出的波特率大小：</p><ul><li>由 USART_BRR = 0x2D9</li><li>可得 DIV_Mantissa = 45 ，DIV_Fraction = 9</li><li>USARTDIV = 45 + (9 / 16 = 0.5625) = 45.5625</li><li>BaudRate(实际波特率) = 84000000 / (16 * 45.5625 = 729) = 115226.337</li><li><strong>这个值根我们的目标波特率相差很小，这么小的误差在正常通信的允许范围内</strong></li><li><strong>8倍过采样时计算方式是一样的</strong></li></ul></li></ul><p><strong>权限控制</strong></p><p>STM32F4xx 系列控制器USART 支持奇偶校验。</p><ul><li>当使用校验位时，串口传输的长度将是8 位的数据帧加上 1 位的校验位总共 9 位，此时 USART_CR1 寄存器的 M 位需要设置为 1，即 9 数据位。</li><li>将 USART_CR1 寄存器的 PCE 位置 1 就可以启动奇偶校验控制，奇偶校验由硬件自动完成。</li><li>启动了奇偶校验控制之后，在发送数据帧时会自动添加校验位，接收数据时自动验证校验位。</li><li>接收数据时如果出现奇偶校验位验证失败，会见USART_SR 寄存器的PE 位置1，并可以产生奇偶校验中断。</li><li>使能了奇偶校验控制后，每个字符帧的格式将变成：起始位+ 数据帧+ 校验位 + 停止位。</li></ul><p><strong>中断控制</strong></p><p>USART 有多个中断请求事件，具体见表USART 中断请求 。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210010337370.png" alt="image-20221001033731235" style="zoom:33%;"><h3 id="usart-初始化结构体" tabindex="-1"><a class="header-anchor" href="#usart-初始化结构体" aria-hidden="true">#</a> USART 初始化结构体</h3><ul><li>标准库函数对每个外设都建立了一个初始化结构体，比如 USART_InitTypeDef，结构体成员用于 设置外设工作参数，并由外设初始化配置函数，比如USART_Init() 调用，这些设定参数将会设置 外设相应的寄存器，达到配置外设工作环境的目的。</li><li>初始化结构体和初始化库函数配合使用是标准库精髓所在，理解了初始化结构体每个成员意义 基本上就可以对该外设运用自如了。初始化结构体定义在stm32f4xx_usart.h 文件中，初始化库函 数定义在stm32f4xx_usart.c 文件中，编程时我们可以结合这两个文件内注释使用。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> USART_BaudRate<span class="token punctuation">;</span>							<span class="token comment">// 波特率</span>
<span class="token class-name">uint16_t</span> USART_WordLength<span class="token punctuation">;</span>			 			<span class="token comment">// 字长</span>
<span class="token class-name">uint16_t</span> USART_StopBits<span class="token punctuation">;</span>							<span class="token comment">// 停止位</span>
<span class="token class-name">uint16_t</span> USART_Parity<span class="token punctuation">;</span>								<span class="token comment">// 校验位</span>
<span class="token class-name">uint16_t</span> USART_Mode<span class="token punctuation">;</span>									<span class="token comment">// USART 模式</span>
<span class="token class-name">uint16_t</span> USART_HardwareFlowControl<span class="token punctuation">;</span>   <span class="token comment">// 硬件流控制 </span>
<span class="token punctuation">}</span> USART_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>USART_BaudRate</strong>：波特率设置，一般设置为 2400、9600、19200、115200。<strong>标准库函数会根据设定值计算得到 USARTDIV 值，并设置USART_BRR 寄存器值</strong>。</li><li><strong>USART_WordLenght</strong>：数据帧字长，可选 8位 或 9位。它由 USART_CR1寄存器的M位设定。如果没有使能奇偶校验控制，一般使用8位数据位。如果使能了奇偶校验则一般使用9位数据位。</li><li><strong>USART_StopBits</strong>：停止位设置，可选0.5、1、1.5、2个 停止位。它由 USART_CR2寄存器的STOP[1:0]位设定。一般我们选择 1 个停止位。</li><li><strong>USART_Parity</strong>：奇偶校验控制选择，可选 USART_Parity_No(无校验)、USART_Parity_Even(偶 校验) 以及USART_Parity_Odd(奇校验)，它由USART_CR1 寄存器的 PCE位 和 PS位 的值设定。</li><li><strong>USART_Mode</strong>：USART 模式选择，有USART_Mode_Rx 和USART_Mode_Tx，允许使用逻辑或运算选择两个，它设定USART_CR1 寄存器的RE 位和TE 位。</li><li><strong>USART_HardwareFlowControl</strong>：硬件流控制选择，只有在硬件流控制模式才有效，可选有使能 RTS、 使能CTS、 同时使能RTS和CTS、 不使能硬件流。</li></ul><p>当使用同步模式时，需要配置 SCLK 引脚输出脉冲，标准库使用一个时钟初始化结构体USART_ClockInitTypeDef 来设置。因此该结构体内容也只有在同步模式才需要设置。</p><p><strong>USART 时钟初始化结构体</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token class-name">uint16_t</span> USART_Clock<span class="token punctuation">;</span>           <span class="token comment">// 时钟使能控制</span>
<span class="token class-name">uint16_t</span> USART_CPOL<span class="token punctuation">;</span>            <span class="token comment">// 时钟极性</span>
<span class="token class-name">uint16_t</span> USART_CPHA<span class="token punctuation">;</span>            <span class="token comment">// 时钟相位</span>
<span class="token class-name">uint16_t</span> USART_LastBit<span class="token punctuation">;</span>         <span class="token comment">// 最尾位时钟脉冲 </span>
<span class="token punctuation">}</span> USART_ClockInitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>USART_Clock</strong>：同步模式下 SCLK 引脚上时钟输出使能控制，可选禁止时钟输出 (US-ART_Clock_Disable) 或开启时钟输出 (USART_Clock_Enable)；如果使用同步模式发送，一般都需要开启时钟。它设定USART_CR2 寄存器的CLKEN 位的值。</li><li><strong>USART_CPOL</strong>：同步模式下SCLK 引脚上输出时钟极性设置，可设置在空闲时SCLK 引脚为低电平(USART_CPOL_Low) 或高电平(USART_CPOL_High)。它设定USART_CR2 寄存器的CPOL位的值。</li><li><strong>USART_CPHA</strong>：同步模式下 SCLK 引脚上输出时钟相位设置，可设置在时钟第一个变化沿捕获数据 (USART_CPHA_1Edge) 或在时钟第二个变化沿捕获数据。它设定 USART_CR2 寄存器的CPHA 位的值。USART_CPHA 与 USART_CPOL 配合使用可以获得多种模式时钟关系。</li><li><strong>USART_LastBit</strong>：选择在发送最后一个数据位的时候时钟脉冲是否在 SCLK 引脚输出，可以是不输出脉冲(USART_LastBit_Disable)、输出脉冲(USART_LastBit_Enable)。它设定USART_CR2 寄存器的LBCL 位的值。</li></ul><h3 id="usart1-收发通信实验" tabindex="-1"><a class="header-anchor" href="#usart1-收发通信实验" aria-hidden="true">#</a> USART1 收发通信实验</h3><p>USART 只需要两根信号线即可完成双向通信，对硬件要求低，使得很多模块都预留 USART 接口来实现与其它模块或控制器进行数据传输，比如 GSM、WI-FI、蓝牙模块等等。在硬件设计时，注意还需要一根 共地线。</p><p>我们经常使用 USART 来实现控制器与电脑之间的数据传输。这使得我们调试程序非常方便，比如我们可以把一些变量的值、函数的返回值、寄存器标志位等等 通过 USART 发送到串口调试助手，这样我们可以非常清楚程序的运行状态，当我们正式发布程序时再把这些调试信息去除即可。</p><p>我们不仅仅可以将数据发送到串口调试助手，我们还可以在串口调试助手发送数据给控制器，程序根据接收到的数据做出不同的处理。</p><p>首先我们编写一个程序实现开发版与电脑通信，在开发版上电时 通过 USART 发送一串字符给电脑，然后开发版进入中断接收等待状态，如果电脑有发送数据回来，开发版就会产生中断，我们在中断服务函数接收数据，并马上把数据返回发送给电脑。</p><h4 id="硬件设计-2" tabindex="-1"><a class="header-anchor" href="#硬件设计-2" aria-hidden="true">#</a> 硬件设计</h4><p>为利用 USART 实现开发版与电脑通信，需要用到一个 SUB 转 USART 的 IC，我们选择 CH340G 芯片来实现这个功能，CH340G是一个 USB总线的转接芯片，实现 USB 转 USART、USB 转 IrDA、红外 或 USB 转打印机接口，我们使用其 USB 转 USART 功能。具体电路设计见图 USB转串口硬件设计。</p><p>我们将 CH340G的TXD引脚通过挑帽 J11 与 USART1 的 RX引脚连接，CH340G的 RXD 引脚通过跳帽J12 与 USART 的 TX 引脚连接。</p><p>CH340G 芯片集成在开发版上，其地线(GND)已与控制器的GND连通。如果我们想使用 USART2，那么就可以把开发版上默认连接的挑帽拔掉，然后用杜邦线连接 USART2 与 CH340G 的通信接口就可以实现通信，这个就是使用跳帽的好处，不会把 CH340 G的通信引脚固定死。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210031529937.png" alt="image-20221003152859365" style="zoom:33%;"><h4 id="软件设计-2" tabindex="-1"><a class="header-anchor" href="#软件设计-2" aria-hidden="true">#</a> 软件设计</h4><p>创建两个文件 bsp_debug_usart.h 和 bsp_debug——usart.c 用来存放 USART 驱动程序及相关宏定义。</p><h4 id="编程要点-2" tabindex="-1"><a class="header-anchor" href="#编程要点-2" aria-hidden="true">#</a> 编程要点</h4><ul><li>使能 RX 和 TX 引脚 GPIO 时钟和USART时钟</li><li>初始化 GPIO ，并将 GPIO 时钟复用到 USART 上</li><li>配置 USART 参数</li><li>配置中断控制器并使能 USART 接收中断</li><li>使能 USART</li><li>在USART 接收中断服务函数实现数据接收和发送</li></ul><h4 id="代码实现" tabindex="-1"><a class="header-anchor" href="#代码实现" aria-hidden="true">#</a> 代码实现</h4><p><code>bsp_debug_usart.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_DEBUG_USART_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_DEBUG_USART_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART</span>								<span class="token expression">USART1</span></span>

<span class="token comment">//USART引脚总线时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_CLK</span>						<span class="token expression">RCC_APB2Periph_USART1</span></span>
<span class="token comment">//USART波特率</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_BAUDRATE</span>			<span class="token expression"><span class="token number">115200</span></span></span>

<span class="token comment">//USART RX引脚所属GPIO组</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_GPIO_PORT</span>	<span class="token expression">GPIOA</span></span>
<span class="token comment">//USART RX引脚所属GPIO组时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_GPIO_CLK</span>		<span class="token expression">RCC_AHB1Periph_GPIOA</span></span>
<span class="token comment">//USART RX引脚所属GPIO引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_PIN</span>				<span class="token expression">GPIO_Pin_10</span></span>
<span class="token comment">//GPIO 复用到 USART1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_AF</span>					<span class="token expression">GPIO_AF_USART1</span></span>

<span class="token comment">//选择将Pin10连接到USART</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_SOURCE</span>			<span class="token expression">GPIO_PinSource10</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_GPIO_PORT</span>	<span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_GPIO_CLK</span>		<span class="token expression">RCC_AHB1Periph_GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_PIN</span>				<span class="token expression">GPIO_Pin_9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_AF</span>					<span class="token expression">GPIO_AF_USART1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_SOURCE</span>			<span class="token expression">GPIO_PinSource9</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_IRQHandler</span> 		<span class="token expression">USART1_IRQHandler</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_IRQ</span>						<span class="token expression">USART1_IRQn</span></span>

<span class="token keyword">void</span> <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendString</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_DEBUG_USART_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_debug_usart.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>



<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
	<span class="token comment">//嵌套向量中断控制器组选择		（//应该类似一个开关，打开哪个的开关就设置的是哪个）</span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置 USART 为中断源</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> DEBUG_USART_IRQ<span class="token punctuation">;</span>
	
	<span class="token comment">//抢占优先级为 1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">//子优先级为 1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	
	<span class="token comment">//初始化配置 NVIC</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
	

<span class="token keyword">void</span> <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>
	
	<span class="token comment">//使能 AHB总线 时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_CLK <span class="token operator">|</span> DEBUG_USART_TX_GPIO_CLK
	<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能 GPIO/USART 时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>DEBUG_USART_CLK<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//链接 PXx 到 USAR_Tx</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_PORT <span class="token punctuation">,</span>
								   DEBUG_USART_RX_SOURCE<span class="token punctuation">,</span>
									 DEBUG_USART_RX_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//链接 PXx 到 USAR_Rx</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>DEBUG_USART_TX_GPIO_PORT <span class="token punctuation">,</span>
									 DEBUG_USART_TX_SOURCE<span class="token punctuation">,</span>
									 DEBUG_USART_TX_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// GPIO 初始化</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>			  <span class="token comment">//推挽输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>				  <span class="token comment">//上拉</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>			<span class="token comment">//时钟速度</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode  <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>					<span class="token comment">//复用模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin   <span class="token operator">=</span> DEBUG_USART_TX_PIN<span class="token punctuation">;</span>		
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_TX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode  <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>					<span class="token comment">//复用模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin   <span class="token operator">=</span> DEBUG_USART_RX_PIN<span class="token punctuation">;</span> 
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//波特率</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> DEBUG_USART_BAUDRATE<span class="token punctuation">;</span>
	<span class="token comment">//字长（数据位 + 校验位）= 8 </span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>
	<span class="token comment">//停止位：1个停止位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>
	<span class="token comment">//校验位选择：不使用校验</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity   <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>
	<span class="token comment">//硬件流控制：不使用流控制</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span>
	<span class="token comment">//USART 模式控制：同时使能接收和发送</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span>
	<span class="token comment">//完成 USART 初始化配置</span>
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//嵌套向量中断控制器 NVIC 配置</span>
	<span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能串口接收中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> USART_IT_RXNE <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能串口</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//发送一个字节数据到 USART</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//等待发送数据寄存器位空</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Usart_SendString</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TC<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	<span class="token comment">//发送一个字节数据到串口</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//等待发送完毕</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//等待串口接收数据</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取数据</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>stm32f4xx_it.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">DEBUG_USART_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">uint8_t</span> ucTemp<span class="token punctuation">;</span>
  <span class="token comment">//接收完成后 USART_SR 寄存器的 RXNE位 置1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//接收一个字符</span>
		ucTemp <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span> DEBUG_USART <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把字符发送回去</span>
		<span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>ucTemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="usart1-接收指令控制led" tabindex="-1"><a class="header-anchor" href="#usart1-接收指令控制led" aria-hidden="true">#</a> USART1 接收指令控制LED</h3><ul><li>初始化配置 LED 的 GPIO</li><li>使能 RX 和 TX 引脚 GPIO时钟 和 USART 时钟</li><li>初始化GPIO，并将 GPIO 复用到 USART 上</li><li>配置 USART参数</li><li>使能 USART</li><li>获取指令输入，根据指令控制 LED 颜色</li></ul><p><code>bsp_usart.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_DEBUG_USART_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_DEBUG_USART_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART</span>								<span class="token expression">USART1</span></span>

<span class="token comment">//USART引脚总线时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_CLK</span>						<span class="token expression">RCC_APB2Periph_USART1</span></span>
<span class="token comment">//USART波特率</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_BAUDRATE</span>			<span class="token expression"><span class="token number">115200</span></span></span>

<span class="token comment">//USART RX引脚所属GPIO组</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_GPIO_PORT</span>	<span class="token expression">GPIOA</span></span>
<span class="token comment">//USART RX引脚所属GPIO组时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_GPIO_CLK</span>		<span class="token expression">RCC_AHB1Periph_GPIOA</span></span>
<span class="token comment">//USART RX引脚所属GPIO引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_PIN</span>				<span class="token expression">GPIO_Pin_10</span></span>
<span class="token comment">//GPIO 复用到 USART1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_AF</span>					<span class="token expression">GPIO_AF_USART1</span></span>

<span class="token comment">//选择将Pin10连接到USART</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_RX_SOURCE</span>			<span class="token expression">GPIO_PinSource10</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_GPIO_PORT</span>	<span class="token expression">GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_GPIO_CLK</span>		<span class="token expression">RCC_AHB1Periph_GPIOA</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_PIN</span>				<span class="token expression">GPIO_Pin_9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_AF</span>					<span class="token expression">GPIO_AF_USART1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_TX_SOURCE</span>			<span class="token expression">GPIO_PinSource9</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_IRQHandler</span> 		<span class="token expression">USART1_IRQHandler</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_IRQ</span>						<span class="token expression">USART1_IRQn</span></span>

<span class="token keyword">void</span> <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendString</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_DEBUG_USART_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_usart.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>



<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
	<span class="token comment">//嵌套向量中断控制器组选择		（//应该类似一个开关，打开哪个的开关就设置的是哪个）</span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置 USART 为中断源</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> DEBUG_USART_IRQ<span class="token punctuation">;</span>
	
	<span class="token comment">//抢占优先级为 1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">//子优先级为 1</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能中断</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	
	<span class="token comment">//初始化配置 NVIC</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
	

<span class="token keyword">void</span> <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>
	
	<span class="token comment">//使能 AHB总线 时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_CLK <span class="token operator">|</span> DEBUG_USART_TX_GPIO_CLK
	<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能 GPIO/USART 时钟</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>DEBUG_USART_CLK<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//链接 PXx 到 USAR_Tx</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_PORT <span class="token punctuation">,</span>
								   DEBUG_USART_RX_SOURCE<span class="token punctuation">,</span>
									 DEBUG_USART_RX_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//链接 PXx 到 USAR_Rx</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>DEBUG_USART_TX_GPIO_PORT <span class="token punctuation">,</span>
									 DEBUG_USART_TX_SOURCE<span class="token punctuation">,</span>
									 DEBUG_USART_TX_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// GPIO 初始化</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>			  <span class="token comment">//推挽输出</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>				  <span class="token comment">//上拉</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>			<span class="token comment">//时钟速度</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode  <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>					<span class="token comment">//复用模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin   <span class="token operator">=</span> DEBUG_USART_TX_PIN<span class="token punctuation">;</span>		
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_TX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode  <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>					<span class="token comment">//复用模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin   <span class="token operator">=</span> DEBUG_USART_RX_PIN<span class="token punctuation">;</span> 
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//波特率</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> DEBUG_USART_BAUDRATE<span class="token punctuation">;</span>
	<span class="token comment">//字长（数据位 + 校验位）= 8 </span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>
	<span class="token comment">//停止位：1个停止位</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>
	<span class="token comment">//校验位选择：不使用校验</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity   <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>
	<span class="token comment">//硬件流控制：不使用流控制</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span>
	<span class="token comment">//USART 模式控制：同时使能接收和发送</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span>
	<span class="token comment">//完成 USART 初始化配置</span>
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//嵌套向量中断控制器 NVIC 配置</span>
	<span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能串口接收中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> USART_IT_RXNE <span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//使能串口</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//发送一个字节数据到 USART</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//等待发送数据寄存器位空</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Usart_SendString</span><span class="token punctuation">(</span>USART_TypeDef <span class="token operator">*</span>pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TC<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	<span class="token comment">//发送一个字节数据到串口</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//等待发送完毕</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//等待串口接收数据</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取数据</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>和上个实验 “USART1 收发通信实验” 的区别在： <ul><li>没有使能USART中断（接收消息之后，接收寄存器里面的值会被清空）</li><li>没有编写中断函数</li><li>重定向了 C 库函数</li><li>本实验阻塞等待接收指令</li></ul></li></ul><h3 id="下载验证-1" tabindex="-1"><a class="header-anchor" href="#下载验证-1" aria-hidden="true">#</a> 下载验证</h3><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210092019995.png" alt="image-20221009201942307"></p><h2 id="dma-直接存储区访问" tabindex="-1"><a class="header-anchor" href="#dma-直接存储区访问" aria-hidden="true">#</a> DMA 直接存储区访问</h2><h3 id="dma-简介" tabindex="-1"><a class="header-anchor" href="#dma-简介" aria-hidden="true">#</a> DMA 简介</h3><p>DMA(Direct Memory Access，直接存储区访问) 为实现数据在 <strong>高速外设寄存器与存储器之间</strong> 或 <strong>存储器与存储器</strong></p><p>之间提供高效的方法，之所以称之为高效，是因为</p><ul><li><p><strong>DMA 传输实现高速数据移动过程无需任何CPU操作控制</strong></p></li><li><p>从硬件层次上来说，DMA 控制器是独立于 Cortex-M4 内核的，有点类似 GPIO、USART 外设一般，只是 DMA 的功能是可以快速移动内存数据</p></li><li><p>直接存储器存取，是单片机的一个外设，它的主要功能是用来搬数据，<strong>但是不需要占用 CPU，即在传输数据的时候， CPU 可以干其他的事情</strong>，好像是多线程一样。数据传输支持从外设到存储器或者存储器到存储器，这里的存储器可以是 SRAM 或者是 FLASH。</p></li><li><p><strong>DMA的总线与Cortex-M3的CPU总线是分开的，因此DMA的运行不会占用CPU的总线资源</strong></p></li></ul><p>STM32F4xx 系列的 DMA 功能齐全，工作模式众多，适合不同编程环境的要求。</p><p>STM32F4xx 系列的 DMA 支持 <strong>外设到存储器、存储器到外设、存储器到存储器</strong> 三种传输模式。</p><ul><li>这里的外设一般指的是外设的数据寄存器，比如 ADC、SPI、I2C、DCMI 等等外设的数据寄存器</li><li>存储器一般指的是 片内SRAM、外部存储器、片内Flash 等等</li></ul><p><strong>外设到存储器传输</strong>：就是把外设数据寄存器的内容转移到指定的内存空间，比如进行 ADC 采集时，我们可以利用 DMA 传输把 AD 转换数据转移到我们定义的存储区中，这样对于多通道采集、采样频率高、连续输出数据的 AD 采集是非常高效的处理方法。</p><p><strong>存储区到外设传输</strong>：就是把一个指定的存储区内容拷贝到另一个存储区空间。功能类似于 C语言内存拷贝函数 memcpy，利用 DMA 传输可以达到更高的传输效率，特别是 DMA 传输不占用CPU的，可以节省很多 CPU 资源。</p><h3 id="dma-功能框图" tabindex="-1"><a class="header-anchor" href="#dma-功能框图" aria-hidden="true">#</a> DMA 功能框图</h3><p>STM32F4xx 系列的 DMA 可以实现 外设到存储器、存储器到外设、存储器到存储器 三种传输模式，这要得益于 DMA 控制器是采样 AHB 主总线的，可以控制 AHB 总线矩阵来启动 AHB 事务。</p><p><img src="/my-vuepress-blog/assets/image-20221010035348992-ea0d0639.png" alt="image-20221010035348992"></p><h4 id="外设通道选择" tabindex="-1"><a class="header-anchor" href="#外设通道选择" aria-hidden="true">#</a> 外设通道选择</h4><p>STM32F4xx 系列资源丰富，具有两个 DMA 控制器，同时外设繁多，为实现正常传输，DMA 需要通道选择控制。<strong>每个 DMA 控制器具有8个数据流，每个数据流对应8个外设通道（或称请求）</strong>。在实现 DMA 传输之前，DMA 控制器会通过 DMA数据流 x 配置寄存器 DMA_SxSR( x为0～7 ，对应8个DMA数据流) 的 CHSEL[2:0] 位选择对应的通道作为该数据流的目标外设。</p><ul><li><strong>这里的通道可以理解为传输数据的一种管道</strong></li></ul><p><strong>外设通道选择要解决的主要问题是决定哪一个外设作为该数据流的源地址或目标地址</strong>。</p><p>DMA 请求映射情况参考 DMA1 各个通道的请求映像 和  表 DMA2 各个通道的请求映像：</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210100405878.png" alt="image-20221010040504764" style="zoom:43%;"><p>DMA2 各个通道的请求映像</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210100405401.png" alt="image-20221010040552281" style="zoom:40%;"><p><strong>每个外设请求都占用一个数据流，相同外设请求可以占用不同的数据流。</strong></p><p>比如 SPI3_RX 请求，即 SPI3 数据发送请求，占用 DMA1的数据流0 和 通道0 ，因此当我们使用该请求时，我们需要在把 DMA_S0CR 寄存器的 CHSEL[2:0] 设置为 &quot;000&quot;，<strong>此时相同数据流的其他通道不能被选择</strong>，处于不可用状态，比如此时不能使用数据流0 通道1 即 I2C1_RX 请求等等。</p><p>从 “DMA1 各个通道的请求映像” 可以发现 SPI3_RX请求不仅仅在数据流0的通道0，同时 数据流2的通道0 也是 SPI_RX请求，实际上其他外设基本上都有两个对应的数据流通道，这两个数据流通道都是可选的，这样设计是尽可能提供多个数据流同时使用情况选择。</p><h4 id="仲裁器" tabindex="-1"><a class="header-anchor" href="#仲裁器" aria-hidden="true">#</a> 仲裁器</h4><p>一个 DMA 寄存器对应8个数据流，数据流包含要传输数据的源地址、目标地址、数据等等信息。</p><p>如果我们需要同时使用同一个DMA控制器（DMA1 或 DMA2）多个外设请求时，必须需要同时使用多个数据流，这需要仲裁器来管理判断哪一个数据流具有优先传输权利。</p><p>仲裁器管理数据流方法分为两个阶段。</p><ul><li>第一阶段属于软件阶段，我们在配置数据流时可以通过寄存器设定它的优先级，具体配置 DMA_SxCr 寄存器PL[1:0]位，可以设置为 非常高、高、中、低 四个级别。</li><li>第二阶段属于硬件阶段，如果两个或以上数据流软件设置优先级一样，则他们优先级取决于数据流编号，编号越低越具有优先权，比如数据流2优先级高于优先级3。</li></ul><h4 id="fifo-dma-传输具有fifo-模式和直接模式" tabindex="-1"><a class="header-anchor" href="#fifo-dma-传输具有fifo-模式和直接模式" aria-hidden="true">#</a> FIFO（DMA 传输具有FIFO 模式和直接模式）</h4><p>每个数据流都独立拥有 4字(32位 x 4)FIFO（先进先出存储器缓冲区）。<strong>DMA 传输具有FIFO 模式和直接模式。</strong></p><ul><li><strong>直接模式</strong>：每个 DMA 请求会立即启动对存储器传输。在直接模式下，如果 DMA 配置为 存储器到外设传输 模式 ，那DMA会将一个数据存放在 FIFO 内，如果外设启动 DMA 传输请求就可以马上将数据传输过去。</li><li><strong>FIFO 模式</strong>：<strong>用于在数据源传输到目的地址之前临时存放这些数据</strong>。可以通过 DMA 数据流 xFIFO 控制寄存器 DMA_SxFCR 的 FTH[1:0] 位来控制 FIFO 的阈值，分别为 1/4、1/2、3/4 和满。如果数据存储量达到阈值级别时，FIFO 内容将传输到目标中。 <ul><li>FIFO 对于要求源地址和目的地址数据宽度不同时非常有用，比如源数据是源源不断的字节数据，而目标地址要求输出字宽度的数据，即在实现数据传输时同时把原来4个8位字节的数据拼凑成一个32位字数据。此时使用 FIFO 功能先把数据缓存起来，分别根据需要输出数据。</li><li>FIFO 另一个作用是用于突发（burst）传输。</li></ul></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210111817528.png" alt="image-20221011181732451" style="zoom:50%;"><ul><li>Bx：字节（8位）</li><li>Hx：半字（16位）</li><li>Wx：字（32位）</li></ul><h4 id="存储器端口、外设端口" tabindex="-1"><a class="header-anchor" href="#存储器端口、外设端口" aria-hidden="true">#</a> 存储器端口、外设端口</h4><p>DMA 控制器实现双 AHB 主接口，更好利用总线矩阵和并行传输。DMA 控制器通过 存储器端口、外设端口、存储器、外设 进行数据传输</p><ul><li><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210101535649.png" alt="image-20221010153532567"></p></li><li><p>DMA 控制器的功能是快速转移内存数据，需要一个连接到源数据地址的端口和一个连接到目标地址的端口。</p></li><li><p>DMA2（DMA 控制器 2） 的存储器端口和外设端口都是连接到AHB总线矩阵，可以使用AHB 总线矩阵功能。</p></li><li><p>DMA2 存储器和外设端口可以访问相关的内存地址，包括 内部Flash、内部SRAM、AHB1外设、AHB2外设、APB2外设、外部存储空间。</p></li></ul><p>DMA1 的存储区端口相比DMA的要减少 AHB2外设 的访问权，同时 <strong>DMA1 外设端口是没有连接到总线矩阵的，只能连接到 APB1 外设</strong>，所以 <strong>DMA1 不能实现存储器到存储器的传输。</strong></p><h4 id="编程端口" tabindex="-1"><a class="header-anchor" href="#编程端口" aria-hidden="true">#</a> 编程端口</h4><p><strong>AHB从器件</strong> 编程端口是连接至 AHB2外设的。AHB2外设在使用DMA传输时需要相关控制信号。</p><h3 id="dma-数据配置" tabindex="-1"><a class="header-anchor" href="#dma-数据配置" aria-hidden="true">#</a> DMA 数据配置</h3><p>DMA工作模式多样，具有多种工作模式：</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210110241525.png" alt="image-20221011024147448" style="zoom:50%;"><h4 id="dma-传输模式" tabindex="-1"><a class="header-anchor" href="#dma-传输模式" aria-hidden="true">#</a> DMA 传输模式</h4><p>DMA2 支持全部三种传输模式，而 DMA1 只有 外设到存储器、存储器到外设 两种模式。</p><ul><li>模式选择可以通过 DMA_SxCR 寄存器的 DIR[1:0] 位控制，进而将 DMA 的DMA_SxCR 寄存器的 EN位 置1就可以使能DMA传输。</li><li>DMA_SxCR寄存器的 PSIZE[1:0] 和 MSIZE[1:0] 位 分别指定外设和存储器数据大小宽度，可以指定为 字节(8位)、半字(16位)、字(32位)，我们可以根据实际情况设置。</li><li>直接模式要求外设和存储器的数据宽度大小一样，实际上在这种模式下 DMA数据流 只使用 PSIZE，MSIZE 被忽略。</li></ul><h4 id="源地址和目标地址" tabindex="-1"><a class="header-anchor" href="#源地址和目标地址" aria-hidden="true">#</a> 源地址和目标地址</h4><ul><li><p>DMA 数据流x 外设地址 DMA_SxPAR（x 为 1～7）寄存器用来指定外设地址，它是一个32位数据有效寄存器。</p></li><li><p><strong>DMA 数据流 x 存储器 0 地址寄存器 (DMA_SxM0AR)（x 为 1～7）</strong> 和 <strong>DMA 数据流 x 存储器 1 地址寄存器 (DMA_SxM0AR)（x 为 1～7）</strong> 用来存放存储器地址，其中DMA_SxM1AR只用于 <strong>双缓冲模式</strong>，</p><ul><li>DMA_SxM0AR 和 DMA_SxM1AR 都是32 位数据有效的。</li></ul></li><li><p><strong>当选择外设到存储器时</strong>，即 DMA_SxCR 寄存器的 DIR[1:0] 位为 “00”，<strong>DMA_SxPAR 寄存器为外设地址</strong>，也就是传输的源地址，DMA_SxM0AR 寄存器为存储器地址，也就是传输的目标地址。</p></li><li><p><strong>当选择存储器到存储器时</strong>，即 DMA_SxCR 寄存器的 DIR[1:0] 位为 “10”，<strong>DMA_SxPAR 寄存器为存储器地</strong>址，也就是传输的源地址，DMA_SxM0AR 寄存器为存储器地址，也就是传输的目标地址。<strong>使用存储器到存储器模式时，不允许循环模式和直接模式。 只有 DMA2 控制器能够执行存储器到存储器的传输。</strong></p><ul><li><p>通过将 DMA_SxCR 寄存器中的使能位 (EN) 置 1 来使能数据流时，数据流会立即开始填充 FIFO，直至达到阈值级别。</p></li><li><p>达到阈值级别后，FIFO 的内容便会移出，并存储到目标中。</p></li><li><p>如果 DMA_SxNDTR 寄存器达到零或 DMA_SxCR 寄存器中的 EN 位由软件清零，传输即会 停止。</p></li><li><p>使用存储器到存储器模式时，不允许循环模式和直接模式。</p></li><li><p>只有 DMA2 控制器能够执行存储器到存储器的传输。</p></li><li><p>如果选择存储器到存储器模式（DMA_SxCR 中的 DIR 位为“10”），并且 DMA_SxCR 寄 存 器中的 EN 位为“1”，则此位由硬件置 1，因为在存储器到存储器配置不能使用直接模式。</p></li><li><p><strong>存储器到存储器模式通道选择没有具体规定，源地址和目标地址使用之前定义的数组首地址，只</strong><strong>能使用一次传输模式不能循环传输</strong></p></li></ul></li><li><p><strong>当选择存储器到外设时</strong>，即 DMA_SxCR 寄存器的 DIR[1:0] 位为 “01”，<strong>DMA_SxM0AR 寄存器作为源地址</strong>，DMA_SxPAR 寄存器作为目标地址。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210140129840.png" alt="image-20221014012856998"></p></li><li><p>只有赢得了数据流的仲裁后，相应数据流才有权访问 AHB 源或目标端口。系统使用在 DMA_SxCR 寄存器 PL[1:0] 位中为每个数据流定义的优先级执行仲裁。</p></li></ul><h4 id="流控制器" tabindex="-1"><a class="header-anchor" href="#流控制器" aria-hidden="true">#</a> 流控制器</h4><p>流控制器主要涉及到控制一个DMA传输停止问题。</p><ul><li><p>DMA 传输 当 DMA_SxCR 寄存器的 EN位 被置1 后，就进入准备传输状态，如果有外设请求 DMA 传输就可以进行数据传输了。</p></li><li><p>很多情况下，我们明确知道传输数据的数目，比如要传 1000个数据 或者 2000 个数据，这样我们就可以在传输之前设置 DMA_SxNDTR 寄存器为要传输的数目值，DMA 控制器在传输完这么多数目的数据后 就可以控制DMA停止传输。</p></li><li><p><strong>DMA 数据流 x 数据项数寄存器 (DMA_SxNDTR) (x = 0～7)</strong> 寄存器<strong>用来记录当前仍需要传输数目</strong>，它是一个 16位 的数据有效寄存器，即最大值为 65535，这个值在程序设计时非常有用，但也有需要注意的地方：</p><ul><li>我们在编程时一般都会明确指定一个传输数量，在完成一次数目传输后 DMA_SxNDTR 计数值就会自减，当达到0时 就说明传输完成。</li></ul></li><li><p>在某些情况下，在传输之前我们无法确定数据的数目，那 DMA 就无法自动控制传输停止了，此时需要外设通过硬件通信向DMA控制器发送停止信号。这里有一个大前提就是外设必须是可以发出这个停止信号的，只有SDIO 才有这个功能，其它外设不具备此功能。</p></li></ul><h4 id="循环模式" tabindex="-1"><a class="header-anchor" href="#循环模式" aria-hidden="true">#</a> 循环模式</h4><p>循环模式相对于一次模式，一次模式就是传输完成一次就停止传输了，下一次传输需要手动控制。而循环模式在传输完成一次后 会自动按照相同配置重新传输（无限重复传输完整的数据，比如一个数组，它会把数组元素传输完成 后 又从头开始），周而复始直至被控制停止 或 传输发生错误。</p><ul><li>通过 DMA_SxCR 寄存器 的 CIRC 位可以使能循环模式。</li></ul><h4 id="传输类型-单次-single-传输-突发-burst-传输" tabindex="-1"><a class="header-anchor" href="#传输类型-单次-single-传输-突发-burst-传输" aria-hidden="true">#</a> 传输类型（单次(Single)传输 &amp; 突发(Burst)传输）</h4><p>DMA 传输类型有 <strong>单次(Single)传输</strong> 和 <strong>突发(Burst)传输</strong>。</p><ul><li><strong>突发传输</strong>：就是用非常短的时间 结合 非常高的数据信号率 传输数据。相对于正常传输速度，突发传输就是在传输阶段把速度瞬间提高，实现高速传输，在数据传输完成后恢复正常速度，有点类似达到数据块 “秒传” 效果。 <ul><li>为达到这个效果，突发传输过程要占用 AHB总线，保证要求每个数据项在传输过程不被分割，这样一次性把数据全部传输完才释放 AHB总线；</li><li>单次传输时，必须通过 AHB的总线仲裁 多次控制才能完成传输。</li></ul></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210110436783.png" alt="image-20221011043625657"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210110437003.png" alt="image-20221011043750819"></p><ul><li>PBURST[1:0] 和 MBURST[1:0] 都位于 DMA_SxCR 寄存器中，分别用于设置 外设和存储器 的突发传输节拍数 <ul><li>对应为 单次传输、4个节拍增量传输、8个节拍增量传输、16个节拍增量传输 。</li><li>PINC位 和 MINC位 是 DMA_SxCR寄存器 的第8和第10位，如果位被置1，则在每次传输数据后 数据地址指针自动递增，其增量由 PSIZE 和 MSIZE 值决定，比如 设置PSIZE为半字大小（2字节），那么下一次传输地址将是前一次地址递增2</li></ul></li><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210110435349.png" alt="image-20221011043550269" style="zoom:50%;"></li></ul><p><strong>DMA传输需要用到总线矩阵，有个总线仲裁管理总线事务，由它来控制该谁谁用总线</strong></p><p><strong>普通的DMA传输可能传一个数据就必须跟总线仲裁提要求，总线仲裁才来安排传输</strong></p><p><strong>如果是增量突发传输，就是一次性就传输4、8、16个数据，其间不被中断</strong></p><p><strong>因为要求不被中断也就会产生一个问题，总线给你占用了，其他组件就没得用了</strong></p><ul><li><p>以DMA的方式进行数据的访问时，例如当要将内存（flash）中的数据加载到外设上，则完成这一操作，必须 占用相应的DMA数据总线，和相应的DMA外设总线，总线的权限是仲裁器分配的。</p></li><li><p>在DMA传输中，FIFO是源加载数数据的缓冲区，即源的数据通过总线加载当FIFO中，然后将FIFO中的数据通过总线加载到目标中。</p></li><li><p>突发增量传输就规定了总线的一次权限可以可以使用多久（可以连续传输几个数据），而不会失去权限。在一次突发传输期间，相应的总线是被锁定的，在突发传输完成之后，总线矩阵会再次分配权限，以相应其他外设的请求。 因为每个数据流的STM32的每个数据流的FIFO有（4字，1字 = 4字节）16个字节，所以最多有16个节拍的字节突发传输，或8个节拍的半字传输，或是4个节拍的字传输。</p></li><li><p>“只有DMA2可以执行存储器到存储器的传输”那是因为DMA2的外设总线DMA_P2经过总线矩阵连接到了存 储器（可能Flash，SRAM1，SRAM，FSMC2）中，而DMA_P1并没有连接。</p></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210111753945.png" alt="image-20221011175319853" style="zoom:25%;"><ul><li>比如：单次传输一个字节就要总线仲裁一次。假设你的通信协议要求一次发送4个字节，用单次传输就需要总线仲裁4次，突发传输就可以只仲裁一次然后全发出去，这样就可以提高传输效率。</li></ul><p>突发传输与FIFO 密切相关，突发传输需要结合 FIFO 使用，具体要求 FIFO 阈值一定要是 突发传输数据量 的整数倍。</p><ul><li>FIFO 阈值选择 和 存储器突发大小 必须配合使用：<img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210112052817.png" alt="image-20221011205259731"></li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210111817528.png" alt="image-20221011181732451" style="zoom:50%;"><ul><li>Bx：字节（8位）</li><li>Hx：半字（16位）</li><li>Wx：字（32位）</li></ul><h4 id="直接模式" tabindex="-1"><a class="header-anchor" href="#直接模式" aria-hidden="true">#</a> 直接模式</h4><p>默认情况下，DMA 工作在直接模式，没有使能 FIFO阈值级别。</p><ul><li><p>在直接模式下 每个外设请求都立即启动对存储器传输 的单次传输。</p></li><li><p><strong>直接模式要求源地址和目标地址的数据宽度必须一致</strong>，所以只有 PSIZE 控制，MSIZE 会被忽略。</p></li><li><p>突发传输时基于 FIFO 的，所以直接模式不支持突发传输。</p></li><li><p>另外 <strong>直接模式 不能用于 存储器到存储器传输。</strong></p></li><li><p>在直接模式下，如果 DMA 配置为 存储器到外设传输 ，那么 DMA 会将一个数据存放在 FIFO 内，如果外设启动 DMA传输请求 ，数据会立即传输过去。</p></li></ul><h4 id="双缓冲模式" tabindex="-1"><a class="header-anchor" href="#双缓冲模式" aria-hidden="true">#</a> 双缓冲模式</h4><p>设置 DMA_SxCR 寄存器的 DBM位 为1 可启动 双缓冲传输模式，并自动激活循环模式。双缓冲不应用于 存储器到存储器的传输 。</p><ul><li><p>双缓冲模式下，两个存储器（DMA_SxM0AR，DMA_SxM1AR）地址都有效，即 DMA_SxM1AR 寄存器将被激活使用。</p></li><li><p>开始传输时 使用 DMA_SxM0AR 寄存器的地址指针所对应的存储区，当这个存储区数据传输完，DMA 控制器会自动切换至 DMA_SxM1AR 寄存器的地址指针所对应的存储区，这样循环调用。</p></li><li><p>当其中一个 存储区 传输完成时，都会把 传输完成中断标志TCIF位 置1，如果我们使能了 DMA_SxCR 寄存器的传输完成中断位TCIE，则可以产生中断信号，这个对我们编程非常有用。</p></li></ul><p>另一个非常有用的信息是：</p><ul><li><p>DMA_SxCR 寄存器的 CT位，当 DMA控制器 在访问使用 DMA_SxM0AR 时，CT = 0，此时 CPU 还不能访问 DMA_SxM0AR，但可以向 DMA_SxM1AR 填充 或 读取数据；</p></li><li><p>当 DMA控制器 在访问使用 DMA_SxM1AR 时，CT = 1，此时 CPU 还不能访问 DMA_SxM1AR，但可以向 DMA_SxM0AR 填充 或 读取数据；</p></li><li><p>CT位 在 未使能 DMA 数据流传输时，此位才可以写入，以指示第一次传输的目标存储区。在使能数据流 后，此位相当于一个状态标志，用于指示作为当前目标的存储区。</p></li></ul><p>双缓冲模式应用在解码程序的地方是非常有效的。 比如 MP3 格式音频解码播放，MP3 是被压缩的文件格式，我们需要特定的解码库程序来解码文件才能得到可以播放的 PCM 信号，解码需要一定的时间。</p><ul><li>按照常规方法 是 读取一段原始数据到缓冲区，然后对缓冲区内容进行解码，解码后才输出到音频播放电路，这种流程对 CPU 运算速度要求高，很容易出现播放不流畅现象。</li><li>如果我们使用 DMA 双缓冲模式传输数据就可以非常好的解决这个问题，达到 解码 和 输出音频数据 到 音频电路 同步进行的效果。</li></ul><h4 id="dma-中断" tabindex="-1"><a class="header-anchor" href="#dma-中断" aria-hidden="true">#</a> DMA 中断</h4><p>每个 DMA数据流 可以在以下事件时产生中断。</p><ul><li><strong>传输一半</strong> ：DMA 数据传输达到一般时 HTIF标志位 被置1，如果使能 HTIE 中断控制，将产生 “达到半传输” 中断。</li><li><strong>传输完成</strong> ：DMA 数据传输完成时，TCIF标识位 被置1 ，如果使能 TCIE 中断控制位，将产生传输完成中断。</li><li><strong>传输错误</strong> ：DMA 访问总线发生错误 或者 在双缓冲模式下 试图访问 “受限” 存储器地址寄存器时，TEIF标志位 被置1，如果使能 TEIE中断控制位 ，将产生传输错误中断。</li><li><strong>FIFO 错误</strong> ：发送 FIFO 下溢 或 上溢 时，FEIF 标志位被置1，如果使能 FEIE中断控制位，将产生 FIFO 错误中断。</li><li><strong>直接模式错误</strong> ：在外设到存储器模式下，因为 存储器总线 没得到授权，使得先前数据没有完成被传输到存储器上，此时 DMEIF标志位 被置1，如果使能 DMEIE中断控制位，将产生直接模式错误中断。</li></ul><h3 id="dma-初始化结构体" tabindex="-1"><a class="header-anchor" href="#dma-初始化结构体" aria-hidden="true">#</a> DMA 初始化结构体</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> DMA_Channel<span class="token punctuation">;</span>								<span class="token comment">// 通道选择</span>
  <span class="token class-name">uint32_t</span> DMA_PeripheralBaseAddr<span class="token punctuation">;</span>		<span class="token comment">// 外设地址</span>
  <span class="token class-name">uint32_t</span> DMA_Memory0BaseAddr<span class="token punctuation">;</span>   		<span class="token comment">// 存储器0 地址</span>
  <span class="token class-name">uint32_t</span> DMA_DIR<span class="token punctuation">;</span>										<span class="token comment">// 传输方向</span>
  <span class="token class-name">uint32_t</span> DMA_BufferSize<span class="token punctuation">;</span>						<span class="token comment">// 数据数目</span>
  <span class="token class-name">uint32_t</span> DMA_PeripheralInc<span class="token punctuation">;</span>					<span class="token comment">// 外设递增</span>
  <span class="token class-name">uint32_t</span> DMA_MemoryInc<span class="token punctuation">;</span>							<span class="token comment">// 存储器递增</span>
  <span class="token class-name">uint32_t</span> DMA_PeripheralDataSize<span class="token punctuation">;</span>		<span class="token comment">// 外设数据宽度</span>
  <span class="token class-name">uint32_t</span> DMA_MemoryDataSize<span class="token punctuation">;</span>				<span class="token comment">// 存储区数据宽度</span>
  <span class="token class-name">uint32_t</span> DMA_Mode<span class="token punctuation">;</span>									<span class="token comment">// 模式选择</span>
  <span class="token class-name">uint32_t</span> DMA_Priority<span class="token punctuation">;</span>							<span class="token comment">// 优先级</span>
  <span class="token class-name">uint32_t</span> DMA_FIFOMode<span class="token punctuation">;</span>							<span class="token comment">// FIFO 模式</span>
  <span class="token class-name">uint32_t</span> DMA_FIFOThreshold<span class="token punctuation">;</span>					<span class="token comment">// FIFO 阈值</span>
  <span class="token class-name">uint32_t</span> DMA_MemoryBurst<span class="token punctuation">;</span>						<span class="token comment">// 存储器突发传输</span>
  <span class="token class-name">uint32_t</span> DMA_PeripheralBurst<span class="token punctuation">;</span>				<span class="token comment">// 外设突发传输</span>
<span class="token punctuation">}</span>DMA_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>DMA_Channel</strong>：用于指定流的通道，此参数可以是@ref DMA_channel的值。 <ul><li>可选通道0 至通道7，每个外设对应固定的通道，具体设置值需要查表DMA1 各个通道的请求映像和表DMA2 各个通道的请求映像；</li><li>它设定DMA_SxCR 寄存器的 CHSEL[2:0] 位的值。</li><li>例如，我们使用模拟数字转换器 ADC3 规则采集 4 个输入通道的 电压数据，查表DMA2 各个通道的请求映像可知使用通道 2。</li></ul></li><li><strong>DMA_PeripheralBaseAddr</strong>：外设地址，设定DMA_SxPAR 寄存器的值； <ul><li>一般设置为外设的数据寄存器地址。</li><li>如果是存储器到存储器模式则设置为其中一个存储区地址。</li><li>ADC3 的数据寄存器 ADC_DR 地址为((uint32_t)ADC3+0x4C)。</li></ul></li><li><strong>DMA_Memory0BaseAddr</strong>：存储器 0 地址，设定 DMA_SxM0AR 寄存器值； <ul><li>一般设置为我们自定义存储区的首地址。</li><li>我们程序先自定义一个 16 位无符号整形数组 ADC_ConvertedValue[4] 用来存放每个通道的 ADC 值，所以把数组首地址 (直接使用数组名即可) 赋值给 DMA_Memory0BaseAddr。</li></ul></li><li><strong>DMA_DIR</strong>：传输方向选择，可选外设到存储器、存储器到外设以及存储器到存储器。 <ul><li>它设定 DMA_SxCR 寄存器的 DIR[1:0] 位的值。</li><li>ADC 采集显然使用外设到存储器模式。</li></ul></li><li><strong>DMA_BufferSize</strong>： <ul><li>设定待传输数据数目，初始化设定 DMA_SxNDTR 寄存器的值。</li><li>这里 ADC 是采集4 个通道数据，所以待传输数目也就是4。</li></ul></li><li><strong>DMA_PeripheralInc</strong>：如果配置为 DMA_PeripheralInc_Enable，使能外设地址自动递增功能，它 设定 DMA_SxCR 寄存器的 PINC 位的值； <ul><li>一般外设都是只有一个数据寄存器，所以一般不会使能该位。</li><li>ADC3 的数据寄存器地址是固定并且只有一个所以不使能外设地址递增。</li></ul></li><li><strong>DMA_MemoryInc</strong>：如果配置为 DMA_MemoryInc_Enable，使能存储器地址自动递增功能，它 设定 DMA_SxCR 寄存器的 MINC 位的值；</li><li>我们自定义的存储区一般都是存放多个数据的，所以使能存储器地址自动递增功能。</li><li>我们之前已经定义了一个包含4 个元素的数字用来存放数据，使能存储区地址递增功能，自动把每个通道数据存放到对应数组元素内。</li><li><strong>DMA_PeripheralDataSize</strong>：外设数据宽度，可选字节 (8 位)、半字 (16 位) 和字 (32 位)，它设定 DMA_SxCR 寄存器的 PSIZE[1:0] 位的值。 <ul><li>ADC 数据寄存器只有低 16 位数据有效，使用半字数据宽度。</li></ul></li><li><strong>DMA_MemoryDataSize</strong>： <ul><li>存储器数据宽度，可选字节(8 位)、半字(16 位) 和字(32 位)，它设定 DMA_SxCR 寄存器的 MSIZE[1:0] 位的值。</li><li>保存 ADC 转换数据也要使用半字数据宽度，这跟我们定义的数组是相对应的。</li></ul></li><li><strong>DMA_Mode</strong>：DMA 传输模式选择，可选一次传输或者循环传输，它设定DMA_SxCR 寄存器 的 CIRC 位的值。 <ul><li>我们希望ADC 采集是持续循环进行的，所以使用循环传输模式。</li></ul></li><li><strong>DMA_Priority</strong>：软件设置数据流的优先级，有4 个可选优先级分别为非常高、高、中和低，它 设定 DMA_SxCR 寄存器的 PL[1:0] 位的值。 <ul><li>DMA 优先级只有在多个 DMA 数据流同时使用时才有意义，这里我们设置为非常高优先级就可以了。</li></ul></li><li><strong>DMA_FIFOMode</strong>：FIFO 模式使能，如果设置为DMA_FIFOMode_Enable 表示使能FIFO 模式 功能； <ul><li>它设定DMA_SxFCR 寄存器的DMDIS 位。</li><li>ADC 采集传输使用直接传输模式即可，不需要使用FIFO 模式。</li></ul></li><li><strong>DMA_FIFOThreshold</strong>：FIFO 阈值选择，可选4 种状态分别为FIFO 容量的1/4、1/2、3/4 和满； <ul><li>它设定 DMA_SxFCR 寄存器的 FTH[1:0] 位；DMA_FIFOMode 设置为 DMA_FIFOMode_Disable， 那 DMA_FIFOThreshold 值无效。</li><li>ADC 采集传输不使用FIFO 模式，设置改值无效。</li></ul></li><li><strong>DMA_MemoryBurst</strong>：存储器突发模式选择，可选单次模式、4 节拍的增量突发模式、8 节拍 的增量突发模式或16 节拍的增量突发模式，它设定DMA_SxCR 寄存器的MBURST[1:0] 位的值。 <ul><li>ADC 采集传输是直接模式，要求使用单次模式。</li></ul></li><li><strong>DMA_PeripheralBurst</strong>：外设突发模式选择，可选单次模式、4 节拍的增量突发模式、8 节拍 的增量突发模式或 16 节拍的增量突发模式，它设定 DMA_SxCR 寄存器的 PBURST[1:0] 位的值。 <ul><li>ADC 采集传输是直接模式，要求使用单次模式。</li></ul></li></ul><h3 id="dma-存储器到存储器实验" tabindex="-1"><a class="header-anchor" href="#dma-存储器到存储器实验" aria-hidden="true">#</a> DMA 存储器到存储器实验</h3><ul><li><p>DMA 工作模式多样，具体如何使用需要配合实际传输条件具体分析。接下来我们通过两个实验详细了解 DMA 不同模式下使用的配置，加深我们对 DMA 功能的理解。</p></li><li><p>DMA 运行高效，使用方便，在很多测试实验都会用到，这里先了解 存储器到存储器、存储器到外设这 两种模式，其他功能模式在其他章节会有很多使用到的情况，也会有相关的分析。</p></li><li><p>存储器到存储器模式可以实现数据在两个内存的快速拷贝。我们先定义一个静态的源数据，然后使用 DMA 传输把源数据拷贝到目标地址上，最后对比源数据和目标地址的数据，看看是否传输 准确。</p></li></ul><h4 id="编程要点-3" tabindex="-1"><a class="header-anchor" href="#编程要点-3" aria-hidden="true">#</a> 编程要点</h4><ul><li>使能 DMA 数据流时钟 并 复位初始化 DMA 数据流；</li><li>配置 DMA 数据流参数；</li><li>使能数据流进行传输；</li><li>等待传输完成，并对源数据和目标地址数据进行比较；</li></ul><h4 id="代码实现-1" tabindex="-1"><a class="header-anchor" href="#代码实现-1" aria-hidden="true">#</a> 代码实现</h4><p><code>bsp_dma.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_DEBUG_DMA_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_DEBUG_DMA_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>

<span class="token comment">//数据流0</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_STREAM</span> 			 <span class="token expression">DMA2_Stream0</span></span>
<span class="token comment">//通道0</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_CHANNEL</span> 		 <span class="token expression">DMA_Channel_0</span></span>
<span class="token comment">//DMA2 时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_STREAM_CLOCK</span> <span class="token expression">RCC_AHB1Periph_DMA2</span></span>
<span class="token comment">//数据流0传输完成中断标志</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_FLAG_TCIF</span>         <span class="token expression">DMA_FLAG_TCIF0</span></span>

<span class="token comment">//要传输的数据大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span>				<span class="token expression"><span class="token number">32</span></span></span>
<span class="token comment">//超时时间</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMEOUT_MAX</span>			<span class="token expression"><span class="token number">10000</span></span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> aSRC_Const_Buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//DMA 传输目标存储器</span>
<span class="token keyword">extern</span> <span class="token class-name">uint32_t</span> aDST_Buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">DMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">BufferCompare</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>pBuffer1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>pBuffer2<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> BufferLenth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_DEBUG_DMA_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_dma.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_dma.h&quot;</span></span>


<span class="token keyword">void</span> <span class="token function">DMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	DMA_InitTypeDef DMA_InitStructure<span class="token punctuation">;</span>
	
	__IO <span class="token class-name">uint32_t</span> timeout <span class="token operator">=</span> TIMEOUT_MAX<span class="token punctuation">;</span>
	
	<span class="token comment">//使能 DMA 时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>DMA_STREAM_CLOCK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//复位初始化 DMA 数据流</span>
	<span class="token function">DMA_DeInit</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//确保 DMA 数据流复位完成</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DMA_GetCmdStatus</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span> <span class="token operator">!=</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//DMA 数据流通道选择</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Channel <span class="token operator">=</span> DMA_CHANNEL<span class="token punctuation">;</span>
	<span class="token comment">//源数据地址</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>aSRC_Const_Buffer<span class="token punctuation">;</span>
	<span class="token comment">//目标地址</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Memory0BaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span> aDST_Buffer<span class="token punctuation">;</span>
	<span class="token comment">//存储器到存储器模式</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_DIR <span class="token operator">=</span> DMA_DIR_MemoryToMemory<span class="token punctuation">;</span>
	<span class="token comment">//要传输的数据大小</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_BufferSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>BUFFER_SIZE<span class="token punctuation">;</span>
	<span class="token comment">//使能数据源指针自动递增</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralInc <span class="token operator">=</span> DMA_PeripheralInc_Enable<span class="token punctuation">;</span>
	<span class="token comment">//使能目标地址自动递增</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryInc <span class="token operator">=</span> DMA_MemoryInc_Enable<span class="token punctuation">;</span>
	<span class="token comment">//这里应该是指定每次传输的数据大小？设置为 1字（32位=4字节）</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralDataSize <span class="token operator">=</span> DMA_PeripheralDataSize_Word<span class="token punctuation">;</span>
	<span class="token comment">//这里应该是指定每次传输的数据大小？设置为 1字（32位=4字节）</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryDataSize <span class="token operator">=</span> DMA_MemoryDataSize_Word<span class="token punctuation">;</span>
	<span class="token comment">//一次传输模式，存储器到存储器 不能使用循环传输</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Mode <span class="token operator">=</span> DMA_Mode_Normal<span class="token punctuation">;</span>
	<span class="token comment">//DMA 数据流优先级为高</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Priority <span class="token operator">=</span> DMA_Priority_High<span class="token punctuation">;</span>
	<span class="token comment">//禁用 FIFO 模式</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOMode <span class="token operator">=</span> DMA_FIFOMode_Disable<span class="token punctuation">;</span>
	<span class="token comment">//设置阈值为 满（4/4）</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOThreshold <span class="token operator">=</span> DMA_FIFOThreshold_Full<span class="token punctuation">;</span>
	<span class="token comment">//单次模式</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryBurst <span class="token operator">=</span> DMA_MemoryBurst_Single<span class="token punctuation">;</span>
	<span class="token comment">//单次模式</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBurst <span class="token operator">=</span> DMA_PeripheralBurst_Single<span class="token punctuation">;</span>
	
	<span class="token comment">//初始化DMA</span>
	<span class="token function">DMA_Init</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span><span class="token operator">&amp;</span>DMA_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//清除 DMA 数据流传输完成标志位			//传输完成标志位、半传输标志位、FIFO 错误标志位、传输错误标志位 以及直接模式错误标志位。</span>
	<span class="token function">DMA_ClearFlag</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span> DMA_FLAG_TCIF<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能 DMA 数据流，开始 DMA 数据流传输</span>
	<span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//等待 DMA 传输结束 或 超时</span>
	timeout <span class="token operator">=</span> TIMEOUT_MAX<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">DMA_GetCmdStatus</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span> <span class="token operator">!=</span> ENABLE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timeout<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">BufferCompare</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>pBuffer1<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>pBuffer2<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> BufferLenth<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>BufferLenth<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>pBuffer1 <span class="token operator">!=</span> <span class="token operator">*</span>pBuffer2<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		pBuffer1<span class="token operator">++</span><span class="token punctuation">;</span>
		pBuffer2<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_dma.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token keyword">const</span> <span class="token class-name">uint32_t</span> aSRC_Const_Buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token number">0x01020304</span><span class="token punctuation">,</span><span class="token number">0x05060708</span><span class="token punctuation">,</span><span class="token number">0x090A0B0C</span><span class="token punctuation">,</span><span class="token number">0x0D0E0F10</span><span class="token punctuation">,</span>
			<span class="token number">0x11121314</span><span class="token punctuation">,</span><span class="token number">0x15161718</span><span class="token punctuation">,</span><span class="token number">0x191A1B1C</span><span class="token punctuation">,</span><span class="token number">0x1D1E1F20</span><span class="token punctuation">,</span>
			<span class="token number">0x21222324</span><span class="token punctuation">,</span><span class="token number">0x25262728</span><span class="token punctuation">,</span><span class="token number">0x292A2B2C</span><span class="token punctuation">,</span><span class="token number">0x2D2E2F30</span><span class="token punctuation">,</span> 
			<span class="token number">0x31323334</span><span class="token punctuation">,</span><span class="token number">0x35363738</span><span class="token punctuation">,</span><span class="token number">0x393A3B3C</span><span class="token punctuation">,</span><span class="token number">0x3D3E3F40</span><span class="token punctuation">,</span> 
			<span class="token number">0x41424344</span><span class="token punctuation">,</span><span class="token number">0x45464748</span><span class="token punctuation">,</span><span class="token number">0x494A4B4C</span><span class="token punctuation">,</span><span class="token number">0x4D4E4F50</span><span class="token punctuation">,</span> 
			<span class="token number">0x51525354</span><span class="token punctuation">,</span><span class="token number">0x55565758</span><span class="token punctuation">,</span><span class="token number">0x595A5B5C</span><span class="token punctuation">,</span><span class="token number">0x5D5E5F60</span><span class="token punctuation">,</span> 
			<span class="token number">0x61626364</span><span class="token punctuation">,</span><span class="token number">0x65666768</span><span class="token punctuation">,</span><span class="token number">0x696A6B6C</span><span class="token punctuation">,</span><span class="token number">0x6D6E6F70</span><span class="token punctuation">,</span>
			<span class="token number">0x71727374</span><span class="token punctuation">,</span><span class="token number">0x75767778</span><span class="token punctuation">,</span><span class="token number">0x797A7B7C</span><span class="token punctuation">,</span><span class="token number">0x7D7E7F80</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//DMA 传输目标存储器</span>
<span class="token class-name">uint32_t</span> aDST_Buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	<span class="token comment">//初始化 LED</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//点亮两个灯</span>
	<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9 <span class="token operator">|</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//DMA 传输配置</span>
	<span class="token function">DMA_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//等待 DMA 传输完成</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DMA_GetFlagStatus</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span> DMA_FLAG_TCIF<span class="token punctuation">)</span> <span class="token operator">==</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//对比 源数据 和 目标数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">BufferCompare</span><span class="token punctuation">(</span>aSRC_Const_Buffer<span class="token punctuation">,</span> aDST_Buffer<span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//相等，绿灯</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token comment">//不相等，红灯</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="dma-存储器到外设实验" tabindex="-1"><a class="header-anchor" href="#dma-存储器到外设实验" aria-hidden="true">#</a> DMA 存储器到外设实验</h3><p>DMA 存储器到外设传输模式非常方便，把存储器数据传输外设数据寄存器中， 这在 STM32 芯片 向其他目标主机，比如电脑、另外一块开发板或者功能芯片，发送数据是非常有用的。RS-232 串口通信是我们常用开发板与 PC 端通信的方法。</p><ul><li>我们可以使用 DMA 传输把指定的存储器数据转移到USART 数据寄存器内，并发送至PC 端，在串口调试助手显示。</li></ul><h4 id="硬件设计-3" tabindex="-1"><a class="header-anchor" href="#硬件设计-3" aria-hidden="true">#</a> 硬件设计</h4><p>存储器到外设模式使用到 USART1 功能，具体电路设置参考USART 章节，无需其他硬件设计。</p><h4 id="软件设计-3" tabindex="-1"><a class="header-anchor" href="#软件设计-3" aria-hidden="true">#</a> 软件设计</h4><p>我们编写两个串口驱动文件bsp_usart_dma.c 和bsp_usart_dma.h，有关串口和DMA 的宏定义以及驱动函数都在里边。</p><h4 id="编程要点-4" tabindex="-1"><a class="header-anchor" href="#编程要点-4" aria-hidden="true">#</a> 编程要点</h4><ul><li>配置 USART 通信</li><li>设置 DMA 为存储器到外设模式，设置数据流通道，指定 USART 寄存器为目标地址，循环发送模式</li><li>使能 DMA 数据流</li><li>使能 USART 的 DMA 发送请求</li><li>DMA 传输同时 CPU 可以运行其它任务</li></ul><h4 id="代码实现-2" tabindex="-1"><a class="header-anchor" href="#代码实现-2" aria-hidden="true">#</a> 代码实现</h4><p><code>bsp_usart_dma.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_USART_DMA_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_USART_DMA_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_USART_DR_BASE</span>  			<span class="token expression"><span class="token punctuation">(</span>USART1_BASE <span class="token operator">+</span> <span class="token number">0x04</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//数据流7</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_STREAM</span> 			 					<span class="token expression">DMA2_Stream7</span></span>
<span class="token comment">//通道4</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_CHANNEL</span> 		 					<span class="token expression">DMA_Channel_4</span></span>
<span class="token comment">//DMA2 时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DMA_STREAM_CLOCK</span>					<span class="token expression">RCC_AHB1Periph_DMA2</span></span>
<span class="token comment">//要传输的数据大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SENDBUFF_SIZE</span>							<span class="token expression"><span class="token number">27</span></span></span>

<span class="token keyword">extern</span> <span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">USART_DMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_DEBUG_DMA_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_usart_dma.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">USART_DMA_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">//开启 DMA 时钟</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>DMA_STREAM_CLOCK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	DMA_InitTypeDef DMA_InitStructure<span class="token punctuation">;</span>
	
	<span class="token comment">//复位初始化 DMA 数据流</span>
	<span class="token function">DMA_DeInit</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//确保 DMA 数据流复位完成</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DMA_GetCmdStatus</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span> <span class="token operator">!=</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//USART TX 对应 DMA 通道4，数据流7</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Channel <span class="token operator">=</span> DMA_CHANNEL<span class="token punctuation">;</span>
	<span class="token comment">//设置目标地址为：串口数据寄存器地址</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBaseAddr <span class="token operator">=</span> DEBUG_USART_DR_BASE<span class="token punctuation">;</span>
	<span class="token comment">//设置 数据源：要传输的变量指针</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Memory0BaseAddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>SEND_BUFFER<span class="token punctuation">;</span>
	<span class="token comment">//传输方向：存储器到外设</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_DIR <span class="token operator">=</span> DMA_DIR_MemoryToPeripheral<span class="token punctuation">;</span>
	<span class="token comment">//NDTR寄存器，数据项数，即数据长度</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_BufferSize <span class="token operator">=</span> SENDBUFF_SIZE<span class="token punctuation">;</span>
	<span class="token comment">//外设地址不自增</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralInc <span class="token operator">=</span> DMA_PeripheralInc_Disable<span class="token punctuation">;</span>
	<span class="token comment">//内存地址自增</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryInc <span class="token operator">=</span> DMA_MemoryInc_Enable<span class="token punctuation">;</span>
	<span class="token comment">//内存数据宽度（单位）</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralDataSize <span class="token operator">=</span> DMA_PeripheralDataSize_Byte<span class="token punctuation">;</span>
	<span class="token comment">//外设数据宽度（单位）</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryDataSize <span class="token operator">=</span> DMA_MemoryDataSize_Byte<span class="token punctuation">;</span>
	<span class="token comment">//DMA 模式：循环模式					//一次模式就是传输完成一次就停止传输了，下一次传输需要手动控制。而循环模式在传输完成一次后 会自动按照相同配置重新传输，周而复始直至被控制停止 或 传输发生错误。</span>
	<span class="token comment">//因为无限重复传输，可能会导致调试工具无法响应</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Mode <span class="token operator">=</span> DMA_Mode_Circular<span class="token punctuation">;</span>
	<span class="token comment">//优先级：中</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_Priority <span class="token operator">=</span> DMA_Priority_Medium<span class="token punctuation">;</span>
	<span class="token comment">//禁用 FIFO</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOMode <span class="token operator">=</span> DMA_FIFOMode_Disable<span class="token punctuation">;</span>
	<span class="token comment">//FIFO 阈值，满 4/4 ，禁用了FIFO，应该是没有意义的</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_FIFOThreshold <span class="token operator">=</span> DMA_FIFOThreshold_Full<span class="token punctuation">;</span>
	<span class="token comment">//存储器突发传输：单次</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_MemoryBurst <span class="token operator">=</span> DMA_MemoryBurst_INC16<span class="token punctuation">;</span>
	<span class="token comment">//外设突发传输：单次</span>
	DMA_InitStructure<span class="token punctuation">.</span>DMA_PeripheralBurst <span class="token operator">=</span> DMA_PeripheralBurst_Single<span class="token punctuation">;</span>
	<span class="token comment">//初始化DMA 2的数据流7</span>
	<span class="token function">DMA_Init</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span><span class="token operator">&amp;</span>DMA_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//使能 DMA</span>
	<span class="token function">DMA_Cmd</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//在存储器与外设传输中，这可能只是确保配置生效，还需要在USART_CR3 寄存器使能传输</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">DMA_GetCmdStatus</span><span class="token punctuation">(</span>DMA_STREAM<span class="token punctuation">)</span> <span class="token operator">!=</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	
	<span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//初始化 LED</span>
	<span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//配置 USART</span>
	<span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//DMA 传输配置</span>
	<span class="token function">USART_DMA_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\tUSART 1 DMA TX Test\t\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SENDBUFF_SIZE <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		SEND_BUFFER<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span><span class="token operator">+</span>i<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\n&#39;</span><span class="token punctuation">;</span>
	
	<span class="token comment">//第二个参数可选：USART_DMAReq_Tx(DMA 使能发送器)、USART_DMAReq_Rx(DMA 使能接收器)</span>
	<span class="token comment">//运行该函数后USART 的DMA 发送传输就开始了，根据配置它会通过USART 循环发送数据。</span>
	<span class="token comment">//DMA 传输过程是不占用CPU 资源的，可以一边传输一次运行其他任务。</span>
	<span class="token function">USART_DMACmd</span><span class="token punctuation">(</span>DEBUG_USART<span class="token punctuation">,</span>USART_DMAReq_Tx<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_9 <span class="token operator">|</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOF<span class="token punctuation">,</span>GPIO_Pin_9 <span class="token operator">|</span> GPIO_Pin_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="下载验证-2" tabindex="-1"><a class="header-anchor" href="#下载验证-2" aria-hidden="true">#</a> 下载验证</h4><ul><li><p>保证开发板相关硬件连接正确，用 USB 线连接开发板“USB_232”接口跟电脑，在电脑端打开串口调试助手，把编译好的程序下载到开发板。程序运行后在串口调试助手可接收到大量的数据，同时开发板上 LED 不断闪烁。</p></li><li><p>这里要注意为演示 DMA 持续运行并且CPU 还能处理其它事情，持续使用DMA 发送数据，量非常大，长时间运行可能会导致电脑端串口调试助手会卡死，鼠标乱飞的情况，所以在测试时最好把串口调试助手的自动清除接收区数据功能勾选上或把DMA 配置中的循环模式改为单次模式。</p></li><li><p><strong>效果：</strong></p><ul><li>LED在一边以500ms的频率闪烁，串口调试器 在不断的输出内容，并且非常卡顿，证明 在进行DMA传输时，CPU可以同时做其它事情</li></ul></li></ul><h2 id="常用存储器" tabindex="-1"><a class="header-anchor" href="#常用存储器" aria-hidden="true">#</a> 常用存储器</h2><h3 id="存储器种类" tabindex="-1"><a class="header-anchor" href="#存储器种类" aria-hidden="true">#</a> 存储器种类</h3><ul><li><p>存储器是计算机的重要组成部分。</p></li><li><p>存储器是用来存储程序代码和数据的部件，有了存储器，计算机才具有记忆功能。</p></li><li><p>基本存储器类型：</p><ul><li><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210162322696.png" alt="image-20221016232247554" style="zoom:50%;"></li></ul></li><li><p>存储器按其存储介质特性主要分为 “易失性存储器” 和 “非易失性存储器” 两大类。其中的 “易失性” 和 “非易失性” 是指存储器断电后，它存储的数据内容是否会丢失的特性。</p></li><li><p>由于一般易失性存储器存取速度快，而非易失性存储器可长期保存数据，它们都在计算机中占据重要的角色。在计算机中易失性存储器最典型的代表是内存。非易失性存储器的代表则是硬盘。</p></li></ul><h3 id="ram-存储器" tabindex="-1"><a class="header-anchor" href="#ram-存储器" aria-hidden="true">#</a> RAM 存储器</h3><p>RAM 是 “Random Access Memory” 的缩写，被译为 随机存储器。所谓 “随机存取” ，指的是当存储器中的数据被读取或写入时，所需要的时间和这段数据所在的位置无关。这个词的由来是因为早前计算机曾使用磁鼓作为存储器，磁鼓时顺序读写设备，而 RAM 可随时读取其内部任意地址的数据，时间都是相同的，因此得名。实际上现在 RAM 已经用于指代作为计算机内存的易失性存储器。</p><p>根据 RAM 存储机制，又分为动态随机存储器 DRAM(Dynamic RAM) 及静态随机存储器 SRAM(Static RAM) 两种。</p><h4 id="dram" tabindex="-1"><a class="header-anchor" href="#dram" aria-hidden="true">#</a> DRAM</h4><p>动态随机存储器 DRAM 的存储单元以电容的电荷来表示数据，有电荷代表1 ，无电荷代表0 。</p><p>但时间一长，代表1的电容会放电，代表0的电容会吸收电荷，因此它需要定期刷新操作，这就是 “动态（Dynamic ）” 一词所形容的特性。</p><p>刷新操作会对电容进行检查，若电量大于 满电 的 1/2，则认为其代表1，并把电容充满电；若小于 1/2 ，则认为其代表0名，并把电容放电，以此来保证数据的正确性。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210162344289.png" alt="image-20221016234417182" style="zoom:50%;"><h4 id="sram" tabindex="-1"><a class="header-anchor" href="#sram" aria-hidden="true">#</a> SRAM</h4><p>根据 DRAM 的通讯方式，又分为同步和异步两种，这两种方式根据通讯时是否需要使用时钟信号来区分。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210162347505.png" alt="image-20221016234705334"></p><ul><li>上图 时一种利用时钟进行同步的通讯时序，它在时钟的上升沿表示有效数据。</li><li>由于使用时钟同步的通讯速度更快，所以同步 DRAM 使用更为广泛，这种 DRAM 被称为 SDRAM（Synchronous DRAM）</li></ul><h4 id="ddr-sdram" tabindex="-1"><a class="header-anchor" href="#ddr-sdram" aria-hidden="true">#</a> DDR SDRAM</h4><p>为了进一步提高 SDRAM 的通讯速度，人们设计了 DDR SDRAM 存储器（Double Data Rate SDRAM）。它的存储特性与 SDRAM 没有区别，但 SDRAM 只在上升沿表示有效数据，在一个时钟周期内，只能表示 1 位数据；</p><p>而DDR SDRAM 在时钟的上升沿及下降沿各表示一个数据，也就是说在一个时钟周期内可以表示 2 位数据，在时钟频率同样的情况下，提高了一倍的速度。</p><p>至于 DDRII 和 DDRIII ，它们的通讯方式并没有区别，主要是通讯同步时钟的频率提高了。</p><p>当前个人计算机常用的内存条是 DDRIII SDRAM 存储器，在一个内存条上包含 多个 DDRIII SDRAM 芯片。</p><h4 id="sram-1" tabindex="-1"><a class="header-anchor" href="#sram-1" aria-hidden="true">#</a> SRAM</h4><p>静态随机存储器 SRAM 的存储单元以锁存器来存储数据，这种电路结构不需要定时刷新充电放电，就能保持状态（当然，如果断电了，数据还是会丢失），所以这种存储器被称为 “静态（Static）” RAM。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210170002715.png" alt="image-20221017000226537" style="zoom:33%;"><ul><li>同样地，SRAM 根据其通讯方式也分为 同步（SSRAM）和异步（SRAM），相对来说，异步SDRAM用得比较多。</li></ul><h4 id="dram-与-sram-的应用场合" tabindex="-1"><a class="header-anchor" href="#dram-与-sram-的应用场合" aria-hidden="true">#</a> DRAM 与 SRAM 的应用场合</h4><p>对比 DRAM 与 SRAM 的结构，可知 DRAM 的结构简单得多，所以生产相同容量的存储器，DRAM 的成本要更低 且 集成度更高。而 DRAM 中的电容结构则决定了它的存取速度不如 SRAM 。</p><p>DRAM 与 SRAM 特性对比：</p><table><thead><tr><th>特性</th><th>DRAM</th><th>SRAM</th></tr></thead><tbody><tr><td>存取速度</td><td>较慢</td><td>较快</td></tr><tr><td>集成度</td><td>较高</td><td>较低</td></tr><tr><td>生产成本</td><td>较低</td><td>较高</td></tr><tr><td>是否需要刷新</td><td>是</td><td>否</td></tr></tbody></table><p>所以在实际应用场合中，SRAM 一般只用于 CPU内部的高速缓存（Cache），而外部扩展的内存一般使用 DRAM。</p><p>在 STM32429 型号或更高级的芯片才支持扩展 SDRAM ，其它型号如 STM32F1、STM32F2 及 STM32F407 等型号只能扩展 SRAM。</p><h3 id="非易失性存储器" tabindex="-1"><a class="header-anchor" href="#非易失性存储器" aria-hidden="true">#</a> 非易失性存储器</h3><p>非易失性存储器种类比较多，半导体类的有 ROM 和 Flash，而其他的则包括 光盘、软盘 及 机械硬盘。</p><h4 id="rom-存储器" tabindex="-1"><a class="header-anchor" href="#rom-存储器" aria-hidden="true">#</a> ROM 存储器</h4><p>ROM 是 “Read Only Memory” 的缩写，意为只能读的存储器。由于技术的发展，后来设计出了可以方便写入数据的 ROM，而这个 “Read Only Memory” 的名称被沿用下来了，现在一般用于指代 非易失性半导体存储器，包括后面介绍的 Flash 存储器，有些人也把它归到 ROM 类里面。</p><p><strong>MASK ROM</strong></p><p>MASK（掩膜）ROM 就是正宗的 ”Read Only Memory“ ，存储器在它内部的数据是在出厂时使用特殊工艺固化的，生产后不可修改，其主要优势是大批量生产时成本低。当前在生产量大，数据不需要修改的场合，还有应用。</p><p><strong>OTPROM</strong></p><p>OTPROM（One Time Programable ROM）是一次可编程存储器。这种存储器出厂时内部并没有资料，用户可以使用专用的编程器将自己的资料写入，但只能写入一次，被写入过后，它的内容不可以再修改。在 NXP 公司生产的控制器芯片中常使用 OTPROM 来存储密钥；</p><p>STM32F407 系列的芯片内部也有一部分的 OTPROM 空间。</p><p><strong>EPROM</strong></p><p>EPROM（Erasable Programmable ROM）可重复擦写的存储器，它解决了 PROM 芯片只能写入一次的问题。这种存储器使用紫外线照射芯片内部擦出数据，擦除和写入都要专门的设备。现在这种存储器基本淘汰，被 EEPROM 取代。</p><p><strong>EEPROM</strong></p><p>EEPROM（Electrically Erasable Programmable ROM）电可擦写存储器。EEPROM 可以重复擦写，它的擦除和写入 都是直接使用电路控制，不需要再使用外部设备来擦写。而且可以按字节为单位修改数据，无需整个芯片擦除。现在主要是用的 ROM 芯片都是 EEPROM。</p><h4 id="flash-存储器" tabindex="-1"><a class="header-anchor" href="#flash-存储器" aria-hidden="true">#</a> Flash 存储器</h4><p>Flash 存储器又被称为闪存，它也是可重复擦写的存储器，部分书籍会把 FLash 存储器称为 Flash ROM ，但它的容量一般比 EEPROM 大得多，且在擦除时，一般以多少个字节为单位。</p><p>如有的 Flash 存储器以 4096 个字节为扇区，最小的擦除单位为一个扇区。根据存储单元电路的不同，Flash 存储器又分为 NOR Flash 和 NAND Flash。</p><ul><li>NOR Flash 和 NAND Flash 特性对比：</li></ul><pre><code>&lt;img src=&quot;https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210170033793.png&quot; alt=&quot;image-20221017003347689&quot; style=&quot;zoom:50%;&quot; /&gt;
</code></pre><ul><li><p>NOR 与 NAND 的共性是在数据写入前都需要有擦除操作，而擦除操作一般是以 “扇区/块” 为单位的。而 NOR 与 ANAD 特性的差别，主要是由于其内部，“地址/数据线” 是否分开导致的。</p></li><li><p>由于 NOR 的地址线和数据线分开，它可以按 “字节” 读写数据，符合CPU的取指、译码、执行要求，所以加入 NOR 上存储了代码指令，CPU 给NOR一个地址，NOR 就能向CPU返回一个数据让CPU执行，中间不需要额外的处理操作。</p></li><li><p>而由于 NAND 的数据和地址线共用，只能按 “块” 来读写数据，假如 NAND 上存储了代码指令，CPU 给 NAND地址后，它无法直接返回该地址的数据，所以不符合 指令译码要求。上图中，<strong>最后一项 “是否支持 XIP” 描述的就是立即执行的特性（eX-ecute In Place）</strong></p></li><li><p>若代码存储在 NAND 上，可以把它先加载到 RAM 上，再由 CPU 执行。所以在功能上，可以认为 NOR 是一种断电后有不会丢失数据的 RAM，但它的擦除单位与 RAM 有区别，且读写速度比 RAM 要慢得多。</p></li><li><p>另外，Flash 的擦除次数是有限的（现在普遍10万次左右），当它的使用接近寿命的时候，可能会出现写操作失败。由于NAND 通常是整块擦写，块内有一位失效 整块都会失效，这杯称为坏块，由于擦写过程复杂，从整体来说 NOR 坏块更少，寿命更长。由于可能存在坏块，所以 Flash 存储器需要 “探测/错误更正（EDC/ECC）”算法来确保数据的正确性。</p></li><li><p>由于两种 Flash 存储器特性的差异，NOR FLASH 一般用在代码存储场合，如嵌入式控制器内部的程序存储空间。而NAND FLASH 一般应用在大数据量存储的场合，包括 SD卡、U盘、固态硬盘 等等，都是NAND FLASH 类型的。</p></li></ul><p>后面我们会了解 RAM、EEPROM、FLASH 存储器读写。</p><h2 id="i2c-读写eeprom" tabindex="-1"><a class="header-anchor" href="#i2c-读写eeprom" aria-hidden="true">#</a> I2C 读写EEPROM</h2><p>本章参考资料： 《STM32F4xx 参考手册》 、 《STM32F4xx 规格书》 、库帮助文档 《stm32f4xx_dsp_stdperiph_lib_um.chm》及《I2C 总线协议》。若对I2C 通讯协议不了解，可先阅读《I2C 总线协议》文档的内容学习。若想了解SMBUS，可阅读《smbus20》文档。关于 EEPROM 存储器，请参考“常用存储器介绍”章节，实验中的 EEPROM，请参考其规格书 《AT24C02》来了解。</p><h3 id="i2c-协议简介" tabindex="-1"><a class="header-anchor" href="#i2c-协议简介" aria-hidden="true">#</a> I2C 协议简介</h3><p>I2C 通讯协议（Inter － Integrated Circuit，内部集成电路）是由Philips 公司开发的，由于它引脚少，硬件实现简单，可扩展性强，不需要 USART、CAN 等通讯协议的外部收发设备，现在被广泛地使用在系统内多个集成电路（IC）间的通讯。</p><p>下面我们分别了解一下 I2C 协议的物理层、协议层。</p><h4 id="物理层-1" tabindex="-1"><a class="header-anchor" href="#物理层-1" aria-hidden="true">#</a> 物理层</h4><p>I2C 通讯设备之间常用连接方式：I2C通讯系统</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240104907.png" alt="image-20221024010454726"></p><p>它的物理层有如下特点：</p><ul><li><p>它是一个支持多设备的总线。“总线” 指多个设备共用的信号线。在一个 I2C 通讯总线中，可连接多个 I2C 通讯设备，支持多个通讯主机及多个通讯从机。</p></li><li><p>一个 I2C 总线只使用两条总线线路，一条双向串行数据线（SDA），一条串行时钟线（SCL）。数据线即用来表示数据，时钟线用于数据收发同步。</p></li><li><p>每个连接到总线的设备都有一个独立的地址，主机可以利用这个地址进行不同设备之间的访问。</p></li><li><p>**总线通过上拉电阻接到电源。根据I2C总线规范，总线空闲时两根线都必须为高。假设主设备A需要启动I2C，他需要在SCL高电平时，将SDA由高电平转换为低电平作为启动信号。由上拉电阻把总线拉成高电平。**当 I2C 设备空闲时，会输出高阻态，而当所有设备都空闲，都输出高阻态时，由上拉电阻把总线拉成高电平。</p></li><li><p><strong>多个主机同时使用总线时，为了防止数据冲突，会利用仲裁方式决定由哪个设备占用总线。</strong></p><ul><li><p>多个主设备可以连接到一个或多个从机。</p></li><li><p>由于 I2C 总线具有线“与”的逻辑功能，SCL 线上只要有一个节点发送低电平，总线上就表现低电平。当所有的节点都发送高电平时，总线才能表现为高电平。</p><ul><li><p>当两个主设备试图通过SDA线路同时发送或接收数据时，同一系统中的多个主设备就会出现问题。</p></li><li><p>为了解决这个问题，每个主设备都需要在发送消息之前检测SDA线是低电平还是高电平；</p><ul><li><p>如果SDA线为低电平，则意味着另一个主设备可以控制总线，并且主设备应等待发送消息；</p></li><li><p>如果SDA线为高电平，则可以安全地发送消息。</p></li></ul></li></ul></li></ul></li><li><p>具有三种传输模式：标准模式传输速率：100kbit/s，快速模式：400kbit/s，高速模式：3.4Mbit/s，但目前大多数 I2C 设备尚不支持高速模式。</p></li><li><p>连接到相同总线的 IC 数量，受到总线的最大电容 400pF 限制。</p></li></ul><h4 id="协议层-1" tabindex="-1"><a class="header-anchor" href="#协议层-1" aria-hidden="true">#</a> 协议层</h4><p><strong>I2C 的协议定义了通讯的 起始地址、停止信号、数据有效性、响应、仲裁、时间同步、地址广播 等环节。</strong></p><h5 id="i2c-基本读写过程" tabindex="-1"><a class="header-anchor" href="#i2c-基本读写过程" aria-hidden="true">#</a> I2C 基本读写过程</h5><p>IC2 通讯过程的基本结构，它的通讯过程见 “主机写数据到从机” 、“主机由从机中读取数据”、“I2C通讯复合格式”</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240109679.png" alt="image-20221024010918603"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240109042.png" alt="image-20221024010925965"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240109993.png" alt="image-20221024010940916"></p><ul><li>这些图表示的是主机和从机通讯时，SDA 线的数据包序列。</li><li>其中 S 表示由主机 I2C 接口产生的传输起始信号，连接到 I2C 总线上的所有从机都会受到这个信号。</li><li>起始信号产生后，所有从机就开始等待主机 紧接下来广播的地址信号（SLAVE_ADDRESS）。</li><li>在 I2C 总线上，每个设备的地址都是唯一的，当主机广播的地址与某个设备地址相同时，这个设备就被选中了，没被选中的设备将会忽略之后的数据信号。根据 I2C 协议，这个从机地址可以是 7位 或 10位。</li><li>在地址位之后，是传输方向的选择位，该位为0时，表示后面的数据传输方向是由主机传输至从机，即主机向从机写数据。改位为1时，则相反，即主机由从机读取数据。</li><li>从机接收到匹配地址后，主机 或 从机 会返回一个应答（ACK） 或 非应答（NACK）信号，只有接收到应答信号后，主机才能继续发送或接收数据。</li><li>若配置的方向传输位为 “写数据” 方向，即第一幅图的情况，广播完地址，接收到应答信号后，主机开始正式向从机传输数据（Data），数据包大小为 8 位，主机每发送完一个字节数据，都要等待从机的应答信号（ACK），重复这个过程，可以向从机传输 N 个数据，这个 N 没有大小限制。当数据传输结束时，主机向从机发送一个停止信号（P），表示不再传输数据。</li><li>若配置的方向传输位为 “读数据” 方向，即第二幅图的情况，广播完地址，接收到应答信号后，从机开始向主机返回数据（Data），数据包大小也为8位，从机每发送完一个数据，都会等待主机的应答信号（ACK），重复这个过程，可以返回 N 个数据，这个 N 也没有大小限制。当主机希望停止接收数据时，就向从机返回一个非应答信号（NACK），则从机自动停止数据传输。</li><li>除了基本的读写，I2C 通讯更常用的是复合格式，即第三幅图的情况，该传输过程有两次起始信号（S）。 <ul><li>一般在第一次传输中，主机通过 SLAVE_ADDRESS 寻找到从设备后，发送一段 “数据”，这段数据通常用于表示从设备内部的 寄存器 或 存储器 地址（注意区分它与SLAVE_ADDRESS的区别）。</li><li>在第二次的传输中，对改地址的内容进行读或写。也就是说，第一次通讯时告诉从机读写地址，第二次则是读写的实际内容。</li></ul></li></ul><p>以上通讯流程中包含的各个信号分解如下：</p><h5 id="通讯的起始信号和停止信号" tabindex="-1"><a class="header-anchor" href="#通讯的起始信号和停止信号" aria-hidden="true">#</a> 通讯的起始信号和停止信号</h5><p>前文中提到的起始（S）和停止（P）信号是两种特殊的状态，见图 “起始信号和停止信号”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240141229.png" alt="image-20221024014111071" style="zoom:50%;"><ul><li>当 SCL 线是高电平时 SDA 线从高电平向低电平切换，这个情况表示通讯的起始。</li><li>当 SCL 线是高电平时 SDA 线由低电平向高电平切换，表示通讯的停止。</li><li><strong>起始和停止信号一般由主机产生。</strong></li></ul><h5 id="数据有效性" tabindex="-1"><a class="header-anchor" href="#数据有效性" aria-hidden="true">#</a> 数据有效性</h5><p>I2C 使用SDA 信号线来传输数据，使用 SCL 信号线进行数据同步，见图 “数据有效性”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240150761.png" alt="image-20221024015058680" style="zoom:33%;"><ul><li>SDA 数据线在 SDL 的每个时钟周期传输一位数据。</li><li><strong>传输时，SCL 为高电平的时候 SDA 表示的数据有效，即此时的 SDA 为高电平时表示数据 “1”，为低电平时表示数据 “0”，当 SCL 为低电平时，SDA 的数据无效，一般在这个时候 SDA 进行电平切换，为下一次表示数据做好准备。</strong></li></ul><p>每次传输数据都以字节为单位，每次传输的字节数不受限制。</p><h5 id="地址及数据方向" tabindex="-1"><a class="header-anchor" href="#地址及数据方向" aria-hidden="true">#</a> 地址及数据方向</h5><p>I2C 总线上的每个设备都有自己的独立地址，主机发起通讯时，通过 SDA 数据线发送设备地址（SLAVE_ADDRESS）来查找从机。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240159519.png" alt="image-20221024015953431" style="zoom:33%;"><ul><li>I2C 协议规定设备地址可以是 7位或10位，实际中 7位的地址应用比较广泛。</li><li>紧跟着设备地址后 第8位或第11位，一个数据传输方向位用来表示数据传输方向。数据方向位为 “1” 表示主机由从机读数据，该位为 “0” 时表示主机向从机写数据。</li><li>数据方向位为 1“读” 时，主机会释放对 SDA 信号线的控制，由从机控制 SDA 信号线，主机接收信号。数据方向位为 0“写” 时，SDA 由主机控制，从机接收信号。</li></ul><h5 id="响应" tabindex="-1"><a class="header-anchor" href="#响应" aria-hidden="true">#</a> 响应</h5><p>I2C 的数据和地址传输都带响应。响应包括 “应答（ACK）” 和 “非应答（NACK）” 两种信号。</p><ul><li><p>作为数据接收端时，当设备（无论主、从机）接收到 I2C 传输的一个字节数据或地址后，若希望对方继续发送数据，则需要向对方发送 “应答（ACK）” 信号，发送方会继续发送一个数据；</p><p>若接收端希望结束数据传输，则向对方发送 “非应答（NACK）” 信号，发送方接收到该信号后会产生一个停止信号，结束信号传输。见图 “响应与非响应数据”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240213055.png" alt="image-20221024021333964" style="zoom:50%;"></li></ul><p>传输时，主机产生时钟，传输完一个8位数据时，数据发送端会释放 SDA 的控制权，由数据接收端控制 SDA，若SDA为高电平，表示非应答信号（NACK），低电平表示应答信号（ACK）</p><h3 id="stm32-的-i2c-特性及架构" tabindex="-1"><a class="header-anchor" href="#stm32-的-i2c-特性及架构" aria-hidden="true">#</a> STM32 的 I2C 特性及架构</h3><p>如果我们直接控制 STM32 的两个 GPIO 引脚，分别用作 SCL 、SDA ，按照上述信号的时序要求，就像控制 LED 灯那样控制引脚的输出（若是接收数据时，读取SDA电平），就可以实现 I2C 通讯。</p><p>同样，假如我们按照 USART 的要求控制引脚，也能实现 USART 通讯。所以只要遵守协议，就是标准的通讯，不管你如何实现它，不管是 ST 生产的控制器还是 ATMEL 生产的存储器，都能按通讯标准交互。</p><p>由于直接控制 GPIO 引脚电平产生时许时，需要由 CPU 控制每个时刻的状态，所以称之为 “软件模拟协议” 方式。</p><p>相对地，还有 “硬件协议” 方式，STM32 的 I2C 片上外设专门负责实现 I2C 通讯协议，只要配置好该外设，它就会自动根据协议要求产生通讯信号，收发数据并缓存起来，CPU 只要检测该位的状态和访问数据寄存器，就能完成数据收发。这种由硬件外设处理 I2C 协议的方式减轻了 CPU的工作，且使软件设计更加简单。</p><h4 id="stm32-的-i2c-外设简介" tabindex="-1"><a class="header-anchor" href="#stm32-的-i2c-外设简介" aria-hidden="true">#</a> STM32 的 I2C 外设简介</h4><p>STM32 的 I2C 外设可用作通讯的主机及从机，支持 100Kbit/s 和 400Kbit/s 的速率，支持 7位、10位 设备地址，支持 DMA 数据传输，并具有数据校验功能。它的 I2C 外设还支持 SMBus 2.0 协议，SMBus 协议与 I2C 类似，主要用于笔记本电脑的电池管理中。感兴趣可以参考《SMBus》文档了解。</p><h4 id="stm32-的-i2c-架构剖析" tabindex="-1"><a class="header-anchor" href="#stm32-的-i2c-架构剖析" aria-hidden="true">#</a> STM32 的 I2C 架构剖析</h4><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210240249743.png" alt="image-20221024024946570" style="zoom:33%;"><h5 id="通讯引脚" tabindex="-1"><a class="header-anchor" href="#通讯引脚" aria-hidden="true">#</a> 通讯引脚</h5><p>I2C 的所有硬件架构都是根据图中左侧 SCL 和 SDA 线展开的（其中的 SMBA 线用于 SMBUS 的警告信号，I2C 通讯没有使用）。</p><ul><li>STM32 芯片有多个 I2C 外设，它们的 I2C 通讯信号引出到不同的 GPIO 引脚上，使用时必须配置到这些指定的引脚，见表 “STM32F4xx的 I2C 的引脚”。</li><li>关于 GPIO 引脚的复用功能，可查阅 《STM32F4xx规格书》，以它为准。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210270022034.png" alt="image-20221027002234735"></p><blockquote><p>注意：其中 PF、PH 端口在 176引脚型号的芯片才有</p></blockquote><h5 id="时钟控制逻辑" tabindex="-1"><a class="header-anchor" href="#时钟控制逻辑" aria-hidden="true">#</a> 时钟控制逻辑</h5><p>SCL 线的时钟信号，由 I2C 接口根据时钟控制寄存器（CCR）控制，控制的参数主要为时钟频率。</p><p>配置 I2C 的CCR 寄存器可以修改通讯速率相关的参数。</p><ul><li>可选择 I2C 通讯的 “标准/快速” 模式，这两个模式速率分别为 100Kbit/s、400Kbit/s。</li><li>在快速模式下，可选择 SCL 时钟的占空比，可选 <code>Tlow / Thigh = 2</code> 或 <code>Tlow / Thigh = 16/9</code> 模式，我们知道 I2C 协议在 SCL 高电平时对 SDA 信号采样，SCL 低电平时 SDA 准备下一个数据，修改 SCL 的高低电平比会影响数据采样，但其实这两个模式的比例差别不大，若不是要求非常严格，这里随便选就可以了。</li><li>CCR 寄存器中，还有一个 12 位的配置因子 CCR，它与 I2C 外设的输入时钟源共同作用，产生 SCL 时钟，STM32 的 I2C 外设都挂载在 APB1 总线上，使用 APB1 的时钟源 PCLK1 = 42MHZ ，SCL 信号线的输出时钟公式如下：</li></ul><p><strong>标准模式：</strong></p><ul><li>$ T_{high} = CCR \times T_{PCLK1} $</li><li>$ T_{low} = CCR \times T_{PCLK1} $</li></ul><p><strong>快速模式，<code>Tlow / Thigh = 2</code> 时：</strong></p><ul><li>$ T_{high} = CCR \times T_{PCLK1} $</li><li>$ T_{low} = 2 \times CCR \times T_{PCLK1} $</li></ul><p><strong>快速模式，<code>Tlow / Thigh = 16 / 9</code> 时：</strong></p><ul><li>$ T_{high} = 9 \times CCR \times T_{PCLK1} $</li><li>$ T_{low} = 16 \times CCR \times T_{PCLK1} $</li></ul><p>例如，我们的 PCLK1 = 42MHZ ，想要 400Kbit/s 的速率，计算方式如下：</p><ul><li><p>PLCK 时钟周期：<code>TPLCK1 = 1 / 42 000 000 = 0.000000023809524(s)</code></p></li><li><p>目标 SCL 时钟周期：<code>TSCL = 1 / 400 000 = 0.0000025（s） </code></p></li><li><p>SCL 时钟周期内的高电平时间：<code>Thigh = TSCL / 3 = 0.000000833333...3...(s)</code> ， （快速模式的<code>Tlow / Thigh = 2</code>模式时，分成3份，因为它们是 1/2 的关系）</p></li><li><p>SCL 时钟周期内的低电平时间：<code>Tlow = 2 * TSCL / 3</code></p></li><li><p>计算 CCR 的值：<code>CCR = Thigh / TPLCK1 = ((1 / 400 000) / 3) / (1/42 000 000) = 0.000000833333...3... / 0.000000023809524(s) = 35 </code></p></li></ul><p><strong>一个时钟周期等于 = 高电平和低电平，高低电平占空比 表示它们在 SCL 的时钟速度下的占比，它们的频率是一样的，都是 400KHZ。</strong></p><p>该结果刚好为整数，所以我们可直接把 CCR 取值为 35，这样 I2C 的 SCL 实际频率即为 400MHZ。</p><p>特别地，CCR 寄存器无法配置小数参数，如果配置某个速率算出来的 CCR 的结果为小数的话，需要对结果进行取整，再配置，然后 SCL 的输出频率会跟原目标频率稍微不同，取整后除了 通讯稍慢点 或 稍快一点 以外，不会对 I2C 的标准通讯造成其它影响。</p><h5 id="数据控制逻辑" tabindex="-1"><a class="header-anchor" href="#数据控制逻辑" aria-hidden="true">#</a> 数据控制逻辑</h5><p>I2C 的 SDA 信号主要连接到数据移位寄存器上，数据移位寄存器的数据来源及目标是 数据寄存器(DR)、地址寄存器(OAR) 、PEC 寄存器 以及 SDA 数据线。</p><ul><li><p>当向外发送数据的时候，数据移位寄存器以 “数据寄存器” 为数据源，把数据一位一位地通过 SDA 信号线发送出去；</p></li><li><p>当从外部接收数据的时候，数据移位寄存器把 SDA 信号线采样到的数据一位一位地存储到 “数据寄存器中”。</p></li><li><p>当 STM32 的 I2C 工作在从机模式的时候，接收到设备地址信号时（主机广播以与目标从机建立连接），移位数据寄存器会把接收到的地址 与 STM32 的自身的 “I2C地址寄存器”的值作比较，以便响应主机的寻址。STM32 的自身 I2C 地址可通过修改 “自身地址寄存器” 修改，支持同时使用两个 I2C 设备地址，两个地址分别存储在 OAR1 和 OAR2 中。</p></li></ul><h5 id="整体控制逻辑" tabindex="-1"><a class="header-anchor" href="#整体控制逻辑" aria-hidden="true">#</a> 整体控制逻辑</h5><p>整体控制逻辑负责协调整个 I2C 外设，控制逻辑的工作模式根据我们配置的 “控制寄存器（CR1 / CR2）”的参数而改变。</p><p>在外设工作时，控制逻辑会根据外设的工作状态修改 “状态寄存器（SR1 和 SR2）”，我们只要读取这些寄存器相关的寄存器位，就可以了解 I2C 的工作状态了。</p><p>除此之外，控制逻辑还根据要求，负责控制产生 I2C 中断信号，DMA 请求即各种 I2C 通讯信号（起始、停止、响应信号等）。</p><h4 id="通讯过程" tabindex="-1"><a class="header-anchor" href="#通讯过程" aria-hidden="true">#</a> 通讯过程</h4><p>使用 I2C 外设通讯时，在通讯的不同阶段它会对 “状态寄存器（SR1 及 SR2）” 的不同数据位写入参数，我们通过读取这些寄存器标志位来了解通讯状态。</p><h5 id="中断" tabindex="-1"><a class="header-anchor" href="#中断" aria-hidden="true">#</a> 中断</h5><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210270308615.png" alt="image-20221027030814526" style="zoom:33%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210270309604.png" alt="QQ20221027-030858@2x" style="zoom:33%;"><h5 id="主发送器" tabindex="-1"><a class="header-anchor" href="#主发送器" aria-hidden="true">#</a> 主发送器</h5><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210270245483.png" alt="image-20221027024556394" style="zoom:50%;"><p>上图是 “主发送器” 通讯过程，即作为 I2C 的主机端时，向外发送数据时的过程。</p><ul><li><p>控制产生起始信号（S），当发生起始信号后，它产生事件 “EV5”，并会对 SR1 寄存器的 SB 位 置1，表示起始信号已经发送；</p></li><li><p>紧接着发送设备地址并等待应答信号，若有从机应答，则产生事件 “EV6”、“EV8” ，这是 SR1 寄存器的 ADDR 位、TXE 位 被置1，ADDR 为1表示已经发送，TXE 为1 表示数据寄存器为空。</p></li><li><p>以上步骤正常执行并对 ADDR 位清零后，我们往 I2C 的 “数据寄存器DR” 写入要发送的数据，这时 TXE 位会被重置0，表示数据寄存器非空，I2C 外设通过 SDA信号线 一位一位把数据发送出去后，又会产生 “EV8” 事件，即 TXE 位被置1，重复这个过程，就可以发送多个字节数据了。</p></li><li><p>当我们发送数据完成后，控制 I2C 设备产生一个停止信号（P），这时候会产生 EV2 事件，SR1 的 TEX 、BTF 位都被置1，表示通讯结束。</p></li></ul><p>假如我们使能了 I2C 中断，以上所有事件产生时，都会产生 I2C 中断信号，进入同一个中断服务函数，到 I2C 中断服务函数后，再通过检查寄存器位来了解是哪一个事件。</p><h5 id="主接收器" tabindex="-1"><a class="header-anchor" href="#主接收器" aria-hidden="true">#</a> 主接收器</h5><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210270325714.png" alt="image-20221027032510625"></p><p>作为 I2C 通讯的主机端时，从外部接收数据的过程：</p><ul><li><p>同主发送流程，起始信号（S）由主机端产生，控制发生起始信号后，它产生事件 “EV5”，并会对 SR1 寄存器的 SB位 置1，表示起始信号已经发送。</p></li><li><p>紧接着发送设备地址并等待应答信号，若从机应答，则产生 ”EV6“ 信号，这时 SR1 寄存器的 ”ADDR“ 位被置1，表示地址已经发送。</p></li><li><p>从机端接收到地址后，开始向主机端发送数据。当主机端接收到这些数据后，会产生 “EV7” 事件，SR1 寄存器的 PXNE 被置1，表示接收数据寄存器非空，我们读取寄存器后，可对数据寄存器清空，以便接收下一次数据。此时我们可以控制 I2C 发送应答信号（ACK）、非应答（NACK），若应答，重复以上步骤接收数据，若非应答，则停止传输。</p></li><li><p>发送非应答信号后，产生停止信号（P），结束传输。</p></li></ul><p>在发送和接收过程中，有的事件不只是标志了我们上面提到状态位，还可能同时标志主机状态之类的状态位，而且读了之后还需要清除标志位，比较复杂。我们可以使用 STM32 标准库函数来直接检测这些事件的复合标志，降低编程难度。</p><h3 id="i2c-初始化结构体了解" tabindex="-1"><a class="header-anchor" href="#i2c-初始化结构体了解" aria-hidden="true">#</a> I2C 初始化结构体了解</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
  <span class="token comment">//Specifies the clock frequency. This parameter must be set to a value lower than 400kHz</span>
  <span class="token comment">//指定时钟频率。此参数必须设置为低于400kHz的值</span>
  <span class="token class-name">uint32_t</span> I2C_ClockSpeed<span class="token punctuation">;</span>

  <span class="token comment">//Specifies the I2C mode.This parameter can be a value of @ref I2C_mode</span>
  <span class="token comment">//指定I2C模式。此参数可以是@ref I2C_mode的值</span>
  <span class="token class-name">uint16_t</span> I2C_Mode<span class="token punctuation">;</span>

  <span class="token comment">//Specifies the I2C fast mode duty cycle. This parameter can be a value of @ref I2C_duty_cycle_in_fast_mode</span>
  <span class="token comment">//指定I2C快速模式占空比。此参数可以是@ref I2C_duty_cycle_in_fast_mode的值</span>
  <span class="token class-name">uint16_t</span> I2C_DutyCycle<span class="token punctuation">;</span>

  <span class="token comment">//Specifies the first device own address.This parameter can be a 7-bit or 10-bit address.</span>
  <span class="token comment">//指定第一个设备自己的地址。此参数可以是7位或10位地址。</span>
  <span class="token class-name">uint16_t</span> I2C_OwnAddress1<span class="token punctuation">;</span> 

  <span class="token comment">//Enables or disables the acknowledgement.This parameter can be a value of @ref I2C_acknowledgement</span>
  <span class="token comment">//启用或禁用响应。此参数可以是@ref I2C_acknowledgement的值（一般都要使能）</span>
  <span class="token class-name">uint16_t</span> I2C_Ack<span class="token punctuation">;</span>

  <span class="token comment">//Specifies if 7-bit or 10-bit address is acknowledged.This parameter can be a value of @ref I2C_acknowledged_address</span>
  <span class="token comment">//指定是否确认7位或10位地址。此参数可以是@ref I2C_acknowledged_address的值</span>
  <span class="token class-name">uint16_t</span> I2C_AcknowledgedAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span> I2C_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>I2C_ClockSpeed</strong>：本成员设置的是 I2C 的传输速率，在调用初始化函数时，函数会根据我们输入的数值经过运算后把时钟因子写入到 I2C 的时钟控制寄存器 CCR。</p><ul><li><p>而我们写入的这个参数不得高于 400KHz。</p></li><li><p>由于 CCR 寄存器不能写入小数类型的时钟因子，固件库计算 CCR 值会向下取整，影响到 SCL 的实际频率可能会低于本成员设置的参数值，此时除了通讯稍微慢一点以外不会对 I2C 的标准通讯造成其它影响。</p></li></ul></li><li><p><strong>I2C_Mode</strong>：本成员设置选择 I2C 的使用方式，有 I2C 模式（I2C_Mode_I2C）和 SMBus 主、从 模式（I2C_Mode_SMBusHost、I2C_Mode_SMBusDevice）。</p><ul><li>I2C 不需要在此 处 区分主从模式，直接设置 I2C_Mode_I2C 即可。</li></ul></li><li><p><strong>I2C_DutyCycle</strong>：本成员设置的是 I2C 的SCL 线时钟的占空比，该配置有两个选择，分别为低电平时间 比 高电平时间为 2 : 1 （I2C_DuryCycle_2）和 16 : 9 (I2C_DuryCycle_16_9)。</p><ul><li>其实这两个模式的比例差别不大，一般要求都不会如此严格，这里随便选就可以了。</li></ul></li><li><p><strong>I2C_OwnAddress1</strong>：本成员配置的是 STM32 的 I2C 设备自己的地址，每个连接到 I2C 总线上的设备都有一个自己的地址，作为主机也不例外。地址可设置为 7位 或 10位（受下面 I2C_AcknowledgedAddress 成员决定），只要该地址是 I2C 总线唯一的即可。</p><ul><li><p>STM32 的 I2C 外设可同时使用两个地址，即同时对两个地址作出响应，这个结构成员 I2C_OwnAddress1 配置的是默认的 OAR1 寄存器存储的地址。</p></li><li><p>若需要设置第二个地址寄存器 OAR2，可使用 I2C_OwnAddress2Config 函数来配置，OAR2 不支持 10位地址。</p></li></ul></li><li><p><strong>I2C_Ack</strong>：本成员是关于 I2C 应答设置，设置为使能则可以发送响应信号。该成员值一般配置为允许应答（I2C_Ack_Enable），这时绝大多数遵循 I2C 标准的设备的通讯要求，改为禁用应答（I2C_Ack_Disable）往往会导致通讯错误。</p></li><li><p><strong>I2C_AcknowledgedAddress</strong>：本成员选择 I2C 的寻址模式是 7位 还是 10位地址。这需要根据实际连接到 I2C 总线上设备的地址进行选择。这个成员配置也影响到 I2C_OwnAddress1 成员，只有这里设置成 10位模式时，I2C_OwnAddress1 才支持 10位 地址。</p></li></ul><p>配置完这些结构体成员值，调用库函数 I2C_Init 即可把结构体的配置写入到寄存器中。</p><h3 id="i2c-读写-eeprom-实验" tabindex="-1"><a class="header-anchor" href="#i2c-读写-eeprom-实验" aria-hidden="true">#</a> I2C 读写 EEPROM 实验</h3><p>EEPROM 是一种掉电后数据不丢失的存储器，常用来存储一些配置信息，以便系统重新上电的时候重新加载之。</p><p>EEPROM 芯片最常用的通讯方式就是 I2C 协议</p><p>本小节以 EEPROM 的读写实验 了解 STM32 的 I2C 使用方法。</p><p>实验中 STM32 的 I2C 外设采用主模式，分别用作主发送器 和 主接收器，通过查询事件的方式来确保正常通讯。</p><p><strong>at24c02是一种eeprom,电擦除的存储芯片，存储的数据掉电不丢失，实际应用中用来存储版本信息,更新信息等等</strong></p><h4 id="硬件设计-4" tabindex="-1"><a class="header-anchor" href="#硬件设计-4" aria-hidden="true">#</a> 硬件设计</h4><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210272004283.png" alt="QQ20221027-195724@2x" style="zoom:33%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210272009745.png" alt="image-20221027200926661" style="zoom:50%;"><p>本实验板中的 EEPROM 芯片（型号：AT24C02）的 SCL 和 SDA 引脚连接到了 STM32 对应的 I2C 引脚中，结合上拉电阻，构成了 I2C 通讯总线，它们通过 I2C 总线交互。</p><p>EEPROM 芯片的设备地址一共有 7位，其中高4位固定为：1010b（b：二进制），低3位由 A0/A1/A2 信号线的电平决定，见图 EEPROM 设备地址，图中 R/W 是读写方向，与地址无关。</p><ul><li>按照图1的连接，A0/A1/A2 均为0 ，所以 EEPROM 的7位设备地址是 1010000b，即 0x50。</li><li>由于 I2C 通讯时，常常是 地址 跟 读写方向 连在一起构成一个8位数，且当 R/W 位为0时，表示写方向，所以加上 7位地址，其值为 0xA0 ，常称该值为 I2C 设备的 “写地址”；</li><li>当 R/W 位为1时，表示读方向，加上 7位地址，其值为 0xA1 ，常称该值为 “读地址”。</li></ul><p>EEPROM芯片中还有一个 WP 引脚，具有写保护功能，当该引脚电平为高时，禁止写入数据，当引脚为低电平时，可写入数据，此处直接接地，不是用写入保护功能。</p><p>关于 EEPROM 的更多信息，可参考其数据手册 《AT24C02》来了解。</p><p>若使用的实验班 EEPROM 的型号、设备地址 或 控制引脚不一样，只需要修改一些配置即可，程序的控制原理相同。</p><h4 id="软件设计-4" tabindex="-1"><a class="header-anchor" href="#软件设计-4" aria-hidden="true">#</a> 软件设计</h4><p>为了使工程更加有条理，我们把读写 EEPROM 相关的代码独立分开存储，方便以后移植。</p><p>在工程之上，新建 “bsp_i2c_ee.c” 、“bsp_i2c_ee.h” 文件。</p><h4 id="编程要点-5" tabindex="-1"><a class="header-anchor" href="#编程要点-5" aria-hidden="true">#</a> 编程要点</h4><ul><li>配置通讯使用的目标引脚为开漏模式（为什么配置开漏模式？查看名词解释这一章节的一些理解）</li><li>使能 I2C 外设的时钟</li><li>配置 I2C 外设的模式、地址、速率等参数 并使能 I2C 外设</li><li>编写基本 I2C 按字节收发的函数</li><li>编写读写 EEPROM 存储内容的函数</li><li>编写测试程序，对读写数据进行校验</li></ul><h4 id="代码实现-3" tabindex="-1"><a class="header-anchor" href="#代码实现-3" aria-hidden="true">#</a> 代码实现</h4><p><code>bsp_i2c_ee.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_BSP_I2C_EE_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_BSP_I2C_EE_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_i2c.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token comment">// I2C 接口</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C</span>                <span class="token expression">I2C1</span></span>
<span class="token comment">// I2C 时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_CLK</span>            <span class="token expression">RCC_APB1Periph_I2C1</span></span>


<span class="token comment">// SCL 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_PIN</span>        <span class="token expression">GPIO_Pin_8</span></span>
<span class="token comment">// SCL 所在 GPIO</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token comment">// SCL 所在 GPIO 时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_GPIO_CLK</span>   <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token comment">// SCL 源引脚，用于复用到 I2C</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_SOURCE</span>     <span class="token expression">GPIO_PinSource8</span></span>
<span class="token comment">// 选择复用到 I2C</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SCL_AF</span>         <span class="token expression">GPIO_AF_I2C1</span></span>

<span class="token comment">// SDA 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_PIN</span>        <span class="token expression">GPIO_Pin_9</span></span>
<span class="token comment">// SDA 所在 GPIO</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_GPIO_PORT</span>  <span class="token expression">GPIOB</span></span>
<span class="token comment">// SDA 所在 GPIO 时钟</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_GPIO_CLK</span>   <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token comment">// SDA 源引脚，用于复用到 I2C</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_SOURCE</span>     <span class="token expression">GPIO_PinSource9</span></span>
<span class="token comment">// 选择复用到 I2C</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_I2C_SDA_AF</span>         <span class="token expression">GPIO_AF_I2C1</span></span>

<span class="token comment">// I2C 自身地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_OWN_ADDRESS7</span>          <span class="token expression"><span class="token number">0x0A</span></span></span>
<span class="token comment">// I2C 通讯速率</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_Speed</span>                 <span class="token expression"><span class="token number">400000</span></span></span>
<span class="token comment">// EEPROM 设备地址</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_ADDRESS</span>            <span class="token expression"><span class="token number">0xA0</span></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CT_FLAG_TIMEOUT</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x1000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2CT_LONG_TIMEOUT</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">10</span><span class="token operator">*</span>I2CT_FLAG_TIMEOUT<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">I2C_EE_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/*_BSP_I2C_EE_H*/</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_i2c_ee.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bsp : board support package 板级支持包</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_i2c_ee.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">I2C_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 使能 I2C 外设时钟</span>
    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>EEPROM_I2C_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使能 I2C 引脚的 GPIO 时钟</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>EEPROM_I2C_SCL_GPIO_CLK <span class="token operator">|</span> EEPROM_I2C_SDA_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 连接引脚源 PinX 到 I2C_SCL</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>EEPROM_I2C_SCL_GPIO_PORT<span class="token punctuation">,</span> EEPROM_I2C_SCL_SOURCE<span class="token punctuation">,</span> EEPROM_I2C_SCL_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 连接引脚源 PinX 到 I2C_SDA</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>EEPROM_I2C_SDA_GPIO_PORT<span class="token punctuation">,</span> EEPROM_I2C_SDA_SOURCE<span class="token punctuation">,</span> EEPROM_I2C_SDA_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置 SCL 引脚</span>
    GPIO_InitTypeDef GPIP_InitStructure<span class="token punctuation">;</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> EEPROM_I2C_SCL_PIN<span class="token punctuation">;</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_OD<span class="token punctuation">;</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>EEPROM_I2C_SCL_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIP_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置 SDA 引脚</span>
    GPIP_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> EEPROM_I2C_SDA_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>EEPROM_I2C_SDA_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIP_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * I2C 工作模式配置
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">I2C_Mode_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// I2C 配置</span>
    I2C_InitTypeDef I2C_InitStructure<span class="token punctuation">;</span>
    <span class="token comment">// I2C 模式 可选： SMBus</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_Mode <span class="token operator">=</span> I2C_Mode_I2C<span class="token punctuation">;</span>
    <span class="token comment">// 占空比</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_DutyCycle <span class="token operator">=</span> I2C_DutyCycle_2<span class="token punctuation">;</span>
    <span class="token comment">// I2C 自身地址</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_OwnAddress1 <span class="token operator">=</span> I2C_OWN_ADDRESS7<span class="token punctuation">;</span>
    <span class="token comment">// 使能响应</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_Ack <span class="token operator">=</span> I2C_Ack_Enable<span class="token punctuation">;</span>
    <span class="token comment">// I2C 寻址模式</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_AcknowledgedAddress <span class="token operator">=</span> I2C_AcknowledgedAddress_7bit<span class="token punctuation">;</span>
    <span class="token comment">// 通信速率</span>
    I2C_InitStructure<span class="token punctuation">.</span>I2C_ClockSpeed <span class="token operator">=</span> I2C_Speed<span class="token punctuation">;</span>
    <span class="token comment">// 写入配置</span>
    <span class="token function">I2C_Init</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> <span class="token operator">&amp;</span>I2C_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//使能 I2C</span>
    <span class="token function">I2C_Cmd</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * I2C 外设初始化
 */</span>
<span class="token keyword">void</span> <span class="token function">I2C_EE_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">I2C_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Mode_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s！ErrorCode : %d\n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 写一个字节到 I2C EEPROM 中
 * @param pBuffer 缓冲区指针
 * @param writeAddr 写地址
 * @return 正常返回 1，异常返回 0
 */</span>
<span class="token class-name">uint32_t</span> <span class="token function">I2C_EE_ByteWrite</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> writeAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 产生 I2C 起始信号</span>
    <span class="token function">I2C_GenerateSTART</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV5 事件 并清除标志</span>
    <span class="token class-name">uint32_t</span> timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_MODE_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV5 主模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送 EEPROM 设备地址，并设置读 或 写模式</span>
    <span class="token function">I2C_Send7bitAddress</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> EEPROM_ADDRESS<span class="token punctuation">,</span> I2C_Direction_Transmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV6 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV6 主设备传输模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检测 EV8 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_TRANSMITTING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV8 主设备字节传输（应该是传输地址）超时&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">I2C_SendData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> writeAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SendData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV8 事件，并清除标志</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_TRANSMITTING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV8 主设备发送数据超时&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送停止信号</span>
    <span class="token function">I2C_GenerateSTOP</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//等待 Standby    状态的最大次数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">MAX_TRIAL_NUMBER</span>    <span class="token expression"><span class="token number">300</span></span></span>

<span class="token comment">/*
 多字节写入及状态等待 单字节写入通讯结束后，EEPROM 芯片会根据这个通讯结果擦写该内存地址的内容，这需要一段 时间，所以我们在多次写入数据时，要先等待 EEPROM 内部擦写完毕。
 这个函数主要实现是向 EEPROM 发送它设备地址，检测 EEPROM 的响应，若 EEPROM 接收到 地址后返回应答信号，则表示 EEPROM 已经准备好，可以开始下一次通讯。
 函数中检测响应是 通过读取 STM32 的 SR1 寄存器的 ADDR 位及 AF 位来实现的，当 I2C 设备响应了地址的时候， ADDR 会置 1，若应答失败，AF 位会置1。
 */</span>
<span class="token comment">/** 等待 EEPROM 到准备状态，不断的尝试连接它，连接上之后马上断开，返回空闲状态
 *
 * @return
 */</span>
<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    __IO <span class="token class-name">uint16_t</span> tmpSR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    __IO <span class="token class-name">uint32_t</span> EETrials <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token class-name">uint32_t</span> timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">I2C_GetFlagStatus</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_FLAG_BUSY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;I2C 忙&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 产生 I2C 起始信号</span>
        <span class="token function">I2C_GenerateSTART</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//检测 EV5 事件，并清除标志</span>
        timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_MODE_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 发送 EEPROM 设备地址</span>
        <span class="token function">I2C_Send7bitAddress</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> EEPROM_ADDRESS<span class="token punctuation">,</span> I2C_Direction_Transmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取 SR1 寄存器状态</span>
            tmpSR1 <span class="token operator">=</span> EEPROM_I2C<span class="token operator">-&gt;</span>SR1<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;地址发送 或 应答 超时&quot;</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmpSR1 <span class="token operator">&amp;</span> <span class="token punctuation">(</span>I2C_SR1_ADDR <span class="token operator">|</span> I2C_SR1_AF<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//一直等待直到 ADDR 及 AF 标志为 1</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSR1 <span class="token operator">&amp;</span> I2C_SR1_ADDR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 清除 addr 标志，该标志通过读 SR1 及 SR2 清除</span>
            <span class="token comment">/* 为什么读取可以清除寄存器标志位？文档规定的！
             读取 I2C_SR1 后再读取 I2C_SR2 可将 ADDR 标志清零，
             即使 ADDR 标志在读取 I2C_SR1 之后置 1 也如此。
             因此，必须仅在 I2C_SR1 中的 ADDR 位已置 1 或者 STOPF 位已清零后 读取 I2C_SR2。
             */</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> EEPROM_I2C<span class="token operator">-&gt;</span>SR2<span class="token punctuation">;</span>
            <span class="token comment">// 产生停止信号</span>
            <span class="token function">I2C_GenerateSTOP</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 清除 AF 标志</span>
            <span class="token function">I2C_ClearFlag</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_FLAG_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 检查等待次数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>EETrials<span class="token operator">++</span> <span class="token operator">==</span> MAX_TRIAL_NUMBER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//等待 MAX_TRIAL_NUMBER 次都还没准备好，退出等待</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;等待空闲超时！errcode :%d\n&quot;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 一次性写入多个数据，每次写入一个字节，等 EEPROM 写入完毕，接着下一个
 * @param pBuffer
 * @param writeAddr
 * @param NumByteToWrite
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_EE_BytesWrite</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> writeAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> res<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint16_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumByteToWrite<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等待 EEPROM 准备完毕</span>
        <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res <span class="token operator">=</span> <span class="token function">I2C_EE_ByteWrite</span><span class="token punctuation">(</span>pBuffer<span class="token operator">++</span><span class="token punctuation">,</span> writeAddr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 每写入一个数据都需要向 EEPROM 发送写入的地址，我们希望向连续地
 * 址写入多个数据的时候，只要告诉EEPROM 第一个内存地址address1，后面的数据按次序写入到
 * address2、address3…这样可以节省通讯的内容，加快速度。为应对这种需求，EEPROM 定义了一
 * 种页写入时序
 * @param pBuffer
 * @param writeAddr
 * @param NumByteToWrite
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> writeAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> I2CT_LONG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">I2C_GetFlagStatus</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_FLAG_BUSY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;I2C 忙 in I2C_EE_PageWrite&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 产生 I2C 起始信号</span>
    <span class="token function">I2C_GenerateSTART</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV5 事件 并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_MODE_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV5 主模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送 EEPROM 设备地址，并设置读 或 写模式</span>
    <span class="token function">I2C_Send7bitAddress</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> EEPROM_ADDRESS<span class="token punctuation">,</span> I2C_Direction_Transmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV6 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV6 主设备传输模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//根据页写入时序，第一个数据被解释为要写入的内存地址address1，后续可连续发送n 个数据，这些数据会依次写入到内存中</span>
    <span class="token function">I2C_SendData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> writeAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV8 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_TRANSMITTING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV8 主设备字节传输（应该是传输地址）超时&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumByteToWrite<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_SendData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment">// 检测 EV8 事件，并清除标志</span>
        timeout <span class="token operator">=</span> I2CT_LONG_TIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_TRANSMITTING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV8 主设备字节传输（应该是传输地址）超时&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送停止信号</span>
    <span class="token function">I2C_GenerateSTOP</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_PAGESIZE</span> <span class="token expression"><span class="token number">8</span></span></span>

<span class="token comment">/**
 * 缓冲区写入，优先把数据按页对齐，再一页一页的写入
 * @param pBuffer
 * @param ReadAddr
 * @param NumByteToRead
 * @return
 */</span>
<span class="token keyword">void</span> <span class="token function">I2C_EE_BufferWrite</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> WriteAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>    <span class="token comment">// 页数</span>
    <span class="token class-name">uint8_t</span> NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>  <span class="token comment">// 整页多出多少个字节</span>
    <span class="token class-name">uint8_t</span> addr <span class="token operator">=</span> WriteAddr <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>              <span class="token comment">// 求 WriteAddr 是不是整页（整页多出了多少个字节）</span>
    <span class="token class-name">uint8_t</span> count <span class="token operator">=</span> EEPROM_PAGESIZE <span class="token operator">-</span> addr<span class="token punctuation">;</span>                  <span class="token comment">// 如果地址不是整页，这里的值是差多少个字节到整页（用于填充完整页）</span>

    <span class="token comment">// addr = 0 , 则 WriteAddr 地址按 EEPROM_PAGESIZE 是对齐的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果要传输的数据 不足一页</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//否则，先传输页</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//后传输不足一页的数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// WriteAddr 不是按 EEPROM_PAGESIZE 对齐的</span>

    <span class="token comment">//如果要写的页数为0，写入不足一页的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果 WriteAddr 地址不足整页，传输count个数据，count 为 WriteAddr 到 整页的差</span>
    NumByteToWrite <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//先传输页</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//后传输不足一页的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">I2C_EE_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_EE_Wait_EEPROM_StandbyState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_EE_BufferRead</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> ReadAddr<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> NumByteToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> I2CT_LONG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">I2C_GetFlagStatus</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_FLAG_BUSY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;I2C Busy in I2C_EE_BufferRead &quot;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">I2C_GenerateSTART</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV5 事件 并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_MODE_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV5 主模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送 EEPROM 设备地址，并设置读 或 写模式</span>
    <span class="token function">I2C_Send7bitAddress</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> EEPROM_ADDRESS<span class="token punctuation">,</span> I2C_Direction_Transmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV6 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV6 主设备传输模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//发送要读取的 EEPROM 内部地址</span>
    <span class="token function">I2C_SendData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ReadAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV8 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_TRANSMITTING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV8 主设备字节传输（应该是传输地址）超时&quot;</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 产生第二次 I2C 起始信号</span>
    <span class="token function">I2C_GenerateSTART</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV5 事件 并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_MODE_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV5 主模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">54</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 选择接收模式</span>
    <span class="token function">I2C_Send7bitAddress</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> EEPROM_ADDRESS<span class="token punctuation">,</span> I2C_Direction_Receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测 EV6 事件，并清除标志</span>
    timeout <span class="token operator">=</span> I2CT_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;EV6 主接收器模式选择超时&quot;</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumByteToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumByteToRead <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 到最后一个数据时，发送非应答信号</span>
            <span class="token function">I2C_AcknowledgeConfig</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        timeout <span class="token operator">=</span> I2CT_LONG_TIMEOUT<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">I2C_CheckEvent</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> I2C_EVENT_MASTER_BYTE_RECEIVED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">I2C_TIMEOUT_Callback</span><span class="token punctuation">(</span><span class="token string">&quot;I2C 接收模式超时&quot;</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>pBuffer <span class="token operator">=</span> <span class="token function">I2C_ReceiveData</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>
        NumByteToRead<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送停止信号</span>
    <span class="token function">I2C_GenerateSTOP</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使能应答，方便下一次 I2C 传输</span>
    <span class="token function">I2C_AcknowledgeConfig</span><span class="token punctuation">(</span>EEPROM_I2C<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;***************************** Start Write *****************************\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_EE_BytesWrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Write SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;***************************** Start Read *****************************\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EE_BufferRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Read SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Random Write *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> writeBuffer<span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writeBuffer<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">200</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x88</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_EE_BufferWrite</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">,</span> <span class="token number">0xc8</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Random Write SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Start Read *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_EE_BufferRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0x0000</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Read SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_i2c_ee.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//DMA 传输配置</span>
    <span class="token comment">//USART_DMA_Config();</span>

    <span class="token function">I2C_EE_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>多字节写入及状态等待</strong></p><ul><li>单字节写入通讯结束后，EEPROM 芯片会根据这个通讯结果擦写该内存地址的内容，这需要一段 时间，所以我们在多次写入数据时，要先等待 EEPROM 内部擦写完毕。</li><li>使用for 循环调用前面定义的I2C_EE_ByteWrite 函数一个字节一个字节地向EEPROM 发送要写入的数据。在每次数据写入通讯前调用了I2C_EE_WaitEepromStandbyState函数等待EEPROM 内部擦写完毕</li><li>这个函数主要实现是向 EEPROM 发送它设备地址，检测 EEPROM 的响应，若 EEPROM 接收到 地址后返回应答信号，则表示 EEPROM 已经准备好，可以开始下一次通讯。函数中检测响应是 通过读取 STM32 的 SR1 寄存器的 ADDR 位及 AF 位来实现的，当 I2C 设备响应了地址的时候， ADDR 会置 1，若应答失败，AF 位会置1。</li></ul><p><strong>EEPROM 的页写入</strong></p><ul><li>每写入一个数据都需要向 EEPROM 发送写入的地址，我们希望向连续地 址写入多个数据的时候，只要告诉EEPROM 第一个内存地址address1，后面的数据按次序写入到 address2、address3…这样可以节省通讯的内容，加快速度。为应对这种需求，EEPROM 定义了一 种页写入时序，见图EEPROM 页写入时序 。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211031959894.png" alt="image-20221103195934070"></p><ul><li>根据页写入时序，第一个数据被解释为要写入的内存地址address1，后续可连续发送n 个数据，这些数据会依次写入到内存中。其中 <strong>AT24C02 型号的芯片页写入时序最多可以一次发送 8 个数据 (即n = 8)</strong>，该值也称为页大小，某些型号的芯片每个页写入时序最多可传输16 个数据。</li></ul><p><strong>从 EEPROM 读取数据</strong></p><p>从 EEPROM 读取数据是一个复合的 I2C 时序，它实际上包含一个写过程和一个读过程，见图EEPROM 数据读取时序 。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211032002785.png" alt="image-20221103200215572" style="zoom:50%;"><ul><li><p>读时序的第一个通讯过程中，使用I2C 发送设备地址寻址(写方向)，接着发送要读取的“内存地址”；第二个通讯过程中，再次使用 I2C 发送设备地址寻址，但这个时候的数据方向是读方向；</p></li><li><p>在这个过程之后，EEPROM 会向主机返回从“内存地址”开始的数据，一个字节一个字节地传输，只要主机的响应为“应答信号”，它就会一直传输下去，主机想结束传输时，就发送“非应答信号”，并以“停止信号”结束通讯，作为从机的EEPROM 也会停止传输。</p></li><li><p>这段中的写过程跟前面的写字节函数类似，而读过程中接收数据时，需要使用库函数 I2C_ReceiveData 来读取。响应信号则通过库函数 I2C_AcknowledgeConﬁg 来发送，DISABLE 时为非响应信号，ENABLE 为响应信号。</p></li></ul><h5 id="i2c-读写-eeprom-实验总结" tabindex="-1"><a class="header-anchor" href="#i2c-读写-eeprom-实验总结" aria-hidden="true">#</a> I2C 读写 EEPROM 实验总结</h5><p>头文件“stm32f10x_i2c.h”，308行。下面的注释介绍了主模式下的通信流程。总结如下：</p><p><strong>主模式下发送：</strong></p><ol><li>通过函数<code>I2C_GenerateSTART（）</code>发送起始信号。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT));</code> 等待EV5事件发生</li><li>通过函数<code>I2C_Send7bitAddress（）</code>发送从器件地址，注意这个函数的第二个参数 uint8_t Address 是8位地址，即最后的读写位随便设为1和0都行，而不是7位地址，函数名挺误导人。根据是，你可以看看这个函数体的内容，就明白了。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));</code>等待EV6发生</li><li>通过函数<code>I2C_SendData()</code>发送数据，对于EEPROM，这里应该是字地址。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTING));</code>等待EV8发生</li><li>后续数据发送同5和6。对于EEPROM，数据都发送完后，需要给EEPROM几个毫秒来完成内部数据写入。</li><li>通过函数<code>I2C_GenerateSTOP();</code> 发送停止信号，通信结束。</li></ol><p>这里有几点要说明的地方：</p><ul><li><strong>事件EV5表示的是I2C主模式准备就绪，和从器件没有关系。如果程序卡在EV5这，一般是自己I2C没配置好。</strong></li><li><strong>后面的EV6，EV8都是和从器件相关的，表示的内容包含“已接收到从器件的ACK”。当程序卡在这两个地方时，考虑从器件地址有没有写对。比如 EEPROM 设备地址不对，7位设备地址 + 1位读写位</strong></li></ul><p><strong>主模式下接收：</strong></p><ol><li>通过函数<code>I2C_GenerateSTART（）</code>发送起始信号。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT));</code> 等待EV5事件发生</li><li>通过函数<code>I2C_Send7bitAddress（）</code>发送从器件地址。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));</code>等待EV6发生</li><li>通过函数<code>I2C_SendData()</code>发送字地址。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_TRANSMITTING));</code>等待EV8发生</li><li><code>I2C_GenerateSTART（）</code>重新发送起始信号。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_MODE_SELECT));</code> 等待EV5事件发生</li><li>通过函数<code>I2C_Send7bitAddress（）</code>发送从器件地址。</li><li>通过代码<code>while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));</code>等待EV6发生</li><li>接收数据。注意先查EV7，后读数据，以及在接收最后一个字节之前关闭自动应答（即返回NACK）。参考I2C读取标准，在结束接收时（即STOP之前），主器件应返回NACK而不再是ACK。 <code>for(i = 0; i &lt; 8; i++) { while(!I2C_CheckEvent(I2C1, I2C_EVENT_MASTER_BYTE_RECEIVED)); //注意顺序，先查后读 readBuff[i] = I2C_ReceiveData(I2C1); if(i == 6)I2C_AcknowledgeConfig(I2C1, DISABLE);//关闭自动ACK即回复NACK,必要，不然I2C总线不会被释放，EV5过不去 }</code></li><li>通过函数<code>I2C_GenerateSTOP();</code> 发送停止信号，通信结束。</li><li>重新启动自动ACK。<code>I2C_AcknowledgeConfig(I2C1, ENABLE);</code>必要语句，不然程序虽然不会等在while那，但数据接受不对。</li></ol><p>说明：由上述流程看出，接收比发送复杂，更容易出错，主要表现在处理ACK和NACK上，其实理解了I2C读取的时序，这都不是问题。</p><p><strong>I2C的初始化：</strong></p><p>作为外设，当然要初始化GPIO端口复用以及外设本身啦，代码如下：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">I2C1_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
        I2C_InitTypeDef I2C_InitStructure<span class="token punctuation">;</span>
        
        <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_I2C1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_6 <span class="token operator">|</span> GPIO_Pin_7<span class="token punctuation">;</span><span class="token comment">//SCL和SDA</span>
        GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_OD<span class="token punctuation">;</span>
        GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span><span class="token comment">//频率参考“中文参考手册”，标准模式下必须至少为2MHz</span>
        <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        I2C_InitStructure<span class="token punctuation">.</span>I2C_Ack <span class="token operator">=</span> I2C_Ack_Enable<span class="token punctuation">;</span>
        I2C_InitStructure<span class="token punctuation">.</span>I2C_AcknowledgedAddress <span class="token operator">=</span> I2C_AcknowledgedAddress_7bit<span class="token punctuation">;</span>
        I2C_InitStructure<span class="token punctuation">.</span>I2C_ClockSpeed <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span><span class="token comment">//标准速度100k</span>
        I2C_InitStructure<span class="token punctuation">.</span>I2C_DutyCycle <span class="token operator">=</span> I2C_DutyCycle_2<span class="token punctuation">;</span><span class="token comment">//标准速度（100K）下无意义,但还是设置一下</span>
        I2C_InitStructure<span class="token punctuation">.</span>I2C_Mode <span class="token operator">=</span> I2C_Mode_I2C<span class="token punctuation">;</span>
        I2C_InitStructure<span class="token punctuation">.</span>I2C_OwnAddress1 <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span><span class="token comment">//I2C1自身7位地址.因为可以用另一个函数设置双地址，所以此处为Address1</span>
        <span class="token function">I2C_Init</span><span class="token punctuation">(</span>I2C1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>I2C_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">I2C_Cmd</span><span class="token punctuation">(</span>I2C1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明：</p><ul><li><strong>初始化两个时钟的代码必须放在最前面，如果放在后面的话，会导致I2C初始化失败，EV5事件过不去。（吸取教训，以后所有外设初始化时，都先使能时钟）</strong></li><li><strong>GPIO配置为“复用开漏”，I2C硬件要接上拉电阻到指定电压（如3.3V）。</strong></li><li><strong>GPIO_Speed 不管选GPIO_Speed_50MHz，GPIO_Speed_10MHz还是GPIO_Speed_2MHz都没问题，亲测（与24C02通信）。</strong></li><li><strong>I2C_Ack 选择的是“是否使能主器件的自动ACK”，按照I2C标准，必须选I2C_Ack_Enable。想让主器件自动返回NACK时，用函数<code>I2C_AcknowledgeConfig(I2C1, DISABLE);</code>关闭自动ACK即可（不回复ACK即NACK）。关闭后记得重新开启ACK。</strong></li><li><strong>I2C_AcknowledgedAddress表示选择7位还是10位从器件地址</strong></li><li><strong>I2C_ClockSpeed，I2C的标准速度就是100K，快速模式下可达400K，亲测两个速度都能正常工作（与24C02通信）。</strong></li><li><strong>I2C_DutyCycle ，这个没怎么管，大于100K速度下才有意义。亲测两个值都可以（与24C02通信）。</strong></li><li><strong>I2C_Mode ，只用作I2C通信的话，选择I2C_Mode_I2C即可。其他的我也不懂。</strong></li><li><strong>I2C_OwnAddress1，STM32自身的第一个I2C地址，可通过其他函数设置双地址，这里不提。这个只有在STM32作为从设备时才有意义，但这种场合应该非常少见，MCU之间的通信用串口或者CAN就行，不应该用I2C。</strong></li></ul><p><strong>最后说下调试中遇到的问题以及解决办法：</strong></p><ul><li>我刚开始配置硬件I2C时，为了便于观察结果，加入了外设LCD，用的驱动程序是正点原子提供的。结果程序始终卡在EV5，后来发现LCD用到了外设fsmc，而I2C1的SDA线在PB7口，PB7还可以复用为FSMC_NADV，导致SDA被占用，初始化失败。解决方法是不再用LCD调试，而选择用串口来观察结果。</li><li><strong>后来程序又卡在EV6，后来发现是从设备地址填错了，我填的是不包含读/写位的7位地址。。。改成8位地址后解决问题。</strong></li><li>后来发现，读完24C02的数据后，I2C无法重新START即卡在后面的EV5上。解决方案是用<code>I2C_AcknowledgeConfig(I2C1, DISABLE);</code>设置好NACK，然后再STOP，I2C通信正常结束且可再次重启。</li><li><strong>I2C 寄存器写入不成功，最后发现 使能时钟搞错了，I2C 挂载在APB1总线下，我初始化成 AHB了</strong></li><li><strong>我的单片机 STM32F407 它有多个 I2C 外设，比如 I2C1 SCL 为PB6 SDA为 PB7，重映射到了 PB8和PB9，使用 PB6和PB7 发送数据时 I2C_FLAG_BUSY 标志位为1，卡住了。最后发现 是因为 虽然它们都连接到了I2C 但是 EEPROM 连接到的是 PB8和PB9。</strong></li></ul><h5 id="软件模拟-i2c-和读写-eeprom" tabindex="-1"><a class="header-anchor" href="#软件模拟-i2c-和读写-eeprom" aria-hidden="true">#</a> 软件模拟 I2C 和读写 EEPROM</h5><p><code>i2c.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLO_I2C_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLO_I2C_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SCL_OUT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">GPIO_WriteBit</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_8<span class="token punctuation">,</span> x<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SDA_OUT</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">GPIO_WriteBit</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">,</span> x<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCL_IN</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_8<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SDA_IN</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_Pin_9<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">IIC_SCL_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIOMode_TypeDef mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">IIC_ack</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ack<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> txd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">IIC_read_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">AT24C02_write_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">uint8_t</span> <span class="token function">AT24C03_read_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">AT24C02_read_page</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pdata<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SS_EE_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">I2C_SS_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HELLO_I2C_H</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>i2c.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;I2C.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdio.h&quot;</span></span>



<span class="token keyword">void</span> <span class="token function">IIC_SCL_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_8<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIOMode_TypeDef mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 起始信号
 * 当 SCL 线是高电平时 SDA 线从高电平向低电平切换，这个情况表示通讯的起始。
 */</span>
<span class="token keyword">void</span> <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置数据线为输出模式</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//总线空闲</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//拉低数据线</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//SCL 拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 停止信号
 * 当 SCL 线是高电平时 SDA 线由低电平向高电平切换，表示通讯的停止。
 */</span>
<span class="token keyword">void</span> <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置数据线为输出模式</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SCL 拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拉低SDA</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 松开 SCL</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待数据写入，太快会应答失败！</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 等待ACK 1-无效 0-有效
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 数据线设置为输入</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拉高时钟线，使从设备可以控制数据线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取数据线电平</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>SDA_IN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//无效应答</span>
        ack <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// SCL拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 产生 有效/无效 应答
 * 传输时，主机产生时钟，传输完一个8位数据时，数据发送端会释放 SDA 的控制权，
 * 由数据接收端控制 SDA，若SDA为高电平，表示非应答信号（NACK），低电平表示应答信号（ACK）
 * @param ack 1-无效应答 0-有效应答
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">IIC_ack</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数据线设置为输出</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SCL拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 ACK</span>
    <span class="token function">SDA_OUT</span><span class="token punctuation">(</span>ack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//保持数据稳定</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SCL拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 发送一个字节数据
 * @param txd
 */</span>
<span class="token keyword">void</span> <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> txd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 数据线设置为输出模式</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// SCL拉低钳住总线</span>
    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>txd <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// SCL 为高电平的时候 SDA 表示的数据有效</span>
        <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// SCL拉低钳住总线</span>
        <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">IIC_read_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> rxd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 数据线设置为输入</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// SCL 为高电平的时候 SDA 表示的数据有效</span>
        <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>SDA_IN<span class="token punctuation">)</span>rxd <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// SCL拉低钳住总线</span>
        <span class="token function">SCL_OUT</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> rxd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 往 AT24C02 写一个字节
 * @param addr 写入的目标地址
 * @param data 数据
 */</span>
<span class="token keyword">void</span> <span class="token function">AT24C02_write_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//发送从设备地址和写信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送写入的字节地址</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送写入的数据</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 3\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//停止信号</span>
    <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">AT24C03_read_byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> data<span class="token punctuation">;</span>
    <span class="token comment">// 发送起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//发送从设备地址和写信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送要读的字节地址</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 再次发送起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送设备地址和读信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 读取一个字节数据</span>
    data <span class="token operator">=</span> <span class="token function">IIC_read_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 无效应答，结束读取</span>
    <span class="token function">IIC_ack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送停止信号</span>
    <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pData<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送设备地址和读信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送写入的目标字节地址</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token operator">*</span>pData<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待 ACK</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 3\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 停止信号</span>
    <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_PAGESIZE</span> <span class="token expression"><span class="token number">8</span></span></span>

<span class="token comment">/**
 * 缓冲区写入，优先把数据按页对齐，再一页一页的写入
 * @param pBuffer
 * @param ReadAddr
 * @param NumByteToRead
 * @return
 */</span>
<span class="token keyword">void</span> <span class="token function">I2C_SS_EE_BufferWrite</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> WriteAddr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>    <span class="token comment">// 页数</span>
    <span class="token class-name">uint8_t</span> NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>  <span class="token comment">// 整页多出多少个字节</span>
    <span class="token class-name">uint8_t</span> addr <span class="token operator">=</span> WriteAddr <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>              <span class="token comment">// 求 WriteAddr 是不是整页（整页多出了多少个字节）</span>
    <span class="token class-name">uint8_t</span> count <span class="token operator">=</span> EEPROM_PAGESIZE <span class="token operator">-</span> addr<span class="token punctuation">;</span>                  <span class="token comment">// 如果地址不是整页，这里的值是差多少个字节到整页（用于填充完整页）</span>

    <span class="token comment">// addr = 0 , 则 WriteAddr 地址按 EEPROM_PAGESIZE 是对齐的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果要传输的数据 不足一页</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//否则，先传输页</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//后传输不足一页的数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// WriteAddr 不是按 EEPROM_PAGESIZE 对齐的</span>

    <span class="token comment">//如果要写的页数为0，写入不足一页的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//如果 WriteAddr 地址不足整页，传输count个数据，count 为 WriteAddr 到 整页的差</span>
    NumByteToWrite <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//先传输页</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> EEPROM_PAGESIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//后传输不足一页的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">AT24C02_write_page</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">,</span> pBuffer<span class="token punctuation">,</span> EEPROM_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>SCL_IN <span class="token operator">||</span> <span class="token operator">!</span>SDA_IN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">AT24C02_read_page</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>pdata<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//发送从设备地址和写信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送要读的目标字节地址</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 起始信号</span>
    <span class="token function">IIC_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送设备地址和读信号。设备地址7位：0x50 ，加1位读写位 1为读，0为写</span>
    <span class="token function">IIC_send_byte</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 ACK</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IIC_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;no ack 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pdata<span class="token operator">++</span> <span class="token operator">=</span> <span class="token function">IIC_read_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">IIC_ack</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">IIC_ack</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止信号</span>
    <span class="token function">IIC_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SS_EE_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">IIC_SCL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">IIC_SDA_mode</span><span class="token punctuation">(</span>GPIO_Mode_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">I2C_SS_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;***************************** Start Write *****************************\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> buffer<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_SS_EE_BufferWrite</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Write SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;***************************** Start Read *****************************\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AT24C02_read_page</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Read SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Random Write *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> writeBuffer<span class="token punctuation">[</span><span class="token number">56</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        writeBuffer<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">200</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x88</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">I2C_SS_EE_BufferWrite</span><span class="token punctuation">(</span><span class="token number">0xc8</span><span class="token punctuation">,</span> writeBuffer<span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Random Write SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Start Read *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AT24C02_read_page</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0x%02X &quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">==</span> <span class="token number">15</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***************************** Read SUCCESS *****************************\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_clkconfig.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;I2C.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//DMA 传输配置</span>
    <span class="token comment">//USART_DMA_Config();</span>

    <span class="token function">I2C_SS_EE_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2C_SS_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spi-读写串行-flash" tabindex="-1"><a class="header-anchor" href="#spi-读写串行-flash" aria-hidden="true">#</a> SPI 读写串行 Flash</h2><p>本章参考资料：《STM32F4xx 参考手册》 、 《STM32F4xx 规格书》 、库帮助文档 《stm32f4xx_dsp_stdperiph_lib_um.chm》及《SPI 总线协议介绍》。</p><ul><li>若对 SPI 通讯协议不了解，可先阅读《SPI 总线协议介绍》文档的内容学习。</li><li>关于 Flash 存储器，请参考 “常用存储器介绍” 章节，实验中 Flash 芯片的具体参数，请参考其规格书 《W25Q128》来了解。</li></ul><h3 id="spi-协议简介" tabindex="-1"><a class="header-anchor" href="#spi-协议简介" aria-hidden="true">#</a> SPI 协议简介</h3><p>SPI 协议是由摩托罗拉公司提出的通讯协议（Serial Peripheral Interface，串行外围设备接口），是一种高速全双工的通讯总线。它被广泛地使用在 ADC、ACD 等设备与 MCU 间，要求通讯速率较高的场合。</p><p>学习本章时，可与 I2C 章节对比阅读，体会两种通讯总线的差异以及 EEPROM存储器 与 Flash存储器 的区别。</p><h4 id="spi-物理层" tabindex="-1"><a class="header-anchor" href="#spi-物理层" aria-hidden="true">#</a> SPI 物理层</h4><p>SPI 通讯设备之间的常用连接方式见图<code>常见的SPI的通讯系统</code>。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211051250750.png" alt="QQ20221105-125007@2x" style="zoom:33%;"><p>SPI 通讯使用3条总线 及 片选线，3条总线分别为 SCK、MOSI、MISO、片选线，它们的作用如下：</p><ul><li><p><code>(Slave Select)片选线</code> 从设备选择信号线，常称为片选信号线，也称 NSS、CS ，以下用 NSS 表示。</p><ul><li>当有多个 SPI从设备与SPI主机相连时，设备的其他信号线 SCK、MOSI、MISO 同时并联到相同的 SPI总线，即无论有多少个从设备，都共同使用这3条总线；</li><li>而每个从设备都有一条 NSS信号线，NSS信号线独占主机的一个引脚，即有多少个从设备，就有多少条片选信号线；</li><li>I2C协议中通过设备地址来寻址，选中总线上的某个设备并与其进行通讯；而 SPI协议 中没有设备地址，它使用 NSS 信号线来寻址，当主机要选择从设备时，把该从设备的 NSS信号线 设置为低电平，即该设备被选中，即片选有效，接着主机开始与被选中的从设备进行 SPI 通讯；</li><li><strong>SPI通讯以 NSS线 置低电平为开始信号，以 NSS线 被拉高作为结束信号。</strong></li></ul></li><li><p><code>SCK(Serial Clock)</code>时钟信号线，用于通讯数据同步。它由通讯主机产生，决定了通讯的速率，不同的设备支持的最高时钟频率不一样，如 STM32 的 SPI时钟最大频率为 $f_{pclk}/2$ ，两个设备之间通讯时，通讯速率受限于低速设备。</p></li><li><p><code>MOSI(Master Output , Slave Input)</code>主设备输出/从设备输入 引脚。主机的数据从这条信号线输出，从设备由这条信号线读入主机发送的数据，即这条线上<strong>数据的方向为主机到从机</strong>。</p></li><li><p><code>MISO(Master Input , Slave Output)</code>主设备输入/从设备输出 引脚。主机从这条信号线读入数据。，从机的数据由这条信号线输出到主机，即在这条线上<strong>数据的方向为从机到主机</strong>。</p></li></ul><h4 id="协议层-2" tabindex="-1"><a class="header-anchor" href="#协议层-2" aria-hidden="true">#</a> 协议层</h4><p>与I2C的类似，SPI协议定义了通讯的起始和停止信号、数据有效性、时钟同步等环节。</p><h5 id="spi-基本通讯过程" tabindex="-1"><a class="header-anchor" href="#spi-基本通讯过程" aria-hidden="true">#</a> SPI 基本通讯过程</h5><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211051318385.png" alt="QQ20221105-131830@2x"></p><p>这时一个主机的通讯时序。NSS、SCK、MOSI 信号都由主机控制产生。而 MISO 的信号由从机产生。</p><p>MOSI 与 MISO 的信号只在 NSS 为低电平的时候才有效，在SCK的每个时钟周期 MOSI 和 MISO 传输一位数据。</p><h5 id="通讯的起始和停止信号" tabindex="-1"><a class="header-anchor" href="#通讯的起始和停止信号" aria-hidden="true">#</a> 通讯的起始和停止信号</h5><ul><li>在图 SPI通讯时序 中的标号处，NSS 信号线由高变低，是SPI通讯的起始信号。NSS是每个从机各自独占的信号线，当从机在自己的NSS线检测到起始信号后，就知道自己被主机选中了，开始准备与主机通讯。</li><li>NSS 信号由低变高，是SPI通讯的停止信号，表示本次通讯结束，从机的选中状态被取消。</li></ul><h5 id="数据有效性-1" tabindex="-1"><a class="header-anchor" href="#数据有效性-1" aria-hidden="true">#</a> 数据有效性</h5><ul><li><p>SPI使用MOSI、MISO信号线来传输数据，使用SCK信号线进行数据同步。</p></li><li><p>MOSI、MISO 数据线在SCK的每个时钟周期传输一位数据，且数据输入输出是同时进行的。</p></li><li><p>数据传输时，MSBIN先行或LSBIN先行并没有作硬性规定，但要保证两个SPI通讯设备之间使用同样的协定，一般都会采用 上图中的MSB先行模式。</p></li><li><p>MOSI、MISO 的数据在SCK的上升沿期间变化输出，<strong>在SCK的下降沿时被采样。即在 SCK 的下降沿时刻，MOSI 、MISO 的数据有效</strong>，高电平时表示数据 “1” ，低电平时表示数据 “0”。在其它时刻，数据无效，MOSI、MISO 为下一次表示数据作准备。</p></li><li><p>SPI 每次数据传输可以 8位或16位为单位，每次传输的单位数不受限制。</p></li></ul><h5 id="cpol-cpha-及通讯模式" tabindex="-1"><a class="header-anchor" href="#cpol-cpha-及通讯模式" aria-hidden="true">#</a> CPOL/CPHA 及通讯模式</h5><p>上图的 SPI通讯时序 中的时序只是 SPI 的其中一种通讯模式，SPI 一共有4种通讯模式，<strong>它们的主要区别是在总线空闲时 SCK 的时钟状态及数据采样时刻。</strong></p><p>为方便说明，在此引入“时钟极性 CPOL” 和 “时钟相位 CPHA” 的概念</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211051401053.png" alt="QQ20221105-140053@2x" style="zoom:50%;"><ul><li><p>时钟极性CPOL 是指 SPI 通讯设备处于空闲状态时，SCK 信号线的电平信号（即SPI通讯开始前，NSS线为高电平时SCK的状态）。CPOL = 0 时，SCK 在空闲状态时为低电平，CPOL = 1 时，则相反。</p></li><li><p>时钟相位CPHA 是指数据的采样时刻，当 CPHA = 0 时，MOSI 或 MISO 数据线上的信号将会在 SCK 时钟线的 “奇数边沿” 被采样。当 CPHA = 1 时，数据线在 SCK 的偶数边沿被采样。见图 CPHA = 0 时 和 CPHA =1 时的SPI通讯模式。</p></li></ul><p>上图中，CPHA = 0 时。根据 SCK 在空闲状态时的电平，分两种情况。SCK 信号线在空闲状态为低电平，CPOL = 0 ；空闲状态为高电平时，CPOL = 1。</p><ul><li>无论 CPOL =0 还是 =1，因为我们配置的时钟相位 CPHA = 0，在图中可以看到，采样时刻都是在 SCK 的奇数边沿。注意当 CPOL = 0 的时候，时钟的奇数边沿是上升沿，而 GPOL = 1 的时候，时钟时钟的奇数边沿是下降沿。所以 <strong>SPI 的采样时刻不是由 上下沿决定的。 MOSI 和 MISO 数据线的有效信号在 SCK 的奇数边沿保持不变，数据信号将在 SCK 奇数边缘时被采样，在非采样时刻，MOSI 、MISO 的有效信号才会发生切换</strong>。</li></ul><p>类似地，当 CPHA = 1时，不受 CPOL 的影响，数据信号在 SCK的偶数边沿被采样，见图 CPHA =1时的通讯模式。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211051440167.png" alt="QQ20221105-143947@2x" style="zoom:50%;"><p>由 GPOL 及 CPHA 的不同状态，SPI 分成了四种模式，见表 SPI 的四种模式，主机与从机需要工作在相同的模式下才可以正常通讯，实际中采用较多的是 “模式0” 与 “模式3”。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211051444207.png" alt="image-20221105144440137"></p><h3 id="stm32-的-spi-特性及架构" tabindex="-1"><a class="header-anchor" href="#stm32-的-spi-特性及架构" aria-hidden="true">#</a> STM32 的 SPI 特性及架构</h3><p>与 I2C 外设一样，STM32芯片也集成了专门用于SPI协议通讯的外设。</p><h4 id="stm32-的-spi-外设简介" tabindex="-1"><a class="header-anchor" href="#stm32-的-spi-外设简介" aria-hidden="true">#</a> STM32 的 SPI 外设简介</h4><p>STM32 的 SPI 外设可用作通讯的主机及从机，支持最高的SCK时钟频率为 $f_{PCLK}/2$（STM32F407型号的芯片默认 $f_{plck1} = 42MHz$ ，$f_{plck2} = 84MHz$），完全支持 SPI 协议的4种模式，数据帧长度可设置为8位或16位，可设置数据MSB先行 或 LSB 先行。</p><p>它还支持双线全双工（前面小节说明的都是这种模式）、双线单向、单线模式。</p><ul><li>其中<strong>双向单线模式可以同时使用 MOSI 及 MISO 数据线 向一个方向传输数据，可以加快一倍的传输速度</strong>。</li><li>而<strong>单线模式则可以减少硬件接线</strong>，当然这样速率会受影响。这里着了解双线全双工模式。</li></ul><p>STM32 的 SPI 外设还支持 I2S 功能，I2S 功能是一种音频串行通讯协议。在我们以后 MP3 播放器时 了解。</p><h4 id="stm32-的-spi-架构剖析" tabindex="-1"><a class="header-anchor" href="#stm32-的-spi-架构剖析" aria-hidden="true">#</a> STM32 的 SPI 架构剖析</h4><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211060023131.png" alt="QQ20221106-002321@2x" style="zoom:50%;"><h5 id="通讯引脚-1" tabindex="-1"><a class="header-anchor" href="#通讯引脚-1" aria-hidden="true">#</a> 通讯引脚</h5><p>SPI 的所有硬件架构都从 图 &quot;SPI 架构图&quot; 中左侧 MOSI、MISO、SCK、NSS 线展开的。</p><p>STM32 芯片有多个 SPI 外设，它们的 SPI 通讯信号引出到不同的 GPIO 引脚上，使用时必须配置到这些指定的引脚，见表 &quot;STM32Fxx的SPI引脚&quot;。关于 GPIO 引脚的复用功能，可查阅《STM32F4xx规格书》，以它为准。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211060044525.png" alt="QQ20221106-004352@2x" style="zoom:50%;"><blockquote><p>注意：其中 PF、PH 端口在 176引脚型号的芯片才有。</p></blockquote><p>其中</p><ul><li>SPI1、SPI4、SPI6 是 APH2 上的设备，最高通讯速率达 42Mbit/s。</li><li>SP2、SP3 是 APB1 上的设备，最高通讯速率为 21Mbit/s。其它功能上没有差异。</li></ul><h5 id="时钟控制逻辑-1" tabindex="-1"><a class="header-anchor" href="#时钟控制逻辑-1" aria-hidden="true">#</a> 时钟控制逻辑</h5><p>SCK 线的时钟信号，由波特率发生器根据 “控制寄存器CR1” 中的 BR[0:2] 位控制，该位是对$f_{plck}$时钟的分频因子，对$f_{plck}$的分频结果就是 SCK 引脚的输出时钟频率，计算方法见下表：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211060050845.png" alt="image-20221106005012665"></p><p>其中 $f_{plck}$ 频率是指 SPI 所在的 APB 总线的频率，APB1为 $f_{plck1}$ ，APB2为 $f_{plck2}$</p><p>通过配置 “控制寄存器CR” 的 “GPOL位” 及 “CPHA” 位可以把SPI设置成前面分析的4种SPI模式。</p><h5 id="数据控制逻辑-1" tabindex="-1"><a class="header-anchor" href="#数据控制逻辑-1" aria-hidden="true">#</a> 数据控制逻辑</h5><p>SPI 的 MOSI 、MISO 都连接到数据移位寄存器上，数据移位寄存器的内容来源于接收缓冲区 和 发送缓冲区 以及 MISO、MOSI 线。</p><ul><li><p>当向外发送数据的时候，数据移位寄存器以 “发送缓冲区” 为数据源，把数据一位一位地通过数据线发送出去；</p></li><li><p>当从外部接收数据的时候，数据移位寄存器把数据线采样到的数据一位一位的存储到 “接收缓冲区” 中。</p></li></ul><p>通过写 SPI 的 “数据寄存器DR” 把数据填充到发送缓冲区中。通过 “数据寄存器DR”，可以获取接收缓冲区中的内容。</p><p>其中数据帧长度可以通过 “控制寄存器CR1” 的 “DFF位” 配置成8位或16位模式；</p><p>配置 “LSBFIRST” 位，可选择 MSB 先行 还是 LSB 先行。</p><h5 id="整体控制逻辑-1" tabindex="-1"><a class="header-anchor" href="#整体控制逻辑-1" aria-hidden="true">#</a> 整体控制逻辑</h5><p>整体控制逻辑负责协调整个 SPI 外设，控制逻辑的工作模式根据我们配置的 “控制寄存器(CR1/CR2)” 的参数而改变，基本的控制参数包括前面提到的 SPI 模式、波特率、LSB先行、主从模式、单向模式 等等。</p><p>在外设工作时，控制逻辑会根据外设的工作状态修改 “状态寄存器(SR)”，我们只要读取状态寄存器相关的寄存器位，就可以了解 SPI 的工作状态了。</p><p>除此之外，控制逻辑还根据要求，负责控制产生 SPI 中断信号、DMA 请求 及 控制 NSS 信号线。</p><p><strong>实际应用中，我们一般不使用 STM32 SPI 外设的标准 NSS 信号线，而是更简单地使用普通的 GPIO ，软件控制它的电平输出，从而产生通讯起始和停止信号。</strong></p><h5 id="通讯过程-1" tabindex="-1"><a class="header-anchor" href="#通讯过程-1" aria-hidden="true">#</a> 通讯过程</h5><p>STM32 使用 SPI 外设通讯时，在通讯的不同阶段它会对 “状态寄存器SR” 的不同数据位写入参数，我们通过读取这些寄存器标志位来了解通讯状态。</p><p>图 “主发送器通讯过程” 中的是 “主模式” 流程，即 STM32 作为 SPI 通讯主机端时的数据收发过程。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211061417908.png" alt="QQ20221106-141651@2x" style="zoom:50%;"><p>主模式收发流程及事件说明如下：</p><ul><li>控制 NSS信号线，产生起始信号（图中没有画出）</li><li>把要发送的数据写入到 “数据寄存器DR” 中，该数据会被存储到发送缓冲区</li><li>通讯开始，SCK 时钟开始运行。MOSI 把发送缓冲区的数据一位一位地传输出去；MISO 则把数据一位一位的存储进接收缓冲区中；</li><li>当发送完一帧数据的时候，“状态寄存器SR” 中的 “TXE标志位” 会被置1，表示传输完一帧，接收缓冲区非空；</li><li><strong>等到 “TXE标志位” 为 1 时，若还要继续发送数据，则再次往 “数据寄存器DR” 写入数据即可；</strong></li><li><strong>等到 “RXNE标志位” 为1时，通过读取 “数据寄存器DR” 可以获取接收缓冲区中的内容。</strong></li></ul><p>假如我们使能了 TXE 或 RXNE 中断，TXE 或 RXNE 置1 时会产生 SPI 中断信号，进入同一个中断服务函数，到 SPI 中断服务程序后，可通过检查寄存器位来了解是哪一个事件，再分别进行处理。</p><p>也可以使用 DMA 方式来收发 “数据寄存器DR” 中的数据。</p><h3 id="spi-初始化结构体" tabindex="-1"><a class="header-anchor" href="#spi-初始化结构体" aria-hidden="true">#</a> SPI 初始化结构体</h3><p>跟其它外设一样，STM32 标准库提供了 SPI 初始化结构体及初始化函数来配置 SPI 外设。初始化结构体及函数定义在库文件“stm32f4xx_spi.h”及“stm32f4xx_spi.c”中，编程时我们可以结合这两个文件内的注释使用或参考库帮助文档。了解初始化结构体后我们就能对SPI 外设运用自如了</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   <span class="token comment">/*!&lt; Specifies the SPI unidirectional or bidirectional data mode.This parameter can be a value of @ref SPI_data_direction */</span>
    <span class="token class-name">uint16_t</span> SPI_Direction<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies the SPI operating mode.This parameter can be a value of @ref SPI_mode */</span>
    <span class="token class-name">uint16_t</span> SPI_Mode<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies the SPI data size.This parameter can be a value of @ref SPI_data_size */</span>
    <span class="token class-name">uint16_t</span> SPI_DataSize<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies the serial clock steady state.This parameter can be a value of @ref SPI_Clock_Polarity */</span>
    <span class="token class-name">uint16_t</span> SPI_CPOL<span class="token punctuation">;</span>     
  
		<span class="token comment">/*!&lt; Specifies the clock active edge for the bit capture.This parameter can be a value of @ref SPI_Clock_Phase */</span>
    <span class="token class-name">uint16_t</span> SPI_CPHA<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies whether the NSS signal is managed by hardware (NSS pin) or by software using the SSI bit. This parameter can be a value of @ref SPI_Slave_Select_management */</span>
    <span class="token class-name">uint16_t</span> SPI_NSS<span class="token punctuation">;</span>             
  
		<span class="token comment">/*!&lt; Specifies the Baud Rate prescaler value which will be used to configure the transmit and receive SCK clock.This parameter can be a value of @ref SPI_BaudRate_Prescaler @note The communication clock is derived from the master clock. The slave clock does not need to be set. */</span>
    <span class="token class-name">uint16_t</span> SPI_BaudRatePrescaler<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies whether data transfers start from MSB or LSB bit.This parameter can be a value of @ref SPI_MSB_LSB_transmission */</span>
    <span class="token class-name">uint16_t</span> SPI_FirstBit<span class="token punctuation">;</span>
  
		<span class="token comment">/*!&lt; Specifies the polynomial used for the CRC calculation. */</span>
    <span class="token class-name">uint16_t</span> SPI_CRCPolynomial<span class="token punctuation">;</span>
<span class="token punctuation">}</span> SPI_InitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>SPI_Direction</code> 指定SPI单向或双向数据模式。此参数可以是 @ ref SPI_data_direction的值.</p><ul><li>本成员设置 SPI 的通讯方向，可设置为双线全双工 (SPI_Direction_2Lines_FullDuplex)，双线只接收 (SPI_Direction_2Lines_RxOnly)，单线只接收 (SPI_Direction_1Line_Rx)、单线只发送模式 (SPI_Direction_1Line_Tx)。</li></ul></li><li><p><code>SPI_Mode</code> 指定SPI操作模式。此参数可以是 @ ref SPI_mode的值</p><ul><li>本成员设置 SPI 工作在主机模式 (SPI_Mode_Master) 或从机模式 (SPI_Mode_Slave )，这两个模式的最大区别为 SPI 的 SCK 信号线的时序，SCK 的时序是由通讯中的主机产生的。若被配置为从机模式，STM32 的 SPI 外设将接受外来的SCK 信号。</li></ul></li><li><p><code>SPI_DataSize</code> 指定SPI数据大小。此参数可以是 @ ref SPI_data_size的值</p><ul><li>本成员可以选择SPI 通讯的数据帧大小是为8 位(SPI_DataSize_8b) 还是16 位(SPI_DataSize_16b)。</li></ul></li><li><p><code>SPI_CPOL</code> 指定串行时钟稳态。此参数可以是 @ ref SPI_Clock_Polarity的值</p><ul><li><p>这两个成员配置 SPI 的时钟极性 CPOL 和时钟相位 CPHA，这两个配置影响到 SPI 的通讯模式， 关于CPOL 和 CPHA 的说明参考前面 “CPOL/CPHA 及通讯模式” 小节。</p></li><li><p>时钟极性CPOL 成员，可设置为高电平(SPI_CPOL_High) 或低电平(SPI_CPOL_Low )。</p></li></ul></li><li><p><code>SPI_CPHA</code> 指定位捕获的时钟活动边沿。此参数可以是 @ ref SPI_Clock_Phase的值</p><ul><li>时钟相位 CPHA 则可以设置为 SPI_CPHA_1Edge(在 SCK 的奇数边沿采集数据) 或 SPI_CPHA_2Edge(在 SCK 的偶数边沿采集数据) 。</li></ul></li><li><p><code>SPI_NSS</code> 指定NSS信号是由硬件 (NSS引脚) 还是由使用SSI位的软件管理。此参数可以是 @ ref SPI_Slave_Select_management的值</p><ul><li>本成员配置 NSS 引脚的使用模式，可以选择为硬件模式 (SPI_NSS_Hard ) 与软件模式(SPI_NSS_Soft )，在硬件模式中的 SPI 片选信号由 SPI 硬件自动产生，而软件模式则需要我们亲自把相应的 GPIO 端口拉高或置低产生非片选和片选信号。实际中软件模式应用比较多。</li></ul></li><li><p><code>SPI_BaudRatePrescaler</code> 指定将用于配置发送和接收SCK时钟的波特率预分频器值。此参数可以是 @ ref SPI_BaudRate_Prescaler @ 的值。注意通信时钟是从主时钟派生的。从时钟不需要设置。</p><ul><li>本成员设置波特率分频因子，分频后的时钟即为 SPI 的 SCK 信号线的时钟频率。这个成员参数可设置为fpclk 的 2、4、6、8、16、32、64、128、256 分频。</li></ul></li><li><p><code>SPI_FirstBit</code> 指定数据传输是从MSB还是LSB位开始。此参数可以是 @ ref SPI_MSB_LSB_transmission的值</p><ul><li>所有串行的通讯协议都会有MSB 先行(高位数据在前) 还是LSB 先行(低位数据在前) 的问题，而 STM32 的 SPI 模块可以通过这个结构体成员，对这个特性编程控制。</li></ul></li><li><p><code>SPI_CRCPolynomial</code> 指定用于CRC计算的多项式。</p><ul><li>这是 SPI 的 CRC 校验中的多项式，若我们使用 CRC 校验时，就使用这个成员的参数 (多项式)，来计算CRC 的值。</li></ul></li></ul><p>配置完这些结构体成员后，我们要调用 SPI_Init 函数把这些参数写入到寄存器中，实现 SPI 的初始化，然后调用SPI_Cmd 来使能SPI 外设。</p><h3 id="spi-读写串行-flash-实验" tabindex="-1"><a class="header-anchor" href="#spi-读写串行-flash-实验" aria-hidden="true">#</a> SPI 读写串行 FLASH 实验</h3><ul><li><p><strong>FLASH 存储器又称闪存，它与 EEPROM 都是掉电后数据不丢失的存储器，但 FLASH 存储容量普遍大于 EEPROM ，现在基本取代了它的位置。</strong></p></li><li><p><strong>我们生活中常用的 U盘、SD卡、SSD固态硬盘、STM32芯片内部用于存储程序的设备，都是 FLASH 类型的存储器。</strong></p></li><li><p><strong>在存储控制上，最主要的区别是 FLASH 芯片只能一大片一大片的擦写，而在 “I2C章节” 中我们了解到 EEPROM 可以单个字节擦写。</strong></p></li></ul><p>本小节以一种使用SPI 通讯的串行FLASH 存储芯片的读写实验来了解 STM32 的SPI 使用方 法。实验中 STM32 的 SPI 外设采用主模式，通过查询事件的方式来确保正常通讯。</p><h4 id="硬件设计-5" tabindex="-1"><a class="header-anchor" href="#硬件设计-5" aria-hidden="true">#</a> 硬件设计</h4><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211061831775.png" alt="QQ20221106-183040@2x" style="zoom:50%;"><p>本实验板中的 FLASH 芯片（型号：W25Q128）是一种 SPI 通讯协议的 NORFLASH 存储器，它 CS/CLK/DIO/DO 引脚分别连接到了 STM32 对应的 SPI 引脚 NSS/SCK/MOSI/MISO 上，其中 STM32 的 NSS 引脚是一个普通的 GPIO，不是 SPI 的专用 NSS 引脚，所以程序中我们要使用软件的控制方式。</p><p>FLASH 芯片中还有 WP 和 HOLD 引脚。</p><ul><li>WP 引脚可以控制写入保护功能，当该引脚为低电平时，禁止写入数据。我们直接接电源，不使用写入保护功能。</li><li>HOLD 引脚可用于暂停通讯，该引脚 为低电平时，通讯暂停，数据输出引脚输出高阻抗状态，时钟和数据输入引脚无效。我们直接接电源，不使用暂停通讯功能。</li></ul><p>关于 FLASH 芯片的更多信息，可参考其数据手册《W25Q128》来了解。</p><h4 id="软件设计-5" tabindex="-1"><a class="header-anchor" href="#软件设计-5" aria-hidden="true">#</a> 软件设计</h4><p>在“工 程模板”之上新建“bsp_spi_ﬂash.c”及“bsp_spi_ﬂash.h”文件</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211070045118.png" alt="image-20221107004527875"></p><p><strong>编程要点</strong></p><ul><li>初始化通讯使用的目标引脚及端口时钟</li><li>使能 SPI 外设的时钟</li><li>配置 SPI 外设的 模式、地址、速率 等参数并使能 SPI 外设</li><li>编写基本 SPI 按字节收发的函数</li><li>编写对 FLASH 擦除及读写操作的函数</li></ul><p><code>bsp_spi_flash.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 2022/11/7.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLO_BSP_SPI_FLASH_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLO_BSP_SPI_FLASH_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_spi.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">// SPI 时钟及初始化函数参数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI</span>                   <span class="token expression">SPI1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_CLK</span>               <span class="token expression">RCC_APB2Periph_SPI1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_CLK_INIT</span>          <span class="token expression">RCC_APB2PeriphClockCmd</span></span>
<span class="token comment">// SCK 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_PIN</span>           <span class="token expression">GPIO_Pin_3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_GPIO_PORT</span>     <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_GPIO_CLK</span>      <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_PINSOURCE</span>     <span class="token expression">GPIO_PinSource3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_AF</span>            <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">// MISO 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_PIN</span>          <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_GPIO_PORT</span>    <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_GPIO_CLK</span>     <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_PINSOURCE</span>    <span class="token expression">GPIO_PinSource4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_AF</span>           <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">// MOSI 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_PIN</span>          <span class="token expression">GPIO_Pin_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_GPIO_PORT</span>    <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_GPIO_CLK</span>     <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_PINSOURCE</span>    <span class="token expression">GPIO_PinSource5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_AF</span>           <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">//CS(NSS) 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_PIN</span>                <span class="token expression">GPIO_Pin_6</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_GPIO_PORT</span>          <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_GPIO_CLK</span>           <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPI_FLASH_CS_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>FLASH_CS_GPIO_PORT<span class="token punctuation">,</span> FLASH_CS_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPI_FLASH_CS_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>FLASH_CS_GPIO_PORT<span class="token punctuation">,</span>FLASH_CS_PIN<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HELLO_BSP_SPI_FLASH_H</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_spi_flash.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 2022/11/7.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_spi_flash.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使能 SPI 引脚 GPIO 时钟</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>FLASH_CS_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_SCK_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_MISO_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_MOSI_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使能 SPI 时钟</span>
    <span class="token function">FLASH_SPI_CLK_INIT</span><span class="token punctuation">(</span>FLASH_SPI_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置引脚复用</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_SCK_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_SCK_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_MISO_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_MISO_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_MISO_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_MOSI_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_MOSI_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_MOSI_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置 SPI SCK 引脚</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_SCK_PIN<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI MISO 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_MISO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI MOSI 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_MOSI_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI CS(NSS) 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_CS_PIN<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 默认停止信号 FLASH:CS 引脚高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// SPI 模式初始化</span>
    SPI_InitTypeDef SPI_InitStructure<span class="token punctuation">;</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span> <span class="token comment">// 双线全双工</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span> <span class="token comment">// 主模式</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span> <span class="token comment">// 数据帧长度 = 8位</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_High<span class="token punctuation">;</span> <span class="token comment">// SPI 空闲时 SCK 高电平</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_2Edge<span class="token punctuation">;</span> <span class="token comment">// 偶数边缘采样</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>    <span class="token comment">// 软件片选信号线</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_2<span class="token punctuation">;</span> <span class="token comment">// SCK，2分频</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span> <span class="token comment">// MSB（高位） 先行</span>
    <span class="token comment">//循环冗余校验（英语：Cyclic redundancy check，通称“CRC”）</span>
    <span class="token comment">//由于我们与FLASH 芯片通讯不需要CRC 校验，并没有使能SPI 的CRC 功能，这时CRC计算式的成员值7是无效的。</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// 指定用于CRC计算的多项式（不知道什么玩意）</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使能 SPI</span>
    <span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_FLAG_TIMEOUT</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x1000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_LONG_TIMEOUT</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">10</span><span class="token operator">*</span>SPI_FLAG_TIMEOUT<span class="token punctuation">)</span></span></span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_TIMEOUT_UserCallback</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;TXE is Timeout ! code :  %d \n&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;RXNE is Timeout ! code :  %d \n&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> timeout <span class="token operator">=</span> SPI_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token comment">// 等待发送缓冲区为空，TXE 事件</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> SPI_I2S_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">SPI_TIMEOUT_UserCallback</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 写入数据寄存器，把要写入的数据写入发送缓冲区</span>
    <span class="token function">SPI_I2S_SendData</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
      等待接受到一个字节数据，为什么要这么做？加这一句的原因是为了确保这个字节已经发送出去，
     因为发生和接收是并行同步进行，那就是说你发生出去一个字节意味着你收到一个字节。
     所以这样判断完全没有问题，再说必要性，如果你不加这句你就会容易犯过早拉高CS信号的错误，
     你想想如果在SPI_I2S_SendData(SPI1, Data)后面立即拉高CS是什么后果。
     */</span>
    timeout <span class="token operator">=</span> SPI_FLAG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> SPI_I2S_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timeout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">SPI_TIMEOUT_UserCallback</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">SPI_I2S_ReceiveData</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 读的时候要注意一个问题，因为从模式是没法提供时钟的，所以主模式下必须要在接收的同时提供时钟。
 * 办法就是发送一个字节来实现，因为还是上面说的，发送一个字节就意味着收到一个字节，代码和写完全一样，
 * 只要把读出来的字节保存即可。
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">SPI_FLASH_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送与应用不相关的数据，为后续的读数据提供时钟信号</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>由于我们与FLASH 芯片通讯不需要CRC 校验，并没有使能SPI 的CRC 功能，这时CRC计算式的成员值7是无效的。</li><li>发生和接收是并行同步进行，那就是说你发生出去一个字节意味着你收到一个字节。</li><li>SPI协议中接收和发送数据是一体的,数据传输的线路为一个循环链路(loop).如果主机发送数据给从机,则必须从从机读取数据(即从机也发送数据到主机).同理,如果主机读取从机发来的数据,也必须同时发送数据给从机.总之,同一个时钟周期内,读和写2个操作都必须执行.</li><li><strong>SPI是全双工同步串行口，收发通信同时进行，发一个字节同时也是收一个字节，收发完成后，才可以从寄存器读取数据</strong>。</li><li>读的时候要注意一个问题，因为从模式是没法提供时钟的，所以主模式下必须要在接收的同时提供时钟。办法就是发送一个字节来实现，因为还是上面说的，发送一个字节就意味着收到一个字节，代码和写完全一样，只要把读出来的字节保存即可。</li></ul><h4 id="控制-flash-的指令" tabindex="-1"><a class="header-anchor" href="#控制-flash-的指令" aria-hidden="true">#</a> 控制 FLASH 的指令</h4><p>搞定SPI 的基本收发单元后，还需要了解如何对FLASH 芯片进行读写。FLASH 芯片自定义了很 多指令，我们通过控制 STM32 利用 SPI 总线向 FLASH 芯片发送指令，FLASH 芯片收到后就会 执行相应的操作。</p><p>而这些指令，对主机端(STM32) 来说，只是它遵守最基本的SPI 通讯协议发送出的数据，但在设备端(FLASH 芯片) 把这些数据解释成不同的意义，所以才成为指令。查看FLASH 芯片的数据手册《W25Q128》，可了解各种它定义的各种指令的功能及指令格式，见表FLASH 常用芯片指令表。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072012302.png" alt="QQ20221107-201105@2x" style="zoom:50%;"><ul><li><p>该表中的第一列为指令名，第二列为指令编码，第三至第 N 列的具体内容根据指令的不同而有 不同的含义。</p></li><li><p>其中带括号的字节参数，方向为 FLASH 向主机传输，即命令响应，不带括号的则为主机向 FLASH 传输。</p></li><li><p>表中“A0~A23”指 FLASH 芯片内部存储器组织的地址；</p></li><li><p>“M0~M7”为厂商号（MANUFACTURERID）；</p></li><li><p>“ID0-ID15”为 FLASH 芯片的 ID；</p></li><li><p>“dummy”指该处可为任意数据；</p></li><li><p>“D0~D7”为FLASH 内部存储矩阵的内容。</p></li></ul><p>在FLSAH 芯片内部，存储有固定的厂商编号(M7-M0) 和不同类型FLASH 芯片独有的编号(ID15- ID0)，见表 FLASH 数据手册的设备ID 说明。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072018211.png" alt="image-20221107201820050"></p><p>通过指令表中的读ID 指令“JEDEC ID”可以获取这两个编号，该指令编码为“9Fh”，其中“9F h”是指16 进制数“9F”(相当于C 语言中的0x9F)。紧跟指令编码的三个字节分别为FLASH 芯 片输出的“(M7-M0)”、“(ID15-ID8)”及“(ID7-ID0)”。</p><p>此处我们以该指令为例，配合其指令时序图进行讲解，见图FLASH 读ID 指令JEDEC_ID 的时序。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072023811.png" alt="QQ20221107-202246@2x" style="zoom:50%;"><p>主机首先通过MOSI 线向FLASH 芯片发送第一个字节数据为“9Fh”，当FLASH 芯片收到该数据 后，它会解读成主机向它发送了“JEDEC 指令”，然后它就作出该命令的响应：通过 MISO 线把 它的厂商 ID(M7-M0) 及芯片类型 (ID15-0) 发送给主机，主机接收到指令响应后可进行校验。<strong>常</strong><strong>见的应用是主机端通过读取设备ID 来测试硬件是否连接正常，或用于识别设备</strong>。</p><p>对于 FLASH 芯片的其它指令，都是类似的，只是有的指令包含多个字节，或者响应包含更多的 数据。</p><p>实际上，编写设备驱动都是有一定的规律可循的。首先我们要确定设备使用的是什么通讯协议。</p><p>如上一章的 EEPROM 使用的是 I2C，本章的 FLASH 使用的是 SPI。</p><ul><li>那么我们就先根据它的通讯协议，选择好STM32 的硬件模块，并进行相应的 I2C 或 SPI 模块初始化。</li><li>接着，我们要了解目标设备的相关指令，因为不同的设备，都会有相应的不同的指令。</li><li>如 EEPROM 中会把第一个数据解释为内部存储矩阵的地址 (实质就是指令)。</li><li>而 FLASH 则定义了更多的指令，有写指令，读指令，读 ID 指令等等。</li><li>最后，我们根据这些指令的格式要求，使用通讯协议向设备发送指令，达到控制设备的目标。</li></ul><h4 id="定义-flash指令编码表" tabindex="-1"><a class="header-anchor" href="#定义-flash指令编码表" aria-hidden="true">#</a> 定义 FLASH指令编码表</h4><p>为了方便使用，我们把 FLASH 芯片的常用指令编码使用宏来封装起来，后面需要发送指令编码 的时候我们直接使用这些宏即可。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* FLASH 常用指令*/</span>
<span class="token comment">// 写使能</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteEnable</span>                    <span class="token expression"><span class="token number">0x06</span></span></span>
<span class="token comment">// 写禁用</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteDisable</span>                   <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token comment">// 读状态寄存器</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReadStatusReg</span>                  <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token comment">// 写状态寄存器</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteStatusReg</span>                 <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token comment">// 读数据</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReadData</span>                       <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token comment">// 快速读取数据</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_FastReadData</span>                   <span class="token expression"><span class="token number">0x0B</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_FastReadDual</span>                   <span class="token expression"><span class="token number">0x3B</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_PageProgram</span>                    <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token comment">// 块擦除</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_BlockErase</span>                     <span class="token expression"><span class="token number">0xD8</span></span></span>
<span class="token comment">// 扇区擦除</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_SectorErase</span>                    <span class="token expression"><span class="token number">0x20</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ChipErase</span>                      <span class="token expression"><span class="token number">0xC7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_PowerDown</span>                      <span class="token expression"><span class="token number">0xB9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReleasePowerDown</span>               <span class="token expression"><span class="token number">0xAB</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_DeviceID</span>                       <span class="token expression"><span class="token number">0xAB</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ManufactDeviceID</span>               <span class="token expression"><span class="token number">0x90</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_JedecDevice</span>                    <span class="token expression"><span class="token number">0x9F</span></span></span>


<span class="token comment">/* 其它 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_ID</span>       <span class="token expression"><span class="token number">0xEF4018</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dummy_Byte</span>     <span class="token expression"><span class="token number">0xFF</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token class-name">uint32_t</span> <span class="token function">SPI_FLASH_ReadDeviceID</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token class-name">uint32_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> temp0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> temp1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> temp2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 JEDEC 指令，读取设备ID</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_JedecDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取一个字节数据，生产厂商</span>
    temp0 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 读取一个字节数据，存储器类型</span>
    temp1 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 读取一个字节数据，容量</span>
    temp2 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 把数据组合起来，作为函数的返回值</span>
    temp <span class="token operator">=</span> <span class="token punctuation">(</span>temp0 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>temp1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span> temp2<span class="token punctuation">;</span>

    <span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_WraiteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送写使能命令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_WriteEnable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>与EEPROM 一样，由于FLASH 芯片向内部存储矩阵写入数据需要消耗一定的时间，并不是在总</li><li>线通讯结束的一瞬间完成的，所以在写操作后需要确认 FLASH 芯片“空闲”时才能进行再次写 入。</li><li>为了表示自己的工作状态，FLASH 芯片定义了一个状态寄存器，见图 FLASH 芯片的状态寄存器。</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072103143.png" alt="QQ20221107-210259@2x" style="zoom:50%;"><p>我们只关注这个状态寄存器的第0 位“BUSY”，当这个位为“1”时，表明FLASH 芯片处于忙碌 状态，它可能正在对内部的存储矩阵进行“擦除”或“数据写入”的操作。</p><p>利用指令表中的“Read Status Register”指令可以获取 FLASH 芯片状态寄存器的内容，其时序见 图读取状态寄存器的时序。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072104148.png" alt="QQ20221107-210400@2x"></p><p>只要向FLASH 芯片发送了读状态寄存器的指令，FLASH 芯片就会持续向主机返回最新的状态寄 存器内容，直到收到 SPI 通讯的停止信号。</p><p>据此我们编写了具有等待 FLASH 芯片写入结束功能的函数</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// WIP（BUSY）标志：FLASH 内部正在写入</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WIP_Flag</span>        <span class="token expression"><span class="token number">0x01</span></span></span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 状态寄存器 命令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_ReadStatusReg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> FLASH_Status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> timout <span class="token operator">=</span> SPI_LONG_TIMEOUT<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        FLASH_Status <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timout<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_TIMEOUT_UserCallback</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FLASH_Status <span class="token operator">&amp;</span> WIP_Flag<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="flash-扇区擦除" tabindex="-1"><a class="header-anchor" href="#flash-扇区擦除" aria-hidden="true">#</a> FLASH 扇区擦除</h4><p>flash有个特性，数据存储的每个位，在更新存储数据时，能把1改成0，而0却不能改为1。所以这就要求<strong>在写入数据前，必须对目标区域进行擦除操作</strong>，即把目标区域中的数据位擦除为1。</p><p>以扇区擦除为例，擦除大小为4KB，即4096字节的数据。由于擦除实际上是往扇区写入数据，把数据位都写为1，所以在擦除前还需要进行“写使能”，并且需要等待flash空闲。</p><p>通常，对存储矩阵擦除的基本操作单位都是多个字节进行，如本例子中的 FLASH 芯片支持“扇 区擦除”、“块擦除”以及“整片擦除”，见表本实验FLASH 芯片的擦除单位。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072133927.png" alt="image-20221107213326753"></p><p>FLASH 芯片的最小擦除单位为扇区 (Sector)，而一个块 (Block) 包含 16 个扇区，其内部存储矩阵 分布见图FLASH 芯片的存储矩阵。。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072134091.png" alt="QQ20221107-213411@2x" style="zoom:50%;"><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211072135691.png" alt="QQ20221107-213505@2x"></p><p>使用扇区擦除指令“Sector Erase”可控制FLASH 芯片开始擦写，其指令时序见图扇区擦除时序。</p><p>扇区擦除指令的第一个字节为指令编码，紧接着发送的 3 个字节用于表示要擦除的存储矩阵地 址。要注意的是在扇区擦除指令前，还需要先发送“写使能”指令，发送扇区擦除指令后，通过 读取寄存器状态等待扇区擦除操作完毕</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/**
 * 擦除 FLASH 扇区
 * @param SectorAddr 要擦除的扇区地址
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> SectorAddr<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 发送 FLASH 写使能命令</span>
    <span class="token function">SPI_FLASH_WraiteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 FLASH 空闲</span>
    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送扇区擦除指令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_SectorErase<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送擦除扇区地址的高位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送擦除扇区地址的中位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送擦除扇区地址的低位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 停止信号 FLASH：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//等待擦写完毕</span>
    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>只要注意发送擦除地址时高位在前即可。<strong>调用扇区擦除指令时注意输入的地址要对齐到4KB。</strong></li></ul><h4 id="flash-的页写入" tabindex="-1"><a class="header-anchor" href="#flash-的页写入" aria-hidden="true">#</a> FLASH 的页写入</h4><p><strong>页：一次性可以写入的数据大小</strong></p><p>目标扇区被擦除完毕后，就可以向它写入数据了。与 EEPROM 类似，FLASH 芯片也有页写入命 令，使用页写入命令最多可以一次向FLASH 传输256 个字节的数据，我们把这个单位为页大小。 FLASH 页写入的时序见图FLASH 芯片页写入。</p><ul><li>从时序图可知，第 1 个字节为“页写入指令”编码，2-4 字节为要写入的“地址 A”，接着的是 要写入的内容，<strong>最多个可以发送256 字节数据，这些数据将会从“地址A”开始，按顺序写入到FLASH 的存储矩阵。若发送的数据超出256 个，则会覆盖前面发送的数据。</strong></li><li>与擦除指令不一样，页写入指令的地址并不要求按256 字节对齐，只要确认目标存储单元是擦除状态即可 (即被擦除后没有被写入过)。所以，若对“地址 x”执行页写入指令后，发送了 200 个 字节数据后终止通讯，下一次再执行页写入指令，从“地址 (x+200)”开始写入 200 个字节也是 没有问题的(小于256 均可)。</li><li>只是在实际应用中由于基本擦除单元是4KB，一般都以扇区为单位进行读写，想深入了解，可学习我们的“FLASH 文件系统”相关的例子。</li></ul><h4 id="不定量数据写入" tabindex="-1"><a class="header-anchor" href="#不定量数据写入" aria-hidden="true">#</a> 不定量数据写入</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>
<span class="token comment">/**
 * 对 FLASH 写入数据，调用本函数写入数据前需要先擦除扇区
 * @param pBuffer 写入的指针数据
 * @param WriteAddr 写入地址
 * @param NumByteToWrite 写入数据长度
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_BufferWrite</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> u32 WriteAddr<span class="token punctuation">,</span> u16 NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u8 NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    u8 NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    u8 Addr <span class="token operator">=</span> WriteAddr <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span> <span class="token comment">// WriteAddr 比 整页多出了 多少个字节</span>
    u8 count <span class="token operator">=</span> SPI_FLASH_PageSize <span class="token operator">-</span> Addr<span class="token punctuation">;</span> <span class="token comment">// 差多少个字节，可以对齐整页</span>

    <span class="token comment">// Addr = 0 ，则 WriteAddr 刚好页对齐(aligned)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//要写入的数据不足一页</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumByteToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> SPI_FLASH_PageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 有多余的不满一页的数据，把它写完</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* WriteAddr 不按页对齐 */</span>

    <span class="token comment">// 写入的数据不足一页</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// WriteAddr + NumOfSingle 大于 页对齐</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">&gt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 先写满当前页</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>

            <span class="token comment">// 再写剩余的数据</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* WriteAddr 不按页对齐，并且写入的数据超过一页 */</span>

    <span class="token comment">//重新计算页数，和多余数</span>
    NumByteToWrite <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>

    <span class="token comment">//先让它对齐</span>
    <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
    WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>

    <span class="token comment">// 对齐后写入页</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> SPI_FLASH_PageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 有多余的不满一页的数据，把它写完</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="从-flash-读取数据" tabindex="-1"><a class="header-anchor" href="#从-flash-读取数据" aria-hidden="true">#</a> 从 FLASH 读取数据</h4><p>相对于写入，FLASH 芯片的数据读取要简单得多，使用读取指令“Read Data”即可，其指令时 序见图SPI_FLASH 读取数据时序。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211080156993.png" alt="QQ20221108-015636@2x"></p><p>发送了指令编码及要读的起始地址后，FLASH 芯片就会按地址递增的方式返回存储矩阵的内容读取的数据量没有限制，只要没有停止通讯，FLASH 芯片就会一直返回数据。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/**
 * 读取 FLASH 数据
 * @param pBuffer 存储读出数据的指针
 * @param ReadAddr 读取地址
 * @param NumByteToRead 读取数据长度
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_BufferRead</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span>u32 ReadAddr<span class="token punctuation">,</span>u16 NumByteToRead<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 起始信号 FLASH : CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 读 指令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_ReadData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 读 地址高位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 读 地址中位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 读 地址低位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取数据</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumByteToRead<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pBuffer <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止信号 FLASH : CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码" aria-hidden="true">#</a> 完整代码</h4><p><code>bsp_spi_flash.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 2022/11/7.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLO_BSP_SPI_FLASH_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLO_BSP_SPI_FLASH_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx_spi.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_SysTick.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">// SPI 时钟及初始化函数参数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI</span>                   <span class="token expression">SPI1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_CLK</span>               <span class="token expression">RCC_APB2Periph_SPI1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_CLK_INIT</span>          <span class="token expression">RCC_APB2PeriphClockCmd</span></span>
<span class="token comment">// SCK 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_PIN</span>           <span class="token expression">GPIO_Pin_3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_GPIO_PORT</span>     <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_GPIO_CLK</span>      <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_PINSOURCE</span>     <span class="token expression">GPIO_PinSource3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_SCK_AF</span>            <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">// MISO 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_PIN</span>          <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_GPIO_PORT</span>    <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_GPIO_CLK</span>     <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_PINSOURCE</span>    <span class="token expression">GPIO_PinSource4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MISO_AF</span>           <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">// MOSI 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_PIN</span>          <span class="token expression">GPIO_Pin_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_GPIO_PORT</span>    <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_GPIO_CLK</span>     <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_PINSOURCE</span>    <span class="token expression">GPIO_PinSource5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_SPI_MOSI_AF</span>           <span class="token expression">GPIO_AF_SPI1</span></span>
<span class="token comment">//CS(NSS) 引脚</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_PIN</span>                <span class="token expression">GPIO_Pin_14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_GPIO_PORT</span>          <span class="token expression">GPIOB</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_CS_GPIO_CLK</span>           <span class="token expression">RCC_AHB1Periph_GPIOB</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPI_FLASH_CS_LOW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>FLASH_CS_GPIO_PORT<span class="token punctuation">,</span> FLASH_CS_PIN<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPI_FLASH_CS_HIGH</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>FLASH_CS_GPIO_PORT<span class="token punctuation">,</span>FLASH_CS_PIN<span class="token punctuation">)</span></span></span>


<span class="token comment">/* FLASH 常用指令*/</span>
<span class="token comment">// 写使能</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteEnable</span>                    <span class="token expression"><span class="token number">0x06</span></span></span>
<span class="token comment">// 写禁用</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteDisable</span>                   <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token comment">// 读状态寄存器</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReadStatusReg</span>                  <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token comment">// 写状态寄存器</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_WriteStatusReg</span>                 <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token comment">// 读数据</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReadData</span>                       <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token comment">// 快速读取数据</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_FastReadData</span>                   <span class="token expression"><span class="token number">0x0B</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_FastReadDual</span>                   <span class="token expression"><span class="token number">0x3B</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_PageProgram</span>                    <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token comment">// 块擦除</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_BlockErase</span>                     <span class="token expression"><span class="token number">0xD8</span></span></span>
<span class="token comment">// 扇区擦除</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_SectorErase</span>                    <span class="token expression"><span class="token number">0x20</span></span></span>
<span class="token comment">// ...</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ChipErase</span>                      <span class="token expression"><span class="token number">0xC7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_PowerDown</span>                      <span class="token expression"><span class="token number">0xB9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ReleasePowerDown</span>               <span class="token expression"><span class="token number">0xAB</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_DeviceID</span>                       <span class="token expression"><span class="token number">0xAB</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_ManufactDeviceID</span>               <span class="token expression"><span class="token number">0x90</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">W25X_JedecDevice</span>                    <span class="token expression"><span class="token number">0x9F</span></span></span>


<span class="token comment">/* 其它 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FLASH_ID</span>       <span class="token expression"><span class="token number">0xEF4018</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Dummy_Byte</span>     <span class="token expression"><span class="token number">0x00</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_FLASH_PageSize</span> <span class="token expression"><span class="token number">256</span></span></span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HELLO_BSP_SPI_FLASH_H</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_spi_flash.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 2022/11/7.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_spi_flash.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使能 SPI 引脚 GPIO 时钟</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>FLASH_CS_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_SCK_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_MISO_GPIO_CLK <span class="token operator">|</span>
                           FLASH_SPI_MOSI_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使能 SPI 时钟</span>
    <span class="token function">FLASH_SPI_CLK_INIT</span><span class="token punctuation">(</span>FLASH_SPI_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置引脚复用</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_SCK_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_SCK_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_MISO_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_MISO_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_MISO_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FLASH_SPI_MOSI_GPIO_PORT<span class="token punctuation">,</span>
                     FLASH_SPI_MOSI_PINSOURCE<span class="token punctuation">,</span>
                     FLASH_SPI_MOSI_AF<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置 SPI SCK 引脚</span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_SCK_PIN<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_SCK_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI MISO 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_MISO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_MISO_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI MOSI 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_SPI_MOSI_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_SPI_MOSI_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 SPI CS(NSS) 引脚</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FLASH_CS_PIN<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FLASH_CS_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 默认停止信号 FLASH:CS 引脚高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// SPI 模式初始化</span>
    SPI_InitTypeDef SPI_InitStructure<span class="token punctuation">;</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span> <span class="token comment">// 双线全双工</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span> <span class="token comment">// 主模式</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span> <span class="token comment">// 数据帧长度 = 8位</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_High<span class="token punctuation">;</span> <span class="token comment">// SPI 空闲时 SCK 高电平</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_2Edge<span class="token punctuation">;</span> <span class="token comment">// 偶数边缘采样</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>    <span class="token comment">// 软件片选信号线</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_2<span class="token punctuation">;</span> <span class="token comment">// SCK，2分频</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span> <span class="token comment">// MSB（高位） 先行</span>
    <span class="token comment">//循环冗余校验（英语：Cyclic redundancy check，通称“CRC”）</span>
    <span class="token comment">//由于我们与FLASH 芯片通讯不需要CRC 校验，并没有使能SPI 的CRC 功能，这时CRC计算式的成员值7是无效的。</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// 指定用于CRC计算的多项式（不知道什么玩意）</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//使能 SPI</span>
    <span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint8_t</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 等待发送缓冲区为空，TXE 事件</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> SPI_I2S_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 写入数据寄存器，把要写入的数据写入发送缓冲区</span>
    <span class="token function">SPI_I2S_SendData</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
      等待接受到一个字节数据，为什么要这么做？加这一句的原因是为了确保这个字节已经发送出去，
     因为发生和接受是并行同步进行，那就是说你发生出去一个字节意味着你收到一个字节。
     所以这样判断完全没有问题，再说必要性，如果你不加这句你就会容易犯过早拉高CS信号的错误，
     你想想如果在SPI_I2S_SendData(SPI1, Data)后面立即拉高CS是什么后果。
     */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">,</span> SPI_I2S_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">SPI_I2S_ReceiveData</span><span class="token punctuation">(</span>FLASH_SPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 读的时候要注意一个问题，因为从模式是没法提供时钟的，所以主模式下必须要在接收的同时提供时钟。
 * 办法就是发送一个字节来实现，因为还是上面说的，发送一个字节就意味着收到一个字节，代码和写完全一样，
 * 只要把读出来的字节保存即可。
 * @return
 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">SPI_FLASH_ReadByte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送与应用不相关的数据，为后续的读数据提供时钟信号</span>
<span class="token punctuation">}</span>

<span class="token class-name">uint32_t</span> <span class="token function">SPI_FLASH_ReadDeviceID</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">uint32_t</span> temp<span class="token punctuation">,</span> temp0<span class="token punctuation">,</span> temp1<span class="token punctuation">,</span> temp2<span class="token punctuation">;</span>

    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 JEDEC 指令，读取设备ID</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_JedecDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取一个字节数据，生产厂商</span>
    temp0 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 读取一个字节数据，存储器类型</span>
    temp1 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 读取一个字节数据，容量</span>
    temp2 <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 把数据组合起来，作为函数的返回值</span>
    temp <span class="token operator">=</span> <span class="token punctuation">(</span>temp0 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>temp1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> temp2<span class="token punctuation">;</span>

    <span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 向 FLASH 发送 写使能 命令
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_WriteEnable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送写使能命令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_WriteEnable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// WIP（BUSY）标志：FLASH 内部正在写入</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WIP_Flag</span>        <span class="token expression"><span class="token number">0x01</span></span></span>

<span class="token comment">/**
 *  等待 WIP(BUSY) 标志被置 0，即等待到 FLASH 内部数据写入完毕
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 状态寄存器 命令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_ReadStatusReg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span> <span class="token operator">&amp;</span> WIP_Flag<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通讯结束：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 擦除 FLASH 扇区
 * @param SectorAddr 要擦除的扇区地址
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_SectorErase</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> SectorAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送 FLASH 写使能命令</span>
    <span class="token function">SPI_FLASH_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 等待 FLASH 空闲</span>
    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 不知道为什么需要等待 200ms ，100ms 不行，问了卖家、正点原子技术支持 都不知道为什么！！！！</span>
    <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始通讯：CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送扇区擦除指令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_SectorErase<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 发送擦除扇区地址的高位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送擦除扇区地址的中位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//发送擦除扇区地址的低位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>SectorAddr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 停止信号 FLASH：CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//等待擦写完毕</span>
    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/**
 * 对 FLASH 按页写入数据，调用本函数写入数据前需要先擦除扇区
 * @param pBuffer 写入的数据指针
 * @param WriteAddr 写入地址
 * @param NumByteToWrite 写入数据长度，必须小于页大小 SPI_FLASH_PerWritePageSize
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> u32 WriteAddr<span class="token punctuation">,</span> u16 NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 发送 FLASH 写使能命令</span>
    <span class="token function">SPI_FLASH_WriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 起始信号 FLASH : CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送页写指令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_PageProgram<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送写地址的高位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WriteAddr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送写地址的中位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WriteAddr <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送写地址的低位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>WriteAddr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumByteToWrite <span class="token operator">&gt;</span> SPI_FLASH_PageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumByteToWrite<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token operator">*</span>pBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止信号 FLASH : CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待写入完毕</span>
    <span class="token function">SPI_FLASH_WaitForWriteEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 对 FLASH 写入数据，调用本函数写入数据前需要先擦除扇区
 * @param pBuffer 写入的指针数据
 * @param WriteAddr 写入地址
 * @param NumByteToWrite 写入数据长度
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_BufferWrite</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> u32 WriteAddr<span class="token punctuation">,</span> u16 NumByteToWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    u8 NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    u8 NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    u8 Addr <span class="token operator">=</span> WriteAddr <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span> <span class="token comment">// WriteAddr 比 整页多出了 多少个字节</span>
    u8 count <span class="token operator">=</span> SPI_FLASH_PageSize <span class="token operator">-</span> Addr<span class="token punctuation">;</span> <span class="token comment">// 差多少个字节，可以对齐整页</span>

    <span class="token comment">// Addr = 0 ，则 WriteAddr 刚好页对齐(aligned)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Addr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//要写入的数据不足一页</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumByteToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> SPI_FLASH_PageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 有多余的不满一页的数据，把它写完</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* WriteAddr 不按页对齐 */</span>

    <span class="token comment">// 写入的数据不足一页</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfPage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// WriteAddr + NumOfSingle 大于 页对齐</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">&gt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 先写满当前页</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
            WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>

            <span class="token comment">// 再写剩余的数据</span>
            <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* WriteAddr 不按页对齐，并且写入的数据超过一页 */</span>

    <span class="token comment">//重新计算页数，和多余数</span>
    NumByteToWrite <span class="token operator">-=</span> count<span class="token punctuation">;</span>
    NumOfPage <span class="token operator">=</span> NumByteToWrite <span class="token operator">/</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    NumOfSingle <span class="token operator">=</span> NumByteToWrite <span class="token operator">%</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>

    <span class="token comment">//先让它对齐</span>
    <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pBuffer <span class="token operator">+=</span> count<span class="token punctuation">;</span>
    WriteAddr <span class="token operator">+=</span> count<span class="token punctuation">;</span>

    <span class="token comment">// 对齐后写入页</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumOfPage<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> SPI_FLASH_PageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
        WriteAddr <span class="token operator">+=</span> SPI_FLASH_PageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 有多余的不满一页的数据，把它写完</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NumOfSingle <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> NumOfSingle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 读取 FLASH 数据
 * @param pBuffer 存储读出数据的指针
 * @param ReadAddr 读取地址
 * @param NumByteToRead 读取数据长度
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_FLASH_BufferRead</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pBuffer<span class="token punctuation">,</span> u32 ReadAddr<span class="token punctuation">,</span> u16 NumByteToRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 起始信号 FLASH : CS 低电平</span>
    <span class="token function">SPI_FLASH_CS_LOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 读 指令</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>W25X_ReadData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送 读 地址高位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF0000</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 读 地址中位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送 读 地址低位</span>
    <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>ReadAddr <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取数据</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>NumByteToRead<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pBuffer <span class="token operator">=</span> <span class="token function">SPI_Flash_SendByte</span><span class="token punctuation">(</span>Dummy_Byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pBuffer<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止信号 FLASH : CS 高电平</span>
    <span class="token function">SPI_FLASH_CS_HIGH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI_FLASH_Test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;********** 16M 串行 FLASH(W25Q128) 实验 **********\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_FLASH_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    u32 FlashId <span class="token operator">=</span> <span class="token function">SPI_FLASH_ReadDeviceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Detected Device : 0x%lx\n&quot;</span><span class="token punctuation">,</span> FlashId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//</span>
    <span class="token keyword">const</span> u32 WriteAddr <span class="token operator">=</span> <span class="token number">0x00000000</span><span class="token punctuation">;</span>
    u8 buffer<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;hello , i like you just like you like me , no body like you than me , hahaha , the just a joke&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//    // 实验板上的 FLASH 芯片默认可能以及存储了有特殊用途的数据，如擦除了这些数据会影响到某些程序的运行</span>
<span class="token comment">//    // 野火说他们预留了“第 0 扇区 (0-4096 地址)”专用于本实验，如非必要，请勿擦除其它地址的内容。（正点原子可能一样）</span>
<span class="token comment">//    // 如已擦除，可在配套资料里找到“刷外部FLASH 内容”程序，根据其说明给FLASH 重新写入出厂内容。</span>
    <span class="token function">SPI_FLASH_SectorErase</span><span class="token punctuation">(</span>WriteAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_FLASH_PageWrite</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Write Content : %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Reset Content : %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SPI_FLASH_BufferRead</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> WriteAddr<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Read Content : %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_spi_flash.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//DMA 传输配置</span>
    <span class="token comment">//USART_DMA_Config();</span>

    <span class="token function">SPI_FLASH_Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意</strong>: 由于实验板上的 FLASH 芯片默认已经存储了特定用途的数据，如擦除了这些数据会 影响到某些程序的运行。所以我们预留了 FLASH 芯片的“第 0 扇区 (0-4096 地址)”专用于 本实验，如非必要，请勿擦除其它地址的内容。如已擦除，可在配套资料里找到“刷外部 FLASH 内容”程序，根据其说明给FLASH 重新写入出厂内容。</p></blockquote><h2 id="串行-flash-文件系统-fatfs" tabindex="-1"><a class="header-anchor" href="#串行-flash-文件系统-fatfs" aria-hidden="true">#</a> 串行 FLASH 文件系统 FatFS</h2><p>FatFs 是面向小型嵌入式系统的一种通用的 FAT 文件系统。它完全是由 ANSIC 语言编写并且完 全独立于底层的 I/O 介质。因此它可以很容易地不加修改地移植到其他的处理器当中，如 8051、 PIC、AVR、SH、Z80、H8、ARM 等。FatFs 支持FAT12、FAT16、FAT32 等格式，所以我们利用 前面写好的SPI Flash 芯片驱动，把FatFs 文件系统代码移植到工程之中，就可以利用文件系统的 各种函数，对SPI Flash 芯片以“文件”格式进行读写操作了。</p><h3 id="各类文件系统" tabindex="-1"><a class="header-anchor" href="#各类文件系统" aria-hidden="true">#</a> 各类文件系统</h3><h4 id="一、fat-fat16-文件系统" tabindex="-1"><a class="header-anchor" href="#一、fat-fat16-文件系统" aria-hidden="true">#</a> 一、FAT（FAT16）文件系统</h4><p>这是MS-DOS和最早期的WIN95操作系统中最常见的硬盘分区格式。它采用16位的文件分配表，能支持最大为2GB的硬盘分区。</p><p>FAT文件系统优点：FAT（FAT16）是目前应用最为广泛和获得操作系统最多的一种磁盘分区格式，几乎所有的操作系统都支持这一种格式，从DOS WINDOWS95/98/NT/ME/2000/XP，甚至LINUX都支持这种分区格式。</p><p>FAT文件系统缺点：最大只支持2GB的分区，而且每个分区最多只能有65525个簇。因此磁盘利用效率非常 低。因为在DOS和WINDOWS系统中，磁盘文件的分配是以簇为单位的，一个簇只分配给一个文件使用，不管这个文件占用整个簇容量的多少。这样，即使一 个文件很小的话，它也要占用一个簇，剩余的空间便全部闲置在那里，形成了磁盘空间的浪费。由于分区表容量的限制，FAT的分区越大，磁盘上每个簇的容量也 越大，造成的浪费也越大。</p><p>FAT文件系统，目前除了一些特殊应用之外，基本上已经不再使用了。试想下，目前主流的硬盘容量已经达到1TB（1TB=1024GB）了，假如使用FAT格式的话，每个分区最大只能2GB，那么电脑里面会有多少个盘符呀！</p><h4 id="二、fat32文件系统" tabindex="-1"><a class="header-anchor" href="#二、fat32文件系统" aria-hidden="true">#</a> 二、FAT32文件系统</h4><p>相信大家对FAT32文件系统不会太陌生，毕竟从Win98开始，FAT32就已经的到了广泛的应用。FAT32格式采用32位的文件分配表，使其对磁盘 的能力大大增强，突破了FAT16对每一个分区的容量只有2GB的限制。Win95以上的操作系统都支持FAT32格式。</p><p>FAT32文件系统优点：突破了FAT对每一个分区的容量只有2GB的限制，可以支持大到2TB（2048G）的分区。在不超过8GB的分区容量下，每个簇的容量都固定为4KB，与FAT16相比，可以大大减少磁盘的浪费，提高磁盘利用率。</p><p>FAT32文件系统缺点：用 FAT32格式分区的磁盘，由于文件分配表的扩大，运行速度比采用FAT16格式分区的磁盘要慢，且DOS系统和某些早期的应用软件不支持这种分区格式。 另外还有一个致命的缺点让FAT32逐渐被淘汰，这就是FAT32的单个文件最大只能支持4GB。现在已经进入高清时代，720P和1080P高清视频文 件都很容易超过4GB，因此FAT32已经走向没落。</p><p>注意：当在windows2000/xp及以后的操作系统中，用自带的磁盘管理工具对硬盘进行分区时，只能创建最大32GB的FAT32文件系统，这是windows限制。用其它第三方工具分区或者DOS或win98下分区，是可以分出更大分区的，而且在windows2000/xp中也能正常使用的。</p><h4 id="三、ntfs文件系统" tabindex="-1"><a class="header-anchor" href="#三、ntfs文件系统" aria-hidden="true">#</a> 三、NTFS文件系统</h4><p>NTFS是从Windows XP系统开始逐渐成为主流的磁盘格式，是微软Windows NT内核的系列操作系统支持的、一个特别为网络和磁盘配额、文件加密等管理安全特性设计的磁盘格式。支持NTFS磁盘格式的操作系统有：WINDOWS NT、WINDOWS2000、WINDOWS2003、WINDOWS XP、WINDOWS vista、WINDOWS7等。因此NTFS目前仍是主流的磁盘格式，有大量用户在使用。</p><p>NTFS文件系统优点：NTFS分区具有极高的安全性和稳定性，在使用中不易产生文件碎片。它能对用户的操作 进行记录，通过对用户权限进行非常严格的限制，使每个用户只能按照系统赋予的权限进行操作，充分保护了系统与数据的安全。另外对大部分用户而言，NTFS 最直观的优点是，单个文件的大小突破了FAT32的4GB的限制。</p><p>NTFS文件系统缺点：NTFS虽然有诸多优点，但这些都是针对传统机械硬盘而设计的，对于新兴的Flash 闪存材料不一定适用。NTFS分区是采用“日志式”的文件系统，因为要记录磁盘的详细读写操作，对U盘这种闪存储介质会造成较大的负担，比如同样存取一个 文件或目录，在NTFS系统上的读写次数就会比FAT32来得多，理论上NTFS格式的U盘比较容易损坏，而且400MB以下的分区也比FAT16更浪费 空间。</p><h4 id="四、exfat文件系统" tabindex="-1"><a class="header-anchor" href="#四、exfat文件系统" aria-hidden="true">#</a> 四、exFAT文件系统</h4><p>exFAT是近年才出现的格式，主要针对移动存储设备，什么闪存、U盘等。因为FAT32格式单个文件不能超过4G，使用NTFS格式又容易损坏闪存芯片，所以才开发EXFAT格式来解决这些问题。</p><p>exFAT文件系统优点：分区大小和单文件大小最大可达16EB（16×1024×1024TB）；簇大小非 常灵活，最小0.5KB，最高达32MB；采用了剩余空间分配表，空间利用率更高；同一目录下最大文件数可达65536个；支持访问控制；支持 TFAT(WINCE早期文件系统)。可以看出，ExFAT就是闪存专用的文件系统，只有U盘和存储卡才能格式化成exFAT，传统硬盘是无法格式化成 exFAT格式的，因为exFAT的特性其实并不比NTFS强，但却比NTFS及FAT32更适合闪存使用。</p><p>exFAT文件系统缺点：exFAT作为一种全新的文件系统，在电脑上的兼容性却不太好，目前主流的XP和Vista默认都不支持ExFAT，XP需升级至SP3补丁、Vista需升级至SP1补丁才能支持它。当然微软也提供了exFAT的单独更新文件，Win7默认支持。</p><h4 id="磁盘文件系统fat、fat32、ntfs、exfat的优缺点" tabindex="-1"><a class="header-anchor" href="#磁盘文件系统fat、fat32、ntfs、exfat的优缺点" aria-hidden="true">#</a> 磁盘文件系统Fat、Fat32、NTFS、exFAT的优缺点</h4><p>我们在Windows系统里格式化磁盘的时候，文件系统的选项里可以看到有“FAT”、“FAT32”、“NTFS”等选项，在对U盘或其他移动存储设备 格式化的时候还会出现“exFAT”选项，那么这四种磁盘格式是什么意思，有哪些优缺点呢？我们应该选择那个呢？下面为大家详细介绍。</p><p>在介绍这四种磁盘格式的区别之前我们先来了解一下什么是磁盘的文件系统。一块没有被格式化过的硬盘，可以比喻成一间没有摆放商品的超市大卖场，在摆放商品 之前，总要先按商品类别分好区域，并安装好货架吧。磁盘的分区、格式化操作就相当于超市大卖场的划分商品区域和安装货架了。</p><blockquote><p><strong>簇</strong>：文件系统最小操作单元。通常来说，磁盘的最小访问单元是扇区，一般是512KB，其实磁盘是可以单字节读写的，但由于flash的特性，字节的每一位都只能从1写成0，要写回1只能把整个扇区擦除，所以干脆把最小操作单元规定为扇区，这样方便快捷。但由于现在的磁盘容量太大了，如果按扇区进行管理就太庞大了，所以文件系统就把若干个扇区划分为一个簇，这样最小管理单元的数量就大大减少，加快磁盘搜索、大文件连续块储存的时间，但这样也是有缺点的，由于簇是最小访问单元，当文件非常小的时候也要用一个簇的空间来储存。比如一个簇设置成了1MB，某个文件1KB，那么存储这个文件就会有约百分之九十的空间浪费掉了。</p></blockquote><blockquote><p><strong>卷</strong> 硬盘上的存储区域。驱动器使用一种文件系统（如 FAT 或 NTFS）格式化卷，并给它指派一个驱动器号。单击“Windows 资源管理器”或“我的电脑”中相应的图标可以查看驱动器的内容。一个硬盘包括好多卷，一卷也可以跨越许多磁盘</p><p><strong>基本卷</strong> 驻留在基本磁盘上的主磁盘分区或逻辑驱动器</p><p><strong>启动卷</strong> 包含 Windows 操作系统及其支持文件的卷。启动卷可以是系统卷，但不必一定是系统卷</p><p><strong>动态卷</strong> 驻留在动态磁盘上的卷。Windows 支持五种类型的动态卷：简单卷、跨区卷、带区卷、镜像卷和 RAID-5 卷。动态卷通过使用文件系统来格式化（例如，FAT 或 NTFS），并有一个分配给它的驱动器号</p><p><strong>镜像卷</strong> 在两个物理磁盘上复制数据的容错卷。通过使用两个相同的卷（被称为镜像），镜像卷提供了数据冗余以便复制包含在卷上的信息。镜像总位于另一个磁盘上。如果其中一个物理磁盘出现故障，则该故障磁盘上的数据将不可用，但是系统可以在其他磁盘上的镜像中继续操作。只能在动态磁盘上创建镜像卷。</p><p><strong>简单卷</strong> 由单个动态磁盘的磁盘空间所组成的动态卷。简单卷可以由磁盘上的单个区域或同一磁盘上链接在一起的多个区域组成。可以在同一磁盘中扩展简单卷，或是扩展到其他磁盘。如果跨多个磁盘扩展简单卷，则该卷将成为跨区卷。只能在动态磁盘上创建简单卷。简单卷不能容错，但是您可以镜像它们以生成一个镜像卷。</p><p><strong>跨区卷</strong> 由多个物理磁盘上的磁盘空间组成的卷。可以通过向其他动态磁盘扩展来增加跨区卷的容量。只能在动态磁盘上创建跨区卷。跨区卷不能容错也不能被镜像。</p><p><strong>带区卷</strong> 以带区形式在两个或多个物理磁盘上存储数据的卷。带区卷上的数据被交替、均匀（以带区形式）的跨磁盘分配。带区卷是所有 Windows 可用的卷中性能最佳的卷，但它们不提供容错。如果带区卷上的磁盘失败，则整个卷上的数据都将丢失。只能在动态磁盘上创建带区卷。带区卷不能被镜像或扩展。</p><p><strong>系统卷</strong> 一个包含用来在 x86 计算机上用 BIOS 装载 Windows 的硬件指定文件的卷。启动卷可以是系统卷，但不必一定是系统卷</p></blockquote><p><strong>前言</strong></p><ol><li>硬件： <ol><li>单片机：stm32f072CB，sram大小16k。（其他单片机只要sram&gt;8k即可通用）</li><li>SPIFlash：W25Q128FV，16Mbyte，单次擦除最小4k。</li></ol></li><li>程序使用的FatFs库版本：ff15。下文所有内容仅保证在此版本可行。</li></ol><p><strong>添加文件</strong></p><ol><li>获取FatFs库（<a href="http://elm-chan.org/fsw/ff/00index_e.html" target="_blank" rel="noopener noreferrer">官网<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）</li><li>将source文件夹全部复制到目标工程中</li><li>添加所有.c文件到工程中，添加相关路径</li></ol><p><strong>移植修改</strong></p><p>需要修改的文件：</p><ol><li><p>integer.h：修改各种整型的宏定义（注：C99--long long对应64位整型）</p></li><li><p>ffconf.h：修改各种设置：（全部宏定义意义见<a href="http://elm-chan.org/fsw/ff/doc/config.html#fs_readonly" target="_blank" rel="noopener noreferrer">官网<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）</p></li><li><ol><li>FF_USE_STRFUNC设为1：开启字符串功能</li><li>FF_USE_MKFS设为1：开启格式化功能</li><li>FF_CODE_PAGE设为936：简体中文</li><li>FF_MIN_SS、FF_MAX_SS设为4096：扇区大小4k</li><li>FF_FS_TINY设为1：文件对象（FIL）不再包括数据缓冲区，而是使用FatFs中的公用缓冲区，适用于RAM偏小的情况。</li><li>FF_FS_NORTC设为1：禁用RTC（时间戳）功能，因为stm32不具备获取时间的功能</li></ol></li><li><p>diskio.c：修改各磁盘IO层操作函数</p><ol><li>修改磁盘设备定义：#define DEV_SPI 0</li><li>修改各函数中case DEV_RAM的操作：stat = STA_NOINIT; 或res = RES_PARERR;</li><li>修改各函数中case DEV_SPI的操作：指向spi_disk.c中的各执行函数</li></ol></li><li></li></ol><p><code>diskio.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 为每个设备定义一个物理编号 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ATA</span>              <span class="token expression"><span class="token number">0</span>  </span><span class="token comment">// 预留 SD 卡使用     /* Example: Map Ramdisk to physical drive 0 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SPI_FLASH</span>        <span class="token expression"><span class="token number">1</span>  </span><span class="token comment">// 外部 SPI Flash    /* Example: Map MMC/SD card to physical drive 1 */</span></span>



DSTATUS <span class="token function">disk_status</span><span class="token punctuation">(</span>
        BYTE pdrv           <span class="token comment">/* 物理编号 */</span>    <span class="token comment">/* Physical drive nmuber to identify the drive */</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DSTATUS stat<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ATA <span class="token operator">:</span>
            stat <span class="token operator">=</span> RES_PARERR<span class="token punctuation">;</span>
            <span class="token keyword">return</span> stat<span class="token punctuation">;</span>

        <span class="token keyword">case</span> SPI_FLASH <span class="token operator">:</span>
            <span class="token comment">/* SPI Flash 状态检测：读取 SPI Flash 设备 ID */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sFLASH_ID <span class="token operator">==</span> <span class="token function">SPI_FLASH_ReadDeviceID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> RES_OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> RES_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> STA_NOINIT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



DSTATUS <span class="token function">disk_initialize</span><span class="token punctuation">(</span>
        BYTE pdrv                <span class="token comment">/* Physical drive nmuber to identify the drive */</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DSTATUS stat<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ATA <span class="token operator">:</span>
            <span class="token keyword">return</span> STA_NOINIT<span class="token punctuation">;</span>

        <span class="token keyword">case</span> SPI_FLASH <span class="token operator">:</span>
            <span class="token function">SPI_FLASH_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SPI_FLASH_Wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stat <span class="token operator">=</span> <span class="token function">disk_status</span><span class="token punctuation">(</span>SPI_FLASH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stat<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> STA_NOINIT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


DRESULT <span class="token function">disk_read</span><span class="token punctuation">(</span>
        BYTE pdrv<span class="token punctuation">,</span>     <span class="token comment">// 设备物理编号   /* Physical drive nmuber to identify the drive */</span>
        BYTE <span class="token operator">*</span>buff<span class="token punctuation">,</span>    <span class="token comment">// 数据缓冲区     /* Data buffer to store read data */</span>
        LBA_t sector<span class="token punctuation">,</span>  <span class="token comment">//扇区地址       /* Start sector in LBA */</span>
        UINT count     <span class="token comment">//扇区个数       /* Number of sectors to read */</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DRESULT res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ATA <span class="token operator">:</span>

            <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>

        <span class="token keyword">case</span> SPI_FLASH <span class="token operator">:</span>
            <span class="token comment">// 扇区偏移 6MB，文件系统空间放在 SPI_FLASH 后面 10MB 空间</span>
            sector <span class="token operator">+=</span> <span class="token number">1536</span><span class="token punctuation">;</span>
            <span class="token function">SPI_FLASH_BufferRead</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> sector <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">,</span> count <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RES_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


DRESULT <span class="token function">disk_write</span><span class="token punctuation">(</span>
        BYTE pdrv<span class="token punctuation">,</span>            <span class="token comment">/* Physical drive nmuber to identify the drive */</span>
        <span class="token keyword">const</span> BYTE <span class="token operator">*</span>buff<span class="token punctuation">,</span>    <span class="token comment">/* Data to be written */</span>
        LBA_t sector<span class="token punctuation">,</span>        <span class="token comment">/* Start sector in LBA */</span>
        UINT count            <span class="token comment">/* Number of sectors to write */</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DRESULT res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ATA <span class="token operator">:</span>
            <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>

        <span class="token keyword">case</span> SPI_FLASH <span class="token operator">:</span>
            sector <span class="token operator">+=</span> <span class="token number">1536</span><span class="token punctuation">;</span>
            u32 write_addr <span class="token operator">=</span> sector <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">;</span>
            <span class="token function">SPI_FLASH_SectorErase</span><span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SPI_FLASH_BufferWrite</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span> buff<span class="token punctuation">,</span> write_addr<span class="token punctuation">,</span> count <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RES_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


DRESULT <span class="token function">disk_ioctl</span><span class="token punctuation">(</span>
        BYTE pdrv<span class="token punctuation">,</span>        <span class="token comment">/* Physical drive nmuber (0..) */</span>
        BYTE cmd<span class="token punctuation">,</span>        <span class="token comment">/* Control code */</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>buff        <span class="token comment">/* Buffer to send/receive control data */</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DRESULT res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pdrv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> ATA <span class="token operator">:</span>

            <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>

        <span class="token keyword">case</span> SPI_FLASH <span class="token operator">:</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> GET_SECTOR_COUNT<span class="token operator">:</span>
                    <span class="token comment">// 扇区数量</span>
                    <span class="token operator">*</span><span class="token punctuation">(</span>DWORD <span class="token operator">*</span><span class="token punctuation">)</span> buff <span class="token operator">=</span> <span class="token number">2560</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> GET_SECTOR_SIZE<span class="token operator">:</span>
                    <span class="token comment">// 扇区大小</span>
                    <span class="token operator">*</span><span class="token punctuation">(</span>DWORD <span class="token operator">*</span><span class="token punctuation">)</span> buff <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> GET_BLOCK_SIZE<span class="token operator">:</span>
                    <span class="token comment">// 这个实际为 同时擦除扇区个数</span>
                    <span class="token operator">*</span><span class="token punctuation">(</span>DWORD <span class="token operator">*</span><span class="token punctuation">)</span> buff <span class="token operator">=</span> <span class="token number">2560</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> RES_OK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> RES_PARERR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/* 时间戳获取 */</span>
DWORD <span class="token function">get_fattime</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2015</span> <span class="token operator">-</span> <span class="token number">1980</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span>    <span class="token comment">/* Year */</span>
           <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span>              <span class="token comment">/* Month 1 */</span>
           <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span>              <span class="token comment">/* day 1 */</span>
           <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">)</span>              <span class="token comment">/* Hour 0  */</span>
           <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span>               <span class="token comment">/* Min 0 */</span>
           <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">/* Sec 0 */</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>get_fattime 函数用于获取当前时间戳，在ﬀ.c 文件中被调用。FatFs 在文件创建、被修改时会记录 时间，这里我们直接使用赋值方法设定时间戳。为更好的记录时间，可以使用控制器 RTC 功能， 具体要求返回值格式为： • bit31:25 ——从1980 至今是多少年，范围是 (0..127) ； • bit24:21 ——月份，范围为(1..12) ； • bit20:16 ——该月份中的第几日，范围为(1..31) ； • bit15:11——时，范围为(0..23)； • bit10:5 ——分，范围为(0..59)； • bit4:0 ——秒/ 2，范围为 (0..29)。</p><p>ﬀconf.h 文件是 FatFs 功能配置文件，我们可以对文件内容进行修改，使得 FatFs 更符合我们的要 求。ﬀconf.h 对每个配置选项都做了详细的使用情况说明。下面只列出修改的配置，其他配置采 用默认即可。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">_USE_MKFS</span>              <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">_CODE_PAGE</span>         <span class="token expression"><span class="token number">936</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">_USE_LFN</span>                   <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>    <span class="token macro-name">_VOLUMES</span>                   <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_MIN_SS</span> <span class="token expression"><span class="token number">512</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_MAX_SS</span> <span class="token expression"><span class="token number">4096</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>_USE_MKFS：格式化功能选择，为使用FatFs 格式化功能，需要把它设置为1。</li><li>_CODE_PAGE：语言功能选择，并要求把相关语言文件添加到工程宏。为支持简体中文文件名 需要使用“936”，正如在图添加 FatFS 文件到工程 的操作，我们已经把 cc936.c 文件添加到工程中（新版本 FatFS 不需要）。</li><li>_USE_LFN：长文件名支持，默认不支持长文件名，这里配置为 2，支持长文件名，并指定使 用栈空间为缓冲区。</li><li>_VOLUMES：指定物理设备数量，这里设置为2，包括预留 SD 卡和SPI Flash 芯片。</li><li>_MIN_SS 、_MAX_SS：指定扇区大小的最小值和最大值。SD 卡扇区大小一般都为 512 字节， SPI Flash 芯片扇区大小一般设置为4096 字节，所以需要把_MAX_SS 改为4096</li></ol><h3 id="fatfs-功能测试" tabindex="-1"><a class="header-anchor" href="#fatfs-功能测试" aria-hidden="true">#</a> FatFs 功能测试</h3><h4 id="文件访问" tabindex="-1"><a class="header-anchor" href="#文件访问" aria-hidden="true">#</a> 文件访问</h4><table><thead><tr><th>名称</th><th>简介</th></tr></thead><tbody><tr><td>f_open</td><td>打开/创建文件</td></tr><tr><td>f_close</td><td>关闭已打开的文件</td></tr><tr><td>f_read</td><td>从文件中读取数据</td></tr><tr><td>f_write</td><td>将数据写入文件</td></tr><tr><td>f_lseek</td><td>移动读/写指针，扩展大小</td></tr><tr><td>f_truncate</td><td>截断文件大小</td></tr><tr><td>f_sync</td><td>刷新缓存数据</td></tr><tr><td>f_forward</td><td>为数据转发到流</td></tr><tr><td>f_expand</td><td>为文件分配连续的块</td></tr><tr><td>f_gets</td><td>读取字符串</td></tr><tr><td>f_puts</td><td>写一个字符</td></tr><tr><td>f_printf</td><td>编写格式化字符串</td></tr><tr><td>f_eof</td><td>文件结尾测试</td></tr><tr><td>f_size</td><td>获取大小</td></tr><tr><td>f_error</td><td>测试错误</td></tr><tr><td>f_tell</td><td>获取当前读/写指针位置</td></tr></tbody></table><h4 id="目录访问" tabindex="-1"><a class="header-anchor" href="#目录访问" aria-hidden="true">#</a> 目录访问</h4><table><thead><tr><th>名称</th><th>简介</th></tr></thead><tbody><tr><td>f_opendir</td><td>打开目录</td></tr><tr><td>f_closedir</td><td>关闭打开的目录</td></tr><tr><td>f_readdir</td><td>读取目录项</td></tr><tr><td>f_findfirst</td><td>打开目录并读取匹配的第一个项目</td></tr><tr><td>f_findnext</td><td>读取下一个匹配的项目</td></tr></tbody></table><h4 id="文件和目录管理" tabindex="-1"><a class="header-anchor" href="#文件和目录管理" aria-hidden="true">#</a> 文件和目录管理</h4><table><thead><tr><th>名称</th><th>简介</th></tr></thead><tbody><tr><td>f_stat</td><td>检查文件或子目录是否存在</td></tr><tr><td>f_unlink</td><td>删除文件或子目录</td></tr><tr><td>f_rename</td><td>重命名/移动文件或子目录</td></tr><tr><td>f_chmod</td><td>更改文件或子目录的属性</td></tr><tr><td>f_utime</td><td>更改文件或子目录的时间戳</td></tr><tr><td>f_mkdir</td><td>创建子目录</td></tr><tr><td>f_chdir</td><td>更改当前目录</td></tr><tr><td>f_chdrive</td><td>更改当前驱动器</td></tr><tr><td>f_getcwd</td><td>检索当前目录和驱动器</td></tr></tbody></table><h4 id="卷管理和系统配置" tabindex="-1"><a class="header-anchor" href="#卷管理和系统配置" aria-hidden="true">#</a> 卷管理和系统配置</h4><table><thead><tr><th>f_mount</th><th>注册/注销卷的工作区域</th></tr></thead><tbody><tr><td>f_mkfs</td><td>在逻辑驱动器上创建 FAT 卷</td></tr><tr><td>f_fdisk</td><td>在物理驱动器上创建分区</td></tr><tr><td>f_getfree</td><td>获取卷上的可用空间</td></tr><tr><td>f_getlabel</td><td>获取卷标</td></tr><tr><td>f_setlabel</td><td>设置卷标</td></tr><tr><td>f_setcp</td><td>设置活动代码页</td></tr></tbody></table><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ff.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    FATFS fs<span class="token punctuation">;</span>						<span class="token comment">// FatFs文件系统对象</span>
    FIL fnew<span class="token punctuation">;</span>   				<span class="token comment">// 文件对象</span>
    FRESULT res_flash<span class="token punctuation">;</span>	<span class="token comment">// 文件操作结果</span>
    UINT fnum<span class="token punctuation">;</span> 					<span class="token comment">// 文件成功读写数量</span>
    BYTE buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello Fuck you I love you \0&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//    u32 work = 4096;</span>

    <span class="token comment">// 挂载 SPI_FLASH 文件系统，文件系统挂载时会对 SPI 设备初始化</span>
    <span class="token comment">//</span>
    <span class="token comment">// opt : 挂载选项: 0 = 不挂载 (延迟挂载)，1 = 立即挂载</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fs<span class="token punctuation">,</span> <span class="token string">&quot;1:&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_NO_FILESYSTEM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***** FLASH 还没有文件系统，即将进行初始化 ***** \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BYTE fucks<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">/* 格式化 */</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_mkfs</span><span class="token punctuation">(</span><span class="token string">&quot;1:&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> fucks<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">!=</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n格式化失败！\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n ***** FLASH 已经成功格式化文件系统 ***** \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*格式化后，取消挂载*/</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;1:&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res_flash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;取消挂载失败！\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 重新挂载 */</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fs<span class="token punctuation">,</span> <span class="token string">&quot;1:&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res_flash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;挂载失败！\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">!=</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n ！！外部 Flash 挂载文件系统失败。(%d)\r\n&quot;</span><span class="token punctuation">,</span> res_flash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n ！！可能原因：SPI Flash 初始化不成功。\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n ***** 文件系统挂载成功，FatFS 写测试 ***** \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token string">&quot;1:hello.txt&quot;</span><span class="token punctuation">,</span> FA_CREATE_ALWAYS <span class="token operator">|</span> FA_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n 写入文件成功，写入字节数据数量，%d : %s\n&quot;</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n 文件写入失败！ \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件打开失败！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n***** FatFS 读测试 *****\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token string">&quot;1:hello.txt&quot;</span><span class="token punctuation">,</span> FA_OPEN_EXISTING <span class="token operator">|</span> FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件打开成功 !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取成功: %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取成功: %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取成功: %s\n&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件读取失败！\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件打开失败！\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>经过测试，不知道是 FLASH 的问题还是什么，比如擦除扇区上个章节 也是搞死人，擦除之前非要等 200ms。</strong></p><p><strong>这里的问题是，函数的返回值 res_flash 和预期结果不一致，时可时不可。所以绝对 TM 的硬件问题。</strong></p></blockquote><h3 id="fatfs-功能使用实验" tabindex="-1"><a class="header-anchor" href="#fatfs-功能使用实验" aria-hidden="true">#</a> FatFs 功能使用实验</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> FRESULT <span class="token function">miscellaneous</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DIR dir<span class="token punctuation">;</span>
    FATFS <span class="token operator">*</span>pfs<span class="token punctuation">;</span>
    DWORD fre_clust<span class="token punctuation">,</span> fre_sect<span class="token punctuation">,</span> tot_sect<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n*************** 设备信息获取 ***************\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* 获取设备信息和空簇大小 */</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_getfree</span><span class="token punctuation">(</span><span class="token string">&quot;1:&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fre_clust<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pfs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/* 计算得到总的扇区个数和空扇区个数 */</span>
    tot_sect <span class="token operator">=</span> <span class="token punctuation">(</span>pfs<span class="token operator">-&gt;</span>n_fatent <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> pfs<span class="token operator">-&gt;</span>csize<span class="token punctuation">;</span>
    fre_sect <span class="token operator">=</span> fre_clust <span class="token operator">*</span> pfs<span class="token operator">-&gt;</span>csize<span class="token punctuation">;</span>
		<span class="token comment">/* 打印信息 (4096 字节/扇区) */</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;》设备总空间：%10lu  KB。\n》可用空间： %10lu    KB。\n&quot;</span><span class="token punctuation">,</span>
           tot_sect <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> fre_sect <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n********    文件定位和格式化写入功能测试 ********\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token string">&quot;1:FatFs 读写测试文件.txt&quot;</span><span class="token punctuation">,</span>
                       FA_OPEN_EXISTING <span class="token operator">|</span> FA_WRITE <span class="token operator">|</span> FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">/* 文件定位 */</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_lseek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token function">f_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>	
						<span class="token comment">/* 格式化写入，参数格式类似 printf    函数 */</span>
            <span class="token function">f_printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token string">&quot;\n在原来文件新添加一行内容\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">f_printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token string">&quot;》设备总空间：%10lu    KB。\n》可用空间： %10lu    KB。\n&quot;</span><span class="token punctuation">,</span>
            tot_sect <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> fre_sect <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">/* 文件定位到文件起始位置 */</span>
            res_flash <span class="token operator">=</span> <span class="token function">f_lseek</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">/* 读取文件所有内容到缓存区 */</span>
            res_flash <span class="token operator">=</span> <span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">,</span> readbuffer<span class="token punctuation">,</span> <span class="token function">f_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;》文件内容：\n%s\n&quot;</span><span class="token punctuation">,</span> readbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fnew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n**********    目录创建和重命名功能测试 **********\r\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">/* 尝试打开目录 */</span>
        res_flash <span class="token operator">=</span> <span class="token function">f_opendir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> <span class="token string">&quot;1:TestDir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">!=</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token comment">/* 打开目录失败，就创建目录 */</span>
            res_flash <span class="token operator">=</span> <span class="token function">f_mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;1:TestDir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						<span class="token comment">/* 如果目录已经存在，关闭它 */</span>
            res_flash <span class="token operator">=</span> <span class="token function">f_closedir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token comment">/* 删除文件 */</span>
            <span class="token function">f_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;1:TestDir/testdir.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">/* 重命名并移动文件 */</span>
            res_flash <span class="token operator">=</span> <span class="token function">f_rename</span><span class="token punctuation">(</span><span class="token string">&quot;1:FatFs 读写测试文件.txt&quot;</span><span class="token punctuation">,</span>
                                 <span class="token string">&quot;1:TestDir/testdir.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;!! 打开文件失败：%d\n&quot;</span><span class="token punctuation">,</span> res_flash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;!! 或许需要再次运行“FatFs    移植与读写测试”工程\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res_flash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>




<span class="token keyword">static</span> FRESULT <span class="token function">file_check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FILINFO fno<span class="token punctuation">;</span>
<span class="token comment">/* 获取文件信息 */</span>
    res_flash <span class="token operator">=</span> <span class="token function">f_stat</span><span class="token punctuation">(</span><span class="token string">&quot;1:TestDir/testdir.txt&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>fno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res_flash <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;“testdir.txt”文件信息：\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;》文件大小: %ld(字节)\n&quot;</span><span class="token punctuation">,</span> fno<span class="token punctuation">.</span>fsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;》时间戳: %u/%02u/%02u, %02u:%02u\n&quot;</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fdate <span class="token operator">&gt;&gt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1980</span><span class="token punctuation">,</span> fno<span class="token punctuation">.</span>fdate <span class="token operator">&gt;&gt;</span> <span class="token number">5</span> <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">,</span> fno<span class="token punctuation">.</span>fdate <span class="token operator">&amp;</span> <span class="token number">31</span><span class="token punctuation">,</span>
               fno<span class="token punctuation">.</span>ftime <span class="token operator">&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">,</span> fno<span class="token punctuation">.</span>ftime <span class="token operator">&gt;&gt;</span> <span class="token number">5</span> <span class="token operator">&amp;</span> <span class="token number">63</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;》属性: %c%c%c%c%c\n\n&quot;</span><span class="token punctuation">,</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_DIR<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token char">&#39;D&#39;</span> <span class="token operator">:</span> <span class="token char">&#39;-&#39;</span><span class="token punctuation">,</span>       <span class="token comment">// 是一个目录</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_RDO<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token char">&#39;R&#39;</span> <span class="token operator">:</span> <span class="token char">&#39;-&#39;</span><span class="token punctuation">,</span>       <span class="token comment">// 只读文件</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_HID<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token char">&#39;H&#39;</span> <span class="token operator">:</span> <span class="token char">&#39;-&#39;</span><span class="token punctuation">,</span>       <span class="token comment">// 隐藏文件</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_SYS<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token char">&#39;S&#39;</span> <span class="token operator">:</span> <span class="token char">&#39;-&#39;</span><span class="token punctuation">,</span>      <span class="token comment">// 系统文件</span>
               <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_ARC<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">:</span> <span class="token char">&#39;-&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 档案文件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res_flash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">static</span> FRESULT <span class="token function">scan_files</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FRESULT res<span class="token punctuation">;</span>       <span class="token comment">//部分在递归过程被修改的变量，不用全局变量</span>
    FILINFO fno<span class="token punctuation">;</span>
    DIR dir<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>fn<span class="token punctuation">;</span>           <span class="token comment">// 文件名</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_USE_LFN</span></span>
    <span class="token comment">/* 长文件名支持 */</span>
    <span class="token comment">/* 简体中文需要 2 个字节保存一个“字”*/</span>
   <span class="token keyword">static</span> <span class="token keyword">char</span> lfn<span class="token punctuation">[</span>_MAX_LFN<span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   fno<span class="token punctuation">.</span>lfname <span class="token operator">=</span> lfn<span class="token punctuation">;</span>
   fno<span class="token punctuation">.</span>lfsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>lfn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token comment">//打开目录</span>
    res <span class="token operator">=</span> <span class="token function">f_opendir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FR_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//读取目录下的内容，再读会自动读下一个文件</span>
            res <span class="token operator">=</span> <span class="token function">f_readdir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fno<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//为空时表示所有项目读取完毕，跳出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> FR_OK <span class="token operator">||</span> fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_USE_LFN</span></span>
            fn <span class="token operator">=</span> <span class="token operator">*</span>fno<span class="token punctuation">.</span>lfname <span class="token operator">?</span> fno<span class="token punctuation">.</span>lfname <span class="token operator">:</span> fno<span class="token punctuation">.</span>fname<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
            fn <span class="token operator">=</span> fno<span class="token punctuation">.</span>fname<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
            <span class="token comment">//点表示当前目录，跳过</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fn <span class="token operator">==</span> <span class="token char">&#39;.&#39;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment">//目录，递归读取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fattrib <span class="token operator">&amp;</span> AM_DIR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//合成完整目录名</span>
                <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;/%s&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//递归遍历</span>
                res <span class="token operator">=</span> <span class="token function">scan_files</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                path<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">//打开失败，跳出循环</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> FR_OK<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s/%s\r\n&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/* 可以在这里提取特定格式的文件路径 */</span>
            <span class="token punctuation">}</span><span class="token comment">//else</span>
        <span class="token punctuation">}</span> <span class="token comment">//for</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="fsmc—扩展外部sram" tabindex="-1"><a class="header-anchor" href="#fsmc—扩展外部sram" aria-hidden="true">#</a> FSMC—扩展外部SRAM</h2><p>本章参考资料：《STM32F4XX-参考手册》FSMC 章节。 关于SRAM 存储器，请参考“常用存储器介绍”章节，实验中FLASH 芯片的具体参数，请参考 其规格书《IS62WV51216》来了解。</p><h3 id="sram-控制原理" tabindex="-1"><a class="header-anchor" href="#sram-控制原理" aria-hidden="true">#</a> SRAM 控制原理</h3><p>STM32 控制器芯片内部有一定大小的 SRAM 及 FLASH 作为内存和程序存储空间，但当程序较 大，内存和程序空间不足时，就需要在STM32 芯片的外部扩展存储器了。</p><p>扩展内存时一般使用 SRAM 和 SDRAM 存储器，但 STM32F407 系列的芯片不支持扩展 SDRAM(STM32F429 系列支持)，它仅支持使用 FSMC 外设扩展 SRAM，我们以 SRAM 为例讲 解如何为STM32 扩展内存。</p><p>给STM32 芯片扩展内存与给PC 扩展内存的原理是一样的，只是PC 上一般以内存条的形式扩展， 内存条实质是由多个内存颗粒(即SRAM 芯片) 组成的通用标准模块，而STM32 直接与SRAM 芯 片连接。</p><p>见图一种 SRAM 芯片的内部结构框图 ，这是我们实验板上使用的型号为 IS62WV51216 的 SRAM 芯片内部结构框图，以它为模型进行学习。</p><p>见图一种 SRAM 芯片的内部结构框图 ，这是我们实验板上使用的型号为 IS62WV51216 的 SRAM 芯片内部结构框图，以它为模型进行学习。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160109820.png" alt="QQ20221116-010928"></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160110324.png" alt="QQ20221116-010835" style="zoom:50%;"><h4 id="sram-信号线" tabindex="-1"><a class="header-anchor" href="#sram-信号线" aria-hidden="true">#</a> SRAM 信号线</h4><p>图一种 SRAM 芯片的内部结构框图 中左侧引出的是 SRAM 芯片的控制引脚，其说明见表 SRAM 控制引脚说明。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160134259.png" alt="image-20221116013427150"></p><p>SRAM 的控制比较简单，只要控制信号线使能了访问，从地址线输入要访问的地址，即可从 I/O 数据线写入或读出数据。</p><h4 id="存储器矩阵" tabindex="-1"><a class="header-anchor" href="#存储器矩阵" aria-hidden="true">#</a> 存储器矩阵</h4><p>框图中标号处表示的是存储器矩阵，这个 SRAM 芯片的空间大小为 512Kx16(bits)，见图 SRAM 存储阵列模型。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160136368.png" alt="image-20221116013643291" style="zoom:50%;"><p>SRAM 内部包含的存储阵列，可以把它理解成一张表格，数据就填在这张表格上。和表格查找一 样，指定一个行地址和列地址，就可以精确地找到目标单元格，这是 SRAM 芯片寻址的基本原 理。这样的每个单元格被称为存储单元，而这样的表则被称为存储矩阵。</p><h4 id="地址译码器、列-i-o-及-i-o-数据电路" tabindex="-1"><a class="header-anchor" href="#地址译码器、列-i-o-及-i-o-数据电路" aria-hidden="true">#</a> 地址译码器、列 I/O 及 I/O 数据电路</h4><ul><li><p>地址译码器把 N 根地址线转换成2N 根信号线，每根信号线对应一行或一列存储单元，通过地址线找到具体的存储单元，实现寻址。</p></li><li><p>如果存储阵列比较大，地址线会分成行和列地址，或者行、列分时复用同一地址总线，访问数据寻址时先用地址线传输行地址再传输列地址。</p></li><li><p><strong>本实例中的 SRAM 比较小，没有列地址线，它的数据宽度为 16 位，即一个行地址对应 2 字节空间，框图中左侧的 A0-A18 是行址信号，19 根地址线的寻址范围 ： 2^19 = 512KB；512 x 16bits(2Byte) = 1MB 存储大小。</strong></p></li><li><p><strong>访问时，使用 UB# 或LB# 线控制数据宽度，例如，当要访问宽度为 16 位的数据时，使用行地址线指出地址，然后把 UB# 和 LB# 线都设置为低电平，那么I/O0-I/O15 线都有效，它们一起输出该地址的16 位数据(或者接收16 位数据到该地址)；</strong></p></li><li><p><strong>当要访问宽度为 8 位的数据时，使用行地址线指出地址，然后把 UB# 或 LB# 其中一个设置为低电平，I/O 会对应输出该地址的高 8 位和低 8 位数据，因此它们被称为数据掩码信号。</strong></p></li></ul><h4 id="控制电路" tabindex="-1"><a class="header-anchor" href="#控制电路" aria-hidden="true">#</a> 控制电路</h4><p>控制电路主要包含了片选、读写使能以及上面提到的宽度控制信号 UB# 和 LB#。利用 CS2 或 CS1# 片选信号，可以把多个 SRAM 芯片组成一个大容量的内存条。OE# 和 WE# 可以控制读写 使能，防止误操作。</p><h4 id="sram-的读写流程" tabindex="-1"><a class="header-anchor" href="#sram-的读写流程" aria-hidden="true">#</a> SRAM 的读写流程</h4><p>对SRAM 进行读写数据时，它各个信号线的时序流程见图SRAM 的读时序及图SRAM 的写时序。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160147465.png" alt="image-20221116014725355" style="zoom:50%;"><p>读写时序的流程很类似：</p><p>(1) 主机使用地址信号线发出要访问的存储器目标地址；</p><p>(2) 控制片选信号 CS1# 及CS2# 使能存储器芯片；</p><p>(3) 若是要进行读操作，则控制读使能信号OE# 表示要读数据，若进行写操作则控制写使能信号 WE# 表示要写数据；</p><p>(4) 使用掩码信号 LB# 与 UB# 指示要访问目标地址的高、低字节部分；</p><p>(5) 若是读取过程，存储器会通过数据线向主机输出目标数据，若是写入过程，主要使用数据线向存储器传输目标数据。</p><p>在读写时序中，有几个比较重要的时间参数，在使用 STM32 控制的时候需要参考，它们的介绍见表 IS62WV51216BLL-55ns 型号SRAM 的时间参数。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160149778.png" alt="image-20221116014935680"></p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211172057186.png" alt="image-20221117205728832"></p><h3 id="fsmc" tabindex="-1"><a class="header-anchor" href="#fsmc" aria-hidden="true">#</a> FSMC</h3><h4 id="简介-1" tabindex="-1"><a class="header-anchor" href="#简介-1" aria-hidden="true">#</a> 简介</h4><p>STM32F407 系列芯片使用FSMC 外设来管理扩展的存储器，FSMC 是Flexible Static Memory Con-troller 的缩写，译为<strong>灵活的静态存储控制器</strong>。它可以用于驱动包括 SRAM、NOR FLASH 以及 NANDFLSAH 类型的存储器，不能驱动如SDRAM 这种动态的存储器而在STM32F429 系列的控 制器中，它具有FMC 外设，支持控制SDRAM 存储器。</p><h4 id="fsmc-框图剖析" tabindex="-1"><a class="header-anchor" href="#fsmc-框图剖析" aria-hidden="true">#</a> FSMC 框图剖析</h4><p>STM32 的 FSMC 外设内部结构见图 FSMC 控制器框图。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160154297.png" alt="image-20221116015436197" style="zoom:50%;"><h4 id="通讯引脚-2" tabindex="-1"><a class="header-anchor" href="#通讯引脚-2" aria-hidden="true">#</a> 通讯引脚</h4><p>在框图的右侧是 FSMC 外设相关的控制引脚，由于控制不同类型存储器的时候会有一些不同的 引脚，看起来有非常多，其中地址线 FSMC_A 和数据线 FSMC_D 是所有控制器都共用的。这些 FSMC 引脚具体对应的GPIO 端口及引脚号可在《STM32F4xx 规格书》中搜索查找到，不在此列 出。针对本示例中的 SRAM 控制器，我们整理出以下的 FSMC 与 SRAM 引脚对照表 FSMC 中的 SRAM 控制信号线。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160155377.png" alt="image-20221116015535286"></p><p>其中比较特殊的 FSMC_NE 是用于控制 SRAM 芯片的片选控制信号线，STM32 具有 FSMC_NE1/2/3/4 号引脚，不同的引脚对应 STM32 内部不同的地址区域。</p><p>例如，当 STM32 访问 0x6C000000-0x6FFFFFFF 地址空间时，FSMC_NE3 引脚会自动设置为低电平，由于它连接到 SRAM 的 CE# 引脚，所以 SRAM 的片选被使能，而访问 0x60000000-0x63FFFFFF 地址时，FSMC_NE1 会输出低电平。</p><p>当使用不同的FSMC_NE 引脚连接外部存储器时，STM32 访问SRAM的地址不一样，从而达到控制多块SRAM 芯片的目的。各引脚对应的地址会在后面“FSMC 的地址映射”小节讲解。</p><h4 id="存储器控制器" tabindex="-1"><a class="header-anchor" href="#存储器控制器" aria-hidden="true">#</a> 存储器控制器</h4><p>上面不同类型的引脚是连接到 FSMC 内部对应的存储控制器中的。NOR/PSRAM/SRAM 设备使 用相同的控制器，NAND/PC 卡设备使用相同的控制器，不同的控制器有专用的寄存器用于配置 其工作模式。</p><p>控制 SRAM 的有 FSMC_BCR1/2/3/4 控制寄存器、FSMC_BTR1/2/3/4 片选时序寄存器以及 FSMC_BWTR1/2/3/4 写时序寄存器。每种寄存器都有 4 个，分别对应于 4 个不同的存储区域， 各种寄存器介绍如下：</p><ul><li>FSMC_BCR 控制寄存器可配置要控制的存储器类型、数据线宽度以及信号有效极性能参数。</li><li>FMC_BTR 时序寄存器用于配置 SRAM 访问时的各种时间延迟，如数据保持时间、地址保 持时间等。</li><li>FMC_BWTR 写时序寄存器与 FMC_BTR 寄存器控制的参数类似，它专门用于控制写时序 的时间参数。</li></ul><h4 id="时钟控制逻辑-2" tabindex="-1"><a class="header-anchor" href="#时钟控制逻辑-2" aria-hidden="true">#</a> 时钟控制逻辑</h4><p>FSMC 外设挂载在AHB 总线上，时钟信号来自于HCLK(默认168MHz)，FSMC 控制器的同步时钟输出就是由它分频得到。例如，NOR 控制器的FSMC_CLK 引脚输出的时钟，它可用于与同步类型的 SRAM 芯片进行同步通讯，它的时钟频率可通过 FSMC_BTR 寄存器的 CLKDIV 位配置，可以配置为 HCLK 的 1/2 或 1/3，也就是说，若它与同步类型的 SRAM 通讯时，同步时钟最高频率为 84MHz。<strong>本示例中的 SRAM 为异步类型的存储器，不使用同步时钟信号，所以时钟分频配置不</strong><strong>起作用</strong>。</p><h4 id="fsmc-的地址映射" tabindex="-1"><a class="header-anchor" href="#fsmc-的地址映射" aria-hidden="true">#</a> FSMC 的地址映射</h4><p>FSMC 连接好外部的存储器并初始化后，就可以直接通过访问地址来读写数据，这种地址访问与 I2C EEPROM、SPI FLASH 的不一样，后两种方式都需要控制I2C 或SPI 总线给存储器发送地址， 然后获取数据；在程序里，这个地址和数据都需要分开使用不同的变量存储，并且访问时还需要使用代码控制发送读写命令。</p><p>而使用 FSMC 外接存储器时，其存储单元是映射到 STM32 的内部寻址空间的；</p><p>**在程序里，定义一个指向这些地址的指针，然后就可以通过指针直接修改该存储单元的内容，FSMC 外设会自动完成数据访问过程，读写命令之类的操作不需要程序控制。**FSMC 的地址映射见图FSMC 的地址映射。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160204834.png" alt="image-20221116020420739" style="zoom:50%;"><p>图中左侧的是 Cortex-M4 内核的存储空间分配，右侧是 STM32 FSMC 外设的地址映射。可以看 到FSMC 的NOR/PSRAM/SRAM/NAND FLASH 以及PC 卡的地址都在ExternalRAM 地址空间内。</p><p>正是因为存在这样的地址映射，使得访问 FSMC 控制的存储器时，就跟访问 STM32 的片上外设 寄存器一样 (片上外设的地址映射即图中左侧的“Peripheral”区域)。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160208199.png" alt="image-20221116020824102"></p><p>FSMC 把整个 External RAM 存储区域分成了 4 个 Bank 区域，并分配了地址范围及适用的存储器 类型，如NOR 及SRAM 存储器只能使用Bank1 的地址。</p><p>在每个Bank 的内部又分成了4 个小块，每个小块有相应的控制引脚用于连接片选信号，如 FSMC_NE[4:1] 信号线可用于选择 BANK1 内部的4 小块地址区域，见图Bank1 内部的小块地址分配，当STM32 访问0x68000000-0x6BFFFFFF地址空间时，会访问到Bank1 的第4 小块区域，相应的FSMC_NE3 信号线会输出控制信号。</p><h4 id="fsmc-控制-sram-的时序" tabindex="-1"><a class="header-anchor" href="#fsmc-控制-sram-的时序" aria-hidden="true">#</a> FSMC 控制 SRAM 的时序</h4><p>FSMC 外设支持输出多种不同的时序以便于控制不同的存储器，它具有ABCD 四种模式，下面我 们仅针对控制SRAM 使用的模式A 进行讲解，见图FSMC 模式A 的读时序及图FSMC 模式A 的 写时序。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160216532.png" alt="image-20221116021611441" style="zoom:50%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160216071.png" alt="image-20221116021627975" style="zoom:50%;"><p>当内核发出访问某个指向外部存储器地址时，FSMC 外设会根据配置控制信号线产生时序访问存 储器，上图中的是访问外部SRAM 时 FSMC 外设的读写时序。</p><ul><li><p>以读时序为例，该图表示一个存储器操作周期由地址建立周期 (ADDSET)、数据建立周期 (DATAST) 以及 2 个 HCLK 周期组成。在地址建立周期中，地址线发出要访问的地址，数据掩 码信号线指示出要读取地址的高、低字节部分，片选信号使能存储器芯片；</p></li><li><p>地址建立周期结束后读使能信号线发出读使能信号，接着存储器通过数据信号线把目标数据传输给 FSMC，FSMC 把它交给内核。</p></li><li><p>写时序类似，区别是它的一个存储器操作周期仅由地址建立周期 (ADDSET) 和数据建立周期 (DATAST) 组成，且在数据建立周期期间写使能信号线发出写信号，接着 FSMC 把数据通过数 据线传输到存储器中。</p></li></ul><h4 id="sram-时序结构体" tabindex="-1"><a class="header-anchor" href="#sram-时序结构体" aria-hidden="true">#</a> SRAM 时序结构体</h4><p>控制 FSMC 使用 SRAM 存储器时主要是配置时序寄存器以及控制寄存器，利用 ST 标准库的 SRAM 时序结构体以及初始化结构体可以很方便地写入参数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> FSMC_AddressSetupTime<span class="token punctuation">;</span> <span class="token comment">/* 地址建立时间，0-0xF 个 HCLK 周期 */</span> 
<span class="token class-name">uint32_t</span> FSMC_AddressHoldTime<span class="token punctuation">;</span> 	<span class="token comment">/* 地址保持时间，0-0xF 个 HCLK 周期 */</span>
<span class="token class-name">uint32_t</span> FSMC_DataSetupTime<span class="token punctuation">;</span>		<span class="token comment">/* 地址建立时间，0-0xF 个 HCLK 周期 */</span>
<span class="token class-name">uint32_t</span> FSMC_BusTurnAroundDuration<span class="token punctuation">;</span><span class="token comment">/* 总线转换周期,0-0xF 个 HCLK 周期，在 NOR FLASH */</span>
<span class="token class-name">uint32_t</span> FSMC_CLKDivision<span class="token punctuation">;</span>	<span class="token comment">/* 时钟分频因子,1-0xF，若控制异步存储器，本参数无效 */</span> 
<span class="token class-name">uint32_t</span> FSMC_DataLatency<span class="token punctuation">;</span> 	<span class="token comment">/* 数据延迟时间，若控制异步存储器，本参数无效 */</span>
<span class="token class-name">uint32_t</span> FSMC_AccessMode<span class="token punctuation">;</span> 	<span class="token comment">/* 设置访问模式 */</span>
<span class="token punctuation">}</span> FSMC_NORSRAMTimingInitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个结构体成员定义的都是 SRAM 读写时序中的各项时间参数，这些成员的的参数都与 FSMC_BRT 及 FSMC_BWTR 寄存器配置对应，各个成员介绍如下：</p><ul><li><p><code>FSMC_AddressSetupTime</code> 本成员设置地址建立时间，即FSMC 读写时序图 FSMC 模式A 的读时序中的ADDSET值，它可以被设置为 0-0xF 个HCLK 周期数，按STM32 标准库的默认配置，HCLK 的时钟频率为168MHz，即一个HCLK 周期为1/168 微秒。</p></li><li><p><code>FSMC_AddressHoldTime</code> 本成员设置地址保持时间，它可以被设置为0-0xF 个HCLK 周期数。</p></li><li><p><code>FSMC_DataSetupTime</code> 本成员设置数据建立时间，即FSMC 读写时序图FSMC 模式A 的写时序中的DATAST值，它可以被设置为0-0xF 个 HCLK 周期数。</p></li><li><p><code>FSMC_BusTurnAroundDuration</code> 本成员设置总线转换周期，在NOR FLASH 存储器中，地址线与数据线可以分时复用，总线转换周期就是指总线在这两种状态间切换需要的延时，防止冲突。控制其它存储器时这个参数无效，配置为0 即可。</p></li><li><p><code>FSMC_CLKDivision</code> 本成员用于设置时钟分频，它以HCLK 时钟作为输入，经过FSMC_CLKDivision 分频后输出到 FSMC_CLK 引脚作为通讯使用的同步时钟。控制其它异步通讯的存储器时这个参数无效，配置为0 即可。</p></li><li><p><code>FSMC_DataLatency</code> 本成员设置数据保持时间，它表示在读取第一个数据之前要等待的周期数，该周期指同步时钟的周期，本参数仅用于同步NOR FLASH 类型的存储器，控制其它类型的存储器时，本参数无效。</p></li><li><p><code>FSMC_AccessMode</code> 本成员设置存储器访问模式，不同的模式下FSMC 访问存储器地址时引脚输出的时序不一样，可选 FSMC_AccessMode_A/B/C/D 模式。一般来说控制SRAM 时使用A 模式。</p></li></ul><p>这个 FSMC_NORSRAMTimingInitTypeDef 时序结构体配置的延时参数，将作为下一节的 FSMC SRAM 初始化结构体的一个成员。</p><h4 id="sram-初始化结构体" tabindex="-1"><a class="header-anchor" href="#sram-初始化结构体" aria-hidden="true">#</a> SRAM 初始化结构体</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> FSMC_Bank<span class="token punctuation">;</span>								<span class="token comment">/* 设置要控制的 Bank 区域 */</span>
<span class="token class-name">uint32_t</span> FSMC_DataAddressMux<span class="token punctuation">;</span> 		<span class="token comment">/* 设置地址总线与数据总线是否复用 */</span>
<span class="token class-name">uint32_t</span> FSMC_MemoryType<span class="token punctuation">;</span>					<span class="token comment">/* 设置存储器的类型 */</span>
<span class="token class-name">uint32_t</span> FSMC_MemoryDataWidth<span class="token punctuation">;</span>		<span class="token comment">/* 设置存储器的数据宽度 */</span>
<span class="token class-name">uint32_t</span> FSMC_BurstAccessMode<span class="token punctuation">;</span>		<span class="token comment">/* 设置是否支持突发访问模式，只支持同步类型的存储器 */</span>
<span class="token class-name">uint32_t</span> FSMC_AsynchronousWait<span class="token punctuation">;</span> 	<span class="token comment">/* 设置是否使能在同步传输时的等待信号，*/</span> 
<span class="token class-name">uint32_t</span> FSMC_WaitSignalPolarity<span class="token punctuation">;</span>	<span class="token comment">/* 设置等待信号的极性 */</span>
<span class="token class-name">uint32_t</span> FSMC_WrapMode<span class="token punctuation">;</span>						<span class="token comment">/* 设置是否支持对齐的突发模式 */</span>
<span class="token class-name">uint32_t</span> FSMC_WaitSignalActive<span class="token punctuation">;</span>		<span class="token comment">/* 配置等待信号在等待前有效还是等待期间有效 */</span> 
<span class="token class-name">uint32_t</span> FSMC_WriteOperation<span class="token punctuation">;</span>			<span class="token comment">/* 设置是否写使能 */</span>
<span class="token class-name">uint32_t</span> FSMC_WaitSignal<span class="token punctuation">;</span>					<span class="token comment">/* 设置是否使能等待状态插入 */</span>
<span class="token class-name">uint32_t</span> FSMC_ExtendedMode<span class="token punctuation">;</span>				<span class="token comment">/* 设置是否使能扩展模式 */</span>
<span class="token class-name">uint32_t</span> FSMC_WriteBurst<span class="token punctuation">;</span>					<span class="token comment">/* 设置是否使能写突发操作 */</span>
FSMC_NORSRAMTimingInitTypeDef<span class="token operator">*</span> FSMC_ReadWriteTimingStruct<span class="token punctuation">;</span> <span class="token comment">/* 当不使用扩展模式时，本参数用于配置读写时序，否则用于配置读时序 */</span> 
FSMC_NORSRAMTimingInitTypeDef<span class="token operator">*</span> FSMC_WriteTimingStruct<span class="token punctuation">;</span> <span class="token comment">/* 当使用扩展模式时，本参数用于配置写时序 */</span>
<span class="token punctuation">}</span>FSMC_NORSRAMInitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个结构体，除最后两个成员是上一小节讲解的时序配置外，其它结构体成员的配置都对应到 FSMC_BCR 中的寄存器位。各个成员意义介绍如下，括号中的是STM32 标准库定义的宏：</p><ul><li><p><code>FSMC_Bank</code> 本成员用于选择 FSMC 映射的存储区域，它的可选参数以及相应的内核地址映射范围见表可以选择的存储器区域及区域对应的地址范围。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211160235442.png" alt="image-20221116023500345"></p></li><li><p><code>FSMC_DataAddressMux</code> 本成员用于设置地址总线与数据总线是否复用 (FSMC_DataAddressMux_Enable /Disable)，在控制NOR FLASH 时，可以地址总线与数据总线可以分时复用，以减少使用 STM32 信号线的数量。</p></li><li><p><code>FSMC_MemoryType</code> 本成员用于设置要控制的存储器类型，它支持控制的存储器类型为 SRAM、PSRAM 以及NOR FLASH(FSMC_MemoryType_SRAM/PSRAM/NOR)。</p></li><li><p><code>FSMC_MemoryDataWidth</code> 本成员用于设置要控制的存储器的数据宽度，可选择设置成 8 或 16 位(FSMC_MemoryDataWidth_8b /16b)。</p></li><li><p><code>FSMC_BurstAccessMode</code> 本成员用于设置是否使用突发访问模式 (FSMC_BurstAccessMode_Enable/Disable)，突发访问模式是指发送一个地址后连续访问多个数据，非突发模式下每访问一个数据都需要输入一个地址，仅在控制同步类型的存储器时才能使用突发模式。</p></li><li><p><code>FSMC_AsynchronousWait</code> 本成员用于设置是否使能在同步传输时使用的等待信号 (FSMC_AsynchronousWait_Enable/Disable)，在控制同步类型的 NOR 或 PSRAM 时，存储器可以使用FSMC_NWAIT 引脚通知STM32 需要等待。</p></li><li><p><code>FSMC_WaitSignalPolarity</code> 本成员用于设置等待信号的有效极性，即要求等待时，使用高电平还是低电平 (FSMC_WaitSignalPolarity_High/Low)</p></li><li><p><code>FSMC_WrapMode</code> 本成员用于设置是否支持把非对齐的 AHB 突发操作分割成 2 次线性操作 (FSMC_WrapMode_Enable/Disable)，该配置仅在突发模式下有效。</p></li><li><p><code>FSMC_WaitSignalActive</code> 本成员用于配置在突发传输模式时，决定存储器是在等待状态之前的一个数据周期有效还是在等待状态期间有效 (FSMC_WaitSignalActive_BeforeWaitState/DuringWaitState)。</p></li><li><p><code>FSMC_WriteOperation</code> 这个成员用于设置是否写使能(FSMC_WriteOperation_Enable/Disable)，禁止写使能的话 FSMC 只能从存储器中读取数据，不能写入。</p></li><li><p><code>FSMC_WaitSignal</code> 本成员用于设置当存储器处于突发传输模式时，是否允许通过NWAIT 信号插入等待状态(FSMC_WaitSignal_Enable/Disable)。</p></li><li><p><code>FSMC_ExtendedMode</code> 本成员用于设置是否使用扩展模式 (FSMC_ExtendedMode_Enable/Disable)，在非扩展模式下，对存储器读写的时序都只使用 FSMC_BCR 寄存器中的配置，即下面的FSMC_ReadWriteTimingStruct 结构体成员；在扩展模式下，对存储器的读写时序可以分开配置，读时序使用FSMC_BCR 寄存器，写时序使用FSMC_BWTR 寄存器的配置，即下面的FSMC_WriteTimingStruct 结构体。</p></li><li><p><code>FSMC_WriteBurst</code> 设置是否使能写突发操作</p></li><li><p><code>FSMC_ReadWriteTimingStruct</code> 本成员是一个指针，赋值时使用上一小节中讲解的时序结构体FSMC_NORSRAMInitTypeDef设置，当不使用扩展模式时，读写时序都使用本成员的参数配置。</p></li><li><p><code>FSMC_WriteTimingStruct</code> 同样地，本成员也是一个时序结构体的指针，只有当使用扩展模式时，本配置才有效，它是写操作使用的时序。</p></li></ul><p>对本结构体赋值完成后，调用FSMC_NORSRAMInit库函数即可把配置参数写入到FSMC_BCR及FSMC_BTR/BWTR寄存器中。</p><h3 id="fsmc—扩展外部-sram-实验" tabindex="-1"><a class="header-anchor" href="#fsmc—扩展外部-sram-实验" aria-hidden="true">#</a> FSMC—扩展外部 SRAM 实验</h3><p>本小节以型号为“IS62WV51216”的 SRAM 芯片为 STM32 扩展内存。它的地址线宽度为 19 位，数据线宽度为 16 位，容量大小为1MB。</p><p>学习本小节内容时，请打开配套的“FSMC—外部 SRAM”工程配合阅读。本实验仅讲解基本的外部SRAM 驱动，不涉及内存管理的内容，在本书的《MDK 编译过程及文件类型全解》章节将会讲解使用更简单的方法从外部 SRAM 中分配变量，以及使用 C 语言标准库的 malloc 函数来分配外部SRAM 的空间。</p><h4 id="硬件设计-6" tabindex="-1"><a class="header-anchor" href="#硬件设计-6" aria-hidden="true">#</a> 硬件设计</h4><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211180308152.png" alt="image-20221118030806054" style="zoom:50%;"><p>外部SRAM 芯片与STM32 相连的引脚非常多，主要是地址线和数据线，这些具有特定FSMC 功能的GPIO 引脚可查询《STM32F4xx 规格书》中的说明来了解。</p><p>关于该SRAM 芯片的更多信息，请参考其规格书《IS62WV51216》了解。若您使用的实验板SRAM的型号或控制引脚不一样，可在我们工程的基础上修改，程序的控制原理相同。</p><p>根据本硬件设计，SRAM 芯片的使能信号与 FSMC_NE3 连接，所以它会被映射到 STM32 中的BANK1 NOR/SRAM 4 区域，该区域的地址范围为0x68000000-0x6BFFFFFF，因此，当内核访问从基地址 0x68000000 开始的 1MB 空间时，FSMC 外设会自动控制原理图中的引脚产生访问时序，访问这个外部SRAM 存储器。</p><h4 id="软件设计-6" tabindex="-1"><a class="header-anchor" href="#软件设计-6" aria-hidden="true">#</a> 软件设计</h4><p>新建“bsp_sram.c”及“bsp_sram.h”文件</p><h4 id="编程要点-6" tabindex="-1"><a class="header-anchor" href="#编程要点-6" aria-hidden="true">#</a> 编程要点</h4><p>(1) 初始化通讯使用的目标引脚及端口时钟；</p><p>(2) 使能 FSMC 外设的时钟；</p><p>(3) 配置 FSMC SRAM 的时序、工作模式；</p><p>(4) 建立机制访问外部 SRAM 存储器；</p><p>(5) 编写测试程序，对读写数据进行校验。</p><p><code>bsp_sram.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 2022/11/16.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLO_BSP_SRAM_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLO_BSP_SRAM_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>

<span class="token comment">/* A 地址信号线 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A0_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A0_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A0_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A0_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A1_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A1_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A1_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A1_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A2_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A2_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A2_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A2_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A3_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A3_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A3_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A3_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A4_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A4_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A4_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A4_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A5_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A5_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A5_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A5_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A6_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A6_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A6_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A6_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A7_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A7_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A7_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_13</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A7_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource13</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A8_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A8_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A8_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A8_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A9_GPIO_PORT</span>            <span class="token expression">GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A9_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOF</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A9_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A9_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A10_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A10_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A10_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A10_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A11_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A11_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A11_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A11_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A12_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A12_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A12_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A12_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource2</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A13_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A13_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A13_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A13_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource3</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A14_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A14_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A14_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A14_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A15_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A15_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A15_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A15_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A16_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A16_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A16_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_11</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A16_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource11</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A17_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A17_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A17_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A17_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A18_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A18_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A18_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_13</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_A18_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource13</span></span>

<span class="token comment">/* D 数据信号线 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D0_GPIO_PORT</span>            <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D0_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D0_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D0_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D1_GPIO_PORT</span>            <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D1_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D1_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D1_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D2_GPIO_PORT</span>            <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D2_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D2_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D2_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D3_GPIO_PORT</span>            <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D3_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D3_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D3_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D4_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D4_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D4_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D4_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource7</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D5_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D5_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D5_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_8</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D5_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource8</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D6_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D6_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D6_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D6_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D7_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D7_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D7_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_10</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D7_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource10</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D8_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D8_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D8_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_11</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D8_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource11</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D9_GPIO_PORT</span>            <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D9_GPIO_CLK</span>             <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D9_GPIO_PIN</span>             <span class="token expression">GPIO_Pin_12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D9_GPIO_PinSource</span>       <span class="token expression">GPIO_PinSource12</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D10_GPIO_PORT</span>           <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D10_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D10_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_13</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D10_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource13</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D11_GPIO_PORT</span>           <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D11_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D11_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D11_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource14</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D12_GPIO_PORT</span>           <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D12_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D12_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D12_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource15</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D13_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D13_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D13_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_8</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D13_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource8</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D14_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D14_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D14_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D14_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource9</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D15_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D15_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D15_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_10</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_D15_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource10</span></span>

<span class="token comment">/* CS 片选 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_CS_GPIO_PORT</span>           <span class="token expression">GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_CS_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOG</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_CS_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_10</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_CS_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource10</span></span>

<span class="token comment">/* WE 写使能 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_WE_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_WE_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_WE_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_WE_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource5</span></span>


<span class="token comment">/* OE 读使能 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_OE_GPIO_PORT</span>           <span class="token expression">GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_OE_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOD</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_OE_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_4</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_OE_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource4</span></span>


<span class="token comment">/* UB 和 LB 同时使能，输出 16 位宽*/</span>

<span class="token comment">/* LB 数据掩码，低电平有效，输入或输出 低8位 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_LB_GPIO_PORT</span>           <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_LB_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_LB_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_0</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_LB_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource0</span></span>

<span class="token comment">/* UB 数据掩码，低电平有效，输入或输出 高8位 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_UB_GPIO_PORT</span>           <span class="token expression">GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_UB_GPIO_CLK</span>            <span class="token expression">RCC_AHB1Periph_GPIOE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_UB_GPIO_PIN</span>            <span class="token expression">GPIO_Pin_1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FSMC_UB_GPIO_PinSource</span>      <span class="token expression">GPIO_PinSource1</span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Bank1_SRAM3_ADDR</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span><span class="token number">0x68000000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS62WV51216_SIZE</span>    <span class="token expression"><span class="token number">0x100000</span></span></span>

<span class="token keyword">void</span> <span class="token function">FSMC_SRAM_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HELLO_BSP_SRAM_H</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>bsp_sram.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/*
#include &quot;bsp_debug_usart.h&quot;
#include &lt;iostream&gt;
using namespace std;

istream &amp;operator&gt;&gt;(istream &amp;out, uint8_t &amp;val) {
    while (USART_GetFlagStatus(DEBUG_USART, USART_FLAG_RXNE) == RESET);
    uint16_t data = USART_ReceiveData(DEBUG_USART);
    val = data;
    return out;
}*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_sram.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">SRAM_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>FSMC_A0_GPIO_CLK <span class="token operator">|</span> FSMC_A1_GPIO_CLK <span class="token operator">|</span> FSMC_A2_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A3_GPIO_CLK <span class="token operator">|</span> FSMC_A4_GPIO_CLK <span class="token operator">|</span> FSMC_A5_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A6_GPIO_CLK <span class="token operator">|</span> FSMC_A7_GPIO_CLK <span class="token operator">|</span> FSMC_A8_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A9_GPIO_CLK <span class="token operator">|</span> FSMC_A10_GPIO_CLK <span class="token operator">|</span> FSMC_A11_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A12_GPIO_CLK <span class="token operator">|</span> FSMC_A13_GPIO_CLK <span class="token operator">|</span> FSMC_A14_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A15_GPIO_CLK <span class="token operator">|</span> FSMC_A16_GPIO_CLK <span class="token operator">|</span> FSMC_A17_GPIO_CLK <span class="token operator">|</span>
                           FSMC_A18_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D0_GPIO_CLK <span class="token operator">|</span> FSMC_D1_GPIO_CLK <span class="token operator">|</span> FSMC_D2_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D3_GPIO_CLK <span class="token operator">|</span> FSMC_D4_GPIO_CLK <span class="token operator">|</span> FSMC_D5_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D6_GPIO_CLK <span class="token operator">|</span> FSMC_D7_GPIO_CLK <span class="token operator">|</span> FSMC_D8_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D9_GPIO_CLK <span class="token operator">|</span> FSMC_D10_GPIO_CLK <span class="token operator">|</span> FSMC_D11_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D12_GPIO_CLK <span class="token operator">|</span> FSMC_D13_GPIO_CLK <span class="token operator">|</span> FSMC_D14_GPIO_CLK <span class="token operator">|</span>
                           FSMC_D15_GPIO_CLK <span class="token operator">|</span>
                           FSMC_CS_GPIO_CLK <span class="token operator">|</span> FSMC_WE_GPIO_CLK <span class="token operator">|</span> FSMC_OE_GPIO_CLK <span class="token operator">|</span>
                           FSMC_LB_GPIO_CLK <span class="token operator">|</span> FSMC_UB_GPIO_CLK<span class="token punctuation">,</span>
                           ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>        <span class="token comment">// 复用模式</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>      <span class="token comment">// 推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>        <span class="token comment">// 上拉电阻</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_100MHz<span class="token punctuation">;</span>  <span class="token comment">// 100MHz</span>

    <span class="token comment">/* A0 ~ A18 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A0_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A0_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A0_GPIO_PORT<span class="token punctuation">,</span> FSMC_A0_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A1_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A1_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A1_GPIO_PORT<span class="token punctuation">,</span> FSMC_A1_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A2_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A2_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A2_GPIO_PORT<span class="token punctuation">,</span> FSMC_A2_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A3_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A3_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A3_GPIO_PORT<span class="token punctuation">,</span> FSMC_A3_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A4_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A4_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A4_GPIO_PORT<span class="token punctuation">,</span> FSMC_A4_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A5_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A5_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A5_GPIO_PORT<span class="token punctuation">,</span> FSMC_A5_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A6_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A6_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A6_GPIO_PORT<span class="token punctuation">,</span> FSMC_A6_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A7_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A7_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A7_GPIO_PORT<span class="token punctuation">,</span> FSMC_A7_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A8_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A8_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A8_GPIO_PORT<span class="token punctuation">,</span> FSMC_A8_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A9_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A9_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A9_GPIO_PORT<span class="token punctuation">,</span> FSMC_A9_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A10_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A10_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A10_GPIO_PORT<span class="token punctuation">,</span> FSMC_A10_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A11_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A11_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A11_GPIO_PORT<span class="token punctuation">,</span> FSMC_A11_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A12_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A12_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A12_GPIO_PORT<span class="token punctuation">,</span> FSMC_A12_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A13_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A13_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A13_GPIO_PORT<span class="token punctuation">,</span> FSMC_A13_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A14_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A14_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A14_GPIO_PORT<span class="token punctuation">,</span> FSMC_A14_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A15_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A15_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A15_GPIO_PORT<span class="token punctuation">,</span> FSMC_A15_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A16_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A16_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A16_GPIO_PORT<span class="token punctuation">,</span> FSMC_A16_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A17_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A17_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A17_GPIO_PORT<span class="token punctuation">,</span> FSMC_A17_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_A18_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_A18_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_A18_GPIO_PORT<span class="token punctuation">,</span> FSMC_A18_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* D0 ~ A15 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D0_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D0_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D0_GPIO_PORT<span class="token punctuation">,</span> FSMC_D0_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D1_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D1_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D1_GPIO_PORT<span class="token punctuation">,</span> FSMC_D1_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D2_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D2_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D2_GPIO_PORT<span class="token punctuation">,</span> FSMC_D2_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D3_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D3_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D3_GPIO_PORT<span class="token punctuation">,</span> FSMC_D3_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D4_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D4_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D4_GPIO_PORT<span class="token punctuation">,</span> FSMC_D4_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D5_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D5_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D5_GPIO_PORT<span class="token punctuation">,</span> FSMC_D5_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D6_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D6_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D6_GPIO_PORT<span class="token punctuation">,</span> FSMC_D6_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D7_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D7_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D7_GPIO_PORT<span class="token punctuation">,</span> FSMC_D7_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D8_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D8_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D8_GPIO_PORT<span class="token punctuation">,</span> FSMC_D8_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D9_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D9_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D9_GPIO_PORT<span class="token punctuation">,</span> FSMC_D9_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D10_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D10_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D10_GPIO_PORT<span class="token punctuation">,</span> FSMC_D10_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D11_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D11_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D11_GPIO_PORT<span class="token punctuation">,</span> FSMC_D11_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D12_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D12_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D12_GPIO_PORT<span class="token punctuation">,</span> FSMC_D12_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D13_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D13_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D13_GPIO_PORT<span class="token punctuation">,</span> FSMC_D13_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D14_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D14_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D14_GPIO_PORT<span class="token punctuation">,</span> FSMC_D14_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_D15_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_D15_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_D15_GPIO_PORT<span class="token punctuation">,</span> FSMC_D15_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/* CS 片选信号线 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_CS_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_CS_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_CS_GPIO_PORT<span class="token punctuation">,</span> FSMC_CS_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* WE 写使能信号线 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_WE_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_WE_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_WE_GPIO_PORT<span class="token punctuation">,</span> FSMC_WE_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* OE 读使能信号线 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_OE_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_OE_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_OE_GPIO_PORT<span class="token punctuation">,</span> FSMC_OE_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* LB 数据掩码 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_LB_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_LB_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_LB_GPIO_PORT<span class="token punctuation">,</span> FSMC_LB_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* UB 数据掩码 */</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> FSMC_UB_GPIO_PIN<span class="token punctuation">;</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>FSMC_UB_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>FSMC_UB_GPIO_PORT<span class="token punctuation">,</span> FSMC_UB_GPIO_PinSource<span class="token punctuation">,</span> GPIO_AF_FSMC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">FSMC_SRAM_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 初始化 SRAM 相关的 GPIO */</span>
    <span class="token function">SRAM_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 使能 FSMC 外设时钟 */</span>
    <span class="token function">RCC_AHB3PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB3Periph_FSMC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    FSMC_NORSRAMTimingInitTypeDef readWriteTiming<span class="token punctuation">;</span>

    <span class="token comment">/*为什么地址建立时间是0ns呢？因为从IS62WV51216写时序关键特性中可以看到，Address Setup Time为0，所以配置时，地址建立时间要等于0。*/</span>
    <span class="token comment">/* 地址建立时间（ADDSET）为 1 个 HCLK 时钟周期（1/168M） */</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_AddressSetupTime <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">// 地址保持时间模式A未用到，所以配置为0</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_AddressHoldTime <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">// 数据保持时间（DATAST）+ 1 个 HCLK = 9/168 微秒 = 54 纳秒</span>
    <span class="token comment">/*据建立时间为什么是54ns呢？因为从IS62WV51216写时序关键特性中可以看到，Dataup to Write End最小值为30ns，
     所以配置时，数据保持时间要大于30ns。至于选择的54ns并不是严格按照手册时间来的，这需要实际调试才能确定具体值。*/</span>
    <span class="token comment">/*那为什么数据建立时间配置为8，但却是9个HCLK周期时间呢？从STM32中文参考手册的时序图中可以看到，
     模式A写入时序的数据建立时间为： 数据建立时间=HCLK周期+1，初始化程序时，如果设置DATAST=0，则实际数据建立周期为1，
     即实际数据建立周期比DATAST值多1个HCLK周期。*/</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_DataSetupTime <span class="token operator">=</span> <span class="token number">0x08</span><span class="token punctuation">;</span>

    <span class="token comment">//设置总线转换周期，仅用于 NOR FLASH</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_BusTurnAroundDuration <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">//设置时钟分频，仅用于同步类型的存储器</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_CLKDivision <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">//数据保持时间，它表示在读取第一个数据之前要等待的周期数，该周期指同步时钟的周期，仅用于NOR FLASH</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_DataLatency <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">//选择匹配 SRAM 的模式</span>
    readWriteTiming<span class="token punctuation">.</span>FSMC_AccessMode <span class="token operator">=</span> FSMC_AccessMode_A<span class="token punctuation">;</span>



    FSMC_NORSRAMInitTypeDef FSMC_NORSRAMInitStructure<span class="token punctuation">;</span>
    <span class="token comment">// 选择 FSMC 映射的存储区域：Bank1 sram3</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_Bank <span class="token operator">=</span> FSMC_Bank1_NORSRAM3<span class="token punctuation">;</span>
    <span class="token comment">// 设置地址总线与数据总线是否复用，仅用于NOR FLASH</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_DataAddressMux <span class="token operator">=</span> FSMC_DataAddressMux_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 设置要控制的存储器类型：SRAM 类型</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_MemoryType <span class="token operator">=</span> FSMC_MemoryType_SRAM<span class="token punctuation">;</span>
    <span class="token comment">// 存储器数据宽度：16位</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_MemoryDataWidth <span class="token operator">=</span> FSMC_MemoryDataWidth_16b<span class="token punctuation">;</span>
    <span class="token comment">// 设置是否使用突发存储模式，仅用于同步类型的存储器</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_BurstAccessMode <span class="token operator">=</span> FSMC_BurstAccessMode_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 设置是否使能等待信号，仅用于同步类型的存储器</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_AsynchronousWait <span class="token operator">=</span> FSMC_AsynchronousWait_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 设置等待信号的有效极性，仅用于同步类型的存储器</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WaitSignalPolarity <span class="token operator">=</span> FSMC_WaitSignalPolarity_Low<span class="token punctuation">;</span>
    <span class="token comment">// 设置是否支持包装突发模式，仅用于同步类型的存储器</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WrapMode <span class="token operator">=</span> FSMC_WrapMode_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 设置等待信号插入时间，仅用于同步类型的存储器</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WaitSignalActive <span class="token operator">=</span> FSMC_WaitSignalActive_BeforeWaitState<span class="token punctuation">;</span>
    <span class="token comment">// 存储器写使能</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WriteOperation <span class="token operator">=</span> FSMC_WriteOperation_Enable<span class="token punctuation">;</span>
    <span class="token comment">// 不使用等待信号</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WaitSignal <span class="token operator">=</span> FSMC_WaitSignal_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 不使用扩展模式，读写使用相同的时序</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_ExtendedMode <span class="token operator">=</span> FSMC_ExtendedMode_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 突发写操作，禁用</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WriteBurst <span class="token operator">=</span> FSMC_WriteBurst_Disable<span class="token punctuation">;</span>
    <span class="token comment">// 读写时序配置</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_ReadWriteTimingStruct <span class="token operator">=</span> <span class="token operator">&amp;</span>readWriteTiming<span class="token punctuation">;</span>
    <span class="token comment">// 使能了扩展模式时，这个配置才有效，这个配置的作用是读写使用不一样的时序</span>
    FSMC_NORSRAMInitStructure<span class="token punctuation">.</span>FSMC_WriteTimingStruct <span class="token operator">=</span> <span class="token operator">&amp;</span>readWriteTiming<span class="token punctuation">;</span>

    <span class="token comment">//初始化 FSMC 配置</span>
    <span class="token function">FSMC_NORSRAMInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FSMC_NORSRAMInitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 使能 BANK</span>
    <span class="token function">FSMC_NORSRAMCmd</span><span class="token punctuation">(</span>FSMC_Bank1_NORSRAM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_led.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_debug_usart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_usart_dma.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_sram.h&quot;</span></span>

<span class="token comment">//DMA 传输源存储器</span>
<span class="token class-name">uint8_t</span> SEND_BUFFER<span class="token punctuation">[</span>SENDBUFF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">temp</span> <span class="token expression"><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Bank1_SRAM3_ADDR<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 绝对定位方式访问 SRAM, 这种方式必须定义成全局变量 */</span>
<span class="token comment">//经过测试 arm-gcc 不支持at直接指定变量位置的写法，报错：warning: &#39;at&#39; attribute directive ignored</span>
<span class="token comment">// uint8_t testValue    __attribute__((at(Bank1_SRAM3_ADDR)));</span>
<span class="token comment">/* 需要换成以下这种形式，section ，里面的 .sram 需要在.ld链接脚本中的SECTION块中定义
 * 步骤：
 * 1 在 MEMORY 块中 新增一行 ：SRAM (rx)      : ORIGIN = 0x68000000, LENGTH = 1024K
 * 2 在 SECTION 块的最后 新增（格式有严格要求，比如空格不能少.sram:）：.sram :
                                                                {
                                                                  . = ALIGN(4);
                                                                  __SRAM_SYMBOLS = .;
                                                                  *(.sram)
                                                                  *(.sram*)
                                                                  . = ALIGN(4);
                                                                  __SRAM_SYMBOLS = .;
                                                                } &gt; SRAM AT&gt; FLASH
 * */</span>
<span class="token class-name">uint8_t</span> testValue    <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">&quot;.sram&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">// 禁用编译器优化（多行）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC push_options</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC <span class="token function">optimize</span> <span class="token punctuation">(</span></span><span class="token string">&quot;O0&quot;</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token comment">// your code</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">GCC pop_options</span></span>

<span class="token comment">// 禁用编译器优化（单个函数）</span>
<span class="token keyword">void</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">optimize</span><span class="token punctuation">(</span><span class="token string">&quot;O0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// unmodifiable compiler code</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">optimize</span><span class="token punctuation">(</span><span class="token string">&quot;O0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">Test_FSMC_SRAM</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FSMC_SRAM_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果不禁用编译器优化，在没有初始化 FSMC 的情况下，还是可以正常的输出</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Test1 %c %c %c %c %c %c %c %c %p\n&quot;</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果不禁用编译器优化，在没有初始化 FSMC 的情况下，还是可以正常的输出</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">&#39;A&#39;</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Test1 %c %c %c %c %c %c %c %c %p\n&quot;</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>testValue<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Bank1_SRAM3_ADDR <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xbbbb</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Write : 0xbbbb , Read : 0x%x\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Bank1_SRAM3_ADDR <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Bank1_SRAM3_ADDR <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0xcccccccc</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Write : 0xbbbb , Read : 0x%lx\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Bank1_SRAM3_ADDR <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 以下代码没禁用优化的情况下，和预期结果一致</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%5d&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>temp<span class="token punctuation">)</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">11</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Test_FSMC_SRAM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>STM32F407ZGTx_FLASH.ld</code></p><div class="language-assembly line-numbers-mode" data-ext="assembly"><pre class="language-assembly"><code>/*
******************************************************************************
**

**  File        : LinkerScript.ld
**
**  Author		: STM32CubeMX
**
**  Abstract    : Linker script for STM32F407ZGTx series
**                1024Kbytes FLASH and 192Kbytes RAM
**
**                Set heap size, stack size and stack location according
**                to application requirements.
**
**                Set memory bank area and size if external memory is used.
**
**  Target      : STMicroelectronics STM32
**
**  Distribution: The file is distributed “as is,” without any warranty
**                of any kind.
**
*****************************************************************************
** @attention
**
** &lt;h2&gt;&lt;center&gt;&amp;copy; COPYRIGHT(c) 2019 STMicroelectronics&lt;/center&gt;&lt;/h2&gt;
**
** Redistribution and use in source and binary forms, with or without modification,
** are permitted provided that the following conditions are met:
**   1. Redistributions of source code must retain the above copyright notice,
**      this list of conditions and the following disclaimer.
**   2. Redistributions in binary form must reproduce the above copyright notice,
**      this list of conditions and the following disclaimer in the documentation
**      and/or other materials provided with the distribution.
**   3. Neither the name of STMicroelectronics nor the names of its contributors
**      may be used to endorse or promote products derived from this software
**      without specific prior written permission.
**
** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
** AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
** IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
** DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
** FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
** DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
** SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
** CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
** OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
**
*****************************************************************************
*/

/* Entry Point */
ENTRY(Reset_Handler)

/* Highest address of the user mode stack */
_estack = ORIGIN(RAM) + LENGTH(RAM);    /* end of RAM */
/* Generate a link error if heap and stack don&#39;t fit into RAM */
_Min_Heap_Size = 0x200;      /* required amount of heap  */
_Min_Stack_Size = 0x400; /* required amount of stack */

/* Specify the memory areas */
MEMORY
{
RAM (xrw)      : ORIGIN = 0x20000000, LENGTH = 128K
CCMRAM (xrw)      : ORIGIN = 0x10000000, LENGTH = 64K
FLASH (rx)      : ORIGIN = 0x8000000, LENGTH = 1024K
SRAM (rx)      : ORIGIN = 0x68000000, LENGTH = 1024K
}

/* Define output sections */
SECTIONS
{
  /* The startup code goes first into FLASH */
  .isr_vector :
  {
    . = ALIGN(4);
    KEEP(*(.isr_vector)) /* Startup code */
    . = ALIGN(4);
  } &gt;FLASH

  /* The program code and other data goes into FLASH */
  .text :
  {
    . = ALIGN(4);
    *(.text)           /* .text sections (code) */
    *(.text*)          /* .text* sections (code) */
    *(.glue_7)         /* glue arm to thumb code */
    *(.glue_7t)        /* glue thumb to arm code */
    *(.eh_frame)

    KEEP (*(.init))
    KEEP (*(.fini))

    . = ALIGN(4);
    _etext = .;        /* define a global symbols at end of code */
  } &gt;FLASH

  /* Constant data goes into FLASH */
  .rodata :
  {
    . = ALIGN(4);
    *(.rodata)         /* .rodata sections (constants, strings, etc.) */
    *(.rodata*)        /* .rodata* sections (constants, strings, etc.) */
    . = ALIGN(4);
  } &gt;FLASH

  .ARM.extab   : { *(.ARM.extab* .gnu.linkonce.armextab.*) } &gt;FLASH
  .ARM : {
    __exidx_start = .;
    *(.ARM.exidx*)
    __exidx_end = .;
  } &gt;FLASH

  .preinit_array     :
  {
    PROVIDE_HIDDEN (__preinit_array_start = .);
    KEEP (*(.preinit_array*))
    PROVIDE_HIDDEN (__preinit_array_end = .);
  } &gt;FLASH
  .init_array :
  {
    PROVIDE_HIDDEN (__init_array_start = .);
    KEEP (*(SORT(.init_array.*)))
    KEEP (*(.init_array*))
    PROVIDE_HIDDEN (__init_array_end = .);
  } &gt;FLASH
  .fini_array :
  {
    PROVIDE_HIDDEN (__fini_array_start = .);
    KEEP (*(SORT(.fini_array.*)))
    KEEP (*(.fini_array*))
    PROVIDE_HIDDEN (__fini_array_end = .);
  } &gt;FLASH

  /* used by the startup to initialize data */
  _sidata = LOADADDR(.data);

  /* Initialized data sections goes into RAM, load LMA copy after code */
  .data : 
  {
    . = ALIGN(4);
    _sdata = .;        /* create a global symbol at data start */
    *(.data)           /* .data sections */
    *(.data*)          /* .data* sections */

    . = ALIGN(4);
    _edata = .;        /* define a global symbol at data end */
  } &gt;RAM AT&gt; FLASH

  _siccmram = LOADADDR(.ccmram);

  /* CCM-RAM section 
  * 
  * IMPORTANT NOTE! 
  * If initialized variables will be placed in this section,
  * the startup code needs to be modified to copy the init-values.  
  */
  .ccmram :
  {
    . = ALIGN(4);
    _sccmram = .;       /* create a global symbol at ccmram start */
    *(.ccmram)
    *(.ccmram*)
    
    . = ALIGN(4);
    _eccmram = .;       /* create a global symbol at ccmram end */
  } &gt;CCMRAM AT&gt; FLASH

  
  /* Uninitialized data section */
  . = ALIGN(4);
  .bss :
  {
    /* This is used by the startup in order to initialize the .bss secion */
    _sbss = .;         /* define a global symbol at bss start */
    __bss_start__ = _sbss;
    *(.bss)
    *(.bss*)
    *(COMMON)

    . = ALIGN(4);
    _ebss = .;         /* define a global symbol at bss end */
    __bss_end__ = _ebss;
  } &gt;RAM

  /* User_heap_stack section, used to check that there is enough RAM left */
  ._user_heap_stack :
  {
    . = ALIGN(8);
    PROVIDE ( end = . );
    PROVIDE ( _end = . );
    . = . + _Min_Heap_Size;
    . = . + _Min_Stack_Size;
    . = ALIGN(8);
  } &gt;RAM

  

  /* Remove information from the standard libraries */
  /DISCARD/ :
  {
    libc.a ( * )
    libm.a ( * )
    libgcc.a ( * )
  }

  .ARM.attributes 0 : { *(.ARM.attributes) }

  .sram :
    {
      . = ALIGN(4);
      __SRAM_SYMBOLS = .;
      *(.sram)
      *(.sram*)
      . = ALIGN(4);
      __SRAM_SYMBOLS = .;
    } &gt; SRAM AT&gt; FLASH
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>output.out</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Test1 A B C D E F G H 0x68000008
Test1 A B C D E F G H 0x68000008
Write : 0xbbbb , Read : 0xbbbb
Write : 0xbbbb , Read : 0xcccccccc
    0    1    2    3    4    5    6    7    8    9   10
   11   12   13   14   15   16   17   18   19   20   21
   22   23   24   25   26   27   28   29   30   31   32
   33   34   35   36   37   38   39   40   41   42   43
   44   45   46   47   48   49   50   51   52   53   54
   55   56   57   58   59   60   61   62   63   64   65
   66   67   68   69   70   71   72   73   74   75   76
   77   78   79   80   81   82   83   84   85   86   87
   88   89   90   91   92   93   94   95   96   97   98
   99  100  101  102  103  104  105  106  107  108  109
  110  111  112  113  114  115  116  117  118  119  120
  121  122  123  124  125  126  127  128  129  130  131
  132  133  134  135  136  137  138  139  140  141  142
  143  144  145  146  147  148  149  150  151  152  153
  154  155  156  157  158  159  160  161  162  163  164
  165  166  167  168  169  170  171  172  173  174  175
  176  177  178  179  180  181  182  183  184  185  186
  187  188  189  190  191  192  193  194  195  196  197
  198  199  200  201  202  203  204  205  206  207  208
  209  210  211  212  213  214  215  216  217  218  219
  220  221  222  223  224  225  226  227  228  229  230
  231  232  233  234  235  236  237  238  239  240  241
  242  243  244  245  246  247  248  249  250  251  252
  253  254  255  256  257  258  259  260  261  262  263
  264  265  266  267  268  269  270  271  272  273  274
  275  276  277  278  279  280  281  282  283  284  285
  286  287  288  289  290  291  292  293  294  295  296
  297  298  299  300  301  302  303  304  305  306  307
  308  309  310  311  312  313  314  315  316  317  318
  319  320  321  322  323  324  325  326  327  328  329
  330  331  332  333  334  335  336  337  338  339  340
  341  342  343  344  345  346  347  348  349  350  351
  352  353  354  355  356  357  358  359  360  361  362
  363  364  365  366  367  368  369  370  371  372  373
  374  375  376  377  378  379  380  381  382  383  384
  385  386  387  388  389  390  391  392  393  394  395
  396  397  398  399  400  401  402  403  404  405  406
  407  408  409  410  411  412  413  414  415  416  417
  418  419  420  421  422  423  424  425  426  427  428
  429  430  431  432  433  434  435  436  437  438  439
  440  441  442  443  444  445  446  447  448  449  450
  451  452  453  454  455  456  457  458  459  460  461
  462  463  464  465  466  467  468  469  470  471  472
  473  474  475  476  477  478  479  480  481  482  483
  484  485  486  487  488  489  490  491  492  493  494
  495  496  497  498  499  500  501  502  503  504  505
  506  507  508  509  510  511  512  513  514  515  516
  517  518  519  520  521  522  523  524  525  526  527
  528  529  530  531  532  533  534  535  536  537  538
  539  540  541  542  543  544  545  546  547  548  549
  550  551  552  553  554  555  556  557  558  559  560
  561  562  563  564  565  566  567  568  569  570  571
  572  573  574  575  576  577  578  579  580  581  582
  583  584  585  586  587  588  589  590  591  592  593
  594  595  596  597  598  599  600  601  602  603  604
  605  606  607  608  609  610  611  612  613  614  615
  616  617  618  619  620  621  622  623  624  625  626
  627  628  629  630  631  632  633  634  635  636  637
  638  639  640  641  642  643  644  645  646  647  648
  649  650  651  652  653  654  655  656  657  658  659
  660  661  662  663  664  665  666  667  668  669  670
  671  672  673  674  675  676  677  678  679  680  681
  682  683  684  685  686  687  688  689  690  691  692
  693  694  695  696  697  698  699  700  701  702  703
  704  705  706  707  708  709  710  711  712  713  714
  715  716  717  718  719  720  721  722  723  724  725
  726  727  728  729  730  731  732  733  734  735  736
  737  738  739  740  741  742  743  744  745  746  747
  748  749  750  751  752  753  754  755  756  757  758
  759  760  761  762  763  764  765  766  767  768  769
  770  771  772  773  774  775  776  777  778  779  780
  781  782  783  784  785  786  787  788  789  790  791
  792  793  794  795  796  797  798  799  800  801  802
  803  804  805  806  807  808  809  810  811  812  813
  814  815  816  817  818  819  820  821  822  823  824
  825  826  827  828  829  830  831  832  833  834  835
  836  837  838  839  840  841  842  843  844  845  846
  847  848  849  850  851  852  853  854  855  856  857
  858  859  860  861  862  863  864  865  866  867  868
  869  870  871  872  873  874  875  876  877  878  879
  880  881  882  883  884  885  886  887  888  889  890
  891  892  893  894  895  896  897  898  899  900  901
  902  903  904  905  906  907  908  909  910  911  912
  913  914  915  916  917  918  919  920  921  922  923
  924  925  926  927  928  929  930  931  932  933  934
  935  936  937  938  939  940  941  942  943  944  945
  946  947  948  949  950  951  952  953  954  955  956
  957  958  959  960  961  962  963  964  965  966  967
  968  969  970  971  972  973  974  975  976  977  978
  979  980  981  982  983  984  985  986  987  988  989
  990  991  992  993  994  995  996  997  998  999 1000
 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011
 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022
 1023
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种方式使用关键字“<strong>attribute</strong>((at()))”来指定变量的地址，代码中指定testValue 存储到SRAM的起始地址，从而实现把变量存储到 SRAM 上。要注意使用这种方法定义变量时，必须在函数外把它定义成全局变量，才可以存储到指定地址上。</p><p>更常见的是利用这种方法定义一个很大的数组，整个数组都指定到SRAM 地址上，然后就像使用malloc 函数一样，用户自定义一些内存管理函数，动态地使用SRAM 的内存，我们在使用emWin写 GUI 应用的时候就是这样做的。参考我们配套的“FSMC—外部 SRAM（内存管理）”实验可以了解如何自行管理内存。</p><p>然而，我们更推荐另一种方法，在本书的《MDK 编译过程及文件类型全解》章节将会讲解使用更简单的方法从 SRAM 中分配变量，以及使用 C 语言标准库的 malloc 函数来分配 SRAM 的空间，更有效地进行内存管理。</p><h2 id="lcd-液晶显示" tabindex="-1"><a class="header-anchor" href="#lcd-液晶显示" aria-hidden="true">#</a> LCD 液晶显示</h2><p>本章参考资料： 《STM32F4XX-中文参考手册》 、 《STM32F4xx 数据手册》 、库帮助文档《stm32f4xx_dsp_stdperiph_lib_um.chm》。</p><p>关于开发板配套的液晶屏控制器参数可查阅《ILI9806G-Data Sheet.pdf》资料获知。</p><p>本章讲解的内容涉及对 FSMC 的控制，若您不了解 FSMC 外设，请先学习前面的《FSMC—扩展外部SRAM》章节。</p><h3 id="显示器简介" tabindex="-1"><a class="header-anchor" href="#显示器简介" aria-hidden="true">#</a> 显示器简介</h3><p>显示器属于计算机的I/O 设备，即输入输出设备。它是一种将特定电子信息输出到屏幕上再反射到人眼的显示工具。常见的有CRT 显示器、液晶显示器、LED 点阵显示器及OLED 显示器。</p><h4 id="液晶显示器" tabindex="-1"><a class="header-anchor" href="#液晶显示器" aria-hidden="true">#</a> 液晶显示器</h4><p>液晶显示器，简称 LCD(Liquid Crystal Display)，相对于上一代 CRT 显示器 (阴极射线管显示器)，LCD 显示器具有功耗低、体积小、承载的信息量大及不伤眼的优点，因而它成为了现在的主流电子显示设备，其中包括电视、电脑显示器、手机屏幕及各种嵌入式设备的显示器。</p><p>图液晶电视及 CRT 电视 是液晶电视与 CRT 电视的外观对比，很明显液晶电视更薄，“现代”是液晶电视给人的第一印象，而CRT 电视则感觉很“笨重”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211180321309.png" alt="image-20221118032154202" style="zoom:50%;"><p>液晶是一种介于固体和液体之间的特殊物质，它是一种有机化合物，常态下呈液态，但是它的分子排列却和固体晶体一样非常规则，因此取名液晶。如果给液晶施加电场，会改变它的分子排列，从而改变光线的传播方向，配合偏振光片，它就具有控制光线透过率的作用，再配合彩色滤光片，改变加给液晶电压大小，就能改变某一颜色透光量的多少，“图液晶屏的绿色显示结构” 中的就是绿色显示结构。利用这种原理，做出可控红、绿、蓝光输出强度的显示结构，把三种显示结构组成一个显示单位，通过控制红绿蓝的强度，可以使该单位混合输出不同的色彩，这样的一个显示单位被称为像素。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190127216.png" alt="image-20221119012734108" style="zoom:33%;"><p>注意液晶本身是不发光的，所以需要有一个背光灯提供光源，光线经过一系列处理过程才到输出，所以输出的光线强度是要比光源的强度低很多的，比较浪费能源(当然，比CRT 显示器还是节能多了)。而且这些处理过程会导致显示方向比较窄，也就是它的视角较小，从侧面看屏幕会看不清它的显示内容。另外，输出的色彩变换时，液晶分子转动也需要消耗一定的时间，导致屏幕的响应速度低。</p><h4 id="led-和-oled-显示器" tabindex="-1"><a class="header-anchor" href="#led-和-oled-显示器" aria-hidden="true">#</a> LED 和 OLED 显示器</h4><p>LED 点阵显示器不存在以上液晶显示器的问题，LED 点阵彩色显示器的单个像素点内包含红绿蓝三色LED 灯，显示原理类似我们实验板上的LED 彩灯，通过控制红绿蓝颜色的强度进行混色，实现全彩颜色输出，多个像素点构成一个屏幕。由于每个像素点都是 LED 灯自发光的，所以在户外白天也显示得非常清晰，但由于 LED 灯体积较大，导致屏幕的像素密度低，所以它一般只适合用于广场上的巨型显示器。相对来说，单色的 LED 点阵显示器应用得更广泛，如公交车上的信息展示牌、店招等，见“图LED 点阵彩屏有 LED 单色显示屏”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190135408.png" alt="image-20221119013553318" style="zoom:50%;"><p>新一代的 OLED 显示器与 LED 点阵彩色显示器的原理类似，但由于它采用的像素单元是“有机发光二极管”(Organic Light Emitting Diode)，所以像素密度比普通LED 点阵显示器高得多，见“图OLED 像素结构”。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190137857.png" alt="image-20221119013746770" style="zoom:50%;"><p>OLED 显示器不需要背光源、对比度高、轻薄、视角广及响应速度快等优点。待到生产工艺更加成熟时，必将取代现在液晶显示器的地位，见图采用 OLED 屏幕的电视及智能手表。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190138231.png" alt="image-20221119013824141" style="zoom:50%;"><h4 id="显示器的基本参数" tabindex="-1"><a class="header-anchor" href="#显示器的基本参数" aria-hidden="true">#</a> 显示器的基本参数</h4><p>不管是哪一种显示器，都有一定的参数用于描述它们的特性，各个参数介绍如下：</p><ul><li>像素 <ul><li>像素是组成图像的最基本单元要素，显示器的像素指它成像最小的点，即前面讲解液晶原理中提到的一个显示单元。</li></ul></li><li>分辨率 <ul><li>一些嵌入式设备的显示器常常以“行像素值x 列像素值”表示屏幕的分辨率。如分辨率800x480 表示该显示器的每一行有800 个像素点，每一列有480 个像素点，也可理解为有800 列，480 行。</li></ul></li><li>色彩深度 <ul><li>色彩深度指显示器的每个像素点能表示多少种颜色，一般用“位”(bit) 来表示。如单色屏的每个像素点能表示亮或灭两种状态(即实际上能显示2 种颜色)，用1 个数据位就可以表示像素点的所有状态，所以它的色彩深度为1bit，其它常见的显示屏色深为16bit、24bit。</li></ul></li><li>显示器尺寸 - 显示器的大小一般以英寸表示，如 5 英寸、21 英寸、24 英寸等，这个长度是指屏幕对角线的长度，通过显示器的对角线长度及长宽比可确定显示器的实际长宽尺寸。</li><li>点距 <ul><li>点距指两个相邻像素点之间的距离，它会影响画质的细腻度及观看距离，相同尺寸的屏幕，若分辨率越高，则点距越小，画质越细腻。如现在有些手机的屏幕分辨率比电脑显示器的还大，这是手机屏幕点距小的原因；LED 点阵显示屏的点距一般都比较大，所以适合远距离观看。</li></ul></li></ul><h3 id="液晶控制原理" tabindex="-1"><a class="header-anchor" href="#液晶控制原理" aria-hidden="true">#</a> 液晶控制原理</h3><p>图 “适合 STM32 控制的显示屏实物图” 是两种适合于 STM32 芯片使用的显示屏，我们以它为例讲解控制液晶屏的基本原理。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190145731.png" alt="image-20221119014528637" style="zoom:50%;"><p>这个完整的显示屏由液晶显示面板、电容触摸面板以及 PCB 底板构成。图中的触摸面板带有触摸控制芯片，该芯片处理触摸信号并通过引出的信号线与外部器件通讯，触摸面板中间是透明的，它贴在液晶面板上面，一起构成屏幕的主体，触摸面板与液晶面板引出的排线连接到PCB 底板上，根据实际需要，PCB 底板上可能会带有“液晶控制器芯片”，图中右侧的液晶屏PCB 上带有RA8875 液晶控制器。</p><p>因为控制液晶面板需要比较多的资源，所以大部分低级微控制器都不能直接控制液晶面板，需要额外配套一个专用液晶控制器来处理显示过程，外部微控制器只要把它希望显示的数据直接交给液晶控制器即可。</p><p>而不带液晶控制器的 PCB 底板，只有小部分的电源管理电路，液晶面板的信号线与外部微控制器相连，直接控制。</p><p>STM32F429 系列的芯片不需要额外的液晶控制器，也就是说它把专用液晶控制器的功能集成到 STM32F429 芯片内部了，可以理解为电脑的CPU 集成显卡，它节约了额外的控制器成本。</p><p>而STM32F407 系列的芯片由于没有集成液晶控制器到芯片内部，所以它只能驱动自带控制器的屏幕，可以理解为电脑的外置显卡。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190150148.png" alt="image-20221119015001046" style="zoom:40%;"><p>总的来说，这两类屏幕的控制框图如图 “两类液晶屏控制框图” 所示。</p><h4 id="液晶面板的控制信号" tabindex="-1"><a class="header-anchor" href="#液晶面板的控制信号" aria-hidden="true">#</a> 液晶面板的控制信号</h4><p>本章我们主要了解如何控制液晶面板，液晶面板的控制信号线即图适合 “STM32 控制的显示屏实物图” 中液晶面板引出的FPC 排线，其说明见表 “液晶面板的信号线” ，液晶面板通过这些信号线与液晶控制器通讯，使用这种通讯信号的被称为RGB 接口(RGB Interface)。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190152302.png" alt="image-20221119015233206" style="zoom:50%;"><ul><li><p>RGB 信号线</p><ul><li>RGB 信号线各有8 根，分别用于表示液晶屏一个像素点的红、绿、蓝颜色分量。</li><li>使用红绿蓝颜色分量来表示颜色是一种通用的做法，打开 Windows 系统自带的画板调色工具，可看到颜色的红绿蓝分量值。</li><li>常见的颜色表示会在“RGB”后面附带各个颜色分量值的数据位数。</li><li>如 RGB565 表示红绿蓝的数据线数分别为 5、6、5 根，一共为16 个数据位，可表示2^16 种颜色；</li><li>而这个液晶屏的种颜色分量的数据线都有8 根，所以它支持RGB888 格式，一共24 位数据线，可表示的颜色为 2^24 种。</li></ul></li><li><p>同步时钟信号 CLK</p><ul><li>液晶屏与外部使用同步通讯方式，以CLK 信号作为同步时钟，在同步时钟的驱动下，每个时钟传输一个像素点数据。</li></ul></li><li><p>水平同步信号 HSYNC</p><ul><li>水平同步信号HSYNC(Horizontal Sync) 用于表示液晶屏一行像素数据的传输结束，每传输完成液晶屏的一行像素数据时，HSYNC 会发生电平跳变。</li><li>如分辨率为 800x480的显示屏(800 列，480 行)，传输一帧的图像HSYNC 的电平会跳变 480 次。</li></ul></li><li><p>垂直同步信号VSYNC</p><ul><li>垂直同步信号 VSYNC(Vertical Sync) 用于表示液晶屏一帧像素数据的传输结束，每传输完成一帧像素数据时，VSYNC 会发生电平跳变。</li><li>其中“帧”是图像的单位，一幅图像称为一帧，在液晶屏中，一帧指一个完整屏液晶像素点。</li><li>人们常常用“帧/秒”来表示液晶屏的刷新特性，即液晶屏每秒可以显示多少帧图像，如液晶屏以60 帧/秒的速率运行时，VSYNC 每秒钟电平会跳变60 次。</li></ul></li><li><p>数据使能信号DE</p><ul><li>数据使能信号 DE(Data Enable) 用于表示数据的有效性，当 DE 信号线为高电平时，RGB 信号线表示的数据有效。</li></ul></li></ul><h4 id="液晶数据传输时序" tabindex="-1"><a class="header-anchor" href="#液晶数据传输时序" aria-hidden="true">#</a> 液晶数据传输时序</h4><p>通过上述信号线向液晶屏传输像素数据时，各信号线的时序见图 “液晶时序图”。</p><p>图中表示的是向液晶屏传输一帧图像数据的时序，中间省略了多行及多个像素点。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190203319.png" alt="image-20221119020314225" style="zoom:50%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190210642.png" alt="image-20221119021000548" style="zoom:46%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211190210628.png" alt="image-20221119021028530" style="zoom:50%;"><p>液晶屏显示的图像可看作一个矩形，结合图 “液晶数据传输图解” 来理解。液晶屏有一个显示指针，它指向将要显示的像素。</p><p>显示指针的扫描方向方向从左到右、从上到下，一个像素点一个像素点地描绘图形。</p><p>这些像素点的数据通过RGB 数据线传输至液晶屏，它们在同步时钟CLK 的驱动下一个一个地传输到液晶屏中，交给显示指针，传输完成一行时，水平同步信号HSYNC 电平跳变一次，而传输完一帧时VSYNC 电平跳变一次。</p><p>但是，液晶显示指针在行与行之间，帧与帧之间切换时需要延时，而且 HSYNC 及 VSYNC 信号本身也有宽度，这些时间参数说明见表 “液晶通讯” 中的时间参数。</p><p>在这些时间参数控制的区域，数据使能信号线“DE”都为低电平，RGB 数据线的信号无效，当“DE”为高电平时，表示的数据有效，传输的数据会直接影响液晶屏的显示区域。</p><h4 id="显存" tabindex="-1"><a class="header-anchor" href="#显存" aria-hidden="true">#</a> 显存</h4><p>液晶屏中的每个像素点都是数据，在实际应用中需要把每个像素点的数据缓存起来，再传输给液晶屏，一般会使用SRAM 或SDRAM 性质的存储器，而这些专门用于存储显示数据的存储器，则被称为显存。</p><p>显存一般至少要能存储液晶屏的一帧显示数据，如分辨率为800x480 的液晶屏，使用RGB888 格式显示，它的一帧显示数据大小为：3x800x480=1152000 字节；</p><p>若使用RGB565 格式显示，一帧显示数据大小为：2x800x480=768000 字节。</p><p>一般来说，外置的液晶控制器会自带显存，而像 STM32F429 等集成液晶控制器的芯片可使用内部 SRAM 或外扩 SDRAM 用于显存空间。</p><h3 id="本笔记3-5寸液晶显示屏简介" tabindex="-1"><a class="header-anchor" href="#本笔记3-5寸液晶显示屏简介" aria-hidden="true">#</a> 本笔记3.5寸液晶显示屏简介</h3><p>该模块采用 TFTLCD面板，可以显示 16 位色的真彩图片。在本章中，我们将使用探索者 STM32F4 开发板上的LCD 接口，来点亮 TFTLCD，并实现 ASCII 字符和彩色的显示等功能，并在串口打印 LCD控制器 ID，同时在 LCD 上面显示。</p><h3 id="tftlcd-简介" tabindex="-1"><a class="header-anchor" href="#tftlcd-简介" aria-hidden="true">#</a> TFTLCD 简介</h3><p>TFT-LCD 即薄膜晶体管液晶显示器。其 英文全称为：Thin Film Transistor-Liquid Crystal Display。</p><p>TFT-LCD 与无源 TN-LCD、STN-LCD 的简单矩阵不同，它在液晶显示屏的每一个象素上都设置有一个薄膜晶体管（TFT），可有效地克服非选通时的串扰，使显示液晶屏的静态特性与扫描线数无关，因此大大提高了图像质量。TFT-LCD 也被叫做真彩液晶显示器。</p><p>TFTLCD 模块，该模块有如下特点：</p><ul><li>3.5 寸屏幕</li><li>320×480 的分辨率</li><li>触摸屏</li><li>262K 色</li></ul><p>该模块支持 262K 色显示，显示分辨率为 320×240，接口为 16 位的 80并口（<strong>80并口全称是8080并行接口，8080并行接口的发明者是INTEL（也称为Intel总线），该总线也被广泛应用于各类液晶显示器，TFT-LCD的80并口指的是LCD与外部连接方式采用的8080并行接口。</strong>），自带触摸屏。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211192134725.png" alt="image-20221119213455596" style="zoom:50%;"><p>TFTLCD 模块采用 16 位的并方式与外部连接，之所以不采用 8 位的方式，是因为彩屏的数据量比较大，尤其在显示图片的时候，如果用 8位数据线，就会比 16 位方式慢一倍以上，我们当然希望速度越快越好，所以我们选择 16位的接口。</p><ul><li>CS：TFTLCD 片选信号</li><li>WR：向 TFTLCD 写入数据</li><li>RD：从 TFTLCD 读取数据</li><li>D[15：0]：16 位双向数据线</li><li>RST：硬复位 TFTLCD</li><li>RS：命令/数据标志（0，读写命令；1，读写数据）</li></ul><p>TFTLCD 模块的 RST 信号线是直接接到 STM32F4 的复位脚上，并不由软件控制，这样可以省下来一个 IO 口。另外我们还需要一个背光控制线来控制 TFTLCD 的背光。</p><p>所以，我们总共需要的 IO 口数目为 21 个（除RST）。</p><p>2.8/3.5/4.3/7 寸等不同尺寸的 TFTLCD 模块，其驱动芯片有很多种类型，比如有：ILI9341/ILI9325/RM68042/RM68021/ILI9320/ILI9328/LGDP4531/LGDP4535/SPFD5408/SSD1289/1505/B505/C505/NT35310/NT35510/SSD1963 等，这里我们仅以 ILI9481 控制器为例进行介绍，其他的控制基本都类似，我们就不详细阐述了。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200116164.png" alt="WX20221119-221331@2x"></p><p>本液晶屏内部包含有一个液晶控制芯片 ILI9481 ，该芯片最主核心部分是位于中间的 GRAM(Graphics RAM)，它就是显存 。GRAM中每个存储单元都对应着液晶面板的一个像素点。</p><p>它右侧的各种模块共同作用把 GRAM 存储单元的数据转化成液晶面板的控制信号，使像素点呈现特定的颜色，而像素点组合起来则成为一幅完整的图像。</p><p>框图的左上角为 ILI9481 的主要控制信号线和配置引脚，根据其不同状态设置可以使芯片工作在不同的模式，如每个像素点的位数可以是 8、9、16 或18 位；</p><p>可配置使用 SPI 接口、8080 接口还是RGB 接口与MCU 进行通讯。</p><p>MCU 通过SPI、8080 接口或RGB 接口与ILI9481 进行通讯，从而访问它的控制寄存器(CR)、地址计数器 (AC)、及GRAM。</p><p>在GRAM 的上侧还有一个LED 控制器(LED Controller)。LCD 为非发光性的显示装置，它需要借助背光源才能达到显示功能，LED 控制器就是用来控制液晶屏中的 LED 背光源。</p><p><strong>其显存总大小为 345600字节（320 * 480 * 18（ILI9481最大支持18位模式） / 8（8位=1字节））</strong></p><h4 id="液晶屏的信号线及-8080-时序" tabindex="-1"><a class="header-anchor" href="#液晶屏的信号线及-8080-时序" aria-hidden="true">#</a> 液晶屏的信号线及 8080 时序</h4><p>ILI9806G 控制器根据自身的 IM[2:0] 信号线电平决定它与 MCU 的通讯方式，它本身支持 SPI 及8080 通讯方式。</p><p>本示例中液晶屏的 ILI9481 控制器在出厂前就已经按固定配置好 (内部已连接硬件电路)，<strong>它被配置为通过8080 接口通讯，使用16 根数据线的RGB565 格式，且背光LED 引脚不与ILI9481 相连，而是直接引出到排针供外部控制器控制</strong>。</p><p>内部硬件电路连接完，剩下的其它信号线被引出到FPC 排线，最后该排线由PCB 底板引出到排针，排针再与实验板上的STM32芯片连接，引出的排针信号线见图液晶屏引出的信号线 。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200135147.png" alt="WX20221120-013526@2x" style="zoom:50%;"><table><thead><tr><th>信号线</th><th>ILI9481 对应的信号线</th><th>说明</th></tr></thead><tbody><tr><td>LCD_D[15:0]</td><td>D[15:0]</td><td>数据信号</td></tr><tr><td>LCD_RD</td><td>RDX</td><td>读数据信号，低电平有效</td></tr><tr><td>LCD_RS</td><td>D/CX</td><td>数据/命令 信号，高电平时D[15:0]表示的是数据，低电平时 D[15:0]表示控制命令</td></tr><tr><td>LCD_RST</td><td>RESX</td><td>复位信号，硬复位 TFTLCD，本开发版中 RST 信号线是直接接到 STM32F4 的复位脚上</td></tr><tr><td>LCD_WR</td><td>CSX</td><td>写数据信号，低电平有效</td></tr><tr><td>LCD_CS</td><td>-</td><td>片选信号，低电平有效</td></tr><tr><td>BL_CTR</td><td>-</td><td>背光信号，高电平点亮</td></tr></tbody></table><p>这些信号线即 8080 通讯接口，带 X 的表示低电平有效，STM32 通过该接口与 ILI9481 芯片进行通讯，实现对液晶屏的控制。</p><p>通讯的内容主要包括命令和显存数据，显存数据即各个像素点的 RGB565 内容；</p><p>命令是指对 ILI9806G 的控制指令，MCU 可通过 8080 接口发送命令编码控制 ILI9481 的工作方式，例如复位指令、设置光标指令、睡眠模式指令等等，具体的指令在《ILI9341_DSxx.pdf》数据手册应该详细说明。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200202044.png" alt="WX20221120-015909@2x"></p><p>由图可知，写命令时序由片选信号 CSX 拉低开始，对数据/命令选择信号线 D/CX 也置低电平表示写入的是命令地址(可理解为命令编码，如软件复位命令：0x01)</p><p>以写信号WRX 为低，读信号 RDX 为高表示数据传输方向为写入</p><p>同时，在数据线 D[18:0](或 D[15:0]) 输出命令地址，在第二个传输阶段传送的是命令的参数，所以D/CX 要置高电平，表示写入的是命令数据，命令数据是某些指令带有的参数，如复位指令编码为 0x01，它后面可以带一个参数，该参数表示多少秒后复位(实际的复位命令不含参数，此处只是为了讲解指令编码与参数的区别)。</p><p>当需要把像素数据写入GRAM 时，过程很类似，把片选信号CSX 拉低后，再把数据/命令选择信号线D/CX 置为高电平，这时由D[23:0] 传输的数据则会被 ILI9481 保存至它的 GRAM 中。</p><h3 id="使用-stm32-的-fsmc-模拟-8080-接口时序" tabindex="-1"><a class="header-anchor" href="#使用-stm32-的-fsmc-模拟-8080-接口时序" aria-hidden="true">#</a> 使用 STM32 的 FSMC 模拟 8080 接口时序</h3><p>ILI9481 的 8080 通讯接口时序可以由 STM32 使用普通 I/O 接口进行模拟，但这样效率太低， STM32 提供了一种特别的控制方法——使用 FSMC 接口实现8080 时序。</p><h4 id="fsmc-简介" tabindex="-1"><a class="header-anchor" href="#fsmc-简介" aria-hidden="true">#</a> FSMC 简介</h4><p>在前面的《FSMC—扩展外部SRAM》章节中了解到STM32 的FSMC 外设可以用于控制扩展的外部存储器，而 MCU 对液晶屏的操作实际上就是把显示数据写入到显存中，与控制存储器非常类似，且 8080 接口的通讯时序完全可以使用 FSMC 外设产生，因而非常适合使用 FSMC 控制液晶屏。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200209381.png" alt="image-20221120020937153"></p><p>控制LCD 时，是使用FSMC 的NORPSRAM 模式的，且与前面使用FSMC 控制SRAM 的稍有不同，控制 SRAM 时使用的是模式 A，而控制 LCD 时使用的是与 NOR FLASH 一样的模式 B，所以我们重点分析框图中 NOR FLASH 控制信号线部分。</p><p>控制 NOR FLASH 主要使用到表 “FSMC 控制 NOR_FLASH 的信号线” 的信号线：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200215049.png" alt="image-20221120021506946"></p><p>在控制 LCD 时，使用的是类似异步、地址与数据线独立的 NOR FLASH 控制方式，所以实际上CLK、NWAIT、NADV 引脚并没有使用到。</p><p>FSMC NOR/PSRAM 中的模式 B 的写时序见图 “FSMC 写 NOR_FLASH 的时序图”。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200217776.png" alt="image-20221120021743546"></p><p>根据 STM32 对寻址空间的地址映射，地址 0x6000 0000 ~ 0x9FFF FFFF 是映射到外部存储器的，而其中的0x6000 0000 ~ 0x6FFF FFFF 则是分配给NOR FLASH、PSRAM 这类可直接寻址的器件。</p><p>当 FSMC 外设被配置成正常工作，并且外部接了 NOR FLASH 时，若向 0x60000000 地址写入数据如 0xABCD，FSMC 会自动在各信号线上产生相应的电平信号，写入数据。</p><p>FSMC 会控制片选信号 NE1 选择相应的 NOR 芯片，然后使用地址线 A[25:0] 输出 0x60000000，在 NWE 写使能信号线上发出低电平的写使能信号，而要写入的数据信号0xABCD 则从数据线D[15:0] 输出，然后数据就被保存到NOR FLASH 中了。</p><h4 id="用-fsmc-模拟-8080-时序" tabindex="-1"><a class="header-anchor" href="#用-fsmc-模拟-8080-时序" aria-hidden="true">#</a> 用 FSMC 模拟 8080 时序</h4><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200225438.png" alt="image-20221120022552323"></p><p>见表 “FSMC 的 NOR/PSRAM 与 8080 信号线对比” ，对比 FSMC NOR/PSRAM 中的模式 B 时序与 ILI9481液晶控制器芯片使用的 8080 时序可发现，这两个时序是十分相似的 (除了 FSMC 的地址线 A 和8080 的 D/CX 线，可以说是完全一样)。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200227768.png" alt="image-20221120022726661"></p><p>对于FSMC 和8080 接口，前四种信号线都是完全一样的，仅仅是FSMC 的地址信号线A[25:0] 与8080 的数据/命令选择线 D/CX 有区别。</p><p>而对于 D/CX 线，它为高电平的时候表示数值，为低电平的时候表示命令，如果能使用 FSMC 的 A 地址线根据不同的情况产生对应的电平，那么就完全可以使用 FSMC 来产生8080 接口需要的时序了。</p><p>为了模拟出 8080 时序，我们可以把 FSMC 的 A0 地址线 (也可以使用其它 A1/A2/... 等地址线) 与ILI9481芯片8080 接口的D/CX 信号线连接，那么当A0 为高电平时(即D/CX 为高电平)，数据线 D[15:0] 的信号会被 ILI9806G 理解为数值，若 A0 为低电平时 (即 D/CX 为低电平)，传输的信号则会被理解为命令。</p><ul><li>由于FSMC 会自动产生地址信号，当使用FSMC 向0x6xxx xxx1、0x6xxx xxx3、0x6xxx xxx5…这些奇数地址写入数据时，地址最低位的值均为1，所以它会控制地址线A0(D/CX) 输出高电平，那么这时通过数据线传输的信号会被理解为数值；</li><li>若向0x6xxx xxx0 、0x6xxx xxx2、0x6xxx xxx4…这些偶数地址写入数据时，地址最低位的值均为0，所以它会控制地址线A0(D/CX) 输出低电平，因此这时通过数据线传输的信号会被理解为命令，见表 “使用FSMC 输出地址示例”。</li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200232285.png" alt="WX20221120-023112@2x"></p><p>有了这个基础，只要配置好FSMC 外设，然后在代码中利用指针变量，向不同的地址单元写入数据，就能够由 FSMC 模拟出的 8080接口向 ILI9481 写入控制命令或GRAM 的数据了。</p><p>注意：在实际控制时，以上地址计算方式还不完整，还需要注意HADDR（AHB总线） 内部地址与FSMC 地址信号线的转换，关于这部分内容在代码时再详细举例说明。</p><h4 id="nor-flash-时序结构体" tabindex="-1"><a class="header-anchor" href="#nor-flash-时序结构体" aria-hidden="true">#</a> NOR FLASH 时序结构体</h4><p>了解一下与FSMC NOR FLASH 控制相关的结构体。</p><p>与控制 SRAM 时一样，控制 FSMC 使用 NOR FLASH 存储器时主要是配置时序寄存器以及控制寄存器，利用 ST 标准库的时序结构体以及初始化结构体可以很方便地写入参数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> FSMC_AddressSetupTime<span class="token punctuation">;</span> <span class="token comment">/* 地址建立时间，0-0xF 个 HCLK 周期 */</span> 
<span class="token class-name">uint32_t</span> FSMC_AddressHoldTime<span class="token punctuation">;</span> 	<span class="token comment">/* 地址保持时间，0-0xF 个 HCLK 周期 */</span>
<span class="token class-name">uint32_t</span> FSMC_DataSetupTime<span class="token punctuation">;</span>		<span class="token comment">/* 地址建立时间，0-0xF 个 HCLK 周期 */</span>
<span class="token class-name">uint32_t</span> FSMC_BusTurnAroundDuration<span class="token punctuation">;</span><span class="token comment">/* 总线转换周期,0-0xF 个 HCLK 周期，在 NOR FLASH */</span>
<span class="token class-name">uint32_t</span> FSMC_CLKDivision<span class="token punctuation">;</span>	<span class="token comment">/* 时钟分频因子,1-0xF，若控制异步存储器，本参数无效 */</span> 
<span class="token class-name">uint32_t</span> FSMC_DataLatency<span class="token punctuation">;</span> 	<span class="token comment">/* 数据延迟时间，若控制异步存储器，本参数无效 */</span>
<span class="token class-name">uint32_t</span> FSMC_AccessMode<span class="token punctuation">;</span> 	<span class="token comment">/* 设置访问模式 */</span>
<span class="token punctuation">}</span> FSMC_NORSRAMTimingInitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个结构体与 SRAM 中的时序结构体完全一样，以下仅列出控制 NOR FLASH 时使用模式 B 用到的结构体成员说明：</p><ul><li><code>FSMC_AddressSetupTime</code> 本成员设置地址建立时间，即FSMC 读写时序图FSMC 写NOR_FLASH 的时序图中的ADDSET 值，它可以被设置为0～0xF 个HCLK 周期数，按STM32 标准库的默认配置，HCLK 的时钟频率为 168MHz，即一个 HCLK 周期为1/168 微秒。</li><li><code>FSMC_DataSetupTime</code> 本成员设置数据建立时间，即FSMC 读写时序图 “FSMC 写NOR_FLASH 的时序图” 中的DATAST 值，它可以被设置为0～0xF 个 HCLK 周期数。</li><li><code>FSMC_AccessMode</code> 本成员设置存储器访问模式，不同的模式下 FSMC 访问存储器地址时引脚输出的时序不一样，可选 FSMC_AccessMode_A/B/C/D 模式。控制异步 NOR FLASH 时使用 模式B。</li></ul><p>这个 FSMC_NORSRAMTimingInitTypeDef 时序结构体配置的延时参数，将作为下一节的 FSMC NOR FLASH 初始化结构体的一个成员。</p><h4 id="fsmc-初始化结构体" tabindex="-1"><a class="header-anchor" href="#fsmc-初始化结构体" aria-hidden="true">#</a> FSMC 初始化结构体</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
<span class="token class-name">uint32_t</span> FSMC_Bank<span class="token punctuation">;</span>								<span class="token comment">/* 设置要控制的 Bank 区域 */</span>
<span class="token class-name">uint32_t</span> FSMC_DataAddressMux<span class="token punctuation">;</span> 		<span class="token comment">/* 设置地址总线与数据总线是否复用 */</span>
<span class="token class-name">uint32_t</span> FSMC_MemoryType<span class="token punctuation">;</span>					<span class="token comment">/* 设置存储器的类型 */</span>
<span class="token class-name">uint32_t</span> FSMC_MemoryDataWidth<span class="token punctuation">;</span>		<span class="token comment">/* 设置存储器的数据宽度 */</span>
<span class="token class-name">uint32_t</span> FSMC_BurstAccessMode<span class="token punctuation">;</span>		<span class="token comment">/* 设置是否支持突发访问模式，只支持同步类型的存储器 */</span>
<span class="token class-name">uint32_t</span> FSMC_AsynchronousWait<span class="token punctuation">;</span> 	<span class="token comment">/* 设置是否使能在同步传输时的等待信号，*/</span> 
<span class="token class-name">uint32_t</span> FSMC_WaitSignalPolarity<span class="token punctuation">;</span>	<span class="token comment">/* 设置等待信号的极性 */</span>
<span class="token class-name">uint32_t</span> FSMC_WrapMode<span class="token punctuation">;</span>						<span class="token comment">/* 设置是否支持对齐的突发模式 */</span>
<span class="token class-name">uint32_t</span> FSMC_WaitSignalActive<span class="token punctuation">;</span>		<span class="token comment">/* 配置等待信号在等待前有效还是等待期间有效 */</span> 
<span class="token class-name">uint32_t</span> FSMC_WriteOperation<span class="token punctuation">;</span>			<span class="token comment">/* 设置是否写使能 */</span>
<span class="token class-name">uint32_t</span> FSMC_WaitSignal<span class="token punctuation">;</span>					<span class="token comment">/* 设置是否使能等待状态插入 */</span>
<span class="token class-name">uint32_t</span> FSMC_ExtendedMode<span class="token punctuation">;</span>				<span class="token comment">/* 设置是否使能扩展模式 */</span>
<span class="token class-name">uint32_t</span> FSMC_WriteBurst<span class="token punctuation">;</span>					<span class="token comment">/* 设置是否使能写突发操作 */</span>
FSMC_NORSRAMTimingInitTypeDef<span class="token operator">*</span> FSMC_ReadWriteTimingStruct<span class="token punctuation">;</span> <span class="token comment">/* 当不使用扩展模式时，本参数用于配置读写时序，否则用于配置读时序 */</span> 
FSMC_NORSRAMTimingInitTypeDef<span class="token operator">*</span> FSMC_WriteTimingStruct<span class="token punctuation">;</span> <span class="token comment">/* 当使用扩展模式时，本参数用于配置写时序 */</span>
<span class="token punctuation">}</span>FSMC_NORSRAMInitTypeDef<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这部分内容与 FSMC 控制 SRAM 时完全一致，此处仅列出与 NOR FLASH 模式 B 相关的一些结构体成员的说明：</p><ul><li><p><code>FSMC_Bank</code> 本成员用于选择 FSMC 映射的存储区域，它的可选参数以及相应的内核地址映射范围见表 “可以选择的存储器区域及区域对应的地址范围”。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200245765.png" alt="image-20221120024540632"></p></li><li><p><code>FSMC_MemoryType</code> 本成员用于设置要控制的存储器类型，它支持控制的存储器类型为 SRAM、PSRAM以及NOR FLASH。(FSMC_MemoryType_SRAM / PSRAM / NOR)。</p></li><li><p><code>FSMC_MemoryDataWidth</code> 本成员用于设置要控制的存储器的数据宽度，可选择设置成 8 或 16 位(FSMC_MemoryDataWidth_8b /16b)。</p></li><li><p><code>FSMC_WriteOperation</code> 这个成员用于设置是否写使能(FSMC_WriteOperation_ Enable /Disable)，禁止写使能的话 FSMC 只能从存储器中读取数据，不能写入。</p></li><li><p><code>FSMC_ExtendedMode</code> 本成员用于设置是否使用扩展模式 (FSMC_ExtendedMode_Enable/Disable)，在非扩展模式下，对存储器读写的时序都只使用 FSMC_BCR 寄存器中的配置，即下面的FSMC_ReadWriteTimingStruct 结构体成员；</p><ul><li>在扩展模式下，对存储器的读写时序可以分开配置，读时序使用FSMC_BCR 寄存器，写时序使用FSMC_BWTR 寄存器的配置，即后面的FSMC_WriteTimingStruct 结构体成员。</li></ul></li><li><p><code>FSMC_ReadWriteTimingStruct</code> 本成员是一个指针，赋值时使用上一小节中讲解的时序结构 体FSMC_NORSRAMInitTypeDef 设置，当不使用扩展模式时，读写时序都使用本成员的参数配置。</p></li><li><p><code>FSMC_WriteTimingStruct</code> 同样地，本成员也是一个时序结构体的指针，只有当使用扩展模式时，本配置才有效，它是写操作使用的时序。</p></li></ul><p>对本结构体赋值完成后，调用 FSMC_NORSRAMInit 库函数即可把配置参数写入到 FSMC_BCR及 FSMC_BTR/BWTR 寄存器中。</p><h3 id="fsmc—液晶显示实验" tabindex="-1"><a class="header-anchor" href="#fsmc—液晶显示实验" aria-hidden="true">#</a> FSMC—液晶显示实验</h3><h4 id="硬件设计-7" tabindex="-1"><a class="header-anchor" href="#硬件设计-7" aria-hidden="true">#</a> 硬件设计</h4><p>使用FSMC 外设控制实验板配套的4.5 寸 ILI9481 液晶屏，见图液晶屏实物图，该液晶屏的分辨率为 480 x 320，支持 RGB565 格式。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200313976.png" alt="image-20221120031349847" style="zoom:67%;"><p>屏幕的PCB 底板引出的信号线会通过PCB 底板上的FPC 接口与液晶面板连接，这些信包括液晶控制相关的 CS、RS 等信号及 DB0-DB15 数据线。</p><p>其中 RS 引脚以高电平表示传输数据，低电平表示传输命令；</p><p>另外还有引出 LCD_K 引脚用于控制屏幕的背光供电，可以通过该引脚控制背光的强度，该引脚为低电平时打开背光。</p><p>除液晶部分的 FPC 接口外，PCB 底板还有一个连接到电阻触摸屏控制器的 FPC 接口，用于检测触摸信号。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200316377.png" alt="image-20221120031643143"></p><p>触摸检测的主体是型号为 XPT2046 的芯片，它接收触摸屏的信号进行处理，把触摸信息使用 SPI接口输出到 STM32 等控制器，在触摸屏章节将会详细了解其检测原理。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200320305.png" alt="image-20221120032043161" style="zoom:50%;"><p>“图液晶屏接口” 表示的是 PCB 底板引出的排针线序，屏幕整体通过这些引出的排针与开发板或其它控制器连接。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211200406733.png" alt="未命名"></p><p>​ LCD 与 MCU 的连接</p><p>“图开发板与屏幕的连接的信号说明” 是本 F407 开发板上的液晶排母接口原理图，它说明了配套的 4.5 寸屏幕接入到开发板上时的信号连接关系。</p><p>其中请着重关注图中液晶屏 LCD_CS 及LCD_RS(即 DC 引脚) 与 FSMC 存储区选择引脚 FSMC_NE 及地址信号 FSMC_A 的编号，它们会决定STM32 要使用什么内存地址来控制与液晶屏的通讯。</p><p>若您使用的液晶屏或实验板不一样，请根据实际连接的引脚修改程序。</p><h4 id="软件设计-7" tabindex="-1"><a class="header-anchor" href="#软件设计-7" aria-hidden="true">#</a> 软件设计</h4><p>新建“bsp_ILI9481_lcd.c”及“bsp_ILI9481_lcd.h”文件，它们不属于STM32 标准库的内容，是由我们自己根据应用需要编写的。</p><h4 id="编程要点-7" tabindex="-1"><a class="header-anchor" href="#编程要点-7" aria-hidden="true">#</a> 编程要点</h4><ul><li>初始化通讯使用的目标引脚及端口时钟；</li><li>使能 FSMC 外设的时钟；</li><li>配置 FSMC 为异步NOR FLASH 模式以仿真 8080 时序；</li><li>建立机制使用FSMC 向液晶屏发送命令及数据；</li><li>发送控制命令初始化液晶屏；</li><li>编写液晶屏的绘制像素点函数；</li><li>利用描点函数制作各种不同的液晶显示应用。</li></ul><p>把 FSMC 配置成异步 NOR FLASH 使用的模式 B，使用该方式模拟 8080 时序 控制液晶屏，执行流程如下：</p><ul><li>初始化 FSMC 时钟 <ul><li>使用库函数RCC_AHBPeriphClockCmd 使能FSMC 外设的时钟。</li></ul></li><li>时序结构体赋值</li></ul><p>对时序结构体FSMC_NORSRAMTimingInitTypeDef 赋值。</p><p>在这个时序结构体配置中，由于我们要使用异步 NORFLASH 的方式模拟 8080 时序，所以选择 FSMC 为模式 B，在该模式下配置 FSMC 的控制时序结构体中，实际上只有地址建立时间FSMC_AddressSetupTime（即ADDSET的值）以及数据建立时间 FSMC_DataSetupTime（即 DATAST 的值）成员的配置值是有效的</p><p>其它异步 NOR FLASH 没使用到的成员值全配置为 0 即可。</p><p>而且，这些成员值使用的单位为：1 个HCLK 的时钟周期，而HCLK 的时钟频率为 168MHz，对应每个时钟周期为1/168 微秒。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211210042708.png" alt="1668962155477"></p><p>由图 “ILI9481 时序参数说明图” 及图 “ILI9481 的时序参数” 要求中的ILI9806G 时序参数说明及要求可大致得知 ILI9481 的写周期为最小twc = 66ns，而读周期最小为trdl+trod=45+20=65ns。（对于读周期表中有参数要一个要求为 trcfm 和 trc 分别为 450ns 及 160ns，但经过测试并不需要遵照它们的指标要求）</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211210054109.png" alt="image-20221121005418739"></p><p>在 FSMC 代 码 中 使 用 结 构 体 中 的 FSMC_AddressSetupTime（即 ADDSET 的 值） 及FSMC_DataSetupTime（即 DATAST 的值）成员控制 FSMC 的读写周期，见图 “FSMC 的读写时序”。</p><p>结合 ILI9806G 的时序要求和 FSMC 的配置图，代码中按照读写时序周期均要求至少 66ns 来计算，配置结果为ADDSET = 1 及DATST = 12，把时间单位1/168 微秒(即1000/168 纳秒) 代入，因此读写周期的时间被配置为：</p><ul><li><p>读周期：trc =((ADDSET+1)+(DATST+1)+2) *1000/168 = ((1+1=2)+(12+1=13)+2)*1000/168 = 101ns</p></li><li><p>写周期：twc =((ADDSET+1)+(DATST+1)) *1000/168 = ((1+1=2)+(12+1=13))*1000/168 = 89ns</p></li></ul><p>把这两个参数值写入到FSMC 后，它控制的读写周期都比 ILI9481 的最低要求值大。（经测试，这两个参数值也可以适当减小，您可以亲自试一下）</p><p>把计算得的参数赋值到时序结构体中的 FSMC_AddressSetupTime（即 ADDSET 的值）及FSMC_DataSetupTime（即DATAST 的值）中，然后再把时序结构体作为指针赋值到下面的FSMC初始化结构体中，作为读写的时序参数，最后再调用FSMC_NORSRAMInit 函数即可把参数写入到相应的寄存器中。</p><p><strong>配置 FSMC 初始化结构体</strong></p><ul><li><code>设置存储区域 FSMC_Bank</code> FSMC_Bank 成 员 设 置 FSMC 的 NOR FLASH 存 储 区 域 映 射 选 择 为 宏 FSMC_Bank1_NORSRAMx (即FSMC_Bank1_NORSRAM4)，这是由于我们的SRAM 硬件连接到FSMC_NE4 和NOR/PSRAM 相关引脚，所以对应到存储区域Bank1_SRAM4，对应的基地址为0X6C00 0000</li><li><code>存储器类型FSMC_MemoryType</code> 由于使用异步 NOR FLASH 模式模拟 8080 时序，所以 FSMC_MemoryType 成员要选择相应的FSMC_MemoryType_NOR；</li><li><code>数据线宽度FSMC_MemoryDataWidth</code> 根据硬件的数据线连接，数据线宽度被配置为16 位宽FSMC_MemoryDataWidth_16b；</li><li><code>写使能FSMC_WriteOperation</code> FSMC_WriteOperation 用于设置写使能，只有使能了才能正常使用 FSMC 向外部存储器写入数据；</li><li><code>扩展模式以及读写时序</code> 在FSMC_ExtendedMode 成员中可以配置是否使用扩展模式，当设置扩展模式时，读时序使用 FSMC_ReadWriteTimingStruct 中的配置，写时序使用 FSMC_WriteTimingStruct中的配置，两种配置互相独立，可以赋值为不同的读写时序结构体。在本实例中不使用扩展模式，即读写时序使用相同的配置，都是赋值为前面的 readWriteTiming 结构体</li><li><code>其它</code> 配置FSMC 还涉及到其它的结构体成员，但这些结构体成员与异步NOR FLASH 控制不相关，都被设置为Disable 了；</li></ul><p>赋值完成后调用库函数FSMC_NORSRAMInit 把初始化结构体配置的各种参数写入到FSMC_BCR控制寄存器及 FSMC_BTR 时序寄存器中。最后调用 FSMC_NORSRAMCmd 函数使能要控制的存储区域FSMC_Bank1_NORSRAM3。</p><p><strong>计算控制液晶屏时使用的地址</strong></p><p>初始化完FSMC 后，即可使用类似扩展外部SRAM 中的读取方式：通过访问某个地址，由FSMC产生时序与外部存储器通讯，进行读写。</p><p>同样地，当访问特定地址时，FSMC 会产生相应的模拟8080 时序，控制地址线输出要访问的内存地址，使用数据信号线接收或发送数据，</p><p>其它片选信号NE、读使能信号NOE、写使能信号NWE辅助产生完整的时序，而由于控制液晶屏的硬件连接中，使用如图 <code>FSMC 与 8080 端口连接简</code> 图中的连接来模拟 8080 时序，所以 FSMC 产生的这些信号会被 ILI9806G 接收，并且使用其中一根 FSMC_Ax 地址控制命令/数据选择引脚 RS(即 D/CX)</p><p>因此，需要重点理解下当 STM32 访问什么地址时，对应的FSMC_Ax 引脚会输出高电平表示传输的是数据，访问什么地址时，对应的 FSMC_Ax 引脚会输出低电平表示传输的是命令。</p><p>若理解了计算过程，以后就可以根据自己制作的硬件电路来计算访问地址了。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211210205502.png" alt="未命名 00.42.40"></p><p>计算地址的过程如下：</p><p>(1) 本工程中使用的是FSMC_NE4 作为8080_CS 片选信号，所以首先可以确认地址范围，当访问0X6C00 0000 ~ 0X6FFF FFFF 地址时，FSMC 均会对外产生片选有效的访问时序；</p><p>(2) 本工程中使用 FSMC_A6 地址线作为命令/数据选择线 RS 信号，所以在以上地址范围内，再选择出使得 FSMC_A6 输出高电平的地址，即可控制表示数据</p><p>选择出使得 FSMC_A6 输出低电平的地址，即可控制表示命令。</p><ul><li>要使 FSMC_A6 地址线为高电平，实质是输出地址信号的第 6 位为 1 即可，使用 0X6C000000~0X6FFF FFFF 内的任意地址，作如下运算： <ul><li>设置地址的第 6 位为1：0X6C00 0000 |= (1«6) = 0x6C00 0040</li></ul></li><li>要使 FSMC_A0 地址线为低电平，实质是输出地址信号的第 0 位为 0 即可，使用 0X6C000000~0X6FFF FFFF 内的任意地址，作如下运算： <ul><li>设置地址的第 6 位为0：0X6C00 0000 &amp;= ~ (1«6) = 0x6C00 0000</li></ul></li></ul><p>(3)<img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211210256210.png" alt="image-20221121025608831"></p><p>但是，以上方法计算的地址还不完全正确，根据《STM32 参考手册》对 FSMC 访问 NOR FLASH 的说明，<strong>HADDR 是 AHB 内部地址线，但也会参与对外部存储器的寻址</strong>。它是字节地址 (8 位，按字节访问)，而我们需要每次从外部取16位数据，但是HADDR中每个地址对应取出来的数是8位，所以我们就让地址指针一次加2，那么这样就相当于第0位没用了</p><p>16位寻址和8位寻址差了一倍，所以地址线差出一根；</p><p>16位寻址时，芯片内总线寻址HADDR[25:1],地址从A1开始，对应IO口寻址为 FSMC_A[24:0]，地址从A0开始，为什么选择以上偏移1位的对应关系，见下表：</p><table><thead><tr><th style="text-align:center;">总线寻址HADDR[25:1]</th><th style="text-align:center;">IO寻址FSMC_A[24:0]</th></tr></thead><tbody><tr><td style="text-align:center;">0000=0</td><td style="text-align:center;">0000=0</td></tr><tr><td style="text-align:center;">0010=2</td><td style="text-align:center;">0001=1</td></tr><tr><td style="text-align:center;">0100=4</td><td style="text-align:center;">0010=2</td></tr><tr><td style="text-align:center;">0110=6</td><td style="text-align:center;">0011=3</td></tr><tr><td style="text-align:center;">1000=8</td><td style="text-align:center;">0100=4</td></tr><tr><td style="text-align:center;">1010=A</td><td style="text-align:center;">0101=5</td></tr><tr><td style="text-align:center;">1100=C</td><td style="text-align:center;">0110=6</td></tr><tr><td style="text-align:center;">1110=E</td><td style="text-align:center;">0111=7</td></tr></tbody></table><p>在本工程中使用的是16 位的数据访问方式，所以HADDR 与FSMC_A 的地址线连接关系会左移一位（相当于HADDR（按字节访问，一次自增2字节 ,HADDR 是 FSMC的2倍）），如HADDR1 与FSMC_A0 对应、HADDR2 与FSMC_A1 对应。</p><p>因此，当FSMC_A0 地址线为 1 时，实际上内部地址的第 1 位为 1，FSMC_A6 地址线为 1 时，实际上内部地址的第 2 位为1。同样地，当希望FSMC_A6 地址输出高电平或低电平时，需要重新调整计算公式：</p><ul><li>要使 FSMC_A6 地址线为高电平，实质是输出地址信号的第 6 位为 1 即可，使用 0X6C000000~0X6FFF FFFF 内的任意地址，作如下运算： <ul><li>设置地址的第 6 位为1：0X6C00 0000 |= (1«(6+1)) = 0x6C00 0080</li></ul></li><li>要使 FSMC_A0 地址线为低电平，实质是输出地址信号的第 0 位为 0 即可，使用 0X6C000000~0X6FFF FFFF 内的任意地址，作如下运算： <ul><li>设置地址的第 6 位为0：0X6C00 0000 &amp;= ~ (1«(6+1)) = 0x6C00 0000</li></ul></li></ul><p>根据最终的计算结果，总结如下：当STM32 访问内部的0x6800 0002 地址时，FSMC 自动输出时序，且使得与液晶屏的数据/命令选择线RS(即D/CX) 相连的FSMC_A0 输出高电平，使得液晶屏会把传输过程理解为数据传输；</p><p>类似地，当STM32 访问内部的 0X68000000 地址时，FSMC 自动输出时序，且使得与液晶屏的数据/命令选择线RS(即D/CX) 相连的FSMC_A0 输出低电平，使得液晶屏会把传输过程理解为命令传输。</p><h2 id="lcd-液晶显示中英文" tabindex="-1"><a class="header-anchor" href="#lcd-液晶显示中英文" aria-hidden="true">#</a> LCD 液晶显示中英文</h2><p>本章参考资料： 《STM32F4xx-中文参考手册》 、 《STM32F4xx 数据手册》 、库帮助文档《stm32f4xx_dsp_stdperiph_lib_um.chm》。</p><p>在前面我们学习了如何使用 FSMC 外设控制液晶屏并用它显示各种图形，本章讲解如何控制液晶屏显示文字。使用液晶屏显示文字时，涉及到字符编码与字模的知识。</p><h3 id="字符编码" tabindex="-1"><a class="header-anchor" href="#字符编码" aria-hidden="true">#</a> 字符编码</h3><p>由于计算机只能识别0 和1，文字也只能以0 和1 的形式在计算机里存储，所以我们需要对文字进行编码才能让计算机处理，编码的过程就是规定特定的 01 数字符串来表示特定的文字，最简单的字符编码例子是ASCII 码。</p><h4 id="ascii-编码" tabindex="-1"><a class="header-anchor" href="#ascii-编码" aria-hidden="true">#</a> ASCII 编码</h4><p>学习C 语言时，我们知道在程序设计中使用ASCII 编码表约定了一些控制字符、英文及数字。它们在存储器中，本质也是二进制数，只是我们约定这些二进制数可以表示某些特殊意义，如以ASCII 编码解释数字“0x41”时，它表示英文字符“A”。</p><p>ASCII 码表分为两部分，第一部分是控制字符或通讯专用字符，它们的数字编码从 0~31，它们并没有特定的图形显示，但会根据不同的应用程序，而对文本显示有不同的影响。</p><p>ASCII 码的第二部分包括空格、阿拉伯数字、标点符号、大小写英文字母以及“DEL（删除控制）”，这部分符号的数字编码从 32~127，除最后一个 DEL 符号外，都能以图形的方式来表示，它们属于传统文字书写系统的一部分。</p><table><thead><tr><th>二进制</th><th>十进制</th><th>十六进制</th><th>字符/缩写</th><th>解释</th></tr></thead><tbody><tr><td>00000000</td><td>0</td><td>00</td><td>NUL (NULL)</td><td>空字符</td></tr><tr><td>00000001</td><td>1</td><td>01</td><td>SOH (Start Of Headling)</td><td>标题开始</td></tr><tr><td>00000010</td><td>2</td><td>02</td><td>STX (Start Of Text)</td><td>正文开始</td></tr><tr><td>00000011</td><td>3</td><td>03</td><td>ETX (End Of Text)</td><td>正文结束</td></tr><tr><td>00000100</td><td>4</td><td>04</td><td>EOT (End Of Transmission)</td><td>传输结束</td></tr><tr><td>00000101</td><td>5</td><td>05</td><td>ENQ (Enquiry)</td><td>请求</td></tr><tr><td>00000110</td><td>6</td><td>06</td><td>ACK (Acknowledge)</td><td>回应/响应/收到通知</td></tr><tr><td>00000111</td><td>7</td><td>07</td><td>BEL (Bell)</td><td>响铃</td></tr><tr><td>00001000</td><td>8</td><td>08</td><td>BS (Backspace)</td><td>退格</td></tr><tr><td>00001001</td><td>9</td><td>09</td><td>HT (Horizontal Tab)</td><td>水平制表符</td></tr><tr><td>00001010</td><td>10</td><td>0A</td><td>LF/NL(Line Feed/New Line)</td><td>换行键</td></tr><tr><td>00001011</td><td>11</td><td>0B</td><td>VT (Vertical Tab)</td><td>垂直制表符</td></tr><tr><td>00001100</td><td>12</td><td>0C</td><td>FF/NP (Form Feed/New Page)</td><td>换页键</td></tr><tr><td>00001101</td><td>13</td><td>0D</td><td>CR (Carriage Return)</td><td>回车键</td></tr><tr><td>00001110</td><td>14</td><td>0E</td><td>SO (Shift Out)</td><td>不用切换</td></tr><tr><td>00001111</td><td>15</td><td>0F</td><td>SI (Shift In)</td><td>启用切换</td></tr><tr><td>00010000</td><td>16</td><td>10</td><td>DLE (Data Link Escape)</td><td>数据链路转义</td></tr><tr><td>00010001</td><td>17</td><td>11</td><td>DC1/XON (Device Control 1/Transmission On)</td><td>设备控制1/传输开始</td></tr><tr><td>00010010</td><td>18</td><td>12</td><td>DC2 (Device Control 2)</td><td>设备控制2</td></tr><tr><td>00010011</td><td>19</td><td>13</td><td>DC3/XOFF (Device Control 3/Transmission Off)</td><td>设备控制3/传输中断</td></tr><tr><td>00010100</td><td>20</td><td>14</td><td>DC4 (Device Control 4)</td><td>设备控制4</td></tr><tr><td>00010101</td><td>21</td><td>15</td><td>NAK (Negative Acknowledge)</td><td>无响应/非正常响应/拒绝接收</td></tr><tr><td>00010110</td><td>22</td><td>16</td><td>SYN (Synchronous Idle)</td><td>同步空闲</td></tr><tr><td>00010111</td><td>23</td><td>17</td><td>ETB (End of Transmission Block)</td><td>传输块结束/块传输终止</td></tr><tr><td>00011000</td><td>24</td><td>18</td><td>CAN (Cancel)</td><td>取消</td></tr><tr><td>00011001</td><td>25</td><td>19</td><td>EM (End of Medium)</td><td>已到介质末端/介质存储已满/介质中断</td></tr><tr><td>00011010</td><td>26</td><td>1A</td><td>SUB (Substitute)</td><td>替补/替换</td></tr><tr><td>00011011</td><td>27</td><td>1B</td><td>ESC (Escape)</td><td>逃离/取消</td></tr><tr><td>00011100</td><td>28</td><td>1C</td><td>FS (File Separator)</td><td>文件分割符</td></tr><tr><td>00011101</td><td>29</td><td>1D</td><td>GS (Group Separator)</td><td>组分隔符/分组符</td></tr><tr><td>00011110</td><td>30</td><td>1E</td><td>RS (Record Separator)</td><td>记录分离符</td></tr><tr><td>00011111</td><td>31</td><td>1F</td><td>US (Unit Separator)</td><td>单元分隔符</td></tr><tr><td>00100000</td><td>32</td><td>20</td><td>(Space)</td><td>空格</td></tr><tr><td>00100001</td><td>33</td><td>21</td><td>!</td><td></td></tr><tr><td>00100010</td><td>34</td><td>22</td><td>&quot;</td><td></td></tr><tr><td>00100011</td><td>35</td><td>23</td><td>#</td><td></td></tr><tr><td>00100100</td><td>36</td><td>24</td><td>$</td><td></td></tr><tr><td>00100101</td><td>37</td><td>25</td><td>%</td><td></td></tr><tr><td>00100110</td><td>38</td><td>26</td><td>&amp;</td><td></td></tr><tr><td>00100111</td><td>39</td><td>27</td><td>&#39;</td><td></td></tr><tr><td>00101000</td><td>40</td><td>28</td><td>(</td><td></td></tr><tr><td>00101001</td><td>41</td><td>29</td><td>)</td><td></td></tr><tr><td>00101010</td><td>42</td><td>2A</td><td>*</td><td></td></tr><tr><td>00101011</td><td>43</td><td>2B</td><td>+</td><td></td></tr><tr><td>00101100</td><td>44</td><td>2C</td><td>,</td><td></td></tr><tr><td>00101101</td><td>45</td><td>2D</td><td>-</td><td></td></tr><tr><td>00101110</td><td>46</td><td>2E</td><td>.</td><td></td></tr><tr><td>00101111</td><td>47</td><td>2F</td><td>/</td><td></td></tr><tr><td>00110000</td><td>48</td><td>30</td><td>0</td><td></td></tr><tr><td>00110001</td><td>49</td><td>31</td><td>1</td><td></td></tr><tr><td>00110010</td><td>50</td><td>32</td><td>2</td><td></td></tr><tr><td>00110011</td><td>51</td><td>33</td><td>3</td><td></td></tr><tr><td>00110100</td><td>52</td><td>34</td><td>4</td><td></td></tr><tr><td>00110101</td><td>53</td><td>35</td><td>5</td><td></td></tr><tr><td>00110110</td><td>54</td><td>36</td><td>6</td><td></td></tr><tr><td>00110111</td><td>55</td><td>37</td><td>7</td><td></td></tr><tr><td>00111000</td><td>56</td><td>38</td><td>8</td><td></td></tr><tr><td>00111001</td><td>57</td><td>39</td><td>9</td><td></td></tr><tr><td>00111010</td><td>58</td><td>3A</td><td>:</td><td></td></tr><tr><td>00111011</td><td>59</td><td>3B</td><td>;</td><td></td></tr><tr><td>00111100</td><td>60</td><td>3C</td><td>&lt;</td><td></td></tr><tr><td>00111101</td><td>61</td><td>3D</td><td>=</td><td></td></tr><tr><td>00111110</td><td>62</td><td>3E</td><td>&gt;</td><td></td></tr><tr><td>00111111</td><td>63</td><td>3F</td><td>?</td><td></td></tr><tr><td>01000000</td><td>64</td><td>40</td><td>@</td><td></td></tr><tr><td>01000001</td><td>65</td><td>41</td><td>A</td><td></td></tr><tr><td>01000010</td><td>66</td><td>42</td><td>B</td><td></td></tr><tr><td>01000011</td><td>67</td><td>43</td><td>C</td><td></td></tr><tr><td>01000100</td><td>68</td><td>44</td><td>D</td><td></td></tr><tr><td>01000101</td><td>69</td><td>45</td><td>E</td><td></td></tr><tr><td>01000110</td><td>70</td><td>46</td><td>F</td><td></td></tr><tr><td>01000111</td><td>71</td><td>47</td><td>G</td><td></td></tr><tr><td>01001000</td><td>72</td><td>48</td><td>H</td><td></td></tr><tr><td>01001001</td><td>73</td><td>49</td><td>I</td><td></td></tr><tr><td>01001010</td><td>74</td><td>4A</td><td>J</td><td></td></tr><tr><td>01001011</td><td>75</td><td>4B</td><td>K</td><td></td></tr><tr><td>01001100</td><td>76</td><td>4C</td><td>L</td><td></td></tr><tr><td>01001101</td><td>77</td><td>4D</td><td>M</td><td></td></tr><tr><td>01001110</td><td>78</td><td>4E</td><td>N</td><td></td></tr><tr><td>01001111</td><td>79</td><td>4F</td><td>O</td><td></td></tr><tr><td>01010000</td><td>80</td><td>50</td><td>P</td><td></td></tr><tr><td>01010001</td><td>81</td><td>51</td><td>Q</td><td></td></tr><tr><td>01010010</td><td>82</td><td>52</td><td>R</td><td></td></tr><tr><td>01010011</td><td>83</td><td>53</td><td>S</td><td></td></tr><tr><td>01010100</td><td>84</td><td>54</td><td>T</td><td></td></tr><tr><td>01010101</td><td>85</td><td>55</td><td>U</td><td></td></tr><tr><td>01010110</td><td>86</td><td>56</td><td>V</td><td></td></tr><tr><td>01010111</td><td>87</td><td>57</td><td>W</td><td></td></tr><tr><td>01011000</td><td>88</td><td>58</td><td>X</td><td></td></tr><tr><td>01011001</td><td>89</td><td>59</td><td>Y</td><td></td></tr><tr><td>01011010</td><td>90</td><td>5A</td><td>Z</td><td></td></tr><tr><td>01011011</td><td>91</td><td>5B</td><td>[</td><td></td></tr><tr><td>01011100</td><td>92</td><td>5C</td><td>\</td><td></td></tr><tr><td>01011101</td><td>93</td><td>5D</td><td>]</td><td></td></tr><tr><td>01011110</td><td>94</td><td>5E</td><td>^</td><td></td></tr><tr><td>01011111</td><td>95</td><td>5F</td><td>_</td><td></td></tr><tr><td>01100000</td><td>96</td><td>60</td><td>`</td><td></td></tr><tr><td>01100001</td><td>97</td><td>61</td><td>a</td><td></td></tr><tr><td>01100010</td><td>98</td><td>62</td><td>b</td><td></td></tr><tr><td>01100011</td><td>99</td><td>63</td><td>c</td><td></td></tr><tr><td>01100100</td><td>100</td><td>64</td><td>d</td><td></td></tr><tr><td>01100101</td><td>101</td><td>65</td><td>e</td><td></td></tr><tr><td>01100110</td><td>102</td><td>66</td><td>f</td><td></td></tr><tr><td>01100111</td><td>103</td><td>67</td><td>g</td><td></td></tr><tr><td>01101000</td><td>104</td><td>68</td><td>h</td><td></td></tr><tr><td>01101001</td><td>105</td><td>69</td><td>i</td><td></td></tr><tr><td>01101010</td><td>106</td><td>6A</td><td>j</td><td></td></tr><tr><td>01101011</td><td>107</td><td>6B</td><td>k</td><td></td></tr><tr><td>01101100</td><td>108</td><td>6C</td><td>l</td><td></td></tr><tr><td>01101101</td><td>109</td><td>6D</td><td>m</td><td></td></tr><tr><td>01101110</td><td>110</td><td>6E</td><td>n</td><td></td></tr><tr><td>01101111</td><td>111</td><td>6F</td><td>o</td><td></td></tr><tr><td>01110000</td><td>112</td><td>70</td><td>p</td><td></td></tr><tr><td>01110001</td><td>113</td><td>71</td><td>q</td><td></td></tr><tr><td>01110010</td><td>114</td><td>72</td><td>r</td><td></td></tr><tr><td>01110011</td><td>115</td><td>73</td><td>s</td><td></td></tr><tr><td>01110100</td><td>116</td><td>74</td><td>t</td><td></td></tr><tr><td>01110101</td><td>117</td><td>75</td><td>u</td><td></td></tr><tr><td>01110110</td><td>118</td><td>76</td><td>v</td><td></td></tr><tr><td>01110111</td><td>119</td><td>77</td><td>w</td><td></td></tr><tr><td>01111000</td><td>120</td><td>78</td><td>x</td><td></td></tr><tr><td>01111001</td><td>121</td><td>79</td><td>y</td><td></td></tr><tr><td>01111010</td><td>122</td><td>7A</td><td>z</td><td></td></tr><tr><td>01111011</td><td>123</td><td>7B</td><td>{</td><td></td></tr><tr><td>01111100</td><td>124</td><td>7C</td><td>|</td><td></td></tr><tr><td>01111101</td><td>125</td><td>7D</td><td>}</td><td></td></tr><tr><td>01111110</td><td>126</td><td>7E</td><td>~</td><td></td></tr><tr><td>01111111</td><td>127</td><td>7F</td><td>DEL (Delete)</td><td>删除</td></tr></tbody></table><p>后来，计算机引进到其它国家的时候，由于他们使用的不是英语，他们使用的字母在ASCII 码表中没有定义，所以他们采用127 号之后的位来表示这些新的字母，还加入了各种形状，一直编号到 255。</p><p>从 128 到 255 这些字符被称为 ASCII 扩展字符集。至此基本存储单位 Byte(char) 能表示的编号都被用完了。</p><h4 id="中文编码" tabindex="-1"><a class="header-anchor" href="#中文编码" aria-hidden="true">#</a> 中文编码</h4><p>由于英文书写系统都是由26 个基本字母组成，利用26 个字母组可合出不同的单词，所以用ASCII码表就能表达整个英文书写系统。</p><p>而中文书写系统中的汉字是独立的方块，若参考单词拆解成字母的表示方式，汉字可以拆解成部首、笔画来表示，但这样会非常复杂(可参考五笔输入法编码)，所以中文编码直接对方块字进行编码，一个汉字使用一个号码。</p><p>由于汉字非常多，常用字就有 6000 多个，如果像 ASCII 编码表那样只使用 1 个字节最多只能表示 256 个汉字，所以我们使用 2 个字节来编码。</p><h4 id="gb2312-标准" tabindex="-1"><a class="header-anchor" href="#gb2312-标准" aria-hidden="true">#</a> GB2312 标准</h4><p>我们首先定义的是GB2312 标准。它把ASCII 码表127 号之后的扩展字符集直接取消掉，并规定 小于127 的编码按原来ASCII 标准解释字符。</p><p>当2 个大于127 的字符连在一起时，就表示1 个汉字，第1 个字节使用(0xA1-0xFE) 编码，第2 个字节使用(0xA1-0xFE) 编码，这样的编码组合起来可以表示了7000 多个符号，其中包含6763 个汉字。</p><p>在这些编码里，我们还把数学符号、罗马字母、日文假名等都编进表中，就连原来在ASCII 里原本就有的数字、标点以及字母也重新编了2 个字节长的编码，这就是平时在输入法里可切换的“全角”字符，而标准的 ASCII 码表中 127号以下的就被称为“半角”字符。</p><p><img src="/my-vuepress-blog/assets/image-20221123000918610-9e8a3435.png" alt="image-20221123000918610"></p><p>上表说明了GB2312 是如何兼容ASCII 码的</p><ul><li><p>当我们设定系统使用GB2312 标准的时候，它遇到一个字符串时，会按字节检测字符值的大小</p></li><li><p>若遇到连续两个字节的数值都大于127 时就把这两个连续的字节合在一起</p></li><li><p>用GB2312 解码，若遇到的数值小于127，就直接用ASCII 把它解码。</p></li></ul><h4 id="区位码" tabindex="-1"><a class="header-anchor" href="#区位码" aria-hidden="true">#</a> 区位码</h4><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230023413.png" alt="image-20221123001805432"></p><p>在GB2312 编码的实际使用中，有时会用到区位码的概念。</p><p>GB2312编码对所收录字符进行了“分区”处理，共 94 个区，每区含有 94 个位，共 8836 个码位。</p><p>而区位码实际是 GB2312 编码的内部形式，它规定对收录的每个字符采用两个字节表示。</p><ul><li>第一个字节称为“高字节”，对应 94 个区；</li><li>第二个字节称为“低字节”，对应 94 个位。</li></ul><p>所以它的区位码范围是：01-94。为兼容 ASCII 码，区号和位号分别加上 0xA0 偏移就得到 GB2312 编码。</p><p>在区位码上加上0xA0 偏移，可求得GB2312 编码范围：<strong>0xA1(0xA0 + 1区) －0xFE（0xA0 + 5E(94) 区）</strong></p><p>其中汉字的编码范围为0xB0A1-0xF7FE，</p><ul><li><strong>第一字节0xB0-0xF7（对应区号：16 － 87）</strong></li><li><strong>第二个字节0xA1-0xFE（对应位号：01 － 94）</strong>。</li></ul><h4 id="gbk-编码" tabindex="-1"><a class="header-anchor" href="#gbk-编码" aria-hidden="true">#</a> GBK 编码</h4><p>据统计，GB2312 编码中表示的 6763 个汉字已经覆盖中国大陆 99.75% 的使用率，单看这个数字已经很令人满意了，但是我们不能因为那些文字不常用就不让它进入信息时代，而且生僻字在人名、文言文中的出现频率是非常高的。</p><p>为此我们在GB2312 标准的基础上又增加了14240 个新汉字(包括所有后面介绍的Big5 中的所有汉字) 和符号，这个方案被称为GBK 标准。</p><p>增加这么多字符，按照 GB2312 原来的格式来编码，2 个字节已经没有足够的编码，我们聪明的程序员修改了一下格式，不再要求第2 个字节的编码值必须大于127，只要第1 个字节大于127 就表示这是一个汉字的开始，这样就做到了兼容ASCII 和 GB2312 标准。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230046040.png" alt="image-20221123004620899"></p><p>上表 说明了 GBK 是如何兼容 ASCII 和 GB2312 标准的，当我们设定系统使用 GBK 标准的时候，它按顺序遍历字符串，按字节检测字符值的大小，若遇到一个字符的值大于127 时，就再读取它后面的一个字符，把这两个字符值合在一起，用GBK 解码，解码完后，再读取第3 个字符，重新开始以上过程，若该字符值小于127，则直接用ASCII 解码。</p><h4 id="gb18030" tabindex="-1"><a class="header-anchor" href="#gb18030" aria-hidden="true">#</a> GB18030</h4><p>随着计算机技术的普及，我们后来又在GBK 的标准上不断扩展字符，这些标准被称为GB18030，如GB18030-2000、GB18030-2005 等(“-”号后面的数字是制定标准时的年号)。</p><p>GB18030 的编码使用 4 个字节，它利用前面标准中的第 2 个字节未使用的“0x30-0x39”编码表示扩充四字节的后缀，兼容 GBK、GB2312 及 ASCII 标准。</p><p>GB18030-2000 主要在GBK 基础上增加了“CJK(中日韩) 统一汉字扩充A”的汉字。</p><p>加上前面GBK的内容，GB18030-2000 一共规定了 27533 个汉字（包括部首、部件等）的编码，还有一些常用非汉字符号。</p><p>GB18030-2005 的主要特点是在GB18030-2000 基础上增加了“CJK(中日韩) 统一汉字扩充B”的汉字。增加了42711 个汉字和多种我国少数民族文字的编码（如藏、蒙古、傣、彝、朝鲜、维吾尔文等）。加上前面 GB18030-2000 的内容，一共收录了 70244 个汉字。</p><p>GB2312、GBK 及GB18030 是汉字的国家标准编码，新版向下兼容旧版，目前比较流行的是GBK 编码，因为每个汉字只占用2 个字节，而且它编码的字符已经能满足大部分的需求，但国家要求一些产品必须支持GB18030 标准。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230058147.png" alt="image-20221123005817753"></p><h4 id="big5-编码" tabindex="-1"><a class="header-anchor" href="#big5-编码" aria-hidden="true">#</a> Big5 编码</h4><p>在台湾、香港等地区，使用较多的是Big5 编码，它的主要特点是收录了繁体字。而从GBK 编码开始，已经把Big5 中的所有汉字收录进编码了。即对于汉字部分，GBK 是Big5 的超集，Big5 能表示的汉字，在GBK 都能找到那些字相应的编码，但他们的编码是不一样的，两个标准不兼容，如 GBK 中的“啊”字编码是“0xB0A1”，而Big5 标准中的编码为“0xB0DA”。</p><h4 id="unicode-字符集和编码" tabindex="-1"><a class="header-anchor" href="#unicode-字符集和编码" aria-hidden="true">#</a> Unicode 字符集和编码</h4><p>由于各个国家或地区都根据使用自己的文字系统制定标准，同一个编码在不同的标准里表示不一样的字符，各个标准互不兼容，而又没有一个标准能够囊括所有的字符，即无法用一个标准表达所有字符。</p><p>国际标准化组织(ISO) 为解决这一问题，它舍弃了地区性的方案，重新给全球上所有文化使用的字母和符号进行编号，对每个字符指定一个唯一的编号 (ASCII 中原有的字符编号不变)。</p><p>这些字符的号码从0x000000 到0x10FFFF，该编号集被称为Universal Multiple-Octet CodedCharacterSet，简称UCS，也被称为Unicode。</p><p>最新版的Unicode 标准还包含了表情符号(聊天软件中的部分emoji 表情)，可访问 Unicode 官网了解：http://www.unicode.org。</p><p>Unicode 字符集只是对字符进行编号，但具体怎么对每个字符进行编码，Unicode 并没指定，因此也衍生出了如下几种unicode 编码方案 (Unicode Transformation Format)。</p><h5 id="utf-32" tabindex="-1"><a class="header-anchor" href="#utf-32" aria-hidden="true">#</a> UTF-32</h5><p>对 Unicode 字符集编码，最自然的就是 UTF-32 方式了。编码时，它直接对 Unicode 字符集里的每个字符都用4 字节来表示，转换方式很简单，直接将字符对应的编号数字转换为4 字节的二进制数。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230106315.png" alt="image-20221123010644161"></p><p>由于UTF-32 把每个字符都用要4 字节来存储，因此UTF-32 不兼容ASCII 编码，也就是说ASCII 编码的文件用UTF-32 标准来打开会成为乱码。</p><ul><li><p>UTF-32 的优点是编码简单，解码也很方便，读取编码的时候每次都直接读 4 个字节，不需要加其它的判断。</p></li><li><p>它的缺点是浪费存储空间，大量常用字符的编号只需要 2 个字节就能表示。</p><ul><li>其次，在存储的时候需要指定字节顺序，是高位字节存储在前 (大端格式)，还是低位字节存储在前 (小端格式)。</li></ul></li></ul><h5 id="utf-16" tabindex="-1"><a class="header-anchor" href="#utf-16" aria-hidden="true">#</a> UTF-16</h5><p>针对 UTF-32 的缺点，人们改进出了 UTF-16 的编码方式，如表格 UTF-16 编码示例 它采用 2 字节或 4 字节的变长编码方式 (UTF-32 定长为 4 字节)。</p><p>对 Unicode 字符编号在 0 到 65535 的统一用 2 个字节来表示，将每个字符的编号转换为2 字节的二进制数，即从0x0000 到0xFFFF。</p><p>而由于Unicode 字符集在0xD800-0xDBFF 这个区间是没有表示任何字符的，所以UTF-16 就利用这段空间，对 Unicode 中编号超出 0xFFFF 的字符，利用它们的编号做某种运算与该空间建立映射关系，从而利用该空间表示4 字节扩展，感兴趣的读者可查阅相关资料了解具体的映射过程。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230132269.png" alt="image-20221123013249124"></p><p>UTF-16 解码时，按两个字节去读取，如果这两个字节不在 0xD800 到 0xDFFF 范围内，那就是双字节编码的字符，以双字节进行解析，找到对应编号的字符。</p><p>如果这两个字节在 0xD800 到0xDFFF 之间，那它就是四字节编码的字符，以四字节进行解析，找到对应编号的字符。</p><p>UTF-16 编码的优点是相对 UTF-32 节约了存储空间，缺点是仍不兼容 ASCII 码，仍有大小端格式问题。</p><h5 id="utf-8" tabindex="-1"><a class="header-anchor" href="#utf-8" aria-hidden="true">#</a> UTF-8</h5><p>UTF-8 是目前 Unicode 字符集中使用得最广的编码方式，目前大部分网页文件已使用 UTF-8 编码，如使用浏览器查看百度首页源文件，可以在前几行HTML 代码中找到如下代码：</p><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Content-Type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/html;charset=utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中“charset”等号后面的“utf-8”即表示该网页字符的编码方式UTF-8。</p><p>UTF-8 也是一种变长的编码方式，它的编码有1、2、3、4 字节长度的方式，每个Unicode 字符根据自己的编号范围去进行对应的编码，它的编码符合以下规律：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230146486.png" alt="image-20221123014647352"></p><ul><li><p>对于 UTF-8 单字节的编码，该字节的第 1 位设为 0(从左边数起第 1 位，即最高位)，剩余的位用来写入字符的Unicode 编号。</p><ul><li>即对于Unicode 编号从0x0000 0000 - 0x0000 007F（127） 的字符，UTF-8 编码只需要 1 个字节，因为这个范围 Unicode 编号的字符与 ASCII 码完全相同，所以UTF-8 兼容了ASCII 码表。</li></ul></li><li><p>对于 UTF-8 使用 N 个字节的编码 (N&gt;1)，第一个字节的前 N 位设为 1，第 N+1 位设为 0，后面字节的前两位都设为10，这N 个字节的其余空位填充该字符的Unicode 编号，高位用0 补足。</p></li></ul><blockquote><p>注：</p><ul><li><p>实际上 utf-8 编码长度最大为四个字节，所以最多只能表示 Unicode 编码值的二进制数为 21位的Unicode 字符。</p></li><li><p>但是已经能表示所有的Unicode 字符，因为 Unicode 的最大码位0x10FFFF 也只有21位。</p></li><li><p>UTF-8 解码的时候以字节为单位去看，如果第一个字节的bit 位以0 开头，那就是ASCII 字符，以单字节进行解析。</p><ul><li>如果第一个字节的数据位以“110”开头，就按双字节进行解析。</li><li>3、4 字节的解析方法类似。</li></ul></li></ul></blockquote><p>UTF-8 的优点是兼容了ASCII 码，节约空间，且没有字节顺序的问题，它直接根据第1 个字节前面数据位中连续的 1 个数决定后面有多少个字节。不过使用 UTF-8 编码汉字平均需要 3 个字节，比 GBK 编码要多一个字节。</p><h4 id="bom" tabindex="-1"><a class="header-anchor" href="#bom" aria-hidden="true">#</a> BOM</h4><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211230155538.png" alt="image-20221123015500255"></p><p>由于UTF 系列有多种编码方式，而且对于UTF-16 和UTF-32 还有大小端的区分，那么计算机软件在打开文档的时候到底应该用什么编码方式去解码呢？</p><ul><li>有的人就想到在文档最前面加标记，一种标记对应一种编码方式，这些标记就叫做 BOM(Byte Order Mark)，它们位于文本文件的开头。</li></ul><blockquote><p>注意：BOM 是对Unicode 的几种编码而言的，ANSI 编码没有BOM。</p><ul><li>但由于带 BOM 的设计很多规范不兼容，不能跨平台，所以这种带 BOM 的设计没有流行起来。</li><li>Linux 系统下默认不带BOM。</li></ul></blockquote><h3 id="字模" tabindex="-1"><a class="header-anchor" href="#字模" aria-hidden="true">#</a> 字模</h3><p>有了编码，我们就能在计算机中处理、存储字符了，但是如果计算机处理完字符后直接以编码的形式输出，人类将难以识别。来，在2 秒内告诉我ASCII 编码的“0x25”表示什么字符？不容易吧？要是觉得容易，再来告诉我GBK 编码的“0xBCC6”表示什么字符。</p><p>因此计算机与人交互时，一般会把字符转化成人类习惯的表现形式进行输出，如显示、打印的时候。</p><p><strong>但是如果仅有字符编码，计算机还不知道该如何表达该字符，因为字符实际上是一个个独特的图形，计算机必须把字符编码转化成对应的字符图形人类才能正常识别，因此我们要给计算机提供字符的图形数据，这些数据就是字模，多个字模数据组成的文件也被称为字库。</strong></p><p>计算机显示字符时，根据字符编码与字模数据的映射关系找到它相应的字模数据，液晶屏根据字模数据显示该字符。</p><h4 id="字模的构成" tabindex="-1"><a class="header-anchor" href="#字模的构成" aria-hidden="true">#</a> 字模的构成</h4><p>已知字模是图形数据，而图形在计算机中是由一个个像素点组成的，所以字模实质是一个个像素点数据。为方便处理，我们把字模定义成方块形的像素点阵，且每个像素点只有0 和1 这两种状态(可以理解为单色图像数据)。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211231415924.png" alt="image-20221123141510620" style="zoom:50%;"><p>见图字模，这是两个宽、高为16x16 的像素点阵组成的两个汉字图形，其中的黑色像素点即为文字的笔迹。计算机要表示这样的图形，只需使用16x16 个二进制数据位，每个数据位记录一个像素点的状态，把黑色像素点以“1”表示，无色像素点以“0”表示即可。</p><p>这样的一个汉字图形，使用16x16/8=32 个字节来就可以记录下来。</p><p>16x16 的“字”的字模数据以 C 语言数组的方式表示，在这样的字模中，以两个字节表示一行像素点，16 行构成一个字模。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">/* 字 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> code Bmp003<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span> 
<span class="token punctuation">{</span>
<span class="token comment">/*------------------------------------------------------------ 
;         源文件 / 文字 : 字
;         宽 × 高（像素）: 16×16
;         字模格式/大小 : 单色点阵液晶字模，横向取模，字节正序/32 字节 
----------------------------------------------------------*/</span>
<span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x3F</span><span class="token punctuation">,</span><span class="token number">0xFC</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x1F</span><span class="token punctuation">,</span><span class="token number">0xE0</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span>
<span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x7F</span><span class="token punctuation">,</span><span class="token number">0xFE</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="字模显示原理" tabindex="-1"><a class="header-anchor" href="#字模显示原理" aria-hidden="true">#</a> 字模显示原理</h4><p>如果使用LCD 的画点函数，按位来扫描这些字模数据，把为1 的位以黑色来显示(也可以使用其它颜色)，为 0 的数据位以白色来显示，即可把整个点阵还原出来，显示在液晶屏上。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

using namespace std<span class="token punctuation">;</span>
<span class="token comment">/*&quot;    当&quot;    字符的字模 16x16    */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> charater_matrix<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">/*&quot;    当&quot;,0*/</span>
        <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span>
        <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
        <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
        <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0xF8</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> temp<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        temp <span class="token operator">=</span> <span class="token punctuation">(</span>charater_matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> charater_matrix<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">-</span> j<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; * &quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;   &quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
                         *                      
          *              *           *          
             *           *           *          
                *        *        *             
                *        *     *                
                         *                      
       *  *  *  *  *  *  *  *  *  *  *          
                                     *          
                                     *          
                                     *          
          *  *  *  *  *  *  *  *  *  *          
                                     *          
                                     *          
                                     *          
       *  *  *  *  *  *  *  *  *  *  *          
                                     *          
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="如何制作字模" tabindex="-1"><a class="header-anchor" href="#如何制作字模" aria-hidden="true">#</a> 如何制作字模</h4><p>以上只是某几个字符的字模，为方便使用，我们需要制作所有常用字符的字模。</p><ul><li>如程序只需要英文显示，那就需要制作包含 ASCII 中的字符和数字中所有字符的字模</li><li>如程序只需要使用一些常用汉字，我们可以选择制作GB2312 编码里所有字符的字模，而且希望字模数据与字符编码有固定的映射关系，以便在程序中使用字符编码作为索引，查找字模。</li></ul><p>在网上搜索可找到一些制作字模的软件工具 “PCtoLCD”，可满足这些需求。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211231909119.png" alt="image-20221123190929978" style="zoom:50%;"><p>(1) 配置字模格式</p><p>打开取模软件，点击“选项”菜单，会弹出一个对话框，见图配置字模格式。</p><ul><li>选项“点阵格式”中的阴、阳码是指字模点阵中有笔迹像素位的状态是“1”还是“0”，像我们前文介绍的那种就是阴码，反过来就是阳码。本工程中使用阴码。</li><li>选项“取模方式”是指字模图形的扫描方向，修改这部分的设置后，选项框的右侧会有相应的说明及动画显示，这里我们依然按前文介绍的字模类型，把它配置成“逐行式”.</li><li>选项“每行显示的数据”里我们把点阵和索引都配置成 16，设置这个点阵的像素大小为16x16。</li></ul><p>字模选项的格式保持不变，设置完我们点击确定即可，字模选项的这些配置会影响到显示代码的编写方式。</p><p>(2) 生成 GB2312 字模</p><p>配置完字模选项后，点击软件中的导入文本图标，会弹出一个“生成字库”的对话框，点击右下角的生成国标汉字库按钮即可生成包含了GB2312 编码里所有字符的字模文件。在《液晶显示中英文》的工程目录下的《GB2312_H3232.FON》是我用这个取模软件生成的字模原文件，若不想自己制作字模，可直接使用该文件。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202301251746311.png" alt="image-20230125174607855"></p><h4 id="字模寻址公式" tabindex="-1"><a class="header-anchor" href="#字模寻址公式" aria-hidden="true">#</a> 字模寻址公式</h4><p>使用字模软件制作的字模数据一般会按照编码格式排列。如我们利用以上软件生成的字模文件 《GB2312_H3232.FON》中的数据，是根据GB2312 的区位码表的顺序存储的，它存储了区位码为 0101-9494 的字符，每个字模的大小为 32x32/8=128 字节。其中第一个字符“空格”的区位码为 0101，它是首个字符，所以文件的前 128 字节存储的是它的字模数据；同理，128-256 字节存储 的则是0102 字符“、”的字模数据。所以我们可以导出任意字符的寻址公式:</p><p><code>Addr = (((CodeH-0xA0-1)*94) +(CodeL-0xA0-1))*32*32/8</code></p><p>其中CodeH 和CodeL 分别是GB2312 编码的第一字节和第二字节；94 是指一个区中有94 个位(即 94 个字符)。公式的实质是根据字符的 GB2312 编码，求出区位码，然后区位码乘以每个字符占据的字节数，求出地址偏移。</p><h4 id="存储字模文件" tabindex="-1"><a class="header-anchor" href="#存储字模文件" aria-hidden="true">#</a> 存储字模文件</h4><p>上面生成的《GB2312_H3232.FON》文件的大小为1023KB，比很多STM32 芯片内部的所有FLASH 空间都大，如果我们还是在程序中直接以C 语言数组的方式存储字模数据，STM32 芯片的程序空间会非常紧张，一般的做法是把字模数据存储到外部存储器，如SD 卡或SPI-FLASH 芯片，当需要显示某个字符时，控制器根据字符的编码算好字模的存储地址，再从存储器中读取，而FLASH 芯片在生产前就固化好字模内容，然后直接把 FLASH 芯片贴到电路板上，作为整个系统的一部分。</p><h3 id="各种模式的液晶显示字符实验" tabindex="-1"><a class="header-anchor" href="#各种模式的液晶显示字符实验" aria-hidden="true">#</a> 各种模式的液晶显示字符实验</h3><h4 id="硬件设计-8" tabindex="-1"><a class="header-anchor" href="#硬件设计-8" aria-hidden="true">#</a> 硬件设计</h4><p>针对不同模式的液晶显示字符工程，需要有不同的硬件支持。</p><p>字库存储在STM32 芯片内部FLASH 的工程跟普通液晶显示的硬件需求无异。需要外部字库的工程，要有额外的 SPI-FLASH、SD 支 持，使用外部FLASH 时，我们的实验板上直接用板子上的SPI-FLASH 芯片存储字库</p><p>请确保该系统包含有存储了字库的 FLASH 芯片，才能正常显示汉字。使用SD 卡时，需要给板子接入存储有《GB2312_H3232.FON》字库文件的MicroSD 卡，SD 卡的文件系统格式需要是FAT 格式，且字库文件所在的目录需要跟程序里使用的文件目录一致。</p><p>关于SPI-FLASH 和SD 卡的原理图及驱动说明可参考其他的章节。给外部SPI-FLASH 和SD 卡存 储字库的操作我们将在另一个文档中说明，本章的默认您已配置好SPI-FLASH 和SD 卡相关的字库环境。</p><h4 id="显示-ascii-编码的字符" tabindex="-1"><a class="header-anchor" href="#显示-ascii-编码的字符" aria-hidden="true">#</a> 显示 ASCII 编码的字符</h4><p>我们先来看如何显示ASCII 码表中的字符，请打开“液晶显示”（即上一章的例程）的工程文件。 本工程中我们把字库数据相关的函数代码写在“fonts.c”及“fonts.h”文件中，字符显示的函数仍 存储在LCD 驱动文件“bsp_ILI9481_lcd.c”及“bsp_ILI9481_lcd.h”中。</p><h5 id="编程要点-8" tabindex="-1"><a class="header-anchor" href="#编程要点-8" aria-hidden="true">#</a> 编程要点</h5><ul><li>获取字模数据；</li><li>根据字模格式，编写液晶显示函数；</li><li>编写测试程序，控制液晶英文。</li></ul><h5 id="代码实现-4" tabindex="-1"><a class="header-anchor" href="#代码实现-4" aria-hidden="true">#</a> 代码实现</h5><p><code>fonts.h</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//</span>
<span class="token comment">// Created by 刘玉培 on 1/25/23.</span>
<span class="token comment">//</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">HELLO_FONTS_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HELLO_FONTS_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stm32f4xx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;bsp_ILI9481_lcd.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;string.h&quot;</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII8x16_Table<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII16x32_Table<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII24x48_Table<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_tFont</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>table<span class="token punctuation">;</span> <span class="token comment">/* 字模 */</span>
    <span class="token class-name">uint8_t</span> width<span class="token punctuation">;</span>        <span class="token comment">/* 字模宽 */</span>
    <span class="token class-name">uint8_t</span> height<span class="token punctuation">;</span>       <span class="token comment">/* 字模高 */</span>
<span class="token punctuation">}</span> sFont<span class="token punctuation">;</span>

<span class="token keyword">static</span> sFont Font8x16 <span class="token operator">=</span> <span class="token punctuation">{</span>
        ASCII8x16_Table<span class="token punctuation">,</span>
        <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token number">16</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> sFont Font16x32 <span class="token operator">=</span> <span class="token punctuation">{</span>
        ASCII16x32_Table<span class="token punctuation">,</span>
        <span class="token number">16</span><span class="token punctuation">,</span>
        <span class="token number">32</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> sFont Font24x48 <span class="token operator">=</span> <span class="token punctuation">{</span>
        ASCII24x48_Table<span class="token punctuation">,</span>
        <span class="token number">24</span><span class="token punctuation">,</span>
        <span class="token number">48</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> sFont <span class="token operator">*</span>CurrentFont <span class="token operator">=</span> <span class="token operator">&amp;</span>Font16x32<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token class-name">uint16_t</span> CurrentColor <span class="token operator">=</span> WHITE<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SET_COLOR</span><span class="token expression"><span class="token punctuation">(</span>color<span class="token punctuation">)</span> <span class="token punctuation">(</span>CurrentColor<span class="token operator">=</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">setFont</span><span class="token punctuation">(</span>sFont <span class="token operator">*</span>font<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">display_en</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">lcd_display_en_string_line</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> line<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">ILI9481_Clear_Line</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">lcd_display_string_en_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">//HELLO_FONTS_H</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fonts.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;fonts.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;fonts.h&quot;</span></span>

<span class="token comment">/**************** 字体，阴码点阵格式，逐行顺向取摸 ***************/</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII8x16_Table<span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII16x32_Table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> ASCII24x48_Table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">setFont</span><span class="token punctuation">(</span>sFont <span class="token operator">*</span>font<span class="token punctuation">)</span><span class="token punctuation">{</span>
    CurrentFont <span class="token operator">=</span> font<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * LCD 显示一个字符
 * @param x 横坐标
 * @param y 纵坐标
 * @param ch 要显示的字符
 */</span>
<span class="token keyword">void</span> <span class="token function">lcd_display_en</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> ch<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//对 ascii 码表偏移，字模表不包含 ASCII 表的前 32 个非图形符号</span>
    <span class="token class-name">uint8_t</span> relativePosition <span class="token operator">=</span> ch <span class="token operator">-</span> <span class="token char">&#39; &#39;</span><span class="token punctuation">;</span>
    <span class="token comment">//每个字模的字节数</span>
    <span class="token class-name">uint8_t</span> font_length <span class="token operator">=</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>width <span class="token operator">*</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token comment">//偏移指针</span>
    <span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span> pFont <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>table<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>relativePosition <span class="token operator">*</span> font_length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//设置显示窗口，由于设置了显示窗口，显示数据会自动换行</span>
    <span class="token function">ILI9481_OpenWindow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> CurrentFont<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送写命令</span>
    <span class="token function">ILI9481_Write_Cmd</span><span class="token punctuation">(</span>CMD_SetPixel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 字体，阴码点阵格式，逐行顺向取摸</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> byteCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> byteCount <span class="token operator">&lt;</span> font_length<span class="token punctuation">;</span> byteCount<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> bitCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> bitCount <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> bitCount<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pFont<span class="token punctuation">[</span>byteCount<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">&gt;&gt;</span> bitCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ILI9481_Write_Data</span><span class="token punctuation">(</span>CurrentColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">ILI9481_Write_Data</span><span class="token punctuation">(</span>BLACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 显示字符串
 * @param x 横坐标
 * @param y 纵坐标
 * @param str 要显示的字符串
 */</span>
<span class="token keyword">void</span> <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> y<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//循环显示字符，读取到 &#39;\0&#39; 时结束</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">!=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//处理换行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">&#39;\n&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
            str<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果横坐标到达边界，换行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> CurrentFont<span class="token operator">-&gt;</span>width<span class="token punctuation">)</span> <span class="token operator">&gt;</span> LCD_X_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//显示字符</span>
        <span class="token function">lcd_display_en</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//横坐标移动</span>
        x <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 在指定行显示字符串
 * @param line
 * @param str
 */</span>
<span class="token keyword">void</span> <span class="token function">lcd_display_en_string_line</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> line<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> y <span class="token operator">=</span> line <span class="token operator">*</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">!=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//处理换行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> <span class="token char">&#39;\n&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
            str<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果横坐标到达边界，换行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> CurrentFont<span class="token operator">-&gt;</span>width<span class="token punctuation">)</span> <span class="token operator">&gt;</span> LCD_X_LENGTH<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            y <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//显示字符</span>
        <span class="token function">lcd_display_en</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//横坐标移动</span>
        x <span class="token operator">+=</span> CurrentFont<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 清除某一行的字符
 * @param line
 */</span>
<span class="token keyword">void</span> <span class="token function">ILI9481_Clear_Line</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> line<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">ILI9481_Clear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> line <span class="token operator">*</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> LCD_X_LENGTH<span class="token punctuation">,</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">lcd_display_string_en_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">lcd_display_en_string_line</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello!\nHow are you?\nWhat are doing?\nFuck your mather!\nI Love you! JiangTao!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ILI9481_Clear_Line</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lcd_display_en_string_line</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;\n\n\nFuck your mather!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_X_LENGTH <span class="token operator">-</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>width <span class="token operator">*</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">300</span> <span class="token operator">+</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>height <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_X_LENGTH <span class="token operator">-</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>width <span class="token operator">*</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">300</span> <span class="token operator">+</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>height <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_X_LENGTH <span class="token operator">-</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>width <span class="token operator">*</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">300</span> <span class="token operator">+</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>height <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用 sprintf 将变量转为字符串</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> <span class="token string">&quot;Times: %lu&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">lcd_display_en_string</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LCD_X_LENGTH <span class="token operator">-</span> <span class="token punctuation">(</span>CurrentFont<span class="token operator">-&gt;</span>width <span class="token operator">*</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Delay_ms</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ILI9481_Clear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> LCD_X_LENGTH<span class="token punctuation">,</span> CurrentFont<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main.c</code></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token function">SysTick_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//初始化 LED</span>
    <span class="token function">LED_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//配置 USART</span>
    <span class="token function">DEBUG_USART_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">ILI9481_GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ILI9481_FSMC_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ILI9481_REG_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ILI9481_Clear</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> LCD_X_LENGTH<span class="token punctuation">,</span> LCD_Y_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lcd_display_string_en_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="显示-gb2312-编码的字符" tabindex="-1"><a class="header-anchor" href="#显示-gb2312-编码的字符" aria-hidden="true">#</a> 显示 GB2312 编码的字符</h4><p>显示 ASCII 编码比较简单，由于字库文件小，甚至都不需要使用外部的存储器，而显示汉字时， 由于我们的字库是存储到外部存储器上的，这涉及到额外的获取字模数据的操作。</p><h2 id="启动文件" tabindex="-1"><a class="header-anchor" href="#启动文件" aria-hidden="true">#</a> 启动文件</h2><p>启动文件在官方固件包路径下：<code>STM32F4xx固件库/STM32F4xx_DSP_StdPeriph_Lib_V1.4.0/Libraries/CMSIS/Device/ST/STM32F4xx/Source/Templates/arm</code></p><p>上面提到的<code>SystemInit</code>用于初始化系统时钟的函数定义在：<code>/STM32F4xx固件库/STM32F4xx_DSP_StdPeriph_Lib_V1.4.0/Libraries/CMSIS/Device/ST/STM32F4xx/Source/Templates/system_stm32f4xx.c</code></p><p>启动文件由汇编编写，是系统上电复位后第一个执行的程序，主要做了以下工作：</p><ul><li><p>初始化堆栈指针 SP = initial_sp</p></li><li><p>初始化PC指针 = Reset-Handler</p></li><li><p>初始化中断向量表</p></li><li><p>配置系统时钟</p></li><li><p>调用C库函数_main初始化用户堆栈，从而最终调用main函数去到C语言的世界</p></li><li><p><code>stm32f4xx.h</code></p><ul><li>外设所有的寄存器描述</li></ul></li><li><p><code>core_cm4.h</code></p><ul><li>内核的所有外设寄存器描述</li></ul></li><li><p><code>misc.c</code></p><ul><li>内核的全部外设驱动函数</li></ul></li><li><p><code>gpio.c</code>、<code>i2c.c</code>、...</p><ul><li>外设</li></ul></li></ul><h3 id="systeminit-函数去哪了" tabindex="-1"><a class="header-anchor" href="#systeminit-函数去哪了" aria-hidden="true">#</a> SystemInit 函数去哪了?</h3><p>在前几章我们自己建工程的时候需要定义一个 SystemInit 空函数，但是在这个用 STM32 标准库 的工程却没有这样做，SystemInit 函数去哪了呢?</p><p>这个函数在 STM32 标准库的“system_stm32f4xx.c”文件中定义了，而我们的工程已经包含该文 件。标准库中的 SystemInit 函数把 STM32 芯片的系统时钟设置成了 168MHz，即此时 AHB1 时钟 频率为 168MHz，APB2 为 84MHz，APB1 为 42MHz。当 STM32 芯片上电后，执行启动文件中的 指令后，会调用该函数，设置系统时钟为以上状态。</p><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h2><h3 id="systick-系统定时器-时间不正确" tabindex="-1"><a class="header-anchor" href="#systick-系统定时器-时间不正确" aria-hidden="true">#</a> SysTick 系统定时器 时间不正确</h3><p>我使用的开发板是正点原子的stm32f407探索者开发板 ，看的教程是野火的，使用SysTick实现延时函数，预期1s延时，结果却等了3、4s</p><p><strong>解决方案</strong></p><p>每一款单片机都有自己的时钟源，存在外部高速时钟（HSE）和外部低速时钟(LSE)，而单片机中的系统时钟最大值为168Mhz，一般都是由外部高速时钟提供，然后经过内部锁相环吧频率升上去。 外部高速晶振如图，正点原子探索者为8M，而野火的霸天虎为25Mhz，两款时钟源不同，因此直接复制的话，会使得，内部时钟混乱。因此出现串口乱码的情况，因此改串口或者该系统时钟源都可以。 在这里我用的是配置系统时钟源，是其最后都达到168Mhz</p><p><strong>解决方法：</strong></p><ul><li>在system_stm32f4xx.c文件中 PLL_M 分频因子 改为8</li><li>在stm32f4xx.h文件中的 HSE_VALUE,确保HSE_VALUE的值与板子上的晶振保持一致。如晶振是25MHz，HSE_VALUE=25000000；晶振是8MHz，HSE_VALUE=8000000。</li></ul><h2 id="名词解释" tabindex="-1"><a class="header-anchor" href="#名词解释" aria-hidden="true">#</a> 名词解释</h2><p>输入：数字信号流入单片机引脚；</p><p>输出：数字信号从单片机引脚流出；</p><p>复用：有些引脚在被设计成特殊功能后，硬件会控制它，不需要用户在程序中操作；</p><p>模拟：模拟信号流入单片机引脚；</p><p>上拉：引脚通过一个电阻连接到VDD；</p><p>下拉：引脚通过一个电阻连接到GND；</p><p>浮空：引脚啥也不接；</p><p>推挽模式：可理解为普通，输出0或者输出1；</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209121330024.png" alt="image-20220912133006854" style="zoom:25%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209121332766.png" alt="image-20220912133225725" style="zoom:33%;"><p>开漏模式：漏极开路（理解它，需要一点模电知识，场效应管相关知识）；只能输出低电平，如果想要输出高电平，必须在IO口上外加一个上拉电阻，由外部电源来提供</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209121331744.png" alt="image-20220912133141711" style="zoom:25%;"><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209121333631.png" alt="image-20220912133311581" style="zoom:33%;"><p>引脚复位：置0</p><p>引脚置位：置1</p><p><strong>以上的说法感觉不是很通俗易懂</strong></p><p>上面是原理图是基于 MOS 管来讲解的，经过查询 ，<strong>MOS管 和 三极管 的主要区别在于 MOS管是用来控制电压的，而三极管是用来控制电流的</strong>，它们的控制方法应该是一样的。</p><p><strong>单极型晶体管和双极型晶体管</strong></p><p><strong>单极型晶体管</strong></p><ul><li>在目前使用的pnp或npn面结型晶体管的工作中，包括金属-氧化物-半导体晶体管在内的场效应晶体管（Metal Oxid Semiconductor Field Effect Transistor，FET），只需要一种载流子，这种晶体管就叫做单极晶体管。单极晶体管即场效应晶体管，因为场效应晶体管在工作时，半导体中只有多数载流子起主要作用，所以又称为单极晶体管。</li></ul><p><strong>双极型晶体管</strong></p><ul><li><strong>晶体管全称双极型三极管</strong>(Bipolar junction transistor，BJT)又称晶体三极管，<strong>简称三极管</strong>，是一种固体半导体器件，可用于检波、整流、放大、开关、稳压、信号调制等。</li></ul><p>BJT ：Bipolar Junction Transistor 双极性晶体管，BJT是电流控制器件；</p><p>FET ：Field Effect Transistor 场效应晶体管，FET是电压控制器件。</p><p><strong>三极管和MOS管</strong></p><blockquote><p>MOS管，即MOSFET:Metal Oxid Semiconductor Field Effect Transistor--金属氧化物半导体场效应晶体管，属绝缘栅型场效应管。因仅有多数载流子参与导电，亦被称作单极型晶体管。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280157332.png" alt="20201116144922236" style="zoom:50%;"><ul><li><p>D （Drain）：漏极</p></li><li><p>G （Gate）：栅极</p></li><li><p>S （Source）：源极</p></li></ul><p><strong>导通条件</strong></p><ul><li><p>NMOS：VG &gt; VS ，电流方向：D ---&gt; S</p></li><li><p>PMOS：VG &lt; VS ，电流方向：S ---&gt; D</p></li></ul></blockquote><blockquote><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280152309.webp" alt="NPNvsPNP-Copy-2" style="zoom:33%;"><ul><li><p>C（Collector） ：集电极</p></li><li><p>B（Base） ：基极</p></li><li><p>E（Emitter）：发射极</p></li></ul><p><strong>导通条件</strong></p><ul><li><p>NPN：VB &gt; VE ，电流方向：C ---&gt; E</p></li><li><p>PNP：VB &lt; VE ，电流方向：E ---&gt; C</p></li></ul></blockquote><p>场效应管的三个极被称为 S（源极）、G（栅极）、D（漏极），分别对应三极管的 E（发射极）、B（基极）、C（集电极），两者作用相似。</p><p>推挽结构：使用两个三极管或 MOSFET（MOS管），以推挽方式存在于电路中。电路工作时，两只对称的开关管每次只有一个导通，所以导通损耗小、效率高。既可以向负载灌电流，也可以从负载抽取电流。推拉式输出级既提高电路的负载能力，又提高开关速度。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280130524.png" alt="image-20221028013015312" style="zoom:50%;"><p>图中上面是 NPN 型三极管，下面是 PNP 型三极管。分别有以下两种情况：</p><ul><li><p>输出高电平：向负载灌电流</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280131349.png" alt="image-20221028013102227" style="zoom:50%;"></li><li><p>输出低电平：从负载拉电流</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280131386.png" alt="image-20221028013135182" style="zoom:50%;"></li></ul><p><strong>开漏结构（OD）：对比推挽结构，开漏结构只有一个三极管或者MOS管。</strong></p><ul><li>之所以叫开漏，是因为 MOS 管分为三极：源极、栅极、漏极。漏极开路输出，所以叫开漏；</li><li>如果是三极管：基极、集电极、发射极，集电极开路，所以叫开集输出（OC）。</li></ul><p>开集输出，NPN 三极管：</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280246239.png" alt="image-20221028024631125" style="zoom:50%;"><ul><li>Vin 高电平，三极管导通，对外输出低电平，外部被直接拉到低。</li></ul><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280247577.png" alt="image-20221028024735274" style="zoom:50%;"><ul><li>Vin 低电平，集电极（C）开路，输出电平状态由外部决定（如果上拉了电阻，输出为高电平）。</li></ul><p><strong>仔细看可以看出，以上和前面 STM32 教程的原理图不太一样</strong></p><p>比如推挽输出，STM32 的输入接了个非门，而以上三极管没有，而是 NPN（NMOS）和 PNP（PMOS）是反着接的。所以它们的输入输出结果一样 输入0 输出 0，输入 1 输出1</p><p>而 开漏输出，用的都是 PNP（PMOS），输入前没有接非门，顺序也没有变，所以 输入 1 时 输出 0，输入 0 时 可以输出1。</p><p><strong>以上分析均采用三极管，MOS 管类似。</strong></p><p>因此，推挽结构可以输出高低电平。<strong>开漏输出只能输出低电平，高电平由外部电路决定</strong>。</p><p><strong>线与功能</strong></p><p>线与：所有 GPIO 输出高就是高，只要有一个输出低，整条线上面的都是低，这就是“与”的意思。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280311242.webp" alt="09005520_62c86178a59b739847"></p><p>左边和右边分别是一个GPIO，两个GPIO的上部是 NMOS 下部是 PMOS，NMOS导通时输出 高电平，PMOS 导通时输出 低电平</p><ul><li>推挽结构下，两个 GPIO 口连接到一根线上，假如左边的 PMOS 导通（输出低电平），右边的 NMOS 导通（输出高电平），Vdd 就会通过两个 MOS 管直接接地，由于 MOS 管导通电阻不大，会导致电流很大，直接损坏这两个 GPIO口，因此，推挽输出不支持线与。</li></ul><p>开漏结构：假如很多 GPIO 是开漏结构，接到了一根线，如下图。开漏结构输出的高电平靠外部上拉，假如有一个 GPIO 接地，那么电流会通过上拉电阻流进地，因为有上拉电阻的存在，所以电流不大，不会损坏 GPIO 口。</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210280318508.webp" alt="09005521_62c861790c6a653117"></p><p><strong>线与，是 I2C 协议的基础！</strong></p><p><strong>线与：当总线上只要有一个设备输出低电平，整条总线便处于低电平状态，这时候总线被称为占用状态。</strong></p><p><strong>TTL施密特触发器：比如：输入超过1.8v输出1，不超过输出0。输入模拟信号，输出的是数字信号</strong></p><h2 id="what-is-the" tabindex="-1"><a class="header-anchor" href="#what-is-the" aria-hidden="true">#</a> What is the？</h2><h3 id="什么是数字信号-什么是模拟信号" tabindex="-1"><a class="header-anchor" href="#什么是数字信号-什么是模拟信号" aria-hidden="true">#</a> 什么是数字信号？什么是模拟信号？</h3><p><strong>数字信号</strong>：数字信号是数字化的，在计算机系统中，CPU只认识“0”和“1”两个数字，所以数字信号需要由“0”和“1”构成的二制数来表示。</p><p><strong>模拟信号</strong>：而摸拟信号则是连续变化的物理量，它的频率、幅度、相位都可以随着时间连续的变化。</p><h4 id="数字信号" tabindex="-1"><a class="header-anchor" href="#数字信号" aria-hidden="true">#</a> 数字信号</h4><p>数字信号只有“0”和“1”，我们把“0”对应为低电平，把“1”对应为高电平。</p><p>大家都听过集成电路是由大规模的晶体管组成的吧？</p><p>这种晶体管组成的逻辑就是TTL（Transistor-Transistor Logic）了。</p><p>在这种处理数字信号的电路中，需要定好一个规则：</p><ul><li><p>2.4V为高电平（H）</p></li><li><p>&lt; 0.4V为低电平（L）</p></li><li><p>规则定好后，通讯和数据的的处理，我们只认高电平（H）=1和低电平（L）=0了。</p></li></ul><p>一个高电平（H）代表“1”，一个低电平（L）代表“0”，两个高电平（H）代表“11”，两个低电平（L）代表“00”，如此类推。因为这个高电平或者低电平的宽度不是固定的，可以长，也可以短，<strong>一个连续的高电平，是区分不出是一个“1”，还是多个“1”的。所以还需要引入时钟同步信号</strong>。</p><p>时钟信号由固定宽度的高低电平形成，在时钟信号的电平由高变为低时，如果数字信号是高，那就是“1”了，反之则为“0”。由此可见数据传速和处理的速度由时钟信号的频率决定的，这就是我们平常所说的CPU主频了，频率越高，处理速度就越快了。</p><p><strong>所以数字信号是：在取值上是离散的、不连续的信号。</strong></p><h4 id="模拟信号" tabindex="-1"><a class="header-anchor" href="#模拟信号" aria-hidden="true">#</a> 模拟信号</h4><p>摸拟信号它是一个连续变化的物理量，比如温度、电流、电压、压力等这些信号，它可以很小，也可以很大，它的数值是无限的。</p><p>在现实现生活中的各种物理量，就像我们说话的声音，其实它就是一个摸拟的信号。摸拟信号有着精确的分辨率，信号处理也简单，可以直接通过三极管或者运放来进行放大处理。但摸拟信号很容易受到干扰，受干扰后的摸拟信号就难以还原了，所以我们一般都会将输入的摸拟量信号进行数字化，再进行计算机处理和传输。</p><p>摸拟信号转化为数字信号需要进行采样和量化两个过程。把采样到的摸拟信号值根据一定的规则是把它量化为一个固定的数值。</p><p>再举一个简单的例子：把0——5V的电压传化为数字信号</p><p>首先我们要定好规则：数值0代表0V电压，数值1023代表5V电压，为什么是1023代表5V呢？这就是量化的精度了，我们也可以定2047=5V，这样精度就更高。</p><p>这样就得到：0.0049V=1；0.0098V=2；0.0147V=3；如此类推。</p><p>同理，数字信号也是可以转换为摸拟信号的，只是过程相反，比如，数字MP3的歌曲经过数字解码后，最后也得转换为摸拟信号才可以通过扬声器发美妙的声音。例如LED的调光，也是一个数字信号转换为摸拟信号经典实例，通过不同占空比的PWM数字信号去控制RGB LED的颜色比例，就可以得到“无限”等级的亮度和颜色了。当然这里所说的“无限”也是有一定的精度限制的。</p><h3 id="载波" tabindex="-1"><a class="header-anchor" href="#载波" aria-hidden="true">#</a> 载波</h3><p><strong>当没有调制信号(即没有能够用来调制的其他电波循环脉冲串或者直流)的情况下由发射机产生的无线电波（或模拟信号）</strong></p><h3 id="无线通信中-射频和载波指的都是模拟信号" tabindex="-1"><a class="header-anchor" href="#无线通信中-射频和载波指的都是模拟信号" aria-hidden="true">#</a> 无线通信中，射频和载波指的都是模拟信号</h3><h3 id="时钟" tabindex="-1"><a class="header-anchor" href="#时钟" aria-hidden="true">#</a> 时钟</h3><blockquote><p><strong>冯诺伊曼架构计算机基本结构，分为5个部分</strong></p><ul><li><strong>中央处理器</strong></li><li><strong>内存</strong></li><li><strong>输入设备</strong></li><li><strong>输出设备</strong></li><li><strong>总线</strong></li></ul></blockquote><blockquote><p>时钟是同步单片机系统各个部件工作时序的最小时间单位，时钟通过 CPU 控制，产生其他与时钟保持一定关系的同步控制信号，协调各部件的工作时序，没有时钟系统就崩溃了。</p><ul><li>如 CPU 与存储器（RAM）传输数据，地址（A0 ~ Ax）、数据 （D0 ~ Dx）、读/写 (R/W) 等信号就必须按照一定的时序出现在各自的总线上，否则就乱套了。</li></ul></blockquote><blockquote><p>每个指令的执行都有时间来控制的…… 内部没有时钟，指令的执行就成了不可检测的盲区。</p></blockquote><blockquote><p><strong>数据总线</strong></p><ul><li>是CPU与内存或其他器件之间的数据传送通道。</li><li>数据总线的宽度决定了CPU和外界的数据传送速度。</li><li>每一条数据总线传送0或1一位，8根地址线一次传送8位，即一个字节。</li><li>需要指出的是，数据的含义是广义的，它可以是真正的数据，也可以指令代码或状态信息，有时甚至是一个控制信息，因此，在实际工作中，数据总线上传送的并不一定仅仅是真正意义上的数据。</li><li>地址总线是数据线数量之和。</li></ul><p><strong>数据总线技术指标：</strong></p><ul><li>总线的位宽：总线的位宽指的是总线能同时传送的二进制数据的位数，或数据总线的位数，即32位、64位等总线宽度的概念。总线的位宽越宽，每秒钟数据传输率越大，总线的带宽越宽。</li><li>总线的带宽（总线数据传输速率）： 数据总线的带宽指的是单位时间内总线上传送的数据量，即每钞钟传送速率。与总线密切相关的两个因素是总线的位宽和总线的工作频率。</li><li>它们之间的关系：总线的带宽=总线的工作频率*总线的位宽 / 8</li></ul></blockquote><blockquote><p><strong>地址总线</strong></p><ul><li>CPU是通过地址总线来指定存储单元的。</li><li>地址总线决定了CPU所能访问的最大内存空间大小。一般来说，若地址总线为n位，则可寻址空间为2n字节。比如 10根线可以访问 2^10 = 1024 个字节。</li></ul></blockquote><blockquote><p><strong>控制总线</strong></p><ul><li>CPU通过控制总线对外部器件进行控制。</li><li>控制总线的宽度决定了CPU对外部器件的控制能力。</li><li>控制总线是控制线数量之和。</li></ul></blockquote><blockquote><p><strong>不同总线的功能</strong></p><ul><li>地址总线决定CPU的寻址能力。</li><li>数据总线的宽度决定CPU与其他器件一次最多传送的数据量。</li><li>控制总线决定CPU对其他器件的控制能力。</li></ul></blockquote><blockquote><p><strong>字、字长</strong></p><p>字：CPU数据总线一次能存取、加工、传送的位数。如：32位的CPU，1字 = 2字节 = 16位</p><p>字长：字的位数</p></blockquote><blockquote><p><strong>寄存器、控制单元和逻辑运算单元</strong></p><ul><li>控制单元：负责控制 CPU 工作。</li><li>逻辑运算单元：即ALU，负责计算。</li><li>寄存器可以分为多种类，每种寄存器的功能又不尽相同。 <ul><li>CPU 中的寄存器主要作用是存储计算时的数据，你可能好奇为什么有了内存还需要寄存器？原因很简单，因为内存离 CPU 太远了，而寄存器就在 CPU 里，还紧挨着控制单元和逻辑运算单元，自然计算时速度会很快。</li><li>常见的寄存器种类： <ul><li>通用寄存器：用来存放需要进行运算的数据，比如需要进行加和运算的两个数据。</li><li>程序计数器：用来存储 CPU 要执行下一条指令「所在的内存地址」，注意不是存储了下一条要执行的指令，此时指令还在内存中，程序计数器只是存储了下一条指令的地址。</li><li>指令寄存器：用来存放程序计数器指向的指令，也就是指令本身，指令被执行完成之前，指令都存储在这里。</li></ul></li></ul></li></ul></blockquote><blockquote><p>总线是用于 CPU 和内存以及其他设备之间的通信，总线可分为 3 种：</p><ul><li>地址总线：用于指定 CPU 将要操作的内存地址；</li><li>数据总线：用于读写内存的数据；</li><li>控制总线：用于发送和接收信号，比如中断、设备复位等信号，CPU 收到信号后自然进行响应，这时也需要控制总线；</li><li>当 CPU 要读写内存数据的时候，一般需要通过两个总线：首先要通过「地址总线」来指定内存的地址；再通过「数据总线」来传输数据；</li></ul></blockquote><blockquote><p><strong>CPU 执行程序的过程如下：</strong></p><ul><li>第一步：CPU <strong>读取</strong>「程序计数器」的值，这个值是指令的内存地址，然后 CPU 的「控制单元」操作「地址总线」指定需要访问的内存地址，接着通知内存设备准备数据，数据准备好后通过「数据总线」将指令数据传给 CPU，CPU 收到内存传来的数据后，将这个指令数据存入到「指令寄存器」。</li><li>第二步：CPU <strong>解码</strong>「指令寄存器」中的指令，确定指令的类型和参数，如果是计算类型的指令，就把指令交给「逻辑运算单元」运算；如果是存储类型的指令，则交由「控制单元」执行；</li><li>第三步：CPU <strong>执行</strong> 完指令后，「程序计数器」的值自增，表示指向下一条指令。这个自增的大小，由 CPU 的位宽决定，比如 32 位的 CPU，指令是 4 个字节，需要 4 个内存地址存放，因此「程序计数器」的值会自增 4；</li></ul></blockquote><blockquote><p><strong>指令周期（Instruction Cycle）</strong></p><p>CPU从存储器中<strong>取出并执行一条指令所需的全部时间</strong>称之为指令周期。</p><p><strong>CPU执行一条指令的过程</strong></p><p>计算机每执行一条指令的过程，可分解为如下步骤：</p><ol><li><p>**Fetch（取指令）：**指令放在存储器，通过PC寄存器和指令寄存器取出指令的过程，由控制器（Control Unit）操作。 从PC寄存器找到对应指令地址，据指令地址从内存把具体指令加载到指令寄存器，然后PC(程序计数器，PC是非intel厂家对IP的称呼)寄存器自增；</p></li><li><p>**Decode（译码）：**据指令寄存器里面的指令，是哪一种类型的指令，解析成要进行什么操作，具体要操作哪些寄存器、数据或内存地址。该阶段也是由控制器执行；</p></li><li><p>**Execute（执行）：**实际执行算术逻辑操作、数据传输或者直接的地址跳转操作。无论是算术操作、逻辑操作的指令，还是数据传输、条件分支的指令，都由算术逻辑单元（ALU）操作，即由运算器处理。如果是一个简单的无条件地址跳转，那可直接在控制器里完成，无需运算器；</p></li></ol><p><strong>不同类型指令的指令周期不相同</strong>。</p><p>**注意：**这里将指令周期划分为3个步骤（Fetch，Decode，Execute），实际上还可以有其他的划分方式，例如划分为4个步骤：Fetch，Decode，Execute，Write Back（即将运算结果写回存储器或者寄存器），再例如划分为5个步骤：Fetch，Decode，Operand Fetch，Execute，Write Back。</p><p>事实上，不同的阶段其实是由计算机中的不同组件完成的：</p><ul><li>取指令的阶段，我们的指令是存放在<strong>存储器</strong>里的，实际上，通过程序计数器和指令寄存器取出指令的过程，是由<strong>控制器</strong>操作的；</li><li>指令的译码过程，也是由<strong>控制器</strong>进行的；</li><li>指令执行的过程，无论是进行算术操作、逻辑操作，还是进行数据传输、条件分支操作，都是由<strong>算术逻辑单元</strong>操作的，也就是由<strong>运算器</strong>处理的。</li><li>但是如果是一个简单的无条件地址跳转，则是直接在<strong>控制器</strong>里面完成的，不需要用到运算器。</li></ul></blockquote><blockquote><p><strong>机器周期</strong></p><p><strong>机器周期亦称CPU周期</strong>，机器周期是人为规定的，实际上是对一条指令执行过程阶段的划分。<strong>具体的划分方法随计算机的不同而不同</strong>。</p><p>例如：取指令、存储器读、存储器写等，这每一项工作称为一个<strong>基本操作</strong>（<strong>注意：每一个基本操作都是由若干CPU最基本的动作组成</strong>）。完成一个<strong>基本操作</strong>所需要的时间称为机器周期。<strong>通常用内存中读取一个指令字的最短时间来规定CPU周期。</strong></p><p><strong>机器周期的规定</strong></p><p>CPU内部操作速度很快，但访问内存速度却慢很多。 每条指令都需要从内存里面加载而来，所以一般把从内存里面读取一条指令的最短时间（与数据通路相关），规定为机器周期。</p><p><strong>机器周期与时钟周期的关系</strong></p><p>一个机器周期内包含若干时钟周期，包含时钟周期的个数称之为机器周期的<strong>时间宽度</strong>。</p><p>如果每个机器周期的时间宽度相等，称为定长机器周期；如果不相等，称为变长机器周期。</p><blockquote><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209102045010.jpg" alt="v2-c226a9f7f62a18296834d45cb8d89043_1440w" style="zoom:67%;"> 如图所示，这里将某一条指令的指令周期划分为3个机器周期，表示指令执行的3个阶段：取指令、取有效地址、执行指令；如(b)图所示，又将某一条指令的指令周期划分为2个机器周期，且机器周期的时间宽度不等，表示这条指令执行需要2个阶段：取指令、执行指令。 </blockquote><p><strong>机器周期与流水线的关系</strong></p><p>机器周期是<strong>为了实现指令流水线</strong>而引入的概念，实际上对应的是<strong>指令流水线的各个阶段，称之为流水阶段（或功能段，流水级等）</strong>。</p><p>例如对于上面(a)图的3个机器周期，作为3个流水阶段，令其重叠执行，可以得到一个三段流水线，其时空图如下所示：</p><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209102050144.jpg" alt="v2-b88c541c93d7586ec6d5c548a530a3a8_1440w"></p><p>其中每一个流水阶段需要4个时钟周期，流水线满载时，每4个时钟周期（或1个机器周期）完成一条指令，此时CPI = 4。如果不采用流水线的方式，需要12个时钟周期（或3个机器周期）完成一条指令，此时CPI = 12。</p></blockquote><blockquote><p><strong>微指令</strong></p><p>微指令：在一个机器周期中，一组实现一定操作功能的微命令的组合，构成一条微指令。</p><p>微指令由微指令实现，由微操作负责执行，执行时间通常为1时钟周期。</p><p>（这是不那么严格来讲，而事实是微指令也会有多个时钟周期才能执行完的情况，但对于RICS/ARM芯片，大多微指令都是一个时钟周期执行完）</p><blockquote><p>**举例：**<em>对于机器指令ADD R1, R2的执行周期（是一个机器周期），需要将寄存器R1与R2的值相加后结果送入R1，对应的微指令是R1+R2→R1。为了实现这个微指令，对应的微操作是R1→DR1，R2→DR2，DR1+DR2→DBUS→R1，这些微操作需要对应的微命令进行控制。</em></p></blockquote><p>**小结：**时钟周期 = 节拍 ≈ 微指令周期</p></blockquote><blockquote><p><strong>时钟周期</strong></p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209110130388.jpg" alt="20200404222755866" style="zoom:67%;"><p>上图的一个方波称为一个脉冲，类似于人类的脉搏跳动。对于每一个方形脉冲，电压或电路从0上升到最大值的那条线叫做上升沿；反之，电压或电流逐渐下降的那条线叫做下降沿。一个脉冲称为CPU的一个<code>时钟信号</code>，或者<code>时钟脉冲</code>。一个脉冲周期就叫CPU时钟周期，一个时钟周期内时钟信号震荡一次。</p><p><strong>脉冲的单位</strong></p><p><strong>两个脉冲相继出现的间隔时间，就是脉冲周期</strong>，它是频率的倒数；而将在单位时间（1秒）内所产生的脉冲个数称为频率。</p><p>频率的单位有：Hz（赫）、kHz（千赫）、MHz（兆赫）、GHz（吉赫）。</p><ul><li>其中1GHz=1000MHz，1MHz=1000kHz，1kHz=1000Hz。</li></ul><p>计算脉冲信号周期的时间单位及相应的换算关系是：s（秒）、ms（毫秒）、μs（微秒）、ns（纳秒）</p><ul><li>其中：1s=1000ms，1 ms=1000μs（微秒），1μs=1000ns。</li></ul></blockquote><h4 id="为什么cpu需要时钟" tabindex="-1"><a class="header-anchor" href="#为什么cpu需要时钟" aria-hidden="true">#</a> 为什么CPU需要时钟？</h4><blockquote><p>CPU可以有时钟，也可以没有时钟。使用时钟工作的CPU被称为<strong>同步CPU（synchronous CPU）</strong>，而不使用时钟工作的CPU被称为<strong>异步CPU（asynchronous CPU）</strong>。</p><p>同步电路的重点是用时钟＋寄存器达到每一级电路同时运行的效果而已，比如一个加法器，两个INPUT一个OUTPUT，如果一个INPUT上的值先于另一个INPUT发生变动，输出就会错误，并且这个错误在后面的电路中会被进一步放大。这时候如果把两个INPUT都用寄存器缓存起来，一个时钟过来同时刷新结果，OUTPUT就不会出现异常。</p><p><strong>时钟不是作用在ALU（逻辑控制单元）上而是寄存器上。</strong></p><p>一般对CPU比较朴素的一种理解是，知道它是一组逻辑门组成黑箱。给特定的输入，会有相应的输出。就像一个函数。</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209101156394.jpg" alt="v2-ce64d735b6ed2ae1751890553005bfee_1440w" style="zoom:33%;"><p>这种模型就叫**“组合电路”**。比如1+1=2。输入两个操作数A=1，B=1，操作符为“➕”加号。输出结果为2。、</p><p>但情况要是稍微复杂一点，比如说1+1+1=?，怎么办？是不是要重新设计一个有3个输入的逻辑加处理单元？那么1+2+3+4+...+10=？怎么计算？同时输入10个操作数吗？肯定不行。</p><p>解决的方法，就是需要**“累加”**。就是先计算1+2，得到的结果再+3，以此类推。</p><blockquote><p>1+2=3 3+3=6 6+4=10 ... ... 36+9=45 45+10=55</p></blockquote><p>累加的过程，这里必须用到2个 寄存器 ，1-10十个数字排列在2号寄存器里，按顺序取出来和上一次计算的和相加。每次得到的暂时的和存在1号寄存器。这时候，CPU的假想结构就变成了下面这样，</p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202209101158624.jpg" alt="v2-04d8e610032d9e73e4b8533c0951b158_1440w" style="zoom:33%;"><p>到这里，问题就来了。假设从2号寄存器取出初始输入A=1，1号寄存器初始化y=0，第一次加法1+0=1。此时逻辑电路处在一个稳定状态。根据上图，这个稳定状态如下，</p><blockquote><p>输入：A=1，y=0 输出：Z=1，Y=1</p></blockquote><p>但如果没有<strong>时钟脉冲</strong>的控制，这个稳定状态一瞬间就会被打破。因为0+1=1的结果马上会被写入1号寄存器。马上1又作为输入重新回到逻辑运算单元。假设此时2号寄存器还没来得及读取出下一个参与计算的数字2，逻辑运算单元此时的输入变为1+1，输出变成2。情况也有可能完全反过来，2号寄存器跑得快，上一次计算的和1还没来的及回到逻辑运算单元，下一个数字2已经到了，于是2+0=2就成了第二个输出。因为像这样操作数顺序不确定，导致一切都会乱套。</p><p>解决问题的办法，就是加个时钟。真正神奇的地方在于，时钟不是直接作用于ALU逻辑运算单元上。而是作用在寄存器上，寄存器上，寄存器上。</p><p>这种特殊的寄存器叫：时钟寄存器。只有在时钟信号的上升沿（比如说5V高位）才能往里写入。其他时候，输入只能在外面等着。《深入理解计算机系统，P249》</p><p>还是从第一个稳态开始：</p><blockquote><p>输入：A=1，y=0 输出：Z=1，Y=1</p></blockquote><p>这时候虽然逻辑运算单元的输出是Y=1，但只要时钟的高压5V脉冲没有到，这个Y=1的输入一直无法写进1号寄存器。所以它的输出y一直保持初始值0。同理2号寄存器也必须等时钟脉冲到达才能读取第二个操作数2。</p><p>所以当时钟电压升高以后，两个寄存器同时被写入新的值。逻辑运算单元接收到两个新输入，在下一个时钟脉冲到达之前，一直保持第二个稳态。</p><blockquote><p>输入：A=2，y=1 输出：Z=3，Y=3</p></blockquote><p>以此类推，直到得到最后计算结果，都保证下一个操作数和上一次计算的和是同时进入逻辑运算单元。</p></blockquote><h3 id="流控制" tabindex="-1"><a class="header-anchor" href="#流控制" aria-hidden="true">#</a> 流控制</h3><p><strong>简介</strong></p><p>数据在传输过程中容易出现数据丢失的现象，例如：两台计算机通过串口传输数据时，或者台式机与单片机之间进行通信时，可能由于两端计算机的处理速度不同，出现接收端的数据缓冲区已满，而发送端依然继续发送数据，则导致数据丢失。流控制的出现就是为了解决这种数据丢失的问题。</p><p><strong>控制原理</strong></p><p>当接收端的数据缓冲区已满，无法处理数据来时，就发出&quot;不再接收&quot;的信号，发送端则停止发送，直到发送端收到&quot;可以继续发送&quot;的信号再发送数据。计算机中常用的两种流控制分别是硬件流控制(RTS/CTS、DTR/DSR等)和软件流控制（XON/XOFF）。</p><p><strong>硬件流控制</strong></p><p>硬件流控制必须将相应的电缆线连上。硬件流控制常用方式为：**RTS/CTS（请求发送/清除发送）**流控制和DTR/DSR（数据终端就绪/数据设置就绪）流控制。 当用RTS/CTS流控制时，需将通讯两端的RTS、CTS线对应相连，数据终端设备（如计算机）使用RTS来启动调制解调器或其它数据通讯设备的数据流，而数据通讯设备（如调制解调器）则用CTS来启动和暂停来自计算机的数据流。这种硬件握手方式的过程为：通过程序为接收端缓冲区大小设置一个高位标志（可为缓冲区大小的75%）和一个低位标志（可为缓冲区大小的25%），当缓冲区内数据量达到高位时，接收端将CTS线置低电平（送逻辑0），当发送端的程序检测到CTS为低后，就停止发送数据，直到接收端缓冲区的数据量低于低位而将CTS置高电平。RTS则用来标明接收设备有没有准备好接收数据。</p><p><strong>软件流控制</strong></p><p>由于电缆线的限制，普通的控制通讯中一般不用硬件流控制，而使用软件流控制。软件流控制常通过XON/XOFF来实现。这种软件握手方式的过程为：当接收端的输入缓冲区内数据量超过设定的高位时，就向数据发送端发出XOFF字符（十进制的19或Control-S，设备编程说明书会有详细阐述），发送端收到XOFF字符后就立即停止发送数据；当接收端的输入缓冲区内数据量低于设定的低位时，就向数据发送端发出XON字符（十进制的17或Control-Q），发送端收到XON字符后就立即开始发送数据。一般可以从设备配套源程序中找到发送的字符是什么。</p><p><strong>两种控制方式比较</strong></p><p>当通过软件流控制方式传输二进制数据时，标志字符也有可能在数据流中出现而引起误操作，这是软件流控制的缺陷，而硬件流控制不会有这个问题。</p><h3 id="gpio-复用概述" tabindex="-1"><a class="header-anchor" href="#gpio-复用概述" aria-hidden="true">#</a> GPIO 复用概述</h3><p>STM32F4 有很多内置的外设，这些外设的外部引脚都是与 GPIO 复用的的，也就是说，一个 GPIO 如果</p><h3 id="c库函数重定向" tabindex="-1"><a class="header-anchor" href="#c库函数重定向" aria-hidden="true">#</a> C库函数重定向</h3><p>用户能自定义自己的C语言库函数，链接器在链接时自动使用这些新的功能函数。</p><p>这个过程叫做重定向 C语言库函数。</p><p>当链接器检查用户编写了与C函数相同名字的函数时，<strong>优先采用</strong>用户编写的函数，这样用户就可以实现对库的修改了。</p><p>举例来说，用户有一个 I/O设备（如USART）。本来库函数fputc() 是把字符输出到调试器控制窗口去的，但用户把输出设备改成了 USART 端口，这样一来，所有基于 fputc() 函数的 printf() 系列函数输出都被重定向 USART 端口上去了。</p><p>下面是实现 fputc() 重定向的例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>f<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">USART_SendData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_FLAG_TC<span class="token punctuation">)</span><span class="token operator">!=</span> SET<span class="token punctuation">)</span><span class="token punctuation">;</span>	
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里，fputc() 函数就成了目标硬件和标准 C库函数之间的一个抽象层。</p><p>但在这之前要将库函数首先包含进来，同时在 STM32 编程过程中，需要 Use MicroLIB，必须先有库才能重定向。</p><h3 id="isp" tabindex="-1"><a class="header-anchor" href="#isp" aria-hidden="true">#</a> ISP</h3><blockquote><ol><li>ISP (In System Programing) 在用户编程，指电路板上的空白器件可以编程写入代码，不需要将元器件从电路板上取下，已经编程的器件也可以使用ISP方式擦除 再写入。</li><li>ISP通过芯片内部的自举程序（BootLoader，由芯片厂家烧写好，不得更改）来选定一种串行外设，对芯片内部的FLash进行编程。</li><li><strong>STM M7内核之后不能串行下载</strong></li><li>最常用的ISP方式就是通过串口下载，最主要的优点就是成本低，缺点是只能用于下载程序，不能硬件仿真。</li><li>普通ISP和一键ISP，普通ISP在下载程序的时候需要手动配置BOOT的启动方式，而一键ISP则通过独特的硬件电路和上位机配合使用来达到一键下载的功能。</li></ol></blockquote><p><strong>USB转串口</strong></p><p>USB出来的电平称为USB电平，它有两根数据线 D+ D- ，STM32 F407 有1 2 3 4 5 6 = 6 个串口，只有串口1才有ISP功能，串口1 即GPIO 的PA9 、PA10，PA9 发送 USART_RX，PA10 接收 USART_TX。</p><p><strong>单片机所有的电平都是TTL电平，我们要实现下载，TTL电平跟USB电平是不兼容的，要实现兼容</strong>：</p><ul><li>USB转TTL <ul><li>我买的STM32 407正点原子采用的是这个，通过CH340这个芯片来实现USB转TTL。</li><li>两根USB数据线出来之后，通过这个芯片转成TTL电平出来 <ul><li>USB 的 D- 和 D+ 端口分别连接到 CH340 的UD- 和UD +端口，然后CH340的 TXD 和 RXD 分别连接到STM32的 USART_RX 和 USART_TX 端口</li></ul></li></ul></li><li>TTL转USB <ul><li>...没用到不说...</li></ul></li></ul><p><strong>ISP 一键下载电路</strong></p><p>要实现ISP，还需要一个独特的硬件电路。它是需要配合软件来的。</p><ul><li>FlyMCU 中有个配置：<strong>DTR的低电平复位，RTS高电平进BootLoader</strong>（我买的STM32 407正点原子要用这个配置）， 关系到： 配置.Boot0 Boot1..(后面再了解)</li><li>配置 Boot0 Boot1 选择启动方式 <ul><li>0 X内部Flash</li><li>1 0内部存储器</li><li>1 1内部SRAM</li></ul></li></ul><p><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202211081159844.JPG" alt="IMG_9498"></p><h3 id="总线矩阵" tabindex="-1"><a class="header-anchor" href="#总线矩阵" aria-hidden="true">#</a> 总线矩阵</h3><img src="https://cxrs.oss-cn-shenzhen.aliyuncs.com/202210102153001.png" alt="image-20221010215303843" style="zoom:67%;"><p>上图是STM32F407的系统总线架构图。由8条主控线S0-S7，7条被控线M0-M6组成。 <strong>八条主控总线是：</strong></p><ul><li><strong>Cortex-M4 I 总线</strong>：获取指令，访问对象是存储器</li><li><strong>Cortex-M4 D 总线</strong>：获取数据，对立即数进行加载和调试访问</li><li><strong>Cortex-M4 S 总线</strong>：访问外设或SRAM的数据</li><li><strong>DMA1 存储器总线</strong>：执行存储器数据的传入和传出</li><li><strong>DMA2 存储器总线</strong>：执行存储器数据的传入和传出</li><li><strong>DMA2 外设总线</strong>：访问AHB 或 执行存储器之间的数据传输。</li><li><strong>以太网DMA 总线</strong>：以太网DMA向存储器存储数据</li><li><strong>USB OTG HS DMA 总线</strong>：USB 向存储器 加载/存储 数据</li></ul><p><strong>七条被控总线：</strong></p><ul><li>内部 FLASH ICode 总线</li><li>内部 FLASH DCode 总线</li><li>主要内部 SRAM1(112KB)</li><li>辅助内部 SRAM2(16KB)</li><li>辅助内部 SRAM3(64KB) (仅适用 STM32F42xx 和 STM32F43xx 系列器件)</li></ul><p><strong>其它：</strong></p><ul><li>AHB：Advanced High Performance Bus高级高性能总线</li><li>CCM：内核耦合存储器</li><li>FSMC：Flexible Static Memory Controller，可变静态存储控制器</li><li>OTG: ON-THE-GO <ul><li>0TG，意为 ON-THE-G0，即在无电脑作为中转站的情况下，也能够实现各种不同设备或移动设备间的连接和数据交换。例如把数码相机直接连接到打印机上，通过 OTG 技术，可将拍摄的照片立即打印出来，而不必依托电脑转存：手机、平板支持 OTG 协议的话，通过 OTG 功能，就能直接和U盘、MP，键盘、游戏手柄等 USB 外界设备相连，并进行各项操作。</li></ul></li></ul><p><strong>总线矩阵用于主控总线之间的访问仲裁管理</strong>。仲裁采用循环调度算法。</p><p><strong>单片机里数据的访问都是通过总线来进行的，而一个总线上可能会同时挂载不同的外设。</strong></p><p><strong>同一个总线的外设在同一时间里可能有几个外设等待进行数据的访问</strong></p><p><strong>总线矩阵就得起到仲裁的作用，也就是给总线的外设分配权限--使用总线的权限</strong></p><h3 id="大小端模式" tabindex="-1"><a class="header-anchor" href="#大小端模式" aria-hidden="true">#</a> 大小端模式</h3><p>为什么要区分大小端，这是因为在计算机系统中，我们是以字节为单位的，每个地址单元都对应着一个字节，一个字节为 8bit。</p><p>但是在C语言中除了8bit的char之外，还有16bit的short型，32bit的long型（要看具体的编译器），另外，对于位数大于 8位的处理器，例如16位或者32位的处理器，由于寄存器宽度大于一个字节，那么必然存在着一个如何将多个字节安排的问题。</p><p>因此就导致了大端存储模式和小端存储模式。例如一个16bit的short型x，在内存中的地址为0x0010，x的值为0x1122，那么0x11为高字节，0x22为低字节。</p><ul><li><p><strong>大端模式</strong>，就将0x11放在低地址中，即0x0010中，0x22放在高地址中，即0x0011中。</p></li><li><p><strong>小端模式</strong>，刚好相反。我们常用的X86结构是小端模式，而KEIL C51则为大端模式。很多的ARM，DSP都为小端模式。有些ARM处理器还可以随时在程序中(在ARM Cortex 系列使用REV、REV16、REVSH指令 )进行大小端的切换。</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

using namespace std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 大端：数据的高字节保存在内存的低地址中，而数据的低字节保存在内存的高地址中
     * 小端：数据的高字节保存在内存的高地址中，而数据的低字节保存在内存的低地址中
     *
     * 本机 Apple Silicon ：0x16fcb6fea  -&gt;  22    0x16fcb6feb  -&gt;  11  ，高字节保存在高地址中，为小端
     */</span>
    <span class="token keyword">short</span> x <span class="token operator">=</span> <span class="token number">0x1122</span><span class="token punctuation">;</span><span class="token comment">// 11 为高字节(位)，22 为低字节(位)</span>
    <span class="token keyword">char</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">;</span>
    x0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//低地址单元 , 0x01</span>
    x1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//高地址单元 , 0x02</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%p  -&gt;  %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%p  -&gt;  %x\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*output :
// 若x0=0x11,则是大端; 若x0=0x22,则是小端......
0x16fcb6fea  -&gt;  22
0x16fcb6feb  -&gt;  11
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="msb-lsb" tabindex="-1"><a class="header-anchor" href="#msb-lsb" aria-hidden="true">#</a> MSB &amp; LSB</h3><ul><li><p>高位先行即在传输一个字节的时候先传输高位(MSB)；</p></li><li><p>低位先行即在传输一个字节的时候先传输低位(LSB)；</p></li></ul><p>高位先行和低位先行是针对串行数据传输方式来说的。常见的串行传输方式有串口(UAR）、I2C、SPI等。</p><p>以串口传输方式为例，标准的串口传输方式是低位先行，芯片在通过TX引脚发送数据时，依次发送位0、位1……位7。</p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/GerryDush/edit/main/zh/note/STM32.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: Tianya-68@qq.com">“Mortal-Tianya”</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/my-vuepress-blog/assets/app-521e935c.js" defer></script>
  </body>
</html>
