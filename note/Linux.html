<!DOCTYPE html>
<html lang="English">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>Linux | Programer's Lifes</title><meta name="description" content="Do not regret for wasting time, do not be ashamed of mediocrity.">
    <link rel="preload" href="/my-vuepress-blog/assets/style-e1f21a1f.css" as="style"><link rel="stylesheet" href="/my-vuepress-blog/assets/style-e1f21a1f.css">
    <link rel="modulepreload" href="/my-vuepress-blog/assets/app-521e935c.js"><link rel="modulepreload" href="/my-vuepress-blog/assets/Linux.html-41b6034c.js"><link rel="modulepreload" href="/my-vuepress-blog/assets/Linux.html-216564d1.js"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-8e536b67.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-cd51371e.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-85224617.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-de2179da.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-62f3fcc4.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-bf5748db.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-863de4b2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/GNU.html-9b334f8b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-41292ae1.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-354884f3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-1e542293.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-ea01f80f.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-6049be6f.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-a5cd54a3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-6e375392.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-d97e1897.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-8e5485e0.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-f60d479b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-dbb41269.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-bc59e5ee.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-d038ca97.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-a6627571.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-a77869ee.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-0e2beb2a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-fe4120f2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-e0ab504c.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-af1902df.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-07b89f5b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-26496d14.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-c29783f5.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-57ad1333.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-c9dbe43a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-3b67e3e3.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-2411d764.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-a6fa84ba.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-805d6d17.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-8f83464a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-ea7eb110.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-39718876.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-c7f5783a.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/404.html-f62106ff.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-0e3add3d.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-2979ca24.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-c6fc80dc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-ae8f0269.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-394e9cca.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-8e47e651.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-38348bb5.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/GNU.html-87241cdd.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-1f1d16cc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-ca601a94.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-ebdd7b52.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-85c33282.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-7ef34afa.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-ff9c155d.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-a62301c6.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-f2370b0b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-743dec54.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-b958c422.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-fff02bd4.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-ccd7c332.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/CPP.html-0353cc68.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/C语言.html-faa4c062.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Docker.html-caf4f3ca.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Echarts图表基本结构.html-d660b06b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Electron SerialPort.html-6807c7c7.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Git.html-fd0cd085.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Kernel.html-d52b7005.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Linux.html-99acd2c6.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Makefile.html-28e441bf.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/MongoDB.html-c26c3399.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/OpenCV.html-b0ba95bc.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Operating System.html-ca4c11eb.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/index.html-387a8185.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/STM32.html-39688344.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/Spring Cloud.html-69259a35.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/TensorFlow.html-5134a5c2.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/乱七八糟.html-403523ab.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/数据结构与算法C语言实现.html-5dcda878.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-51b5a534.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/ 计算机底层原理及电路实现.html-2e5c188b.js" as="script"><link rel="prefetch" href="/my-vuepress-blog/assets/404.html-9e190cf3.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/my-vuepress-blog/" class=""><!----><span class="site-name can-hide">Programer&#39;s Lifes</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/my-vuepress-blog/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Note"><span class="title">Note</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Note"><span class="title">Note</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/README.md" class="" aria-label="Designed Pattern"><!--[--><!--]--> Designed Pattern <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/C语言.md" class="" aria-label="C Language"><!--[--><!--]--> C Language <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/CPP.md" class="" aria-label="C Plus Plus"><!--[--><!--]--> C Plus Plus <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Echarts图表基本结构.md" class="" aria-label="Echarts Basic Structure"><!--[--><!--]--> Echarts Basic Structure <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Git.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Linux.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Makefile.md" class="" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/OpenCV.md" class="" aria-label="OpenCV"><!--[--><!--]--> OpenCV <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Operating System.md" class="" aria-label="Operating System"><!--[--><!--]--> Operating System <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Spring Cloud.md" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/STM32.md" class="" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/TensorFlow.md" class="" aria-label="TensorFlow"><!--[--><!--]--> TensorFlow <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/乱七八糟.md" class="" aria-label="Mix"><!--[--><!--]--> Mix <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/数据结构与算法C语言实现.md" class="" aria-label="Data Structure and Algorithm"><!--[--><!--]--> Data Structure and Algorithm <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Kernel"><span class="title">Kernel</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Kernel"><span class="title">Kernel</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Kernel.md" class="" aria-label="Kernel"><!--[--><!--]--> Kernel <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/GNU.md" class="" aria-label="GNU"><!--[--><!--]--> GNU <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/my-vuepress-blog/note/Linux.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Linux.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/GerryDush" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/my-vuepress-blog/" class="" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Note"><span class="title">Note</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Note"><span class="title">Note</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/README.md" class="" aria-label="Designed Pattern"><!--[--><!--]--> Designed Pattern <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/C语言.md" class="" aria-label="C Language"><!--[--><!--]--> C Language <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/CPP.md" class="" aria-label="C Plus Plus"><!--[--><!--]--> C Plus Plus <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Echarts图表基本结构.md" class="" aria-label="Echarts Basic Structure"><!--[--><!--]--> Echarts Basic Structure <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Git.md" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Linux.md" class="" aria-label="Linux"><!--[--><!--]--> Linux <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Makefile.md" class="" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/OpenCV.md" class="" aria-label="OpenCV"><!--[--><!--]--> OpenCV <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Operating System.md" class="" aria-label="Operating System"><!--[--><!--]--> Operating System <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Spring Cloud.md" class="" aria-label="Spring Cloud"><!--[--><!--]--> Spring Cloud <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/STM32.md" class="" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/TensorFlow.md" class="" aria-label="TensorFlow"><!--[--><!--]--> TensorFlow <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/乱七八糟.md" class="" aria-label="Mix"><!--[--><!--]--> Mix <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/数据结构与算法C语言实现.md" class="" aria-label="Data Structure and Algorithm"><!--[--><!--]--> Data Structure and Algorithm <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Kernel"><span class="title">Kernel</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Kernel"><span class="title">Kernel</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/Kernel.md" class="" aria-label="Kernel"><!--[--><!--]--> Kernel <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/note/GNU.md" class="" aria-label="GNU"><!--[--><!--]--> GNU <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/my-vuepress-blog/note/Linux.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/my-vuepress-blog/zh/note/Linux.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/GerryDush" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Linux <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pcb" class="router-link-active router-link-exact-active sidebar-item" aria-label="PCB"><!--[--><!--]--> PCB <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#位图机制" class="router-link-active router-link-exact-active sidebar-item" aria-label="位图机制"><!--[--><!--]--> 位图机制 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#文件空洞" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件空洞"><!--[--><!--]--> 文件空洞 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#页缓存" class="router-link-active router-link-exact-active sidebar-item" aria-label="页缓存"><!--[--><!--]--> 页缓存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#脏页" class="router-link-active router-link-exact-active sidebar-item" aria-label="脏页"><!--[--><!--]--> 脏页 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#虚拟文件系统-virtual-file-system-vfs" class="router-link-active router-link-exact-active sidebar-item" aria-label="虚拟文件系统（Virtual File System，VFS）"><!--[--><!--]--> 虚拟文件系统（Virtual File System，VFS） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#mmu-内存管理单元" class="router-link-active router-link-exact-active sidebar-item" aria-label="MMU （内存管理单元）"><!--[--><!--]--> MMU （内存管理单元） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号"><!--[--><!--]--> 信号 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#什么是信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是信号"><!--[--><!--]--> 什么是信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#异常终止" class="router-link-active router-link-exact-active sidebar-item" aria-label="异常终止"><!--[--><!--]--> 异常终止 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#人为触发信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="人为触发信号"><!--[--><!--]--> 人为触发信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号相关函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号相关函数"><!--[--><!--]--> 信号相关函数 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#kill" class="router-link-active router-link-exact-active sidebar-item" aria-label="kill"><!--[--><!--]--> kill <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#raise" class="router-link-active router-link-exact-active sidebar-item" aria-label="raise"><!--[--><!--]--> raise <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#abort" class="router-link-active router-link-exact-active sidebar-item" aria-label="abort"><!--[--><!--]--> abort <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pause" class="router-link-active router-link-exact-active sidebar-item" aria-label="pause"><!--[--><!--]--> pause <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#alarm" class="router-link-active router-link-exact-active sidebar-item" aria-label="alarm"><!--[--><!--]--> alarm <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#setitimer" class="router-link-active router-link-exact-active sidebar-item" aria-label="setitimer"><!--[--><!--]--> setitimer <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#signal" class="router-link-active router-link-exact-active sidebar-item" aria-label="signal"><!--[--><!--]--> signal <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号集" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号集"><!--[--><!--]--> 信号集 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号集工作过程" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号集工作过程"><!--[--><!--]--> 信号集工作过程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号集相关函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号集相关函数"><!--[--><!--]--> 信号集相关函数 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigaction" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigaction"><!--[--><!--]--> sigaction <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigemptyset" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigemptyset"><!--[--><!--]--> sigemptyset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigfillset" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigfillset"><!--[--><!--]--> sigfillset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigaddset" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigaddset"><!--[--><!--]--> sigaddset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigdelset" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigdelset"><!--[--><!--]--> sigdelset <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigismember" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigismember"><!--[--><!--]--> sigismember <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigprocmask" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigprocmask"><!--[--><!--]--> sigprocmask <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigpending" class="router-link-active router-link-exact-active sidebar-item" aria-label="sigpending"><!--[--><!--]--> sigpending <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#sigchld-信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="SIGCHLD 信号"><!--[--><!--]--> SIGCHLD 信号 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#linux-之-io-系统编程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Linux 之 IO 系统编程"><!--[--><!--]--> Linux 之 IO 系统编程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#文件io" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件IO"><!--[--><!--]--> 文件IO <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#open-打开或创建一个文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="open 打开或创建一个文件"><!--[--><!--]--> open 打开或创建一个文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#write" class="router-link-active router-link-exact-active sidebar-item" aria-label="write"><!--[--><!--]--> write <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#read" class="router-link-active router-link-exact-active sidebar-item" aria-label="read"><!--[--><!--]--> read <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#lseek" class="router-link-active router-link-exact-active sidebar-item" aria-label="lseek"><!--[--><!--]--> lseek <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#实现-cp-命令" class="router-link-active router-link-exact-active sidebar-item" aria-label="实现 cp 命令"><!--[--><!--]--> 实现 cp 命令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#复制文件描述符-dup" class="router-link-active router-link-exact-active sidebar-item" aria-label="复制文件描述符 dup"><!--[--><!--]--> 复制文件描述符 dup <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#复制文件描述符-指定新的文件描述符-dup2" class="router-link-active router-link-exact-active sidebar-item" aria-label="复制文件描述符，指定新的文件描述符 dup2"><!--[--><!--]--> 复制文件描述符，指定新的文件描述符 dup2 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#文件锁-fcntl" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件锁 fcntl"><!--[--><!--]--> 文件锁 fcntl <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#检查文件或目录的是否存在-访问权限-access" class="router-link-active router-link-exact-active sidebar-item" aria-label="检查文件或目录的是否存在&amp;访问权限 access"><!--[--><!--]--> 检查文件或目录的是否存在&amp;访问权限 access <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#修改文件大小-truncate" class="router-link-active router-link-exact-active sidebar-item" aria-label="修改文件大小 truncate"><!--[--><!--]--> 修改文件大小 truncate <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取文件元信息-stat" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取文件元信息 stat"><!--[--><!--]--> 获取文件元信息 stat <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#根据文件路径获取文件状态-stat" class="router-link-active router-link-exact-active sidebar-item" aria-label="根据文件路径获取文件状态 stat"><!--[--><!--]--> 根据文件路径获取文件状态 stat <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#根据文件描述符获取文件状态-fstat" class="router-link-active router-link-exact-active sidebar-item" aria-label="根据文件描述符获取文件状态 fstat"><!--[--><!--]--> 根据文件描述符获取文件状态 fstat <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取符号链接文件的状态信息-lstat" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取符号链接文件的状态信息 lstat"><!--[--><!--]--> 获取符号链接文件的状态信息 lstat <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#mmap-内存映射文件" class="router-link-active router-link-exact-active sidebar-item" aria-label="mmap 内存映射文件"><!--[--><!--]--> mmap 内存映射文件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#解除由-mmap-创建的映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="解除由 mmap 创建的映射"><!--[--><!--]--> 解除由 mmap 创建的映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix共享内存-shm-open" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX共享内存 shm_open"><!--[--><!--]--> POSIX共享内存 shm_open <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#标准io" class="router-link-active router-link-exact-active sidebar-item" aria-label="标准IO"><!--[--><!--]--> 标准IO <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#标准io与文件io的区别" class="router-link-active router-link-exact-active sidebar-item" aria-label="标准IO与文件IO的区别"><!--[--><!--]--> 标准IO与文件IO的区别 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#三个缓存的概念-数组" class="router-link-active router-link-exact-active sidebar-item" aria-label="三个缓存的概念（数组）"><!--[--><!--]--> 三个缓存的概念（数组） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#测试验证库缓存的存在" class="router-link-active router-link-exact-active sidebar-item" aria-label="测试验证库缓存的存在"><!--[--><!--]--> 测试验证库缓存的存在 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#标准io相关函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="标准IO相关函数"><!--[--><!--]--> 标准IO相关函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写函数"><!--[--><!--]--> 读写函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#调整读写位置指针" class="router-link-active router-link-exact-active sidebar-item" aria-label="调整读写位置指针"><!--[--><!--]--> 调整读写位置指针 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#二进制文件读写" class="router-link-active router-link-exact-active sidebar-item" aria-label="二进制文件读写"><!--[--><!--]--> 二进制文件读写 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#文件结尾和出错" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件结尾和出错"><!--[--><!--]--> 文件结尾和出错 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#文件io-和-标准io小总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="文件IO 和 标准IO小总结"><!--[--><!--]--> 文件IO 和 标准IO小总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#目录io" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录IO"><!--[--><!--]--> 目录IO <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#打开目录" class="router-link-active router-link-exact-active sidebar-item" aria-label="打开目录"><!--[--><!--]--> 打开目录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建目录" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建目录"><!--[--><!--]--> 创建目录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读目录" class="router-link-active router-link-exact-active sidebar-item" aria-label="读目录"><!--[--><!--]--> 读目录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#调整目录位置指针" class="router-link-active router-link-exact-active sidebar-item" aria-label="调整目录位置指针"><!--[--><!--]--> 调整目录位置指针 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#关闭目录" class="router-link-active router-link-exact-active sidebar-item" aria-label="关闭目录"><!--[--><!--]--> 关闭目录 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="示例："><!--[--><!--]--> 示例： <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#time-程序执行耗时" class="router-link-active router-link-exact-active sidebar-item" aria-label="time 程序执行耗时"><!--[--><!--]--> time 程序执行耗时 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#diff-比较文件的差异" class="router-link-active router-link-exact-active sidebar-item" aria-label="diff 比较文件的差异"><!--[--><!--]--> diff 比较文件的差异 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#linux-多线程编程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Linux 多线程编程"><!--[--><!--]--> Linux 多线程编程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#一、多线程的基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="一、多线程的基本概念"><!--[--><!--]--> 一、多线程的基本概念 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#进程" class="router-link-active router-link-exact-active sidebar-item" aria-label="进程"><!--[--><!--]--> 进程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程"><!--[--><!--]--> 线程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#并发" class="router-link-active router-link-exact-active sidebar-item" aria-label="并发"><!--[--><!--]--> 并发 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#并行" class="router-link-active router-link-exact-active sidebar-item" aria-label="并行"><!--[--><!--]--> 并行 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#多线程的优势" class="router-link-active router-link-exact-active sidebar-item" aria-label="多线程的优势"><!--[--><!--]--> 多线程的优势 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#二、多线程的基本控制" class="router-link-active router-link-exact-active sidebar-item" aria-label="二、多线程的基本控制"><!--[--><!--]--> 二、多线程的基本控制 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建线程" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建线程"><!--[--><!--]--> 创建线程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程生命周期"><!--[--><!--]--> 线程生命周期 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的创建" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的创建"><!--[--><!--]--> 线程的创建 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的四个基本状态" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的四个基本状态"><!--[--><!--]--> 线程的四个基本状态 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#回收" class="router-link-active router-link-exact-active sidebar-item" aria-label="回收"><!--[--><!--]--> 回收 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程退出" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程退出"><!--[--><!--]--> 线程退出 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#终止线程的几种方式" class="router-link-active router-link-exact-active sidebar-item" aria-label="终止线程的几种方式"><!--[--><!--]--> 终止线程的几种方式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pthread-join" class="router-link-active router-link-exact-active sidebar-item" aria-label="pthread_join"><!--[--><!--]--> pthread_join <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程取消" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程取消"><!--[--><!--]--> 线程取消 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#取消函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="取消函数"><!--[--><!--]--> 取消函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#取消状态" class="router-link-active router-link-exact-active sidebar-item" aria-label="取消状态"><!--[--><!--]--> 取消状态 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#取消类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="取消类型"><!--[--><!--]--> 取消类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#取消点" class="router-link-active router-link-exact-active sidebar-item" aria-label="取消点"><!--[--><!--]--> 取消点 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程信号处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程信号处理"><!--[--><!--]--> 线程信号处理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#向线程发送信号" class="router-link-active router-link-exact-active sidebar-item" aria-label="向线程发送信号"><!--[--><!--]--> 向线程发送信号 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#向线程发送信号实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="向线程发送信号实例"><!--[--><!--]--> 向线程发送信号实例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号处理"><!--[--><!--]--> 信号处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号处理实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号处理实例"><!--[--><!--]--> 信号处理实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程清理" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程清理"><!--[--><!--]--> 线程清理 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程清理实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程清理实例"><!--[--><!--]--> 线程清理实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#三、线程的同步" class="router-link-active router-link-exact-active sidebar-item" aria-label="三、线程的同步"><!--[--><!--]--> 三、线程的同步 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#互斥量" class="router-link-active router-link-exact-active sidebar-item" aria-label="互斥量"><!--[--><!--]--> 互斥量 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#为什么要使用互斥量" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要使用互斥量"><!--[--><!--]--> 为什么要使用互斥量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#初始化与释放" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化与释放"><!--[--><!--]--> 初始化与释放 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#加锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="加锁"><!--[--><!--]--> 加锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#解锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="解锁"><!--[--><!--]--> 解锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="实例"><!--[--><!--]--> 实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号量"><!--[--><!--]--> 信号量 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#二进制信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="二进制信号量"><!--[--><!--]--> 二进制信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#计数信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="计数信号量"><!--[--><!--]--> 计数信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#初始化信号量-sem-init" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化信号量 sem_init"><!--[--><!--]--> 初始化信号量 sem_init <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#等待-阻塞-信号量的值减小-sem-wait" class="router-link-active router-link-exact-active sidebar-item" aria-label="等待（阻塞）信号量的值减小 sem_wait"><!--[--><!--]--> 等待（阻塞）信号量的值减小 sem_wait <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#增加信号量的值-sem-post" class="router-link-active router-link-exact-active sidebar-item" aria-label="增加信号量的值 sem_post"><!--[--><!--]--> 增加信号量的值 sem_post <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#销毁-释放-信号量-sem-destroy" class="router-link-active router-link-exact-active sidebar-item" aria-label="销毁（释放）信号量 sem_destroy"><!--[--><!--]--> 销毁（释放）信号量 sem_destroy <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号量例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号量例子"><!--[--><!--]--> 信号量例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁"><!--[--><!--]--> 读写锁 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#什么是读写锁-它与互斥量的区别" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么是读写锁，它与互斥量的区别"><!--[--><!--]--> 什么是读写锁，它与互斥量的区别 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁初始化" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁初始化"><!--[--><!--]--> 读写锁初始化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁销毁"><!--[--><!--]--> 读写锁销毁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读模式加锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="读模式加锁"><!--[--><!--]--> 读模式加锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#写模式加锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="写模式加锁"><!--[--><!--]--> 写模式加锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁解锁" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁解锁"><!--[--><!--]--> 读写锁解锁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#实例-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="实例"><!--[--><!--]--> 实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#条件变量" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件变量"><!--[--><!--]--> 条件变量 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#条件变量的引入" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件变量的引入"><!--[--><!--]--> 条件变量的引入 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#初始化" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化"><!--[--><!--]--> 初始化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="销毁"><!--[--><!--]--> 销毁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#使用" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用"><!--[--><!--]--> 使用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#实例-2" class="router-link-active router-link-exact-active sidebar-item" aria-label="实例"><!--[--><!--]--> 实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#四、线程高级控制" class="router-link-active router-link-exact-active sidebar-item" aria-label="四、线程高级控制"><!--[--><!--]--> 四、线程高级控制 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#一次性初始化" class="router-link-active router-link-exact-active sidebar-item" aria-label="一次性初始化"><!--[--><!--]--> 一次性初始化 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pthread-once" class="router-link-active router-link-exact-active sidebar-item" aria-label="pthread_once"><!--[--><!--]--> pthread_once <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#实例-3" class="router-link-active router-link-exact-active sidebar-item" aria-label="实例"><!--[--><!--]--> 实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程属性"><!--[--><!--]--> 线程属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程属性初始化" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程属性初始化"><!--[--><!--]--> 线程属性初始化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程属性销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程属性销毁"><!--[--><!--]--> 线程属性销毁 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的分离属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的分离属性"><!--[--><!--]--> 线程的分离属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#分离属性的使用方法" class="router-link-active router-link-exact-active sidebar-item" aria-label="分离属性的使用方法"><!--[--><!--]--> 分离属性的使用方法 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置线程分离属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置线程分离属性"><!--[--><!--]--> 设置线程分离属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取线程分离状态" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取线程分离状态"><!--[--><!--]--> 获取线程分离状态 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的分离属性实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的分离属性实例"><!--[--><!--]--> 线程的分离属性实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的栈属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的栈属性"><!--[--><!--]--> 线程的栈属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#修改线程的栈属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="修改线程的栈属性"><!--[--><!--]--> 修改线程的栈属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取线程的栈属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取线程的栈属性"><!--[--><!--]--> 获取线程的栈属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程栈属性-栈守护区" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程栈属性 栈守护区"><!--[--><!--]--> 线程栈属性 栈守护区 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置栈守护区大小" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置栈守护区大小"><!--[--><!--]--> 设置栈守护区大小 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取栈守护区大小" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取栈守护区大小"><!--[--><!--]--> 获取栈守护区大小 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程栈属性实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程栈属性实例"><!--[--><!--]--> 线程栈属性实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的同步属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的同步属性"><!--[--><!--]--> 线程的同步属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#互斥量属性初始化" class="router-link-active router-link-exact-active sidebar-item" aria-label="互斥量属性初始化"><!--[--><!--]--> 互斥量属性初始化 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#互斥量属性销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="互斥量属性销毁"><!--[--><!--]--> 互斥量属性销毁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#进程共享属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="进程共享属性"><!--[--><!--]--> 进程共享属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置进程共享属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置进程共享属性"><!--[--><!--]--> 设置进程共享属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取进程共享属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取进程共享属性"><!--[--><!--]--> 获取进程共享属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#互斥量类型属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="互斥量类型属性"><!--[--><!--]--> 互斥量类型属性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁属性"><!--[--><!--]--> 读写锁属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁属性初始化与销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁属性初始化与销毁"><!--[--><!--]--> 读写锁属性初始化与销毁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#读写锁进程共享属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="读写锁进程共享属性"><!--[--><!--]--> 读写锁进程共享属性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#条件变量属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件变量属性"><!--[--><!--]--> 条件变量属性 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#条件变量属性初始化与销毁" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件变量属性初始化与销毁"><!--[--><!--]--> 条件变量属性初始化与销毁 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#条件变量进程共享属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="条件变量进程共享属性"><!--[--><!--]--> 条件变量进程共享属性 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程的同步属性实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程的同步属性实例"><!--[--><!--]--> 线程的同步属性实例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程私有数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程私有数据"><!--[--><!--]--> 线程私有数据 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建线程私有数据键" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建线程私有数据键"><!--[--><!--]--> 创建线程私有数据键 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#销毁线程私有数据键" class="router-link-active router-link-exact-active sidebar-item" aria-label="销毁线程私有数据键"><!--[--><!--]--> 销毁线程私有数据键 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#私有数据键关联数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="私有数据键关联数据"><!--[--><!--]--> 私有数据键关联数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取私有数据键关联的数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取私有数据键关联的数据"><!--[--><!--]--> 获取私有数据键关联的数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程私有实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程私有实例"><!--[--><!--]--> 线程私有实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#线程与fork" class="router-link-active router-link-exact-active sidebar-item" aria-label="线程与fork"><!--[--><!--]--> 线程与fork <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pthread-atfork" class="router-link-active router-link-exact-active sidebar-item" aria-label="pthread_atfork"><!--[--><!--]--> pthread_atfork <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pthread-atfork-实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="pthread_atfork 实例"><!--[--><!--]--> pthread_atfork 实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#系统进程" class="router-link-active router-link-exact-active sidebar-item" aria-label="系统进程"><!--[--><!--]--> 系统进程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#相关指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="相关指令"><!--[--><!--]--> 相关指令 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#top" class="router-link-active router-link-exact-active sidebar-item" aria-label="top"><!--[--><!--]--> top <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pstree" class="router-link-active router-link-exact-active sidebar-item" aria-label="pstree"><!--[--><!--]--> pstree <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#ps" class="router-link-active router-link-exact-active sidebar-item" aria-label="ps"><!--[--><!--]--> ps <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#进程信息表" class="router-link-active router-link-exact-active sidebar-item" aria-label="进程信息表"><!--[--><!--]--> 进程信息表 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#进程概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="进程概念"><!--[--><!--]--> 进程概念 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#孤儿进程" class="router-link-active router-link-exact-active sidebar-item" aria-label="孤儿进程"><!--[--><!--]--> 孤儿进程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#僵尸进程" class="router-link-active router-link-exact-active sidebar-item" aria-label="僵尸进程"><!--[--><!--]--> 僵尸进程 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#pid-和-ppid" class="router-link-active router-link-exact-active sidebar-item" aria-label="PID 和 PPID"><!--[--><!--]--> PID 和 PPID <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#专用的-pid" class="router-link-active router-link-exact-active sidebar-item" aria-label="专用的 PID"><!--[--><!--]--> 专用的 PID <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#相关函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="相关函数"><!--[--><!--]--> 相关函数 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建子进程-fork" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建子进程 fork"><!--[--><!--]--> 创建子进程 fork <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#exit-进程退出" class="router-link-active router-link-exact-active sidebar-item" aria-label="exit 进程退出"><!--[--><!--]--> exit 进程退出 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#函数注册终止处理函数-atexit" class="router-link-active router-link-exact-active sidebar-item" aria-label="函数注册终止处理函数 atexit"><!--[--><!--]--> 函数注册终止处理函数 atexit <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#程序退出时执行的函数-on-exit-非标准" class="router-link-active router-link-exact-active sidebar-item" aria-label="程序退出时执行的函数 on_exit (非标准)"><!--[--><!--]--> 程序退出时执行的函数 on_exit (非标准) <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#回收子进程-wait-waitpid" class="router-link-active router-link-exact-active sidebar-item" aria-label="回收子进程 wait waitpid"><!--[--><!--]--> 回收子进程 wait waitpid <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#为什么要回收子进程" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要回收子进程"><!--[--><!--]--> 为什么要回收子进程 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#waitpid-函数等待指定子进程结束" class="router-link-active router-link-exact-active sidebar-item" aria-label="waitpid 函数等待指定子进程结束"><!--[--><!--]--> waitpid 函数等待指定子进程结束 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#执行程序-exec" class="router-link-active router-link-exact-active sidebar-item" aria-label="执行程序 exec*"><!--[--><!--]--> 执行程序 exec* <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#linux-进程间通信" class="router-link-active router-link-exact-active sidebar-item" aria-label="Linux 进程间通信"><!--[--><!--]--> Linux 进程间通信 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#system-v-与-posix-简介与对比" class="router-link-active router-link-exact-active sidebar-item" aria-label="System V 与 POSIX 简介与对比"><!--[--><!--]--> System V 与 POSIX 简介与对比 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-消息队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 消息队列："><!--[--><!--]--> POSIX 消息队列： <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 信号量："><!--[--><!--]--> POSIX 信号量： <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-共享内存" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 共享内存："><!--[--><!--]--> POSIX 共享内存： <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#无名管道-pipe" class="router-link-active router-link-exact-active sidebar-item" aria-label="无名管道 pipe"><!--[--><!--]--> 无名管道 pipe <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#有名管道" class="router-link-active router-link-exact-active sidebar-item" aria-label="有名管道"><!--[--><!--]--> 有名管道 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建有名管道" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建有名管道"><!--[--><!--]--> 创建有名管道 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#使用有名管道进行通信" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用有名管道进行通信"><!--[--><!--]--> 使用有名管道进行通信 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号通信" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号通信"><!--[--><!--]--> 信号通信 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#ipc-资源状态" class="router-link-active router-link-exact-active sidebar-item" aria-label="IPC 资源状态"><!--[--><!--]--> IPC 资源状态 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#ipcs" class="router-link-active router-link-exact-active sidebar-item" aria-label="ipcs"><!--[--><!--]--> ipcs <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#ipcrm" class="router-link-active router-link-exact-active sidebar-item" aria-label="ipcrm"><!--[--><!--]--> ipcrm <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#system-v-共享内存" class="router-link-active router-link-exact-active sidebar-item" aria-label="System V 共享内存"><!--[--><!--]--> System V 共享内存 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建或获取共享内存段-shmget" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建或获取共享内存段 shmget"><!--[--><!--]--> 创建或获取共享内存段 shmget <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#生成-key-ftok" class="router-link-active router-link-exact-active sidebar-item" aria-label="生成 key ftok"><!--[--><!--]--> 生成 key ftok <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#映射共享内存到进程空间-shmat" class="router-link-active router-link-exact-active sidebar-item" aria-label="映射共享内存到进程空间 shmat"><!--[--><!--]--> 映射共享内存到进程空间 shmat <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#释放共享内存映射的进程地址空间-shmdt" class="router-link-active router-link-exact-active sidebar-item" aria-label="释放共享内存映射的进程地址空间 shmdt"><!--[--><!--]--> 释放共享内存映射的进程地址空间 shmdt <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取-设置-删除共享内存对象-shmctl" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取｜设置｜删除共享内存对象 shmctl"><!--[--><!--]--> 获取｜设置｜删除共享内存对象 shmctl <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#共享内存父子进程通信例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="共享内存父子进程通信例子"><!--[--><!--]--> 共享内存父子进程通信例子 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#共享内存-非父子进程间通信-例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="共享内存 非父子进程间通信 例子"><!--[--><!--]--> 共享内存 非父子进程间通信 例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#system-v-消息队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="System V 消息队列"><!--[--><!--]--> System V 消息队列 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建或获取消息队列-msgget" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建或获取消息队列 msgget"><!--[--><!--]--> 创建或获取消息队列 msgget <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取-设置-删除消息队列对象-msgctl" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取｜设置｜删除消息队列对象 msgctl"><!--[--><!--]--> 获取｜设置｜删除消息队列对象 msgctl <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#向消息队列发送消息-msgsnd" class="router-link-active router-link-exact-active sidebar-item" aria-label="向消息队列发送消息 msgsnd"><!--[--><!--]--> 向消息队列发送消息 msgsnd <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#从消息队列接收消息-msgrcv" class="router-link-active router-link-exact-active sidebar-item" aria-label="从消息队列接收消息 msgrcv"><!--[--><!--]--> 从消息队列接收消息 msgrcv <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#使用消息队列进程间互相通信例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用消息队列进程间互相通信例子"><!--[--><!--]--> 使用消息队列进程间互相通信例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#system-v-信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="System V 信号量"><!--[--><!--]--> System V 信号量 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建或获取信号集-semget" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建或获取信号集 semget"><!--[--><!--]--> 创建或获取信号集 semget <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取或设置信号量集的信息-semget" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取或设置信号量集的信息 semget"><!--[--><!--]--> 获取或设置信号量集的信息 semget <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#操作信号量-semop" class="router-link-active router-link-exact-active sidebar-item" aria-label="操作信号量 semop"><!--[--><!--]--> 操作信号量 semop <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="例子"><!--[--><!--]--> 例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-进程间通信" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 进程间通信"><!--[--><!--]--> POSIX 进程间通信 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-共享内存-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 共享内存"><!--[--><!--]--> POSIX 共享内存 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建或打开共享内存" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建或打开共享内存"><!--[--><!--]--> 创建或打开共享内存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#释放共享内存" class="router-link-active router-link-exact-active sidebar-item" aria-label="释放共享内存"><!--[--><!--]--> 释放共享内存 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#内存映射" class="router-link-active router-link-exact-active sidebar-item" aria-label="内存映射"><!--[--><!--]--> 内存映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#解除由-mmap-创建的映射-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="解除由 mmap 创建的映射"><!--[--><!--]--> 解除由 mmap 创建的映射 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#共享内存进程间通信例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="共享内存进程间通信例子"><!--[--><!--]--> 共享内存进程间通信例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-消息队列-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 消息队列"><!--[--><!--]--> POSIX 消息队列 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建消息队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建消息队列"><!--[--><!--]--> 创建消息队列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#删除一个-posix-消息队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="删除一个 POSIX 消息队列"><!--[--><!--]--> 删除一个 POSIX 消息队列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#消息队列发送消息" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列发送消息"><!--[--><!--]--> 消息队列发送消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#消息队列接收消息" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列接收消息"><!--[--><!--]--> 消息队列接收消息 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#消息队列设置异步通知" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列设置异步通知"><!--[--><!--]--> 消息队列设置异步通知 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置-修改消息队列的属性" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置｜修改消息队列的属性"><!--[--><!--]--> 设置｜修改消息队列的属性 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#消息队列进程双向通信例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息队列进程双向通信例子"><!--[--><!--]--> 消息队列进程双向通信例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#posix-信号量-1" class="router-link-active router-link-exact-active sidebar-item" aria-label="POSIX 信号量"><!--[--><!--]--> POSIX 信号量 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#打开或创建-posix-命名信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="打开或创建 POSIX 命名信号量"><!--[--><!--]--> 打开或创建 POSIX 命名信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#关闭命名信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="关闭命名信号量"><!--[--><!--]--> 关闭命名信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#删除命名信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="删除命名信号量"><!--[--><!--]--> 删除命名信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#初始化未命名的-posix-信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化未命名的 POSIX 信号量"><!--[--><!--]--> 初始化未命名的 POSIX 信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#销毁-释放-未命名信号量-sem-destroy" class="router-link-active router-link-exact-active sidebar-item" aria-label="销毁（释放）未命名信号量 sem_destroy"><!--[--><!--]--> 销毁（释放）未命名信号量 sem_destroy <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#获取信号量的当前值" class="router-link-active router-link-exact-active sidebar-item" aria-label="获取信号量的当前值"><!--[--><!--]--> 获取信号量的当前值 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#等待信号量" class="router-link-active router-link-exact-active sidebar-item" aria-label="等待信号量"><!--[--><!--]--> 等待信号量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#增加信号量的值" class="router-link-active router-link-exact-active sidebar-item" aria-label="增加信号量的值"><!--[--><!--]--> 增加信号量的值 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#信号量进程间通信例子" class="router-link-active router-link-exact-active sidebar-item" aria-label="信号量进程间通信例子"><!--[--><!--]--> 信号量进程间通信例子 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#socket-网络编程" class="router-link-active router-link-exact-active sidebar-item" aria-label="Socket 网络编程"><!--[--><!--]--> Socket 网络编程 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#创建套接字" class="router-link-active router-link-exact-active sidebar-item" aria-label="创建套接字"><!--[--><!--]--> 创建套接字 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置网络地址" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置网络地址"><!--[--><!--]--> 设置网络地址 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#网络字节序和主机字节序" class="router-link-active router-link-exact-active sidebar-item" aria-label="网络字节序和主机字节序"><!--[--><!--]--> 网络字节序和主机字节序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#点分十进制的-ipv4-或-ipv6-地址字符串和二进制格式互转" class="router-link-active router-link-exact-active sidebar-item" aria-label="点分十进制的 IPv4 或 IPv6 地址字符串和二进制格式互转"><!--[--><!--]--> 点分十进制的 IPv4 或 IPv6 地址字符串和二进制格式互转 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#点分十进制地址转二进制-inet-pton" class="router-link-active router-link-exact-active sidebar-item" aria-label="点分十进制地址转二进制 inet_pton"><!--[--><!--]--> 点分十进制地址转二进制 inet_pton <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#二进制地址转点分十进制-inet-ntop" class="router-link-active router-link-exact-active sidebar-item" aria-label="二进制地址转点分十进制 inet_ntop"><!--[--><!--]--> 二进制地址转点分十进制 inet_ntop <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#二进制ipv4地址转点分十进制-inet-ntoa" class="router-link-active router-link-exact-active sidebar-item" aria-label="二进制IPv4地址转点分十进制 inet_ntoa"><!--[--><!--]--> 二进制IPv4地址转点分十进制 inet_ntoa <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#点分十进制ipv4地址转二进制-inet-aton" class="router-link-active router-link-exact-active sidebar-item" aria-label="点分十进制IPv4地址转二进制 inet_aton"><!--[--><!--]--> 点分十进制IPv4地址转二进制 inet_aton <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#设置套接字选项-setsockopt" class="router-link-active router-link-exact-active sidebar-item" aria-label="设置套接字选项 setsockopt"><!--[--><!--]--> 设置套接字选项 setsockopt <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#绑定套接字-bind" class="router-link-active router-link-exact-active sidebar-item" aria-label="绑定套接字 bind"><!--[--><!--]--> 绑定套接字 bind <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#监听连接请求-listen" class="router-link-active router-link-exact-active sidebar-item" aria-label="监听连接请求 listen"><!--[--><!--]--> 监听连接请求 listen <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#接受客户端请求-accept" class="router-link-active router-link-exact-active sidebar-item" aria-label="接受客户端请求 accept"><!--[--><!--]--> 接受客户端请求 accept <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#与服务器建立连接-connect" class="router-link-active router-link-exact-active sidebar-item" aria-label="与服务器建立连接 connect"><!--[--><!--]--> 与服务器建立连接 connect <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#收发数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="收发数据"><!--[--><!--]--> 收发数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#简单-tcp-服务器-客户端实例" class="router-link-active router-link-exact-active sidebar-item" aria-label="简单 TCP 服务器&amp;客户端实例"><!--[--><!--]--> 简单 TCP 服务器&amp;客户端实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#嵌入式linux网络编程基础" class="router-link-active router-link-exact-active sidebar-item" aria-label="嵌入式Linux网络编程基础"><!--[--><!--]--> 嵌入式Linux网络编程基础 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#wireshark" class="router-link-active router-link-exact-active sidebar-item" aria-label="Wireshark"><!--[--><!--]--> Wireshark <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#传输层tcp和udp" class="router-link-active router-link-exact-active sidebar-item" aria-label="传输层TCP和UDP"><!--[--><!--]--> 传输层TCP和UDP <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#osi七层模型和tcp-ip协议族" class="router-link-active router-link-exact-active sidebar-item" aria-label="OSI七层模型和TCP/IP协议族"><!--[--><!--]--> OSI七层模型和TCP/IP协议族 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp编程模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP编程模型"><!--[--><!--]--> TCP编程模型 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#客户端" class="router-link-active router-link-exact-active sidebar-item" aria-label="客户端"><!--[--><!--]--> 客户端 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#服务端" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务端"><!--[--><!--]--> 服务端 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp-三次握手和四次挥手" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP 三次握手和四次挥手"><!--[--><!--]--> TCP 三次握手和四次挥手 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp-报文段首部格式" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP 报文段首部格式"><!--[--><!--]--> TCP 报文段首部格式 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp-三次握手建立连接" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP 三次握手建立连接"><!--[--><!--]--> TCP 三次握手建立连接 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#三次握手过程详解" class="router-link-active router-link-exact-active sidebar-item" aria-label="三次握手过程详解"><!--[--><!--]--> 三次握手过程详解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#什么要三次握手" class="router-link-active router-link-exact-active sidebar-item" aria-label="什么要三次握手"><!--[--><!--]--> 什么要三次握手 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#isn-initial-sequence-number-是固定的吗" class="router-link-active router-link-exact-active sidebar-item" aria-label="ISN (Initial Sequence Number) 是固定的吗"><!--[--><!--]--> ISN (Initial Sequence Number) 是固定的吗 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#三次握手过程中可以携带数据吗" class="router-link-active router-link-exact-active sidebar-item" aria-label="三次握手过程中可以携带数据吗"><!--[--><!--]--> 三次握手过程中可以携带数据吗 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#半连接队列" class="router-link-active router-link-exact-active sidebar-item" aria-label="半连接队列"><!--[--><!--]--> 半连接队列 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#syn-洪泛攻击" class="router-link-active router-link-exact-active sidebar-item" aria-label="SYN 洪泛攻击"><!--[--><!--]--> SYN 洪泛攻击 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#如果第三次握手丢失了-客户端服务端会如何处理" class="router-link-active router-link-exact-active sidebar-item" aria-label="如果第三次握手丢失了，客户端服务端会如何处理"><!--[--><!--]--> 如果第三次握手丢失了，客户端服务端会如何处理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp-四次挥手释放连接" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP 四次挥手释放连接"><!--[--><!--]--> TCP 四次挥手释放连接 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#为什么要四次挥手" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要四次挥手"><!--[--><!--]--> 为什么要四次挥手 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#socket-io-多路复用" class="router-link-active router-link-exact-active sidebar-item" aria-label="Socket IO 多路复用"><!--[--><!--]--> Socket IO 多路复用 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#select" class="router-link-active router-link-exact-active sidebar-item" aria-label="select"><!--[--><!--]--> select <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#epoll" class="router-link-active router-link-exact-active sidebar-item" aria-label="epoll"><!--[--><!--]--> epoll <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#原始套接字" class="router-link-active router-link-exact-active sidebar-item" aria-label="原始套接字"><!--[--><!--]--> 原始套接字 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#以太网帧" class="router-link-active router-link-exact-active sidebar-item" aria-label="以太网帧"><!--[--><!--]--> 以太网帧 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#ip-头部" class="router-link-active router-link-exact-active sidebar-item" aria-label="IP 头部"><!--[--><!--]--> IP 头部 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#tcp-头部" class="router-link-active router-link-exact-active sidebar-item" aria-label="TCP 头部"><!--[--><!--]--> TCP 头部 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#协议衍生" class="router-link-active router-link-exact-active sidebar-item" aria-label="协议衍生"><!--[--><!--]--> 协议衍生 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#操作原始套接字" class="router-link-active router-link-exact-active sidebar-item" aria-label="操作原始套接字"><!--[--><!--]--> 操作原始套接字 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#简单示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="简单示例"><!--[--><!--]--> 简单示例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#伪造ip头-伪造ip地址示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="伪造IP头｜伪造IP地址示例"><!--[--><!--]--> 伪造IP头｜伪造IP地址示例 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#icmp-协议示例" class="router-link-active router-link-exact-active sidebar-item" aria-label="icmp 协议示例"><!--[--><!--]--> icmp 协议示例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/my-vuepress-blog/note/Linux.html#单播、广播、组播" class="router-link-active router-link-exact-active sidebar-item" aria-label="单播、广播、组播"><!--[--><!--]--> 单播、广播、组播 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="linux" tabindex="-1"><a class="header-anchor" href="#linux" aria-hidden="true">#</a> Linux</h1><p>查看Linux内核版本</p><p><code>cat /proc/version</code></p><blockquote><p>/proc目录存储的是当前内核运行状态的一系列特殊文件,包括:内存、CPU内核、已安装文件系统等信息。</p><p>而正在运行的内核的信息存储在/proc/version虚拟文件中,我们可以使用cat命令查看。</p></blockquote><p>显示操作系统信息</p><p><code>uname –a</code></p><ul><li>文件管理</li><li>进程管理</li><li>设备管理</li><li>内存管理</li><li>网络管理</li></ul><h2 id="pcb" tabindex="-1"><a class="header-anchor" href="#pcb" aria-hidden="true">#</a> PCB</h2><p>PCB（进程控制块，Process Control Block）是操作系统中用于管理进程信息的数据结构。每个进程在操作系统中都有一个相应的 PCB，PCB 存储了与该进程有关的重要信息，包括进程状态、程序计数器、寄存器值、进程ID、父进程ID、打开文件的列表、信号处理信息等。</p><p>PCB 的主要作用是跟踪和管理进程的状态，以及为操作系统提供有关进程的所有必要信息。当操作系统进行进程切换时，会保存当前进程的 PCB 状态，并加载下一个进程的 PCB，以便继续执行。</p><h2 id="位图机制" tabindex="-1"><a class="header-anchor" href="#位图机制" aria-hidden="true">#</a> 位图机制</h2><p>位图机制是一种用位来表示某些信息或状态的技术。在计算机科学和操作系统中，位图常常用于表示一组开关、标志或状态，每个位都对应一项信息。</p><p>在操作系统中，位图机制经常用于管理资源分配、文件系统等方面。以下是一些位图机制的常见应用：</p><ol><li><strong>内存管理：</strong> 位图可以用来表示内存页面的分配情况。每个位对应一个内存页面，位值为1表示页面已分配，为0表示未分配。</li><li><strong>文件系统：</strong> 文件系统中的位图可以表示存储块的使用情况。每个位对应一个存储块，位值为1表示存储块已分配，为0表示未分配。</li><li><strong>进程管理：</strong> 位图可以用于表示进程的状态，比如就绪、运行、阻塞等。每个位对应一个进程，位值表示相应的状态。</li><li><strong>设备管理：</strong> 位图可以用于表示设备的使用情况，例如磁盘上的扇区、网络中的端口等。每个位对应一个设备单元，位值为1表示已分配，为0表示未分配。</li><li><strong>权限管理：</strong> 在访问控制中，位图可以表示用户或用户组对文件或资源的权限。每个位表示一个权限，位值为1表示拥有相应权限，为0表示没有。</li></ol><h2 id="文件空洞" tabindex="-1"><a class="header-anchor" href="#文件空洞" aria-hidden="true">#</a> 文件空洞</h2><p>文件空洞是指在文件中分配了一段空间，但实际上并没有实际写入数据，这样的操作可以通过设置偏移量来实现，具体可以使用 <code>lseek</code> 函数来进行操作。</p><ul><li><p>创建文件空洞步骤：</p><ol><li>打开文件。</li><li>使用 <code>lseek</code> 将偏移量设置到一个比文件大小大的位置。</li><li>执行写入操作（即使写入为空）。</li></ol></li><li><p>文件空洞特点：</p><ul><li>不占用实际磁盘空间。</li><li>通过文件系统记录其存在。</li></ul></li></ul><!---->并非所有文件系统都支持文件空洞，需根据实际情况选择使用。<h2 id="页缓存" tabindex="-1"><a class="header-anchor" href="#页缓存" aria-hidden="true">#</a> 页缓存</h2><p>页缓存是操作系统中的一种内存管理机制，用于提高文件系统的访问性能。在页缓存中，磁盘上的文件数据被缓存到系统的内存中，从而加速对文件的读写操作。</p><p>基本思想是将文件数据分割成固定大小的块，称为“页”，通常大小为4KB。这些页被加载到系统的物理内存中，并且文件的访问将在内存中进行，而不是直接从磁盘读取。</p><p>当程序请求访问文件时，操作系统首先检查页缓存中是否已经存在文件的相应页。如果存在，系统直接从内存中读取数据，而不是从磁盘。这可以显著提高文件访问速度，因为内存访问通常比磁盘访问更快。</p><p>如果请求的数据不在页缓存中，系统将从磁盘读取相应的页，并将其加载到内存中。这样，在未来的访问中，相同的数据将在页缓存中可用。</p><p>页缓存的好处包括：</p><ol><li><strong>提高性能：</strong> 通过减少对磁盘的直接访问，加速了文件的读写操作。</li><li><strong>减少磁盘 I/O：</strong> 避免了每次访问文件都要进行磁盘 I/O 操作，降低了对磁盘的负载。</li><li><strong>利用空闲内存：</strong> 将空闲的物理内存用于缓存文件数据，充分利用系统的内存资源。</li></ol><p>不过，页缓存也有一些潜在的问题，例如缓存一致性、缓存过期策略等。在一些特定场景下，可能需要通过操作系统提供的相关接口进行手动的控制和管理。</p><h2 id="脏页" tabindex="-1"><a class="header-anchor" href="#脏页" aria-hidden="true">#</a> 脏页</h2><p>脏页是指页缓存中的一个页面，其内容已经被修改，但这些修改尚未被写回到磁盘。当应用程序修改了一个页的内容时，操作系统会将这个页标记为“脏页”。</p><p>在页缓存中，每个页面都有一个相关的状态标志，用来指示该页的状态。常见的状态标志包括：</p><ul><li><strong>脏页（Dirty Page）：</strong> 表示该页的内容已经被修改。</li><li><strong>干净页（Clean Page）：</strong> 表示该页的内容没有被修改。</li></ul><p>当一个脏页需要被写回到磁盘时，这通常发生在以下情况之一：</p><ol><li><strong>同步写回（Synchronous Writeback）：</strong> 操作系统立即将脏页写回磁盘，以确保数据的一致性。这通常在文件写操作完成后进行。</li><li><strong>异步写回（Asynchronous Writeback）：</strong> 操作系统延迟写回脏页，以提高性能。这些写回操作可能会在系统空闲时进行，或者通过一些策略（例如脏页数量达到一定阈值）触发。</li></ol><p>脏页的概念是为了优化文件系统的性能。通过延迟写回，系统可以更有效地利用内存缓存，减少频繁的磁盘 I/O 操作。但同时，需要确保在必要时，所有的修改都会被正确地同步到磁盘，以保持数据的一致性。</p><p>对于管理脏页，操作系统通常提供了相应的接口和策略。一些常见的命令行工具如<code>sync</code>可以用来强制将脏页写回磁盘。在编程中，一些系统调用和库函数也提供了控制脏页的手段。</p><h2 id="虚拟文件系统-virtual-file-system-vfs" tabindex="-1"><a class="header-anchor" href="#虚拟文件系统-virtual-file-system-vfs" aria-hidden="true">#</a> 虚拟文件系统（Virtual File System，VFS）</h2><p>虚拟文件系统（Virtual File System，VFS）是操作系统中的一个抽象层，它提供了一个通用的文件系统接口，使得不同类型的文件系统可以被统一地访问和操作。VFS允许应用程序和系统内核与文件系统交互，而无需了解底层文件系统的具体实现。</p><p>以下是虚拟文件系统的一些关键概念和特点：</p><ol><li><strong>抽象接口：</strong> VFS 提供了一个抽象的文件系统接口，定义了文件和目录操作的标准操作，例如打开、关闭、读取、写入、创建和删除等。</li><li><strong>多文件系统支持：</strong> VFS 允许系统同时支持多个不同类型的文件系统，如ext4、NTFS、FAT32等。这使得操作系统能够访问和管理不同格式的存储介质，如硬盘、固态硬盘、CD-ROM等。</li><li><strong>统一路径表示：</strong> 不同文件系统可能有不同的路径表示方式，VFS 提供了一个统一的路径命名规范，使得应用程序和系统内核可以使用相同的路径访问文件。</li><li><strong>文件描述符：</strong> VFS 使用文件描述符来表示打开的文件，这些文件描述符允许系统内核追踪每个打开文件的状态，包括当前的读写位置等信息。</li><li><strong>虚拟目录树：</strong> VFS 维护一个虚拟的目录树，该目录树包含所有已挂载的文件系统。通过挂载，文件系统可以被动态地加入到虚拟目录树中。</li><li><strong>系统调用：</strong> 操作系统通过一组标准的系统调用提供文件系统的功能，这些系统调用被应用程序和用户空间程序用于访问和操作文件。</li><li><strong>挂载和卸载：</strong> VFS 支持文件系统的挂载和卸载操作。挂载将一个文件系统连接到虚拟目录树的某个位置，而卸载则断开这个连接。</li><li><strong>网络文件系统支持：</strong> VFS 支持网络文件系统，允许远程计算机上的文件系统通过网络进行访问。</li></ol><p>Linux、UNIX 和一些其他类 UNIX 操作系统都采用了虚拟文件系统的设计，以实现文件系统的可扩展性和灵活性。 VFS 是一个重要的操作系统组件，它使得不同文件系统可以在同一个系统中协同工作。</p><h2 id="mmu-内存管理单元" tabindex="-1"><a class="header-anchor" href="#mmu-内存管理单元" aria-hidden="true">#</a> MMU （内存管理单元）</h2><p>MMU（内存管理单元）的工作原理涉及虚拟内存和物理内存的映射，以及访问权限的控制。</p><ol><li><strong>地址映射：</strong> MMU负责将程序使用的虚拟地址映射到实际的物理地址上。想象一下，你有一本地图（页表），上面标注了虚拟地址和对应的物理地址。MMU就像使用这张地图的导航系统，根据虚拟地址找到对应的物理地址。</li><li><strong>分页：</strong> 内存被划分成小块，称为页。虚拟内存和物理内存都被分成相同大小的页。当程序访问一个虚拟地址时，MMU知道这个地址所属的页，然后查找页表，找到对应的物理页。</li><li><strong>页表：</strong> 页表是一个数据结构，保存了虚拟地址到物理地址的映射关系。MMU使用页表来进行地址翻译。如果一个虚拟页不在物理内存中，就发生了缺页中断，操作系统负责将相应的物理页加载到内存中。</li><li><strong>访问权限控制：</strong> MMU也负责管理内存的访问权限。每个页表项中包含了一些标志，用于指定对应页的访问权限，例如读、写、执行权限。如果程序尝试执行一些未授权的操作，MMU将阻止这些操作并触发相应的异常。</li></ol><p>总的来说，MMU的工作原理就是通过页表进行虚拟地址到物理地址的映射，实现对虚拟内存的访问和管理。这种机制使得计算机能够更灵活、高效地使用内存，同时提供了对内存的保护和隔离。</p><p><strong>页表是什么？</strong></p><p>页表是一种数据结构，用于存储虚拟地址和物理地址之间的映射关系。在虚拟内存系统中，内存被划分成固定大小的页面，页表记录了每个页面的映射关系。当程序访问虚拟地址时，操作系统通过页表将其映射到对应的物理地址。</p><p><strong>如何工作？</strong></p><ol><li><strong>分页：</strong> 内存和虚拟内存都被分成固定大小的页面，通常是4KB。这些页面在虚拟内存和物理内存之间建立映射。</li><li><strong>页表项：</strong> 页表由一系列页表项组成，每个页表项存储一个虚拟页面和对应的物理页面的映射关系。其中，包括物理地址、访问权限、脏页位等信息。</li><li><strong>多级页表：</strong> 为了节省空间，页表可以采用多级结构。例如，一级页表记录了二级页表的起始地址，而二级页表记录了实际的映射关系。这种多级结构允许系统更灵活地管理大型的地址空间。</li><li><strong>地址转换：</strong> 当程序访问虚拟地址时，MMU（内存管理单元）会使用页表进行地址转换。MMU根据虚拟地址的高位索引到相应的页表，然后再根据低位找到对应的物理地址。</li><li><strong>缺页中断：</strong> 如果虚拟页面对应的物理页面不在内存中，会发生<code>缺页(Page Fault Interrupt)</code>中断。操作系统会将缺失的页面加载到内存，并更新页表。</li></ol><p><strong>优势：</strong></p><ol><li><strong>内存隔离：</strong> 通过页表，每个程序都有自己的虚拟地址空间，不受其他程序的影响，提高了内存的隔离性。</li><li><strong>虚拟内存：</strong> 页表允许实现虚拟内存，将部分程序暂时存储在磁盘上，以释放物理内存，从而提高整体系统的性能和可用性。</li><li><strong>访问权限控制：</strong> 通过页表中的权限位，操作系统可以对每个页面设置不同的访问权限，增强了对内存的控制。</li></ol><p><strong>缺页（Page Fault）</strong></p><p>缺页（Page Fault）是指程序在访问虚拟内存中的某个页面时，该页面当前不在物理内存中。这时候，操作系统需要将相应的页面从磁盘或其他存储介质中加载到物理内存，以满足程序的访问需求。</p><p>当一个程序访问某个虚拟地址时，操作系统会检查相应的页表，以确定该虚拟地址对应的物理地址是否在内存中。如果对应的页面不在内存中，就发生了缺页。</p><p>缺页的处理一般包括以下步骤：</p><ol><li><strong>页表查找：</strong> 操作系统检查页表，确定缺页的虚拟地址对应的页面是否在物理内存中。</li><li><strong>缺页中断（Page Fault Interrupt）：</strong> 如果页面不在内存中，操作系统会产生一个缺页中断。这时控制权交回给操作系统内核。</li><li><strong>加载页面：</strong> 操作系统会从磁盘或其他存储介质中加载缺失的页面到物理内存中。这可能涉及到页面的读取、写入和更新页表等操作。</li><li><strong>更新页表：</strong> 操作系统更新页表，将虚拟地址映射到新加载的页面。</li><li><strong>重新执行指令：</strong> 一旦缺页处理完成，控制权返回到程序，并重新执行触发缺页的指令。</li></ol><p>缺页处理是虚拟内存管理的一个关键部分。它允许系统有效地使用有限的物理内存，将常用的页面保留在内存中，而将不常用的页面存储在磁盘上。这样，即使程序的虚拟地址空间很大，实际需要的物理内存却可以被灵活管理。</p><p>虚拟内存系统的设计使得程序能够以更大的虚拟地址空间运行，而无需足够大的物理内存。缺页处理允许操作系统动态地将数据从磁盘加载到内存，从而实现更好的性能和资源利用。</p><p>CPU 与 MMU（内存管理单元）之间的通信是通过地址总线、数据总线和控制总线来实现的。下面简要说明这些总线的作用：</p><ol><li><strong>地址总线：</strong> 地址总线用于传送 CPU 发出的内存地址信号。CPU 通过地址总线告诉 MMU 它要访问的内存地址。地址总线的宽度决定了 CPU 能够寻址的地址范围，例如一个32位地址总线可以寻址的地址范围是 2^32 个地址。</li><li><strong>数据总线：</strong> 数据总线用于传送 CPU 和内存之间的数据。CPU 通过数据总线读取或写入内存中的数据。数据总线的宽度决定了每次数据传输的位数，例如一个32位数据总线可以一次传输32位的数据。</li><li><strong>控制总线：</strong> 控制总线用于传送控制信号，它包括一系列信号线，用于控制数据的读写、地址的选择、总线的状态等。控制总线上的信号由 CPU 发送给 MMU，以告知 MMU 当前的操作是读取还是写入，以及其他相关的控制信息。</li></ol><p>在访问内存时，CPU 通过地址总线发送虚拟地址给 MMU。MMU 根据页表等信息将虚拟地址转换为物理地址，并通过地址总线将物理地址发送到内存中。然后，通过数据总线进行读取或写入操作。控制总线用于协调这一系列操作。</p><p>这整个过程使得 CPU 能够和 MMU 交互，实现对内存的访问和管理。在虚拟内存系统中，MMU 还负责虚拟地址到物理地址的映射，通过页表等数据结构来完成这个映射。 CPU 和 MMU 的协同工作是计算机系统中内存管理的关键部分。</p><p>页表是由操作系统负责管理和维护的数据结构，用于存储虚拟地址到物理地址的映射关系。下面是页表的基本生成和管理过程：</p><ol><li><strong>操作系统初始化：</strong> 在计算机系统启动时，操作系统会初始化页表。这个初始化过程包括建立空的页表，确定虚拟地址和物理地址的映射关系。</li><li><strong>分页：</strong> 内存被划分成固定大小的页面，通常为4KB。每个页面有一个唯一的物理地址。</li><li><strong>建立映射：</strong> 操作系统通过将虚拟地址和对应的物理地址建立映射关系来填充页表。这通常发生<strong>在程序启动时或在程序运行时的动态分配内存时</strong>。</li><li><strong>多级页表：</strong> 为了降低页表的存储开销，一些系统采用多级页表的结构。在这种结构中，页表分层存储，每一级的页表项指向下一级的页表。这种多级结构允许系统更灵活地管理大型的地址空间。</li><li><strong>更新页表：</strong> 当程序访问虚拟地址时，MMU（内存管理单元）会使用页表进行地址转换。如果虚拟页面对应的物理页面不在内存中，就会发生缺页中断。操作系统负责将缺失的页面加载到内存，并更新页表中的映射关系。</li><li><strong>分配和回收：</strong> 当程序动态申请内存或释放内存时，操作系统需要动态地更新页表。例如，当程序调用 <code>malloc</code> 分配内存时，操作系统会更新页表，建立新的虚拟地址到物理地址的映射关系。</li></ol><h2 id="信号" tabindex="-1"><a class="header-anchor" href="#信号" aria-hidden="true">#</a> 信号</h2><h3 id="什么是信号" tabindex="-1"><a class="header-anchor" href="#什么是信号" aria-hidden="true">#</a> 什么是信号</h3><p>信号是 Linux 进程间通信的最古老的方式之一，是事件发生时对进程的通知机制，有时也称之为软件中断，它是在软件层次上对中断机制的一种模拟，是一种异步通信的方式。信号可以导致一个正在运行的进程被另一个正在运行的异步进程中断，转而处理某一个突发事件。</p><p>发往进程的诸多信号，通常都是源于内核。引发内核为进程产生信号的各类事件如下：</p><p>对于前台进程，用户可以通过输入特殊的终端字符来给它发送信号。比如输入Ctrl+C 通常会给进程发送一个中断信号。</p><p>硬件发生异常，即硬件检测到一个错误条件并通知内核，随即再由内核发送相应信号给相关进程。比如执行一条异常的机器语言指令，诸如被 0 除，或者引用了无法访问的内存区域。</p><p>系统状态变化，比如 alarm 定时器到期将引起 SIGALRM 信号，进程执行的 CPU时间超限，或者该进程的某个子进程退出。</p><p>运行 kill 命令或调用 kill 函数。</p><p>使用信号的两个主要目的是： 让进程知道已经发生了一个特定的事情。 强迫进程执行它自己代码中的信号处理程序。 信号的特点：</p><p>简单、不能携带大量信息、满足某个特定条件才发送、优先级比较高。</p><p>查看系统定义的信号列表：<code>kill –l</code>，前 31 个信号为常规信号，其余为实时信号。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># kill -l</span>
 <span class="token number">1</span><span class="token punctuation">)</span> SIGHUP	 <span class="token number">2</span><span class="token punctuation">)</span> SIGINT	 <span class="token number">3</span><span class="token punctuation">)</span> SIGQUIT	 <span class="token number">4</span><span class="token punctuation">)</span> SIGILL	 <span class="token number">5</span><span class="token punctuation">)</span> SIGTRAP
 <span class="token number">6</span><span class="token punctuation">)</span> SIGABRT	 <span class="token number">7</span><span class="token punctuation">)</span> SIGBUS	 <span class="token number">8</span><span class="token punctuation">)</span> SIGFPE	 <span class="token number">9</span><span class="token punctuation">)</span> SIGKILL	<span class="token number">10</span><span class="token punctuation">)</span> SIGUSR1
<span class="token number">11</span><span class="token punctuation">)</span> SIGSEGV	<span class="token number">12</span><span class="token punctuation">)</span> SIGUSR2	<span class="token number">13</span><span class="token punctuation">)</span> SIGPIPE	<span class="token number">14</span><span class="token punctuation">)</span> SIGALRM	<span class="token number">15</span><span class="token punctuation">)</span> SIGTERM
<span class="token number">16</span><span class="token punctuation">)</span> SIGSTKFLT	<span class="token number">17</span><span class="token punctuation">)</span> SIGCHLD	<span class="token number">18</span><span class="token punctuation">)</span> SIGCONT	<span class="token number">19</span><span class="token punctuation">)</span> SIGSTOP	<span class="token number">20</span><span class="token punctuation">)</span> SIGTSTP
<span class="token number">21</span><span class="token punctuation">)</span> SIGTTIN	<span class="token number">22</span><span class="token punctuation">)</span> SIGTTOU	<span class="token number">23</span><span class="token punctuation">)</span> SIGURG	<span class="token number">24</span><span class="token punctuation">)</span> SIGXCPU	<span class="token number">25</span><span class="token punctuation">)</span> SIGXFSZ
<span class="token number">26</span><span class="token punctuation">)</span> SIGVTALRM	<span class="token number">27</span><span class="token punctuation">)</span> SIGPROF	<span class="token number">28</span><span class="token punctuation">)</span> SIGWINCH	<span class="token number">29</span><span class="token punctuation">)</span> SIGIO	<span class="token number">30</span><span class="token punctuation">)</span> SIGPWR
<span class="token number">31</span><span class="token punctuation">)</span> SIGSYS	<span class="token number">34</span><span class="token punctuation">)</span> SIGRTMIN	<span class="token number">35</span><span class="token punctuation">)</span> SIGRTMIN+1	<span class="token number">36</span><span class="token punctuation">)</span> SIGRTMIN+2	<span class="token number">37</span><span class="token punctuation">)</span> SIGRTMIN+3
<span class="token number">38</span><span class="token punctuation">)</span> SIGRTMIN+4	<span class="token number">39</span><span class="token punctuation">)</span> SIGRTMIN+5	<span class="token number">40</span><span class="token punctuation">)</span> SIGRTMIN+6	<span class="token number">41</span><span class="token punctuation">)</span> SIGRTMIN+7	<span class="token number">42</span><span class="token punctuation">)</span> SIGRTMIN+8
<span class="token number">43</span><span class="token punctuation">)</span> SIGRTMIN+9	<span class="token number">44</span><span class="token punctuation">)</span> SIGRTMIN+10	<span class="token number">45</span><span class="token punctuation">)</span> SIGRTMIN+11	<span class="token number">46</span><span class="token punctuation">)</span> SIGRTMIN+12	<span class="token number">47</span><span class="token punctuation">)</span> SIGRTMIN+13
<span class="token number">48</span><span class="token punctuation">)</span> SIGRTMIN+14	<span class="token number">49</span><span class="token punctuation">)</span> SIGRTMIN+15	<span class="token number">50</span><span class="token punctuation">)</span> SIGRTMAX-14	<span class="token number">51</span><span class="token punctuation">)</span> SIGRTMAX-13	<span class="token number">52</span><span class="token punctuation">)</span> SIGRTMAX-12
<span class="token number">53</span><span class="token punctuation">)</span> SIGRTMAX-11	<span class="token number">54</span><span class="token punctuation">)</span> SIGRTMAX-10	<span class="token number">55</span><span class="token punctuation">)</span> SIGRTMAX-9	<span class="token number">56</span><span class="token punctuation">)</span> SIGRTMAX-8	<span class="token number">57</span><span class="token punctuation">)</span> SIGRTMAX-7
<span class="token number">58</span><span class="token punctuation">)</span> SIGRTMAX-6	<span class="token number">59</span><span class="token punctuation">)</span> SIGRTMAX-5	<span class="token number">60</span><span class="token punctuation">)</span> SIGRTMAX-4	<span class="token number">61</span><span class="token punctuation">)</span> SIGRTMAX-3	<span class="token number">62</span><span class="token punctuation">)</span> SIGRTMAX-2
<span class="token number">63</span><span class="token punctuation">)</span> SIGRTMAX-1	<span class="token number">64</span><span class="token punctuation">)</span> SIGRTMAX
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看信号的详细信息：<code>man 7 signal</code></p><p>信号的 5 种默认处理动作：</p><ol><li>Term 终止进程</li><li>Ign 当前进程忽略掉这个信号</li><li>Core 终止进程，并生成一个Core文件</li><li>Stop 暂停当前进程</li><li>Cont 继续执行当前被暂停的进程</li></ol><p>信号的几种状态：产生、未决、递达</p><p><code>SIGKILL</code> 和 <code>SIGSTOP</code> 信号不能被捕捉、阻塞或者忽略，只能执行默认动作。</p><h3 id="异常终止" tabindex="-1"><a class="header-anchor" href="#异常终止" aria-hidden="true">#</a> 异常终止</h3><p>当进程执行了某些在系统看来具有危险性的操作，或系统本身发生了某种故障或意外，内核会向相关进程发送特定的信号。如果进程无意针对收到的信号采取补救措施，那么内核将按照缺省方式将进程杀死，并视情形生成核心转储文件(core)以备事后分析，俗称<strong>吐核</strong></p><blockquote><p><code>SIGILL(4)</code>: 进程试图执行非法指令</p><p><code>SIGBUS(7)</code>: 硬件错误或对齐错误</p><p><code>SIGFPE(8)</code>: 浮点运算错误</p><p><code>SIGSEGV(11)</code>: 无效的内存访问</p><p><code>SIGPWR(30)</code>: 系统电源故障</p></blockquote><h3 id="人为触发信号" tabindex="-1"><a class="header-anchor" href="#人为触发信号" aria-hidden="true">#</a> 人为触发信号</h3><blockquote><p><code>SIGINT(2)</code>: Ctrl+C</p><p><code>SIGQUIT(3)</code>: Ctrl+\</p><p><code>SIGKILL(9)</code>: 不能被捕获或忽略的进程终止信号</p><p><code>SIGTERM(15)</code>: 可以被捕获或忽略的进程终止信号</p></blockquote><ol><li><strong>SIGHUP (1):</strong> 挂起或控制终端关闭。</li><li><strong>SIGINT (2):</strong> 中断信号，通常由键盘输入 <code>Ctrl+C</code> 生成。</li><li><strong>SIGQUIT (3):</strong> 退出信号，通常由键盘输入 <code>Ctrl+\</code> 生成。</li><li><strong>SIGILL (4):</strong> 非法指令。</li><li><strong>SIGTRAP (5):</strong> 跟踪/断点陷阱。</li><li><strong>SIGABRT (6):</strong> 中止信号，通常由调用 <code>abort</code> 函数生成。</li><li><strong>SIGBUS (7):</strong> 总线错误。</li><li><strong>SIGFPE (8):</strong> 浮点异常。</li><li><strong>SIGKILL (9):</strong> 强制终止进程。</li><li><strong>SIGUSR1 (10):</strong> 用户定义信号1。</li><li><strong>SIGSEGV (11):</strong> 段错误，通常表示内存访问越界。</li><li><strong>SIGUSR2 (12):</strong> 用户定义信号2。</li><li><strong>SIGPIPE (13):</strong> 管道破裂。</li><li><strong>SIGALRM (14):</strong> 定时器信号。</li><li><strong>SIGTERM (15):</strong> 终止信号，用于请求进程正常终止。</li><li><strong>SIGCHLD (17):</strong> 子进程终止或停止，父进程接收到这个信号。</li><li><strong>SIGCONT (18):</strong> 继续运行已停止的进程。</li><li><strong>SIGSTOP (19):</strong> 停止信号，用于暂停进程的执行。</li><li><strong>SIGTSTP (20):</strong> 终端停止信号，通常由键盘输入 <code>Ctrl+Z</code> 生成。</li><li><strong>SIGTTIN (21):</strong> 后台进程请求输入。</li><li><strong>SIGTTOU (22):</strong> 后台进程请求输出。</li><li><strong>SIGURG (23):</strong> 紧急情况信号。</li><li><strong>SIGXCPU (24):</strong> 超过CPU时间限制。</li><li><strong>SIGXFSZ (25):</strong> 超过文件大小限制。</li><li><strong>SIGVTALRM (26):</strong> 虚拟定时器信号。</li><li><strong>SIGPROF (27):</strong> 进程定时器信号。</li><li><strong>SIGWINCH (28):</strong> 窗口大小改变信号。</li><li><strong>SIGIO (29):</strong> 异步IO事件发生。</li><li><strong>SIGPWR (30):</strong> 电源故障信号。</li><li><strong>SIGSYS (31):</strong> 非法系统调用。</li><li><strong>SIGRTMIN (34):</strong> 实时信号的最小值。</li><li><strong>SIGRTMAX (64):</strong> 实时信号的最大值</li></ol><p><strong>这里只列出了一部分信号，实际上有更多的信号可用。在实际编程中，通常使用 <code>man</code> 命令查看特定信号的详细信息，例如 <code>man 7 signal</code>。</strong></p><h3 id="信号相关函数" tabindex="-1"><a class="header-anchor" href="#信号相关函数" aria-hidden="true">#</a> 信号相关函数</h3><p>头文件</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="kill" tabindex="-1"><a class="header-anchor" href="#kill" aria-hidden="true">#</a> kill</h4><p><code>int kill(pid_t pid, int sig);</code> 给任何的进程或者进程组pid, 发送任何的信号 sig</p><ul><li><code>pid</code><ul><li><code>&gt; 0 </code> 发送信号给指定进程ID的进程。</li><li><code>= 0</code> 发送信号给与调用进程属于同一进程组的所有进程。</li><li><code>= -1</code> 发送信号给调用进程有权限发送信号的所有进程。</li><li><code>&lt; -1</code> 发送信号给与指定进程组ID相等的所有进程。</li></ul></li><li><code>sig</code> 需要发送的信号的编号或者是宏值，0表示不发送任何信号</li></ul><h4 id="raise" tabindex="-1"><a class="header-anchor" href="#raise" aria-hidden="true">#</a> raise</h4><p><code>int raise(int sig);</code> 给当前进程发送信号</p><ul><li><code>sig</code> 要发送的信号</li><li><code>return </code> 成功 0，失败 非0</li></ul><h4 id="abort" tabindex="-1"><a class="header-anchor" href="#abort" aria-hidden="true">#</a> abort</h4><p><code>void abort(void);</code> 发送 SIGABRT 信号给当前的进程，杀死当前进程，相当于 <code>kill(getpid(), SIGABRT);</code></p><p>例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child process\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent process\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;kill child process now\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>fork()</code> 函数在父进程中返回子进程的进程ID，而在子进程中返回0。如果<code>fork()</code>失败，返回-1。所以，当你执行 <code>pid = fork();</code> 后，<code>pid</code> 的值会有三种情况：</p><ul><li><strong>pid &gt; 0：</strong> 这是在父进程中，<code>pid</code> 的值是新创建子进程的进程ID。</li><li><strong>pid == 0：</strong> 这是在子进程中，<code>pid</code> 的值为0。</li><li><strong>pid == -1：</strong> 这是 <code>fork()</code> 失败的情况。</li></ul></blockquote><h4 id="pause" tabindex="-1"><a class="header-anchor" href="#pause" aria-hidden="true">#</a> pause</h4><p><code>int pause(void);</code> 是一个系统调用，通常用于使进程挂起（暂停）直到接收到一个信号。它位于 <code>&lt;unistd.h&gt;</code> 头文件中。</p><ul><li><code>return</code> 函数返回值为 -1，并设置 <code>errno</code> 为 <code>EINTR</code>（被信号中断），这是因为 <code>pause</code> 只有在接收到信号时才会返回，否则一直处于挂起状态。</li></ul><blockquote><p>主要用途是在程序中等待信号的到来，通常与信号处理函数一起使用。当进程执行到 <code>pause</code> 时，它将挂起等待，直到收到一个信号。一旦收到信号，进程将执行与该信号相关联的信号处理函数（如果已经注册了的话），然后从 <code>pause</code> 函数返回。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">signalHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received signal %d\n&quot;</span><span class="token punctuation">,</span> signo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册信号处理函数</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> signalHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for signal...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 进程挂起，等待信号的到来</span>
    <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Resumed after receiving signal.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="alarm" tabindex="-1"><a class="header-anchor" href="#alarm" aria-hidden="true">#</a> alarm</h4><p><code>unsigned int alarm(unsigned int seconds);</code> 设置定时器（闹钟）。函数调用，开始倒计时，当倒计时为0的时候，函数会给当前的进程发送一个信号：SIGALARM</p><ul><li><code>seconds</code> 倒计时的时长，单位：秒。如果参数为0，定时器无效（不进行倒计时，不发信号）。取消一个定时器，通过 alarm(0)。</li><li><code>return </code><ul><li>之前没有定时器，返回0</li><li>之前有定时器，返回之前的定时器剩余的时间</li></ul></li></ul><blockquote><p><code>SIGALARM</code> 信号默认终止当前的进程，每一个进程都有且只有唯一的一个定时器。</p><p><code>alarm(10);</code> -&gt; 返回 <code>0</code></p><p>过了<code>1</code>秒</p><p><code>alarm(5);</code> -&gt; 返回 <code>9</code></p><p><code>alarm(100)</code> -&gt; <strong>该函数是不阻塞的</strong></p></blockquote><p>示例：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;seconds = %d\n&quot;</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span>

    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seconds <span class="token operator">=</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 不阻塞</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;seconds = %d\n&quot;</span><span class="token punctuation">,</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="setitimer" tabindex="-1"><a class="header-anchor" href="#setitimer" aria-hidden="true">#</a> setitimer</h4><p><code>int setitimer(int which, const struct itimerval *new_value,struct itimerval *old_value);</code> 设置定时器（闹钟）。可以替代alarm函数。精度微妙 us，可以实现周期性定时</p><ul><li><p><code>which</code> 定时器以什么时间计时</p><ul><li><code>ITIMER_REAL</code> 真实时间，当时间到达发送 <code>SIGALRM</code> <strong>(常用)</strong></li><li><code>ITIMER_VIRTUAL</code> 用户时间，时间到达，发送 <code>SIGVTALRM</code></li><li><code>ITIMER_PROF</code> 以该进程在用户态和内核态下所消耗的时间来计算，时间到达，发送 <code>SIGPROF</code></li></ul></li><li><p><code>new_value</code> 设置定时器的属性</p><ul><li><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">itimerval</span> <span class="token punctuation">{</span>      <span class="token comment">// 定时器的结构体</span>
  <span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_interval<span class="token punctuation">;</span>  <span class="token comment">// 每个阶段的时间，间隔时间</span>
  <span class="token keyword">struct</span> <span class="token class-name">timeval</span> it_value<span class="token punctuation">;</span>     <span class="token comment">// 延迟多长时间执行定时器</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li></li></ul><pre><code>```c
struct timeval {        // 时间的结构体
    time_t      tv_sec;     //  秒数     
    suseconds_t tv_usec;    //  微秒    
};
```
</code></pre></li><li><p><code>old_value</code> 记录上一次的定时的时间参数，一般不使用，指定NULL</p></li><li><p><code>return</code> 成功 0,失败 -1 并设置错误号</p></li></ul><p>例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">timerHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> signo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Timer expired! Signo: %d\n&quot;</span><span class="token punctuation">,</span> signo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置定时器处理函数</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> timerHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>
    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		<span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;定时器开始了...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setitimer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./test
定时器开始了<span class="token punctuation">..</span>.
Timer expired<span class="token operator">!</span> Signo: <span class="token number">14</span>
Timer expired<span class="token operator">!</span> Signo: <span class="token number">14</span>
Timer expired<span class="token operator">!</span> Signo: <span class="token number">14</span>
Timer expired<span class="token operator">!</span> Signo: <span class="token number">14</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="signal" tabindex="-1"><a class="header-anchor" href="#signal" aria-hidden="true">#</a> signal</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token class-name">sighandler_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 函数指针，返回值是信号的编号</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>sighandler_t signal(int signum, sighandler_t handler);</code> 设置某个信号的捕捉行为</p><ul><li><code>signum</code> 要捕捉的信号</li><li><code>handler</code> 捕捉到信号要如何处理 <ul><li><code>SIG_IGN</code> 忽略信号</li><li><code>SIG_DFL</code> 使用信号默认的行为</li><li><code>回调函数</code> 这个函数是内核调用，程序员只负责写，捕捉到信号后如何去处理信号。</li></ul></li><li><code>return</code><ul><li>成功，返回上一次注册的信号处理函数的地址。第一次调用返回<code>NULL</code></li><li>失败，返回<code>SIG_ERR</code>，设置错误号</li></ul></li></ul><blockquote><p>SIGKILL SIGSTOP不能被捕捉，不能被忽略。</p></blockquote><p>例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myalarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;捕捉到了信号的编号是：%d\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxxxx\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册信号捕捉</span>
    <span class="token comment">// signal(SIGALRM, SIG_IGN);</span>
    <span class="token comment">// signal(SIGALRM, SIG_DFL);</span>
    <span class="token comment">// void (*sighandler_t)(int); 函数指针，int类型的参数表示捕捉到的信号的值。</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> myalarm<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 非阻塞的</span>
    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>
    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
	  <span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;定时器开始了...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setitimer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="信号集" tabindex="-1"><a class="header-anchor" href="#信号集" aria-hidden="true">#</a> 信号集</h3><p>许多信号相关的系统调用都需要能表示一组不同的信号，多个信号可使用一个称之为信号集的数据结构来表示，其系统数据类型为 sigset_t。</p><p>在 PCB 中有两个非常重要的信号集。一个称之为 “<strong>阻塞信号集</strong>” ，另一个称之为“<strong>未决信号集</strong>” 。这两个信号集都是内核使用位图机制来实现的。</p><p><strong>但操作系统不允许我们直接对这两个信号集进行位操作，而需自定义另外一个集合，借助信号集操作函数来对 PCB 中的这两个信号集进行修改</strong>。</p><p>信号的 “未决” 是一种状态，指的是信号已经发送给进程但尚未被处理的信号集。进程在某一时刻可以处理多个信号，未决信号集就是那些等待处理的信号的集合。</p><p>信号的 “阻塞” 是一个开关动作，指的是阻止信号被处理，但不是阻止信号产生。</p><p>信号的阻塞就是让系统暂时保留信号留待以后发送。由于另外有办法让系统忽略信号，所以一般情况下信号的阻塞只是暂时的，只是为了防止信号打断敏感的操作。</p><h4 id="信号集工作过程" tabindex="-1"><a class="header-anchor" href="#信号集工作过程" aria-hidden="true">#</a> 信号集工作过程</h4><ol><li><p>用户通过键盘 <code>Ctrl + C</code>, 产生 2 号信号 <code>SIGINT</code> (信号被创建)</p></li><li><p>信号产生但是没有被处理 （未决）</p><ul><li>在内核中将所有的没有被处理的信号存储在一个集合中 （未决信号集）</li><li><code>SIGINT</code> 信号状态被存储在第2个标志位上 <ul><li>这个标志位的值为<code>0</code>， 说明信号不是未决状态</li><li>这个标志位的值为<code>1</code>， 说明信号处于未决状态</li></ul></li></ul></li><li><p>这个未决状态的信号，需要被处理，处理之前需要和另一个信号集（阻塞信号集），进行比较</p><ul><li>阻塞信号集默认不阻塞任何的信号</li><li>如果想要阻塞某些信号，需要用户调用系统的API</li></ul></li><li><p>在处理的时候和阻塞信号集中的标志位进行查询，看是不是对该信号设置阻塞了</p><ul><li>如果没有阻塞，这个信号就被处理</li><li><strong>如果阻塞了，这个信号就继续处于未决状态，直到阻塞解除，这个信号就被处理</strong></li></ul></li></ol><h4 id="信号集相关函数" tabindex="-1"><a class="header-anchor" href="#信号集相关函数" aria-hidden="true">#</a> 信号集相关函数</h4><p>以下信号集相关的函数都是对<code>自定义</code>的信号集进行操作。</p><h5 id="sigaction" tabindex="-1"><a class="header-anchor" href="#sigaction" aria-hidden="true">#</a> sigaction</h5><p><code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);</code> 给signum设置一个处理函数.</p><ul><li><p><code>signum</code> 要捕捉的信号编号</p></li><li><p><code>act</code> 包含信的信号处理函数和标志的结构体</p></li><li><p><code>oldact</code> 可选，用于保存之前信号处理的信息，一般不使用，传递NULL</p></li><li><p><code>return</code> 成功时返回 0，失败时返回 -1，并设置 <code>errno</code> 来指示错误。</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sigaction</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数指针，指向的函数就是信号捕捉到之后的处理函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 不常用，同样是信号处理函数，有三个参数，可以获得关于信号更详细的信息</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_sigaction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">siginfo_t</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 临时阻塞信号集，在信号捕捉函数执行过程中，临时阻塞某些信号。</span>
    <span class="token class-name">sigset_t</span> sa_mask<span class="token punctuation">;</span>
    <span class="token comment">// 使用哪一个信号处理对捕捉到的信号进行处理</span>
    <span class="token keyword">int</span> sa_flags<span class="token punctuation">;</span>
    <span class="token comment">// 被废弃掉了</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sa_restorer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>sa_flags</code> 可选值</p><p><code>0</code> 表示使用 sa_handler</p><p><code>SA_SIGINFO</code> 使用 sa_sigaction 成员而不是 sa_handler 作为信号处理函数</p><p><code>SA_RESTART</code> 使被信号打断的系统调用自动重新发起</p><p><code>SA_NOCLDSTOP</code> 使父进程在它的子进程暂停或继续运行时不会收到 <code>SIGCHLD</code> 信号</p><p><code>SA_NOCLDWAIT</code> 使父进程在它的子进程退出时不会收到 SIGCHLD 信号，这时子进程如果退出也不会成为僵尸进程</p><p><code>SA_NODEFER</code> 使对信号的屏蔽无效，即在信号处理函数执行期间仍能发出这个信号</p><p><code>SA_RESETHAND</code> 信号处理之后重新设置为默认的处理方式</p></blockquote><h5 id="sigemptyset" tabindex="-1"><a class="header-anchor" href="#sigemptyset" aria-hidden="true">#</a> sigemptyset</h5><p><code>int sigemptyset(sigset_t *set);</code> 清空信号集中的数据，将信号集中的所有的标志位置为0</p><ul><li><code>set</code> 需要操作的信号集</li><li><code>return</code> 成功返回0， 失败返回-1</li></ul><h5 id="sigfillset" tabindex="-1"><a class="header-anchor" href="#sigfillset" aria-hidden="true">#</a> sigfillset</h5><p><code>int sigfillset(sigset_t *set);</code> 将信号集中的所有的标志位置为1</p><ul><li><code>set</code> 需要操作的信号集</li><li><code>return</code> 成功返回0， 失败返回-1</li></ul><h5 id="sigaddset" tabindex="-1"><a class="header-anchor" href="#sigaddset" aria-hidden="true">#</a> sigaddset</h5><p><code>int sigaddset(sigset_t *set, int signum);</code> 设置信号集中的某一个信号对应的标志位为1，<strong>表示阻塞这个信号</strong></p><ul><li><code>set</code> 需要操作的信号集</li><li><code>signum</code> 需要设置阻塞的那个信号</li><li><code>return</code> 成功返回0， 失败返回-1</li></ul><h5 id="sigdelset" tabindex="-1"><a class="header-anchor" href="#sigdelset" aria-hidden="true">#</a> sigdelset</h5><p><code>int sigdelset(sigset_t *set, int signum);</code> 设置信号集中的某一个信号对应的标志位为0，<strong>表示不阻塞这个信号</strong></p><ul><li><code>set</code> 需要操作的信号集</li><li><code>signum</code> 需要设置不阻塞的那个信号</li><li><code>return</code> 成功返回0， 失败返回-1</li></ul><h5 id="sigismember" tabindex="-1"><a class="header-anchor" href="#sigismember" aria-hidden="true">#</a> sigismember</h5><p><code>int sigismember(const sigset_t *set, int signum);</code> 判断某个信号是否阻塞</p><ul><li><code>set</code> 需要操作的信号集</li><li><code>sinum </code> 需要判断的那个信号</li><li><code>return</code><ul><li><code>1</code> signum被阻塞</li><li><code>0</code> signum不阻塞</li><li><code>-1</code> 失败</li></ul></li></ul><p>例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个信号集</span>
    <span class="token class-name">sigset_t</span> set<span class="token punctuation">;</span>

    <span class="token comment">// 清空信号集的内容</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断 SIGINT 是否在信号集 set 里</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT 不阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT 阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 添加几个信号到信号集中</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断SIGINT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT 不阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGINT 阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断SIGQUIT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGQUIT 不阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGQUIT 阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从信号集中删除一个信号</span>
    <span class="token function">sigdelset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断SIGQUIT是否在信号集中</span>
    ret <span class="token operator">=</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGQUIT 不阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;SIGQUIT 阻塞\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="sigprocmask" tabindex="-1"><a class="header-anchor" href="#sigprocmask" aria-hidden="true">#</a> sigprocmask</h5><p><code>int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);</code> 将自定义信号集中的数据设置到内核中（设置阻塞，解除阻塞，替换）</p><ul><li><code>how</code> 如何对内核阻塞信号集进行处理 <ul><li><code>SIG_BLOCK</code> 将指定的信号添加到当前进程的信号屏蔽集中。在信号屏蔽集中的信号将被阻塞，不会立即处理。</li><li><code>SIG_UNBLOCK</code> 从当前进程的信号屏蔽集中移除指定的信号，允许这些信号再次被处理。</li><li><code>SIG_SETMASK</code> 将当前进程的信号屏蔽集替换为指定的信号集，即只包含 <code>set</code> 中的信号。</li></ul></li><li><code>set</code> 根据用户设置的数据，对内核中的数据进行解除阻塞 mask &amp;= ~set</li><li><code>oldset</code> 保存设置之前的内核中的阻塞信号集的状态，可以是 NULL</li><li><code>return</code><ul><li>成功：0</li><li>失败：-1 , 设置错误号：EFAULT、EINVAL</li></ul></li></ul><h5 id="sigpending" tabindex="-1"><a class="header-anchor" href="#sigpending" aria-hidden="true">#</a> sigpending</h5><p><code>int sigpending(sigset_t *set);</code> 获取内核中的未决信号集</p><ul><li><code>set</code> 将当前进程的未决信号集存储在 <code>set</code> 指向的 <code>sigset_t</code> 结构中。</li></ul><p>例子1：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 编写一个程序，把所有的常规信号（1-31）的未决状态打印到屏幕</span>
<span class="token comment">// 设置某些信号是阻塞的，通过键盘产生这些信号</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 设置2、3号信号阻塞</span>
    <span class="token class-name">sigset_t</span> set<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将2号和3号信号添加到信号集中</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改内核中的阻塞信号集</span>
    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        num<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前的未决信号集的数据</span>
        <span class="token class-name">sigset_t</span> pendingset<span class="token punctuation">;</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigpending</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历前32位</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">31</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pendingset<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sigismember&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 解除阻塞</span>
            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例子2:</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myalarm</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;捕捉到了信号的编号是：%d\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxxxx\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 过3秒以后，每隔2秒钟定时一次</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myalarm<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清空临时阻塞信号集</span>
   
    <span class="token comment">// 注册信号捕捉</span>
    <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> new_value<span class="token punctuation">;</span>

    <span class="token comment">// 设置间隔的时间</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置延迟的时间,3秒之后开始第一次定时</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    new_value<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 非阻塞的</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;定时器开始了...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setitimer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// getchar();</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sigchld-信号" tabindex="-1"><a class="header-anchor" href="#sigchld-信号" aria-hidden="true">#</a> SIGCHLD 信号</h3><p><code>SIGCHLD</code> 信号产生的3个条件：</p><ol><li>子进程终止时（最常见）</li><li>子进程接收到 SIGSTOP 信号停止时</li><li>子进程处在停止态，接受到 SIGCONT 后唤醒时</li></ol><p>以上三种条件都会给父进程发送 <code>SIGCHLD</code> 信号，父进程默认会忽略该信号。</p><p>使用 <code>SIGCHLD</code> 信号解决<code>僵尸进程</code>的问题：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myFun</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;捕捉到的信号 ：%d\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 回收子进程PCB的资源</span>
    <span class="token comment">// while(1) {</span>
    <span class="token comment">//     wait(NULL); </span>
    <span class="token comment">// }</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> WNOHANG<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child die , pid = %d\n&quot;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// 说明还有子进程或者</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// 没有子进程</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 提前设置好阻塞信号集，阻塞SIGCHLD，因为有可能子进程很快结束，父进程还没有注册完信号捕捉</span>
    <span class="token class-name">sigset_t</span> set<span class="token punctuation">;</span>
    <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>set<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一些子进程</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程</span>

        <span class="token comment">// 捕捉子进程死亡时发送的SIGCHLD信号</span>
        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
        act<span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> myFun<span class="token punctuation">;</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>act<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册完信号捕捉以后，解除阻塞</span>
        <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>set<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent process pid : %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child process pid : %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="linux-之-io-系统编程" tabindex="-1"><a class="header-anchor" href="#linux-之-io-系统编程" aria-hidden="true">#</a> Linux 之 IO 系统编程</h2><h3 id="文件io" tabindex="-1"><a class="header-anchor" href="#文件io" aria-hidden="true">#</a> 文件IO</h3><h4 id="open-打开或创建一个文件" tabindex="-1"><a class="header-anchor" href="#open-打开或创建一个文件" aria-hidden="true">#</a> open 打开或创建一个文件</h4><p><code>open(const char *pathname, int flags, mode_t mode)</code> 创建或打开某个文件：最多有3个参数</p><ul><li><code>pathname</code> : 包含路径的文件名</li><li><code>flags</code> : 打开文件的方式</li></ul><table><thead><tr><th>flag</th><th>功能</th></tr></thead><tbody><tr><td><code>O_RDONLY</code></td><td>只读</td></tr><tr><td><code>O_WRONLY</code></td><td>只写</td></tr><tr><td><code>O_RDWR</code></td><td>读写</td></tr><tr><td><code>O_CREAT</code></td><td>创建一个文件</td></tr><tr><td><code>O_EXCL</code></td><td>如果使用 <code>O_CREATE</code> 时文件存在，会返回错误信息，这一参数可用来测试文件是否存在</td></tr><tr><td><code>O_TRUNC</code></td><td>打开文件（会把已经存在的内容给删除）</td></tr><tr><td><code>O_APPEND</code></td><td>追加方式打开文件（不会把已经存在的内容给删除）</td></tr></tbody></table><ul><li><p><code>mode</code> : 创建文件的权限，如果不是创建文件，可以不加这个参数，mode标识在fcntl.h 文件中声明。</p></li><li><p><code>return</code> :</p><ul><li>成功：文件描述符，它是一个非负整数，即文件的ID号，相当于人的身份证</li><li>出错：-1</li></ul></li></ul><blockquote><p>什么是文件描述符？<br>内核的一个重要功能是文件管理，系统有非常多的文件，内核怎么样认识每一个文件呢？<br>内核采用ID号的方式标识这些文件，inode号，node号表示不同的文件，比如 <code>ls -ali 查看文件</code> 只要文件不一样，inode号就不一样<br>那么这些内核的文件id号，在每个用户的程序中怎么样映射呢？即是通过文件描述符。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 8进制掩码</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>open <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create file %s failure \n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create file %s success \n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里需要注意，mode读写权限默认会跟Linux自带的一个用户文件创建权限掩码,</p><p>系统为了保护用户创建文件和文件夹的权限,此时系统会有一个默认的用户掩码(umask)，大多数的Linux系统的默认掩码为0022。</p><blockquote><p>它的公式是：<code>mode &amp; (~umask)</code></p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">umask</span> <span class="token comment">#查看掩码</span>
<span class="token builtin class-name">umask</span> 0000 <span class="token comment">#修改为掩码为 0000，即取消它的作用</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="write" tabindex="-1"><a class="header-anchor" href="#write" aria-hidden="true">#</a> write</h4><p><code>write(int fd,void *buf,size_t count)</code></p><ul><li><code>fd</code> : 向哪个文件写</li><li><code>buf</code> : 写什么内容</li><li><code>count</code> : 写多少个字节</li><li><code>return</code> : 实际写了多少个字节</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello Linux&quot;</span><span class="token punctuation">;</span>
    fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;./hello.txt&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>open <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file failure \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file success fd:%d\n&quot;</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;writend number = %d\n&quot;</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="read" tabindex="-1"><a class="header-anchor" href="#read" aria-hidden="true">#</a> read</h4><p><code>read(int fd,void *buf,size_t count)</code> 读取文件内容</p><ul><li><code>fd</code> : 从哪个文件读</li><li><code>buf</code> : 读到哪里</li><li><code>count</code> : 读多少个字节</li><li><code>return</code> : 实际读到多少个字节</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello Linux&quot;</span><span class="token punctuation">;</span>
	fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;./hello.txt&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>open <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file failure \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file success fd:%d\n&quot;</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;writend number = %d\n&quot;</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">char</span> read_buf<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	count <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token number">20l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt content : %s\n&quot;</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="lseek" tabindex="-1"><a class="header-anchor" href="#lseek" aria-hidden="true">#</a> lseek</h4><p><code>lseek(int fd,off_t offset,int whence)</code> 调整读写位置指针</p><ul><li><code>fd</code> : 要调整的文件描述符号</li><li><code>offset</code> : 相对 <code>whence</code> 的偏移，单位是字节的数量，可正可负（向前移，向后移）</li><li><code>whence</code> : 当前位置的基点，有3个标志： <ul><li><code>SEEK_SET</code> : 文件开头 + <code>offset</code></li><li><code>SEEK_CUR</code> : 当前读写指针位置 + <code>offset</code></li><li><code>SEEK_END</code> : 当前文件的结尾 + <code>offset</code></li></ul></li><li><code>return</code> : 成功：当前位置，失败：-1</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello Linux&quot;</span><span class="token punctuation">;</span>
	fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;./hello.txt&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>open <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file failure \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open file success fd:%d\n&quot;</span><span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;writend number = %d\n&quot;</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">char</span> read_buf<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	count <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token number">20l</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello.txt content : %s\n&quot;</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现-cp-命令" tabindex="-1"><a class="header-anchor" href="#实现-cp-命令" aria-hidden="true">#</a> 实现 cp 命令</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> rd_fd<span class="token punctuation">,</span> wr_fd<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;please input src file and dec file\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	rd_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>rd_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open src file %s failure\n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open src file %s success\n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	wr_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>wr_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open des file %s failure\n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;open des file %s success\n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> read_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> read_buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	

	<span class="token keyword">do</span><span class="token punctuation">{</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>read_buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		read_count <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>rd_fd<span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">write</span><span class="token punctuation">(</span>wr_fd<span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span>read_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>read_count <span class="token operator">&gt;=</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		
	<span class="token function">close</span><span class="token punctuation">(</span>rd_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>wr_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="复制文件描述符-dup" tabindex="-1"><a class="header-anchor" href="#复制文件描述符-dup" aria-hidden="true">#</a> 复制文件描述符 dup</h4><p><code>int dup(int oldfd);</code> 函数是一个 UNIX/Linux 系统调用，用于复制文件描述符。<code>dup</code> 函数会复制参数 <code>oldfd</code> 所指定的文件描述符，返回一个新的文件描述符，新的文件描述符和原始的文件描述符都指向相同的文件表项。通常，<code>dup</code> 返回的新文件描述符是当前可用的最小的文件描述符。</p><ul><li><code>oldfd</code>：要复制的文件描述符。</li><li><code>return</code> 返回的新文件描述符是当前可用的最小的文件描述符。</li></ul><p>示例：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个文件描述符</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error opening file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 复制文件描述符</span>
    <span class="token keyword">int</span> new_fd <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error duplicating file descriptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用原始文件描述符和复制的文件描述符进行读取操作</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> read_bytes<span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Reading from original file descriptor:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    read_bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> read_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nReading from duplicated file descriptor:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    read_bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> read_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在这个例子中，我们首先打开一个文件获取文件描述符 <code>fd</code>，然后使用 <code>dup</code> 复制这个文件描述符，得到一个新的文件描述符 <code>new_fd</code>。最后，我们使用这两个文件描述符分别进行读取操作，它们会共享相同的文件表项，因此读取的内容是相同的。</p></blockquote><h4 id="复制文件描述符-指定新的文件描述符-dup2" tabindex="-1"><a class="header-anchor" href="#复制文件描述符-指定新的文件描述符-dup2" aria-hidden="true">#</a> 复制文件描述符，指定新的文件描述符 dup2</h4><p><code>int dup2(int oldfd, int newfd);</code> 函数也是用于复制文件描述符，但它允许显式指定新的文件描述符的值。</p><ul><li><p><code>oldfd</code>：要复制的文件描述符。</p></li><li><p><code>newfd</code>：新的文件描述符的值。</p></li><li><p><code>return</code> 返回的指定的新的文件描述符。</p></li></ul><blockquote><p><code>dup2</code> 函数会将 <code>oldfd</code> 复制到 <code>newfd</code>，如果 <code>newfd</code> 已经打开，它会先关闭 <code>newfd</code>，然后将 <code>oldfd</code> 复制给它。如果 <code>oldfd</code> 和 <code>newfd</code> 相等，<code>dup2</code> 不会关闭 <code>newfd</code>，但仍会返回 <code>newfd</code>。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个文件描述符</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error opening file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 复制文件描述符</span>
    <span class="token keyword">int</span> new_fd <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error duplicating file descriptor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用原始文件描述符和复制的文件描述符进行读取操作</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> read_bytes<span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Reading from original file descriptor:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    read_bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> read_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nReading from duplicated file descriptor:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    read_bytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> read_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文件锁-fcntl" tabindex="-1"><a class="header-anchor" href="#文件锁-fcntl" aria-hidden="true">#</a> 文件锁 fcntl</h4><p>文件锁（File Lock）是一种机制，用于在多个进程或线程之间协调对文件的访问，以防止并发访问时可能导致的问题。文件锁通常用于确保对共享文件的互斥访问，以防止竞态条件和数据不一致性。</p><p>在 UNIX/Linux 系统中，文件锁主要由以下两种类型：</p><ol><li><strong>共享锁（Shared Lock）：</strong> 多个进程可以同时拥有共享锁，但任何一个进程拥有共享锁时，其他进程无法获得独占锁。</li><li><strong>独占锁（Exclusive Lock）：</strong> 一个进程拥有独占锁时，其他进程无法获得共享锁或独占锁。</li></ol><p>文件锁的相关函数主要包括 <code>fcntl</code>、<code>flock</code> 等。</p><p>为了避免多个进程在读写同一个文件的同一个区域时发生冲突，Unix/Linux系统引入了文件锁机制，并把文件锁分为读锁和写锁两种，它们的区别在于**，对一个文件的特定区域可以加多把读锁，对一个文件的特定区域只能加一把锁。**</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">flock</span> <span class="token punctuation">{</span>
    <span class="token keyword">short</span> l_type<span class="token punctuation">;</span>    <span class="token comment">/* 锁的类型：F_RDLCK、F_WRLCK 或 F_UNLCK */</span>
    <span class="token keyword">short</span> l_whence<span class="token punctuation">;</span>  <span class="token comment">/* 起始位置：SEEK_SET、SEEK_CUR 或 SEEK_END */</span>
    <span class="token class-name">off_t</span> l_start<span class="token punctuation">;</span>   <span class="token comment">/* 锁定区域的起始位置（相对l_whence偏移） */</span>
    <span class="token class-name">off_t</span> l_len<span class="token punctuation">;</span>     <span class="token comment">/* 锁定区域的长度 */</span>
    <span class="token class-name">pid_t</span> l_pid<span class="token punctuation">;</span>     <span class="token comment">/* 拥有锁的进程ID（由内核设置） */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>l_type</code>：锁的类型，可以是以下值之一： <ul><li><code>F_RDLCK</code>：读锁。</li><li><code>F_WRLCK</code>：写锁。</li><li><code>F_UNLCK</code>：解锁。</li></ul></li><li><code>l_whence</code>：锁定区域的起始位置，可以是以下值之一： <ul><li><code>SEEK_SET</code>：锁定区域的起始位置是从文件开头开始。</li><li><code>SEEK_CUR</code>：锁定区域的起始位置是从当前文件指针位置开始。</li><li><code>SEEK_END</code>：锁定区域的起始位置是从文件末尾开始。</li></ul></li><li><code>l_start</code>：锁定区域的起始位置，根据 <code>l_whence</code> 的值确定是相对于文件开头、当前位置还是文件末尾。</li><li><code>l_len</code>：锁定区域的长度，指定锁定的字节数。</li><li><code>l_pid</code>：由内核设置的拥有锁的进程ID。当锁被占用时，该字段指示哪个进程拥有锁。</li></ul><p><code>int fcntl(int fd, int cmd, struct flock *lock);</code> 是一个系统调用，用于对文件描述符进行各种控制操作，包括文件锁定。</p><ul><li><code>fd</code>：文件描述符，是要进行操作的文件的标识符。</li><li><code>cmd</code>：命令，指定 <code>fcntl</code> 要执行的操作。 <ul><li><code>F_SETLK</code>：设置文件锁定，如果无法加锁，则立即返回 -1。</li><li><code>F_SETLKW</code>：设置文件锁定，如果无法加锁，则阻塞直到能够加锁。</li><li><code>F_GETLK</code>：获取文件锁定信息，填充 <code>struct flock</code> 结构体。</li></ul></li><li><code>lock</code>：一个指向 <code>struct flock</code> 结构的指针，这个结构定义了文件锁定的信息。</li></ul><blockquote><p><strong>锁机制之所以能够避免读写冲突，关键在于参与读写的多个进程都在按照一套模式一先加锁，再读写，最后解锁一按部就班地执行。这就形成了一套协议，只要参与者无一例外地遵循这套协议，读写就是安全的。反之，如果哪个进程不遵守这套协议，完全无视锁的存在，想读就读，想写就写，即便有锁，对它也起不到任何约束作用。因此，这样的锁机制被称为劝谏锁或协议锁。</strong></p></blockquote><h4 id="检查文件或目录的是否存在-访问权限-access" tabindex="-1"><a class="header-anchor" href="#检查文件或目录的是否存在-访问权限-access" aria-hidden="true">#</a> 检查文件或目录的是否存在&amp;访问权限 access</h4><p><code>int access(const char *pathname, int mode);</code></p><ul><li><code>pathname</code>：指定要检查权限的文件或目录的路径名。</li><li><code>mode</code> ：指定要检查的权限，是一个位掩码，可以是以下值之一： <ul><li><code>F_OK</code>：检查文件是否存在。</li><li><code>R_OK</code>：检查读权限。</li><li><code>W_OK</code>：检查写权限。</li><li><code>X_OK</code>：检查执行权限。</li></ul></li><li><code>return</code><ul><li>如果权限检查成功，返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查文件是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s exists\n&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查文件是否具有读权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has read access\n&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查文件是否具有写权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> W_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has write access\n&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查文件是否具有执行权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has execute access\n&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="修改文件大小-truncate" tabindex="-1"><a class="header-anchor" href="#修改文件大小-truncate" aria-hidden="true">#</a> 修改文件大小 truncate</h4><p><code>int truncate(const char *path, off_t length);</code></p><ul><li><code>path</code>：指定要修改大小的文件的路径名。</li><li><code>length</code>：指定文件的新大小，单位是字节。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><blockquote><ul><li>如果新的文件大小比原始大小小，则多余的部分将被丢弃。</li><li>如果新的文件大小比原始大小大，则文件的内容将会扩展，扩展的部分将用0字节文件空洞填充。</li><li>使用此函数需要对文件具有写权限，否则将返回错误。</li></ul></blockquote><h4 id="获取文件元信息-stat" tabindex="-1"><a class="header-anchor" href="#获取文件元信息-stat" aria-hidden="true">#</a> 获取文件元信息 stat</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="根据文件路径获取文件状态-stat" tabindex="-1"><a class="header-anchor" href="#根据文件路径获取文件状态-stat" aria-hidden="true">#</a> 根据文件路径获取文件状态 stat</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">stat</span> <span class="token punctuation">{</span>
    <span class="token class-name">dev_t</span>     st_dev<span class="token punctuation">;</span>         <span class="token comment">/* 包含文件的设备 ID */</span>
    <span class="token class-name">ino_t</span>     st_ino<span class="token punctuation">;</span>         <span class="token comment">/* inode 编号 */</span>
    <span class="token class-name">mode_t</span>    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* 文件保护模式（权限）*/</span>
    <span class="token class-name">nlink_t</span>   st_nlink<span class="token punctuation">;</span>       <span class="token comment">/* 硬链接数量 */</span>
    <span class="token class-name">uid_t</span>     st_uid<span class="token punctuation">;</span>         <span class="token comment">/* 文件所有者的用户 ID */</span>
    <span class="token class-name">gid_t</span>     st_gid<span class="token punctuation">;</span>         <span class="token comment">/* 文件所有者的组 ID */</span>
    <span class="token class-name">dev_t</span>     st_rdev<span class="token punctuation">;</span>        <span class="token comment">/* 设备 ID（如果是特殊文件） */</span>
    <span class="token class-name">off_t</span>     st_size<span class="token punctuation">;</span>        <span class="token comment">/* 文件总大小，以字节为单位 */</span>
    <span class="token class-name">blksize_t</span> st_blksize<span class="token punctuation">;</span>     <span class="token comment">/* 文件系统 I/O 的块大小 */</span>
    <span class="token class-name">blkcnt_t</span>  st_blocks<span class="token punctuation">;</span>      <span class="token comment">/* 分配的 512 字节块数量 */</span>
    <span class="token class-name">time_t</span>    st_atime<span class="token punctuation">;</span>       <span class="token comment">/* 最后访问时间 */</span>
    <span class="token class-name">time_t</span>    st_mtime<span class="token punctuation">;</span>       <span class="token comment">/* 最后修改时间 */</span>
    <span class="token class-name">time_t</span>    st_ctime<span class="token punctuation">;</span>       <span class="token comment">/* 最后状态改变时间 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>st_mode</code> 是一个 32 位的无符号整数，但其中的低 16 位用于表示文件类型和权限信息。</p><p><code>st_mode</code> 主要包含了三个部分的信息：</p><p>a. <strong>文件类型（15 ~ 12 位）</strong>：这部分用于表示文件的类型，包括常见的目录、常规文件、字符设备、块设备、FIFO（命名管道）、符号链接和套接字等。</p><ul><li><p>这 4 位表示文件的类型，可以使用以下宏进行检查：</p><ul><li><code>S_ISFIFO(mode)</code>：是否为 FIFO（命名管道）。</li><li><code>S_ISCHR(mode)</code>：是否为字符设备。</li><li><code>S_ISDIR(mode)</code>：是否为目录。</li><li><code>S_ISBLK(mode)</code>：是否为块设备。</li><li><code>S_ISREG(mode)</code>：是否为常规文件。</li><li><code>S_ISLNK(mode)</code>：是否为符号链接。</li><li><code>S_ISSOCK(mode)</code>：是否为套接字。</li></ul></li></ul><p>b. <strong>执行文件时设置的信息（11 ~ 9 位）</strong>：这部分包括 setuid、setgid 和粘滞位的信息，用于在执行文件时设置相应的权限。</p><ul><li><p>第 9 位：<code>**S_ISUID**</code>，setuid 位，当执行该文件时，将文件所有者的权限赋予执行者。</p></li><li><p>第 10 位：<code>**S_ISGID**</code>，setgid 位，当执行该文件时，将文件组的权限赋予执行者。</p></li><li><p>第 11 位：<code>**S_ISVTX**</code>，粘滞位，通常用于目录，限制删除文件的权限。</p><ul><li><p><code>&quot;粘滞位&quot;（Sticky Bit）</code> 是与文件权限相关的一个特殊权限标志，它通常应用在目录上。在目录上设置了粘滞位后，只有目录的所有者、文件的所有者和超级用户才能删除或重命名该目录中的文件，其他用户无法删除或修改不属于自己的文件。</p><p>在目录的权限中，粘滞位用数字表示为1。例如，一个目录权限为1777，其中的1表示粘滞位。在 <code>ls</code> 命令的输出中，可以看到目录权限中的粘滞位标识为&quot;T&quot;。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#设置粘滞位的方法通常是通过 chmod 命令：</span>
<span class="token function">chmod</span> +t directory_name
<span class="token comment">#使用数字表示法：</span>
<span class="token function">chmod</span> <span class="token number">1777</span> directory_name
<span class="token comment">#要清除粘滞位，可以使用：</span>
<span class="token function">chmod</span> <span class="token parameter variable">-t</span> directory_name
<span class="token comment">#或者：</span>
<span class="token function">chmod</span> 0777 directory_name
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><p>c. <strong>文件访问权限（8 ~ 0 位）</strong>：这部分用于表示文件的访问权限，包括用户（所有者）、群组和其他用户的读、写、执行权限。</p><ul><li>第 8 位：文件所有者的读权限（<code>S_IRUSR</code>）。</li><li>第 7 位：文件所有者的写权限（<code>S_IWUSR</code>）。</li><li>第 6 位：文件所有者的执行权限（<code>S_IXUSR</code>）。</li><li>第 5 位：群组的读权限（<code>S_IRGRP</code>）。</li><li>第 4 位：群组的写权限（<code>S_IWGRP</code>）。</li><li>第 3 位：群组的执行权限（<code>S_IXGRP</code>）。</li><li>第 2 位：其他用户的读权限（<code>S_IROTH</code>）。</li><li>第 1 位：其他用户的写权限（<code>S_IWOTH</code>）。</li><li>第 0 位：其他用户的执行权限（<code>S_IXOTH</code>）。</li></ul><p>linux 预定义的一些宏来代替这些生硬的掩码。这些宏定义在 include 头文件中。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//bit15 ~ bit12 , 文件类型属性区域</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFMT</span>      <span class="token expression"><span class="token number">0170000</span>     文件类型的位遮罩</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFSOCK</span>    <span class="token expression"><span class="token number">0140000</span>     socket</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFLNK</span>     <span class="token expression"><span class="token number">0120000</span>     符号链接<span class="token punctuation">(</span>symbolic link<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFREG</span>     <span class="token expression"><span class="token number">0100000</span>     一般文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFBLK</span>     <span class="token expression"><span class="token number">0060000</span>     区块装置<span class="token punctuation">(</span>block device<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFDIR</span>     <span class="token expression"><span class="token number">0040000</span>     目录</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFCHR</span>     <span class="token expression"><span class="token number">0020000</span>     字符装置<span class="token punctuation">(</span>character device<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_IFIFO</span>     <span class="token expression"><span class="token number">0010000</span>     先进先出<span class="token punctuation">(</span>fifo<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISSOCK</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFSOCK<span class="token punctuation">)</span>  </span><span class="token comment">//提供了一些宏来帮助用户执行&amp;操作，是则返回1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISLNK</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFLNK<span class="token punctuation">)</span>  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISREG</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFREG<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISBLK</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFBLK<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISDIR</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFDIR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISCHR</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFCHR<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">S_ISFIFO</span><span class="token expression"><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">&amp;</span> S_IFMT<span class="token punctuation">)</span> <span class="token operator">==</span> S_IFIFO<span class="token punctuation">)</span></span></span>

<span class="token comment">//bit11 ~ bit9，权限的特殊属性区域</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_ISUID</span>      <span class="token expression"><span class="token number">0004000</span>     文件的<span class="token punctuation">(</span>set user<span class="token operator">-</span>id on execution<span class="token punctuation">)</span>位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_ISGID</span>      <span class="token expression"><span class="token number">0002000</span>     文件的<span class="token punctuation">(</span>set group<span class="token operator">-</span>id on execution<span class="token punctuation">)</span>位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">S_ISVTX</span>      <span class="token expression"><span class="token number">0001000</span>     文件的sticky位</span></span>

<span class="token comment">//bit8 ~ bit0，权限属性区域</span>
<span class="token comment">//文件所有者（owner）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRWXU</span> <span class="token expression"><span class="token number">00700</span>	</span><span class="token comment">/* mask for file owner permissions */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRUSR</span> <span class="token expression"><span class="token number">00400</span>	</span><span class="token comment">/* owner has read permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWUSR</span> <span class="token expression"><span class="token number">00200</span>	</span><span class="token comment">/* owner has write permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXUSR</span> <span class="token expression"><span class="token number">00100</span>	</span><span class="token comment">/* owner has execute permission */</span></span>
 <span class="token comment">//组用户（group）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRWXG</span> <span class="token expression"><span class="token number">00070</span>	</span><span class="token comment">/* mask for group permissions */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRGRP</span> <span class="token expression"><span class="token number">00040</span>	</span><span class="token comment">/* group has read permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWGRP</span> <span class="token expression"><span class="token number">00020</span>	</span><span class="token comment">/* group has write permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXGRP</span> <span class="token expression"><span class="token number">00010</span>	</span><span class="token comment">/* group has execute permission */</span></span>
 <span class="token comment">//其他用户（other）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IRWXO</span> <span class="token expression"><span class="token number">00007</span>	</span><span class="token comment">/* mask for permissions for others (not in group) */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IROTH</span> <span class="token expression"><span class="token number">00004</span>	</span><span class="token comment">/* others have read permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IWOTH</span> <span class="token expression"><span class="token number">00002</span>	</span><span class="token comment">/* others have write permission */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">S_IXOTH</span> <span class="token expression"><span class="token number">00001</span>	</span><span class="token comment">/* others have execute permission */</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 假设 file_info 是一个 struct stat 结构体的实例</span>
<span class="token keyword">struct</span> <span class="token class-name">stat</span> file_info<span class="token punctuation">;</span>

<span class="token comment">// 检查用户是否有读权限</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>file_info<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> S_IRUSR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;User has read permission.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;User does not have read permission.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><p><code>int stat(const char *pathname, struct stat *statbuf);</code> 用于获取文件的状态信息，包括文件大小、权限、创建时间等。</p><ul><li><code>pathname</code>：指定要获取状态信息的文件路径名。</li><li><code>statbuf</code>：一个指向 <code>struct stat</code> 结构的指针，用于存储文件状态信息。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> file_info<span class="token punctuation">;</span>

    <span class="token comment">// 获取文件状态信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_info<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File Size: %ld bytes\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>file_info<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File Permissions: %o\n&quot;</span><span class="token punctuation">,</span> file_info<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Hard Links: %ld\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>file_info<span class="token punctuation">.</span>st_nlink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他信息也可以类似地获取和打印</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="根据文件描述符获取文件状态-fstat" tabindex="-1"><a class="header-anchor" href="#根据文件描述符获取文件状态-fstat" aria-hidden="true">#</a> 根据文件描述符获取文件状态 fstat</h5><p><code>int fstat(int fd, struct stat *statbuf);</code> 函数用于获取文件描述符所指向文件的状态信息，类似于 <code>stat</code> 函数。</p><ul><li><code>fd</code>：文件描述符，指定要获取状态信息的文件。</li><li><code>statbuf</code>：一个指向 <code>struct stat</code> 结构的指针，用于存储文件状态信息。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename <span class="token operator">=</span> <span class="token string">&quot;example.txt&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> file_descriptor <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> file_info<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>file_descriptor <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error opening file&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取文件状态信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>file_descriptor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_info<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File Size: %ld bytes\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>file_info<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;File Permissions: %o\n&quot;</span><span class="token punctuation">,</span> file_info<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Number of Hard Links: %ld\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>file_info<span class="token punctuation">.</span>st_nlink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他信息也可以类似地获取和打印</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>file_descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="获取符号链接文件的状态信息-lstat" tabindex="-1"><a class="header-anchor" href="#获取符号链接文件的状态信息-lstat" aria-hidden="true">#</a> 获取符号链接文件的状态信息 lstat</h5><p><code>int lstat(const char *pathname, struct stat *statbuf);</code> 函数用于获取符号链接文件状态信息，类似于 <code>stat</code> 函数。</p><ul><li><code>pathname</code>：指定要获取状态信息的文件路径名。</li><li><code>statbuf</code>：一个指向 <code>struct stat</code> 结构的指针，用于存储文件状态信息。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><blockquote><p><code>lstat</code> 与 <code>stat</code> 的区别在于，当指定的文件是符号链接时，<code>lstat</code> 获取符号链接本身的状态信息，而 <code>stat</code> 获取符号链接指向的文件的状态信息。</p></blockquote><h4 id="mmap-内存映射文件" tabindex="-1"><a class="header-anchor" href="#mmap-内存映射文件" aria-hidden="true">#</a> mmap 内存映射文件</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</code> 是一个系统调用，用于在进程的地址空间中映射文件或者其它对象（比如设备、匿名内存）的一部分。这个调用允许直接在内存中操作文件，而不需要常规的读写操作。在C语言中，通常使用 <code>mmap</code> 函数来进行内存映射。</p><ul><li><p><code>addr</code>：映射的起始地址，通常设置为 <code>NULL</code>，表示由系统选择合适的地址。</p></li><li><p><code>length</code>：映射的长度，以字节为单位。</p></li><li><p><code>prot</code>：映射的保护标志，指定映射区的访问权限</p><ul><li><code>PROT_READ</code>：允许读取映射区域的数据。</li><li><code>PROT_WRITE</code>：允许写入映射区域的数据。</li><li><code>PROT_EXEC</code>：允许执行映射区域的数据。</li><li><code>PROT_NONE</code>：禁止对映射区域进行访问。</li></ul></li><li><p><code>flags</code>：映射的标志，控制映射的类型和行为</p><ul><li><code>MAP_SHARED</code>：共享映射，多个进程可以共享映射区域的内容。对映射区域的修改会反映到所有共享该区域的进程。</li><li><code>MAP_PRIVATE</code>：私有映射，映射区域对调用进程是私有的，对映射区域的修改不会反映到其他进程。如果多个进程都使用 <code>MAP_PRIVATE</code>，它们各自的修改不会相互影响。</li><li><code>MAP_ANONYMOUS</code>：创建匿名映射，不与任何文件关联。这通常与 <code>MAP_PRIVATE</code> 一起使用，用于创建无关文件的共享内存区域。</li><li><code>MAP_FIXED</code>：强制使用指定的地址开始映射。如果指定地址无法使用，<code>mmap</code> 失败。</li><li><code>MAP_FIXED_NOREPLACE</code>：类似于 <code>MAP_FIXED</code>，但如果指定地址已经被占用，则 <code>mmap</code> 失败。</li><li><code>MAP_LOCKED</code>：锁定映射区域的所有页，防止它们被交换到磁盘。</li><li><code>MAP_POPULATE</code>：预先加载映射区域的所有页到物理内存，而不是在访问时按需加载。</li><li><code>MAP_NORESERVE</code>：不为映射区域保留交换空间。如果映射的数据多于系统实际可用的交换空间，这可能导致 <code>mmap</code> 失败。</li><li><code>MAP_GROWSDOWN</code>：用于堆栈，表示映射区域从高地址向低地址扩展。</li><li><code>MAP_DENYWRITE</code>：禁止写入映射区域。仅对私有映射有效，用于提高性能。</li><li><code>MAP_EXECUTABLE</code>：允许在映射区域中执行代码。</li></ul></li><li><p><code>fd</code>：文件描述符，如果映射与文件关联，传入文件描述符；如果是匿名映射，可以传入 <code>-1</code>。</p></li><li><p><code>offset</code>：文件的偏移量，对于文件映射，表示从文件的哪个位置开始映射；对于匿名映射，通常设置为 <code>0</code>。</p></li><li><p><code>return</code> 返回值是映射的起始地址，如果映射失败，返回 <code>MAP_FAILED</code>（通常是 <code>(void *) -1</code>）。</p></li></ul><blockquote><p>使用 <code>mmap</code> 可以创建文件映射，实现共享内存，也可以用于创建匿名映射，实现进程间通信。使用时需要仔细考虑映射的权限、标志和其他参数，确保满足具体的需求。此外，使用完成后，通常需要使用 <code>munmap</code> 函数解除映射。</p></blockquote><h4 id="解除由-mmap-创建的映射" tabindex="-1"><a class="header-anchor" href="#解除由-mmap-创建的映射" aria-hidden="true">#</a> 解除由 <code>mmap</code> 创建的映射</h4><p><code>int munmap(void *addr, size_t length);</code> 是一个系统调用，用于解除由 <code>mmap</code> 创建的映射，释放相应的资源。在 C 语言中，<code>munmap</code> 函数的声明通常位于 <code>&lt;sys/mman.h&gt;</code> 头文件中。</p><ul><li><code>addr</code>：映射的起始地址，通常是由 <code>mmap</code> 返回的映射起始地址。</li><li><code>length</code>：映射的长度，以字节为单位，应该与 <code>mmap</code> 时指定的长度一致。</li><li><code>return</code><ul><li>返回值是整数类型，表示函数执行的结果。如果解除映射成功，返回 <code>0</code>；</li><li>如果失败，返回 <code>-1</code>，并设置 <code>errno</code> 指示错误的原因。</li></ul></li></ul><blockquote><p>使用 <code>munmap</code> 可以释放 <code>mmap</code> 创建的映射，回收相关的资源。解除映射后，与映射关联的内存区域将不再对进程可见，对这些区域的访问将引发错误。</p><p>在使用 <code>munmap</code> 时需要确保传入的参数与之前使用 <code>mmap</code> 创建映射时的参数一致。通常，在不再需要映射时，应当及时使用 <code>munmap</code> 解除映射，以避免资源泄漏。</p></blockquote><h4 id="posix共享内存-shm-open" tabindex="-1"><a class="header-anchor" href="#posix共享内存-shm-open" aria-hidden="true">#</a> POSIX共享内存 shm_open</h4><p><code>shm_open</code> 和 <code>shmget</code> 都是用于创建或打开共享内存对象的函数，但它们属于不同的 IPC（进程间通信）机制，并且在使用方式和功能上有一些区别。以下是它们的主要区别：</p><p><code>shm_open</code>：</p><ol><li><strong>机制：</strong> <code>shm_open</code> 是 POSIX 标准定义的函数，属于 POSIX 共享内存机制。</li><li><strong>使用方式：</strong> <code>shm_open</code> 主要用于创建或打开一个 POSIX 共享内存对象，返回一个文件描述符，类似于文件 I/O 的方式。可以通过文件描述符进行后续的映射、读写等操作。</li><li><strong>命名对象：</strong> <code>shm_open</code> 创建的共享内存对象是命名的，需要指定一个名字，而其他进程可以通过相同的名字来打开相同的共享内存对象。</li><li><strong>通用性：</strong> <code>shm_open</code> 通常更通用，因为它是 POSIX 标准的一部分，因此在兼容 POSIX 的系统上可用。</li></ol><p><code>shmget</code>：</p><ol><li><strong>机制：</strong> <code>shmget</code> 属于 System V 共享内存机制。</li><li><strong>使用方式：</strong> <code>shmget</code> 用于创建或获取一个 System V 共享内存标识符，返回一个共享内存标识符，而不是文件描述符。后续的操作需要使用这个标识符进行。</li><li><strong>键值：</strong> <code>shmget</code> 使用一个键值（key）来标识共享内存对象，其他进程需要使用相同的键值来获取相同的共享内存对象。</li><li><strong>特定于 System V：</strong> <code>shmget</code> 是特定于 System V 的机制，在一些现代的系统中可能不太常见。</li></ol><p><code>int shm_open(const char *name, int oflag, mode_t mode);</code> 是用于创建或打开共享内存对象的系统调用。它通常用于在 POSIX 环境中进行共享内存的创建和访问。</p><ul><li><code>name</code>：共享内存对象的名称。在 POSIX 共享内存中，这个名称类似于文件路径。</li><li><code>oflag</code>：标志参数，用于指定打开共享内存对象的方式，例如 <code>O_CREAT</code> 表示创建共享内存对象。 <ul><li><strong><code>O_CREAT</code>：</strong> 如果共享内存对象不存在，则创建它。如果省略此标志，<code>shm_open</code> 将仅尝试打开已存在的共享内存对象。</li><li><strong><code>O_EXCL</code>：</strong> 与 <code>O_CREAT</code> 一起使用时，确保创建新的共享内存对象。如果对象已存在，将返回错误。</li><li><strong><code>O_RDWR</code>：</strong> 以读写方式打开共享内存对象。必须指定此标志，因为共享内存通常用于在进程之间共享数据。</li><li><strong><code>O_RDONLY</code>：</strong> 以只读方式打开共享内存对象。</li><li><strong><code>O_WRONLY</code>：</strong> 以只写方式打开共享内存对象。通常，共享内存对象是双向的，因此 <code>O_RDWR</code> 更为常见。</li></ul></li><li><h2 id="mode-权限参数-用于指定共享内存对象的权限-例如-0666-表示读写权限-允许所有用户读取和写入共享内存。仅在创建新对象时有效。" tabindex="-1"><a class="header-anchor" href="#mode-权限参数-用于指定共享内存对象的权限-例如-0666-表示读写权限-允许所有用户读取和写入共享内存。仅在创建新对象时有效。" aria-hidden="true">#</a> <code>mode</code>：权限参数，用于指定共享内存对象的权限，例如，<code>0666</code> 表示读写权限，允许所有用户读取和写入共享内存。<strong>仅在创建新对象时有效。</strong></h2></li><li><code>return</code><ul><li>返回值为共享内存对象的文件描述符</li><li>如果失败则返回 -1。</li></ul></li></ul><h3 id="标准io" tabindex="-1"><a class="header-anchor" href="#标准io" aria-hidden="true">#</a> 标准IO</h3><h4 id="标准io与文件io的区别" tabindex="-1"><a class="header-anchor" href="#标准io与文件io的区别" aria-hidden="true">#</a> 标准IO与文件IO的区别</h4><ul><li><p>文件IO ：是直接调用内核提供的系统调用函数，头文件是 <code>unistd.h</code></p></li><li><p>标准IO ：是间接调用系统调用函数的函数，头文件是 <code>stdio.h</code></p></li><li><p><code>getchar()</code>,<code>putchar()</code> : 一个字符</p></li><li><p><code>gets(buf)</code>,<code>puts(buf)</code> : 一串字符</p></li><li><p><code>scanf()</code>,<code>printf()</code> : 一个字符 或 一串字符</p></li></ul><blockquote><p>之前学过输入输出相关的函数，都是标准的输入（键盘），标准的输出（显示器）</p></blockquote><blockquote><p>之前学过的标准输入输出函数函数不能读写普通文件</p></blockquote><hr> 而我们接下来要学的标准IO中的相关函数，不仅可以读写普通文件，也可以向标准的输入或标准的输出中读或写。 <h4 id="三个缓存的概念-数组" tabindex="-1"><a class="header-anchor" href="#三个缓存的概念-数组" aria-hidden="true">#</a> 三个缓存的概念（数组）</h4><ul><li>用户空间的缓存（<code>user buffer</code>）：程序中定义的缓存，比如：<code>char buf[1024]</code></li><li>库缓存（<code>lib buffer</code>）：标准库函数中也有一个缓存，合格缓存称为库缓存</li><li>内核空间的缓存（<code>kernel buffer</code>）：每打开一个文件，内核在内核空间也会开辟一块缓存，这个叫做内核空间的缓存</li></ul><h4 id="测试验证库缓存的存在" tabindex="-1"><a class="header-anchor" href="#测试验证库缓存的存在" aria-hidden="true">#</a> 测试验证库缓存的存在</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 用户空间缓存。</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果遇到 \n 会调用系统调用函数输出。</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">1020</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token comment">// 同时，经过测试当库缓存达到大于1024时会输出，说明库缓存为1024字节</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>标准IO库缓存写满，或遇到<code>\n</code>时，会调用系统调用函数。</p></blockquote><p>缓存分为：</p><ul><li>全缓存：库缓存满时，比如达到 1024 字节</li><li>行缓存：遇到 <code>\n</code> 时</li><li>无缓存：例如内核提供的<code>write</code>和<code>read</code>函数。</li></ul><p>无缓存：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment">#include &lt;stdio.h&gt;</span>
<span class="token comment">#include &lt;unistd.h&gt;</span>

int main<span class="token punctuation">(</span>void<span class="token punctuation">)</span><span class="token punctuation">{</span>
    write<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">&quot;Hello&quot;</span>,5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    while<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>标准输入的文件描述符是 <code>0</code>，标准输出的文件描述符是 <code>1</code></p></blockquote><h4 id="标准io相关函数" tabindex="-1"><a class="header-anchor" href="#标准io相关函数" aria-hidden="true">#</a> 标准IO相关函数</h4><ul><li>标准输入流：<code>stdin</code> ，文件描述符 <code>0</code></li><li>标准输出流：<code>stdout</code> ，文件描述符 <code>1</code></li><li>标准错误流：<code>stderr</code> ，文件描述符 <code>2</code></li></ul><table><thead><tr><th>文件IO</th><th>标准IO</th></tr></thead><tbody><tr><td>open</td><td>fopen</td></tr><tr><td>close</td><td>fclose</td></tr><tr><td>lseek</td><td>fseek</td></tr><tr><td>read</td><td>-</td></tr><tr><td>write</td><td>-</td></tr></tbody></table><p><strong>标准IO中，读写函数比较多，分：全缓存、行缓存、无缓存</strong></p><ul><li><code>FILE * fopen(const char *path, const char *mode);</code><ul><li><code>FILE *</code> : 文件流指针，类似文件IO中的文件描述符 <ul><li>FILE 是一个结构体，包含读写缓存的首地址、大小、文件指针等</li></ul></li><li><code>mode</code> : 文件打开方式</li></ul></li></ul><table><thead><tr><th>mode</th><th>说明</th></tr></thead><tbody><tr><td>b</td><td>二进制流</td></tr><tr><td>r</td><td>只读</td></tr><tr><td>w</td><td>只写，如果文件不存在则创建，如果存在会清空内容</td></tr><tr><td>a</td><td>只写，如果文件不存在则创建，以追加模式打开</td></tr><tr><td>r+</td><td>读写</td></tr><tr><td>w+</td><td>读写，如何不存在则创建，如果存在会清空内容</td></tr><tr><td>a+</td><td>读写，如何不存在则创建，以追加模式打开</td></tr></tbody></table><blockquote><p><code>[mode]</code> + <code>b</code> 表示读写二进制流，如：<code>rb</code>、<code>r+b</code>、<code>a+b</code></p></blockquote><ul><li><p><code>int fclose(FILE *stream);</code> 释放文件资源调用成功返回 <code>0</code> ，失败返回 <code>EOF</code> 即 -1，并设置 <code>errno</code> 表示错误类型。</p></li><li><p>在释放文件之前，刷新缓存中的数据，如果标准I/O库已经为该流自动分配了一个缓存，则释放此缓存。</p></li><li><p><code>int fflush(FILE *stream);</code> 用于强制将缓冲区的内容写入文件。</p><ul><li><code>stream</code> : 指向要刷新缓冲区的文件流的指针。</li><li><code>return</code> : 返回一个整数值，如果成功刷新缓冲区，返回 0；如果发生错误，返回 EOF（通常为 -1）。</li></ul></li></ul><h4 id="读写函数" tabindex="-1"><a class="header-anchor" href="#读写函数" aria-hidden="true">#</a> 读写函数</h4><ul><li><p>一串读：<code>gets</code> <code>fgets</code> <code>scanf</code></p></li><li><p>一串写：<code>fputs</code> <code>puts</code> <code>printf</code> <code>fprintf</code> <code>sprintf</code></p></li><li><p>一个读：<code>fgetc</code> <code>getc</code> <code>getchar</code></p></li><li><p>一个写：<code>fputc</code> <code>putc</code> <code>putchar</code></p></li><li><p><code>char *gets(char *str);</code> 用于从标准输入读取字符串，但它已经被认为是不安全的，因为它无法防止缓冲区溢出。</p><ul><li><code>str</code> : 接受的缓冲数组</li><li><code>return</code> : 返回缓冲区的数组指针地址</li></ul></li><li><p><code>char *fgets(char *s,int size,FILE *stream);</code></p><ul><li><code>s</code> : 缓存读取到的内容</li><li><code>size</code> : 读多少个字节</li><li><code>stream</code> : 从哪个文件读读</li><li><code>return</code> : 成功返回 s 的指针地址，如果到末尾或出错返回 null</li></ul></li><li><p><code>int puts(const char *str);</code> 用于向标准输出写入字符串，并自动在字符串末尾添加换行符 <code>\n</code>。</p><ul><li><code>str</code> : 要写入的内容</li><li><code>return</code> : 成功返回非负值，出错则 <code>EOF</code> 即 <code>-1</code></li></ul></li><li><p><code>int fputs(const char *s,FILE * stream);</code> 用于向指定的文件写入字符串，不自动添加换行符。</p><ul><li><code>s</code> : 要写入的内容</li><li><code>stream</code> : 要写到的文件</li><li><code>return</code> : 成功返回非负值，出错则 <code>EOF</code> 即 <code>-1</code></li></ul></li></ul><blockquote><p>fputs 时全缓存，只有在库缓存满了才会输出</p></blockquote><ul><li><p><code>int fprintf(FILE *stream, const char *format, ...);</code> 用于将格式化的数据输出到指定的文件流，而不是标准输出。</p><ul><li><code>stream</code> : 参数是指向文件流的指针，用于指定输出到哪个文件。</li><li><code>format</code> : 和 printf 第一个参数一样</li><li><code>...</code> : 和 printf 第二个参数一样</li></ul></li><li><p><code>int sprintf(char *str, const char *format, ...);</code> 用于将格式化的数据输出到指定的文件流，而不是标准输出。</p><ul><li><code>str</code> : 参数是一个字符数组，用于存储格式化后的字符串。</li><li><code>format</code> : 和 printf 第一个参数一样</li><li><code>...</code> : 和 printf 第二个参数一样</li></ul></li><li><p><code>int fgetc(FILE *stream);</code> 用于向指定的文件写入字符串，不自动添加换行符。</p><ul><li><code>stream</code> : 参数是指向文件流的指针，表示要读取字符的文件。</li><li><code>return</code> :读取的字符的 ASCII 值，或者 EOF 表示读取失败或到达文件末尾。</li></ul></li><li><p><code>int fputc(int character, FILE *stream);</code> 用于向指定的文件写入字符串，不自动添加换行符。</p><ul><li><code>character</code> : 参数是要写入的字符的 ASCII 值。</li><li><code>stream</code> : 参数是指向文件流的指针，表示要写入字符的文件。</li><li><code>return</code> :写入的字符，或者 EOF 表示写入失败。</li></ul></li></ul><h4 id="调整读写位置指针" tabindex="-1"><a class="header-anchor" href="#调整读写位置指针" aria-hidden="true">#</a> 调整读写位置指针</h4><ul><li><p><code>int fseek(FILE *stream, long offset, int whence);</code> 用于在文件读写操作中移动文件指针。</p><ul><li><code>stream</code> : 要调整的文件</li><li><code>offset</code> : 相对 <code>whence</code> 的偏移，单位是字节的数量，可正可负（向前移，向后移）</li><li><code>whence</code> : 当前位置的基点，有3个标志： <ul><li><code>SEEK_SET</code> : 文件开头 + <code>offset</code></li><li><code>SEEK_CUR</code> : 当前读写指针位置 + <code>offset</code></li><li><code>SEEK_END</code> : 当前文件的结尾 + <code>offset</code></li></ul></li><li><code>return</code> : 成功：当前位置，失败：-1</li></ul></li><li><p><code>void rewind(FILE *stream);</code> 用于将文件的位置指针（文件指针）重新设置到文件的起始位置</p><ul><li><code>stream</code>：指向要重新设置位置指针的文件流的指针。</li></ul></li><li><p><code>long int ftell(FILE *stream);</code> 获取文件位置指针（文件指针）的当前位置相对于文件起始位置的偏移量</p><ul><li><code>return</code>：如果成功，返回当前文件位置指针相对于文件起始位置的偏移量（以字节为单位）。如果失败，返回 -1，并设置 errno 表示错误类型。</li></ul></li></ul><h4 id="二进制文件读写" tabindex="-1"><a class="header-anchor" href="#二进制文件读写" aria-hidden="true">#</a> 二进制文件读写</h4><ul><li><code>size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);</code> 用于从文件读取数据块到内存中</li><li><code>ptr</code> : 指向存储读取数据的内存块的指针。</li><li><code>size</code> : 每个数据块的大小（字节数）。</li><li><code>nmemb</code> : 要读取的数据块的数量。</li><li><code>stream</code> : 指向文件流的指针。</li><li><code>return</code> : 实际读取的数据块数量（通常等于 <code>nmemb</code>），如果出现错误或到达文件末尾，返回值可能小于 <code>nmemb</code>。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;data.bin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 假设数据是整数数组</span>
    <span class="token class-name">size_t</span> elements_read <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Read %zu elements from file.\n&quot;</span><span class="token punctuation">,</span> elements_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);</code> 将内存中的数据块写入文件</li><li><code>ptr</code> : 指向要写入文件的内存块的指针。</li><li><code>size</code> : 每个数据块的大小（字节数）。</li><li><code>nmemb</code> : 要写入的数据块的数量。</li><li><code>stream</code> : 指向文件流的指针。</li><li><code>return</code> : 返回值为实际写入的数据块数量（通常等于 <code>nmemb</code>），如果出现错误，返回值可能小于 <code>nmemb</code></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>FILE <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;data.bin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> data<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 假设数据是整数数组</span>
    <span class="token comment">// 假设数据已经准备好</span>
    <span class="token class-name">size_t</span> elements_written <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Written %zu elements to file.\n&quot;</span><span class="token punctuation">,</span> elements_written<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="文件结尾和出错" tabindex="-1"><a class="header-anchor" href="#文件结尾和出错" aria-hidden="true">#</a> 文件结尾和出错</h4><ul><li><p><code>int feof(FILE *stream);</code> 如果文件流 stream 的结束标志已经被设置，返回非零值（true），否则返回零值（false）。</p></li><li><p><code>int ferror(FILE *stream);</code> 如果文件流 stream 的错误标志已经被设置，返回非零值（true），否则返回零值（false）。</p></li><li><p><code>void clearerr(FILE *stream);</code> 用于清除文件流的错误和结束标志，将它们重置为初始状态。</p></li></ul><h3 id="文件io-和-标准io小总结" tabindex="-1"><a class="header-anchor" href="#文件io-和-标准io小总结" aria-hidden="true">#</a> 文件IO 和 标准IO小总结</h3><p>标准库文件 I/O 和内核文件 I/O 是两种不同的方法用于在计算机程序中进行文件操作。</p><p>标准库文件 I/O：</p><ul><li><p>高级接口：标准库文件 I/O 提供了高级的接口，例如 fopen、fclose、fread、fwrite 等函数，使得文件操作更加方便和易于理解。</p></li><li><p>缓冲机制：标准库文件 I/O 通常会使用缓冲机制，将数据先放入缓冲区，然后批量写入磁盘，这可以减少频繁的磁盘 I/O 操作，提高性能。</p></li><li><p>跨平台：标准库提供了跨平台的接口，因此可以在不同操作系统上运行相同的代码，而不需要进行太多的修改。</p></li><li><p>简单易用：标准库函数提供了相对简单的接口，使得文件操作对于初学者来说更容易理解和使用。</p></li></ul><p>内核文件 I/O：</p><ul><li><p>低级接口：内核文件 I/O 提供了对文件系统的底层访问，通常使用系统调用（如 open、read、write、close 等）来实现。这些调用直接与操作系统的文件系统交互。</p></li><li><p>无缓冲：内核文件 I/O 操作通常是无缓冲的，数据直接从用户程序到磁盘，这使得它们在一些特定的场景中可能会更快。</p></li><li><p>灵活性：内核文件 I/O 具有更高的灵活性，可以执行一些标准库不容易实现的操作，例如直接在磁盘上读取/写入特定的扇区等。</p></li><li><p>更高的开销：使用内核文件 I/O 通常需要更多的代码和处理，因为你需要自己处理一些底层的细节，如错误处理、文件描述符管理等。</p></li></ul><p>选择使用标准库文件 I/O 还是内核文件 I/O 取决于你的具体需求和程序的性能要求。通常来说，大多数应用程序会优先选择标准库文件 I/O，因为它提供了更高级别的抽象，使得文件操作更容易实现和维护。但在一些特殊的场景中，可能会需要使用内核文件 I/O 来实现更底层、更高效的文件操作。</p><h3 id="目录io" tabindex="-1"><a class="header-anchor" href="#目录io" aria-hidden="true">#</a> 目录IO</h3><p><strong>操作文件夹 IO 通常需要这两个头文件</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="打开目录" tabindex="-1"><a class="header-anchor" href="#打开目录" aria-hidden="true">#</a> 打开目录</h4><ul><li><code>DIR *opendir(const char *name);</code> 用于打开一个目录，返回一个指向目录流（directory stream）的指针，以便后续对该目录的操作。 <ul><li><code>name</code> : 参数是要打开的目录的路径。</li><li><code>return</code> : 是指向目录流的指针，如果打开失败，返回 <code>NULL</code></li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/directory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 对目录进行操作</span>
        <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭目录流</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建目录" tabindex="-1"><a class="header-anchor" href="#创建目录" aria-hidden="true">#</a> 创建目录</h4><ul><li><code>int mkdir(const char *pathname, mode_t mode);</code> 用于创建一个新目录。 <ul><li><code>pathname</code> : 参数是要创建的目录的路径。</li><li><code>mode</code> : 参数是新目录的权限模式，通常使用八进制表示，同样与<code>umask</code>做掩码。</li><li><code>return</code> : 为 <code>0</code> 表示成功，<code>-1</code> 表示失败。</li></ul></li></ul><h4 id="读目录" tabindex="-1"><a class="header-anchor" href="#读目录" aria-hidden="true">#</a> 读目录</h4><ul><li><code>struct dirent *readdir(DIR *dir);</code> 用于读取目录内容的函数，它用于遍历目录中的文件和子目录。 <ul><li><code>dir</code> : 指向已经通过 <code>opendir</code> 打开的目录流的指针。</li><li><code>return</code> : 指向 struct dirent 结构体的指针，该结构体包含了目录中的一个条目的信息，包括文件名、文件类型等。当读取到目录的末尾时，返回 NULL。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token punctuation">{</span>
    <span class="token class-name">ino_t</span>          d_ino<span class="token punctuation">;</span>       <span class="token comment">/* Inode number */</span>
    <span class="token class-name">off_t</span>          d_off<span class="token punctuation">;</span>       <span class="token comment">/* Not an offset; see note below */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>    <span class="token comment">/* Length of this record */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  d_type<span class="token punctuation">;</span>      <span class="token comment">/* Type of file; not supported by all file system types */</span>
    <span class="token keyword">char</span>           d_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Null-terminated filename */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>dirent-&gt;d_type 是用于获取目录项（directory entry）类型的一个字段。在Linux系统中，通过使用 readdir 函数读取目录时，每个目录项都包含一个 struct dirent 结构体，其中的 d_type 字段表示目录项的类型。</p><p>可能的类型值包括：</p><ul><li><code>DT_REG</code>：常规文件（<code>regular file</code>）</li><li><code>DT_DIR</code>：目录文件（<code>directory</code>）</li><li><code>DT_FIFO</code>：命名管道（<code>FIFO</code>）</li><li><code>DT_SOCK</code>：套接字文件（<code>socket</code>）</li><li><code>DT_CHR</code>：字符设备文件（<code>character device</code>）</li><li><code>DT_BLK</code>：块设备文件（<code>block device</code>）</li><li><code>DT_LNK</code>：符号链接（<code>symbolic link</code>）</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/directory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
        <span class="token comment">// 读取目录中的条目</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entry <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Name: %s, Type: %d\n&quot;</span><span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>d_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="调整目录位置指针" tabindex="-1"><a class="header-anchor" href="#调整目录位置指针" aria-hidden="true">#</a> 调整目录位置指针</h4><ul><li><p><code>void rewinddir(DIR *dir);</code> 用于将目录流的位置重置到目录的开始位置。</p><ul><li><code>dir</code> : 参数是通过 <code>opendir</code> 打开的目录流指针。</li></ul></li><li><p><code>long telldir(DIR *dir);</code> 用于将目录流的位置重置到目录的开始位置。</p><ul><li><code>dir</code> : 参数是通过 <code>opendir</code> 打开的目录流指针。</li><li><code>return</code> : 目录流的当前位置的偏移量。</li></ul></li><li><p><code>void seekdir(DIR *dir, long loc);</code> 用于设置目录流的位置。</p><ul><li><code>dir</code> : 参数是通过 <code>opendir</code> 打开的目录流指针。</li><li><code>loc</code> : 参数是通过 <code>telldir</code> 获取的目录流位置的偏移量。</li></ul></li></ul><h4 id="关闭目录" tabindex="-1"><a class="header-anchor" href="#关闭目录" aria-hidden="true">#</a> 关闭目录</h4><ul><li><code>int closedir(DIR *dir);</code> 用于关闭目录流的函数，它用于结束对目录的操作。 <ul><li><code>dir</code> : 参数是通过 <code>opendir</code> 打开的目录流指针。</li><li><code>return</code> : 返回一个整数值，如果成功关闭目录流，返回 0；如果发生错误，返回 <code>EOF</code>（通常为 <code>-1</code>）。</li></ul></li></ul><h4 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例：</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Please input path \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    DIR <span class="token operator">*</span>dir <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>dir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;FIle is not exits! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span>dir_p<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>dir_p <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;dir inode : %ld , name : %s \n&quot;</span><span class="token punctuation">,</span>dir_p<span class="token operator">-&gt;</span>d_ino<span class="token punctuation">,</span>dir_p<span class="token operator">-&gt;</span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="time-程序执行耗时" tabindex="-1"><a class="header-anchor" href="#time-程序执行耗时" aria-hidden="true">#</a> time 程序执行耗时</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@Ubuntu-arm64:~/study/linux-io<span class="token comment"># time cat hello.txt </span>
Hello Linux
real	0m0.003s    <span class="token comment"># 总耗时</span>
user	0m0.001s    <span class="token comment"># 在用户空间耗时</span>
sys	    0m0.002s    <span class="token comment"># 在内核空间耗时</span>
root@Ubuntu-arm64:~/study/linux-io<span class="token comment"># </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="diff-比较文件的差异" tabindex="-1"><a class="header-anchor" href="#diff-比较文件的差异" aria-hidden="true">#</a> diff 比较文件的差异</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>root@Ubuntu-arm64:~/study/linux-io<span class="token comment"># diff test_buf.c test_write.c </span>
<span class="token number">1</span>,2c1,2
<span class="token operator">&lt;</span> <span class="token comment">#include &lt;stdio.h&gt;</span>
<span class="token operator">&lt;</span> <span class="token comment">#include &lt;unistd.h&gt;</span>
---
<span class="token operator">&gt;</span> <span class="token comment">#include &quot;unistd.h&quot;</span>
<span class="token operator">&gt;</span> <span class="token comment">#include &quot;stdio.h&quot;</span>
<span class="token number">5</span>,6c5
<span class="token operator">&lt;</span> 	write<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">&quot;Hello&quot;</span>,5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span> 	while<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
---
<span class="token operator">&gt;</span> 	write<span class="token punctuation">(</span><span class="token number">1</span>,<span class="token string">&quot;Hello Linux<span class="token entity" title="\n">\n</span>&quot;</span>,128<span class="token punctuation">)</span><span class="token punctuation">;</span>
root@Ubuntu-arm64:~/study/linux-io<span class="token comment"># </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="linux-多线程编程" tabindex="-1"><a class="header-anchor" href="#linux-多线程编程" aria-hidden="true">#</a> Linux 多线程编程</h2><h3 id="一、多线程的基本概念" tabindex="-1"><a class="header-anchor" href="#一、多线程的基本概念" aria-hidden="true">#</a> 一、多线程的基本概念</h3><p>使用多线程的目的是合理地利用资源，提高CPU的效率</p><h5 id="进程" tabindex="-1"><a class="header-anchor" href="#进程" aria-hidden="true">#</a> 进程</h5><p>一个正在执行的程序，它是资源分配的最小单位。</p><h5 id="线程" tabindex="-1"><a class="header-anchor" href="#线程" aria-hidden="true">#</a> 线程</h5><p>有时又称轻量级进程，程序执行的最小单位，系统独立调度和分配CPU的基本单位，它是进程中的一个实体。一个进程中可以有多个线程，这些线程共享进程的所有资源，线程本身包含一点必不可少的资源。</p><p>进程出现了很多弊端，一是由于进程是资源拥有者，创建、销毁、切换存在较大的时间、空间开销，因此需要引入线程；二是由于对称多处理器（SMP）出现，可以满足多个运行单位，而多个进程并行开销过大。</p><h5 id="并发" tabindex="-1"><a class="header-anchor" href="#并发" aria-hidden="true">#</a> 并发</h5><p>并发是指在同一时刻，只能有一条指令执行，但多个进程指令被快速轮换执行，使得在宏观上具有多个进程同时执行的效果。 <strong>开起来同时发生，单核。</strong></p><h5 id="并行" tabindex="-1"><a class="header-anchor" href="#并行" aria-hidden="true">#</a> 并行</h5><p>并行时指在同一时刻，有多条指令在多个处理器上同时执行。真正的同时发生。</p><h4 id="多线程的优势" tabindex="-1"><a class="header-anchor" href="#多线程的优势" aria-hidden="true">#</a> 多线程的优势</h4><ol><li>在多处理器中程序的并行性。</li><li>在等待慢速IO操作时，程序可以执行其他操作，提高并发性。</li><li>模块化的编程，能更清晰地表达程序中独立事件的关系，结构清晰。</li><li>占用较少的系统资源</li></ol><p><strong>多线程不一定要多处理器</strong></p><h3 id="二、多线程的基本控制" tabindex="-1"><a class="header-anchor" href="#二、多线程的基本控制" aria-hidden="true">#</a> 二、多线程的基本控制</h3><h4 id="创建线程" tabindex="-1"><a class="header-anchor" href="#创建线程" aria-hidden="true">#</a> 创建线程</h4><table><thead><tr><th></th><th>线程</th><th>进程</th></tr></thead><tbody><tr><td>标识符类型</td><td>pthread_t</td><td>pid_t</td></tr><tr><td>获取id</td><td>pthread_self()</td><td>getpid()</td></tr><tr><td>创建</td><td>pthread_create()</td><td>fork()</td></tr></tbody></table><p><code>int pthread_create(pthread_t *restrict thread,const pthread_attr_t *restrict attr,void *(*start_routine)(void *),void *restrict arg);</code></p><ul><li><p><code>thread</code> 这是一个指向 pthread_t 类型的指针，用于存储新创建线程的标识符，即线程id。</p></li><li><p><code>attr</code> 线程属性（调度策略，继承性，分离性...），如果传入 NULL，则使用默认属性。</p></li><li><p><code>start_routine</code> 回调函数。</p></li><li><p><code>arg</code> 这是传递给 start_routine 函数的参数，它是一个 void 指针。</p></li><li><p><code>return</code> 成功返回0，否则返回错误码。错误码在 <code>/usr/include/asm-generic/errno.h</code></p></li></ul><blockquote><p>编译时需要链接库libpthread</p></blockquote><p>stdafx.h</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>thread_create_test.c</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">print_id</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>

	pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s pid is %u , tid is 0x%lx\n&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">,</span>pid<span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">print_id</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token string">&quot;new thread : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">print_id</span><span class="token punctuation">(</span><span class="token string">&quot;main thread : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 主函数执行完，进程也会结束，其他线程也提前结束了，有提供相关的函数，这里先使用sleep休眠来防止没有执行到新的线程。</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程生命周期" tabindex="-1"><a class="header-anchor" href="#线程生命周期" aria-hidden="true">#</a> 线程生命周期</h4><p><strong>初始化线程/主线程</strong></p><ol><li>当C程序运行时，首先运行main函数。这个特殊的执行流被称为初始线程或主线程。你可以在初始线程中做任何普通线程可以做的事情。</li><li>主线程的特殊性在于，他在main函数返回的时候，会导致进程结束，进程内所有的线程也会结束。你可以在主线程中调用 pthread_exit 函数结束当前线程，这样进程会等待所有线程结束时才终止。</li><li>主线程接受参数的方式是通过 argc和argv，而普通线程只有一个参数 void*</li><li>在绝大多书情况下，主线程默认在堆栈上运行，这个堆栈可以增长到足够的长度。而普通线程的堆栈是受限制的，一旦溢出就会产生错误。</li></ol><h4 id="线程的创建" tabindex="-1"><a class="header-anchor" href="#线程的创建" aria-hidden="true">#</a> 线程的创建</h4><ol><li>主线程是随着进程的创建而创建。</li><li>其他线程可以通过调用函数来创建，主要调用pthread_create。</li><li>新线程可能在当前线程从函数pthread_create 返回之前已经运行了，甚至返回之前可能已经执行完了。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">Man</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> age<span class="token punctuation">;</span>
	<span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> id<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">Man</span><span class="token operator">*</span> man <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Man</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;man age is %d , name is %s , id is %s\n&quot;</span><span class="token punctuation">,</span>man<span class="token operator">-&gt;</span>age<span class="token punctuation">,</span>man<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span>man<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">Man</span> man<span class="token punctuation">;</span>
	man<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">22</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>man<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>man<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token string">&quot;001&quot;</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>man<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot; main thread have %d args \n&quot;</span><span class="token punctuation">,</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argc<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;arg of args : %s\n&quot;</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//int *threadResult;</span>
    
    <span class="token comment">// 退出当前线程</span>
    <span class="token comment">//pthread_exit(threadResult);</span>


	<span class="token comment">// 等待线程结束，并获取返回值</span>
	<span class="token comment">//pthread_join(tid,(void **)threadResult);</span>
	<span class="token comment">// 打印线程的返回值</span>
	<span class="token comment">//free(threadResult);</span>

    <span class="token comment">// 无返回值</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程的四个基本状态" tabindex="-1"><a class="header-anchor" href="#线程的四个基本状态" aria-hidden="true">#</a> 线程的四个基本状态</h4><table><thead><tr><th>状态</th><th>含义</th></tr></thead><tbody><tr><td>就绪</td><td>线程能够运行，但是在等待可用的处理器</td></tr><tr><td>运行</td><td>线程正在运行，在多核系统中，可能同时有多个线程在运行</td></tr><tr><td>阻塞</td><td>线程在等待处理器以外的软件</td></tr><tr><td>终止</td><td>线程从启动函数中返回，或者调用pthread_exit函数，或被取消</td></tr></tbody></table><h4 id="回收" tabindex="-1"><a class="header-anchor" href="#回收" aria-hidden="true">#</a> 回收</h4><p>线程的分离属性：</p><p>分离一个正在运行的线程并不影响它，仅仅是通知当前系统该线程结束时，其所属的资源可以回收，一个没有被分离的线程，在终止时会保留它的虚拟内存，包括它们的堆栈和其他系统资源，有时这种线程被称为 “僵尸线程”。<strong>创建线程时默认是非分离的</strong></p><p>如果线程具有分离属性，线程终止时会立即回收，**回收将释放掉所有在线程终止时未释放的系统资源和进程资源，**包括线程返回值的内存空间、堆栈、保存寄存器的内存空间等。</p><p>终止被分离的线程，会释放该线程所有的系统资源，但是你必须释放由该线程占用的程序资源。由malloc或mmap分配的内存可以在任何时候由任何线程释放，条件便利、互斥量、信号量可以由任何线程销毁，只要他们被解锁了或没有线程等待。但是互斥量只有它的主人才能解锁它，所以在线程终止前，你需要解锁互斥量。</p><h4 id="线程退出" tabindex="-1"><a class="header-anchor" href="#线程退出" aria-hidden="true">#</a> 线程退出</h4><p><code>void pthread_exit(void *retval);</code></p><ul><li><code>retval</code> 是线程的返回值，可以是任意类型的指针。</li></ul><h4 id="终止线程的几种方式" tabindex="-1"><a class="header-anchor" href="#终止线程的几种方式" aria-hidden="true">#</a> 终止线程的几种方式</h4><p>exit是危险的，会终止进程</p><p>另外还有 return 和 pthread_exit 它们的区别不大，不会导致进程终止</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread return ! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread pthread_exit ! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread exit ! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;main thread !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ gcc <span class="token parameter variable">-o</span> thread_exit thread_exit.c
$ ./thread_exit <span class="token number">1</span>
new thread <span class="token builtin class-name">return</span> <span class="token operator">!</span>
main thread <span class="token operator">!</span>
$ ./thread_exit <span class="token number">2</span>
new thread pthread_exit <span class="token operator">!</span>
main thread <span class="token operator">!</span>
$ ./thread_exit <span class="token number">3</span>
new thread <span class="token builtin class-name">exit</span> <span class="token operator">!</span>
$
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="pthread-join" tabindex="-1"><a class="header-anchor" href="#pthread-join" aria-hidden="true">#</a> pthread_join</h4><p><code>int pthread_join(pthread_t thread, void **retval);</code> 调用该函数的线程会一直阻塞，知道指定的线程tid执行完，或调用pthread_exit，返回或取消。</p><ul><li><code>thread</code> 线程tid</li><li><code>retval</code> 线程的返回值</li><li><code>return</code> 如果 pthread_join 成功执行，它将返回 0，果发生错误，返回的值会是一个正整数，表示相应的错误代码。</li></ul><p>调用 pthread_join 会使指定线程处于分离状态，如果指定线程已经处于分离状态，那么调用就会失败。</p><p><code>int pthread_detach(pthread_t thread);</code> 用于将线程标记为“分离状态”，这意味着线程结束时会自动释放其资源，而不需要其他线程调用 pthread_join 来获取其返回状态。<strong>线程可以自己分离自己</strong>。</p><ul><li><code>thread</code> 线程标识符 tid</li><li><code>return</code> 如果 pthread_detach 成功执行，它将返回 0，如果发生错误，返回的值会是一个正整数，表示相应的错误代码。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am thread 1 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am thread 2 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//pthread_detach(pthread_self());</span>
	<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>

	<span class="token keyword">int</span> err1 <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err2 <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err1 <span class="token operator">||</span> err2<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am main thread \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token operator">*</span>retval1<span class="token punctuation">,</span><span class="token operator">*</span>retval2<span class="token punctuation">;</span>
	err1 <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>retval1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	err2 <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>retval2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 error code is %d\n&quot;</span><span class="token punctuation">,</span>err1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 2 error code is %d\n&quot;</span><span class="token punctuation">,</span>err2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 retval is %ld\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> retval1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 2 retval is %ld\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> retval2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am main thread \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果一个线程已经被成功等待过（通过调用 pthread_join），再次调用 pthread_join 会返回错误。这是因为一个线程一旦被等待，其资源会被释放，再次等待同一个线程相当于在等待一个已经不存在的线程。</p><p>通常，你在等待线程结束时只需调用一次 pthread_join。如果其他线程也需要等待相同的线程，它们应该在不同的地方调用 pthread_join，而不是在同一个线程对象上多次调用。如此一来，每个线程都有机会等待目标线程的结束。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">pthread_t</span> thread_id<span class="token punctuation">;</span>

<span class="token comment">// 线程1等待目标线程结束</span>
<span class="token function">pthread_join</span><span class="token punctuation">(</span>thread_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 其他线程等待相同的目标线程</span>
<span class="token comment">// 这是合法的，因为它们是不同的线程对象</span>
<span class="token function">pthread_join</span><span class="token punctuation">(</span>thread_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这会返回错误</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程取消" tabindex="-1"><a class="header-anchor" href="#线程取消" aria-hidden="true">#</a> 线程取消</h4><h5 id="取消函数" tabindex="-1"><a class="header-anchor" href="#取消函数" aria-hidden="true">#</a> 取消函数</h5><p><code>int pthread_cancel(pthread_t thread);</code> 函数用于请求取消另一个线程。这个函数并不是强制性的，而是发送一个取消请求，目标线程可以选择在适当的时候作出响应。目标线程需要在代码中显式地处理取消请求，通常通过检查取消状态并调用 pthread_testcancel 来实现。</p><ul><li><code>thread</code> 线程id</li><li><code>return</code> 如果成功，返回 0，如果出现错误，返回相应的错误代码。</li></ul><h5 id="取消状态" tabindex="-1"><a class="header-anchor" href="#取消状态" aria-hidden="true">#</a> 取消状态</h5><p><code>int pthread_setcancelstate(int state, int *oldstate);</code> 用于设置线程的取消状态。线程的取消状态决定了是否响应取消请求。</p><ul><li><code>state</code> 指定新的取消状态。可以是 <code>PTHREAD_CANCEL_ENABLE</code>（允许取消）或 <code>PTHREAD_CANCEL_DISABLE</code>（禁止取消）。默认值是 <code>PTHREAD_CANCEL_ENABLE</code>.</li><li><code>oldstate</code> 是一个可选的指针，用于存储原来的取消状态。</li><li><code>return</code> 如果成功，返回 0，如果出现错误，返回相应的错误代码。</li></ul><p>调用 <code>pthread_setcancelstate</code> 将线程的取消状态设置为指定的值。如果 <code>oldstate</code> 不是 <code>NULL</code>，则原来的取消状态将存储在 <code>oldstate</code> 指向的位置。</p><h5 id="取消类型" tabindex="-1"><a class="header-anchor" href="#取消类型" aria-hidden="true">#</a> 取消类型</h5><p><code>int pthread_setcanceltype(int type, int *oldtype);</code> 函数用于设置线程的取消类型。线程的取消类型决定了在哪些取消点上会响应取消请求。</p><ul><li><code>type</code> 指定新的取消类型。可以是 <code>PTHREAD_CANCEL_DEFERRED</code>（延迟取消）取消请求被延迟，直到线程进入取消点。或 <code>PTHREAD_CANCEL_ASYNCHRONOUS</code>（异步取消）一旦取消请求被发出，线程将立即被取消，无论它当前是否在执行计算、等待系统调用还是在执行其他任务。 默认值是<code>PTHREAD_CANCEL_DEFERRED</code>.</li><li><code>oldtype</code> 是一个可选的指针，用于存储原来的取消类型。</li><li><code>return</code> 如果成功，返回 0，如果出现错误，返回相应的错误代码。</li></ul><p>调用 <code>pthread_setcanceltype</code> 将线程的取消类型设置为指定的值。如果 <code>oldtype</code> 不是 <code>NULL</code>，则原来的取消类型将存储在 <code>oldtype</code> 指向的位置。</p><h5 id="取消点" tabindex="-1"><a class="header-anchor" href="#取消点" aria-hidden="true">#</a> 取消点</h5><p>取消点是指程序中允许取消请求检查的特定位置。当线程在取消点上执行时，它会检查取消状态，如果取消状态允许取消，则执行取消操作。</p><p>一些典型的取消点包括：</p><ul><li><strong>I/O 操作</strong>： 诸如 <code>read</code>、<code>write</code> 等系统调用，以及标准 I/O 库函数（如 <code>printf</code>、<code>scanf</code>）中的操作。</li><li><strong>等待函数</strong>： 诸如 <code>pthread_join</code> 和 <code>pthread_cond_wait</code> 等等等待其他线程的函数。</li><li><strong>定时器函数</strong>： 诸如 <code>sleep</code> 和 <code>usleep</code>。</li><li><strong>条件变量函数</strong>： 诸如 <code>pthread_cond_wait</code>。</li><li><strong>互斥锁解锁</strong>： 当线程调用 <code>pthread_mutex_unlock</code> 时，如果有其他线程在等待这个互斥锁，它们可能会被取消。</li></ul><p>当线程在取消点上执行时，系统会检查线程的取消状态。如果取消状态允许取消（即取消状态为 <code>PTHREAD_CANCEL_ENABLE</code>），并且有取消请求等待，线程将被取消。</p><p>要在程序中设置取消点，你可以使用类似于 <code>pthread_testcancel</code> 的函数，它是一个特殊的取消点函数，用于检查取消请求并执行相应的处理。</p><p><code>void pthread_testcancel(void);</code> 是一个取消点函数，用于检查取消状态并执行相应的处理。在默认情况下，线程在进入取消点时会检查取消状态，如果允许取消并且有取消请求等待，线程将执行取消操作。</p><p>pthread_testcancel 函数没有返回值。当线程执行到这个函数时，系统会检查取消状态，如果允许取消并且有取消请求等待，线程将被取消。</p><p>通常，pthread_testcancel 被用于程序中的特定位置，作为一个显式的取消点。例如，你可以在长时间循环的迭代中使用它，以便在取消请求发生时及时响应。这样可以确保线程在任何时候都能够被取消，而不仅仅在标准的取消点上。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> stateval <span class="token operator">=</span> <span class="token function">pthread_setcancelstate</span><span class="token punctuation">(</span>PTHREAD_CANCEL_DISABLE<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stateval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;set cancel state failed 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am new thread\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;about to cancel \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	stateval <span class="token operator">=</span> <span class="token function">pthread_setcancelstate</span><span class="token punctuation">(</span>PTHREAD_CANCEL_ENABLE<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stateval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;set cancel state failed 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> typeval <span class="token operator">=</span> <span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span>PTHREAD_CANCEL_ASYNCHRONOUS<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>typeval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;set cancel type failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;first cancel point \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;second cancel point \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;start cancel \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> cval <span class="token operator">=</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;end cancel \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>cval <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;cancel thread failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>rval<span class="token punctuation">;</span>
	<span class="token keyword">int</span> jval <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token operator">&amp;</span>rval<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread return val is %ld\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>rval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程信号处理" tabindex="-1"><a class="header-anchor" href="#线程信号处理" aria-hidden="true">#</a> 线程信号处理</h4><h5 id="向线程发送信号" tabindex="-1"><a class="header-anchor" href="#向线程发送信号" aria-hidden="true">#</a> 向线程发送信号</h5><p><code>int pthread_kill(pthread_t thread, int sig);</code> 是用于向指定线程发送信号的函数，主要在 POSIX 线程编程中使用。</p><ul><li><p><code>thread</code> 要发送信号的目标线程的标识符。</p></li><li><p><code>sig</code> 要发送的信号编号。</p></li><li><p><code>return</code> 函数的返回值是 0 或者一个正整数，表示成功发送信号。如果返回值是其他值，通常表示出现了错误。</p></li></ul><p>pthread_kill 不是kill，而是向线程发送signal，对比普通signal，大部分signal 的默认动作是终止进程的运行，所以我们才要用 sigaction() 函数去抓信号并加上处理函数。</p><p>而 pthread_kill 的作用是，向指定id的线程发送signal信号，如果线程代码内不做处理，则按照信号默认的行为影响整个进程，也就是说，如果你给一个线程发送了SIGQUIT，但线程内却没有实现 signal处理函数，则整个进程退出。</p><p>如果想要获得正常的行为，就需要在线程内实现signation。</p><p>如果 sig 的参数不是0 ，需要清楚这是什么信号，而且一定要实现线程的信号处理函数，否则会影响整个进程。</p><p>sig = 0 ，这是一个保留信号，其实并没有发送信号，作用是用来判断线程是否还活着。</p><h5 id="向线程发送信号实例" tabindex="-1"><a class="header-anchor" href="#向线程发送信号实例" aria-hidden="true">#</a> 向线程发送信号实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am new thread \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
 	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create a new thread failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//sleep(1);</span>
	err <span class="token operator">=</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> EINVAL<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;An invalid signal was specified. \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am main thread !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="信号处理" tabindex="-1"><a class="header-anchor" href="#信号处理" aria-hidden="true">#</a> 信号处理</h5><p><code>int pthread_sigmask(int how, const sigset_t *set, sigset_t *oldset);</code> 函数用于检查或更改线程的信号屏蔽集。与 <code>sigprocmask</code> 函数类似，但 <code>pthread_sigmask</code> 专门用于线程，并且只影响调用线程的信号屏蔽集。</p><ul><li><code>how</code> 参数指定了要进行的操作，可以取以下几个标志之一： <ul><li><code>SIG_BLOCK</code>：将指定的信号添加到线程的信号屏蔽集中。</li><li><code>SIG_UNBLOCK</code>：从线程的信号屏蔽集中移除指定的信号。</li><li><code>SIG_SETMASK</code>：将线程的信号屏蔽集替换为指定的信号集。</li></ul></li><li><code>set</code> 是一个指向 <code>sigset_t</code> 类型的指针，表示要操作的信号集。</li><li><code>oldset</code> 是一个指向 <code>sigset_t</code> 类型的指针，用于存储之前的信号屏蔽集。可以是 <code>NULL</code></li></ul><blockquote><p>与 <code>sigprocmask</code> 不同，<code>pthread_sigmask</code> 仅影响调用线程的信号屏蔽集，而不会影响其他线程。</p></blockquote><h5 id="信号处理实例" tabindex="-1"><a class="header-anchor" href="#信号处理实例" aria-hidden="true">#</a> 信号处理实例</h5><p>示例：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">sig_handler1</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread1 get signal %d \n&quot;</span><span class="token punctuation">,</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sig_handler2</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread2 get signal %d \n&quot;</span><span class="token punctuation">,</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler1<span class="token punctuation">;</span>
	<span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">,</span>SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 注册信号捕捉</span>
	<span class="token function">sigaction</span><span class="token punctuation">(</span>SIGQUIT<span class="token punctuation">,</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 屏蔽信号</span>
	<span class="token comment">// SIG_BLOCK 将指定的信号添加到线程的信号屏蔽集中。</span>
	<span class="token comment">// sa_mask 临时阻塞信号集</span>
	<span class="token function">pthread_sigmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span>sa_mask<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> act<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>act<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    act<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler2<span class="token punctuation">;</span>
	<span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>act<span class="token punctuation">.</span> sa_mask<span class="token punctuation">,</span>SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册信号捕捉</span>
	<span class="token function">sigaction</span><span class="token punctuation">(</span>SIGQUIT<span class="token punctuation">,</span><span class="token operator">&amp;</span>act<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 1 failed ! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread2 failed ! \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 发送信号</span>
	err <span class="token operator">=</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span>SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;send siganl to thread1 failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span>SIGQUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;send signal to thread2 failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_sigmask</span>
new thread <span class="token number">2</span>
new thread <span class="token number">1</span>
thread1 get signal <span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>信号对应的线程处理函数是共享的</p><p>对同一个信号多次调用 <code>sigaction</code> 会覆盖之前的设置，而不是追加新的处理函数。这可能会导致最后设置的信号处理函数覆盖之前的设置。</p><p>如果两个线程对同一个信号设置不同的信号处理函数，后设置的会覆盖先设置的。这是因为 POSIX 信号处理函数是进程级别的，而不是线程级别的。</p><p>因此以上示例才会输出：thread1 get signal 3，而不是 thread2 get signal 3</p></blockquote><h4 id="线程清理" tabindex="-1"><a class="header-anchor" href="#线程清理" aria-hidden="true">#</a> 线程清理</h4><p><code>void pthread_cleanup_push(void (*routine)(void *), void *arg);</code> 用于将一个清理函数注册到清理函数栈上。清理函数将在线程退出时按照栈的顺序执行。</p><ul><li><code>routine</code> 是一个指向清理函数的函数指针。清理函数是在线程退出时执行的函数。</li><li><code>arg</code> 是传递给清理函数的参数。可以是任意类型的指针，用于传递额外的数据给清理函数。</li></ul><p><code>void pthread_cleanup_pop(int execute);</code> 用于注销之前注册的清理函数，同时可以指定是否在注销时执行清理函数。</p><ul><li><code>execute</code> 是一个整数参数，如果 <code>execute</code> 的值为非零，表示在线程退出时执行注册的清理函数；如果 <code>execute</code> 的值为零，表示不执行注册的清理函数。</li></ul><blockquote><p>这两个函数要成对出现，否则会无法编译通过。</p></blockquote><p><code>pthread_cleanup_push</code> 和 <code>pthread_cleanup_pop</code> 中注册的清理函数在以下情况下会执行：</p><ol><li><strong>正常线程退出：</strong> 如果线程通过 <code>pthread_exit</code> 正常退出，注册的清理函数会被执行。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>cleanup_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 线程的主要逻辑</span>
<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清理函数将在正常退出时执行</span>
<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>异常线程终止：</strong> 如果线程因为接收到取消请求而被取消，注册的清理函数也会被执行。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>cleanup_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 线程的主要逻辑</span>
<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清理函数将在线程取消时执行</span>
<span class="token function">pthread_testcancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 在某个点检测取消请求</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong>调用 <code>pthread_cleanup_pop</code> 时执行：</strong> 在调用 <code>pthread_cleanup_pop</code> 时，如果传递的 <code>execute</code> 参数为非零，那么注册的清理函数将被执行。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>cleanup_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 线程的主要逻辑</span>
<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 清理函数将在此时执行</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li><strong>线程异常终止：</strong> 在某些情况下，线程可能因为未处理的信号或其他异常情况而非正常退出，此时也会执行注册的清理函数。这取决于系统和运行时环境的具体实现。</li></ol><h5 id="线程清理实例" tabindex="-1"><a class="header-anchor" href="#线程清理实例" aria-hidden="true">#</a> 线程清理实例</h5><p>例子：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">first_clean</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s first clean \n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">second_clean</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s second clean \n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread 1 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>first_clean<span class="token punctuation">,</span><span class="token string">&quot;thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>second_clean<span class="token punctuation">,</span><span class="token string">&quot;thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread2 2 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>first_clean<span class="token punctuation">,</span><span class="token string">&quot;thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>second_clean<span class="token punctuation">,</span><span class="token string">&quot;thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread1 failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread2 failed !\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_cleanup</span>
new thread <span class="token number">1</span>
thread2 second clean
new thread2 <span class="token number">2</span>
thread2 second clean
thread2 first clean
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、线程的同步" tabindex="-1"><a class="header-anchor" href="#三、线程的同步" aria-hidden="true">#</a> 三、线程的同步</h3><h4 id="互斥量" tabindex="-1"><a class="header-anchor" href="#互斥量" aria-hidden="true">#</a> 互斥量</h4><h5 id="为什么要使用互斥量" tabindex="-1"><a class="header-anchor" href="#为什么要使用互斥量" aria-hidden="true">#</a> 为什么要使用互斥量</h5><p>使用互斥量（Mutex）的主要目的是在多线程环境中确保共享资源的安全访问，避免竞态条件（Race Condition）和数据不一致性问题。以下是一些使用互斥量的主要原因：</p><ol><li><strong>保护共享资源：</strong> 当多个线程同时访问和修改共享数据时，互斥量用于确保在任何给定时刻只有一个线程能够访问共享资源。这防止了多个线程同时写入数据或读取不一致的数据，从而维护数据的一致性。</li><li><strong>防止竞态条件：</strong> 竞态条件指的是多个线程同时访问共享资源，且最终的结果取决于线程执行的相对顺序。使用互斥量可以避免竞态条件，确保操作的顺序不会导致不确定的结果。</li><li><strong>确保原子性操作：</strong> 互斥量可以用于将一系列操作组合成一个原子操作。原子操作是不可中断的单个操作，要么全部完成，要么完全不执行。这确保了一组相关的操作在执行期间不会被其他线程干扰。</li><li><strong>线程同步：</strong> 互斥量用于同步多个线程的执行，确保它们以正确的顺序执行。例如，一个线程可能依赖于另一个线程执行完某个任务后才能继续执行，互斥量可以用于实现这种同步。</li><li><strong>避免死锁：</strong> 通过使用互斥量，可以避免多个线程之间的死锁情况，即多个线程相互等待对方释放资源而无法继续执行的情况。</li></ol><p>使用互斥量是多线程编程中常见的同步机制，确保线程安全性和可靠性。然而，互斥量的不当使用可能导致性能问题或死锁，因此在设计和实现中需要谨慎考虑。</p><p>为了让线程访问数据不产生冲突，这就需要多变量加锁，使得同一时刻只有一个线程可以访问变量。</p><p>互斥量本质就是锁，访问共享资源前对互斥量加锁，访问完成后解锁。</p><p>当互斥量加锁后，其他需要访问该互斥量的线程都将阻塞。</p><p>当互斥量解锁后，所有因为这个互斥量阻塞的线程都将变为就绪状态，第一个获得 CPU 的线程会获得互斥量，变为运行态，而其他变量会继续变为阻塞，在这种方式下访问互斥量每次只有一个线程能向前执行。</p><p>互斥量用 pthread_mutex_t 类型的数据表示，在使用之前需要对互斥量初始化。</p><ol><li>如果是动态分配的互斥量，可以调用 <code>pthread_mutex_init()</code> 函数初始化。</li><li>动态分配的互斥量在释放内存之前，需要调用 <code>pthread_mutex_destroy()</code></li><li>如果是静态分配的互斥量，可以把它设置为常量，<code>PTHREAD_MUTEX_INITIALIZER</code> 。</li></ol><h5 id="初始化与释放" tabindex="-1"><a class="header-anchor" href="#初始化与释放" aria-hidden="true">#</a> 初始化与释放</h5><p><code>int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *attr);</code> 用于初始化互斥量（Mutex）。这个函数为互斥量分配内存并初始化其属性。</p><ul><li><code>mutex</code> 指向要初始化的互斥量的指针。</li><li><code>attr</code> 指向互斥量属性的指针，通常可以传递为 <code>NULL</code>，表示使用默认属性。如果需要自定义互斥量的属性，可以使用 <code>pthread_mutexattr_init</code> 和相关函数创建和设置属性。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>PTHREAD_MUTEX_INITIALIZER</code> 是一个宏，用于初始化静态分配的互斥量（Mutex）。<strong>它提供了一种简便的方式来初始化互斥量的静态实例，而不需要调用 <code>pthread_mutex_init</code> 函数。</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">pthread_mutex_t</span> my_mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int pthread_mutex_destroy(pthread_mutex_t *mutex); </code>用于销毁互斥量（Mutex），释放其占用的资源。</p><ul><li><code>mutex</code> 指向要销毁的互斥量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="加锁" tabindex="-1"><a class="header-anchor" href="#加锁" aria-hidden="true">#</a> 加锁</h5><p><code>int pthread_mutex_lock(pthread_mutex_t *mutex);</code> 函数用于对互斥量进行加锁。当一个线程对互斥量加锁后，其他线程如果试图对同一互斥量加锁，将会被阻塞，直到拥有锁的线程释放锁。</p><ul><li><code>mutex</code> 指向要加锁的互斥量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_mutex_trylock(pthread_mutex_t *mutex);</code> 用于尝试对互斥量进行非阻塞加锁。如果互斥量当前未被其他线程锁定，调用 <code>pthread_mutex_trylock</code> 将成功获取锁，并立即返回；否则，它将返回一个错误码，而不会阻塞线程。</p><ul><li><code>mutex</code> 指向要尝试加锁的互斥量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果互斥量已经被锁定，返回 <code>EBUSY</code>（互斥量被忙占）。</li><li>如果失败，返回其他错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="解锁" tabindex="-1"><a class="header-anchor" href="#解锁" aria-hidden="true">#</a> 解锁</h5><p><code>int pthread_mutex_unlock(pthread_mutex_t *mutex);</code> 用于对互斥量进行解锁。当一个线程对互斥量解锁后，其他线程可以再次尝试对该互斥量加锁。</p><ul><li><code>mutex</code> 指向要解锁的互斥量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="实例" tabindex="-1"><a class="header-anchor" href="#实例" aria-hidden="true">#</a> 实例</h5><p>加锁前：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>
		a <span class="token operator">=</span> i<span class="token punctuation">;</span>
		b <span class="token operator">=</span> i<span class="token punctuation">;</span>
		c <span class="token operator">=</span> i<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">!=</span>b <span class="token operator">||</span> a<span class="token operator">!=</span>c <span class="token operator">||</span> b<span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 %d %d %d \n&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>
        a <span class="token operator">=</span> i<span class="token punctuation">;</span>
        b <span class="token operator">=</span> i<span class="token punctuation">;</span>
        c <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">!=</span>b <span class="token operator">||</span> a<span class="token operator">!=</span>c <span class="token operator">||</span> b<span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 %d %d %d \n&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_mutex</span>
thread <span class="token number">1</span> <span class="token number">835767</span> <span class="token number">835776</span> <span class="token number">835776</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>因为在给a、b、c 赋值的时候，可能失去CPU了，后被另一个线程获得，然后就导致a、b、c的值不一样</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>
		a <span class="token operator">=</span> i<span class="token punctuation">;</span>
		b <span class="token operator">=</span> i<span class="token punctuation">;</span>
		c <span class="token operator">=</span> i<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">!=</span>b <span class="token operator">||</span> a<span class="token operator">!=</span>c <span class="token operator">||</span> b<span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 %d %d %d \n&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">;</span>
        a <span class="token operator">=</span> i<span class="token punctuation">;</span>
        b <span class="token operator">=</span> i<span class="token punctuation">;</span>
        c <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token operator">!=</span>b <span class="token operator">||</span> a<span class="token operator">!=</span>c <span class="token operator">||</span> b<span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 %d %d %d \n&quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>没有输出，因为加锁保证了原子性操作，所以 a、b、c的值永远相等</p></blockquote><h4 id="信号量" tabindex="-1"><a class="header-anchor" href="#信号量" aria-hidden="true">#</a> 信号量</h4><p>信号量是一种用于线程同步的机制，通常用于控制多个线程对共享资源的访问。信号量主要有两种类型：二进制信号量和计数信号量。</p><h5 id="二进制信号量" tabindex="-1"><a class="header-anchor" href="#二进制信号量" aria-hidden="true">#</a> 二进制信号量</h5><ul><li>二进制信号量只有两个状态，通常用于互斥访问共享资源。它的值可以是0或1。</li><li>常见的函数包括 <code>sem_init</code>（初始化信号量）、<code>sem_wait</code>（等待信号量减一，如果当前值为0，则阻塞线程）、<code>sem_post</code>（增加信号量的值，唤醒等待的线程）、<code>sem_destroy</code>（销毁信号量）等。</li></ul><h5 id="计数信号量" tabindex="-1"><a class="header-anchor" href="#计数信号量" aria-hidden="true">#</a> 计数信号量</h5><ul><li>计数信号量允许一个整数值，通常用于控制同时访问共享资源的线程数量。</li><li>常见的函数包括 <code>sem_init</code>、<code>sem_wait</code>、<code>sem_post</code>、<code>sem_destroy</code>等。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="初始化信号量-sem-init" tabindex="-1"><a class="header-anchor" href="#初始化信号量-sem-init" aria-hidden="true">#</a> 初始化信号量 sem_init</h5><p><code>int sem_init(sem_t *sem, int pshared, unsigned int value);</code> 是在POSIX标准中定义的，用于初始化一个信号量。这个函数通常在使用信号量之前调用，以设置信号量的初始值。</p><ul><li><code>sem</code>：指向要初始化的信号量的指针。</li><li><code>pshared</code>：指定信号量是在进程间共享还是在线程间共享。如果为0，表示信号量在当前进程的所有线程之间共享；如果为非零值，表示信号量可以在多个进程之间共享。</li><li><code>value</code>：指定信号量的初始值。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><h5 id="等待-阻塞-信号量的值减小-sem-wait" tabindex="-1"><a class="header-anchor" href="#等待-阻塞-信号量的值减小-sem-wait" aria-hidden="true">#</a> 等待（阻塞）信号量的值减小 sem_wait</h5><p><code>int sem_wait(sem_t *sem);</code> 是一个信号量操作函数，用于等待（阻塞）信号量的值减小。如果信号量的值大于零，<code>sem_wait</code> 函数将信号量的值减一，并立即返回。如果信号量的值为零，<code>sem_wait</code> 函数将阻塞当前线程，直到信号量的值变为非零。</p><ul><li><code>sem</code>：指向要等待的信号量的指针。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><h5 id="增加信号量的值-sem-post" tabindex="-1"><a class="header-anchor" href="#增加信号量的值-sem-post" aria-hidden="true">#</a> 增加信号量的值 sem_post</h5><p><code>int sem_post(sem_t *sem);</code> 是一个信号量操作函数，用于增加信号量的值。它通常用于在进程或线程结束对共享资源的访问时释放信号量，以允许其他等待该信号量的进程或线程继续执行。</p><ul><li><code>sem</code>：指向要增加值的信号量的指针。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><h5 id="销毁-释放-信号量-sem-destroy" tabindex="-1"><a class="header-anchor" href="#销毁-释放-信号量-sem-destroy" aria-hidden="true">#</a> 销毁（释放）信号量 sem_destroy</h5><p><code>int sem_destroy(sem_t *sem);</code> 是一个信号量操作函数，用于销毁（释放）先前通过 <code>sem_init</code> 初始化的信号量。在不再需要信号量时，应该调用 <code>sem_destroy</code> 来释放相关的资源。</p><ul><li><code>sem</code>：指向要销毁的信号量的指针。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><h5 id="信号量例子" tabindex="-1"><a class="header-anchor" href="#信号量例子" aria-hidden="true">#</a> 信号量例子</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NUM</span> <span class="token expression"><span class="token number">5</span></span></span>
<span class="token keyword">int</span> list<span class="token punctuation">[</span>NUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">pthread_mutex_t</span> mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token class-name">sem_t</span> left<span class="token punctuation">,</span>has<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>j <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果货架容量为0，则等待</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;producer : %d \n&quot;</span><span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
		list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> NUM<span class="token punctuation">;</span>
		<span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;consumer%d : %d\n&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> NUM<span class="token punctuation">;</span>
		<span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>left<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>NUM<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计数信号量，货架容量为NUM</span>
	<span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 二进制信号量，表示货架是否有商品</span>

	<span class="token class-name">pthread_t</span> pid<span class="token punctuation">,</span>cid<span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>producer<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>consumer<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>consumer<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>cid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>producer <span class="token builtin class-name">:</span> <span class="token number">1</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">1</span>
producer <span class="token builtin class-name">:</span> <span class="token number">2</span>
producer <span class="token builtin class-name">:</span> <span class="token number">3</span>
producer <span class="token builtin class-name">:</span> <span class="token number">4</span>
producer <span class="token builtin class-name">:</span> <span class="token number">5</span>
producer <span class="token builtin class-name">:</span> <span class="token number">6</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">2</span>
producer <span class="token builtin class-name">:</span> <span class="token number">7</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">3</span>
producer <span class="token builtin class-name">:</span> <span class="token number">8</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">4</span>
producer <span class="token builtin class-name">:</span> <span class="token number">9</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">5</span>
producer <span class="token builtin class-name">:</span> <span class="token number">10</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">6</span>
producer <span class="token builtin class-name">:</span> <span class="token number">11</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">7</span>
producer <span class="token builtin class-name">:</span> <span class="token number">12</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">8</span>
producer <span class="token builtin class-name">:</span> <span class="token number">13</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">9</span>
producer <span class="token builtin class-name">:</span> <span class="token number">14</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">10</span>
producer <span class="token builtin class-name">:</span> <span class="token number">15</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">11</span>
producer <span class="token builtin class-name">:</span> <span class="token number">16</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">12</span>
producer <span class="token builtin class-name">:</span> <span class="token number">17</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">13</span>
producer <span class="token builtin class-name">:</span> <span class="token number">18</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">14</span>
producer <span class="token builtin class-name">:</span> <span class="token number">19</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">15</span>
producer <span class="token builtin class-name">:</span> <span class="token number">20</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">16</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">17</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">18</span>
consumer1 <span class="token builtin class-name">:</span> <span class="token number">19</span>
consumer2 <span class="token builtin class-name">:</span> <span class="token number">20</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="读写锁" tabindex="-1"><a class="header-anchor" href="#读写锁" aria-hidden="true">#</a> 读写锁</h4><h5 id="什么是读写锁-它与互斥量的区别" tabindex="-1"><a class="header-anchor" href="#什么是读写锁-它与互斥量的区别" aria-hidden="true">#</a> 什么是读写锁，它与互斥量的区别</h5><p>读写锁与互斥量类似，不过读写锁有更高的并行性。</p><ul><li>互斥量要么加锁，要么不加锁，并且同一时刻只允许一个线程对其加锁。对于一个变量的读取，完全可以让多个线程同时操作。</li></ul><p><strong>读写锁非常适合对数据结构读次数大于写次数的程序</strong></p><p><strong>读写锁有3种状态</strong></p><ul><li><strong>读模式下加锁</strong><ul><li>在它被解锁之前，所有试图对这个锁加锁的线程都会阻塞。</li><li>当它以写模式加锁时，是以独占的方式锁住的。</li></ul></li><li><strong>写模式下加锁</strong><ul><li>所有试图以读模式对其加锁的线程都会获得访问权</li><li>但是如果线程希望以写模式对其加锁，它必须阻塞直到所有线程释放锁。</li><li>如果有线程试图以写模式对其加锁，那么读写锁会阻塞随后的读模式锁请求。</li><li>当它以读模式加锁时，是以共享的方式锁住的。</li></ul></li><li>不加锁</li></ul><p><strong>一次只有一个线程可以占有写模式下的读写锁，但是多个线程可以同时占用读模式下的读写锁。</strong></p><h5 id="读写锁初始化" tabindex="-1"><a class="header-anchor" href="#读写锁初始化" aria-hidden="true">#</a> 读写锁初始化</h5><p><code>int pthread_rwlock_init(pthread_rwlock_t *rwlock, const pthread_rwlockattr_t *attr);</code> 函数用于初始化读写锁（read-write lock）。读写锁允许多个线程同时获得读取访问权限，但只允许一个线程获得写入访问权限。</p><ul><li><code>rwlock</code> 指向要初始化的读写锁的指针。</li><li><code>attr</code> 指向读写锁属性的指针，通常可以传递为 <code>NULL</code>，表示使用默认属性。如果需要自定义读写锁的属性，可以使用 <code>pthread_rwlockattr_init</code> 和相关函数创建和设置属性。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="读写锁销毁" tabindex="-1"><a class="header-anchor" href="#读写锁销毁" aria-hidden="true">#</a> 读写锁销毁</h5><p><code>int pthread_rwlock_destroy(pthread_rwlock_t *rwlock);</code> 函数用于销毁读写锁（read-write lock），释放其占用的资源。销毁读写锁之前，应确保没有任何线程在持有该锁，否则销毁操作可能会导致未定义的行为。</p><ul><li><code>rwlock</code> 指向要销毁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="读模式加锁" tabindex="-1"><a class="header-anchor" href="#读模式加锁" aria-hidden="true">#</a> 读模式加锁</h5><p><code>int pthread_rwlock_rdlock(pthread_rwlock_t *rwlock);</code> 函数用于以读取方式加锁读写锁（read-write lock）。读取方式的加锁允许多个线程同时获得读取访问权限，但不允许写入访问。</p><ul><li><code>rwlock</code> 指向要加读锁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_rwlock_tryrdlock(pthread_rwlock_t *rwlock);</code> 函数用于尝试以非阻塞方式以读取方式加锁读写锁（read-write lock）。如果读写锁当前没有被写入锁定，调用 <code>pthread_rwlock_tryrdlock</code> 将成功获取读锁，立即返回；否则，它将返回错误码，而不会阻塞线程。</p><ul><li><code>rwlock</code> 指向要加读锁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果读写锁当前已被写入锁定，返回 <code>EBUSY</code>（资源忙占）。</li><li>如果失败，返回其他错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="写模式加锁" tabindex="-1"><a class="header-anchor" href="#写模式加锁" aria-hidden="true">#</a> 写模式加锁</h5><p><code>int pthread_rwlock_wrlock(pthread_rwlock_t *rwlock);</code> 函数用于以写入方式加锁读写锁（read-write lock）。写入方式的加锁只允许一个线程获得写入访问权限，而不允许其他线程获得读取或写入访问。</p><ul><li><code>rwlock</code> 指向要加写锁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_rwlock_trywrlock(pthread_rwlock_t *rwlock);</code> 函数用于尝试以非阻塞方式以写入方式加锁读写锁（read-write lock）。如果读写锁当前没有被任何线程锁定，调用 <code>pthread_rwlock_trywrlock</code> 将成功获取写锁，立即返回；否则，它将返回错误码，而不会阻塞线程。</p><ul><li><code>rwlock</code> 指向要尝试加写锁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果读写锁当前已被锁定，返回 <code>EBUSY</code>（资源忙占）。</li><li>如果失败，返回其他错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="读写锁解锁" tabindex="-1"><a class="header-anchor" href="#读写锁解锁" aria-hidden="true">#</a> 读写锁解锁</h5><p><code>int pthread_rwlock_unlock(pthread_rwlock_t *rwlock);</code> 函数用于解锁读写锁（read-write lock）。当一个线程完成了对读写锁的读取或写入操作后，应该调用 <code>pthread_rwlock_unlock</code> 来释放锁，以便其他线程可以获得对该锁的访问。</p><ul><li><code>rwlock</code> 指向要解锁的读写锁的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="实例-1" tabindex="-1"><a class="header-anchor" href="#实例-1" aria-hidden="true">#</a> 实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_rwlock_t</span> rwlock<span class="token punctuation">;</span>
<span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 print num %d \n&quot;</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 is over \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 2 print num %d \n&quot;</span><span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 2 is over \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;init rwlock failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 2 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="条件变量" tabindex="-1"><a class="header-anchor" href="#条件变量" aria-hidden="true">#</a> 条件变量</h4><h5 id="条件变量的引入" tabindex="-1"><a class="header-anchor" href="#条件变量的引入" aria-hidden="true">#</a> 条件变量的引入</h5><p>条件变量用于在线程之间建立通信机制，允许线程等待某个条件的发生。它通常与互斥量一起使用，以实现线程的等待和唤醒机制。当线程在某个条件上等待时，它会释放互斥锁，使得其他线程可以在该互斥锁上执行。当条件发生时，线程被唤醒，重新获取互斥锁，然后继续执行。</p><p>例如：货架有生产者和消费者，生产者负责补货，消费者负责消费，货架容量有限，当货架有货时，通知消费者消费，当货架有空位时，通知生产者补货。</p><h5 id="初始化" tabindex="-1"><a class="header-anchor" href="#初始化" aria-hidden="true">#</a> 初始化</h5><p><strong>动态初始化</strong></p><p><code>int pthread_cond_init(pthread_cond_t *cond, const pthread_condattr_t *attr);</code> 函数用于初始化条件变量（condition variable）。在使用条件变量之前，需要调用该函数进行初始化。</p><ul><li><code>cond</code>：指向要初始化的条件变量的指针。</li><li><code>attr</code>：指向条件变量属性的指针。可以为 <code>NULL</code>，表示使用默认属性。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><strong>静态初始化</strong></p><p><code>PTHREAD_MUTEX_INITIALIZER</code> 是一个宏，用于静态地初始化一个条件变量。这个宏会创建一个包含所有必要初始化信息的条件变量对象。<strong>使用静态初始化时，不需要调用 <code>pthread_cond_destroy</code>。</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token class-name">pthread_cond_t</span> my_condition <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用 <code>PTHREAD_COND_INITIALIZER</code> 可以避免显式调用 <code>pthread_cond_init</code> 进行初始化。请注意，这种方式只适用于静态初始化，不能用于动态初始化，也就是不能在运行时进行初始化。</p><h5 id="销毁" tabindex="-1"><a class="header-anchor" href="#销毁" aria-hidden="true">#</a> 销毁</h5><p><code>int pthread_cond_destroy(pthread_cond_t *cond);</code> 函数用于销毁条件变量（condition variable）。在使用完条件变量后，应该调用该函数来释放相关资源。</p><ul><li><code>cond</code>：指向要销毁的条件变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="使用" tabindex="-1"><a class="header-anchor" href="#使用" aria-hidden="true">#</a> 使用</h5><p><code>int pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex);</code> 函数用于使线程在条件变量上等待（阻塞），直到其他线程通过调用 <code>pthread_cond_signal</code> 或 <code>pthread_cond_broadcast</code> 发送信号通知，或者等待的线程被中断（被信号中断）。</p><ul><li><code>cond</code>：指向条件变量的指针。</li><li><code>mutex</code>：指向与条件变量关联的互斥锁的指针。<strong>在调用 <code>pthread_cond_wait</code> 之前，必须先锁定这个互斥锁。</strong></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_cond_timedwait(pthread_cond_t *cond, pthread_mutex_t *mutex, const struct timespec *abstime);</code> 函数是 <code>pthread_cond_wait</code> 的一个变体，允许线程在等待条件变量的同时设置一个超时时间，即使条件没有满足，也能在指定的时间后返回。</p><ul><li><code>cond</code>：指向条件变量的指针。</li><li><code>mutex</code>：指向与条件变量关联的互斥锁的指针。<strong>在调用 <code>pthread_cond_timedwait</code> 之前，必须先锁定这个互斥锁。</strong></li><li><code>abstime</code>：指向 <code>struct timespec</code> 结构的指针，表示等待的超时时间。</li><li><code>return</code><ul><li>如果条件满足，或者在超时前收到信号，返回 0。</li><li>如果超时，返回 <code>ETIMEDOUT</code>。</li><li>如果其他错误，返回相应的错误码。</li></ul></li></ul><blockquote><p>需要注意：<code>abstime</code> 是一个绝对时间。例如要等待<code>3</code>分钟，就要先获取当前时间然后加上<code>3</code>分钟，而不是直接将<code>3</code>分钟转为 <code>timespec</code>。</p></blockquote><blockquote><p><code>timespec</code> 是一个结构体，用于表示时间。在 POSIX 环境下，通常用于传递时间信息，例如在等待一定时间后超时。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token punctuation">{</span>
    <span class="token class-name">time_t</span> tv_sec<span class="token punctuation">;</span>  <span class="token comment">// 秒数</span>
    <span class="token keyword">long</span>   tv_nsec<span class="token punctuation">;</span> <span class="token comment">// 纳秒数（nanoseconds）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>tv_sec</code>：表示秒数，是一个整数类型的数据，用于表示从某个起始点（通常是1970年1月1日）到现在的秒数。</li><li><code>tv_nsec</code>：表示纳秒数，是一个长整数类型的数据，用于表示秒数之外的部分，以纳秒为单位。</li></ul><p>结合两者，<code>struct timespec</code> 可以精确表示一个时间点，通常用于在多线程编程中控制等待时间。</p><p>例如，在使用 <code>pthread_cond_timedwait</code> 函数时，可以通过 <code>struct timespec</code> 来表示等待的超时时间。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token class-name">pthread_mutex_t</span> my_mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token class-name">pthread_cond_t</span> my_condition <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>
<span class="token keyword">int</span> shared_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_function</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 加锁</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待条件满足或超时</span>
    <span class="token keyword">struct</span> <span class="token class-name">timespec</span> ts<span class="token punctuation">;</span>
    <span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_REALTIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ts<span class="token punctuation">.</span>tv_sec <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// 设置等待超时时间为 5 秒</span>

    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">pthread_cond_timedwait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_condition<span class="token punctuation">,</span> <span class="token operator">&amp;</span>my_mutex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 条件满足，执行操作</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Thread is awake, shared_data: %d\n&quot;</span><span class="token punctuation">,</span> shared_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> ETIMEDOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 超时</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Thread timed out waiting for condition\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其他错误</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;pthread_cond_timedwait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解锁</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>

    <span class="token comment">// 创建线程</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_function<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 加锁</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 修改共享数据，条件满足</span>
    shared_data <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送信号通知等待的线程</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_condition<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 解锁</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>my_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 等待线程结束</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int pthread_cond_broadcast(pthread_cond_t *cond);</code> 函数用于向所有等待在条件变量上的线程发送信号，通知它们条件已经满足。<strong>这个函数通常在共享资源发生改变，并且多个线程等待这个改变的时候使用，以唤醒所有等待的线程。</strong></p><ul><li><code>cond</code>：指向条件变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_cond_signal(pthread_cond_t *cond);</code> 函数用于向等待在条件变量上的单个线程发送信号，通知它条件已经满足。<strong>通常在共享资源发生改变，只有一个线程需要被唤醒的情况下使用。</strong></p><ul><li><code>cond</code>：指向条件变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><strong>注意，一定要在条件改变以后再唤醒线程</strong></p><h5 id="实例-2" tabindex="-1"><a class="header-anchor" href="#实例-2" aria-hidden="true">#</a> 实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">5</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PRODUCT_CNT</span> <span class="token expression"><span class="token number">30</span></span></span>
<span class="token keyword">struct</span> <span class="token class-name">product_cons</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> readpos<span class="token punctuation">;</span>
	<span class="token keyword">int</span> writepos<span class="token punctuation">;</span>
	<span class="token class-name">pthread_mutex_t</span> lock<span class="token punctuation">;</span>
	<span class="token class-name">pthread_cond_t</span> notempty<span class="token punctuation">;</span>
	<span class="token class-name">pthread_cond_t</span> notfull<span class="token punctuation">;</span>
<span class="token punctuation">}</span> buffer<span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">product_cons</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notempty<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notfull<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>readpos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>writepos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">product_cons</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notempty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notfull<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>readpos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>writepos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 存储一个数据到buffer</span>
<span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">product_cons</span> <span class="token operator">*</span>p<span class="token punctuation">,</span><span class="token keyword">int</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 如果库存满了，则先等待消费</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>writepos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> BUFFER_SIZE <span class="token operator">==</span> p<span class="token operator">-&gt;</span>readpos<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;producer wait for notfull ...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notfull<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	p<span class="token operator">-&gt;</span>buffer<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>writepos <span class="token operator">%</span> BUFFER_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>writepos<span class="token operator">++</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>writepos <span class="token operator">=</span> p<span class="token operator">-&gt;</span>writepos <span class="token operator">%</span> BUFFER_SIZE<span class="token punctuation">;</span>

	<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notempty<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//读取并移除一个数据从buffer</span>
<span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">product_cons</span> <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">{</span>
	 <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果没有库存，等待</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>readpos <span class="token operator">==</span> p<span class="token operator">-&gt;</span>writepos<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;consumer wait for notempty ...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notempty<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   	<span class="token keyword">int</span> data <span class="token operator">=</span> p<span class="token operator">-&gt;</span>buffer<span class="token punctuation">[</span>p<span class="token operator">-&gt;</span>readpos <span class="token operator">%</span> BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>readpos<span class="token operator">++</span><span class="token punctuation">;</span>
    p<span class="token operator">-&gt;</span>readpos <span class="token operator">=</span> p<span class="token operator">-&gt;</span>readpos <span class="token operator">%</span> BUFFER_SIZE<span class="token punctuation">;</span><span class="token punctuation">;</span>

	<span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>notfull<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 每秒钟生产一个</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> PRODUCT_CNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;put the %d product ...\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;put the %d product success. \n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 每2秒钟消费一个</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;get product ...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> data <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;get the %d product success.\n&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>cnt <span class="token operator">==</span> PRODUCT_CNT<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>producer<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>consumer<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">finish</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_cond</span>
put the <span class="token number">1</span> product <span class="token punctuation">..</span>.
put the <span class="token number">1</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">1</span> product success.
put the <span class="token number">2</span> product <span class="token punctuation">..</span>.
put the <span class="token number">2</span> product success.
put the <span class="token number">3</span> product <span class="token punctuation">..</span>.
put the <span class="token number">3</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">2</span> product success.
put the <span class="token number">4</span> product <span class="token punctuation">..</span>.
put the <span class="token number">4</span> product success.
put the <span class="token number">5</span> product <span class="token punctuation">..</span>.
put the <span class="token number">5</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">3</span> product success.
put the <span class="token number">6</span> product <span class="token punctuation">..</span>.
put the <span class="token number">6</span> product success.
put the <span class="token number">7</span> product <span class="token punctuation">..</span>.
put the <span class="token number">7</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">4</span> product success.
put the <span class="token number">8</span> product <span class="token punctuation">..</span>.
put the <span class="token number">8</span> product success.
put the <span class="token number">9</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">5</span> product success.
put the <span class="token number">9</span> product success.
put the <span class="token number">10</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">6</span> product success.
put the <span class="token number">10</span> product success.
put the <span class="token number">11</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">7</span> product success.
put the <span class="token number">11</span> product success.
put the <span class="token number">12</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">8</span> product success.
put the <span class="token number">12</span> product success.
put the <span class="token number">13</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">9</span> product success.
put the <span class="token number">13</span> product success.
put the <span class="token number">14</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">10</span> product success.
put the <span class="token number">14</span> product success.
put the <span class="token number">15</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">11</span> product success.
put the <span class="token number">15</span> product success.
put the <span class="token number">16</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">12</span> product success.
put the <span class="token number">16</span> product success.
put the <span class="token number">17</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">13</span> product success.
put the <span class="token number">17</span> product success.
put the <span class="token number">18</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">14</span> product success.
put the <span class="token number">18</span> product success.
put the <span class="token number">19</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">15</span> product success.
put the <span class="token number">19</span> product success.
put the <span class="token number">20</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">16</span> product success.
put the <span class="token number">20</span> product success.
put the <span class="token number">21</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">17</span> product success.
put the <span class="token number">21</span> product success.
put the <span class="token number">22</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">18</span> product success.
put the <span class="token number">22</span> product success.
put the <span class="token number">23</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">19</span> product success.
put the <span class="token number">23</span> product success.
put the <span class="token number">24</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">20</span> product success.
put the <span class="token number">24</span> product success.
put the <span class="token number">25</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">21</span> product success.
put the <span class="token number">25</span> product success.
put the <span class="token number">26</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">22</span> product success.
put the <span class="token number">26</span> product success.
put the <span class="token number">27</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">23</span> product success.
put the <span class="token number">27</span> product success.
put the <span class="token number">28</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">24</span> product success.
put the <span class="token number">28</span> product success.
put the <span class="token number">29</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">25</span> product success.
put the <span class="token number">29</span> product success.
put the <span class="token number">30</span> product <span class="token punctuation">..</span>.
producer <span class="token function">wait</span> <span class="token keyword">for</span> notfull <span class="token punctuation">..</span>.
get product <span class="token punctuation">..</span>.
get the <span class="token number">26</span> product success.
put the <span class="token number">30</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">27</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">28</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">29</span> product success.
get product <span class="token punctuation">..</span>.
get the <span class="token number">30</span> product success.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、线程高级控制" tabindex="-1"><a class="header-anchor" href="#四、线程高级控制" aria-hidden="true">#</a> 四、线程高级控制</h3><h4 id="一次性初始化" tabindex="-1"><a class="header-anchor" href="#一次性初始化" aria-hidden="true">#</a> 一次性初始化</h4><p>在多线程编程中，有时我们需要确保某些操作只被执行一次，避免多个线程多次执行同一段代码。为了实现这个目标，可以使用一次性初始化（One-time Initialization）机制，其中涉及到的函数包括 <code>pthread_once</code> 和 <code>pthread_key_create</code></p><h5 id="pthread-once" tabindex="-1"><a class="header-anchor" href="#pthread-once" aria-hidden="true">#</a> pthread_once</h5><p><code>int pthread_once(pthread_once_t *once_control, void (*init_routine)(void));</code> 函数用于确保一个特定的初始化函数（init_routine）只被执行一次，即使多个线程同时调用 <code>pthread_once</code>。它通常与全局变量或资源的初始化一起使用，以确保这些初始化只在第一次调用时执行。</p><ul><li><code>once_control</code> 一个 <code>pthread_once_t</code> 类型的控制变量，用于跟踪初始化是否已经完成。应初始化为 <code>PTHREAD_ONCE_INIT</code>。</li><li><code>init_routine</code> 一个指向初始化函数的指针，这个函数只会在第一次调用 <code>pthread_once</code> 时执行。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p><strong>Linux Threads 使用互斥锁和条件变量来保证 <code>pthread_once()</code> 指定的函数仅执行一次。</strong></p></blockquote><p>一般来说，<code>pthread_once_t</code> 有三个可能的状态：</p><ul><li><code>NEVER(0)</code>：初始状态，表示初始化函数从未执行过。</li><li><code>IN_PROGRESS(1)</code>：表示初始化函数正在执行中。</li><li><code>DONE(2)</code>：表示初始化函数已经成功执行过。</li></ul><p><strong>如果<code>pthread_once_t</code>的初始值为：</strong></p><ul><li><code>0</code> 表示 <code>pthread_once</code> 从执行过，<code>init_routine</code> 会执行。</li><li><code>1</code> 表示 <code>pthread_once</code> 正在执行，则所有 <code>pthread_once</code> 函数都必须等待其中一个激发 &quot;<code>已执行一次</code>&quot; 信号，否则所有的 <code>pthread_once</code> 都会陷入永久的等待中，<code>init_routine</code> 也就无法执行</li><li><code>2</code> 表示 <code>pthread_once</code> 已经执行过一次，从而所有的 <code>pthread_once</code> 都会立即返回，<code>init_routine </code>则没有机会执行。</li></ul><blockquote><p>在不同系统上可能有所不同，因为这是底层实现的细节，取决于系统对于 <code>pthread_once</code> 的具体实现。</p></blockquote><h5 id="实例-3" tabindex="-1"><a class="header-anchor" href="#实例-3" aria-hidden="true">#</a> 实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_once_t</span> once <span class="token operator">=</span> PTHREAD_ONCE_INIT<span class="token punctuation">;</span>
<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">thread_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread_init 0x%lx\n&quot;</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 1 tid is : %lx\n&quot;</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>once<span class="token punctuation">,</span>thread_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread1 call once is 0x%lx\n&quot;</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 2 tid is : %lx\n&quot;</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>once<span class="token punctuation">,</span>thread_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread2 call once is 0x%lx\n&quot;</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 1 failed.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 2 failed.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_once</span>
I am thread <span class="token number">1</span> tid is <span class="token builtin class-name">:</span> ffffa963f1a0
I am thread_init 0xffffa963f1a0
thread1 call once is 0xffffa963f1a0
I am thread <span class="token number">2</span> tid is <span class="token builtin class-name">:</span> ffffa8e2f1a0
thread2 call once is 0xffffa8e2f1a0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程属性" tabindex="-1"><a class="header-anchor" href="#线程属性" aria-hidden="true">#</a> 线程属性</h4><p><code>pthread_attr_t</code> 是一个线程属性对象，用于设置线程的一些属性和参数。通过 <code>pthread_attr_t</code>，你可以在创建线程时指定一些特定的属性，例如线程的栈大小、调度策略等。</p><p>线程属性：</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>detachstate</td><td>分离状态</td></tr><tr><td>policy</td><td>调度策略</td></tr><tr><td>param</td><td>调度参数</td></tr><tr><td>inherit</td><td>继承调度属性</td></tr><tr><td>scope</td><td>线程作用域</td></tr><tr><td>stacksize</td><td>栈大小</td></tr></tbody></table><blockquote><p>并不是所有的操作系统都支持这些属性，因此需要检查当前系统是否支持这些属性</p></blockquote><h5 id="线程属性初始化" tabindex="-1"><a class="header-anchor" href="#线程属性初始化" aria-hidden="true">#</a> 线程属性初始化</h5><p><code>int pthread_attr_init(pthread_attr_t *attr);</code> 函数用于初始化线程属性对象 <code>pthread_attr_t</code>，将其设置为默认值。这个函数在使用线程属性之前通常需要调用一次，以确保线程属性对象的正确初始化。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，用于存储初始化后的线程属性。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="线程属性销毁" tabindex="-1"><a class="header-anchor" href="#线程属性销毁" aria-hidden="true">#</a> 线程属性销毁</h5><p><code>int pthread_attr_init(pthread_attr_t *attr);</code> 函数用于销毁线程属性对象 <code>pthread_attr_t</code>，释放相关资源。在使用线程属性对象后，如果不再需要，应该调用此函数进行清理，以防止内存泄漏。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，该对象在函数调用后不再可用。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h4 id="线程的分离属性" tabindex="-1"><a class="header-anchor" href="#线程的分离属性" aria-hidden="true">#</a> 线程的分离属性</h4><p>分离一个正在运行的线程并不影响它，仅仅是通知当前系统该线程结束时，其所属的资源可以回收，一个没有被分离的线程，在终止时会保留它的虚拟内存，包括它们的堆栈和其他系统资源，有时这种线程被称为 “僵尸线程”。<strong>创建线程时默认是非分离的</strong></p><p>如果线程具有分离属性，线程终止时会立即回收，**回收将释放掉所有在线程终止时未释放的系统资源和进程资源，**包括线程返回值的内存空间、堆栈、保存寄存器的内存空间等。</p><p>终止被分离的线程，会释放该线程所有的系统资源，但是你必须释放由该线程占用的程序资源。由malloc或mmap分配的内存可以在任何时候由任何线程释放，条件便利、互斥量、信号量可以由任何线程销毁，只要他们被解锁了或没有线程等待。<strong>但是互斥量只有它的主人才能解锁它，所以在线程终止前，你需要解锁互斥量。</strong></p><h5 id="分离属性的使用方法" tabindex="-1"><a class="header-anchor" href="#分离属性的使用方法" aria-hidden="true">#</a> 分离属性的使用方法</h5><p>如果在创建线程的时候就知道不需要了解线程的运行状态，那么就可以修改<code>pthread_attr_t</code> 的 <code>detachstate</code> 属性，让线程以分离状态启动。</p><h5 id="设置线程分离属性" tabindex="-1"><a class="header-anchor" href="#设置线程分离属性" aria-hidden="true">#</a> 设置线程分离属性</h5><p><code>int pthread_attr_setdetachstate(pthread_attr_t *attr, int detachstate);</code> 函数用于设置线程的分离状态，即指定线程是可分离（detached）还是 非分离状态，非分离状态需要等待其他线程调用 <code>pthread_join</code> 来回收资源（joinable）。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要设置的线程属性。</li><li><code>detachstate</code> 指定线程的分离状态，可以取以下值之一： <ul><li><code>PTHREAD_CREATE_DETACHED</code>：表示线程是可分离的，它会在线程结束时自动释放资源，不需要其他线程调用 <code>pthread_join</code>。</li><li><code>PTHREAD_CREATE_JOINABLE</code>：表示线程需要其他线程调用 <code>pthread_join</code> 来回收资源，否则可能导致资源泄漏。</li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="获取线程分离状态" tabindex="-1"><a class="header-anchor" href="#获取线程分离状态" aria-hidden="true">#</a> 获取线程分离状态</h5><p><code>int pthread_attr_getdetachstate(const pthread_attr_t *attr, int *detachstate);</code> 函数用于获取线程的分离状态，即判断线程是可分离的还是非分离状态（需要等待其他线程调用 <code>pthread_join</code> 来回收资源）。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要获取信息的线程属性。</li><li><code>detachstate</code>：指向整型变量的指针，用于存储获取的线程分离状态，可以是 <code>PTHREAD_CREATE_DETACHED</code> 或 <code>PTHREAD_CREATE_JOINABLE</code>。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p>所有的操作系统都支持线程的分离状态属性</p></blockquote><h5 id="线程的分离属性实例" tabindex="-1"><a class="header-anchor" href="#线程的分离属性实例" aria-hidden="true">#</a> 线程的分离属性实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 1\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 2\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token class-name">pthread_attr_t</span> attr<span class="token punctuation">;</span>
	<span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化线程属性</span>
	<span class="token function">pthread_attr_setdetachstate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>PTHREAD_CREATE_DETACHED<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置分离状态属性</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 1 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create new thread 2 failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join thread 1 failed : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join thread 1 success \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join thread 1 failed : %s \n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;join thread 1 success \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 销毁线程属性</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_datachstate</span>
I am thread <span class="token number">1</span>
I am thread <span class="token number">2</span>
<span class="token function">join</span> thread <span class="token number">1</span> success
<span class="token function">join</span> thread <span class="token number">1</span> failed <span class="token builtin class-name">:</span> Invalid argument
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程的栈属性" tabindex="-1"><a class="header-anchor" href="#线程的栈属性" aria-hidden="true">#</a> 线程的栈属性</h4><p>在大多数操作系统中，每个进程都有自己的虚拟地址空间，而每个线程则共享该进程的虚拟地址空间。</p><ul><li>虚拟地址空间的大小取决于操作系统和架构，但都是固定的，如果应用程序中使用了太多的线程，导致线程累计超过可用的虚拟地址空间，这个时候就需要减少线程默认的栈大小。</li><li>另外如果线程分配了大量的自动变量或者栈帧太深，那么这个时候需要的栈要比默认的大。</li></ul><p>pthread_create 创建线程时，若不指定分配堆栈大小，系统会分配默认值，查看默认值方法如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ulimit -s</span>
<span class="token number">8192</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>上述表示为8M；单位为KB。</p><h5 id="修改线程的栈属性" tabindex="-1"><a class="header-anchor" href="#修改线程的栈属性" aria-hidden="true">#</a> 修改线程的栈属性</h5><p><code>int pthread_attr_setstacksize(pthread_attr_t *attr, size_t stacksize);</code> 函数用于设置线程属性对象中的线程栈大小。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要设置的线程属性。</li><li><code>stacksize</code>：指定线程栈的大小，以字节为单位。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="获取线程的栈属性" tabindex="-1"><a class="header-anchor" href="#获取线程的栈属性" aria-hidden="true">#</a> 获取线程的栈属性</h5><p><code>int pthread_attr_getstacksize(const pthread_attr_t *attr, size_t *stacksize);</code> 函数用于获取线程属性对象中的线程栈大小。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要获取信息的线程属性。</li><li><code>stacksize</code>：指向存储线程栈大小的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p><strong>对于栈大小的设置，在创建线程之后还可以修改</strong></p></blockquote><p>对于遵循POSIX标准的系统来说，不一定支持线程的栈属性，因此需要编译检查：</p><ol><li>编译阶段 <code>_POSIX_THREAD_ATTR_STACKADDR</code> 和 <code>_POSIX_THREAD_ATTR_STACKSIZE</code> 符号来检查系统是否支持线程栈属性，这些宏定义在 <code>/usr/include/posix_opt.h</code> 中</li><li>在运行阶段把 <code>_SC_THREAD_ATTR_STACKADDR</code> 和 <code>_SC_THREAD_ATTR_STACKSIZE</code> 传递给 <code>sysconf</code> 函数检查系统对线程栈属性的支持。</li></ol><h5 id="线程栈属性-栈守护区" tabindex="-1"><a class="header-anchor" href="#线程栈属性-栈守护区" aria-hidden="true">#</a> 线程栈属性 栈守护区</h5><p>栈守护区（stack guard）是在线程栈的边缘设置的一段内存，其主要目的是检测栈溢出。栈溢出是指程序在执行过程中使用了超出栈空间范围的内存，可能导致程序崩溃或安全漏洞。</p><p>栈守护区的工作原理是在栈的边缘添加一段额外的内存，被称为守护区。当程序执行时，栈上的数据不断地向下增长，如果数据触及了栈守护区，就表示栈即将溢出。在这种情况下，系统可以检测到栈溢出并采取相应的措施，例如终止程序或生成错误报告。</p><p><code>pthread_attr_setguardsize</code> 函数用于设置线程属性对象中的栈守护区大小。通过调整栈守护区的大小，可以在一定程度上增强程序对栈溢出的检测和防范能力。</p><p>在实际应用中，栈守护区的大小通常由操作系统或编译器决定，并且很多情况下不需要显式设置。然而，对于特殊需求或对栈溢出有严格要求的应用，可以通过调整栈守护区的大小来增加程序的健壮性。</p><p>这个属性的默认值是 <code>PAGESIZE</code> 个字节，你可以把它设置为0，这样就不会提供守护缓冲区。</p><h5 id="设置栈守护区大小" tabindex="-1"><a class="header-anchor" href="#设置栈守护区大小" aria-hidden="true">#</a> 设置栈守护区大小</h5><p><code>int pthread_attr_setguardsize(pthread_attr_t *attr, size_t guardsize);</code> 函数用于设置线程属性对象中的栈守护区（stack guard size）。栈守护区是在线程栈的边缘设置的一段内存，用于检测栈溢出。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要设置的线程属性。</li><li><code>guardsize</code>：指定线程栈的守护区大小，以字节为单位。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="获取栈守护区大小" tabindex="-1"><a class="header-anchor" href="#获取栈守护区大小" aria-hidden="true">#</a> 获取栈守护区大小</h5><p><code>int pthread_attr_getguardsize(const pthread_attr_t *attr, size_t *guardsize);</code> 函数用于设置线程属性对象中的栈守护区（stack guard size）。栈守护区是在线程栈的边缘设置的一段内存，用于检测栈溢出。</p><ul><li><code>attr</code>：指向 <code>pthread_attr_t</code> 对象的指针，表示要获取信息的线程属性。</li><li><code>guardsize</code>：指向存储线程栈守护区大小的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="线程栈属性实例" tabindex="-1"><a class="header-anchor" href="#线程栈属性实例" aria-hidden="true">#</a> 线程栈属性实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_attr_t</span> attr<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">size_t</span> stacksize<span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_POSIX_THREAD_ATTR_STACKSIZE</span></span>
	<span class="token function">pthread_attr_getstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span><span class="token operator">&amp;</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread 1 stack size is %ld \n&quot;</span><span class="token punctuation">,</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_attr_setstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span><span class="token number">131073</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_attr_getstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span><span class="token operator">&amp;</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;new thread 1 stack size is %ld \n&quot;</span><span class="token punctuation">,</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
	<span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_POSIX_THREAD_ATTR_STACKSIZE</span></span>
	<span class="token function">pthread_attr_setstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>PTHREAD_STACK_MIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_attr_stack</span>
new thread <span class="token number">1</span> stack size is <span class="token number">131072</span>
new thread <span class="token number">1</span> stack size is <span class="token number">131073</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程的同步属性" tabindex="-1"><a class="header-anchor" href="#线程的同步属性" aria-hidden="true">#</a> 线程的同步属性</h4><p>就像线程有属性一样，线程的同步互斥量也有属性，比较重要的是进程共享属性和类型属性。</p><p>互斥量的属性用 <code>pthread_mutexattr_t</code> 类型的数据表示，使用之前需要初始化，使用完成后需要销毁。</p><h5 id="互斥量属性初始化" tabindex="-1"><a class="header-anchor" href="#互斥量属性初始化" aria-hidden="true">#</a> 互斥量属性初始化</h5><p><code>int pthread_mutexattr_init(pthread_mutexattr_t *attr);</code> 函数用于初始化互斥量属性对象，该对象用于设置互斥量的属性，例如类型、协议、共享性等。</p><ul><li><code>attr</code>：指向 <code>pthread_mutexattr_t</code> 对象的指针，表示要初始化的互斥量属性对象。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="互斥量属性销毁" tabindex="-1"><a class="header-anchor" href="#互斥量属性销毁" aria-hidden="true">#</a> 互斥量属性销毁</h5><p><code>int pthread_mutexattr_destroy(pthread_mutexattr_t *attr);</code> 函数用于初始化互斥量属性对象，该对象用于设置互斥量的属性，例如类型、协议、共享性等。</p><ul><li><code>attr</code>：指向 <code>pthread_mutexattr_t</code> 对象的指针，表示要销毁的互斥量属性对象。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="进程共享属性" tabindex="-1"><a class="header-anchor" href="#进程共享属性" aria-hidden="true">#</a> 进程共享属性</h5><p><strong>进程共享属性有两个可选项：</strong></p><ul><li><code>PTHREAD_PROCESS_PRIVATE</code> 默认值，同一个进程多个线程可以访问同一个同步对象</li><li><code>PTHREAD_PROCESS_SHARED</code> 这个属性可以使互斥量在多个进程中同步，<strong>如果互斥量在多进程的共享区域，那么具有这个属性的互斥量可以同步多进程。</strong></li></ul><h5 id="设置进程共享属性" tabindex="-1"><a class="header-anchor" href="#设置进程共享属性" aria-hidden="true">#</a> 设置进程共享属性</h5><p><code>int pthread_mutexattr_setpshared(pthread_mutexattr_t *attr, int pshared);</code> 函数用于设置互斥量属性对象中的互斥量的共享性。</p><ul><li><code>attr</code>：指向 <code>pthread_mutexattr_t</code> 对象的指针，表示要设置的互斥量属性。</li><li><code>pshared</code> 指定互斥量的共享性，可以取以下值之一： <ul><li><code>PTHREAD_PROCESS_PRIVATE</code>：互斥量是进程内私有的。</li><li><code>PTHREAD_PROCESS_SHARED</code>：互斥量是可在多个进程之间共享的。</li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="获取进程共享属性" tabindex="-1"><a class="header-anchor" href="#获取进程共享属性" aria-hidden="true">#</a> 获取进程共享属性</h5><p><code>int pthread_mutexattr_getpshared(const pthread_mutexattr_t *attr, int *pshared);</code> 函数用于获取互斥量属性对象中的互斥量的共享性设置。</p><ul><li><code>attr</code>：指向 <code>pthread_mutexattr_t</code> 对象的指针，表示要获取信息的互斥量属性。</li><li><code>pshared</code>：指向存储互斥量共享性设置的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p>进程共享属性需要检测系统是否支持，可以检测宏 <code>_POSIX_THREAD_PROCESS_SHARED</code></p></blockquote><h5 id="互斥量类型属性" tabindex="-1"><a class="header-anchor" href="#互斥量类型属性" aria-hidden="true">#</a> 互斥量类型属性</h5><table><thead><tr><th>互斥量类型</th><th>没有解锁时，再次加锁</th><th>不占用时解锁</th><th>已解锁时解锁</th></tr></thead><tbody><tr><td>PTHREAD_MUTEX_NORMAL</td><td>死锁</td><td>未定义</td><td>未定义</td></tr><tr><td>PTHREAD_MUTEX_ERRORCHEK</td><td>返回错误</td><td>返回错误</td><td>返回错误</td></tr><tr><td>PTHREAD_MUTEX_RECURSIVE</td><td>允许</td><td>返回错误</td><td>返回错误</td></tr><tr><td>PTHREAD_MUTEX_DEFAULT</td><td>未定义</td><td>未定义</td><td>未定义</td></tr></tbody></table><p>获取互斥量类型属性</p><p><code>int pthread_mutexattr_gettype(const pthread_mutexattr_t *attr, int *type);</code> 函数用于获取互斥量属性对象中的互斥量类型设置。</p><ul><li><code>attr</code>：指向 <code>pthread_mutexattr_t</code> 对象的指针，表示要获取信息的互斥量属性。</li><li><code>type</code>：指向存储互斥量类型设置的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h4 id="读写锁属性" tabindex="-1"><a class="header-anchor" href="#读写锁属性" aria-hidden="true">#</a> 读写锁属性</h4><h5 id="读写锁属性初始化与销毁" tabindex="-1"><a class="header-anchor" href="#读写锁属性初始化与销毁" aria-hidden="true">#</a> 读写锁属性初始化与销毁</h5><p><code>int pthread_rwlockattr_init(pthread_rwlockattr_t *attr);</code> 函数用于初始化读写锁属性对象，该对象用于设置读写锁的属性。</p><ul><li><code>attr</code>：指向 <code>pthread_rwlockattr_t</code> 对象的指针，表示要初始化的读写锁属性对象。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_rwlockattr_destroy(pthread_rwlockattr_t *attr);</code> 函数用于销毁读写锁属性对象，释放相关的资源。</p><ul><li><p><code>attr</code>：指向 <code>pthread_rwlockattr_t</code> 对象的指针，表示要销毁的读写锁属性对象。</p></li><li><p><code>return</code></p><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="读写锁进程共享属性" tabindex="-1"><a class="header-anchor" href="#读写锁进程共享属性" aria-hidden="true">#</a> 读写锁进程共享属性</h5><p><code>int pthread_rwlockattr_setpshared(pthread_rwlockattr_t *attr, int shared);</code> 函数用于设置读写锁属性对象中的读写锁的共享性。</p><ul><li><code>attr</code>：指向 <code>pthread_rwlockattr_t</code> 对象的指针，表示要设置的读写锁属性。</li><li><code>shared</code>：指定读写锁的共享性，可以取以下值之一： <ul><li><code>PTHREAD_PROCESS_PRIVATE</code>：读写锁是进程内私有的。</li><li><code>PTHREAD_PROCESS_SHARED</code>：读写锁是可在多个进程之间共享的。</li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_rwlockattr_getpshared(const pthread_rwlockattr_t *attr, int *shared);</code> 函数用于获取读写锁属性对象中的读写锁的共享性设置。</p><ul><li><code>attr</code>：指向 <code>pthread_rwlockattr_t</code> 对象的指针，表示要获取信息的读写锁属性。</li><li><code>shared</code>：指向存储读写锁共享性设置的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h4 id="条件变量属性" tabindex="-1"><a class="header-anchor" href="#条件变量属性" aria-hidden="true">#</a> 条件变量属性</h4><h5 id="条件变量属性初始化与销毁" tabindex="-1"><a class="header-anchor" href="#条件变量属性初始化与销毁" aria-hidden="true">#</a> 条件变量属性初始化与销毁</h5><p><code>int pthread_condattr_init(pthread_condattr_t *attr);</code> 函数用于初始化条件变量属性对象，该对象用于设置条件变量的属性。</p><ul><li><code>attr</code>：指向 <code>pthread_condattr_t</code> 对象的指针，表示要初始化的条件变量属性对象。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_condattr_destroy(pthread_condattr_t *attr);</code> 函数用于销毁条件变量属性对象，释放相关的资源。</p><ul><li><p><code>attr</code>：指向 <code>pthread_condattr_t</code> 对象的指针，表示要销毁的条件变量属性对象。</p></li><li><p><code>return</code></p><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="条件变量进程共享属性" tabindex="-1"><a class="header-anchor" href="#条件变量进程共享属性" aria-hidden="true">#</a> 条件变量进程共享属性</h5><p><code>int pthread_condattr_setpshared(pthread_condattr_t *attr, int shared);</code> 函数用于设置条件变量属性对象中的条件变量的共享性。</p><ul><li><code>attr</code>：指向 <code>pthread_condattr_t</code> 对象的指针，表示要设置的条件变量属性。</li><li><code>shared</code> 指定条件变量的共享性，可以取以下值之一： <ul><li><code>PTHREAD_PROCESS_PRIVATE</code>：条件变量是进程内私有的。</li><li><code>PTHREAD_PROCESS_SHARED</code>：条件变量是可在多个进程之间共享的。</li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><p><code>int pthread_condattr_getpshared(const pthread_condattr_t *attr, int *shared);</code> 函数，用于获取条件变量属性对象中的共享性设置。</p><ul><li><code>attr</code>：指向 <code>pthread_condattr_t</code> 对象的指针，表示要获取信息的条件变量属性。</li><li><code>shared</code>：指向存储条件变量共享性设置的变量的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p><strong>用法是和互斥量同步属性一样的，稍微变通就好</strong></p></blockquote><h4 id="线程的同步属性实例" tabindex="-1"><a class="header-anchor" href="#线程的同步属性实例" aria-hidden="true">#</a> 线程的同步属性实例</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>shm1 <span class="token operator">=</span> <span class="token string">&quot;myshm1&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>shm2 <span class="token operator">=</span> <span class="token string">&quot;myshm2&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> shm1_id<span class="token punctuation">,</span>shm2_id<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>

	<span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">;</span>
	<span class="token class-name">pthread_mutexattr_t</span> mutexattr<span class="token punctuation">;</span>

	<span class="token comment">// 打开共享内存</span>
	shm1_id <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span>shm1<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 调整共享内存大小</span>
	<span class="token function">ftruncate</span><span class="token punctuation">(</span>shm1_id<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 映射共享内存，MAP_SHARED 属性表示，对共享内存的任何修改都会影响其他进程</span>
	mutex <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> shm1_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_POSIX_THREAD_PROCESS_SHARED</span></span>
	<span class="token function">pthread_mutexattr_setpshared</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexattr<span class="token punctuation">,</span>PTHREAD_PROCESS_SHARED<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span>mutex<span class="token punctuation">,</span><span class="token operator">&amp;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 打开共享内存</span>
	shm2_id <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span>shm2<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 调整共享内存大小</span>
	<span class="token function">ftruncate</span><span class="token punctuation">(</span>shm2_id<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 映射共享内存，MAP_SHARED 属性表示，对共享内存的任何修改都会影响其他进程</span>
	buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> shm2_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 休眠1s，让父进程先执行</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child process \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 将共享内存内容修改为 hello</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child buf is : %s\n&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent process \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 修改共享内存内容为 world</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent buf is : %s\n&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 销毁属性</span>
	<span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 接触映射</span>
	<span class="token function">munmap</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 清除共享内存</span>
	<span class="token function">shm_unlink</span><span class="token punctuation">(</span>shm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 接触映射</span>
	<span class="token function">munmap</span><span class="token punctuation">(</span>mutex<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 清除共享内存</span>
	<span class="token function">shm_unlink</span><span class="token punctuation">(</span>shm2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_sync_attr</span>
I am parent process
I am child process
parent buf is <span class="token builtin class-name">:</span> world
child buf is <span class="token builtin class-name">:</span> hello
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="线程私有数据" tabindex="-1"><a class="header-anchor" href="#线程私有数据" aria-hidden="true">#</a> 线程私有数据</h4><p>线程的私有数据是指每个线程可以拥有自己独立的数据，而不会被其他线程访问。在 POSIX 线程库中，你可以使用 <code>pthread_key_create</code> 函数创建线程私有数据的键，然后使用 <code>pthread_setspecific</code> 和 <code>pthread_getspecific</code> 函数设置和获取特定线程的私有数据。</p><p>在 POSIX 线程中，你可以使用线程的私有数据（Thread-Specific Data，简称 TSD）来实现线程间的数据隔离。每个线程都有自己的 TSD 副本，线程可以独立地访问和修改它们自己的 TSD 副本，而不会影响其他线程。</p><p>尽管它们的名字相同，但是在多线程中，互不影响。</p><h5 id="创建线程私有数据键" tabindex="-1"><a class="header-anchor" href="#创建线程私有数据键" aria-hidden="true">#</a> 创建线程私有数据键</h5><p><code>int pthread_key_create(pthread_key_t *key, void (*destructor)(void *));</code> 函数用于创建线程特定数据键（TSD key），该键用于关联线程私有数据。</p><ul><li><code>key</code>：指向 <code>pthread_key_t</code> 对象的指针，用于存储创建的 TSD key。</li><li><code>destructor</code>：一个可选的清理函数，当线程退出时，该函数将被调用以销毁线程私有数据。可以将其设置为 <code>NULL</code>，表示不需要清理函数。 <ul><li><code>void destructor(void *data);</code></li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="销毁线程私有数据键" tabindex="-1"><a class="header-anchor" href="#销毁线程私有数据键" aria-hidden="true">#</a> 销毁线程私有数据键</h5><p><code>int pthread_key_delete(pthread_key_t key);</code> 函数用于销毁线程特定数据键（TSD key），该键通过 <code>pthread_key_create</code> 创建。</p><ul><li><code>key</code>：要删除的 TSD key。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p><strong>键销毁之后与其关联的数据并没有销毁，因此如果是malloc申请的数据，需要在清理函数 <code>destructor</code> 中将其释放。</strong></p></blockquote><h5 id="私有数据键关联数据" tabindex="-1"><a class="header-anchor" href="#私有数据键关联数据" aria-hidden="true">#</a> 私有数据键关联数据</h5><p><code>int pthread_setspecific(pthread_key_t key, const void *value);</code> 函数用于将线程私有数据与指定的 TSD key 相关联。</p><ul><li><code>key</code>：要与线程私有数据相关联的 TSD key。</li><li><code>value</code>：线程私有数据的指针。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><h5 id="获取私有数据键关联的数据" tabindex="-1"><a class="header-anchor" href="#获取私有数据键关联的数据" aria-hidden="true">#</a> 获取私有数据键关联的数据</h5><p><code>void *pthread_getspecific(pthread_key_t key);</code> 函数用于获取与指定 TSD key 相关联的线程私有数据。</p><ul><li><code>key</code>：要获取线程私有数据的 TSD key。</li><li><code>return</code><ul><li>如果关联的线程私有数据存在，则返回关联的数据的指针。</li><li>如果关联的线程私有数据不存在（或者发生错误），返回 <code>NULL</code>。</li></ul></li></ul><h5 id="线程私有实例" tabindex="-1"><a class="header-anchor" href="#线程私有实例" aria-hidden="true">#</a> 线程私有实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_key_t</span> key<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 1 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置数据后，让线程2执行并设置数据再回到线程1获取</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>gotstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 1 key data : %s\n&quot;</span><span class="token punctuation">,</span>gotstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func2</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为了让线程1先执行</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am thread 2 \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>gotstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;thread 2 key data : %s\n&quot;</span><span class="token punctuation">,</span>gotstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">cleanup_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;cleaup function start : %p ...\n&quot;</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid1<span class="token punctuation">,</span>tid2<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>

	<span class="token function">pthread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>cleanup_func<span class="token punctuation">)</span><span class="token punctuation">;</span>

	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid1<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid2<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">pthread_key_delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_specific</span>
I am thread <span class="token number">1</span>
I am thread <span class="token number">2</span>
thread <span class="token number">2</span> key data <span class="token builtin class-name">:</span> world
cleaup <span class="token keyword">function</span> start <span class="token builtin class-name">:</span> 0xffff7c000b70 <span class="token punctuation">..</span>.
thread <span class="token number">1</span> key data <span class="token builtin class-name">:</span> hello
cleaup <span class="token keyword">function</span> start <span class="token builtin class-name">:</span> 0xffff84000f80 <span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">2123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// print : 2123</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>intptr_t</code> 是 C99 标准引入的整数类型，具有足够的位数，可以安全地容纳指针。而 <code>long</code> 类型的大小可能在不同的系统上有所变化。</p></blockquote><h4 id="线程与fork" tabindex="-1"><a class="header-anchor" href="#线程与fork" aria-hidden="true">#</a> 线程与fork</h4><p>当线程调用fork函数时，就为子进程创建了一个与调用进程相同的副本（子进程）。新进程是调用进程的复制，包括代码、数据和执行上下文。</p><p>但是也会将父进程的互斥量、读写锁、条件变量的状态继承过来。</p><p><strong>也就是说，如果父进程的互斥量是锁着的，那么在子进程中也是锁着的（尽管子进程没有lock）</strong></p><p>子进程中只有一个线程，由父进程调用fork函数的线程副本构成。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_mutex_t</span> mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 因为拷贝了父进程已经锁住的互斥量副本，但是由于它们属于两个不同的副本，因此父进程解锁了互斥量，但是此副本并不知情，所以它永远都在堵塞。除非子进程先解锁 pthread_mutex_unlock(&amp;mutex); ， 但是这样并不好！</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 因为和mian中锁的互斥量是同一个副本，所以在mian中休眠2s解锁后，这里的阻塞会放开</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>

	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 因为新线程休眠了1s，所以会先将互斥量锁住，然后休眠2s的时候轮到新线程执行</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;main\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_atfork</span>
main
parent
<span class="token comment"># ps</span>
    PID TTY          TIME CMD
   <span class="token number">1219</span> pts/1    00:00:01 <span class="token function">bash</span>
   <span class="token number">3180</span> pts/1    00:00:00 thread_atfork  <span class="token comment"># 子进程一直在阻塞，没有结束</span>
   <span class="token number">3182</span> pts/1    00:00:00 <span class="token function">ps</span>
   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="pthread-atfork" tabindex="-1"><a class="header-anchor" href="#pthread-atfork" aria-hidden="true">#</a> pthread_atfork</h5><p><code>int pthread_atfork(void (*prepare)(void), void (*parent)(void), void (*child)(void));</code> 是 POSIX 线程库提供的函数，用于注册在 <code>fork</code> 调用期间执行的回调函数。这些回调函数分别在 <code>fork</code> 之前、之后的父进程和之后的子进程执行。主要目的是为了处理多线程环境下 <code>fork</code> 可能引发的问题，如死锁、资源泄漏等。</p><ul><li><code>prepare</code>：在调用 <code>fork</code> 之前由父进程执行的回调函数，用于准备 <code>fork</code>。</li><li><code>parent</code>：在调用 <code>fork</code> 之后由父进程执行的回调函数，用于恢复父进程状态。</li><li><code>child</code>：在调用 <code>fork</code> 之后由子进程执行的回调函数，用于初始化子进程的状态。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回错误码，可以使用 <code>strerror</code> 函数获取错误信息。</li></ul></li></ul><blockquote><p><strong>如果在prepare中加锁所有的互斥量，在 parent 和 child 中解锁互斥量，那么在fork返回之后，互斥量的状态就是未加锁。</strong></p></blockquote><p>可以有多个 pthread_atforkf 函数，就是也会有多个处理程序 (prepare , parent , child ) 。多个 prepare 的执行顺序与注册顺序相反，而 parent 和 child 的执行顺序与注册顺序相同。</p><h5 id="pthread-atfork-实例" tabindex="-1"><a class="header-anchor" href="#pthread-atfork-实例" aria-hidden="true">#</a> pthread_atfork 实例</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;stdafx.h&quot;</span></span>

<span class="token class-name">pthread_mutex_t</span> mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// 等待main解锁</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am prepare \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_atfork</span><span class="token punctuation">(</span>prepare<span class="token punctuation">,</span>parent<span class="token punctuation">,</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child lock\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;child \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent lock\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>

	<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 因为新线程休眠了1s，所以会先将互斥量锁住，然后休眠2s的时候轮到新线程执行</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;main\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./thread_atfork</span>
main
I am prepare
I am parent
parent lock
parent
I am child
child lock
child
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="系统进程" tabindex="-1"><a class="header-anchor" href="#系统进程" aria-hidden="true">#</a> 系统进程</h2><p>进程是计算机中正在运行的程序的实例。每个进程都有独立的内存空间，包括代码、数据和堆栈。进程还包括程序计数器（用于指示正在执行的指令的位置）、寄存器集合、打开的文件描述符、进程 ID 等信息。进程是操作系统中进行任务调度和资源管理的基本单位。</p><p>面是关于进程的一些重要特性和概念：</p><ol><li><strong>独立性：</strong> 每个进程都在自己的独立地址空间中运行，相互之间不直接访问对方的内存数据。</li><li><strong>并发性：</strong> 多个进程可以同时运行，实现并发执行。这样可以充分利用计算机系统的多核处理器和资源。</li><li><strong>同步与通信：</strong> 进程之间可以通过各种同步和通信机制来进行交互。这包括信号、管道、消息队列、共享内存等。</li><li><strong>资源分配：</strong> 操作系统负责分配和管理进程所需的资源，如内存、CPU 时间、文件描述符等。</li><li><strong>进程状态：</strong> 进程可以处于运行、就绪、阻塞等状态，这取决于其当前执行情况和与外部资源的交互。</li><li><strong>创建和终止：</strong> 进程可以由其他进程创建，也可以自行终止。进程的创建通常通过 fork 和 exec 等系统调用完成。</li><li><strong>进程间关系：</strong> 进程之间可以存在父子关系，形成进程树。父进程可以等待子进程结束，获取其退出状态。</li><li><strong>调度：</strong> 操作系统使用调度算法决定哪个进程获得 CPU 时间，实现任务的合理分配。</li><li><strong>进程组：</strong> 进程可以组织成进程组，方便对组内的进程进行操作和控制。</li><li><strong>守护进程：</strong> 后台运行的长期进程，通常在系统启动时启动，不依赖于用户登录。</li></ol><p>进程是操作系统中的核心概念，它们为计算机系统提供了多任务和并发执行的能力。操作系统通过对进程的管理和调度，实现了对计算机系统资源的有效利用和任务的有序执行。</p><h3 id="相关指令" tabindex="-1"><a class="header-anchor" href="#相关指令" aria-hidden="true">#</a> 相关指令</h3><h4 id="top" tabindex="-1"><a class="header-anchor" href="#top" aria-hidden="true">#</a> top</h4><p><code>top</code> 是一个用于实时监视系统进程和资源利用情况的命令行工具。它提供了一个交互式的界面，显示系统中运行的进程列表、系统负载、内存使用、CPU使用等信息。</p><p>以下是 <code>top</code> 的基本用法：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">top</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>top</code> 的输出界面包括多个部分，主要包括：</p><ol><li><strong>任务信息区：</strong> 显示了运行中的进程列表，包括 PID、用户、CPU 使用率、内存使用率等。</li><li><strong>系统负载区：</strong> 显示了系统的平均负载（1分钟、5分钟、15分钟）。</li><li><strong>内存信息区：</strong> 显示了内存的总量、使用量、空闲量等信息。</li><li><strong>交互命令区：</strong> 提供了一些交互式命令，可以用于刷新、排序、结束进程等操作。</li></ol><p><code>top</code> 有许多交互式命令，可以通过按键来进行不同的操作，例如：</p><ul><li><code>q</code>：退出 <code>top</code>。</li><li><code>k</code>：结束一个进程。</li><li><code>r</code>：修改进程的优先级。</li><li><code>Space</code>：刷新显示。</li></ul><p><code>top</code> 的具体使用和输出格式也会因不同的操作系统而有所不同。在 Linux 系统中，<code>top</code> 通常会默认按照 CPU 使用率降序排序，你可以使用不同的选项来调整排序和显示的内容。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">top</span> <span class="token parameter variable">-o</span> %MEM  <span class="token comment"># 按照内存使用率排序</span>
<span class="token function">top</span> <span class="token parameter variable">-o</span> TIME+  <span class="token comment"># 按照累计 CPU 时间排序</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>要了解更多选项和命令，请查看 <code>top</code> 的手册页，可以通过以下命令获取：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">man</span> <span class="token function">top</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="pstree" tabindex="-1"><a class="header-anchor" href="#pstree" aria-hidden="true">#</a> pstree</h4><p><code>pstree</code> 是一个 Linux/Unix 系统上用于以树形结构显示进程间关系的命令。它能够以树状图的形式展示当前系统中所有进程的父子关系，便于直观地理解进程的层级关系。</p><p>以下是 <code>pstree</code> 的基本用法：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pstree
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>认情况下，<code>pstree</code> 将显示当前终端下的所有进程的树形结构。输出的每一行表示一个进程，子进程相对于父进程向右缩进。</p><p>示例输出：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># pstree</span>
systemd─┬─agetty
        ├─containerd───10*<span class="token punctuation">[</span><span class="token punctuation">{</span>containerd<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─cron
        ├─dbus-daemon
        ├─dockerd───14*<span class="token punctuation">[</span><span class="token punctuation">{</span>dockerd<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─in.tftpd
        ├─nginx───10*<span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
        ├─orbstack-helper───9*<span class="token punctuation">[</span><span class="token punctuation">{</span>orbstack-helper<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─rsyslogd───3*<span class="token punctuation">[</span><span class="token punctuation">{</span>rsyslogd<span class="token punctuation">}</span><span class="token punctuation">]</span>
        ├─sshd───sshd───bash───pstree
        ├─2*<span class="token punctuation">[</span>systemd───<span class="token punctuation">(</span>sd-pam<span class="token punctuation">)</span><span class="token punctuation">]</span>
        ├─systemd-journal
        ├─systemd-logind
        ├─systemd-network
        └─vsftpd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你只想查看特定进程及其子进程的树状结构，可以提供该进程的 PID 作为参数：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pstree <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>例如：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pstree <span class="token parameter variable">-p</span> <span class="token number">1234</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这将显示进程 ID 为 1234 的进程及其子进程的树形结构。</p><p><code>pstree</code> 命令提供了一种直观的方式来查看进程之间的关系，对于理解系统的进程组织结构和层级关系很有帮助。</p><h4 id="ps" tabindex="-1"><a class="header-anchor" href="#ps" aria-hidden="true">#</a> ps</h4><p><code>ps</code> 是一个用于查看当前正在运行的进程信息的命令。它的输出显示了系统中各个进程的状态、资源占用情况等信息。</p><p>以下是 <code>ps</code> 命令的基本用法：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">ps</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>常用选项：</p><ul><li><strong><code>-e</code>：</strong> 显示系统中所有的进程。</li><li><strong><code>-f</code>：</strong> 显示详细的进程信息，包括进程的 UID、PID、PPID、C、STIME 等。</li><li><strong><code>-l</code>：</strong> 显示长格式的进程信息，包括 F、S、UID、PID、PPID、C、PRI、NI、ADDR、SZ、WCHAN、STIME、TTY、TIME、CMD 等。</li><li><strong><code>-a</code>：</strong> 显示所有用户的进程。</li><li><strong><code>-u</code>：</strong> 显示用户的进程信息，包括用户、PID、%CPU、%MEM、VSZ、RSS、TTY、STAT、START、TIME、COMMAND。</li><li><strong><code>-x</code>：</strong> 显示无控制终端的进程。</li><li><strong><code>-r</code>：</strong> 显示没有运行的进程。</li></ul><p>示例：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 显示所有进程</span>
<span class="token function">ps</span> <span class="token parameter variable">-e</span>

<span class="token comment"># 显示详细信息</span>
<span class="token function">ps</span> <span class="token parameter variable">-f</span>

<span class="token comment"># 显示用户的进程信息</span>
<span class="token function">ps</span> <span class="token parameter variable">-u</span> username
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这只是 <code>ps</code> 命令的一部分选项。根据不同的操作系统（如Linux、Unix等）和版本，<code>ps</code> 命令可能会有一些变化。 <code>ps</code> 命令提供了丰富的选项，可以根据需要选择合适的选项进行进程信息的查看。</p><h4 id="进程信息表" tabindex="-1"><a class="header-anchor" href="#进程信息表" aria-hidden="true">#</a> 进程信息表</h4><ul><li><strong><code>USER</code>：</strong> 进程的所有者（用户名）。</li><li><strong><code>PID</code>：</strong> 进程 ID，是一个唯一标识符，用于标识系统中的每个进程。</li><li><strong><code>%CPU</code>：</strong> 进程的 CPU 利用率，表示该进程占用 CPU 时间的百分比。</li><li><strong><code>%MEM</code>：</strong> 进程使用的物理内存的百分比。</li><li><strong><code>VSZ</code>（Virtual Memory Size）：</strong> 进程使用的虚拟内存的大小，以千字节（KB）为单位。</li><li><strong><code>RSS</code>（Resident Set Size）：</strong> 进程占用的物理内存的大小，以千字节（KB）为单位。</li><li><strong><code>TTY</code>：</strong> 进程关联的终端设备。</li><li><strong><code>STAT</code>（Process Status）：</strong> 进程的状态，通常包括一个或多个字符，如 R（运行）、S（休眠）、Z（僵尸）等。 <ul><li><strong><code>R</code>：</strong> 运行状态 (Running)。表示进程当前正在运行或在运行队列中等待执行。</li><li><strong><code>S</code>：</strong> 睡眠状态 (Sleeping)。表示进程当前正在休眠（等待某个事件的发生）。</li><li><strong><code>D</code>：</strong> 不可中断的睡眠状态 (Uninterruptible Sleep)。表示进程在执行不可中断的操作，通常是等待硬件设备的输入或输出。</li><li><strong><code>T</code>：</strong> 暂停状态 (Stopped)。表示进程被暂停了，通常是由于接收到了 <code>SIGSTOP</code>、<code>SIGTSTP</code>、<code>SIGTTIN</code> 或 <code>SIGTTOU</code> 信号。</li><li><strong><code>Z</code>：</strong> 僵尸状态 (Zombie)。表示进程已经终止，但其父进程尚未调用 <code>wait</code> 或 <code>waitpid</code> 来获取其终止状态。僵尸进程会占用系统资源，应该被及时清理。</li><li><strong><code>I</code>：</strong> 空闲状态 (Idle)。表示进程是空闲进程，通常是系统空闲进程。</li><li><strong><code>&lt;</code>：</strong> 高优先级进程。表示进程运行在高优先级模式。</li><li><strong><code>N</code>：</strong> 低优先级进程。表示进程运行在低优先级模式。</li></ul></li><li><strong><code>START</code>：</strong> 进程启动的时间。</li><li><strong><code>TIME</code>：</strong> 进程消耗的 CPU 时间。</li><li><strong><code>COMMAND</code>：</strong> 启动进程的命令。</li></ul><h3 id="进程概念" tabindex="-1"><a class="header-anchor" href="#进程概念" aria-hidden="true">#</a> 进程概念</h3><h4 id="孤儿进程" tabindex="-1"><a class="header-anchor" href="#孤儿进程" aria-hidden="true">#</a> 孤儿进程</h4><p>孤儿进程是指其父进程先于它结束或者其父进程不再关心它的状态，这时孤儿进程将被 init 进程（或称为 init 进程，进程 ID 为 1）或 <code>systemd</code>进程收养。孤儿进程的状态将由 init 进程来管理。</p><p>一个进程成为孤儿进程的典型情况是，父进程先于子进程结束，而子进程仍然在运行。在这种情况下，子进程会成为孤儿进程。孤儿进程的特点是它不再有父进程，init 进程成为了它的新父进程。</p><p>孤儿进程的状态由 init 进程来收养和处理。一旦孤儿进程终止，它的退出状态将会被保留，直到父进程通过调用 <code>wait</code> 或 <code>waitpid</code> 来获取。这样，孤儿进程不会立即被操作系统清理掉，确保其退出状态能够被收集。</p><p>在 Unix/Linux 等类 Unix 操作系统中，创建孤儿进程的一种常见方式是在一个进程中创建子进程，然后使父进程先于子进程结束。这可以通过 <code>fork</code> 创建子进程，然后在父进程中调用 <code>exit</code> 来实现。</p><p>为了避免产生孤儿进程，父进程通常会在 fork 出子进程后使用 <code>wait</code> 或 <code>waitpid</code> 等系统调用来等待子进程的终止状态。这样，即使父进程先于子进程结束，子进程的终止状态也能被及时处理。</p><p>以下是一个产生孤儿进程的简单示例：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) exiting.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID %d) exiting without waiting.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="僵尸进程" tabindex="-1"><a class="header-anchor" href="#僵尸进程" aria-hidden="true">#</a> 僵尸进程</h4><p>僵尸进程是指一个已经终止执行的进程，但其父进程还没有调用 <code>wait</code> 或 <code>waitpid</code> 等系统调用来获取该进程的终止状态。这个终止状态（退出码等信息）被保留在系统中，而进程表明该进程已经结束。</p><p>正常情况下，当一个进程终止时，其终止状态会被保存在内核的进程表中，等待父进程通过 <code>wait</code> 或 <code>waitpid</code> 获取。只有当父进程调用了这些系统调用之后，进程的资源才会被完全释放。</p><p>以下是一个简单的例子，展示了如何创建一个僵尸进程：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) exiting.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID %d) sleeping.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 父进程休眠，不调用wait来获取子进程终止状态</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process waking up.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在这个例子中，父进程创建了一个子进程，子进程在创建后立即退出。父进程休眠了一段时间而没有调用 <code>wait</code> 来等待子进程的终止状态。在这段时间内，子进程成为了僵尸进程。可以通过使用 <code>ps</code> 命令查看进程状态。</p><p>避免僵尸进程的一种常见方法是在父进程中使用 <code>wait</code> 或 <code>waitpid</code> 来等待子进程的终止状态，确保子进程的资源能够得到释放。如果父进程不需要获取子进程的终止状态，可以使用 <code>waitpid</code> 的 <code>WNOHANG</code> 选项来进行非阻塞检查。</p></blockquote><h3 id="pid-和-ppid" tabindex="-1"><a class="header-anchor" href="#pid-和-ppid" aria-hidden="true">#</a> PID 和 PPID</h3><ul><li>每个进程都有一个非负整数形式的唯一编号，即PID( <strong>Process Identification</strong> )进程标识</li><li>PID在任何时刻都是唯一的，但是可以重用，当进程终止并被回收以后，其PID就可以为其它进程所用</li><li>进程的PID由系统内核根据延迟重用算法生成，以确保新进程的PID不同于最近终止进程的PID</li></ul><h4 id="专用的-pid" tabindex="-1"><a class="header-anchor" href="#专用的-pid" aria-hidden="true">#</a> 专用的 PID</h4><ul><li>0号进程，调度进程，亦称交换进程(swapper)，系统内核的一部分，所有进程的根进程磁盘上没有它的可执行程序文件</li><li>1号进程，init进程，在系统自举过程结束时由调度进程创建，读写与系统有关的初始化文件，引导系统至一个特定状态，以超级用户特权运行的普通进程，永不终</li><li>除调度进程以外，系统中的每个进程都有唯一的父进程，对任何一个子进程而言，其父进程的PID即是它的PPID</li></ul><h4 id="相关函数" tabindex="-1"><a class="header-anchor" href="#相关函数" aria-hidden="true">#</a> 相关函数</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unisstd.h&gt;</span></span>

<span class="token class-name">pid_t</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的PID</span>

<span class="token class-name">pid_t</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的父进程的PID</span>

<span class="token class-name">uid_t</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的实际用户ID</span>

<span class="token class-name">gid_t</span> <span class="token function">getgid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的实际组ID</span>

<span class="token class-name">uid_t</span> <span class="token function">geteuid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的有效用户ID</span>

<span class="token class-name">gid_t</span> <span class="token function">getegid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回调用进程的有效组ID</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="创建子进程-fork" tabindex="-1"><a class="header-anchor" href="#创建子进程-fork" aria-hidden="true">#</a> 创建子进程 fork</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>pid_t fork(void);</code> 是一个在 Unix 和类 Unix 操作系统中用于创建新进程的系统调用。调用 <code>fork</code> 时，操作系统会复制当前进程的地址空间（包括代码、数据、堆栈等）创建一个新的进程，新进程被称为子进程，而调用 <code>fork</code> 的进程被称为父进程。</p><ul><li><code>return</code><ul><li>在父进程中，<code>fork</code> 返回子进程的进程标识符（PID）。</li><li>在子进程中，<code>fork</code> 返回 0。</li><li>如果 <code>fork</code> 失败，返回 -1，表示没有创建新进程。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID %d) created a child process (PID %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个示例中，调用 <code>fork</code> 后，父进程和子进程都会执行接下来的代码，但由于 <code>fork</code> 的返回值不同，它们可以通过返回值的判断来区分执行的是父进程的代码还是子进程的代码。</p><p>需要注意的是，<code>fork</code> 会创建一个子进程，但并不保证父进程和子进程的执行顺序。操作系统的调度策略会影响它们的执行顺序。</p><h3 id="exit-进程退出" tabindex="-1"><a class="header-anchor" href="#exit-进程退出" aria-hidden="true">#</a> exit 进程退出</h3><p><code>void exit(int status);</code> 是一个用于正常终止进程的库函数，它在 C 语言中被广泛使用。通过调用 <code>exit</code> 函数，程序可以在终止前执行一些清理工作，并返回一个退出状态码给调用进程或操作系统。在 POSIX 环境中，<code>exit</code> 函数定义在 <code>&lt;stdlib.h&gt;</code> 头文件中。</p><ul><li><code>status</code> 参数是程序的退出状态码，通常用于向调用进程传递一些信息。在大多数系统中，0 表示成功，非零值表示错误。</li><li><code>exit</code> 函数不返回，它会立即终止当前进程。</li></ul><p>在上面的示例中，调用 <code>exit(0)</code> 表示程序正常退出，传递退出状态码 0。在实际应用中，<code>exit</code> 可以用于释放资源、关闭文件、保存数据等清理工作。</p><p>需要注意的是，<code>exit</code> 函数不同于 <code>return</code> 语句。<code>exit</code> 可以在程序的任何地方调用，而且不会返回到调用点，而是直接终止整个进程。在多文件程序中，如果有需要执行的清理工作，也可以使用 <code>atexit</code> 函数注册终止处理函数。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Before exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用 exit 函数，传递退出状态码 0</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下面的代码不会执行，因为 exit 函数不会返回</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;After exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 这个语句实际上不会被执行</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在上面的示例中，调用 <code>exit(0)</code> 表示程序正常退出，传递退出状态码 0。在实际应用中，<code>exit</code> 可以用于释放资源、关闭文件、保存数据等清理工作。</p><p>需要注意的是，<code>exit</code> 函数不同于 <code>return</code> 语句。<code>exit</code> 可以在程序的任何地方调用，而且不会返回到调用点，而是直接终止整个进程。在多文件程序中，如果有需要执行的清理工作，也可以使用 <code>atexit</code> 函数注册终止处理函数。</p></blockquote><h3 id="函数注册终止处理函数-atexit" tabindex="-1"><a class="header-anchor" href="#函数注册终止处理函数-atexit" aria-hidden="true">#</a> 函数注册终止处理函数 atexit</h3><p><code>int atexit(void (*function)(void));</code> 是一个 C 语言标准库函数，用于在程序正常终止时注册函数，这些函数将在 <code>exit</code> 被调用或 <code>main</code> 函数正常返回时执行。这可以用于执行一些清理工作或释放资源等操作。在 POSIX 环境中，<code>atexit</code> 函数定义在 <code>&lt;stdlib.h&gt;</code> 头文件中。</p><ul><li><code>function</code> 参数是一个指向无返回值函数的指针，表示要在程序终止时执行的函数。</li><li><code>return</code>： <ul><li>成功返回 0</li><li>失败返回非零值。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">cleanup1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cleanup 1 executed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">cleanup2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cleanup 2 executed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册 cleanup1 和 cleanup2 两个清理函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atexit</span><span class="token punctuation">(</span>cleanup1<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;atexit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atexit</span><span class="token punctuation">(</span>cleanup2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;atexit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Main function executed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 正常退出程序，会执行注册的清理函数</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下面的代码不会执行，因为 exit 不会返回</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;After exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在这个例子中，<code>cleanup1</code> 和 <code>cleanup2</code> 两个函数通过 <code>atexit</code> 注册，它们将在程序正常终止时执行。需要注意的是，如果程序通过非正常手段（如调用 <code>abort</code> 函数或接收到一个信号导致程序终止）而不是 <code>exit</code> 正常退出，<code>atexit</code> 注册的函数将不会执行。</p><p><code>atexit</code> 可以用于在程序退出时执行一些清理工作，例如关闭文件、释放内存等。</p></blockquote><h3 id="程序退出时执行的函数-on-exit-非标准" tabindex="-1"><a class="header-anchor" href="#程序退出时执行的函数-on-exit-非标准" aria-hidden="true">#</a> 程序退出时执行的函数 on_exit (非标准)</h3><p><code>int on_exit(void (*function)(int, void *), void *arg);</code> 是一个非标准的函数，它通常用于注册在程序退出时执行的函数。与 <code>atexit</code> 不同，<code>on_exit</code> 提供了一个额外的参数，用于传递给注册的函数。请注意，<code>on_exit</code> 不是 POSIX 标准函数，因此在不同的系统和编译器中的支持程度可能有所不同。</p><ul><li><code>function</code> 参数是一个指向函数的指针，该函数接受两个参数：一个 <code>int</code> 类型的退出状态码和一个 <code>void</code> 指针类型的参数。</li><li><code>arg</code> 参数是一个指向要传递给注册函数的数据的指针。</li><li><code>return</code><ul><li>成功返回 0</li><li>失败返回非零值。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Cleanup function executed with status %d\n&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Argument passed to cleanup: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册 cleanup 函数，并传递一个参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">on_exit</span><span class="token punctuation">(</span>cleanup<span class="token punctuation">,</span> <span class="token string">&quot;Hello, on_exit!&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;on_exit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Main function executed\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 正常退出程序，会执行注册的清理函数</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 下面的代码不会执行，因为 exit 不会返回</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;After exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>在这个例子中，<code>cleanup</code> 函数通过 <code>on_exit</code> 注册，它接受一个退出状态码和一个参数。与 <code>atexit</code> 不同，<code>on_exit</code> 允许传递参数给注册的函数。</p><p>由于 <code>on_exit</code> 不是标准函数，不同的系统和编译器可能有不同的实现或者可能不支持。在可移植性的考虑下，更常见的是使用标准的 <code>atexit</code> 函数。</p></blockquote><h3 id="回收子进程-wait-waitpid" tabindex="-1"><a class="header-anchor" href="#回收子进程-wait-waitpid" aria-hidden="true">#</a> 回收子进程 wait waitpid</h3><h4 id="为什么要回收子进程" tabindex="-1"><a class="header-anchor" href="#为什么要回收子进程" aria-hidden="true">#</a> 为什么要回收子进程</h4><ul><li><p>清除僵尸进程，避免消耗系统资源</p></li><li><p>父进程需要等待子进程的终止，以继续后续工作.</p></li><li><p>父进程需要知道子进程终止的原因</p><ul><li><p>如果是正常终止，那么进程的退出码是多少?</p></li><li><p>如果是异常终止，那么进程是被那个信号所终止的?</p></li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pid_t wait(int *status);</code> 是一个系统调用，用于等待子进程结束并获取其终止状态。</p><ul><li><code>status</code> 是一个指向整数的指针，用于存储子进程的终止状态信息。</li><li><code>return</code>： <ul><li>如果成功等待到子进程终止，返回子进程的进程标识符（PID）。</li><li>如果调用出错，返回 -1。</li></ul></li></ul><blockquote><p><code>wait</code> 函数的作用是让父进程等待其子进程的终止，并收集有关子进程的一些信息。通过 <code>status</code> 参数，父进程可以了解子进程的退出状态、终止原因等信息。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程执行的代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) executing.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程执行的代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID %d) waiting for the child process.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> status<span class="token punctuation">;</span>
        <span class="token class-name">pid_t</span> terminated_child_pid <span class="token operator">=</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>terminated_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) has terminated.\n&quot;</span><span class="token punctuation">,</span> terminated_child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child exited with status: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child terminated by signal: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="waitpid-函数等待指定子进程结束" tabindex="-1"><a class="header-anchor" href="#waitpid-函数等待指定子进程结束" aria-hidden="true">#</a> waitpid 函数等待指定子进程结束</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>pid_t waitpid(pid_t pid, int *status, int options);</code> 是一个系统调用，用于等待指定的子进程结束并获取其终止状态。与 <code>wait</code> 不同，<code>waitpid</code> 允许指定等待的子进程，而不仅仅是等待任意子进程的终止。</p><ul><li><code>pid</code> 是要等待的子进程的进程标识符（PID）： <ul><li>如果 <code>pid</code> &gt; 0，表示等待具有指定 PID 的子进程。</li><li>如果 <code>pid</code> = 0，表示等待与调用进程属于同一进程组的任意子进程。</li><li>如果 <code>pid</code> = -1，表示等待任意子进程。</li><li>如果 <code>pid</code> &lt; -1，表示等待进程组 ID 为 <code>pid</code> 绝对值的任意子进程。</li></ul></li><li><code>status</code> 是一个指向整数的指针，用于存储子进程的终止状态信息。</li><li><code>options</code> 是一个控制等待行为的整数参数，可以使用位掩码进行设置，常用的选项有： <ul><li><strong><code>WNOHANG</code>：</strong> 非阻塞模式。如果没有子进程已经终止，立即返回 0，而不阻塞父进程。</li><li><strong><code>WUNTRACED</code>：</strong> 阻塞等待已经停止的子进程的状态（等待子进程收到某个信号）。这对于监视子进程的停止状态很有用，例如，当子进程收到 <code>SIGSTOP</code> 信号时。</li><li><strong><code>WCONTINUED</code>：</strong> 阻塞等待已经继续执行的子进程的状态（等待子进程收到某个信号）。这对于监视子进程的继续状态很有用，例如，当子进程收到 <code>SIGCONT</code> 信号时。</li><li>这些选项可以通过按位或运算进行组合。例如，如果希望在非阻塞模式下等待已经停止的子进程，可以使用 <code>WNOHANG | WUNTRACED</code>。</li></ul></li><li><code>return</code>： <ul><li>如果成功等待到子进程终止，返回子进程的 PID。</li><li>如果调用出错，返回 -1。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">pid_t</span> child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;fork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 子进程执行的代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) executing.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 父进程执行的代码</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent process (PID %d) waiting for the child process.\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> status<span class="token punctuation">;</span>
        <span class="token class-name">pid_t</span> terminated_child_pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>terminated_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;waitpid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child process (PID %d) has terminated.\n&quot;</span><span class="token punctuation">,</span> terminated_child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child exited with status: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child terminated by signal: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>父进程使用 <code>waitpid</code> 来等待特定的子进程（由 <code>fork</code> 返回的 <code>child_pid</code>）终止。与 <code>wait</code> 类似，<code>waitpid</code> 允许父进程获取子进程的退出状态。</p></blockquote><h3 id="执行程序-exec" tabindex="-1"><a class="header-anchor" href="#执行程序-exec" aria-hidden="true">#</a> 执行程序 exec*</h3><p><code>exec</code> 是一组系统调用，用于在当前进程的上下文中执行新的程序。这组函数包括 <code>execl</code>, <code>execle</code>, <code>execlp</code>, <code>execv</code>, <code>execve</code>, <code>execvp</code> 等，每个都有略微不同的特性。</p><p>这些函数的共同目标是替换当前进程的映像，即用新程序的映像替代当前进程的映像。这样，新程序就会在当前进程的上下文中执行，而不会创建新的进程。以下是其中两个常用的 <code>exec</code> 函数：</p><p><strong><code>execl</code> 和 <code>execv</code>：</strong> 这两个函数根据参数的传递方式的不同而命名。它们用于执行指定的可执行文件，取代当前进程的映像。它们的参数是可变数量的字符串，最后一个字符串必须是 <code>NULL</code>，表示参数列表的结束。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (char *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>path</code> 是要执行的可执行文件的路径。</li><li><code>arg0</code> 是新程序的名称，用于设置 <code>argv[0]</code>。</li><li><code>...</code> 或 <code>argv[]</code> 是传递给新程序的参数列表，以 <code>NULL</code> 结尾。</li></ul><p><strong><code>execle</code> 和 <code>execve</code>：</strong> 这两个函数允许指定新的环境变量，除了与 <code>execl</code> 和 <code>execv</code> 相关的参数之外，它们还接受额外的参数 <code>envp</code> 用于设置新程序的环境变量。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>cCopy code
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">execle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (char *) NULL, char *const envp[] */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execve</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>path</code> 是要执行的可执行文件的路径。</li><li><code>arg0</code> 是新程序的名称，用于设置 <code>argv[0]</code>。</li><li><code>...</code> 或 <code>argv[]</code> 是传递给新程序的参数列表，以 <code>NULL</code> 结尾。</li><li><code>envp[]</code> 是传递给新程序的环境变量列表。</li></ul><p><strong><code>execlp</code>, <code>execvp</code>:</strong> 这两个函数与 <code>execl</code>, <code>execv</code> 类似，区别在于它们会在系统的 PATH 环境变量中搜索可执行文件，而不是要求提供一个完整的路径。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* (char *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>path</code> 是要执行的可执行文件的路径。</li><li><code>arg0</code> 是新程序的名称，用于设置 <code>argv[0]</code>。</li><li><code>...</code> 或 <code>argv[]</code> 是传递给新程序的参数列表，以 <code>NULL</code> 结尾。</li><li><code>file</code> 是要执行的可执行文件的名称，不需要是一个完整路径。</li></ul><blockquote><p>这些 <code>exec</code> 函数在执行成功时不会返回，只有在出错时才会返回，返回值为 -1。如果 <code>exec</code> 调用失败，可以通过查看 <code>errno</code> 变量获取错误信息。</p><p>使用 <code>exec</code> 系列函数是进行进程替换的典型方式，它允许在一个进程的上下文中加载并执行一个全新的程序。</p></blockquote><h2 id="linux-进程间通信" tabindex="-1"><a class="header-anchor" href="#linux-进程间通信" aria-hidden="true">#</a> Linux 进程间通信</h2><p>进程间通信（Inter-Process Communication，IPC）是在操作系统中，不同进程之间进行数据交换和信息共享的机制。有几个主要的原因解释为什么需要进程间通信：</p><ol><li><strong>数据共享：</strong> 进程可能需要共享数据，以便彼此协同工作。例如，一个进程可能生成一些数据，而另一个进程需要使用这些数据进行进一步的处理。通过进程间通信，可以实现这种数据的共享。</li><li><strong>并发执行：</strong> 在多任务操作系统中，多个进程可能同时运行。为了协调它们的工作，进程需要进行通信。这种通信可用于同步进程的活动，以便它们按照期望的顺序执行。</li><li><strong>模块化设计：</strong> 大型软件系统通常以模块化的方式设计，其中不同的模块可能作为独立的进程运行。这些模块可能需要通过进程间通信进行协同工作，以便实现整体系统的功能。</li><li><strong>资源共享：</strong> 进程间通信也用于共享系统资源，如文件、设备、网络连接等。多个进程可能需要同时访问这些资源，因此需要一种机制来协调它们之间的访问。</li><li><strong>分布式系统：</strong> 在分布式系统中，不同的进程可能运行在不同的计算机上。进程间通信是实现这些分布式组件之间协同工作的关键。</li><li><strong>进程控制：</strong> 有时候一个进程可能需要控制或监视另一个进程的行为。通过进程间通信，可以实现对其他进程的监控、控制和交互。</li></ol><p>常见的进程间通信方式包括管道、消息队列、共享内存、信号量、套接字等。选择适当的通信方式取决于应用程序的需求和设计目标。</p><p>在UNIX-like操作系统中，当一个新的进程被创建时，它会继承一些文件描述符，其中包括三个标准文件描述符：标准输入（stdin，文件描述符为0）、标准输出（stdout，文件描述符为1）、标准错误（stderr，文件描述符为2）。</p><p>这三个标准文件描述符通常是在进程启动时由操作系统自动打开的。它们与终端或其他输入/输出设备相关联，使得程序能够通过它们与用户或其他进程进行交互。以下是这些标准文件描述符的一些特性：</p><ol><li><strong>标准输入（stdin，文件描述符为0）：</strong> 默认与终端设备关联，用于从用户获取输入。当进程启动时，通常可以使用键盘输入。</li><li><strong>标准输出（stdout，文件描述符为1）：</strong> 默认与终端设备关联，用于向用户输出信息。当进程启动时，通常可以在终端上看到输出。</li><li><strong>标准错误（stderr，文件描述符为2）：</strong> 默认与终端设备关联，用于向用户输出错误信息。与标准输出不同，标准错误通常用于输出程序的错误信息，而不受标准输出重定向的影响。</li></ol><p>这种继承的机制使得新创建的子进程可以直接使用这三个标准文件描述符进行输入和输出，而不需要重新打开。当然，子进程在执行过程中可以通过文件描述符的重定向来改变这些标准文件描述符的关联，从而实现输入输出的灵活控制。</p><h3 id="system-v-与-posix-简介与对比" tabindex="-1"><a class="header-anchor" href="#system-v-与-posix-简介与对比" aria-hidden="true">#</a> <a href="https://www.cnblogs.com/zackary/p/8433033.html" target="_blank" rel="noopener noreferrer">System V 与 POSIX 简介与对比<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></h3><p>当我们在 Linux 系统中进行进程间通信时，例如信号量，消息队列，共享内存等方式，会发现有System V以及POSIX两种类型。今天我们就来简单介绍下它们。</p><p>POSIX：</p><blockquote><p>POSIX(Portable Operating System Interface for Computing Systems)是由IEEE 和ISO/IEC 开发的一簇标准。该标准是基于现有的UNIX 实践和经验，描述了操作系统的调用服务接口，用于保证编制的应用程序可以在源代码一级上在多种操作系统上移植运行。它是在1980 年早期一个UNIX 用户组(usr/group)的早期工作的基础上取得的。该UNIX 用户组原来试图将AT&amp;T 的系统V 和Berkeley CSRG的BSD 系统的调用接口之间的区别重新调和集成，从而于1984 年产生了/usr/group 标准。1985 年，IEEE操作系统技术委员会标准小组委员会(TCOS-SS)开始在ANSI 的支持下责成IEEE 标准委员会制定有关程序源代码可移植性操作系统服务接口正式标准。到了1986 年4 月，IEEE 就制定出了试用标准。第一个正式标准是在1988 年9 月份批准的(IEEE 1003.1-1988)，也既以后经常提到的POSIX.1 标准。</p></blockquote><p>System V:</p><blockquote><p>System V， 曾经也被称为 AT&amp;T System V，是Unix操作系统众多版本中的一支。它最初由 AT&amp;T 开发，在1983年第一次发布。一共发行了4个 System V 的主要版本：版本1、2、3 和 4。System V Release 4，或者称为SVR4，是最成功的版本，成为一些UNIX共同特性的源头，例如 ”SysV 初始化脚本“ (/etc/init.d)，用来控制系统启动和关闭，System V Interface Definition (SVID) 是一个System V 如何工作的标准定义。 AT&amp;T 出售运行System V的专有硬件，但许多(或许是大多数)客户在其上运行一个转售的版本，这个版本基于 AT&amp;T 的实现说明。流行的SysV 衍生版本包括 Dell SVR4 和 Bull SVR4。当今广泛使用的 System V 版本是 SCO OpenServer，基于 System V Release 3，以及SUN Solaris 和 SCO UnixWare，都基于 System V Release 4。 System V 是 AT&amp;T 的第一个商业UNIX版本(UNIX System III)的加强。传统上，System V 被看作是两种UNIX&quot;风味&quot;之一(另一个是 BSD)。然而，随着一些并不基于这两者代码的UNIX实现的出现，例如 Linux 和 QNX， 这一归纳不再准确，但不论如何，像POSIX这样的标准化努力一直在试图减少各种实现之间的不同。</p></blockquote><p>与 System V 对象类似，POSIX IPC 对象的属主、属主的组以及其他用户具有读取和写入权限，但是没有执行权限。POSIX IPC 对象的属主无法将对象分配给其他属主。POSIX IPC 包括以下功能：</p><blockquote><p>1.消息允许进程将已格式化的数据流发送到任意进程。</p><p>2.信号量允许进程同步执行。</p><p>3.共享内存允许进程共享其部分虚拟地址空间。</p></blockquote><p>与 System V IPC 接口不同，POSIX IPC 接口均为多线程安全接口。</p><p>由于之前的文章已经介绍过了System V 的 IPC，所以以下只简单介绍下 POSIX 的 IPC 接口。</p><h5 id="posix-消息队列" tabindex="-1"><a class="header-anchor" href="#posix-消息队列" aria-hidden="true">#</a> POSIX 消息队列：</h5><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>mqd_t mq_open(const char *name, int oflag, mode_t mode, struct mq_attr *attr)</td><td>创建命名消息队列</td></tr><tr><td>mqd_t mq_close(mqd_t mqdes)</td><td>结束到开放式消息队列的连接</td></tr><tr><td>mqd_t mq_unlink(const char *name)</td><td>结束到开放式消息队列的连接，并在最后一个进程关闭此队列时将其删除</td></tr><tr><td>mqd_t mq_send(mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned msg_prio)</td><td>将消息放入队列</td></tr><tr><td>ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned *msg_prio)</td><td>在队列中接收消息</td></tr><tr><td>mqd_t mq_notify(mqd_t mqdes, const struct sigevent *notification)</td><td>通知进程或线程消息已存在于队列中</td></tr><tr><td>mqd_t mq_getattr(mqd_t mqdes, struct mq_attr *attr) 、mqd_t mq_setattr(mqd_t mqdes, struct mq_attr *newattr, struct mq_attr *oldattr)</td><td>设置或获取消息队列属性</td></tr></tbody></table><h5 id="posix-信号量" tabindex="-1"><a class="header-anchor" href="#posix-信号量" aria-hidden="true">#</a> POSIX 信号量：</h5><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>sem_t *sem_open(const char *name, int oflag, mode_t mode, unsigned int value)</td><td>创建命名信号量</td></tr><tr><td>int sem_init(sem_t *sem, int pshared, unsigned int value)</td><td>初始化信号量结构</td></tr><tr><td>int sem_close(sem_t *sem)</td><td>结束到开放式信号量的连接</td></tr><tr><td>int sem_unlink(const char *name)</td><td>结束到开放式信号量的连接，并在最后一个进程关闭此信号量时将其删除</td></tr><tr><td>int sem_getvalue(sem_t *sem, int *sval)</td><td>将信号量的值复制到指定整数中</td></tr><tr><td>int sem_wait(sem_t *sem)</td><td>递减信号量计数，当其他进程拥有信号量时进行阻塞，或者当其他进程拥有信号量时返回错误</td></tr><tr><td>int sem_post(sem_t *sem)</td><td>递增信号量计数</td></tr></tbody></table><h5 id="posix-共享内存" tabindex="-1"><a class="header-anchor" href="#posix-共享内存" aria-hidden="true">#</a> POSIX 共享内存：</h5><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>int shm_open(const char *name, int oflag, mode_t mode)</td><td>创建共享内存</td></tr><tr><td>int shm_unlink(const char *name)</td><td>结束到共享内存的连接，并在最后一个进程关闭它时将其删除</td></tr><tr><td>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset)</td><td>映射内存</td></tr><tr><td>int munmap(void *addr, size_t length);</td><td>解除由 <code>mmap</code> 创建的映射</td></tr></tbody></table><p>内存映射机制mmap是POSIX标准的系统调用，有匿名映射和文件映射两种：</p><blockquote><p>1.匿名映射使用进程的虚拟内存空间，它和malloc()类似，实际上有些malloc实现会使用mmap匿名映射分配内存，不过匿名映射不是POSIX标准中规定的。 2.文件映射有MAP_PRIVATE和MAP_SHARED两种。前者使用COW的方式，把文件映射到当前的进程空间，修改操作不会改动源文件。后者直接把文件映射到当前的进程空间，所有的修改会直接反应到文件的page cache，然后由内核自动同步到映射文件上。</p></blockquote><p>相比于IO函数调用，基于文件的mmap的一大优点是把文件映射到进程的地址空间，避免了数据从用户缓冲区到内核page cache缓冲区的复制过程；当然还有一个优点就是不需要频繁的read/write系统调用。</p><h5 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h5><p>POSIX 在无竞争条件下，不需要陷入内核，其实现是非常轻量级的; System V 则不同，无论有无竞争都要执行系统调用，因此性能落了下风。</p><p><strong>总体来说，System V IPC存在时间比较老，许多系统都支持，但是接口复杂，并且可能各平台上实现略有区别。</strong></p><p><strong>看完视频才知道，以下是 System V，FUCK Teacher</strong></p><h3 id="无名管道-pipe" tabindex="-1"><a class="header-anchor" href="#无名管道-pipe" aria-hidden="true">#</a> 无名管道 pipe</h3><p>无名管道（Anonymous Pipe）是一种基于文件描述符的简单的进程间通信机制，通常在父进程与其子进程之间使用。无名管道是通过 <code>pipe</code> 系统调用创建的，不需要在文件系统中创建文件，因此被称为无名管道。</p><p>无名管道（Anonymous Pipe）在操作系统中的实现上可以被看作是一个简单的队列，它提供了一种协调进程间通信的方式。虽然它并不是传统队列数据结构，但在实际使用中具有一些类似队列的特性。</p><p>无名管道的特性：</p><ol><li><strong>FIFO（先进先出）：</strong> 数据在管道中的传递是按照先进先出的原则进行的。首先写入管道的数据会最先被读取。</li><li><strong>单向通信：</strong> 无名管道是单向的，有一个写入端和一个读取端。数据只能从写入端流向读取端，不能反向。</li><li><strong>缓冲区：</strong> 管道通常有一个有限的缓冲区，用于存储待读取的数据。当缓冲区满时，写入操作可能被阻塞，直到有足够的空间。</li><li><strong>阻塞与非阻塞：</strong> 管道的读写操作可以是阻塞的或非阻塞的，具体取决于进程对文件描述符的设置。如果读取端没有可用数据，读取操作可能会阻塞等待数据的到来。</li><li><strong>半双工：</strong> 无名管道是半双工的，只允许单向的数据流动。要实现双向通信，通常需要创建两个管道，一个用于父进程向子进程发送数据，另一个用于子进程向父进程发送数据。</li></ol><p>总的来说，虽然无名管道并不是严格的队列数据结构，但在处理进程间通信时，它提供了一种有序的、先进先出的数据传递机制，类似队列的一些特性。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int pipe(int filedes[2]);</code> 是一个在Unix-like操作系统上用于创建管道的系统调用。管道是一种进程间通信的机制，它允许一个进程的输出直接传递给另一个进程的输入，形成一个数据流。</p><ul><li><code>filedes[2]</code> 是一个包含两个整数(文件描述符)的数组。<code>filedes[0]</code> 用于读取，<code>filedes[1]</code> 用于写入。 <ul><li>分别使用 <code>write </code> <code>read</code> 写入和读取数据</li><li>如果写入内容超过缓冲区大小并且没有被消费，<code>write</code> 会阻塞；如果读取不到数据，<code>read</code> 会堵塞</li><li>管道相当于一个队列，出队后，数据会从队列中消失</li></ul></li><li><code>return</code>： <ul><li>如果成功，返回0。</li><li>如果失败，返回-1，并设置 <code>errno</code> 表示错误的类型。</li></ul></li></ul><blockquote><p>注意：</p><ul><li>管道是创建在内存中的，进程结束，空间释放，管道就不存在了</li><li>管道中的数据，读完了就删除了（队列）。</li><li>如果管道中没有东西可读，则会读阻塞</li></ul></blockquote><p>验证读阻塞：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create pipe failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span> write_buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;Hello Linux&quot;</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> read_buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>write_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;read_buf : %s \n&quot;</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果管道中没有数据，再次读取会堵塞</span>
	<span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>    <span class="token number">412</span>     <span class="token number">472</span>     <span class="token number">472</span>     <span class="token number">393</span> pts/1        <span class="token number">472</span> S+       <span class="token number">0</span>   <span class="token number">0</span>:00 ./pipe_1
<span class="token comment"># read阻塞，查看进程状态为睡眠状态</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>验证写阻塞，缓冲区大小：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create pipe failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> write_buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;H&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> read_buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  	<span class="token comment">// 缓冲区大小为 32768</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">32768</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>write_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;write end \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;read_buf : %s \n&quot;</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>read_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>write_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>pipe</code> 创建的管道在操作系统中有一个默认的缓冲区大小。这个缓冲区的大小是有限的，通常在几千字节到几万字节之间，具体取决于操作系统的实现。</p></blockquote><p>验证进程间通信：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token keyword">int</span> fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create pipe failed \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> process_inter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 子进程</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>process_inter<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>process_inter<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am child process : %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 父进程</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;I am parent process : %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		process_inter <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>process_inter<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>无名管道的缺点：只能实现父子进程之间的通信。</strong></p></blockquote><h3 id="有名管道" tabindex="-1"><a class="header-anchor" href="#有名管道" aria-hidden="true">#</a> 有名管道</h3><p>有名管道（Named Pipe）是一种命名的FIFO（First-In-First-Out）通信机制，它允许在不同进程之间进行通信，而不像无名管道那样限制在相关的进程之间。有名管道通常以文件的形式存在于文件系统中，可以通过文件名在不同的进程之间进行访问。</p><p>有名管道的创建和使用涉及到两个步骤：创建有名管道和使用有名管道进行进程间通信。</p><h4 id="创建有名管道" tabindex="-1"><a class="header-anchor" href="#创建有名管道" aria-hidden="true">#</a> 创建有名管道</h4><p>有名管道可以使用 <code>mkfifo</code> 函数在文件系统中创建。函数原型如下：</p><p><code>int mkfifo(const char *pathname, mode_t mode);</code></p><ul><li><code>pathname</code> 是有名管道的路径名。</li><li><code>mode</code> 是文件权限模式。</li><li><code>return</code><ul><li>如果成功创建有名管道，<code>mkfifo</code> 返回 0。</li><li>如果出现错误，返回 -1，并设置 <code>errno</code> 表示具体的错误类型。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token string">&quot;./my_fifo&quot;</span><span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;create mk_fifo failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Named pipe created ./my_fifo\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用有名管道进行通信" tabindex="-1"><a class="header-anchor" href="#使用有名管道进行通信" aria-hidden="true">#</a> 使用有名管道进行通信</h4><p>创建有名管道后，可以在不同的进程中打开该管道文件进行通信。下面是一个简单的例子，演示了两个进程之间的通信：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// writer.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;./my_fifo&quot;</span><span class="token punctuation">,</span>O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> message<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello from writer process!\n&quot;</span><span class="token punctuation">;</span>
	<span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// reader.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;./my_fifo&quot;</span><span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">char</span> message<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> bytesRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>message<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Reader process received: %.*s&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>bytesRead<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./writer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./reader
Reader process received: Hello from writer process<span class="token operator">!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="信号通信" tabindex="-1"><a class="header-anchor" href="#信号通信" aria-hidden="true">#</a> 信号通信</h3><p>在Unix-like操作系统中，信号相关的函数可以用来实现一些简单的进程间通信。以下是一些常见的与信号相关的函数：</p><p>在Unix-like操作系统中，信号相关的函数可以用来实现一些简单的进程间通信。以下是一些常见的与信号相关的函数：</p><ol><li><strong><code>kill</code> 函数：</strong><ul><li><strong>描述：</strong> 用于向指定的进程发送信号。</li><li><strong>原型：</strong> <code>int kill(pid_t pid, int sig);</code></li><li><strong>返回值：</strong> 成功返回0，失败返回-1。</li></ul></li><li><strong><code>raise</code> 函数：</strong><ul><li><strong>描述：</strong> 用于向自身发送信号。</li><li><strong>原型：</strong> <code>int raise(int sig);</code></li><li><strong>返回值：</strong> 成功返回0，失败返回非零值。</li></ul></li><li><strong><code>signal</code> 函数：</strong><ul><li><strong>描述：</strong> 用于注册信号处理函数。</li><li><strong>原型：</strong> <code>sighandler_t signal(int signum, sighandler_t handler);</code></li><li><strong>返回值：</strong> 成功返回之前的信号处理函数，失败返回<code>SIG_ERR</code>。</li></ul></li><li><strong><code>sigaction</code> 函数：</strong><ul><li><strong>描述：</strong> 更强大、可移植的信号处理函数注册方式。</li><li><strong>原型：</strong> <code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact);</code></li><li><strong>返回值：</strong> 成功返回0，失败返回-1。</li></ul></li><li><strong><code>sigprocmask</code> 函数：</strong><ul><li><strong>描述：</strong> 用于检查或更改进程的信号屏蔽字。</li><li><strong>原型：</strong> <code>int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);</code></li><li><strong>返回值：</strong> 成功返回0，失败返回-1。</li></ul></li><li><strong><code>sigpending</code> 函数：</strong><ul><li><strong>描述：</strong> 获取当前进程阻塞的未决信号集。</li><li><strong>原型：</strong> <code>int sigpending(sigset_t *set);</code></li><li><strong>返回值：</strong> 成功返回0，失败返回-1。</li></ul></li></ol><p>这些函数可以用于在进程间传递简单的通知或信号，但并不适用于传递大量数据。如果需要更复杂的进程间通信，例如传递数据，通常会选择其他IPC机制，如管道、消息队列、共享内存等。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">parent_func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig_num<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent received signal : %d \n&quot;</span><span class="token punctuation">,</span>sig_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">child_func</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig_num<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child received signal : %d \n&quot;</span><span class="token punctuation">,</span>sig_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// SIGUSR1的编号是10，SIGCHLD的编号是17</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span>parent_func<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span>child_func<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./signal_1</span>
Child received signal <span class="token builtin class-name">:</span> <span class="token number">17</span>
Parent received signal <span class="token builtin class-name">:</span> <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ipc-资源状态" tabindex="-1"><a class="header-anchor" href="#ipc-资源状态" aria-hidden="true">#</a> IPC 资源状态</h3><h4 id="ipcs" tabindex="-1"><a class="header-anchor" href="#ipcs" aria-hidden="true">#</a> ipcs</h4><p><code>ipcs</code> 是一个用于显示 IPC（Inter-Process Communication）资源状态的命令，通常在Unix-like系统中使用。它可以显示消息队列、共享内存段和信号量(Semaphore)的信息。<code>ipcs</code> 命令可以帮助你查看系统上当前存在的 IPC 资源的状态。</p><p>以下是 <code>ipcs</code> 命令的基本用法：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipcs <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>常用的选项包括：</p><ul><li><strong><code>-m</code>：</strong> 显示共享内存段的信息。</li><li><strong><code>-q</code>：</strong> 显示消息队列的信息。</li><li><strong><code>-s</code>：</strong> 显示信号量的信息。</li><li><strong><code>-a</code>：</strong> 显示所有 IPC 资源的信息。</li></ul><p>例如，要查看所有共享内存段的信息，可以运行：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipcs <span class="token parameter variable">-m</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或者要查看所有 IPC 资源的信息，可以运行：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipcs <span class="token parameter variable">-a</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>ipcs</code> 的输出通常包括资源的键值、创建者的用户ID和组ID、访问权限、关联的进程ID等信息。使用 <code>man ipcs</code> 命令可以查看更多关于 <code>ipcs</code> 命令的详细信息。</p><h4 id="ipcrm" tabindex="-1"><a class="header-anchor" href="#ipcrm" aria-hidden="true">#</a> ipcrm</h4><p>以下是 <code>ipcrm</code> 命令的基本用法：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipcrm <span class="token punctuation">[</span>options<span class="token punctuation">]</span> resource_identifier
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>常用的选项包括：</p><ul><li><strong><code>-m</code>：</strong> 删除共享内存段。</li><li><strong><code>-q</code>：</strong> 删除消息队列。</li><li><strong><code>-s</code>：</strong> 删除信号量。</li></ul><p><code>resource_identifier</code> 是要删除的 IPC 资源的标识符。对于共享内存段和消息队列，标识符是 IPC 对象的ID。对于信号量，标识符是信号量集的ID。</p><p>例如，要删除共享内存段的 IPC 对象，可以运行：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ipcrm <span class="token parameter variable">-m</span> <span class="token operator">&lt;</span>shm_id<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中 <code>&lt;shm_id&gt;</code> 是共享内存段的标识符。类似地，要删除消息队列或信号量，可以使用 <code>-q</code> 或 <code>-s</code> 选项，并提供相应的标识符。</p><p>请注意，删除 IPC 资源将释放相关的系统资源，但应该小心使用 <code>ipcrm</code> 命令，确保不会影响正在使用这些资源的进程。通常，删除 IPC 资源应在不再需要它们的情况下进行。</p><h3 id="system-v-共享内存" tabindex="-1"><a class="header-anchor" href="#system-v-共享内存" aria-hidden="true">#</a> System V 共享内存</h3><p>共享内存通过将同一块物理内存映射到多个进程的地址空间，使它们可以共享数据。在实现上，通常会使用 <code>mmap</code> 函数进行内存映射，从而实现对这块内存的文件IO操作。</p><p><code>ipcrm</code> 是用于删除 IPC（Inter-Process Communication）资源的命令，包括消息队列、共享内存段和信号量(Semaphore)。通过 <code>ipcrm</code> 命令，你可以删除指定的 IPC 资源，释放系统资源。</p><h4 id="创建或获取共享内存段-shmget" tabindex="-1"><a class="header-anchor" href="#创建或获取共享内存段-shmget" aria-hidden="true">#</a> 创建或获取共享内存段 shmget</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int shmget(key_t key, size_t size, int shmflg); </code> 用于创建或获取共享内存段的系统调用。这个调用允许进程在它们之间共享一块物理内存。</p><ul><li><code>key</code>：共享内存段的键值，通常使用 <code>ftok</code> 函数生成 或 <code>IPC_PRIVATE</code>。</li><li><code>size</code>：共享内存段的大小（以字节为单位）。</li><li><code>shmflg</code>：标志，用于指定操作的一些选项，比如权限和操作方式。 <ul><li><strong><code>IPC_CREAT</code>：</strong><ul><li><strong>描述：</strong> 如果共享内存段不存在，则创建它。</li><li><strong>值：</strong> 01000（八进制）。</li></ul></li><li><strong><code>IPC_EXCL</code>：</strong><ul><li><strong>描述：</strong> 与 <code>IPC_CREAT</code> 一同使用，如果共享内存段已经存在，则报错。</li><li><strong>值：</strong> 02000（八进制）。</li></ul></li><li><strong>权限标志（类似于文件权限）：</strong><ul><li><strong>描述：</strong> 指定共享内存的权限，包括用户读写执行权限。</li><li><strong>值：</strong> 例如，<code>IPC_CREAT | IPC_EXCL | 0666</code> ，其中 <code>0666</code> 表示读写权限。</li></ul></li><li><strong><code>SHM_HUGETLB</code>：</strong><ul><li><strong>描述：</strong> 为共享内存使用大页面（Huge Pages）。</li><li><strong>值：</strong> 04000（八进制）。</li></ul></li></ul></li><li><code>return</code><ul><li>成功时返回共享内存段的标识符（非负整数）</li><li>失败时返回 -1。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d \n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;remove share memory shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> cmd<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 	<span class="token function">sprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">&quot;ipcrm -m %d&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./a.out</span>
create share memory success shmid <span class="token operator">=</span> <span class="token number">5</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">5</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

remove share memory shmid <span class="token operator">=</span> <span class="token number">5</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="生成-key-ftok" tabindex="-1"><a class="header-anchor" href="#生成-key-ftok" aria-hidden="true">#</a> 生成 key ftok</h4><blockquote><p><code>IPC_PRIVATE</code> 是一个特殊的键值 一般是 0x00000000，用于在创建 IPC 对象时让系统为其生成唯一的标识符。<code>IPC_PRIVATE</code> 的标识符与当前进程相关联，因此通常用于创建只能在相关进程之间共享的 IPC 对象，比如父子进程之间。</p><p><code>ftok</code> 函数则允许你使用文件路径和项目ID来生成键值，这样就可以在不同的进程之间共享相同的键值，从而实现进程间通信。这种方式更灵活，不仅限于父子进程之间。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>key_t ftok(const char *pathname, int proj_id);</code> 用于生成键值（key）的系统调用，通常用于创建或获取 IPC（Inter-Process Communication）对象，例如消息队列、共享内存和信号量的键值。</p><ul><li><code>pathname</code>：一个路径名，通常是指向一个存在的文件的路径。该路径名用于生成键值。</li><li><code>proj_id</code>：一个整数，用于区分同一路径下可能存在多个 IPC 对象。</li><li><code>return</code> 成功返回IPC键值，失败返回-1</li></ul><blockquote><p><code>ftok</code> 将 <code>pathname</code> 和 <code>proj_id</code> 组合生成一个唯一的键值。生成的键值用于创建或获取 IPC 对象，确保在不同的进程之间能够共享同一个 IPC 对象。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp&quot;</span><span class="token punctuation">,</span> <span class="token char">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 使用路径名和项目ID生成键值</span>

    <span class="token comment">// 创建或获取消息队列</span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Message queue ID: %d\n&quot;</span><span class="token punctuation">,</span> msgid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="映射共享内存到进程空间-shmat" tabindex="-1"><a class="header-anchor" href="#映射共享内存到进程空间-shmat" aria-hidden="true">#</a> 映射共享内存到进程空间 shmat</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>void *shmat(int shmid, const void *shmaddr, int shmflg);</code> 将共享内存段附加到调用进程的地址空间，使得进程能够访问这块共享内存。</p><ul><li><code>shmid</code>：共享内存段的标识符，通常通过 <code>shmget</code> 获取。</li><li><code>shmaddr</code>：指定共享内存被附加到进程地址空间的地址，通常为 <code>NULL</code>，表示由系统自动选择地址。</li><li><code>shmflg</code>：标志参数，通常设置为 <code>0</code>。 <ul><li><strong><code>SHM_RDONLY</code></strong> 表示共享内存段以只读模式附加，进程不能修改共享内存的内容。</li><li><strong><code>SHM_RND</code></strong> 如果 <code>shmaddr</code> 不为 <code>NULL</code>，将 <code>shmaddr</code> 地址向下舍入到系统页面大小的整数倍。</li><li><strong><code>SHM_EXEC</code></strong> 允许附加的共享内存段包含可执行的代码。</li><li><code>0</code> 可读写</li></ul></li><li><code>return</code><ul><li>返回一个指向共享内存段附加位置的指针。</li><li>如果附加失败，返回 <code>(void *)-1</code>。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> aa <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;key : %X\n&quot;</span><span class="token punctuation">,</span>aa<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>aa<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory content : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory content : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>共享内存特点：</strong></p><ul><li>共享内存之后，一直存在于内核中，直到被删除或系统关闭；</li><li>共享内存和管道不一样，读取后，内存仍然在其共享内存中；</li></ul></blockquote><h4 id="释放共享内存映射的进程地址空间-shmdt" tabindex="-1"><a class="header-anchor" href="#释放共享内存映射的进程地址空间-shmdt" aria-hidden="true">#</a> 释放共享内存映射的进程地址空间 shmdt</h4><p><code>int shmdt(const void *shmaddr);</code> 当你使用 <code>shmat</code> 函数将共享内存段连接到进程的地址空间后，当这块共享内存不再需要时，可以使用 <code>shmdt</code> 函数将其从进程的地址空间中分离。</p><ul><li><p><code>shmaddr</code>：共享内存段附加的起始地址，通常是通过 <code>shmat</code> 获取的。</p></li><li><p><code>return</code> 为0表示成功，-1表示失败。</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> aa <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;key : %X\n&quot;</span><span class="token punctuation">,</span>aa<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>aa<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory content : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">shmdt</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmdt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory content : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./a.out
key <span class="token builtin class-name">:</span> 6224FFE1
create share memory success shmid <span class="token operator">=</span> <span class="token number">7</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x6224ffe1 <span class="token number">7</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

hello
share memory content <span class="token builtin class-name">:</span> hello
Segmentation fault
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="获取-设置-删除共享内存对象-shmctl" tabindex="-1"><a class="header-anchor" href="#获取-设置-删除共享内存对象-shmctl" aria-hidden="true">#</a> 获取｜设置｜删除共享内存对象 shmctl</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> shm_perm<span class="token punctuation">;</span>     <span class="token comment">// 共享内存的权限信息</span>
    <span class="token class-name">size_t</span> shm_segsz<span class="token punctuation">;</span>             <span class="token comment">// 共享内存段的大小（字节数）</span>
    <span class="token class-name">time_t</span> shm_atime<span class="token punctuation">;</span>             <span class="token comment">// 上次附加时间</span>
    <span class="token class-name">time_t</span> shm_dtime<span class="token punctuation">;</span>             <span class="token comment">// 上次分离时间</span>
    <span class="token class-name">time_t</span> shm_ctime<span class="token punctuation">;</span>             <span class="token comment">// 上次变更状态的时间</span>
    <span class="token class-name">pid_t</span> shm_cpid<span class="token punctuation">;</span>               <span class="token comment">// 创建共享内存的进程ID</span>
    <span class="token class-name">pid_t</span> shm_lpid<span class="token punctuation">;</span>               <span class="token comment">// 最后操作共享内存的进程ID</span>
    <span class="token class-name">shmatt_t</span> shm_nattch<span class="token punctuation">;</span>          <span class="token comment">// 当前附加到共享内存的进程数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int shmctl(int shmid, int cmd, struct shmid_ds *buf);</code>用于控制共享内存段，允许对共享内存进行不同的操作，如删除共享内存段、获取共享内存信息等。</p><ul><li><code>shmid</code>：共享内存段的标识符，通常通过 <code>shmget</code> 获取。</li><li><code>cmd</code>：控制命令，用于指定要执行的操作。常用的命令包括： <ul><li><code>IPC_STAT</code>：获取共享内存信息，将信息保存在 <code>struct shmid_ds</code> 结构体中。</li><li><code>IPC_SET</code>：设置共享内存信息，通过 <code>struct shmid_ds</code> 结构体提供新的信息。</li><li><code>IPC_RMID</code>：删除共享内存段。</li></ul></li><li><code>buf</code>：指向 <code>struct shmid_ds</code> 结构体的指针，用于传递或获取共享内存的信息。如何 <code>cmd</code> 为 <code>IPC_RMID</code> ,可以设置为 <code>NULL</code></li><li><code>return</code> 返回值为0表示成功，-1表示失败。</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> aa <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;key : %X\n&quot;</span><span class="token punctuation">,</span>aa<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>aa<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory content : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">shmdt</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmdt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmctl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>
------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x6224ffe1 <span class="token number">7</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

hello linux
share memory content <span class="token builtin class-name">:</span> hello linux

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

root@Ubuntu-arm64:~/study/linux-process<span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="共享内存父子进程通信例子" tabindex="-1"><a class="header-anchor" href="#共享内存父子进程通信例子" aria-hidden="true">#</a> 共享内存父子进程通信例子</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR2<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
		p <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 映射到父进程的地址空间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;parent write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 暂停父进程，等待子进程发送信号唤醒</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
        p <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 映射到子进程的地址空间</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 暂停子进程，等待父进程发送信号唤醒</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;share memory data : %s&quot;</span><span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">kill</span><span class="token punctuation">(</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SIGUSR2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">shmdt</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmdt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">=</span> <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmctl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./a.out</span>
create share memory success shmid <span class="token operator">=</span> <span class="token number">8</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">8</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

parent <span class="token function">write</span> data <span class="token builtin class-name">:</span> hello linux
share memory data <span class="token builtin class-name">:</span> hello linux
parent <span class="token function">write</span> data <span class="token builtin class-name">:</span> hi
share memory data <span class="token builtin class-name">:</span> hi
parent <span class="token function">write</span> data <span class="token builtin class-name">:</span> nihao
share memory data <span class="token builtin class-name">:</span> nihao
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="共享内存-非父子进程间通信-例子" tabindex="-1"><a class="header-anchor" href="#共享内存-非父子进程间通信-例子" aria-hidden="true">#</a> 共享内存 非父子进程间通信 例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;ftok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR2<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
	<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	p<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待客户端进程收到pid后唤醒</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kill</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;ftok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create share memory success shmid = %d\n&quot;</span><span class="token punctuation">,</span>shmid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -m&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
	<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shmat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> server_pid<span class="token punctuation">;</span>
	server_pid <span class="token operator">=</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kill</span><span class="token punctuation">(</span>server_pid<span class="token punctuation">,</span>SIGUSR2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待服务端进程收到pid后唤醒</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client received data : %s&quot;</span><span class="token punctuation">,</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kill</span><span class="token punctuation">(</span>server_pid<span class="token punctuation">,</span>SIGUSR2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token operator">/</span>server
create share memory success shmid <span class="token operator">=</span> <span class="token number">9</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> Shared Memory Segments <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
key        shmid      owner      perms      bytes      nattch     status
<span class="token number">0x00000000</span> <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x00000000</span> <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x00000000</span> <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x00000000</span> <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x00000000</span> <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x00000000</span> <span class="token number">8</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
<span class="token number">0x6124ffe1</span> <span class="token number">9</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>

server write data <span class="token operator">:</span> nihao
server write data <span class="token operator">:</span> zaima
server write data <span class="token operator">:</span> hello linux
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./client
create share memory success shmid <span class="token operator">=</span> <span class="token number">9</span>

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status
0x00000000 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">1</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">2</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">3</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">6</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x00000000 <span class="token number">8</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">0</span>
0x6124ffe1 <span class="token number">9</span>          root       <span class="token number">777</span>        <span class="token number">128</span>        <span class="token number">1</span>

client received data <span class="token builtin class-name">:</span> nihao
client received data <span class="token builtin class-name">:</span> zaima
client received data <span class="token builtin class-name">:</span> hello linux
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="system-v-消息队列" tabindex="-1"><a class="header-anchor" href="#system-v-消息队列" aria-hidden="true">#</a> System V 消息队列</h3><p>消息队列（Message Queue）是一种进程间通信的机制，允许进程通过在队列中发送和接收消息来进行通信。在消息队列中，消息的发送和接收是异步的，即发送方将消息放入队列后可以立即继续执行其他操作，而不需要等待接收方读取消息。</p><p>在Unix/Linux系统中，消息队列由系统维护，有一个唯一的标识符（Message Queue Identifier）用于标识每个消息队列。进程通过该标识符连接到消息队列，并进行消息的发送和接收。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建或获取消息队列-msgget" tabindex="-1"><a class="header-anchor" href="#创建或获取消息队列-msgget" aria-hidden="true">#</a> 创建或获取消息队列 msgget</h4><p><code>int msgget(key_t key, int msgflg); </code> 用于创建或获取消息队列，返回消息队列的标识符（Message Queue Identifier，msqid）。</p><ul><li><code>key</code>：消息队列的关键字，通常使用 <code>ftok</code> 函数生成。</li><li></li><li><code>msgflg</code>：标志，用于指定操作的一些选项，比如权限和操作方式。 <ul><li><strong><code>IPC_CREAT</code>：</strong><ul><li><strong>描述：</strong> 如果消息队列不存在，则创建它。</li><li><strong>值：</strong> 01000（八进制）。</li></ul></li><li><strong><code>IPC_EXCL</code>：</strong><ul><li><strong>描述：</strong> 与 <code>IPC_CREAT</code> 一同使用，如果消息队列已经存在，则报错。</li><li><strong>值：</strong> 02000（八进制）。</li></ul></li><li><strong>权限标志（类似于文件权限）：</strong><ul><li><strong>描述：</strong> 指定消息队列的权限，包括用户读写执行权限。</li><li><strong>值：</strong> 例如，<code>IPC_CREAT | IPC_EXCL | 0666</code> ，其中 <code>0666</code> 表示读写权限。</li></ul></li></ul></li><li><code>return</code><ul><li>成功时返回消息队列的标识符（非负整数）</li><li>失败时返回 -1。</li></ul></li></ul><h4 id="获取-设置-删除消息队列对象-msgctl" tabindex="-1"><a class="header-anchor" href="#获取-设置-删除消息队列对象-msgctl" aria-hidden="true">#</a> 获取｜设置｜删除消息队列对象 msgctl</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">msqid_ds</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> msg_perm<span class="token punctuation">;</span>     <span class="token comment">// 消息队列的权限信息</span>
    <span class="token class-name">time_t</span> msg_stime<span class="token punctuation">;</span>             <span class="token comment">// 上次发送消息的时间</span>
    <span class="token class-name">time_t</span> msg_rtime<span class="token punctuation">;</span>             <span class="token comment">// 上次接收消息的时间</span>
    <span class="token class-name">time_t</span> msg_ctime<span class="token punctuation">;</span>             <span class="token comment">// 上次变更状态的时间</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> msg_cbytes<span class="token punctuation">;</span>     <span class="token comment">// 消息队列中当前消息的总字节数</span>
    <span class="token class-name">msgqnum_t</span> msg_qnum<span class="token punctuation">;</span>           <span class="token comment">// 消息队列中的消息数量</span>
    <span class="token class-name">msglen_t</span> msg_qbytes<span class="token punctuation">;</span>          <span class="token comment">// 消息队列的最大字节数</span>
    <span class="token class-name">pid_t</span> msg_lspid<span class="token punctuation">;</span>              <span class="token comment">// 最后发送消息的进程ID</span>
    <span class="token class-name">pid_t</span> msg_lrpid<span class="token punctuation">;</span>              <span class="token comment">// 最后接收消息的进程ID</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int msgctl(int msqid, int cmd, struct msqid_ds *buf);</code> 用于控制消息队列，包括获取消息队列信息、设置消息队列信息以及删除消息队列等操作。</p><ul><li><code>msqid</code>：消息队列的标识符。</li><li><code>cmd</code>：控制命令，用于指定要执行的操作。 <ul><li><strong><code>IPC_STAT</code>：</strong> 获取消息队列的状态信息，将信息保存在 <code>struct msqid_ds</code> 结构体中。</li><li><strong><code>IPC_SET</code>：</strong> 设置消息队列的状态信息，通过 <code>struct msqid_ds</code> 结构体提供新的信息。</li><li><strong><code>IPC_RMID</code>：</strong> 删除消息队列。</li></ul></li><li><code>buf</code>：指向 <code>struct msqid_ds</code> 结构体的指针，用于传递或获取消息队列的信息。</li><li><code>return</code><ul><li>返回值为0表示成功</li><li>-1表示失败</li></ul></li></ul><h4 id="向消息队列发送消息-msgsnd" tabindex="-1"><a class="header-anchor" href="#向消息队列发送消息-msgsnd" aria-hidden="true">#</a> 向消息队列发送消息 msgsnd</h4><p><code>int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg);</code> 用于向消息队列发送消息。</p><ul><li><p><code>msqid</code>：消息队列的标识符。</p></li><li><p><code>msgp</code>：指向消息结构体的指针。</p><ul><li><p>消息结构体的定义通常包括一个长整型（<code>long</code>）的消息类型字段和实际消息数据。例如：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">message</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> mtype<span class="token punctuation">;</span>  <span class="token comment">// 消息类型</span>
    <span class="token keyword">char</span> mtext<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 消息内容</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在使用 <code>msgsnd</code> 函数时，需要设置好消息类型和消息内容，然后将消息结构体的指针传递给 <code>msgp</code> 参数。</p></li></ul></li><li><p><code>msgsz</code>：消息的大小，以字节为单位。</p></li><li><p><code>msgflg</code>：标志参数，用于指定发送消息的行为。</p><ul><li><strong><code>0</code>：</strong> 默认行为，表示阻塞操作。如果消息队列满（达到最大消息数或最大字节数），则调用会阻塞，直到有空间可用。</li><li><strong><code>IPC_NOWAIT</code>：</strong> 非阻塞操作。如果消息队列满，立即返回，并设置 <code>errno</code> 为 <code>EAGAIN</code>。</li><li><strong><code>msgflg | IPC_NOWAIT</code>：</strong> 与 <code>IPC_NOWAIT</code> 一起使用，表示非阻塞操作。</li><li><strong><code>IPC_NOERROR</code>：</strong> 如果消息长度超过了 <code>msgsz</code>，截断消息而不返回错误。此选项用于确保发送的消息不会因为长度过大而导致失败。</li></ul></li><li><p><code>return</code></p><ul><li>返回值为0表示成功</li><li>-1表示失败</li></ul></li></ul><h4 id="从消息队列接收消息-msgrcv" tabindex="-1"><a class="header-anchor" href="#从消息队列接收消息-msgrcv" aria-hidden="true">#</a> 从消息队列接收消息 msgrcv</h4><p><code>ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, int msgflg);</code> 用于从消息队列接收消息。</p><ul><li><p><code>msqid</code>：消息队列的标识符。</p></li><li><p><code>msgp</code>：指向接收消息的缓冲区的指针。</p></li><li><p><code>msgsz</code>：缓冲区的大小。</p></li><li><p><code>msgtyp</code>：指定要接收的消息类型。如果为0，则接收队列中的第一条消息。</p></li><li><p><code>msgflg</code>：标志参数，用于指定接收消息的行为。</p><ul><li><strong><code>0</code>：</strong> 默认行为，表示阻塞操作。如果消息队列为空，调用将阻塞，直到有消息可用。</li><li><strong><code>IPC_NOWAIT</code>：</strong> 非阻塞操作。如果消息队列为空，立即返回，并设置 <code>errno</code> 为 <code>ENOMSG</code>。</li><li><strong><code>msgflg | IPC_NOWAIT</code>：</strong> 与 <code>IPC_NOWAIT</code> 一起使用，表示非阻塞操作。</li></ul></li><li><p><code>return</code></p><ul><li>返回值为接收到的消息的实际字节数，</li><li>-1 表示失败。</li><li>如果 <code>msgflg</code> 包含 <code>IPC_NOWAIT</code> 标志并且没有可用的消息，函数将立即返回，并在 <code>errno</code> 中设置 <code>ENOMSG</code> 错误。</li></ul></li></ul><h4 id="使用消息队列进程间互相通信例子" tabindex="-1"><a class="header-anchor" href="#使用消息队列进程间互相通信例子" aria-hidden="true">#</a> 使用消息队列进程间互相通信例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">message</span><span class="token punctuation">{</span>
	<span class="token keyword">long</span> mttype<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;s&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msgid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create or get msg success msgid = %d\n&quot;</span><span class="token punctuation">,</span>msgid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -q&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">message</span> msg<span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>mttype <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 父进程，负责发送数据</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgets</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 子进程负责接收数据</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">msgrcv</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nserver received data : %s&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">message</span><span class="token punctuation">{</span>
	<span class="token keyword">long</span> mttype<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;s&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>msgid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;msgget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create or get msg success msgid = %d\n&quot;</span><span class="token punctuation">,</span>msgid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -q&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">message</span> msg<span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>mttype <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 父进程，负责发送数据</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgets</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 子进程负责接收数据</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">msgrcv</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nclient received data : %s&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./server
create or get msg success msgid <span class="token operator">=</span> <span class="token number">0</span>

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
0x7324ffe1 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">0</span>            <span class="token number">0</span>

server <span class="token function">write</span> data <span class="token builtin class-name">:</span> hello
server <span class="token function">write</span> data <span class="token builtin class-name">:</span>
server received data <span class="token builtin class-name">:</span> nihao
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> chifanlema
server <span class="token function">write</span> data <span class="token builtin class-name">:</span>
server received data <span class="token builtin class-name">:</span> chile
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> xiexie
server <span class="token function">write</span> data <span class="token builtin class-name">:</span>
server received data <span class="token builtin class-name">:</span> bukeqi
server <span class="token function">write</span> data <span class="token builtin class-name">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./client
create or get msg success msgid <span class="token operator">=</span> <span class="token number">0</span>

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
0x7324ffe1 <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">0</span>            <span class="token number">0</span>

client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received data <span class="token builtin class-name">:</span> hello
client <span class="token function">write</span> data <span class="token builtin class-name">:</span> nihao
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received data <span class="token builtin class-name">:</span> chifanlema
client <span class="token function">write</span> data <span class="token builtin class-name">:</span> chile
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received data <span class="token builtin class-name">:</span> xiexie
client <span class="token function">write</span> data <span class="token builtin class-name">:</span> bukeqi
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意：</strong></p><ul><li>消息被消费（读取）后，即被删除</li><li>按照约定格式可以根据消息类型获取，互不冲突</li></ul></blockquote><h3 id="system-v-信号量" tabindex="-1"><a class="header-anchor" href="#system-v-信号量" aria-hidden="true">#</a> System V 信号量</h3><h4 id="创建或获取信号集-semget" tabindex="-1"><a class="header-anchor" href="#创建或获取信号集-semget" aria-hidden="true">#</a> 创建或获取信号集 semget</h4><p><code>int semget(key_t key, int nsems, int semflg);</code> 用于创建或获取一个 System V 信号量集。</p><ul><li><code>key</code>：信号量集的关键字，通常使用 <code>ftok</code> 函数生成。</li><li><code>nsems</code>：信号量集中的信号量数量，表示要创建或获取的信号量集中包含多少个信号量。</li><li><code>semflg</code>：标志参数，用于指定创建或获取信号量集的行为。 <ul><li><strong><code>IPC_CREAT</code>：</strong> 如果信号量集不存在，则创建它。</li><li><strong><code>IPC_EXCL</code>：</strong> 与 <code>IPC_CREAT</code> 一起使用，用于确保信号量集是新创建的，如果信号量集已经存在，则返回错误。</li><li><strong>权限标志（例如，0666）：</strong> 指定信号量集的访问权限。</li></ul></li><li><code>return</code><ul><li>返回值为信号量集的标识符（semid）</li><li>如果失败则返回 -1</li></ul></li></ul><h4 id="获取或设置信号量集的信息-semget" tabindex="-1"><a class="header-anchor" href="#获取或设置信号量集的信息-semget" aria-hidden="true">#</a> 获取或设置信号量集的信息 semget</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> sem_perm<span class="token punctuation">;</span>   <span class="token comment">// 信号量的权限结构</span>
    <span class="token class-name">time_t</span> sem_otime<span class="token punctuation">;</span>           <span class="token comment">// 上一次的操作时间</span>
    <span class="token class-name">time_t</span> sem_ctime<span class="token punctuation">;</span>           <span class="token comment">// 上一次的变更时间</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sem_nsems<span class="token punctuation">;</span>    <span class="token comment">// 信号量集中信号量的数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">seminfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> semmap<span class="token punctuation">;</span>    <span class="token comment">// 未使用</span>
    <span class="token keyword">int</span> semmni<span class="token punctuation">;</span>    <span class="token comment">// 信号量标识符数组（semid_ds结构体）的最大数量</span>
    <span class="token keyword">int</span> semmns<span class="token punctuation">;</span>    <span class="token comment">// 信号量数量的最大值</span>
    <span class="token keyword">int</span> semmnu<span class="token punctuation">;</span>    <span class="token comment">// 未使用</span>
    <span class="token keyword">int</span> semmsl<span class="token punctuation">;</span>    <span class="token comment">// 每个信号量集中的最大信号量数</span>
    <span class="token keyword">int</span> semopm<span class="token punctuation">;</span>    <span class="token comment">// 每次 semop 调用中的最大操作数</span>
    <span class="token keyword">int</span> semume<span class="token punctuation">;</span>    <span class="token comment">// 未使用</span>
    <span class="token keyword">int</span> semusz<span class="token punctuation">;</span>    <span class="token comment">// 信号量数组中的每个信号量的用户可用字节数</span>
    <span class="token keyword">int</span> semvmx<span class="token punctuation">;</span>    <span class="token comment">// 信号量值的最大值</span>
    <span class="token keyword">int</span> semaem<span class="token punctuation">;</span>    <span class="token comment">// 未使用</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个联合类型，用于适应不同的 semctl 操作</span>
<span class="token keyword">union</span> semun <span class="token punctuation">{</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>               <span class="token comment">// SETVAL 操作的值</span>
    <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>  <span class="token comment">// IPC_STAT 和 IPC_SET 操作的缓冲区</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>array<span class="token punctuation">;</span> <span class="token comment">// GETALL 和 SETALL 操作的数组</span>
    <span class="token keyword">struct</span> <span class="token class-name">seminfo</span> <span class="token operator">*</span>__buf<span class="token punctuation">;</span> <span class="token comment">// IPC_INFO 操作的缓冲区</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int semctl(int semid, int semnum, int cmd, ...);</code> 用于对 System V 信号量集进行控制操作。它可以执行多种不同的操作，例如获取或设置信号量集的信息、设置单个信号量的值等。</p><ul><li><p><code>semid</code>：信号量集的标识符，由 <code>semget</code> 函数返回。</p></li><li><p><code>semnum</code>：指定信号量的索引，通常为0表示对信号量集中的所有信号量进行操作。</p></li><li><p><code>cmd</code>：控制命令，指定要执行的操作。</p><ul><li><strong><code>IPC_STAT</code></strong>：获取信号量集的状态信息。</li><li><strong><code>IPC_SET</code></strong>：设置信号量集的状态信息。</li><li><strong><code>IPC_RMID</code></strong>：删除信号量集。</li><li><strong><code>GETPID</code></strong>：获取信号量集的创建者的进程ID。</li><li><strong><code>GETVAL</code></strong>：获取信号量的当前值。</li><li><strong><code>GETALL</code></strong>：获取信号量集中所有信号量的值。</li><li><strong><code>GETNCNT</code></strong>：获取等待在信号量上进行 P 操作的进程数。</li><li><strong><code>GETZCNT</code></strong>：获取等待在信号量上进行 Z 操作的进程数。</li><li><strong><code>SETVAL</code></strong>：设置信号量的值。</li><li><strong><code>SETALL</code></strong>：设置信号量集中所有信号量的值。</li></ul></li><li><p><code>...</code> 具体取决于 <code>cmd</code> 的值。<code>semctl</code> 的 <code>cmd</code> 参数决定了使用哪种操作，而对于不同的操作，可能需要提供不同数量和类型的参数。</p><ul><li><p><strong>获取或设置单个信号量的值：</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">semctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> semnum<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在这种情况下，<code>cmd</code> 可能是 <code>GETVAL</code> 或 <code>SETVAL</code>，而可变参数部分则取决于 <code>cmd</code> 的值。例如，对于 <code>SETVAL</code>，需要提供要设置的值作为额外的参数。</p></li><li><p><strong>获取或设置所有信号量的值：</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">semctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> semnum<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">union</span> semun arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里 <code>arg</code> 是一个 <code>union</code> 类型，通常包含了与具体操作相关的参数。例如，如果是获取或设置所有信号量的值，<code>arg</code> 可能包含了所有信号量的值的数组。</p></li></ul></li><li><p><code>return</code></p><ul><li>返回值取决于 <code>cmd</code></li><li>如果失败则返回 -1</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;union.h&gt;</span></span>




<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp&quot;</span><span class="token punctuation">,</span> <span class="token char">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 生成键值</span>

    <span class="token comment">// 创建或获取信号量集</span>
    <span class="token keyword">int</span> semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semget&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Semaphore set created or opened successfully. Semaphore ID: %d\n&quot;</span><span class="token punctuation">,</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取信号量的值</span>
    <span class="token keyword">int</span> current_value <span class="token operator">=</span> <span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GETVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current_value <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semctl (GETVAL)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Current value of the semaphore: %d\n&quot;</span><span class="token punctuation">,</span> current_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置信号量的值为 5</span>
    <span class="token keyword">union</span> semun arg_setval<span class="token punctuation">;</span>
    arg_setval<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> SETVAL<span class="token punctuation">,</span> arg_setval<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semctl (SETVAL)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Semaphore value set to 5.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 再次获取信号量的值</span>
    <span class="token keyword">int</span> new_value <span class="token operator">=</span> <span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GETVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>new_value <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semctl (GETVAL)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;New value of the semaphore: %d\n&quot;</span><span class="token punctuation">,</span> new_value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 删除信号量集</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;semctl (IPC_RMID)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="操作信号量-semop" tabindex="-1"><a class="header-anchor" href="#操作信号量-semop" aria-hidden="true">#</a> 操作信号量 semop</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sembuf</span> <span class="token punctuation">{</span>
    <span class="token keyword">short</span> sem_num<span class="token punctuation">;</span>  <span class="token comment">// 信号量集中的索引，表示要对哪个信号量执行操作。</span>
    <span class="token keyword">short</span> sem_op<span class="token punctuation">;</span>   <span class="token comment">// 操作类型，正值表示 V 操作（加1），负值表示 P 操作（减1），0 表示等待信号量值为 0。</span>
    <span class="token keyword">short</span> sem_flg<span class="token punctuation">;</span>  <span class="token comment">// 操作标志，通常设置为 0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int semop(int semid, struct sembuf *sops, size_t nsops);</code> 函数用于在 System V 信号量集上执行一系列的操作。这些操作可以包括对单个信号量的 P 操作（减1）或 V 操作（加1），或者对多个信号量的一组操作，<strong>当信号量值为0，这个函数会阻塞，直到它不为0</strong>，但是如果 sem_op 设置为0.情况可能相反。</p><ul><li><code>semid</code>：信号量集的标识符，由 <code>semget</code> 函数返回。</li><li><code>sops</code>：指向一个 <code>sembuf</code> 结构数组的指针，描述了要执行的一系列操作。</li><li><code>nsops</code>：指定 <code>sops</code> 数组的长度，即要执行的操作的数量。</li><li><code>return</code><ul><li>如果所有的操作都成功执行，返回值为 <code>0</code>。</li><li>如果有任何一个操作失败，返回值为 <code>-1</code>，并设置全局变量 <code>errno</code> 来指示出错的原因。</li></ul></li></ul><h4 id="例子" tabindex="-1"><a class="header-anchor" href="#例子" aria-hidden="true">#</a> 例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token keyword">union</span> semun <span class="token punctuation">{</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>               <span class="token comment">// value for SETVAL</span>
    <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>  <span class="token comment">// buffer for IPC_STAT, IPC_SET</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>array<span class="token punctuation">;</span> <span class="token comment">// array for GETALL, SETALL</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 信号集大小为3</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create or get sem success semid = %d\n&quot;</span><span class="token punctuation">,</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 让客户端先运行</span>
	<span class="token keyword">union</span> semun arg<span class="token punctuation">;</span>
	arg<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>SETVAL<span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置索引1信号的值为0</span>
	<span class="token keyword">struct</span> <span class="token class-name">sembuf</span> buf<span class="token punctuation">;</span>
	buf<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 操作对象是3个信号中的索引1</span>
	buf<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 信号值为0 ，再次执行P 操作（减1）会阻塞，直到被执行V 操作（加1），除非是sem_op = 0 表示等待信号量值为 0</span>
	buf<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 操作标志，通常设置为 0</span>
	<span class="token function">semop</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行以上操作</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server say : %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">key_t</span> key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">&quot;./a.txt&quot;</span><span class="token punctuation">,</span><span class="token char">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 信号集大小为3</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create or get sem success semid = %d\n&quot;</span><span class="token punctuation">,</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">&quot;ipcs -s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client say : %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">200000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">struct</span> <span class="token class-name">sembuf</span> buf<span class="token punctuation">;</span>
    buf<span class="token punctuation">.</span>sem_num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 操作对象是3个信号中的索引1</span>
    buf<span class="token punctuation">.</span>sem_op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// V 操作（加1），释放被信号值为0的阻塞</span>
    buf<span class="token punctuation">.</span>sem_flg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 操作标志，通常设置为 0</span>
    <span class="token function">semop</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行以上操作</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先执行 server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token operator">/</span>sem_server
create or get sem success semid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> Semaphore Arrays <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
key        semid      owner      perms      nsems
<span class="token number">0x6324ffe1</span> <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再执行 client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token operator">/</span>sem_client
create or get sem success semid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> Semaphore Arrays <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
key        semid      owner      perms      nsems
<span class="token number">0x6324ffe1</span> <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">3</span>

client say <span class="token operator">:</span> <span class="token number">0</span>
client say <span class="token operator">:</span> <span class="token number">1</span>
client say <span class="token operator">:</span> <span class="token number">2</span>
client say <span class="token operator">:</span> <span class="token number">3</span>
client say <span class="token operator">:</span> <span class="token number">4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>server 被唤醒</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token operator">/</span>sem_server
create or get sem success semid <span class="token operator">=</span> <span class="token number">0</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> Semaphore Arrays <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
key        semid      owner      perms      nsems
<span class="token number">0x6324ffe1</span> <span class="token number">0</span>          root       <span class="token number">777</span>        <span class="token number">3</span>

server say <span class="token operator">:</span> <span class="token number">0</span>
server say <span class="token operator">:</span> <span class="token number">1</span>
server say <span class="token operator">:</span> <span class="token number">2</span>
server say <span class="token operator">:</span> <span class="token number">3</span>
server say <span class="token operator">:</span> <span class="token number">4</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="posix-进程间通信" tabindex="-1"><a class="header-anchor" href="#posix-进程间通信" aria-hidden="true">#</a> POSIX 进程间通信</h2><h3 id="posix-共享内存-1" tabindex="-1"><a class="header-anchor" href="#posix-共享内存-1" aria-hidden="true">#</a> POSIX 共享内存</h3><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>int shm_open(const char *name, int oflag, mode_t mode)</td><td>创建共享内存</td></tr><tr><td>int shm_unlink(const char *name)</td><td>结束到共享内存的连接，并在最后一个进程关闭它时将其删除</td></tr><tr><td>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset)</td><td>映射内存</td></tr><tr><td>int munmap(void *addr, size_t length);</td><td>解除由 <code>mmap</code> 创建的映射</td></tr></tbody></table><h4 id="创建或打开共享内存" tabindex="-1"><a class="header-anchor" href="#创建或打开共享内存" aria-hidden="true">#</a> 创建或打开共享内存</h4><p><code>int shm_open(const char *name, int oflag, mode_t mode)</code> 用于创建或打开共享内存对象的 POSIX 函数。</p><ul><li><p><code>name</code>：共享内存对象的名称，类似于文件系统中的文件名。如果共享内存对象不存在，则创建一个新的共享内存对象；如果存在，则打开现有的共享内存对象。需要注意的是，共享内存对象的名称在系统范围内必须是唯一的。</p></li><li><p><code>oflag</code>：用于指定打开共享内存对象的方式，可以使用以下标志的组合：</p><ul><li><code>O_RDONLY</code>：只读方式打开共享内存对象。</li><li><code>O_RDWR</code>：读写方式打开共享内存对象。</li><li><code>O_CREAT</code>：如果共享内存对象不存在，则创建它。如果同时指定了 <code>O_CREAT</code> 和 <code>O_EXCL</code>，并且共享内存对象已经存在，则会返回错误。</li><li><code>O_EXCL</code>：如果指定了 <code>O_CREAT</code>，并且共享内存对象已经存在，则会返回错误。</li><li><code>O_TRUNC</code>：如果共享内存对象存在且以读写方式打开，则将其截断为零长度。</li></ul></li><li><p><code>mode</code>：用于指定创建新共享内存对象时的权限位，仅在指定了 <code>O_CREAT</code> 时有效。其权限位与文件的权限位类似，例如 <code>0666</code>。</p></li><li><p><code>return</code></p><ul><li><p>函数返回一个文件描述符，用于标识共享内存对象。</p></li><li><p>如果出现错误，则返回 -1，并设置 <code>errno</code> 变量来指示错误类型。</p></li></ul></li></ul><blockquote><p><strong>在使用之前需要先使用 <code>ftruncate(fd,size)</code> 调整内存到需要的大小，否则会出现 <code>Bus error</code> 错误</strong></p></blockquote><h4 id="释放共享内存" tabindex="-1"><a class="header-anchor" href="#释放共享内存" aria-hidden="true">#</a> 释放共享内存</h4><p><code>int shm_unlink(const char *name);</code></p><ul><li><code>name</code>：是一个指向共享内存对象名称的字符串。调用 <code>shm_unlink</code> 函数后，如果没有进程再使用该共享内存对象，则该对象将被删除，释放系统资源。</li><li><code>return</code><ul><li>如果成功删除共享内存对象，则该函数返回 0。</li><li>如果出现错误，则返回 -1，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><h4 id="内存映射" tabindex="-1"><a class="header-anchor" href="#内存映射" aria-hidden="true">#</a> 内存映射</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</code> 是一个系统调用，用于在进程的地址空间中映射文件或者其它对象（比如设备、匿名内存）的一部分。这个调用允许直接在内存中操作文件，而不需要常规的读写操作。在C语言中，通常使用 <code>mmap</code> 函数来进行内存映射。</p><ul><li><p><code>addr</code>：映射的起始地址，通常设置为 <code>NULL</code>，表示由系统选择合适的地址。</p></li><li><p><code>length</code>：映射的长度，以字节为单位。</p></li><li><p><code>prot</code>：映射的保护标志，指定映射区的访问权限</p><ul><li><code>PROT_READ</code>：允许读取映射区域的数据。</li><li><code>PROT_WRITE</code>：允许写入映射区域的数据。</li><li><code>PROT_EXEC</code>：允许执行映射区域的数据。</li><li><code>PROT_NONE</code>：禁止对映射区域进行访问。</li></ul></li><li><p><code>flags</code>：映射的标志，控制映射的类型和行为</p><ul><li><code>MAP_SHARED</code>：共享映射，多个进程可以共享映射区域的内容。对映射区域的修改会反映到所有共享该区域的进程。</li><li><code>MAP_PRIVATE</code>：私有映射，映射区域对调用进程是私有的，对映射区域的修改不会反映到其他进程。如果多个进程都使用 <code>MAP_PRIVATE</code>，它们各自的修改不会相互影响。</li><li><code>MAP_ANONYMOUS</code>：创建匿名映射，不与任何文件关联。这通常与 <code>MAP_PRIVATE</code> 一起使用，用于创建无关文件的共享内存区域。</li><li><code>MAP_FIXED</code>：强制使用指定的地址开始映射。如果指定地址无法使用，<code>mmap</code> 失败。</li><li><code>MAP_FIXED_NOREPLACE</code>：类似于 <code>MAP_FIXED</code>，但如果指定地址已经被占用，则 <code>mmap</code> 失败。</li><li><code>MAP_LOCKED</code>：锁定映射区域的所有页，防止它们被交换到磁盘。</li><li><code>MAP_POPULATE</code>：预先加载映射区域的所有页到物理内存，而不是在访问时按需加载。</li><li><code>MAP_NORESERVE</code>：不为映射区域保留交换空间。如果映射的数据多于系统实际可用的交换空间，这可能导致 <code>mmap</code> 失败。</li><li><code>MAP_GROWSDOWN</code>：用于堆栈，表示映射区域从高地址向低地址扩展。</li><li><code>MAP_DENYWRITE</code>：禁止写入映射区域。仅对私有映射有效，用于提高性能。</li><li><code>MAP_EXECUTABLE</code>：允许在映射区域中执行代码。</li></ul></li><li><p><code>fd</code>：文件描述符，如果映射与文件关联，传入文件描述符；如果是匿名映射，可以传入 <code>-1</code>。</p></li><li><p><code>offset</code>：文件的偏移量，对于文件映射，表示从文件的哪个位置开始映射；对于匿名映射，通常设置为 <code>0</code>。</p></li><li><p><code>return</code> 返回值是映射的起始地址，如果映射失败，返回 <code>MAP_FAILED</code>（通常是 <code>(void *) -1</code>）。</p></li></ul><blockquote><p>使用 <code>mmap</code> 可以创建文件映射，实现共享内存，也可以用于创建匿名映射，实现进程间通信。使用时需要仔细考虑映射的权限、标志和其他参数，确保满足具体的需求。此外，使用完成后，通常需要使用 <code>munmap</code> 函数解除映射。</p></blockquote><h4 id="解除由-mmap-创建的映射-1" tabindex="-1"><a class="header-anchor" href="#解除由-mmap-创建的映射-1" aria-hidden="true">#</a> 解除由 <code>mmap</code> 创建的映射</h4><p><code>int munmap(void *addr, size_t length);</code> 是一个系统调用，用于解除由 <code>mmap</code> 创建的映射，释放相应的资源。在 C 语言中，<code>munmap</code> 函数的声明通常位于 <code>&lt;sys/mman.h&gt;</code> 头文件中。</p><ul><li><code>addr</code>：映射的起始地址，通常是由 <code>mmap</code> 返回的映射起始地址。</li><li><code>length</code>：映射的长度，以字节为单位，应该与 <code>mmap</code> 时指定的长度一致。</li><li><code>return</code><ul><li>返回值是整数类型，表示函数执行的结果。如果解除映射成功，返回 <code>0</code>；</li><li>如果失败，返回 <code>-1</code>，并设置 <code>errno</code> 指示错误的原因。</li></ul></li></ul><h4 id="共享内存进程间通信例子" tabindex="-1"><a class="header-anchor" href="#共享内存进程间通信例子" aria-hidden="true">#</a> 共享内存进程间通信例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span><span class="token punctuation">{</span>
	<span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ftruncate</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 需要先调整共享内存大小</span>
	<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>MAP_SHARED<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mmap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
	p<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;mypid : %d\n&quot;</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待客户端进程收到pid后唤醒</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">fgets</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">kill</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知客户端</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">munmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">shm_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span><span class="token punctuation">{</span>
	<span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">pid_t</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">myfunc</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">shm_open</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;shm_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">ftruncate</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 需要先调整共享内存大小</span>
	<span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">shmbuf</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span>PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>MAP_SHARED<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mmap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span>myfunc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 捕获信号，以防止信号的默认行为导致进程终止</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello : %d\n&quot;</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token operator">-&gt;</span>pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client received data : %s&quot;</span><span class="token punctuation">,</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 休眠一秒让服务端获得CPU执行到pause</span>
		<span class="token function">kill</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>SIGUSR1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知客户端</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">munmap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">shm_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./server</span>
mypid <span class="token builtin class-name">:</span> <span class="token number">1023</span>
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> hello
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> nihao
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> 😂
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># ./client</span>
hello <span class="token builtin class-name">:</span> <span class="token number">1023</span>
client received data <span class="token builtin class-name">:</span> hello
client received data <span class="token builtin class-name">:</span> nihao
client received data <span class="token builtin class-name">:</span> 😂
client received data <span class="token builtin class-name">:</span> <span class="token builtin class-name">exit</span>
<span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="posix-消息队列-1" tabindex="-1"><a class="header-anchor" href="#posix-消息队列-1" aria-hidden="true">#</a> POSIX 消息队列</h3><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>mqd_t mq_open(const char *name, int oflag, mode_t mode, struct mq_attr *attr)</td><td>创建命名消息队列</td></tr><tr><td>mqd_t mq_close(mqd_t mqdes)</td><td>结束到开放式消息队列的连接</td></tr><tr><td>mqd_t mq_unlink(const char *name)</td><td>结束到开放式消息队列的连接，并在最后一个进程关闭此队列时将其删除</td></tr><tr><td>mqd_t mq_send(mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned msg_prio)</td><td>将消息放入队列</td></tr><tr><td>ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned *msg_prio)</td><td>在队列中接收消息</td></tr><tr><td>mqd_t mq_notify(mqd_t mqdes, const struct sigevent *notification)</td><td>通知进程或线程消息已存在于队列中</td></tr><tr><td>mqd_t mq_setattr(mqd_t mqdes, struct mq_attr *newattr, struct mq_attr *oldattr)</td><td>设置消息队列属性</td></tr><tr><td>mqd_t mq_getattr(mqd_t mqdes, struct mq_attr *attr) ；</td><td>获取消息队列属性</td></tr></tbody></table><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqueue.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建消息队列" tabindex="-1"><a class="header-anchor" href="#创建消息队列" aria-hidden="true">#</a> 创建消息队列</h4><p><code>mqd_t mq_open(const char *name, int oflag, mode_t mode, struct mq_attr *attr);</code> 函数用于打开或创建 POSIX 消息队列。</p><ul><li><p><code>name</code>：消息队列的名称，必须以斜杠 <code>/</code> 开头。如果消息队列不存在，则根据 <code>oflag</code> 和 <code>mode</code> 参数创建一个新的消息队列；如果消息队列已存在，则根据 <code>oflag</code> 参数打开现有的消息队列。</p></li><li><p><code>oflag</code>：用于指定打开或创建消息队列的方式，可以是以下标志的组合：</p><ul><li><code>O_RDONLY</code>：以只读方式打开消息队列。</li><li><code>O_WRONLY</code>：以只写方式打开消息队列。</li><li><code>O_RDWR</code>：以读写方式打开消息队列。</li><li><code>O_CREAT</code>：如果消息队列不存在，则创建它。</li><li><code>O_EXCL</code>：如果指定了 <code>O_CREAT</code>，并且消息队列已经存在，则返回错误。</li><li><code>O_NONBLOCK</code>：以非阻塞方式打开消息队列。</li></ul></li><li><p><code>mode</code>：用于指定创建新消息队列时的权限位，仅在指定了 <code>O_CREAT</code> 时有效。其权限位与文件的权限位类似，例如 <code>0666</code>。</p></li><li><p><code>attr</code>：指向 <code>mq_attr</code> 结构体的指针，用于指定消息队列的属性。如果为 <code>NULL</code>，则使用默认属性。</p><ul><li><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">mq_attr</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> mq_flags<span class="token punctuation">;</span>      <span class="token comment">// 队列标志</span>
    <span class="token keyword">long</span> mq_maxmsg<span class="token punctuation">;</span>     <span class="token comment">// 队列中的最大消息数</span>
    <span class="token keyword">long</span> mq_msgsize<span class="token punctuation">;</span>    <span class="token comment">// 每个消息的最大字节数</span>
    <span class="token keyword">long</span> mq_curmsgs<span class="token punctuation">;</span>    <span class="token comment">// 队列中当前的消息数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>return</code></p><ul><li>函数返回一个消息队列描述符 <code>mqd_t</code></li><li>如果出现错误，则返回 <code>(mqd_t)-1</code>，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><p><code>int mq_close(mqd_t mqdes);</code> 用于关闭一个已打开的 POSIX 消息队列。</p><ul><li><p><code>mqdes</code>：要关闭的消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>return</code></p><ul><li>返回值为 0 表示成功关闭消息队列，</li><li>如果出现错误则返回 -1，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><h4 id="删除一个-posix-消息队列" tabindex="-1"><a class="header-anchor" href="#删除一个-posix-消息队列" aria-hidden="true">#</a> 删除一个 POSIX 消息队列</h4><p><code>int mq_unlink(const char *name);</code> 函数用于删除一个 POSIX 消息队列的名称，使其不再存在于系统中。</p><ul><li><p><code>name</code>：要删除的消息队列的名称。</p></li><li><p><code>return</code></p><ul><li>函数返回值为 0 表示成功删除消息队列名称，</li><li>如果出现错误则返回 -1，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><h4 id="消息队列发送消息" tabindex="-1"><a class="header-anchor" href="#消息队列发送消息" aria-hidden="true">#</a> 消息队列发送消息</h4><p><code>int mq_send(mqd_t mqdes, const char *msg_ptr, size_t msg_len, unsigned int msg_prio);</code> 用于向打开的 POSIX 消息队列发送消息。</p><ul><li><p><code>mqdes</code>：消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>msg_ptr</code>：指向要发送的消息的缓冲区的指针。</p></li><li><p><code>msg_len</code>：要发送的消息的长度，以字节为单位。</p></li><li><p><code>msg_prio</code>：消息的优先级，优先级越高的消息会在队列中排在优先级低的消息之前。通常情况下，优先级为 0。</p></li><li><p><code>return</code></p><ul><li>函数返回值为 0 表示成功发送消息，</li><li>如果出现错误则返回 -1，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><h4 id="消息队列接收消息" tabindex="-1"><a class="header-anchor" href="#消息队列接收消息" aria-hidden="true">#</a> 消息队列接收消息</h4><p><code>ssize_t mq_receive(mqd_t mqdes, char *msg_ptr, size_t msg_len, unsigned int *msg_prio);</code> 用于从打开的 POSIX 消息队列接收消息。</p><ul><li><p><code>mqdes</code>：消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>msg_ptr</code>：指向存储接收消息的缓冲区的指针。</p></li><li><p><code>msg_len</code>：接收消息的缓冲区长度，以字节为单位。</p></li><li><p><code>msg_prio</code>：用于返回接收到消息的优先级。如果不需要获取消息的优先级，可以传入 <code>NULL</code>。</p></li><li><p><code>return</code></p><ul><li>函数返回接收到的消息的长度（以字节为单位），</li><li>如果出现错误则返回 -1，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><blockquote><p><strong>注意：</strong> <code>msg_len</code> 必须 <code>&gt;=</code> <code>mq_attr.mq_msgsize</code></p></blockquote><h4 id="消息队列设置异步通知" tabindex="-1"><a class="header-anchor" href="#消息队列设置异步通知" aria-hidden="true">#</a> 消息队列设置异步通知</h4><p><code>int mq_notify(mqd_t mqdes, const struct sigevent *notification);</code> 用于为指定的消息队列设置异步通知。当有新消息到达消息队列时，将触发异步通知，并执行与 <code>notification</code> 参数相关联的操作。</p><ul><li><p><code>mqdes</code>：消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>notification</code>：一个指向 <code>sigevent</code> 结构体的指针，用于设置异步通知的相关属性。<code>sigevent</code> 结构体包含了通知的类型和其他相关信息。</p><ul><li><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sigevent</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sigev_notify<span class="token punctuation">;</span>               <span class="token comment">// 通知类型</span>
    <span class="token keyword">int</span> sigev_signo<span class="token punctuation">;</span>                <span class="token comment">// 信号编号</span>
    <span class="token keyword">union</span> sigval sigev_value<span class="token punctuation">;</span>       <span class="token comment">// 附加值</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sigev_notify_function<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">union</span> sigval<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知处理函数</span>
    <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>sigev_notify_attributes<span class="token punctuation">;</span>     <span class="token comment">// 线程属性</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>sigev_notify</code>：用于指定通知的类型，可以是以下值之一：</p><ul><li><code>SIGEV_NONE</code>：不使用通知机制。</li><li><code>SIGEV_SIGNAL</code>：使用信号来通知。</li><li><code>SIGEV_THREAD</code>：使用线程来通知。</li></ul></li><li><p><code>sigev_signo</code>：如果 <code>sigev_notify</code> 是 <code>SIGEV_SIGNAL</code>，则指定要发送的信号编号。</p></li><li><p><code>sigev_value</code>：用于传递附加值的联合体。</p></li><li><p><code>sigev_notify_function</code>：如果 <code>sigev_notify</code> 是 <code>SIGEV_THREAD</code>，则指定一个函数，在新创建的线程中调用该函数来处理通知。</p></li><li><p><code>sigev_notify_attributes</code>：如果 <code>sigev_notify</code> 是 <code>SIGEV_THREAD</code>，则可以指定线程的属性。</p></li></ul></li><li><p><code>return</code></p><ul><li>如果成功注册异步通知，则返回 0。如果出现错误，则返回 -1，</li><li>并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><blockquote><p><strong>线程通知和信号通知的区别</strong></p><p>可以将线程通知视为异步的，因为它会在新创建的线程中执行通知处理函数，而不会阻塞当前线程的执行。这意味着，在接收到线程通知时，可以继续执行当前线程的其他操作，而不必等待通知处理函数执行完毕。</p><p>信号通知可能更像是一种阻塞的机制，因为当进程接收到信号时，会立即转移到信号处理函数执行，中断当前的程序流程。在处理完信号后，程序会回到原来的位置继续执行。这种行为可能会导致程序在接收到信号时被阻塞，直到信号处理函数执行完毕。</p><p><strong>不能用于进程间通信</strong><strong><code>mq_notify</code> 函数注册的异步通知只能与调用 <code>mq_notify</code> 函数的进程关联，无法跨进程。这意味着，如果进程A注册了一个消息队列的异步通知，当有新消息到达时，只有进程A会收到通知，其他进程无法感知到这个通知。</strong></p></blockquote><h4 id="设置-修改消息队列的属性" tabindex="-1"><a class="header-anchor" href="#设置-修改消息队列的属性" aria-hidden="true">#</a> 设置｜修改消息队列的属性</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">mq_attr</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> mq_flags<span class="token punctuation">;</span>       <span class="token comment">// 队列标志</span>
    <span class="token keyword">long</span> mq_maxmsg<span class="token punctuation">;</span>      <span class="token comment">// 队列中的最大消息数</span>
    <span class="token keyword">long</span> mq_msgsize<span class="token punctuation">;</span>     <span class="token comment">// 每个消息的最大字节数</span>
    <span class="token keyword">long</span> mq_curmsgs<span class="token punctuation">;</span>     <span class="token comment">// 队列中当前的消息数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int mq_setattr(mqd_t mqdes, const struct mq_attr *newattr, struct mq_attr *oldattr);</code> 用于修改 POSIX 消息队列的属性。</p><ul><li><p><code>mqdes</code>：消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>newattr</code>：指向 <code>struct mq_attr</code> 结构体的指针，表示要设置的新的消息队列属性。</p></li><li><p><code>oldattr</code>：如果不为 <code>NULL</code>，则指向 <code>struct mq_attr</code> 结构体的指针，用于存储修改前的消息队列属性。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><p><code>int mq_getattr(mqd_t mqdes, struct mq_attr *attr);</code> 用于获取 POSIX 消息队列的属性。</p><ul><li><p><code>mqdes</code>：消息队列的描述符，即由 <code>mq_open</code> 函数返回的消息队列描述符。</p></li><li><p><code>attr</code>：指向 <code>struct mq_attr</code> 结构体的指针，用于存储获取到的消息队列属性。</p></li><li><p><code>return</code></p><ul><li>函数返回值为 0 表示成功，</li><li>-1 表示失败，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><blockquote><p>在 POSIX 消息队列中，并没有像 System V 消息队列中那样直接支持消息类型的概念。但是，您可以通过在消息的数据中包含用于区分类型的标识符或者消息格式来实现消息的类型区分。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqueue.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">QUEUE_NAME</span> <span class="token string">&quot;/my_queue&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MSG_SIZE</span> <span class="token expression"><span class="token number">256</span></span></span>

<span class="token comment">// 定义消息类型</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">{</span>
    MSG_TYPE_A<span class="token punctuation">,</span>
    MSG_TYPE_B<span class="token punctuation">,</span>
    MSG_TYPE_C
<span class="token punctuation">}</span> MessageType<span class="token punctuation">;</span>

<span class="token comment">// 定义消息结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    MessageType type<span class="token punctuation">;</span>
    <span class="token keyword">char</span> data<span class="token punctuation">[</span>MAX_MSG_SIZE <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>MessageType<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> Message<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">mqd_t</span> mq<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mq_attr</span> attr<span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>mq_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>mq_maxmsg <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>mq_msgsize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建或打开消息队列</span>
    mq <span class="token operator">=</span> <span class="token function">mq_open</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mq <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">mqd_t</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送消息</span>
    Message msg<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>type <span class="token operator">=</span> MSG_TYPE_A<span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string">&quot;Message of type A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mq_send</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 接收消息并解析类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mq_receive</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_receive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> MSG_TYPE_A<span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received message of type A: %s\n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MSG_TYPE_B<span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received message of type B: %s\n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MSG_TYPE_C<span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received message of type C: %s\n&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received message of unknown type\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭消息队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mq_close</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 删除消息队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mq_unlink</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_unlink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></blockquote><h4 id="消息队列进程双向通信例子" tabindex="-1"><a class="header-anchor" href="#消息队列进程双向通信例子" aria-hidden="true">#</a> 消息队列进程双向通信例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqueue.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">msgbuf</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> type<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">mq_attr</span> attr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>mq_maxmsg <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">.</span>mq_msgsize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">msgbuf</span> msg<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">mqd_t</span> mq <span class="token operator">=</span> <span class="token function">mq_open</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>mq <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgets</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">mq_send</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">mq_close</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">mq_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">mqd_t</span> mq <span class="token operator">=</span> <span class="token function">mq_open</span><span class="token punctuation">(</span><span class="token string">&quot;/bb&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>mq <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> bytesRead <span class="token operator">=</span> <span class="token function">mq_receive</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收大小必须&gt;= mq_attr.mq_msgsize</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nserver received %ld  data : %s&quot;</span><span class="token punctuation">,</span>bytesRead<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;server write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">mq_close</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">mq_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/bb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqueue.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">msgbuf</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> type<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">124</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">mq_attr</span> attr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">.</span>mq_maxmsg <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">.</span>mq_msgsize <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">msgbuf</span> msg<span class="token punctuation">;</span>
	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">mqd_t</span> mq <span class="token operator">=</span> <span class="token function">mq_open</span><span class="token punctuation">(</span><span class="token string">&quot;/bb&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>mq <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fgets</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">mq_send</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">mq_close</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">mq_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/bb&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">mqd_t</span> mq <span class="token operator">=</span> <span class="token function">mq_open</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">,</span>O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>mq <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;mq_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">124</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> bytesRead <span class="token operator">=</span> <span class="token function">mq_receive</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span><span class="token number">128</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收大小必须&gt;= mq_attr.mq_msgsize</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\nclient received %ld  data : %s&quot;</span><span class="token punctuation">,</span>bytesRead<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>buf<span class="token punctuation">,</span><span class="token string">&quot;exit\n&quot;</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client write data : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">mq_close</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token function">mq_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./server
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> hello linux
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> 你好
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> 😂
server <span class="token function">write</span> data <span class="token builtin class-name">:</span> zaima
server <span class="token function">write</span> data <span class="token builtin class-name">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./client
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received <span class="token number">128</span>  data <span class="token builtin class-name">:</span> hello linux
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received <span class="token number">128</span>  data <span class="token builtin class-name">:</span> 你好
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received <span class="token number">128</span>  data <span class="token builtin class-name">:</span> 😂
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
client received <span class="token number">128</span>  data <span class="token builtin class-name">:</span> zaima
client <span class="token function">write</span> data <span class="token builtin class-name">:</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="posix-信号量-1" tabindex="-1"><a class="header-anchor" href="#posix-信号量-1" aria-hidden="true">#</a> POSIX 信号量</h3><table><thead><tr><th>API</th><th>API 作用</th></tr></thead><tbody><tr><td>sem_t *sem_open(const char *name, int oflag, mode_t mode, unsigned int value)</td><td>创建命名信号量</td></tr><tr><td>int sem_init(sem_t *sem, int pshared, unsigned int value)</td><td>初始化信号量结构</td></tr><tr><td>int sem_close(sem_t *sem)</td><td>结束到开放式信号量的连接</td></tr><tr><td>int sem_unlink(const char *name)</td><td>结束到开放式信号量的连接，并在最后一个进程关闭此信号量时将其删除</td></tr><tr><td>int sem_getvalue(sem_t *sem, int *sval)</td><td>将信号量的值复制到指定整数中</td></tr><tr><td>int sem_wait(sem_t *sem)</td><td>递减信号量计数，当其他进程拥有信号量时进行阻塞，或者当其他进程拥有信号量时返回错误</td></tr><tr><td>int sem_post(sem_t *sem)</td><td>递增信号量计数</td></tr><tr><td>int sem_destroy(sem_t *sem);</td><td>销毁（释放）未命名信号量</td></tr></tbody></table><blockquote><p><strong>未命名信号量通常用于线程同步</strong></p><ul><li>sem_init</li><li>sem_destroy</li></ul><p>其他函数和命名信号量一样</p><p><strong>命名信号量通常用于进程间通信</strong></p></blockquote><h4 id="打开或创建-posix-命名信号量" tabindex="-1"><a class="header-anchor" href="#打开或创建-posix-命名信号量" aria-hidden="true">#</a> 打开或创建 POSIX 命名信号量</h4><p><code>sem_t *sem_open(const char *name, int oflag, mode_t mode, unsigned int value);</code> 用于打开或创建 POSIX 命名信号量。</p><ul><li><p><code>name</code>：信号量的名称，必须以斜杠 <code>/</code> 开头，且不超过 <code>SEM_NAME_MAX</code> 个字符。</p></li><li><p><code>oflag</code>：打开标志，可以是以下值之一：</p><ul><li><code>O_CREAT</code>：如果不存在指定名称的信号量，则创建它。</li><li><code>O_EXCL</code>：与 <code>O_CREAT</code> 一起使用时，要求创建一个新的信号量，如果已经存在同名的信号量，则返回错误。</li><li><code>O_RDWR</code>：以读写方式打开信号量。</li><li><code>O_RDONLY</code>：以只读方式打开信号量。</li><li><code>O_WRONLY</code>：以只写方式打开信号量。</li></ul></li><li><p><code>mode</code>：创建新信号量时，指定权限位，通常以八进制表示。</p></li><li><p><code>value</code>：信号量的初始值。</p></li><li><p><code>return</code></p><ul><li>函数返回值为 <code>sem_t*</code> 类型的指针，指向打开或创建的信号量对象。</li><li>如果出现错误，则返回 <code>SEM_FAILED</code>，并设置相应的错误码，可以通过查看 <code>errno</code> 变量获取。</li></ul></li></ul><h4 id="关闭命名信号量" tabindex="-1"><a class="header-anchor" href="#关闭命名信号量" aria-hidden="true">#</a> 关闭命名信号量</h4><p><code>int sem_close(sem_t *sem);</code> 用于关闭命名信号量。</p><ul><li><p><code>sem</code>：是一个指向信号量对象的指针，它指向要关闭的信号量。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败。</li></ul></li></ul><blockquote><p>在成功关闭信号量之后，对应的信号量资源将被释放，但信号量并不会立即被销毁。只有当所有对该信号量的打开者都调用了 <code>sem_close</code> 函数后，信号量才会被销毁。</p></blockquote><h4 id="删除命名信号量" tabindex="-1"><a class="header-anchor" href="#删除命名信号量" aria-hidden="true">#</a> 删除命名信号量</h4><p><code>int sem_unlink(const char *name);</code> 用于删除命名信号量，从文件系统中删除信号量的名称。</p><ul><li><p><code>name</code> 是要删除的信号量的名称。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败。</li></ul></li></ul><blockquote><p>成功调用 <code>sem_unlink</code> 函数后，命名信号量将从文件系统中删除，但是仅在所有对该信号量的打开者都调用了 <code>sem_close</code> 函数之后，该信号量才会被真正销毁。</p></blockquote><h4 id="初始化未命名的-posix-信号量" tabindex="-1"><a class="header-anchor" href="#初始化未命名的-posix-信号量" aria-hidden="true">#</a> 初始化未命名的 POSIX 信号量</h4><p><code>int sem_init(sem_t *sem, int pshared, unsigned int value);</code> 是在POSIX标准中定义的，用于初始化一个信号量。这个函数通常在使用信号量之前调用，以设置信号量的初始值。</p><ul><li><code>sem</code>：指向要初始化的信号量的指针。</li><li><code>pshared</code>：指定信号量是在进程间共享还是在线程间共享。如果为0，表示信号量在当前进程的所有线程之间共享；如果为非零值，表示信号量可以在多个进程之间共享。</li><li><code>value</code>：指定信号量的初始值。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><blockquote><p><code>sem_init</code> 类似无名管道，只能父子进程间通信</p></blockquote><h4 id="销毁-释放-未命名信号量-sem-destroy" tabindex="-1"><a class="header-anchor" href="#销毁-释放-未命名信号量-sem-destroy" aria-hidden="true">#</a> 销毁（释放）未命名信号量 sem_destroy</h4><p><code>int sem_destroy(sem_t *sem);</code> 是一个信号量操作函数，用于销毁（释放）先前通过 <code>sem_init</code> 初始化的信号量。在不再需要信号量时，应该调用 <code>sem_destroy</code> 来释放相关的资源。</p><ul><li><code>sem</code>：指向要销毁的信号量的指针。</li><li><code>return</code><ul><li>返回值为0表示成功，</li><li>而其他的值表示出现了错误。如果出现错误，可以使用全局变量 <code>errno</code> 获取具体的错误代码。</li></ul></li></ul><h4 id="获取信号量的当前值" tabindex="-1"><a class="header-anchor" href="#获取信号量的当前值" aria-hidden="true">#</a> 获取信号量的当前值</h4><p><code>int sem_getvalue(sem_t *sem, int *sval);</code> 用于获取信号量的当前值，即信号量的计数器值。</p><ul><li><p><code>sem</code> 是一个指向信号量对象的指针，指向要获取值的信号量对象。</p></li><li><p><code>sval</code> 是一个指针，用于存储获取到的信号量的值。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败。</li></ul></li></ul><h4 id="等待信号量" tabindex="-1"><a class="header-anchor" href="#等待信号量" aria-hidden="true">#</a> 等待信号量</h4><p><code>int sem_wait(sem_t *sem);</code> 函数用于等待信号量，如果信号量的值大于 0，则将信号量的值减 1 并立即返回；如果信号量的值为 0，则调用进程将被阻塞，直到信号量的值大于 0 为止。</p><ul><li><p><code>sem</code> 是一个指向信号量对象的指针，指向要等待的信号量对象。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败。</li></ul></li></ul><blockquote><p>成功调用后，信号量的值会减 1，如果调用进程被阻塞，则会等待直到信号量的值变为大于 0 为止。</p></blockquote><h4 id="增加信号量的值" tabindex="-1"><a class="header-anchor" href="#增加信号量的值" aria-hidden="true">#</a> 增加信号量的值</h4><p><code>int sem_post(sem_t *sem);</code> 用于增加信号量的值。</p><ul><li><p><code>sem</code> 是一个指向信号量对象的指针，指向要释放的信号量对象。</p></li><li><p><code>return</code></p><ul><li>0 表示成功，</li><li>-1 表示失败</li></ul></li></ul><blockquote><p>成功调用后，信号量的值会增加 1，如果有其他进程或线程正在等待该信号量，则其中一个等待的进程或线程将被唤醒。</p></blockquote><h4 id="信号量进程间通信例子" tabindex="-1"><a class="header-anchor" href="#信号量进程间通信例子" aria-hidden="true">#</a> 信号量进程间通信例子</h4><p>server</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">sem_t</span> <span class="token operator">*</span>semid <span class="token operator">=</span> <span class="token function">sem_open</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sem_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sem_wait</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sem_post</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_close</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>client</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token class-name">sem_t</span> <span class="token operator">*</span>semid <span class="token operator">=</span> <span class="token function">sem_open</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0777</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sem_open&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sem_post</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使当前进程让出CPU，让服务器sem_wait先收到，以防下一行的先收到信号</span>
	<span class="token function">sem_wait</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hello %d\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">sem_close</span><span class="token punctuation">(</span>semid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">sem_unlink</span><span class="token punctuation">(</span><span class="token string">&quot;/aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>先运行 server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./server
<span class="token comment"># 阻塞中...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>再运行client</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>./client
<span class="token comment"># 等待server执行完...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>server</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hello <span class="token number">1</span>
hello <span class="token number">2</span>
hello <span class="token number">3</span>
hello <span class="token number">4</span>
hello <span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>server 执行完后， client 开始执行</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hello <span class="token number">1</span>
hello <span class="token number">2</span>
hello <span class="token number">3</span>
hello <span class="token number">4</span>
hello <span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="socket-网络编程" tabindex="-1"><a class="header-anchor" href="#socket-网络编程" aria-hidden="true">#</a> Socket 网络编程</h2><p>Socket（套接字）是一种用于在计算机网络中进行通信的编程接口或端点。它允许不同的计算机或进程通过网络进行数据交换。在网络编程中，Socket 提供了一种标准化的方法，使不同操作系统上的程序能够进行通信。</p><p>Socket 编程通常涉及两个主要角色：</p><ol><li><strong>服务器（Server）：</strong> 在网络上监听并等待客户端的连接请求。一旦连接建立，服务器与客户端之间就可以进行双向通信。</li><li><strong>客户端（Client）：</strong> 发起与服务器的连接请求，并在连接建立后与服务器进行通信。</li></ol><p>Socket 编程的常用步骤如下：</p><ol><li><strong>创建 Socket：</strong> 使用 <code>socket</code> 函数创建一个套接字，指定协议和套接字类型。</li><li><strong>绑定 Socket：</strong> 对于服务器，使用 <code>bind</code> 函数将套接字绑定到特定的 IP 地址和端口上。</li><li><strong>监听（对于服务器）：</strong> 使用 <code>listen</code> 函数开始监听连接请求。</li><li><strong>接受连接（对于服务器）：</strong> 使用 <code>accept</code> 函数接受客户端的连接请求，建立连接。</li><li><strong>连接（对于客户端）：</strong> 使用 <code>connect</code> 函数连接到服务器。</li><li><strong>发送和接收数据：</strong> 使用 <code>send</code> 和 <code>recv</code> 函数在连接上发送和接收数据。</li><li><strong>关闭连接：</strong> 使用 <code>close</code> 函数关闭连接。</li></ol><p>Socket 提供了不同类型的套接字，常见的包括：</p><ul><li><strong>流式套接字（SOCK_STREAM）：</strong> 提供面向连接的、可靠的双向字节流。常用于 TCP 协议。</li><li><strong>数据报套接字（SOCK_DGRAM）：</strong> 提供无连接、不可靠的通信。常用于 UDP 协议。</li></ul><p>Socket 编程可以用于各种网络应用，包括 Web 服务器、聊天程序、文件传输等。在不同编程语言中，Socket API 的实现可能会有所不同。在C语言中，常见的有 POSIX Socket API，而在Python中，有 <code>socket</code> 模块等。</p><h3 id="创建套接字" tabindex="-1"><a class="header-anchor" href="#创建套接字" aria-hidden="true">#</a> 创建套接字</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int socket(int domain, int type, int protocol);</code> 函数是用于创建套接字的系统调用。</p><ul><li><code>domain</code>：指定协议族（地址族），常见的有 <code>AF_INET</code>（IPv4）、<code>AF_INET6</code>（IPv6）等。 <ul><li><strong><code>AF_INET</code> (IPv4):</strong> 使用 IPv4 地址族。</li><li><strong><code>AF_INET6</code> (IPv6):</strong> 使用 IPv6 地址族。</li><li><strong><code>AF_UNIX</code> (Unix Domain):</strong> 使用 Unix 域套接字，用于本地进程间通信。</li><li><strong><code>AF_NETLINK</code> (Netlink):</strong> 用于 Linux 内核与用户空间之间的通信。</li><li><strong><code>AF_PACKET</code> (Packet):</strong> 原始套接字，用于直接访问网络帧。</li></ul></li><li><code>type</code>：指定套接字类型，常见的有 <code>SOCK_STREAM</code>（流式套接字，用于 TCP）和 <code>SOCK_DGRAM</code>（数据报套接字，用于 UDP）等。 <ul><li><strong><code>SOCK_STREAM</code> (Stream):</strong> 流式套接字，提供面向连接的、可靠的双向字节流。用于 TCP。</li><li><strong><code>SOCK_DGRAM</code> (Datagram):</strong> 数据报套接字，提供无连接、不可靠的通信。用于 UDP。</li><li><strong><code>SOCK_RAW</code> (Raw):</strong> 原始套接字，可以用于直接访问网络帧，通常需要特殊权限。</li><li><strong><code>SOCK_SEQPACKET</code> (Sequential Packet):</strong> 有序分组套接字。</li></ul></li><li><code>protocol</code>：指定具体的协议，通常可以设为 0，表示使用默认协议。 <ul><li><strong><code>0</code> (Default):</strong> 通常表示使用默认协议。对于 <code>SOCK_STREAM</code> 类型，表示使用 TCP；对于 <code>SOCK_DGRAM</code> 类型，表示使用 UDP。</li><li><strong><code>IPPROTO_TCP</code>:</strong> TCP 协议。</li><li><strong><code>IPPROTO_UDP</code>:</strong> UDP 协议。</li><li><strong><code>IPPROTO_ICMP</code>:</strong> ICMP 协议，用于网络错误报告和诊断。</li><li><strong><code>IPPROTO_RAW</code>:</strong> 原始 IP 协议。</li><li><strong><code>IPPROTO_IP</code>:</strong> 使用主机系统默认的协议。</li><li><strong><code>IPPROTO_IPV6</code>:</strong> IPv6 协议。</li></ul></li><li><code>return</code><ul><li>如果成功，返回一个非负整数作为套接字描述符，表示创建的套接字。</li><li>如果失败，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><h3 id="设置网络地址" tabindex="-1"><a class="header-anchor" href="#设置网络地址" aria-hidden="true">#</a> 设置网络地址</h3><p>在socket程序中，<code>struct sockaddr_in</code> 用于设置网络地址</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span>  <span class="token comment">// 地址族（地址类型）</span>
    <span class="token keyword">char</span>        sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 地址数据，通常包含 IP 地址和端口号等信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">sa</span><span class="token expression">_family</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">AF_INET：表示 IPv4 地址族。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">AF_INET6：表示 IPv6 地址族。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">AF_UNIX：表示 Unix 域（本地域）套接字。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">AF_NETLINK：表示 Linux 内核通信协议。</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token expression">AF_PACKET：表示原始网络数据包接口。</span></span>

#其中，sa_family 字段表示地址族，指定了地址的类型，可以是 AF_INET（IPv4）、AF_INET6（IPv6）、AF_UNIX（Unix 域套接字）等等。而 sa_data 字段则是一个长度为 <span class="token number">14</span> 字节的数组，用于存储具体的地址信息，如 IP 地址和端口号。

#由于 <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> 是一个抽象的通用结构体，它并不能直接用于存储具体的地址信息，而是需要配合实际的协议族结构体使用，如 <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>（用于 IPv4 地址）、<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span>（用于 IPv6 地址）、<span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span>（用于 Unix 域套接字地址）等。这些结构体会根据不同的协议族对 <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> 进行扩展，以存储各种不同类型的地址信息。

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span> <span class="token comment">// 地址族 (AF_INET)</span>
    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>     <span class="token comment">// 端口号</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span> <span class="token comment">// IPv4 地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin6_family<span class="token punctuation">;</span>   <span class="token comment">// 地址族 (AF_INET6)</span>
    <span class="token class-name">in_port_t</span> sin6_port<span class="token punctuation">;</span>       <span class="token comment">// 端口号</span>
    <span class="token class-name">uint32_t</span> sin6_flowinfo<span class="token punctuation">;</span>    <span class="token comment">// 流信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span> <span class="token comment">// IPv6 地址</span>
    <span class="token class-name">uint32_t</span> sin6_scope_id<span class="token punctuation">;</span>    <span class="token comment">// 用于确定地址的范围</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">// IPv4 地址，以网络字节序存储</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// IPv6 地址，以字节数组形式存储</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="网络字节序和主机字节序" tabindex="-1"><a class="header-anchor" href="#网络字节序和主机字节序" aria-hidden="true">#</a> 网络字节序和主机字节序</h3><p>网络字节序（<code>Network Byte Order</code>）和主机字节序（<code>Host Byte Order</code>）是两种不同的字节序，用于在计算机网络中进行数据传输和交换。字节序指的是字节在内存中存储的顺序，包括大端序（<code>Big-Endian</code>）和小端序（<code>Little-Endian</code>）两种。</p><ol><li><p><strong>网络字节序（<code>Big-Endian</code>）：</strong> 在网络字节序中，最高有效字节（Most Significant Byte，MSB）存储在最低的内存地址，而最低有效字节（Least Significant Byte，LSB）存储在最高的内存地址。这意味着数据在网络上传输时，字节的顺序是按照大端序排列的。</p></li><li><p><strong>主机字节序：</strong> 主机字节序是指在特定计算机体系结构上使用的字节序。不同的处理器和架构可能使用大端序或小端序。例如，x86 架构通常使用小端序，而大多数网络协议要求使用大端序。</p><ul><li><strong>小端字节序（Little-endian）：</strong> 低位字节存储在低地址，高位字节存储在高地址。x86 架构是小端字节序。</li><li><strong>大端字节序（Big-endian）：</strong> 高位字节存储在低地址，低位字节存储在高地址。例如，网络字节序就是大端字节序。(<strong>符合直觉</strong>)</li></ul></li></ol><p>为了在不同字节序的系统之间进行正确的数据传输，通信双方需要协商使用哪种字节序。<strong>通常，在网络编程中，会使用标准的网络字节序，即大端序。</strong></p><ol><li><strong><code>htons</code> (Host to Network Short):</strong> 将 16 位整数从主机字节序转换为网络字节序。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong><code>ntohs</code> (Network to Host Short):</strong> 将 16 位整数从网络字节序转换为主机字节序。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><strong><code>htonl</code> (Host to Network Long):</strong> 将 32 位整数从主机字节序转换为网络字节序。</li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p><strong><code>ntohl</code> (Network to Host Long):</strong> 将 32 位整数从网络字节序转换为主机字节序。</p></li><li><p><strong><code>ntohl</code> (Network to Host Long):</strong> 将 32 位整数从网络字节序转换为主机字节序。</p></li></ol><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些函数通常用于处理网络协议头部中的字段，确保在网络中正确传递数据。例如，在发送数据时，可以使用 <code>htons</code> 和 <code>htonl</code> 将数据转换为网络字节序；在接收数据时，可以使用 <code>ntohs</code> 和 <code>ntohl</code> 将数据从网络字节序转换为主机字节序。</p><h3 id="点分十进制的-ipv4-或-ipv6-地址字符串和二进制格式互转" tabindex="-1"><a class="header-anchor" href="#点分十进制的-ipv4-或-ipv6-地址字符串和二进制格式互转" aria-hidden="true">#</a> 点分十进制的 IPv4 或 IPv6 地址字符串和二进制格式互转</h3><h4 id="点分十进制地址转二进制-inet-pton" tabindex="-1"><a class="header-anchor" href="#点分十进制地址转二进制-inet-pton" aria-hidden="true">#</a> 点分十进制地址转二进制 inet_pton</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int inet_pton(int af, const char *src, void *dst);</code> 函数用于将点分十进制的 IPv4 或 IPv6 地址转换为二进制格式。它的原型如下：</p><ul><li><p><code>af</code>：地址族，可以是 <code>AF_INET</code> 表示 IPv4，或 <code>AF_INET6</code> 表示 IPv6。</p></li><li><p><code>src</code>：输入的点分十进制形式的 IP 地址字符串。</p></li><li><p><code>dst</code>：用于存储二进制格式地址的缓冲区，类型为 <code>void*</code> ，<code>dst</code> 取值可以是 <code>in_addr_t</code> 或 <code>in6_addr</code></p><ul><li><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin_family<span class="token punctuation">;</span> <span class="token comment">// 地址族 (AF_INET)</span>
    <span class="token class-name">in_port_t</span> sin_port<span class="token punctuation">;</span>     <span class="token comment">// 端口号</span>
    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span> <span class="token comment">// IPv4 地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span> sin6_family<span class="token punctuation">;</span>   <span class="token comment">// 地址族 (AF_INET6)</span>
    <span class="token class-name">in_port_t</span> sin6_port<span class="token punctuation">;</span>       <span class="token comment">// 端口号</span>
    <span class="token class-name">uint32_t</span> sin6_flowinfo<span class="token punctuation">;</span>    <span class="token comment">// 流信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span> <span class="token comment">// IPv6 地址</span>
    <span class="token class-name">uint32_t</span> sin6_scope_id<span class="token punctuation">;</span>    <span class="token comment">// 用于确定地址的范围</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span> <span class="token comment">// IPv4 地址，以网络字节序存储</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// IPv6 地址，以字节数组形式存储</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>return</code></p><ul><li>1 表示转换成功。</li><li>0 表示输入的字符串不是有效的 IP 地址。</li><li>-1 表示发生错误，可以通过 <code>errno</code> 获取具体的错误信息。</li></ul></li></ul><h4 id="二进制地址转点分十进制-inet-ntop" tabindex="-1"><a class="header-anchor" href="#二进制地址转点分十进制-inet-ntop" aria-hidden="true">#</a> 二进制地址转点分十进制 inet_ntop</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);</code> 用于将网络字节序的 IP 地址转换为点分十进制字符串表示形式。它支持 IPv4 和 IPv6 地址族。</p><ul><li><code>af</code> 参数指定了地址族，可以是 <code>AF_INET</code> 表示 IPv4 地址族，也可以是 <code>AF_INET6</code> 表示 IPv6 地址族。</li><li><code>src</code> 参数是一个指向包含二进制形式 IP 地址的内存区域的指针，<code>dst</code> 取值可以是 <code>in_addr_t</code> 或 <code>in6_addr</code>。</li><li><code>dst</code> 参数是一个指向用于保存转换后的 IP 地址字符串的缓冲区的指针。</li><li><code>size</code> 参数指定了缓冲区的大小。</li><li><code>return</code><ul><li>函数返回一个指向转换后的 IP 地址字符串的指针，</li><li>如果转换失败，则返回 <code>NULL</code>。</li></ul></li></ul><h5 id="二进制ipv4地址转点分十进制-inet-ntoa" tabindex="-1"><a class="header-anchor" href="#二进制ipv4地址转点分十进制-inet-ntoa" aria-hidden="true">#</a> 二进制IPv4地址转点分十进制 inet_ntoa</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>char *inet_ntoa(struct in_addr in);</code> 用于将 IPv4 地址（<code>struct in_addr</code> 类型）转换为点分十进制字符串表示形式。它将一个 <code>struct in_addr</code> 结构体中的 <code>s_addr</code> 字段（32 位的 IPv4 地址）转换为点分十进制字符串。</p><ul><li><code>in</code> 是一个 <code>struct in_addr</code> 类型的结构体变量，表示要转换的 IPv4 地址。</li><li><code>return</code> 返回值是一个指向静态分配的字符串的指针，该字符串包含了表示 IPv4 地址的点分十进制形式。需要注意的是，<code>inet_ntoa</code> 函数使用了一个静态的缓冲区来存储结果，因此多次调用这个函数可能会覆盖之前的结果。</li></ul><h4 id="点分十进制ipv4地址转二进制-inet-aton" tabindex="-1"><a class="header-anchor" href="#点分十进制ipv4地址转二进制-inet-aton" aria-hidden="true">#</a> 点分十进制IPv4地址转二进制 inet_aton</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int inet_aton(const char *cp, struct in_addr *inp);</code> 用于将点分十进制形式的 IPv4 地址转换为网络字节序的二进制形式。这个函数是 <code>inet_addr</code> 函数的改进版本。</p><ul><li><code>cp</code> 参数是一个指向包含点分十进制形式 IPv4 地址的字符串的指针。</li><li><code>inp</code> 参数是一个指向 <code>struct in_addr</code> 类型的结构体变量的指针，用于保存转换后的二进制形式 IPv4 地址。</li><li><code>return</code><ul><li>函数返回值为 1 表示转换成功，</li><li>返回 0 表示传入的字符串不是有效的 IPv4 地址格式。</li></ul></li></ul><p><code>in_addr_t inet_addr(const char *cp);</code> 用于将点分十进制形式的 IPv4 地址转换为网络字节序的二进制形式。</p><ul><li><code>cp</code> 参数是一个指向包含点分十进制形式 IPv4 地址的字符串的指针。</li><li><code>return</code><ul><li>函数返回值是一个 <code>in_addr_t</code> 类型的值，表示转换后的二进制形式 IPv4 地址。</li><li>如果转换失败，则返回 <code>INADDR_NONE</code> 宏，其值为 <code>0xFFFFFFFF</code>。</li></ul></li></ul><h3 id="设置套接字选项-setsockopt" tabindex="-1"><a class="header-anchor" href="#设置套接字选项-setsockopt" aria-hidden="true">#</a> 设置套接字选项 setsockopt</h3><p><code>int setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);</code> 是一个系统调用函数，用于设置套接字选项。它允许程序员在创建套接字之后，在运行时修改套接字的属性。<code>setsockopt</code> 函数通常用于调整套接字的行为，以满足特定需求或优化网络性能。</p><ul><li><code>sockfd</code>：套接字描述符，指定要修改选项的套接字。</li><li><code>level</code>：选项所属的协议层次。 <ul><li><code>SOL_SOCKET</code>：通用套接字选项，适用于各种类型的套接字。</li><li><code>IPPROTO_TCP</code>：TCP 协议选项，用于控制 TCP 套接字的行为。</li><li><code>IPPROTO_IP</code>：IP 协议选项，用于控制 IP 层的行为。</li><li><code>IPPROTO_IPV6</code>：IPv6 协议选项，用于控制 IPv6 层的行为。</li></ul></li><li><code>optname</code>：要设置的选项名称，可以是常量，如 <code>SO_REUSEADDR</code>、<code>SO_KEEPALIVE</code> 等。 <ul><li><code>SO_REUSEADDR</code>：允许多个套接字绑定到同一个地址。</li><li><code>SO_KEEPALIVE</code>：启用 TCP 的 keepalive 机制，用于检测连接是否仍然有效。</li><li><code>SO_RCVBUF</code> 和 <code>SO_SNDBUF</code>：设置接收缓冲区和发送缓冲区的大小。</li><li><code>SO_TIMEOUT</code>：设置超时时间，用于控制阻塞操作的超时时间。</li><li><code>TCP_NODELAY</code>：禁用 Nagle 算法，用于实现低延迟的数据传输。</li><li><code>IP_TTL</code>：设置 IP 数据包的 TTL（Time-To-Live），用于控制数据包在网络中的生存时间。</li><li><code>IP_ADD_MEMBERSHIP</code> 和 <code>IP_DROP_MEMBERSHIP</code>：用于 IP 多播的成员身份管理。</li><li><code>TCP_MAXSEG</code>：设置 TCP 协议的最大分段大小。</li><li><code>TCP_KEEPIDLE</code>、<code>TCP_KEEPINTVL</code> 和 <code>TCP_KEEPCNT</code>：用于设置 TCP keepalive 定时器参数。</li><li>这只是一些常见的选项，实际上还有很多其他可用的选项，具体可参考操作系统或网络库的文档。</li></ul></li><li><code>optval</code>：指向包含新选项值的缓冲区的指针。</li><li><code>optlen</code>：指定 <code>optval</code> 缓冲区的长度。</li><li><code>return</code><ul><li>成功后返回 0，</li><li>失败返回 -1，并设置相应的错误码（通过 <code>errno</code> 获取）。</li></ul></li></ul><h3 id="绑定套接字-bind" tabindex="-1"><a class="header-anchor" href="#绑定套接字-bind" aria-hidden="true">#</a> 绑定套接字 bind</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code> 函数是在套接字编程中用于将一个地址（IP 地址和端口号）绑定到一个套接字的操作。</p><ul><li><code>sockfd</code>：套接字描述符，是通过 <code>socket</code> 创建的套接字。</li><li><code>addr</code>：指向包含要绑定到套接字的地址信息的结构体指针。通常是 <code>struct sockaddr</code> 类型的指针，但在实际使用中可能是指向特定地址结构体（如 <code>struct sockaddr_in</code> 或 <code>struct sockaddr_in6</code>）的指针。</li><li><code>addrlen</code>：地址结构体的长度，使用 <code>sizeof(struct sockaddr)</code>。</li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// 准备地址结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>
    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>         <span class="token comment">// IPv4 地址族</span>
    server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span> <span class="token comment">// 使用任意可用地址</span>
    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 设置端口号，注意转换为网络字节序</span>

    <span class="token comment">// 绑定地址到套接字</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>INADDR_ANY</code> 是一个特殊的 IP 地址常量，表示将套接字绑定到所有可用的网络接口上。它在 IPv4 编程中经常用于服务器端，使服务器能够接受来自任意网络接口的连接请求。</p><p>在 <code>&lt;netinet/in.h&gt;</code> 头文件中定义了 <code>INADDR_ANY</code> 的值，通常是 0。其值为：</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INADDR_ANY</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">in_addr_t</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当你将套接字绑定到 <code>INADDR_ANY</code> 时，系统会选择一个适当的网络接口来处理该套接字。这使得服务器能够在多个网络接口上监听，并接受来自任意网络接口的连接请求。</p></blockquote><h3 id="监听连接请求-listen" tabindex="-1"><a class="header-anchor" href="#监听连接请求-listen" aria-hidden="true">#</a> 监听连接请求 listen</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int listen(int sockfd, int backlog);</code> 函数用于将套接字设置为监听状态，准备接受连接请求。</p><ul><li><code>sockfd</code>：是通过 <code>socket</code> 创建并经过 <code>bind</code> 绑定的套接字描述符。</li><li><code>backlog</code>：定义了在未处理连接请求队列中允许的最大连接数。如果有更多的连接请求，它们将被拒绝。这个参数并不是连接数的硬性限制，而是系统能够处理的最大连接数。 <ul><li>如果将 <code>backlog</code> 参数设置为 0，系统会使用一个合理的默认值。但是，这个默认值可能因系统而异，因此最好的做法是在调用 <code>listen</code> 时显式地指定一个合适的 <code>backlog</code> 值。</li><li>如果服务器预计会有大量并发连接，可以选择一个较大的值。在实践中，常见的 <code>backlog</code> 值为 5 到 128 之间。</li></ul></li><li><code>return</code><ul><li>如果成功，返回 0。</li><li>如果失败，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><h3 id="接受客户端请求-accept" tabindex="-1"><a class="header-anchor" href="#接受客户端请求-accept" aria-hidden="true">#</a> 接受客户端请求 accept</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);</code> 函数用于在服务器端接受客户端的连接请求。它是在监听套接字上调用的，等待客户端连接并返回一个新的套接字，通过这个新套接字可以与客户端进行通信。</p><ul><li><code>sockfd</code>：是调用 <code>socket</code> 和 <code>bind</code> 后通过 <code>listen</code> 监听的套接字描述符。</li><li><code>addr</code>：一个指向 <code>struct sockaddr</code> 类型的指针，用于存储客户端的地址信息。可以传入 <code>NULL</code>，表示不关心客户端地址。</li><li><code>addrlen</code>：一个指向 <code>socklen_t</code> 类型的指针，用于指定传入的 <code>addr</code> 缓冲区的长度。在函数调用后，<code>addrlen</code> 会被更新为实际接收到的地址结构体的长度。可以传入 <code>NULL</code>，表示不关心客户端地址。</li><li><code>return</code><ul><li>如果成功，返回一个新的套接字描述符，用于与客户端进行通信。</li><li>如果失败，返回 -1，并设置 <code>errno</code> 表示错误类型。</li></ul></li></ul><blockquote><p>accept 返回一个新的 socket 关联到客户端，它与原始 socket 有相同的套接字类型和协议族。</p><p>传递给 accept 的原始 socket 没有关联客户端，它继续保持可用状态，接受其他客户端的请求。</p><p>accept 是一个阻塞函数，会一直等到有新的客户端请求。</p></blockquote><h3 id="与服务器建立连接-connect" tabindex="-1"><a class="header-anchor" href="#与服务器建立连接-connect" aria-hidden="true">#</a> 与服务器建立连接 connect</h3><p><code>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code> 函数用于建立与远程服务器的连接。它通常用于 TCP 客户端，将客户端与服务器建立连接。</p><ul><li><code>sockfd</code>：套接字描述符，由 <code>socket</code> 函数创建。</li><li><code>addr</code>：指向要连接的目标地址的 <code>sockaddr</code> 结构体的指针。</li><li><code>addrlen</code>：<code>addr</code> 结构体的长度。</li><li><code>return</code><ul><li>成功：0。</li><li>失败：-1，并设置全局变量 <code>errno</code> 以指示错误类型。</li></ul></li></ul><h3 id="收发数据" tabindex="-1"><a class="header-anchor" href="#收发数据" aria-hidden="true">#</a> 收发数据</h3><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ssize_t recv(int sockfd, void *buf, size_t len, int flags);</code> 用于从套接字接收数据。可以在已连接的套接字上使用（通过 <code>connect</code> 或 <code>accept</code> 建立连接）。常用于流式套接字（如 SOCK_STREAM）。</p><ul><li><code>sockfd</code> 套接字描述符。</li><li><code>buf</code> 接收数据的缓冲区。</li><li><code>len</code> 缓冲区长度。</li><li><code>flags</code> 控制接收操作的行为，通常设置为 0。</li><li><code>return</code> 返回接收到的字节数，如果出现错误返回 -1。如果对端关闭连接，返回 0。</li></ul><p><code>ssize_t send(int sockfd, const void *buf, size_t len, int flags);</code> 用于向套接字发送数据。可以在已连接的套接字上使用。常用于流式套接字。</p><ul><li><code>sockfd</code>：套接字描述符。</li><li><code>buf</code>：要发送的数据的缓冲区。</li><li><code>len</code>：要发送的数据的长度。</li><li><code>flags</code>：控制发送操作的行为，通常设置为 0。</li><li><code>return</code> 返回发送的字节数，如果出现错误返回 -1。</li></ul><p><code>ssize_t sendto(int sockfd, const void *buf, size_t len, int flags, const struct sockaddr *dest_addr, socklen_t addrlen);</code> 用于向指定目标地址发送数据。可以在无连接的套接字上使用（例如 UDP 套接字）。常用于数据报套接字（如 SOCK_DGRAM）。</p><ul><li><code>sockfd</code>：套接字描述符。</li><li><code>buf</code>：要发送的数据的缓冲区。</li><li><code>len</code>：要发送的数据的长度。</li><li><code>flags</code>：控制发送操作的行为，通常设置为 0。</li><li><code>dest_addr</code>：目标地址结构体的指针。</li><li><code>addrlen</code>：目标地址结构体的长度。</li><li><code>return</code> 返回发送的字节数，如果出现错误返回 -1。</li></ul><p><code>ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags, struct sockaddr *src_addr, socklen_t *addrlen);</code> 用于从指定的套接字接收数据，并同时获取发送方的地址信息。这个函数通常用于UDP套接字编程中。</p><ul><li><code>sockfd</code>：指定接收数据的套接字文件描述符。</li><li><code>buf</code>：指向存储接收数据的缓冲区的指针。</li><li><code>len</code>：缓冲区的大小，即要接收的最大字节数。</li><li><code>flags</code>：标志位，通常设置为0。</li><li><code>src_addr</code>：用于存储发送方地址信息的 sockaddr 结构体的指针。</li><li><code>addrlen</code>：<code>src_addr</code> 结构体的长度，在调用时指定为地址结构体的大小。</li><li><code>return</code><ul><li>返回实际接收的字节数，</li><li>如果出错则返回-1，并设置相应的 errno。</li></ul></li></ul><p><code>ssize_t read(int fd, void *buf, size_t count);</code> 用于从文件描述符读取数据，包括套接字描述符。可以用于任何打开的文件描述符，不仅限于套接字。</p><ul><li><code>fd</code>：文件描述符，可以是套接字描述符。</li><li><code>buf</code>：接收数据的缓冲区。</li><li><code>count</code>：缓冲区长度。</li><li><code>return</code> 返回读取的字节数，如果出现错误返回 -1。如果读到文件末尾（对套接字来说是对端关闭连接），返回 0。</li></ul><p><code>ssize_t write(int fd, const void *buf, size_t count);</code> 用于向文件描述符写入数据，包括套接字描述符。可以用于任何打开的文件描述符，不仅限于套接字。</p><ul><li><code>fd</code>：文件描述符，可以是套接字描述符。</li><li><code>buf</code>：要发送的数据的缓冲区。</li><li><code>count</code>：要发送的数据的长度。</li><li><code>return</code> 返回写入的字节数，如果出现错误返回 -1。</li></ul><h3 id="简单-tcp-服务器-客户端实例" tabindex="-1"><a class="header-anchor" href="#简单-tcp-服务器-客户端实例" aria-hidden="true">#</a> 简单 TCP 服务器&amp;客户端实例</h3><p>服务端</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_LISTEN</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">int</span> clients<span class="token punctuation">[</span>MAX_LISTEN<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">char</span> recv_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> recv_len<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 接收信息</span>
		<span class="token comment">//recv_buf[0] = &#39;\0&#39;;</span>
		recv_len  <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>recv_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>recv_len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;recv error , reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">close</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>recv_len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %d was closed !\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">close</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//recv_buf[recv_len] = &#39;\0&#39;;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;client %d : %s\n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 100ms</span>
		<span class="token keyword">char</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;Server replied : &quot;</span><span class="token punctuation">;</span>
		<span class="token function">strcat</span><span class="token punctuation">(</span>send_buf<span class="token operator">+</span><span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">,</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">send</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>send_buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	<span class="token comment">// 创建套接字</span>
	<span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create socket failed, reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 指定监听地址</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>
	server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 绑定地址到套接字</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;bind error, reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 监听请求</span>
	err <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>MAX_LISTEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;listen error, reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span> recv_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token class-name">pthread_t</span> tids<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 接收来自客户端的请求</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;accept error , reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tids<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>thread_func<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> MAX_LISTEN<span class="token punctuation">)</span><span class="token punctuation">{</span>
			i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>客户端</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
	sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;create socket failed, reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>
	server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;convert failed , reasion : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;this&#39;s a invalid address \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;connect to server error, reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span> send_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Input your message : \n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		send_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>
		<span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> send_bytes <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>send_buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>send_bytes <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;send data failed , reason : %s\n&quot;</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
		<span class="token keyword">char</span> recv_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	    <span class="token keyword">int</span> recv_len<span class="token punctuation">;</span>
		recv_len  <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>recv_buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>recv_len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="嵌入式linux网络编程基础" tabindex="-1"><a class="header-anchor" href="#嵌入式linux网络编程基础" aria-hidden="true">#</a> 嵌入式Linux网络编程基础</h2><img src="/my-vuepress-blog/assets/image-20240127045428997-bbbb6b76.png" alt="image-20240127045428997" style="zoom:50%;"><blockquote><p>客户端程序 ==&gt; 客户端内核 ==&gt; 客户端以太网驱动 ==&gt; 服务器以太网驱动 ==&gt; 服务器内核 ==&gt; 服务端程序</p><p>客户端程序 &lt;== 客户端内核 &lt;== 客户端以太网驱动 &lt;== 服务器以太网驱动 &lt;== 服务器内核 &lt;== 服务端程序</p></blockquote><img src="/my-vuepress-blog/assets/image-20240127045716148-938f7353.png" alt="image-20240127045716148" style="zoom:50%;"><blockquote><p>服务器返回的结果可能和发送请求的线路是不一样的</p><p>TCP协议栈允许在广域网上面，发出去的包和收回来的包在不同的路径，路由器主要的作用是寻找最短路径，当然每个路由器的优化方法、协议可能不一样，最终的路径也不一样</p></blockquote><h3 id="wireshark" tabindex="-1"><a class="header-anchor" href="#wireshark" aria-hidden="true">#</a> Wireshark</h3><p>Wireshark 是一个网络封包分析软件，它可以网卡捕获网络数据包，并提供丰富的过滤功能，以便用户对捕获的数据包进行筛选和分析。以下是一些 Wireshark 中常用的过滤属性：</p><ol><li><strong>ip.addr</strong>：根据 IP 地址过滤数据包，可以指定源 IP 地址、目标 IP 地址，或者同时指定源和目标 IP 地址。</li><li><strong>tcp.port</strong>：根据 TCP 端口过滤数据包，可以指定源端口、目标端口，或者同时指定源和目标端口。</li><li><strong>udp.port</strong>：根据 UDP 端口过滤数据包，使用方法同上。</li><li><strong>http</strong>：过滤 HTTP 协议的数据包。</li><li><strong>dns</strong>：过滤 DNS 协议的数据包。</li><li><strong>icmp</strong>：过滤 ICMP 协议的数据包。</li><li><strong>tcp.flags</strong>：根据 TCP 标志位过滤数据包，可以指定 SYN、ACK、FIN、RST 等标志。</li><li><strong>tcp.analysis.retransmission</strong>：过滤 TCP 重传数据包。</li><li><strong>tcp.analysis.ack_rtt</strong>：过滤 TCP 确认应答时间大于预设值的数据包。</li><li><strong>frame.number</strong>：根据数据包的序号过滤数据包。</li><li><strong>eth.addr</strong>：以太网地址（MAC 地址）过滤数据包。</li><li><strong>frame.len</strong>：根据数据包的长度过滤数据包。</li><li><strong>ip.proto</strong>：根据 IP 协议类型（如 TCP、UDP、ICMP）过滤数据包。</li><li><strong>ip.src</strong> 和 <strong>ip.dst</strong>：分别根据源 IP 地址和目标 IP 地址过滤数据包。</li><li><strong>tcp.analysis.flags</strong>：根据 TCP 协议的标志位（如 SYN、ACK、FIN、RST）过滤数据包。</li><li><strong>tcp.window_size</strong>：根据 TCP 窗口大小过滤数据包。</li><li><strong>http.request.method</strong> 和 <strong>http.response.code</strong>：根据 HTTP 请求方法和响应状态码过滤数据包。</li><li><strong>dns.qry.name</strong> 和 <strong>dns.resp.name</strong>：分别根据 DNS 查询名称和响应名称过滤数据包。</li><li><strong>udp.srcport</strong> 和 <strong>udp.dstport</strong>：分别根据 UDP 源端口和目标端口过滤数据包。</li><li><strong>icmp.type</strong> 和 <strong>icmp.code</strong>：分别根据 ICMP 报文类型和代码过滤数据包。</li></ol><h3 id="传输层tcp和udp" tabindex="-1"><a class="header-anchor" href="#传输层tcp和udp" aria-hidden="true">#</a> 传输层TCP和UDP</h3><h4 id="osi七层模型和tcp-ip协议族" tabindex="-1"><a class="header-anchor" href="#osi七层模型和tcp-ip协议族" aria-hidden="true">#</a> OSI七层模型和TCP/IP协议族</h4><p><img src="/my-vuepress-blog/assets/image-20240127054644430-2cdd00f9.png" alt="image-20240127054644430"></p><p>OSI（Open Systems Interconnection）七层模型和 TCP/IP 协议族是两种不同的网络通信模型和协议族，它们有一些区别：</p><ol><li><strong>OSI 七层模型</strong>： <ul><li>OSI 模型是由国际标准化组织（ISO）制定的一个通信协议的参考模型。</li><li>OSI 模型将网络通信划分为七个层次，每个层次负责特定的功能，层次间有明确的界限和接口。这些层次分别是物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。</li><li>OSI 模型提供了一个理论框架，用于设计和实现网络协议，但实际上并没有广泛应用于现实世界的网络通信中。</li></ul></li><li><strong>TCP/IP 协议族</strong>： <ul><li>TCP/IP 协议族是实际应用中最广泛使用的一组网络协议，包括了 TCP（Transmission Control Protocol）和 IP（Internet Protocol）等多个协议。</li><li>TCP/IP 协议族并不严格遵循 OSI 七层模型，它通常被划分为四个层次，分别是网络接口层（或数据链路层）、网络层、传输层和应用层。</li><li>TCP/IP 协议族是互联网的基础，几乎所有现代网络都采用 TCP/IP 协议。</li></ul></li></ol><p>主要的区别在于 OSI 模型是一个理论上的参考模型，而 TCP/IP 协议族是一组实际应用中广泛使用的网络协议。OSI 模型提供了更为细致的分层结构，使得设计和实现网络协议更加灵活和规范化，但由于其较为复杂，未能在实际应用中得到广泛采用。而 TCP/IP 协议族则是实际网络通信中最常用的协议族，它简洁高效，适用于各种网络环境，并成为了互联网的基石。</p><p>以下是 OSI 七层模型和 TCP/IP 协议族中各层次之间的对应关系：</p><ol><li><strong>物理层（Physical Layer）</strong>： <ul><li>OSI 模型：物理层负责传输比特流，控制物理链路的传输特性，如电压、频率等。</li><li>TCP/IP 协议族：网络接口层（或数据链路层）对应于 OSI 模型的物理层和数据链路层，负责实现数据在物理媒介上的传输。</li></ul></li><li><strong>数据链路层（Data Link Layer）</strong>： <ul><li>OSI 模型：数据链路层负责进行透明传输，检错和纠错，以及进行流量控制等。</li><li>TCP/IP 协议族：网络接口层（或数据链路层）对应于 OSI 模型的物理层和数据链路层，负责实现数据在物理媒介上的传输。</li></ul></li><li><strong>网络层（Network Layer）</strong>： <ul><li>OSI 模型：网络层负责实现路由选择、数据包转发和路径选择等功能。</li><li>TCP/IP 协议族：网络层对应于 OSI 模型的网络层，负责实现 IP 协议，处理数据包的路由选择和转发。</li></ul></li><li><strong>传输层（Transport Layer）</strong>： <ul><li>OSI 模型：传输层负责可靠的端到端通信，提供数据传输的错误检测和纠正机制，以及流量控制和拥塞控制等功能。</li><li>TCP/IP 协议族：传输层对应于 OSI 模型的传输层，负责实现 TCP 和 UDP 协议，提供端到端的可靠数据传输服务。</li></ul></li><li><strong>会话层（Session Layer）</strong>： <ul><li>OSI 模型：会话层负责建立、管理和终止会话连接，提供数据同步和检查点等功能。</li><li>TCP/IP 协议族：TCP/IP 协议族没有明确对应于 OSI 模型的会话层，这些功能通常由应用层自行处理。</li></ul></li><li><strong>表示层（Presentation Layer）</strong>： <ul><li>OSI 模型：表示层负责数据格式的转换和编码、解码，以及数据压缩和加密等功能。</li><li>TCP/IP 协议族：TCP/IP 协议族没有明确对应于 OSI 模型的表示层，这些功能通常由应用层自行处理。</li></ul></li><li><strong>应用层（Application Layer）</strong>： <ul><li>OSI 模型：应用层提供用户接口，支持用户应用程序的各种服务和功能，如电子邮件、文件传输、远程登录等。</li><li>TCP/IP 协议族：应用层对应于 OSI 模型的应用层，提供各种应用服务和协议，如 HTTP、FTP、SMTP 等。</li></ul></li></ol><p><strong>用户数据报协议 UDP</strong>（User Datagram Protocol）：</p><ul><li><strong>UDP 在传送数据之前不需要先建立连接</strong>，远程主机在收到 UDP 报文后，不需要给出任何确认。</li><li>虽然 UDP <strong>不提供可靠交付</strong>，但在某些情况下 UDP 确是一种最有效的工作方式（一般用于即时通信），比如： QQ 语音、 QQ 视频 、直播等等</li></ul><p><strong>传输控制协议 TCP</strong>（Transmission Control Protocol）：</p><ul><li>TCP 提供<strong>面向连接</strong>的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。</li><li>TCP 不提供广播或多播服务。由于 TCP 要提供<strong>可靠</strong>的，面向连接的传输服务（TCP的可靠体现在TCP在传递数据之前，会有三次握手来建立连接，而且在数据传递时，有确认、窗口、重传、流量控制、拥塞控制机制，在数据传完后，还会四次挥手断开连接用来节约系统资源），这不仅使协议数据单元的首部增大很多，还要占用许多处理机资源。</li><li>TCP <strong>一般用于文件传输、发送和接收邮件、远程登录等场景</strong>。</li></ul><h3 id="tcp编程模型" tabindex="-1"><a class="header-anchor" href="#tcp编程模型" aria-hidden="true">#</a> TCP编程模型</h3><h4 id="客户端" tabindex="-1"><a class="header-anchor" href="#客户端" aria-hidden="true">#</a> 客户端</h4><img src="/my-vuepress-blog/assets/image-20240127055035588-c6ace711.png" alt="image-20240127055035588" style="zoom:50%;"><h4 id="服务端" tabindex="-1"><a class="header-anchor" href="#服务端" aria-hidden="true">#</a> 服务端</h4><img src="/my-vuepress-blog/assets/image-20240127055328052-3728e3f1.png" alt="image-20240127055328052" style="zoom:50%;"><h3 id="tcp-三次握手和四次挥手" tabindex="-1"><a class="header-anchor" href="#tcp-三次握手和四次挥手" aria-hidden="true">#</a> TCP 三次握手和四次挥手</h3><h4 id="tcp-报文段首部格式" tabindex="-1"><a class="header-anchor" href="#tcp-报文段首部格式" aria-hidden="true">#</a> TCP 报文段首部格式</h4><p>TCP 报文段的具体格式大家可以不必都记住，但是其中的几个<strong>控制位</strong>与我们接下来要讲的三次握手和四次挥手息息相关，大家一定要牢记。</p><p><img src="/my-vuepress-blog/assets/1460000039165596-796199f9.webp" alt="1460000039165596"></p><p>首部固定部分各字段意义如下：</p><p>**Source Port (16 bits) **</p><ul><li><p><strong>源端口和目的端口</strong>：各占 2 个字节，分别写入源端口和目的端口。IP 地址 + 端口号就可以确定一个进程地址</p></li><li><p><strong>序号/序列号（Sequense Number，SN）</strong>：在一个 TCP 连接中传送的字节流中的每一个字节都按顺序编号。该字段表示本报文段所发送的数据的第一个字节的序号。</p><ul><li><p>初始序号称为 Init Sequense Number, ISN（序号/序列号这个字段很重要，大家留个印象，下文会详细讲解）</p></li><li><p>例如，一报文段的序号是 101，共有 100 字节的数据。这就表明：本报文段的数据的第一个字节的序号是 101，最后一个字节的序号是 200。显然，下一个报文段的数据序号应当从 201 开始，即下一个报文段的序号字段值应为 201。</p></li></ul></li><li><p><strong>确认号 ack</strong>：期望收到对方下一个报文段的第一个数据字节的序号。若确认号为 N，则表明：到序号 N-1 为止的所有数据都已正确收到。</p></li><li><p><strong>数据偏移</strong>（首部长度）：它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。这个字段实际上是指出TCP报文段的首部长度。</p></li><li><p><strong>保留</strong>：占 6 位，应置为 0，保留为今后使用。</p></li><li><p><strong>紧急位 URG</strong>：当 URG = 1 时，表明此报文段中有紧急数据，是高优先级的数据，应尽快发送，不用在缓存中排队。该控制位需配合紧急指针使用（紧急指针指出本报文段中紧急数据的字节数）</p><ul><li>举个例子：我们需要取消一个已经发送了很长程序的运行，因此用户从键盘发出中断命令。如果不使用紧急数据，那么这个指令将存储在接收 TCP 的缓存末尾，只有在所有的数据被处理完毕后这两个字符才被交付接收方的应用进程，这样做就无法实现立即中断。</li></ul></li><li><p><strong>确认 ACK</strong>：仅当 ACK = 1 时确认号字段才有效，当 ACK = 0 时确认号无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置为 1。</p></li><li><p><strong>推送 PSH</strong>：当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应。在这种情况下，TCP 就可以使用推送（push）操作。这时，发送方 TCP 把 PSH 置为 1，并立即创建一个报文段发送出去。接收方 TCP 收到 PSH = 1 的报文段，就尽快地交付接收应用进程。而不用等到整个缓存都填满了后再向上交付。</p></li><li><p><strong>复位 RST</strong>：当 RST = 1 时，表明 TCP 连接中出现了严重错误（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立传输连接。</p></li><li><p><strong>同步 SYN</strong>：SYN = 1 表示这是一个连接请求或连接接受报文。</p><ul><li>当 SYN = 1 而 ACK = 0 时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使 SYN = 1 且 ACK = 1。</li></ul></li><li><p><strong>终止 FIN</strong>：用来释放一个连接。当 FIN = 1时，表明此报文段的发送发的数据已发送完毕，并要求释放运输连接。</p></li><li><p><strong>Window Size (16 bits):</strong> 窗口大小，指发送方期望从接收方接收的数据量。</p></li><li><p><strong>Checksum (16 bits):</strong> 校验和，用于检测头部和数据的错误。</p></li><li><p><strong>Urgent Pointer (16 bits):</strong> 紧急指针，用于指示紧急数据的位置。</p></li><li><p><strong>Options (variable):</strong> 可选项，用于包含各种 TCP 选项。</p></li><li><p><strong>Padding (variable):</strong> 填充字段，用于使 TCP 头部长度是 32 位的整数倍。</p></li><li><p><strong>Data (variable):</strong> 数据字段，包含 TCP 报文的有效数据。</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code> <span class="token number">0</span>      <span class="token number">7</span> <span class="token number">8</span>     <span class="token number">15</span> <span class="token number">16</span>    <span class="token number">23</span> <span class="token number">24</span>    <span class="token number">31</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>     Source Port      <span class="token operator">|</span> Destination Port <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>            Sequence Number            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>        Acknowledgment Number          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>  Data  <span class="token operator">|</span>  Rese<span class="token operator">-</span> <span class="token operator">|</span>U<span class="token operator">|</span>A<span class="token operator">|</span>P<span class="token operator">|</span>R<span class="token operator">|</span>S<span class="token operator">|</span>F<span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Offset <span class="token operator">|</span> rved   <span class="token operator">|</span>R<span class="token operator">|</span>C<span class="token operator">|</span>S<span class="token operator">|</span>S<span class="token operator">|</span>Y<span class="token operator">|</span>I<span class="token operator">|</span>    Window Size
<span class="token operator">|</span>        <span class="token operator">|</span>        <span class="token operator">|</span>G<span class="token operator">|</span>K<span class="token operator">|</span>H<span class="token operator">|</span>T<span class="token operator">|</span>N<span class="token operator">|</span>N<span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">|</span>        <span class="token operator">|</span>        <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span>T<span class="token operator">|</span>N<span class="token operator">|</span> <span class="token operator">|</span>N<span class="token operator">|</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>    Checksum       <span class="token operator">|</span>  Urgent Pointer <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>  Options          <span class="token operator">|</span> Padding   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>                             data                                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，各字段含义如下：</p><ul><li><p><strong>Source Port (16 bits):</strong> 源端口，指发送端的端口号。</p></li><li><p><strong>Destination Port (16 bits):</strong> 目的端口，指接收端的端口号。</p></li><li><p><strong>Sequence Number (32 bits):</strong> 序列号，用于标识从发送方到接收方的每个字节的数据。</p></li><li><p><strong>Acknowledgment Number (32 bits):</strong> 确认号，表示接收方期望下一个接收的字节的序列号。</p></li><li><p><strong>Data Offset (4 bits):</strong> 数据偏移，指示 TCP 头部中的数据的起始位置。</p></li><li><p><strong>Reserved (3 bits):</strong> 保留字段，未使用，应为 0。</p></li><li><p>Flags (9 bits):</p><p>标志位，包括：</p><ul><li>URG (1 bit): 紧急指针（Urgent Pointer）是否有效。</li><li>ACK (1 bit): 确认序号字段是否有效。</li><li>PSH (1 bit): 接收端是否应该尽快将此数据推送给应用程序。</li><li>RST (1 bit): 重置连接。</li><li>SYN (1 bit): 发起一个新连接。</li><li>FIN (1 bit): 断开连接。</li></ul></li><li><p><strong>Window Size (16 bits):</strong> 窗口大小，指发送方期望从接收方接收的数据量。</p></li><li><p><strong>Checksum (16 bits):</strong> 校验和，用于检测头部和数据的错误。</p></li><li><p><strong>Urgent Pointer (16 bits):</strong> 紧急指针，用于指示紧急数据的位置。</p></li><li><p><strong>Options (variable):</strong> 可选项，用于包含各种 TCP 选项。</p></li><li><p><strong>Padding (variable):</strong> 填充字段，用于使 TCP 头部长度是 32 位的整数倍。</p></li><li><p><strong>Data (variable):</strong> 数据字段，包含 TCP 报文的有效数据。</p></li></ul><h4 id="tcp-三次握手建立连接" tabindex="-1"><a class="header-anchor" href="#tcp-三次握手建立连接" aria-hidden="true">#</a> TCP 三次握手建立连接</h4><h4 id="三次握手过程详解" tabindex="-1"><a class="header-anchor" href="#三次握手过程详解" aria-hidden="true">#</a> 三次握手过程详解</h4><p>三次握手的原文是 <code>three-way handshake</code>，整个名词的可以翻译为：<strong>需要三个步骤才能建立握手/连接的机制</strong>。当然，三次握手也可以叫 <code>three-message handshake</code>，通过三条消息来建立的握手/连接。</p><p>进行三次握手的主要作用就是为了确认双方的接收能力和发送能力是否正常、指定自己的 <strong>初始化序列号(Init Sequense Number, <code>ISN</code>)</strong> 为后面的可靠性传输做准备。</p><p>三次握手过程如下图：</p><img src="/my-vuepress-blog/assets/view-ac949302.webp" alt="view" style="zoom:50%;"><p>回顾一下图中字符的含义：</p><ul><li><code>SYN</code>：连接请求/接收 报文段</li><li><code>seq</code>：发送的第一个字节的序号</li><li><code>ACK</code>：确认报文段</li><li><code>ack</code>：确认号。希望收到的下一个数据的第一个字节的序号</li></ul><p><strong>刚开始客户端处于 <code>Closed</code> 的状态，而服务端处于 <code>Listen</code> 状态</strong>：</p><blockquote><p><code>CLOSED</code>： 没有任何连接状态</p><p><code>LISTEN </code>：侦听来自远方 TCP 端口的连接请求</p></blockquote><p><strong>第一次握手</strong>：客户端向服务端发送一个 SYN 报文（SYN = 1），并指明客户端的初始化序列号 ISN(x)，即图中的 seq = x，表示本报文段所发送的数据的第一个字节的序号。此时客户端处于 <code>SYN_SENd</code> 状态。</p><blockquote><p><code>SYN-SENT</code> ：在发送连接请求后等待匹配的连接请求</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127214443122-4ccdcdb7.png" alt="image-20240127214443122"></p><p><strong>第二次握手</strong>：服务器收到客户端的 SYN 报文之后，会发送 SYN 报文作为应答（SYN = 1），并且指定自己的初始化序列号 ISN(y)，即图中的 seq = y。同时会把客户端的 ISN + 1 作为确认号 ack 的值，表示已经收到了客户端发来的的 SYN 报文，希望收到的下一个数据的第一个字节的序号是 x + 1，此时服务器处于 <code>SYN_REVD</code> 的状态。</p><blockquote><p><code>SYN-RECEIVED</code>：在收到和发送一个连接请求后等待对连接请求的确认</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127214822925-232f0dcc.png" alt="image-20240127214822925"></p><p><strong>第三次握手</strong>：客户端收到服务器端响应的 SYN 报文之后，会发送一个 ACK 报文，也是一样把服务器的 ISN + 1 作为 ack 的值，表示已经收到了服务端发来的的 SYN 报文，希望收到的下一个数据的第一个字节的序号是 y + 1，并指明此时客户端的序列号 seq = x + 1（初始为 seq = x，所以第二个报文段要 +1），此时客户端处于 <code>Establised</code> 状态。</p><p>服务器收到 ACK 报文之后，也处于 <code>Establised 状态</code>，至此，双方建立起了 TCP 连接。</p><blockquote><p><code>ESTABLISHED</code>：代表一个打开的连接，数据可以传送给用户</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127215025353-102d14ad.png" alt="image-20240127215025353"></p><h4 id="什么要三次握手" tabindex="-1"><a class="header-anchor" href="#什么要三次握手" aria-hidden="true">#</a> 什么要三次握手</h4><p>三次握手的目的是建立可靠的通信信道，说到通讯，简单来说就是数据的发送与接收，而三次握手最主要的目的就是<strong>双方确认自己与对方的发送与接收是正常的</strong>。</p><p>只有经过三次握手才能确认双发的收发功能都正常，缺一不可：</p><ul><li><p>第一次握手（客户端发送 SYN 报文给服务器，服务器接收该报文）：客户端什么都不能确认；服务器确认了对方发送正常，自己接收正常</p></li><li><p>第二次握手（服务器响应 SYN 报文给客户端，客户端接收该报文）：</p><p>客户端确认了：自己发送、接收正常，对方发送、接收正常；</p><p>服务器确认了：对方发送正常，自己接收正常</p></li><li><p>第三次握手（客户端发送 ACK 报文给服务器）：</p><p>客户端确认了：自己发送、接收正常，对方发送、接收正常；</p><p>服务器确认了：自己发送、接收正常，对方发送、接收正常</p></li></ul><h4 id="isn-initial-sequence-number-是固定的吗" tabindex="-1"><a class="header-anchor" href="#isn-initial-sequence-number-是固定的吗" aria-hidden="true">#</a> ISN (Initial Sequence Number) 是固定的吗</h4><p><strong>三次握手的其中一个重要功能是客户端和服务端交换 ISN(Initial Sequence Number)，以便让对方知道接下来接收数据的时候如何按序列号组装数据</strong>。</p><p>当一端为建立连接而发送它的 SYN 时，它会为连接选择一个初始序号。ISN 随时间而变化，因此每个连接都将具有不同的 ISN。<strong>如果 ISN 是固定的，攻击者很容易猜出后续的确认号，因此 ISN 是动态生成的</strong>。</p><h4 id="三次握手过程中可以携带数据吗" tabindex="-1"><a class="header-anchor" href="#三次握手过程中可以携带数据吗" aria-hidden="true">#</a> 三次握手过程中可以携带数据吗</h4><p>第三次握手的时候，是可以携带数据的。但是，<strong>第一次、第二次握手绝对不可以携带数据</strong></p><p>假如第一次握手可以携带数据的话，如果有人要恶意攻击服务器，那他每次都在第一次握手中的 SYN 报文中放入大量的数据，然后疯狂重复发 SYN 报文的话（因为攻击者根本就不用管服务器的接收、发送能力是否正常，它就是要攻击你），这会让服务器花费很多时间、内存空间来接收这些报文。</p><p>⭐ <strong>简单的记忆就是，请求连接/接收 即 <code>SYN = 1</code> 的时候不能携带数据</strong></p><p>而对于第三次的话，此时客户端已经处于 <code>ESTABLISHED</code> 状态。对于客户端来说，他已经建立起连接了，并且也已经知道服务器的接收、发送能力是正常的了，所以当然能正常发送/携带数据了。</p><h4 id="半连接队列" tabindex="-1"><a class="header-anchor" href="#半连接队列" aria-hidden="true">#</a> 半连接队列</h4><p>服务器第一次收到客户端的 SYN 之后，就会处于 <code>SYN_RCVD</code> 状态，此时双方还没有完全建立其连接，服务器会把这种状态下的请求连接放在一个队列里，我们把这种队列称之为<strong>半连接队列</strong>。</p><p>当然还有一个<strong>全连接队列</strong>，完成三次握手后建立起的连接就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。</p><h4 id="syn-洪泛攻击" tabindex="-1"><a class="header-anchor" href="#syn-洪泛攻击" aria-hidden="true">#</a> SYN 洪泛攻击</h4><p>SYN 攻击就是 <strong>Client 在短时间内伪造大量不存在的 IP 地址，并向 Server 不断地发送 SYN 包</strong>，Server 则回复确认包，并等待 Client 确认，由于源地址不存在，因此 Server 需要不断重发直至超时，这些伪造的 SYN 包将长时间占用半连接队列，导致正常的 SYN 请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。</p><h4 id="如果第三次握手丢失了-客户端服务端会如何处理" tabindex="-1"><a class="header-anchor" href="#如果第三次握手丢失了-客户端服务端会如何处理" aria-hidden="true">#</a> 如果第三次握手丢失了，客户端服务端会如何处理</h4><p>服务器发送完 SYN-ACK 包，如果未收到客户端响应的确认包，也即第三次握手丢失。那么服务器就会进行首次重传，若等待一段时间仍未收到客户确认包，就进行第二次重传。如果重传次数超过系统规定的最大重传次数，则系统将该连接信息从半连接队列中删除。</p><p>注意，每次重传等待的时间不一定相同，一般会是指数增长，例如间隔时间为 1s，2s，4s，8s…</p><h4 id="tcp-四次挥手释放连接" tabindex="-1"><a class="header-anchor" href="#tcp-四次挥手释放连接" aria-hidden="true">#</a> TCP 四次挥手释放连接</h4><p>建立一个 TCP 连接需要三次握手，而终止一个 TCP 连接要经过四次挥手（也有将四次挥手叫做四次握手的）。这是由于 TCP 的<strong>半关闭</strong>（half-close）特性造成的，即TCP 提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。</p><p>TCP 连接的释放需要发送四个包（执行四个步骤），因此称为四次挥手(<code>Four-way handshake</code>)，<strong>客户端或服务端均可主动发起挥手动作</strong>。</p><img src="/my-vuepress-blog/assets/view-1-155426dd.webp" alt="view-1" style="zoom:50%;"><p>回顾一下上图中符号的意思：</p><ul><li><code>FIN</code> ：连接终止位</li><li><code>seq</code>：发送的第一个字节的序号</li><li><code>ACK</code>：确认报文段</li><li><code>ack</code>：确认号。希望收到的下一个数据的第一个字节的序号</li></ul><blockquote><p>由于本次下面抓包是由服务端主动关闭连接，所以暂且先将它们的角色交换，实际上无论客户端和服务端关闭，流程、协议都是一样的</p></blockquote><p>刚开始双方都处于<code>ESTABLISHED</code> 状态，假设是客户端先发起关闭请求。四次挥手的过程如下：</p><p><strong>第一次挥手</strong>：客户端发送一个 FIN 报文（请求连接终止：FIN = 1），报文中会指定一个序列号 seq = u。并<strong>停止再发送数据，主动关闭 TCP 连接</strong>。此时客户端处于 <code>FIN_WAIT1</code> 状态，等待服务端的确认。</p><blockquote><p><code>FIN-WAIT-1</code> - 等待远程TCP的连接中断请求，或先前的连接中断请求的确认；</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127221219902-b100c671.png" alt="image-20240127221219902"></p><p><strong>第二次挥手</strong>：服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了，此时服务端处于 <code>CLOSE_WAIT</code> 状态。</p><blockquote><p><code>CLOSE-WAIT</code> - 等待从本地用户发来的连接中断请求；</p></blockquote><p><strong>此时的 TCP 处于半关闭状态，客户端到服务端的连接释放</strong>。客户端收到服务端的确认后，进入<code>FIN_WAIT2</code>（终止等待 2）状态，等待服务端发出的连接释放报文段。</p><blockquote><p><code>FIN-WAIT-2</code> - 从远程TCP等待连接中断请求；</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127221606111-5e75267c.png" alt="image-20240127221606111"></p><p><strong>第三次挥手</strong>：如果服务端也想断开连接了（没有要向客户端发出的数据），和客户端的第一次挥手一样，发送 FIN 报文，且指定一个序列号。此时服务端处于 <code>LAST_ACK</code> 的状态，等待客户端的确认。</p><blockquote><p><code>LAST-ACK</code> - 等待原来发向远程TCP的连接中断请求的确认；</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127222804624-6596048d.png" alt="image-20240127222804624"></p><p><strong>第四次挥手</strong>：客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答（ack = w+1），且把服务端的序列值 +1 作为自己 ACK 报文的序号值（seq=u+1），此时客户端处于 <strong><code>TIME_WAIT</code> （时间等待）状态</strong>。</p><blockquote><p><code>TIME-WAIT</code> - 等待足够的时间以确保远程TCP接收到连接中断请求的确认；</p></blockquote><p><img src="/my-vuepress-blog/assets/image-20240127222901954-d654986b.png" alt="image-20240127222901954"></p><p>🚨 注意 ！！！这个时候由服务端到客户端的 TCP 连接并未释放掉，<strong>需要经过时间等待计时器设置的时间 2MSL（一个报文的来回时间） 后才会进入 <code>CLOSED</code> 状态</strong>（这样做的目的是确保服务端收到自己的 ACK 报文。如果服务端在规定时间内没有收到客户端发来的 ACK 报文的话，服务端会重新发送 FIN 报文给客户端，客户端再次收到 FIN 报文之后，就知道之前的 ACK 报文丢失了，然后再次发送 ACK 报文给服务端）。服务端收到 ACK 报文之后，就关闭连接了，处于 <code>CLOSED</code> 状态。</p><h4 id="为什么要四次挥手" tabindex="-1"><a class="header-anchor" href="#为什么要四次挥手" aria-hidden="true">#</a> 为什么要四次挥手</h4><p>由于 TCP 的<strong>半关闭</strong>（half-close）特性，TCP 提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。</p><p>任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入<strong>半关闭状态</strong>。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就<strong>完全关闭</strong>了TCP连接。</p><p><strong>通俗的来说，两次握手就可以释放一端到另一端的 TCP 连接，完全释放连接一共需要四次握手</strong>。</p><p>举个例子：A 和 B 打电话，通话即将结束后，A 说 “我没啥要说的了”，B 回答 “我知道了”，于是 A 向 B 的连接释放了。但是 B 可能还会有要说的话，于是 B 可能又巴拉巴拉说了一通，最后 B 说“我说完了”，A 回答“知道了”，于是 B 向 A 的连接释放了，这样整个通话就结束了。</p><blockquote><p>半关闭状态是，用户不能调用tcp fd进行write操作了，但是tcp write buff中的数据还得发送给对方、这个流程和正常传输是一样的。</p><p>FIN状态位表示：“发送后，当前客户端仍然会接收服务器的数据，但是不会接收他本地服务的数据（应用层的数据）”，所以客户端在发送fin后仍然能发送ack是不矛盾的，因为ack不是本地服务的数据，是放在tcp头部的，而不是body中</p></blockquote><h3 id="socket-io-多路复用" tabindex="-1"><a class="header-anchor" href="#socket-io-多路复用" aria-hidden="true">#</a> Socket IO 多路复用</h3><h4 id="select" tabindex="-1"><a class="header-anchor" href="#select" aria-hidden="true">#</a> select</h4><p>select 实现多路复用的方式是，将已连接的 Socket 都放到一个<strong>文件描述符集合</strong>，然后调用 select 函数将文件描述符集合<strong>拷贝</strong>到内核里，让内核来检查是否有网络事件产生，检查的方式很粗暴，就是通过<strong>遍历</strong>文件描述符集合的方式，当检查到有事件产生后，将此 Socket 标记为可读或可写， 接着再把整个文件描述符集合<strong>拷贝</strong>回用户态里，然后用户态还需要再通过<strong>遍历</strong>的方法找到可读或可写的 Socket，然后再对其处理。</p><p>所以，对于 select 这种方式，需要进行 <strong>2 次「遍历」文件描述符集合</strong>，一次是在内核态里，一个次是在用户态里 ，而且还会发生 <strong>2 次「拷贝」文件描述符集合</strong>，先从用户空间传入内核空间，由内核修改后，再传出到用户空间中。</p><p>select 使用固定长度的 BitsMap，表示文件描述符集合，而且所支持的文件描述符的个数是有限制的，在 Linux 系统中，由内核中的 FD_SETSIZE 限制， 默认最大值为 <code>1024</code>，只能监听 0~1023 的文件描述符。</p><p>poll 不再用 BitsMap 来存储所关注的文件描述符，取而代之用动态数组，以链表形式来组织，突破了 select 的文件描述符个数限制，当然还会受到系统文件描述符限制。</p><p>但是 poll 和 select 并没有太大的本质区别，<strong>都是使用「线性结构」存储进程关注的 Socket 集合，因此都需要遍历文件描述符集合来找到可读或可写的 Socket，时间复杂度为 O(n)，而且也需要在用户态与内核态之间拷贝文件描述符集合</strong>，这种方式随着并发数上来，性能的损耗会呈指数级增长。</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);</code> 是一个 I/O 复用函数，用于在一组文件描述符上进行等待，直到其中之一变为可读、可写或发生错误。它允许程序员监视多个文件描述符，当其中任何一个准备好进行 I/O 操作时，<code>select()</code> 函数就会返回，并告知哪些文件描述符已经准备好。</p><ul><li><p><code>nfds</code>：被监听的文件描述符中最大的文件描述符值加1。</p></li><li><p><code>readfds</code>：指向一组文件描述符的集合，表示程序希望在这些文件描述符上进行读取操作。</p></li><li><p><code>writefds</code>：指向一组文件描述符的集合，表示程序希望在这些文件描述符上进行写入操作。</p></li><li><p><code>exceptfds</code>：指向一组文件描述符的集合，表示程序希望在这些文件描述符上进行异常处理。</p></li><li><p><code>timeout</code>：表示 <code>select()</code> 函数的超时时间。</p></li><li><p><code>return</code></p><ul><li>执行成功时返回就绪文件描述符的个数，</li><li>如果超时则返回0，</li><li>如果发生错误则返回-1。</li></ul></li><li><p><code>FD_CLR(fd, fd_set *fdset)</code>：从文件描述符集合中清除指定的文件描述符 <code>fd</code>。</p></li><li><p><code>FD_COPY(fd_set *fdset_orig, fd_set *fdset_copy)</code>：将文件描述符集合 <code>fdset_orig</code> 复制到另一个文件描述符集合 <code>fdset_copy</code> 中。</p></li><li><p><code>FD_ISSET(fd, fd_set *fdset)</code>：检查指定的文件描述符 <code>fd</code> 是否在文件描述符集合 <code>fdset</code> 中设置。</p></li><li><p><code>FD_SET(fd, fd_set *fdset)</code>：将指定的文件描述符 <code>fd</code> 加入到文件描述符集合 <code>fdset</code> 中。</p></li><li><p><code>FD_ZERO(fd_set *fdset)</code>：清空文件描述符集合 <code>fdset</code>，将所有文件描述符都从集合中移除。</p></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_CLIENTS</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> server_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>server_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Create socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">,</span>client<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">socklen_t</span> len<span class="token punctuation">;</span>

	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> client_fds<span class="token punctuation">[</span>MAX_CLIENTS<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	fd_set readfds<span class="token punctuation">;</span>
	<span class="token keyword">int</span> max_num<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 因为 select() 函数会修改传递给它的文件描述符集合，标记出哪些文件描述符已经准备好可读、可写或者出现了异常。所以，在每次调用 select() 之前，我们都需要重新初始化文件描述符集合，以确保我们监视的是最新的状态。</span>
		<span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		max_num <span class="token operator">=</span> server_fd<span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> MAX_CLIENTS<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">FD_SET</span><span class="token punctuation">(</span>client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> max_num<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 更新监听数量</span>
					max_num <span class="token operator">=</span> client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//sockfd 是从低往高增长的，使用sockfd + 1作为select的监控数量，这样可以减少内核的和进程的遍历次数</span>
		<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>max_num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;select&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// 当服务器空闲</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">int</span> client_fd<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;New connection , socket fd : %d , IP : %s , Port : %d \n&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ntohs</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> MAX_CLIENTS<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> MAX_CLIENTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">int</span> client_fd <span class="token operator">=</span> client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token class-name">ssize_t</span> bytes_received <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>bytes_received <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Client disconnection from fd %d\n&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				client_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received data from client %d : %s&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">char</span> send_buf<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">,</span><span class="token string">&quot;Server Received client %d data : %s&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">send</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span>send_buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="epoll" tabindex="-1"><a class="header-anchor" href="#epoll" aria-hidden="true">#</a> epoll</h4><p>epoll 是 Linux 内核提供的一种高效的 I/O 复用机制，可以用于监视大量的文件描述符，并在这些文件描述符就绪时通知应用程序。相比于传统的 select 和 poll，epoll 在大量文件描述符的情况下表现更优。</p><p>epoll 的主要特点包括：</p><ol><li><p>事件驱动： epoll 是基于事件驱动的，应用程序可以通过 epoll_wait() 等待事件的发生，而不是被动地轮询文件描述符状态。</p></li><li><p>支持多种触发模式： epoll 支持边缘触发（Edge-Triggered，EPOLLET）和水平触发（Level-Triggered，EPOLLIN/EPOLLOUT）两种模式。</p><ul><li>在<strong>边缘触发模式</strong>下，只有当文件描述符状态发生变化时才会通知应用程序</li><li>而在<strong>水平触发模式</strong>下，只要文件描述符处于可读或可写状态，就会一直通知应用程序。</li></ul></li><li><p>效率高： epoll 使用红黑树（Red-Black Tree）和双链表（Doubly Linked List）数据结构来管理文件描述符集合，因此可以在 O(1) 时间内完成插入、删除和查找操作，效率很高。</p></li></ol><p>使用 epoll 的基本步骤包括：</p><ol><li><p>创建 epoll 实例：通过调用 epoll_create() 或 epoll_create1() 创建一个 epoll 实例。</p></li><li><p>注册文件描述符：使用 epoll_ctl() 函数将需要监视的文件描述符添加到 epoll 实例中，并指定感兴趣的事件类型（如可读、可写等）。</p></li><li><p>等待事件发生：使用 epoll_wait() 函数等待文件描述符上的事件发生，当有事件发生时，epoll_wait() 将返回就绪的文件描述符以及相应的事件类型。</p></li><li><p>处理事件：根据返回的文件描述符和事件类型，应用程序可以进行相应的处理操作。</p></li></ol><p><code>int epoll_create(int size);</code> 创建一个 epoll 实例。</p><ul><li><code>size</code> 是一个提示，指定需要监视的文件描述符数量的大小。这个参数在Linux 2.6.8版本之前被忽略，但现在已经不再使用。可以传入任何大于0的值。</li><li><code>return</code><ul><li>成功时返回一个新的 epoll 实例的文件描述符，</li><li>失败时返回 -1。</li></ul></li></ul><p><code>int epoll_create1(int flags);</code> 创建一个 epoll 实例。</p><ul><li><code>flags</code> 为0时表示使用默认行为，暂时没有其他标志位。</li><li><code>return</code><ul><li>成功时返回一个新的 epoll 实例的文件描述符，</li><li>失败时返回 -1。</li></ul></li></ul><blockquote><p>主要的区别在于 <code>epoll_create1</code> 可以通过传入标志位参数来指定行为，而 <code>epoll_create</code> 则无法指定其他行为。在功能上，两者基本是一致的，但是 <code>epoll_create1</code> 是对 <code>epoll_create</code> 的一个扩展，更灵活，因为它允许在将来添加更多的标志位。通常情况下，建议使用 <code>epoll_create1</code> 来创建 epoll 实例，因为它提供了更好的扩展性。</p></blockquote><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span> 
  <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> 				<span class="token comment">// 用于保存指针类型的数据。</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span>          <span class="token comment">// 用于保存文件描述符。</span>
  <span class="token class-name">uint32_t</span> u32<span class="token punctuation">;</span>    <span class="token comment">// 用于保存32位无符号整数。</span>
  <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span>    <span class="token comment">// 用于保存64位无符号整数。</span>
<span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
  <span class="token class-name">uint32_t</span> events<span class="token punctuation">;</span>		<span class="token comment">// EPOLLIN：表示文件描述符可读。</span>
                      <span class="token comment">// EPOLLOUT：表示文件描述符可写。</span>
                      <span class="token comment">// EPOLLERR：表示文件描述符发生错误。</span>
                      <span class="token comment">// EPOLLET：表示边缘触发模式。</span>
                      <span class="token comment">// EPOLLONESHOT：表示一次性触发模式。</span>
 
  <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>  <span class="token comment">// 用于保存与事件相关的数据，类型为 epoll_data_t。</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</code> 用于控制 epoll 实例中的文件描述符，包括添加、修改和删除操作。</p><ul><li><code>epfd</code>：epoll 实例的文件描述符。</li><li><code>op</code>：操作类型，可以是以下三种之一： <ul><li><code>EPOLL_CTL_ADD</code>：将文件描述符添加到 epoll 实例中。</li><li><code>EPOLL_CTL_MOD</code>：修改 epoll 实例中的文件描述符。</li><li><code>EPOLL_CTL_DEL</code>：从 epoll 实例中删除文件描述符。</li></ul></li><li><code>fd</code>：要添加、修改或删除的文件描述符。</li><li><code>event</code>：指向一个 epoll_event 结构体的指针，用于指定感兴趣的事件类型和相关数据。</li><li><code>return</code><ul><li>成功时返回0，</li><li>失败时返回 -1。</li></ul></li></ul><p><code>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</code> 等待就绪事件的发生。</p><ul><li><code>epfd</code>：epoll 实例的文件描述符。</li><li><code>events</code>：用于存储就绪事件的 epoll_event 结构体数组。</li><li><code>maxevents</code>：指定 events 数组的最大长度，即最多可以存储多少个事件。</li><li><code>timeout</code>：等待事件的超时时间，单位为毫秒。传入负值表示永远等待，传入0表示立即返回，传入正值表示等待指定的毫秒数后返回。</li><li><code>return</code><ul><li>成功，等待就绪事件的数量。</li><li>如果在超时时间内没有任何事件就绪，它将返回 0。</li><li>失败时返回 -1。</li></ul></li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_EVENTS</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">int</span> server_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>server_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;Create socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;setsockopt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">,</span>client<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> epoll_fd <span class="token operator">=</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>epoll_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;epoll_create1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">,</span>events<span class="token punctuation">[</span>MAX_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
	event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
	event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> server_fd<span class="token punctuation">;</span>

	<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> server_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注册事件</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;epoll_ctl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Server started. Waiting for connections...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">int</span> num_events <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待事件</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>num_events <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;epoll_wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 遍历已经触发的事件</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> num_events<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">==</span> server_fd<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token class-name">socklen_t</span> len  <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> client_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>client_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;New connection from %s:%d\n&quot;</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">htons</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
				event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> client_fd<span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> client_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;event_ctl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">int</span> client_fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
			<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> bytes_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>bytes_read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Client %d disconnected\n&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				err <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epoll_fd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> client_fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;epoll_ctl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token function">close</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Received message from client %d :%s&quot;</span><span class="token punctuation">,</span>client_fd<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>client_fd<span class="token punctuation">,</span><span class="token string">&quot;Got it.&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	<span class="token function">close</span><span class="token punctuation">(</span>server_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="原始套接字" tabindex="-1"><a class="header-anchor" href="#原始套接字" aria-hidden="true">#</a> 原始套接字</h3><p>一个TCP报文有以太网帧 + IP 头部 + TCP 头部 + 数据组成</p><p>是的，一个TCP报文在发送时会被封装成一个以太网帧（Ethernet Frame），然后经过网络层时会添加IP头部（IP Header），再经过传输层时会添加TCP头部（TCP Header），最后才是数据部分。因此，一个完整的TCP报文通常由以下几部分组成：</p><ol><li><strong>以太网帧（Ethernet Frame）：</strong> 以太网帧首部包含目标MAC地址、源MAC地址和EtherType字段，用于在局域网中传输数据。以太网帧的数据部分是IP数据报。</li><li><strong>IP头部（IP Header）：</strong> IP头部包含了源IP地址和目标IP地址，用于在网络层中进行路由和转发。在TCP/IP协议栈中，IP头部紧接在以太网帧的后面。</li><li><strong>TCP头部（TCP Header）：</strong> TCP头部包含了源端口和目标端口等信息，用于在传输层中进行端到端的通信。在TCP/IP协议栈中，TCP头部紧接在IP头部的后面。</li><li><strong>数据部分：</strong> TCP报文的数据部分是传输的有效载荷，其中包含应用层数据。数据部分的大小取决于TCP报文的大小和应用层数据的大小。</li></ol><p>因此，一个完整的TCP报文是由以太网帧、IP头部、TCP头部和数据部分组成的。在发送端，这些部分会依次添加到数据报中，然后在网络中传输到目标主机，最后在接收端依次解析，提取出应用层数据。</p><h4 id="以太网帧" tabindex="-1"><a class="header-anchor" href="#以太网帧" aria-hidden="true">#</a> 以太网帧</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token number">0</span>             <span class="token number">7</span> <span class="token number">8</span>            <span class="token number">15</span> <span class="token number">16</span>           <span class="token number">23</span> <span class="token number">24</span>            <span class="token number">31</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> Destination MAC Address                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> Source MAC Address                                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> EtherType                                      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各字段解释如下：</p><ul><li><strong>目标MAC地址（Destination MAC Address）：</strong> 占6个字节（48位），用于指定数据帧的目标设备的MAC地址。</li><li><strong>源MAC地址（Source MAC Address）：</strong> 占6个字节（48位），用于指定数据帧的发送设备的MAC地址。</li><li><strong>EtherType：</strong> 占2个字节（16位），用于指定数据帧的上层协议类型，表示数据帧中数据部分的类型。常见的EtherType值包括0x0800（表示IPv4协议）、0x86DD（表示IPv6协议）、0x0806（表示ARP协议）等。</li></ul><p>以太网帧首部的总长度为14个字节，不包括数据部分。这个首部是以太网帧在局域网中传输的基本结构，在每个以太网帧中都会包含这个首部。</p><h4 id="ip-头部" tabindex="-1"><a class="header-anchor" href="#ip-头部" aria-hidden="true">#</a> IP 头部</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code> <span class="token number">0</span>      <span class="token number">4</span>       <span class="token number">8</span>      <span class="token number">12</span>      <span class="token number">16</span>      <span class="token number">20</span>      <span class="token number">24</span>      <span class="token number">28</span>      <span class="token number">32</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>Version<span class="token operator">|</span>  IHL <span class="token operator">|</span>  TOS <span class="token operator">|</span> Total Length <span class="token punctuation">(</span><span class="token number">16</span> bits<span class="token punctuation">)</span>                    <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span> Identification <span class="token punctuation">(</span><span class="token number">16</span> bits<span class="token punctuation">)</span>        <span class="token operator">|</span>Flags<span class="token operator">|</span>    Fragment Offset     <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>  TTL <span class="token operator">|</span> Protocol<span class="token operator">|</span>     Header Checksum <span class="token punctuation">(</span><span class="token number">16</span> bits<span class="token punctuation">)</span>                   <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                         Source IP Address                        <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                     Destination IP Address                      <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span> Options and Padding <span class="token punctuation">(</span>if any<span class="token punctuation">)</span> <span class="token punctuation">..</span>.                                  <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各字段解释如下：</p><ul><li><strong>版本（Version）：</strong> 占4位，用来指定IP协议的版本，IPv4的版本号为4。</li><li><strong>首部长度（Internet Header Length, IHL）：</strong> 占4位，表示IP首部的长度，单位为4字节。由于IP首部的长度是可变的，这个字段用来指示IP首部的字节数，通常情况下，IPv4首部长度为20字节，如果IP首部包含选项字段，则长度会更长。</li><li><strong>服务类型（Type of Service, TOS）：</strong> 占8位，用来指定数据包的服务类型，包括优先级、延迟、吞吐量和可靠性等信息。在IPv4中，这个字段通常被忽略，现在已经被DSCP和ECN字段取代。</li><li><strong>总长度（Total Length）：</strong> 占16位，指定整个IP数据报的长度，包括IP首部和数据部分的长度。</li><li><strong>标识（Identification）：</strong> 占16位，用于标识数据报的片偏移，用于在数据报在分段传输的情况下重新组装数据报。</li><li><strong>标志（Flags）：</strong> 占3位，用于控制分段和重组过程。具体有3个标志位，分别为：位0（保留）、位1（不分段标志 DF）、位2（更多分段 MF）。</li><li><strong>片偏移（Fragment Offset）：</strong> 占13位，表示数据报在分段传输中的位置，指明该片段在原始数据报中的位置。</li><li><strong>生存时间（Time to Live, TTL）：</strong> 占8位，表示数据报在网络中可以存活的最大时间，单位为路由器经过的时间，每经过一个路由器，该字段值减1，当TTL字段值为0时，数据报会被丢弃。</li><li><strong>协议（Protocol）：</strong> 占8位，表示上层协议的类型，如ICMP、TCP、UDP等。</li><li><strong>首部校验和（Header Checksum）：</strong> 占16位，用于检测IP首部在传输过程中是否出现错误。</li><li><strong>源IP地址（Source IP Address）：</strong> 占32位，指定数据包的源IP地址。</li><li><strong>目的IP地址（Destination IP Address）：</strong> 占32位，指定数据包的目的IP地址。</li><li><strong>选项（Options）：</strong> 可选字段，用于指定一些特殊的IP选项，如记录路由、时间戳等。通常情况下，这个字段为空，长度为0。</li></ul><p>IPv4首部总长度为20字节，如果有选项字段，则长度会更长。IPv6的首部格式不同于IPv4，但也包含类似的字段，只是字段名称和长度可能会有所不同。</p><h4 id="tcp-头部" tabindex="-1"><a class="header-anchor" href="#tcp-头部" aria-hidden="true">#</a> TCP 头部</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>  <span class="token number">0</span>      <span class="token number">4</span>       <span class="token number">8</span>      <span class="token number">12</span>      <span class="token number">16</span>      <span class="token number">20</span>      <span class="token number">24</span>      <span class="token number">28</span>      <span class="token number">32</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>            Source Port            <span class="token operator">|</span>        Destination Port       <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                        Sequence Number                          <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                    Acknowledgment Number                        <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span> Data  <span class="token operator">|</span>  Reserved  <span class="token operator">|</span>C<span class="token operator">|</span>E<span class="token operator">|</span>U<span class="token operator">|</span>A<span class="token operator">|</span>P<span class="token operator">|</span>R<span class="token operator">|</span>S<span class="token operator">|</span>F<span class="token operator">|</span>             Window          <span class="token operator">|</span>
<span class="token operator">|</span> Offset<span class="token operator">|</span>            <span class="token operator">|</span>W<span class="token operator">|</span>C<span class="token operator">|</span>R<span class="token operator">|</span>C<span class="token operator">|</span>S<span class="token operator">|</span>S<span class="token operator">|</span>Y<span class="token operator">|</span>I<span class="token operator">|</span>                               <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token operator">|</span>            <span class="token operator">|</span>R<span class="token operator">|</span>E<span class="token operator">|</span>G<span class="token operator">|</span>K<span class="token operator">|</span>H<span class="token operator">|</span>T<span class="token operator">|</span>N<span class="token operator">|</span>N<span class="token operator">|</span>                               <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>       Checksum             <span class="token operator">|</span>       Urgent Pointer               <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                     Options and Padding                        <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
<span class="token operator">|</span>                            Data                                <span class="token operator">|</span>
+------+------+------+------+------+------+------+------+------+
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各字段解释如下：</p><ul><li><strong>源端口（Source Port）：</strong> 占16位，指定发送端口的端口号。</li><li><strong>目标端口（Destination Port）：</strong> 占16位，指定接收端口的端口号。</li><li><strong>序列号（Sequence Number）：</strong> 占32位，用于指定数据段的序列号，表示在数据流中的位置。</li><li><strong>确认号（Acknowledgment Number）：</strong> 占32位，用于指定下一个期望接收到的数据段的序列号。</li><li><strong>数据偏移（Data Offset）：</strong> 占4位，指定TCP头部的长度，以32位字（即4字节）为单位。该字段表示TCP头部的长度，因为TCP头部的长度是可变的，所以需要这个字段来指示TCP头部的实际长度。</li><li><strong>保留位（Reserved）：</strong> 占6位，保留为以备将来使用，目前为0。</li><li><strong>控制位（Flags）：</strong> 占6位，用于控制TCP连接的建立、维护和关闭。包括URG、ACK、PSH、RST、SYN和FIN等标志位。</li><li><strong>窗口（Window）：</strong> 占16位，用于指定发送方的接收窗口大小，表示接收方当前可以接收的数据量。</li><li><strong>校验和（Checksum）：</strong> 占16位，用于检测TCP头部和数据部分的传输是否出错。</li><li><strong>紧急指针（Urgent Pointer）：</strong> 占16位，只有在URG标志位被置位时才有意义，用于指示紧急数据在数据流中的位置。</li><li><strong>选项和填充（Options and Padding）：</strong> 可选字段，用于指定一些特殊的TCP选项，如最大段大小（MSS）、窗口缩放因子等。</li><li><strong>数据（Data）：</strong> TCP头部后面的是数据部分，包含了TCP传输的有效载荷，即应用层数据。数据的长度由TCP头部的长度和IP数据报总长度决定。</li></ul><p>总的来说，TCP头部长度为20字节（当没有选项字段时），加上选项字段的长度，TCP头部长度会相应增加。</p><h4 id="协议衍生" tabindex="-1"><a class="header-anchor" href="#协议衍生" aria-hidden="true">#</a> 协议衍生</h4><p><img src="/my-vuepress-blog/assets/image-20240130052813020-bfc05984.png" alt="image-20240130052813020"></p><h4 id="操作原始套接字" tabindex="-1"><a class="header-anchor" href="#操作原始套接字" aria-hidden="true">#</a> 操作原始套接字</h4><p><code>socket(AF_INET, SOCK_RAW, 协议);</code></p><p><code>socket(AF_PACKET SOCK_RAW, 协议);</code></p><ul><li><p>操作原始套接字时，套接字类型必须是：<code>SOCK_RAW</code></p></li><li><p>当使用 <code>AF_INET</code> 时，可以操作的是IP首部以及IP首部后的数据部分，这包括TCP和UDP数据报，但并不包括以太网帧头部。</p></li><li><p>当使用 <code>AF_PACKET</code> 时，可以操作的是以太网帧头部以及以太网帧后的数据部分，这包括了整个以太网帧，不仅限于IP首部和数据部分。</p></li><li><p>可以通过：<code>cat /etc/protocols</code> 查看各种协议的编号</p></li></ul><p><code>AF_INET</code> 和 <code>AF_PACKET</code> 是两种不同的地址族（Address Families），用于在套接字编程中指定通信所使用的协议族。</p><ol><li><strong>AF_INET (Internet Address Family)：</strong><ul><li><code>AF_INET</code> 是用于IPv4网络的地址族，它是套接字编程中最常用的地址族之一。</li><li>在IPv4网络中，<code>AF_INET</code> 用于指定使用IPv4地址和端口进行通信。</li><li>在套接字编程中，使用 <code>AF_INET</code> 可以创建IPv4的套接字，并使用IPv4地址和端口进行通信。</li></ul></li><li><strong>AF_PACKET (Packet Address Family)：</strong><ul><li><code>AF_PACKET</code> 是用于在数据链路层（通常是以太网）发送和接收数据帧的地址族。</li><li>在 <code>AF_PACKET</code> 中，套接字操作的是数据链路层上的数据帧，而不是传统的IP数据包。</li><li><code>AF_PACKET</code> 套接字提供了对底层数据链路的直接访问，可以用于实现一些特殊的网络功能，如网络嗅探、数据包捕获和注入等。</li></ul></li></ol><p>因此，<code>AF_INET</code> 用于在IPv4网络中进行通信，而 <code>AF_PACKET</code> 用于在数据链路层发送和接收数据帧。在普通的网络应用中，通常使用 <code>AF_INET</code> 进行通信，而 <code>AF_PACKET</code> 通常用于实现一些特殊的网络工具和功能。</p><h4 id="简单示例" tabindex="-1"><a class="header-anchor" href="#简单示例" aria-hidden="true">#</a> 简单示例</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> raw<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>raw<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    raw<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    raw<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.1.17&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Hello test aaaaaaaaaaaaaaaaaaaaa&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>raw<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;send over.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="伪造ip头-伪造ip地址示例" tabindex="-1"><a class="header-anchor" href="#伪造ip头-伪造ip地址示例" aria-hidden="true">#</a> 伪造IP头｜伪造IP地址示例</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFER_SIZE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEST_IP</span> <span class="token string">&quot;192.168.1.17&quot;</span></span>

<span class="token comment">// IP头部结构</span>
<span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_ihl<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">//IP头部长度</span>
                       iph_ver<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">//IP协议版本</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_tos<span class="token punctuation">;</span>   <span class="token comment">//服务类型</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_len<span class="token punctuation">;</span>   <span class="token comment">//IP数据包长度</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_ident<span class="token punctuation">;</span> <span class="token comment">//标识符</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_flag<span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token comment">//标志</span>
                       iph_offset<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">;</span> <span class="token comment">//偏移</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_ttl<span class="token punctuation">;</span>   <span class="token comment">//生存时间</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>      iph_protocol<span class="token punctuation">;</span> <span class="token comment">//传输层协议</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> iph_chksum<span class="token punctuation">;</span>  <span class="token comment">//IP头部校验和</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>       iph_sourceip<span class="token punctuation">;</span> <span class="token comment">//源IP地址</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>       iph_destip<span class="token punctuation">;</span>   <span class="token comment">//目标IP地址</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 校验和计算函数</span>
<span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">checksum</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token operator">*</span>buf <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> result<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> len <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> len <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> <span class="token operator">*</span>buf<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        sum <span class="token operator">+=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>

    sum <span class="token operator">=</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>sum <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sum <span class="token operator">+=</span> <span class="token punctuation">(</span>sum <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token operator">~</span>sum<span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> raw_socket<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> dest_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token operator">*</span>ip_hdr<span class="token punctuation">;</span>

    <span class="token comment">// 创建原始套接字</span>
    raw_socket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>raw_socket <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置目标地址结构</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest_addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dest_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dest_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    dest_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>DEST_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造IP数据包</span>
    ip_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span> <span class="token operator">*</span><span class="token punctuation">)</span> buffer<span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_ihl <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_ver <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_ttl <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_protocol <span class="token operator">=</span> IPPROTO_TCP<span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_sourceip <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;8.8.8.8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 伪造源IP地址</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_destip <span class="token operator">=</span> dest_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_len <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算IP头部校验和</span>
    ip_hdr<span class="token operator">-&gt;</span>iph_chksum <span class="token operator">=</span> <span class="token function">checksum</span><span class="token punctuation">(</span>ip_hdr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送数据包</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendto</span><span class="token punctuation">(</span>raw_socket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ipheader</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dest_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dest_addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Packet sent successfully.\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>raw_socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="icmp-协议示例" tabindex="-1"><a class="header-anchor" href="#icmp-协议示例" aria-hidden="true">#</a> icmp 协议示例</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/ip_icmp.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">int</span> sockfd<span class="token punctuation">,</span>retval<span class="token punctuation">,</span>n<span class="token punctuation">;</span>
     <span class="token class-name">socklen_t</span> clilen<span class="token punctuation">;</span>
     <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> cliaddr<span class="token punctuation">,</span> servaddr<span class="token punctuation">;</span>
     <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> i<span class="token punctuation">;</span>

     sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> IPPROTO_ICMP<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     clilen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          n <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cliaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clilen<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span>ip_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">ip</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;IP 头部大小 %d bytes.\n&quot;</span><span class="token punctuation">,</span> ip_hdr<span class="token operator">-&gt;</span>ip_hl<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%02X%s&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">16</span> <span class="token operator">?</span> <span class="token string">&quot; &quot;</span> <span class="token operator">:</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">struct</span> <span class="token class-name">icmp</span> <span class="token operator">*</span>icmp_hdr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">icmp</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ip_hdr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> ip_hdr<span class="token operator">-&gt;</span>ip_hl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;ICMP msgtype=%d, code=%d &quot;</span><span class="token punctuation">,</span> icmp_hdr<span class="token operator">-&gt;</span>icmp_type<span class="token punctuation">,</span> icmp_hdr<span class="token operator">-&gt;</span>icmp_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s -&gt; &quot;</span><span class="token punctuation">,</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_hdr<span class="token operator">-&gt;</span>ip_src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span>   <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>ip_hdr<span class="token operator">-&gt;</span>ip_dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="单播、广播、组播" tabindex="-1"><a class="header-anchor" href="#单播、广播、组播" aria-hidden="true">#</a> 单播、广播、组播</h3><ol><li><p><strong>单播通信</strong>：</p><ul><li>单播通信的IP地址范围是一个特定的IP地址，用于将数据包直接发送到目标设备。这个目标设备的IP地址可以是任何有效的单播IP地址，通常在私有网络中是从以下范围中分配的： <ul><li>私有IPv4地址范围：通常是从以下三个地址段中分配：10.0.0.0/8、172.16.0.0/12、192.168.0.0/16。</li><li>IPv6地址范围：IPv6地址是全球唯一的，因此范围更广泛，但一般都是从全球唯一地址空间中分配。</li></ul></li></ul></li><li><p><strong>广播通信</strong>：</p><ul><li>广播通信的IP地址范围是特殊的广播地址，用于将数据包发送到网络中的所有设备。在IPv4中，广播地址是网络地址的最后一个地址，通常用于向整个网络发送数据。常见的IPv4广播地址是255.255.255.255，表示发送到本地网络中的所有设备。而在IPv6中，广播通信不再使用，而是使用了多播通信。</li></ul></li><li><p><strong>组播通信</strong>：</p><ul><li>组播通信的IP地址范围是一组特殊的组播地址，用于将数据包发送到一组设备，这些设备已经通过协议加入了相应的组播组。组播地址在IPv4和IPv6中都有对应的范围。 <ul><li>在IPv4中，组播地址范围是224.0.0.0 到 239.255.255.255。</li><li>在IPv6中，组播地址范围是 ff00::/8。</li></ul></li></ul></li><li><p><strong>单播协议</strong>：</p><ul><li><strong>TCP（传输控制协议）</strong>：TCP是一种面向连接的协议，常用于单播通信，例如网页浏览、文件传输等。</li><li><strong>UDP（用户数据报协议）</strong>：UDP是一种无连接的协议，常用于实时数据传输、视频流等单播通信场景。</li></ul></li><li><p><strong>广播协议</strong>：</p><ul><li><strong>ARP（地址解析协议）</strong>：ARP用于将IP地址解析成MAC地址，以便进行本地网络中的设备通信。当一个设备需要与网络中的另一个设备通信时，它会使用ARP协议来查询目标设备的MAC地址。</li><li><strong>DHCP（动态主机配置协议）</strong>：DHCP用于动态分配IP地址和其他网络配置参数给网络中的设备，通常通过广播来查找可用的DHCP服务器并获取配置信息。</li></ul></li><li><p><strong>组播协议</strong>：</p><ul><li><strong>IGMP（Internet组管理协议）</strong>：IGMP允许主机加入或离开特定的组播组，以便接收或停止接收特定的组播流。</li><li><strong>PIM（协议无关组播）</strong>：PIM用于在不同的组播路由器之间交换组播路由信息，以支持跨网络的组播传输。</li></ul></li></ol></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/GerryDush/edit/main/note/Linux.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: Tianya-68@qq.com">“Mortal-Tianya”</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/my-vuepress-blog/assets/app-521e935c.js" defer></script>
  </body>
</html>
