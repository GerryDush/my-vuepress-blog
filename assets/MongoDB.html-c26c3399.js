import{_ as t,r as c,o as p,c as l,d as n,e as s,b as e,a as o}from"./app-521e935c.js";const i={},r=n("h1",{id:"笔记",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#笔记","aria-hidden":"true"},"#"),s(" 笔记")],-1),d=n("h2",{id:"一、mongodb",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#一、mongodb","aria-hidden":"true"},"#"),s(" 一、MongoDB")],-1),u={id:"_1、慎用local、admin数据库",tabindex:"-1"},m=n("a",{class:"header-anchor",href:"#_1、慎用local、admin数据库","aria-hidden":"true"},"#",-1),k={href:"https://mongoing.com/archives/2599",target:"_blank",rel:"noopener noreferrer"},h=n("h3",{id:"_1-慎用local数据库",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1-慎用local数据库","aria-hidden":"true"},"#"),s(" （1）慎用local数据库")],-1),_=n("p",null,"​ local数据库，从名字可以看出，它只会在本地存储数据，即local数据库里的内容不会同步到副本集里其他节点上去；目前local数据库主要存储副本集的配置信息、oplog信息，这些信息是每个Mongod进程独有的，不需要同步到副本集种其他节点。",-1),g=n("p",null,[s("​ 在使用MongoDB时，"),n("code",null,"重要的数据千万不要存储在local数据库中"),s("，否则当一个节点故障时，存储在local里的数据就会丢失。")],-1),v={href:"https://docs.mongodb.org/manual/reference/write-concern/",target:"_blank",rel:"noopener noreferrer"},b=n("code",null,"{w: 1}",-1),f=n("code",null,'{w: "majority"}',-1),M=n("p",null,"当Mongod启用auth选项时，用户需要创建数据库帐号，访问时根据帐号信息来鉴权，而数据库帐号信息就存储在admin数据库下。",-1),y=o(`<h3 id="_2-慎用admin数据库" tabindex="-1"><a class="header-anchor" href="#_2-慎用admin数据库" aria-hidden="true">#</a> （2）慎用admin数据库</h3><p>​ 当Mongod启用auth选项时，用户需要创建数据库帐号，访问时根据帐号信息来鉴权，而数据库帐号信息就存储在admin数据库下。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>mongo<span class="token operator">-</span><span class="token number">9551</span><span class="token operator">:</span><span class="token constant">PRIMARY</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> use admin
switched to db admin
mongo<span class="token operator">-</span><span class="token number">9551</span><span class="token operator">:</span><span class="token constant">PRIMARY</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span> db<span class="token punctuation">.</span><span class="token function">getCollectionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span> <span class="token string">&quot;system.users&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;system.version&quot;</span> <span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>system.version存储authSchema的版本信息</li><li>system.users存储了数据库帐号信息</li><li>如果用户创建了自定义的角色，还会有system.roles集合</li></ul><p>用户可以在admin数据库下建立任意集合，存储任何数据，但<code>强烈建议不要使用admin数据库存储应用业务数据</code>，最好创建新的数据库。</p>`,5),D={href:"https://jira.mongodb.org/browse/SERVER-16092",target:"_blank",rel:"noopener noreferrer"},x=o(`<p>从代码中我们可以看出，MongoDB将将admin数据库上的<code>意向写锁(MODE_IX)</code>直接升级为<code>写锁(MODE_X)</code>，也就是说<code>admin数据库的写入操作的锁级别只能到DB级别</code>，不支持多个collection并发写入，在写入时也不支持并发读取。如果用户在admin数据库里存储业务数据，则可能遭遇性能问题。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsDocLocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> enableCollectionLocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>                 
  	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsDocLocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> enableCollectionLocking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 			<span class="token comment">// The check for the admin db is to ensure direct writes to auth collections</span>
      <span class="token comment">// are serialized (see SERVER-16092).</span>
      	<span class="token keyword">if</span> <span class="token punctuation">(</span>_id <span class="token operator">==</span> resourceIdAdminDB <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> <span class="token operator">!</span>isRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         			_mode <span class="token operator">=</span> <span class="token constant">MODE_X</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         _lockState<span class="token operator">-</span><span class="token operator">&amp;</span>gt<span class="token punctuation">;</span><span class="token function">lock</span><span class="token punctuation">(</span>_id<span class="token punctuation">,</span> _mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2);function B(E,R){const a=c("ExternalLinkIcon");return p(),l("div",null,[r,d,n("h3",u,[m,s(" 1、"),n("a",k,[s("慎用local、admin数据库"),e(a)])]),n("blockquote",null,[h,_,g,n("p",null,[s("​ 另外，对于重要的数据，除了不能存储在local数据库，还要注意MongoDB默认的"),n("a",v,[s("WriteConcern"),e(a)]),s("是"),b,s("，即数据写到Primary上（不保证journal已经写成功）就向客户端确认，这时同样存在丢数据的风险。对于重要的数据，可以设置更高级别的如"),f,s("来保证数据写到大多数节点后再向客户端确认，当然这对写入的性能会造成一定的影响。")]),M]),n("blockquote",null,[y,n("p",null,[s("admin数据库里的system.users、system.roles2个集合的数据，MongoDB会cache在内存里，这样不用每次鉴权都从磁盘加载用户角色信息。目前cache的维护代码，只有在保证system.users、system.roles的写入都串行化的情况下才能正确工作，详情参考官方issue "),n("a",D,[s("SERVER-16092"),e(a)])]),x])])}const w=t(i,[["render",B],["__file","MongoDB.html.vue"]]);export{w as default};
